<html><head>
<style type="text/css">
body {margin:3%; }
h1 {color:gray; font-size:120%;}
h2 {color:gray; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre.flxbg {background-color:#A0FFA0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.uncheckedflxbg {background-color:#D0D0D0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.cppbg {background-color:#80FF80; color:black; }
pre.prefmtbg {background-color:#D0D0D0; color:black; }
pre.expected {background-color:#E0FF80; color:black; }
pre.input {background-color:#E08080; color:black; }
pre.inclusion {background-color:#D070D0; color:black; }
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:#FF8080; color:black; }
</style>
<title>/Users/skaller/felix/src/web/tut/cbind_10.html</title></head><body>
<style>
body {margin:3%; font-family: sans-serif; }
h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
h2 {color:#202020; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
pre.cppbg {background-color:#C2FDC2; }
pre.prefmtbg {background-color:#F1F1F1; }
pre.expected {background-color:hsla(74,94%,88%,1); }
pre.input {background-color:hsla(20,94%,88%,1); }
pre.inclusion {
    font-family: Arial;
    font-weight: normal;
    font-size: 0.9em;
    color: #555;
    border: none;
    box-shadow: none;
    text-align: right;
    margin: -7px 11px -12px 0;
    padding: 0;
    background-color:#fafafa;
}
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
.container {
  position: fixed;
  top:0px;
  left:0px;
  height : 100%;
  width: 100%;
  background-color: grey;
  margin: 0px;
  padding: 0px;
  border-width: 0px;
  color: #404040;
}
.maincontent {
  padding:4px;
  padding-left:8px;
  line-height:1.3em;
  color:#404040; background-color:#fafafa;
}
.maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
.maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent code { color:#902030; }
.toppanel {
  position:absolute; left:0px; top:0px; height:20px; right:0px;
  background-color: #e0e0e0;
}
.bottompanel {
  position:absolute; left:0px; top:22px; bottom:0px; right:0px;
  background-color: #fafafa;
  font-size:14px;
}
.leftpanel {
  position:absolute; left:0px; top:0px; bottom:0px; width: 150px;
  background-color: #eaeaea; overflow: auto;
}
.rightpanel {
  position:absolute; right: 0px; left:160px; top:0px; bottom: 0px;
  background-color: #fafafa; overflow: auto;
}
.divider {
  position:absolute; left: 150px; top:0px; bottom:0px;
  background-color: black; width:2px;
  box-shadow: 0 0 8px #000;
}

#panemover {
    position:absolute;
    left: 150px;
    width : 10px;
    top: 0px;
    bottom: 0px;
    opacity: 0.3;
    cursor:col-resize;
}

div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}
</style>

<style>
div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}


</style>

    <script async="true">
      function dragStart(e, left, right){
        document.getElementById("panemover").style.width="70%";
        document.getElementById("panemover").style.left="50px";
        mousedown = true;
        x = e.clientX
        dragOffsetLeft =
          document.getElementById(left).getBoundingClientRect().right -
          document.getElementById(left).getBoundingClientRect().left -
          x
        ;
        dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x;
        dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
      }
      function dragRelease(){
        document.getElementById('panemover').style.width = '10px';
        document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
        mousedown = false;
      }
      function drag(e, left, right){
        if(!mousedown){return}
        x = e.clientX
        tmpLeft = dragOffsetLeft + x
        tmpDivider= dragOffsetDivider + x
        tmpRight = dragOffsetRight + x
        document.getElementById(left).style.width= tmpLeft + 'px';
        document.getElementById("divider").style.left= tmpDivider + 'px';
        document.getElementById(right).style.left = tmpRight + 'px';
      };
    </script>

<script type="text/javascript">

  function mexpand(id)
  {
    var n = document.getElementById(id).style;
    n.display = "block";
  }

  function mcollapse(id)
  {
    var n = document.getElementById(id).style;
    n.display = "none";
  }

  var counter_max = 0;
  function mshow(id,loc)
  {
    var i;
    for(i=1; i<=counter_max; ++i)
      mcollapse("menu"+String(i));
    mexpand(id);
    window.location.replace(loc);
  }
</script>

<script type="text/javascript">

function expand(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/minus.gif";
  button.alt = "-";
  n.display = "block";
}
function collapse(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/plus.gif";
  button.alt = "+";
  n.display = "none";
}
function toggle(button,id)
{
  var n = document.getElementById(id).style;
  if (n.display == "none")
  {
    button.src = "/share/src/web/images/minus.gif";
    button.alt = "-";
    n.display = "block";
  }
  else
  {
    button.src = "/share/src/web/images/plus.gif";
    button.alt = "+";
    n.display = "none";
  }
}
var allbuttons = [
"Callbacks"
];
function expand_all(dummy)
{
  for (i in allbuttons)
  {
    expand(allbuttons[i], allbuttons[i]+"_d");
  }
}
function collapse_all(dummy)
{
  for (i in allbuttons)
  {
    collapse(allbuttons[i], allbuttons[i]+"_d");
  }
}
</script>

<script>
function mouseover(id)
{
  var elt = document.getElementById(id);
  elt.style.display="none";
  var elt2 = document.getElementById(id+"_mo");
  elt2.style.display="inline";
}

function mouseout(id)
{
  var elt = document.getElementById(id+"_mo");
  elt.style.display="none";
  var elt2 = document.getElementById(id);
  elt2.style.display="inline";
}

</script>
<script> function nop(dummy) {} </script>
    <div class="container">
      <div class="toppanel">
    <!--Main Content top navbar-->
<span style="position:relative; bottom:6px"
  onmouseover="mouseover('expand')"
  onmouseout="mouseout('expand')"
  onclick="expand_all('expand')"
  ><span id="expand"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span><span id="expand_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span></span><span style="position:relative; bottom:6px"
  onmouseover="mouseover('collapse')"
  onmouseout="mouseout('collapse')"
  onclick="collapse_all('collapse')"
  ><span id="collapse"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span><span id="collapse_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span></span><a href='cbind_09.html'><span style="position:relative; bottom:6px"
  onmouseover="mouseover('prev')"
  onmouseout="mouseout('prev')"
  onclick="nop('prev')"
  ><span id="prev"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Prev</text></svg></span><span id="prev_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Prev</text></svg></span></span></a> <a href='cbind_11.html'><span style="position:relative; bottom:6px"
  onmouseover="mouseover('next')"
  onmouseout="mouseout('next')"
  onclick="nop('next')"
  ><span id="next"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Next</text></svg></span><span id="next_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Next</text></svg></span></span></a> <a href='cbind_index.html'><span style="position:relative; bottom:6px"
  onmouseover="mouseover('index')"
  onmouseout="mouseout('index')"
  onclick="nop('index')"
  ><span id="index"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Index</text></svg></span><span id="index_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Index</text></svg></span></span></a>     <!--Main Content top navbar End-->

      </div> <!-- toppanel end -->
      <div class="bottompanel">
        <span id="divider" class="divider"></span>

        <span id="left" class="leftpanel" >
          <div class="menucontent">
  <!--Left Margin Toc-->
  <div id="leftmargintoc">
    <!--Left Margin Toc Main Contents-->
      <div class=m1 onclick="mshow('menu1','#Callbacks_h')"> <a href="#Callbacks_h">Callbacks</a></div>
      <div class=sm id=menu1>
      </div>
    <script>counter_max=1;</script>
  </div>
  <!--End Left Margin Toc-->

          </div> <!-- leftpanel contents end -->
        </span> <!-- leftpanel end -->

        <span id="right" class="rightpanel">
          <div class="maincontent">
<!--Main Content Body-->
<h1 id='Callbacks_h'><img src='/share/src/web/images/minus.gif' id='Callbacks' onclick='toggle(this,"Callbacks_d")' alt='+'/> 10.1 Callbacks</h1><div id='Callbacks_d' style='display:block'>
<p>There is a common need in many API's to provide callback functions.
Lets look at an example, which we will embed in Felix:
</p><p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Specify C code to be inserted into implementation file">body</span> demo = """<span class="embedded_c">
<span class="lineno" id=line2></span>  <span class="big_keyword">typedef</span> <span class="qualifier">void</span> mouse_click_handler_t 
<span class="lineno" id=line3></span>   (<span class="qualifier">int</span> x, <span class="qualifier">int</span> y, 
<span class="lineno" id=line4></span>   <span class="qualifier">long</span> window, 
<span class="lineno" id=line5></span>   <span class="qualifier">void</span> *client_data
<span class="lineno" id=line6></span>  );
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  <span class="qualifier">void</span> register_mouse_click_handler 
<span class="lineno" id=line9></span>  (
<span class="lineno" id=line10></span>    <span class="qualifier">long</span> window, 
<span class="lineno" id=line11></span>    mouse_click_handler_t * handler, 
<span class="lineno" id=line12></span>    <span class="qualifier">void</span> * client_data
<span class="lineno" id=line13></span>  )
<span class="lineno" id=line14></span>  {
<span class="lineno" id=line15></span>   <span class="comment">// demo registration function will just call the callback
<span class="lineno" id=line16></span>  </span> <span class="comment">// with some test data
<span class="lineno" id=line17></span>  </span> <span class="qualifier">int</span> x = 42;
<span class="lineno" id=line18></span>   <span class="qualifier">int</span> y = 38;
<span class="lineno" id=line19></span>   (*handler)(x,y,window, client_data);  
<span class="lineno" id=line20></span>  }
<span class="lineno" id=line21></span>  </span>""";
</pre></p><p>In this example we have a C function <code>register_mouse_click_handler</code>
which accepts a pointer to a handler function <code>handler</code> of 
type {mouse_click_handler_t) and some arbitrary <code>client_data</code> 
which is passed to the handler.
</p><p>Normally, we'd be accepting a handler for each <code>window</code> 
and calling the function registered for that window
when the user clicks the mouse in it, however for purpose
of this demo the registration function will just call
the callback immediately.
</p><p>Now, whilst we could write a callback handler in C, it is more
fun to write one in Felix. To do this, we will create a wrapper
function to use as the callback, and then pass it the Felix
function as the <code>client_data</code>. The wrapper function then casts
it back to a Felix function and invokes it.
</p><p>Here's how we generate the wrapper function:
</p><p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="qualifier" title="A C wrapper for a Felix callback">callback</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> mouse_click_handler_wrapper: 
<span class="lineno" id=line2></span>   <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C long type">long</span> * 
<span class="lineno" id=line3></span>   mouse_click_handler_wrapper 
<span class="lineno" id=line4></span>  ;
</pre></p><p>In this code the function name <code>mouse_click_handler_wrapper</code>
is used in its own type to indicate the position of 
the <code>client_data</code> pointer. Clearly this mechanism will not work
on callbacks that do not accept a <code>client_data</code> pointer.
</p><p>The effect of the function is to take the first three
arguments and a Felix function which accepts the same
three arguments, and apply that function to the arguments,
returning the same result as that function would.
In other words this is just an apply function, but with
one important difference: its a C function which applies
a Felix function.
</p><p>Now we will write our callback in Felix:
</p><p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> myClickHandler (x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, w:<span class="library" title="binding of C long type">long</span>) 
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>   <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"User clicked in Window "</span> + w.<span class="library" title="Convert a value to a string">str</span> +
<span class="lineno" id=line4></span>      <span class="fstring">" at ("</span> + x.<span class="library" title="Convert a value to a string">str</span> + <span class="fstring">", "</span> + y.<span class="library" title="Convert a value to a string">str</span> <span class="fstring">")"</span>
<span class="lineno" id=line5></span>   ;
<span class="lineno" id=line6></span>  }
</pre></p><p>This function must have the same type as the callback,
except its a Felix function (or procedure), and the
<code>client_data</code> argument is dropped (because this function
actually <em>is</em> the client data!
</p><p>Now we specify the type of the C handler for convenience:
</p><p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define an alias for a type expression">typedef</span> c_handler_t = <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C long type">long</span> * <span class="library" title="special binding of C void* type">address</span> --&gt; <span class="library" title="Type with no values, returning void indicates a procedure">void</span>;
</pre></p><p>so that we can create a Felix binding of the C registration
function we're going to call:
</p><p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> register_mouse_click_handler: <span class="library" title="binding of C long type">long</span> * c_handler_t * <span class="library" title="special binding of C void* type">address</span> <span class="big_keyword" title="specify requirements">requires</span> demo;
</pre></p><p>Notice the type of the <code>client_data</code> is given as <code>address</code> which is the
Felix way of spelling {void*}.
</p><p>Now all we need to do is call the registration function with
our wrapper <code>mouse_click_handler_wrapper</code> as the callback
and the Felix function <code>myClickHandler</code> as the <code>client_data</code>:
</p><p><pre class='flxbg'><span class="lineno" id=line1></span>  register_mouse_click_handler (99l,
<span class="lineno" id=line2></span>   <span class="hack">C_hack</span>::cast[c_handler_t] mouse_click_handler_wrapper,
<span class="lineno" id=line3></span>   <span class="hack">C_hack</span>::cast[<span class="library" title="special binding of C void* type">address</span>] myClickHandler
<span class="lineno" id=line4></span>  );
</pre></p><p>Notice the casts. The wrapper function has the correct type
for the Felix function as the <code>client_data</code> but C just uses
a {void*} so we have to cast the wrapper to the type expected
in C. 
</p><p>Similarly, we have to cast our Felix function to an <code>address</code>
because that's what C expects for the <code>client_data</code>.
</p><p><pre class="expected">User clicked in Window 99 at (42, 38)
</pre></p><p>Now, please look at the generated C++, for me this is here:
</p><p><pre class="prefmtbg">~/felix&gt;less ~/.felix/cache/text/Users/johnskaller/felix/cbdemo.hpp
~/felix&gt;less ~/.felix/cache/text/Users/johnskaller/felix/cbdemo.cpp
</pre></p><p>In particular the compiler generated this:
</p><p><pre class="prefmtbg">//------------------------------
//CALLBACK C PROCEDURE &lt;40780&gt;: mouse_click_handler_wrapper
void mouse_click_handler_wrapper(int _a0, int _a1, long _a2, _a5339t_55573 _a3){
 _pt55578* callback = (_pt55578*)_a3;
 ::flx::rtl::con_t *p = callback-&gt;call(0,_tt55577(_a0,_a1,_a2));
 while(p)p = p-&gt;resume();
 }
</pre></p></div><!--Main Content Body End-->

          </div> <!-- rightpanel contents end -->
          <hr>
        </span> <!-- rightpanel end -->

        <span id="panemover" style="cursor:col-resize;"
         onmousedown="dragStart(event, 'left', 'right'); return false;"
         onmousemove="drag(event, 'left', 'right');"
         onmouseout="dragRelease();"
         onmouseup="dragRelease();"
        >
        </span> <!-- panemover end -->
      </div> <!-- bottom panel end -->
    </div> <!-- container end -->
</body></html>

