<html><head>
<style type="text/css">
body {margin:3%; }
h1 {color:gray; font-size:120%;}
h2 {color:gray; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre.flxbg {background-color:#A0FFA0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.uncheckedflxbg {background-color:#D0D0D0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.cppbg {background-color:#80FF80; color:black; }
pre.prefmtbg {background-color:#D0D0D0; color:black; }
pre.expected {background-color:#E0FF80; color:black; }
pre.input {background-color:#E08080; color:black; }
pre.inclusion {background-color:#D070D0; color:black; }
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:#FF8080; color:black; }
</style>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
        skipTags: ["script","noscript","style","textarea"]
    }
  });
</script>
<title>Flx compiler driver tool</title></head><body>
<style>
body {margin:3%; font-family: sans-serif; }
h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
h2 {color:#202020; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
pre.cppbg {background-color:#C2FDC2; }
pre.prefmtbg {background-color:#F1F1F1; }
pre.expected {background-color:hsla(74,94%,88%,1); }
pre.input {background-color:hsla(20,94%,88%,1); }
pre.inclusion {
    font-family: Arial;
    font-weight: normal;
    font-size: 0.9em;
    color: #555;
    border: none;
    box-shadow: none;
    text-align: right;
    margin: -7px 11px -12px 0;
    padding: 0;
    background-color:#fafafa;
}
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
.container {
  position: fixed;
  top:0px;
  left:0px;
  height : 100%;
  width: 100%;
  background-color: grey;
  margin: 0px;
  padding: 0px;
  border-width: 0px;
  color: #404040;
}
.maincontent {
  padding:4px;
  padding-left:8px;
  line-height:1.3em;
  color:#404040; background-color:#fafafa;
}
.maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
.maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent code { color:#902030; }
.toppanel {
  position:absolute; left:0px; top:0px; height:20px; right:0px;
  background-color: #e0e0e0;
}
.bottompanel {
  position:absolute; left:0px; top:22px; bottom:0px; right:0px;
  background-color: #fafafa;
  font-size:14px;
}
.leftpanel {
  position:absolute; left:0px; top:0px; bottom:0px; width: 150px;
  background-color: #eaeaea; overflow: auto;
}
.rightpanel {
  position:absolute; right: 0px; left:160px; top:0px; bottom: 0px;
  background-color: #fafafa; overflow: auto;
}
.divider {
  position:absolute; left: 150px; top:0px; bottom:0px;
  background-color: black; width:2px;
  box-shadow: 0 0 8px #000;
}

#panemover {
    position:absolute;
    left: 150px;
    width : 10px;
    top: 0px;
    bottom: 0px;
    opacity: 0.3;
    cursor:col-resize;
}

div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}
</style>

<style>
div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}


</style>

    <script async="true">
      function dragStart(e, left, right){
        document.getElementById("panemover").style.width="70%";
        document.getElementById("panemover").style.left="50px";
        mousedown = true;
        x = e.clientX
        dragOffsetLeft =
          document.getElementById(left).getBoundingClientRect().right -
          document.getElementById(left).getBoundingClientRect().left -
          x
        ;
        dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x;
        dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
      }
      function dragRelease(){
        document.getElementById('panemover').style.width = '10px';
        document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
        mousedown = false;
      }
      function drag(e, left, right){
        if(!mousedown){return}
        x = e.clientX
        tmpLeft = dragOffsetLeft + x
        tmpDivider= dragOffsetDivider + x
        tmpRight = dragOffsetRight + x
        document.getElementById(left).style.width= tmpLeft + 'px';
        document.getElementById("divider").style.left= tmpDivider + 'px';
        document.getElementById(right).style.left = tmpRight + 'px';
      };
    </script>

<script type="text/javascript">

  function mexpand(id)
  {
    var n = document.getElementById(id).style;
    n.display = "block";
  }

  function mcollapse(id)
  {
    var n = document.getElementById(id).style;
    n.display = "none";
  }

  var counter_max = 0;
  function mshow(id,loc)
  {
    var i;
    for(i=1; i<=counter_max; ++i)
      mcollapse("menu"+String(i));
    mexpand(id);
    window.location.replace(loc);
  }
</script>

<script type="text/javascript">

function expand(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/minus.gif";
  button.alt = "-";
  n.display = "block";
}
function collapse(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/plus.gif";
  button.alt = "+";
  n.display = "none";
}
function toggle(button,id)
{
  var n = document.getElementById(id).style;
  if (n.display == "none")
  {
    button.src = "/share/src/web/images/minus.gif";
    button.alt = "-";
    n.display = "block";
  }
  else
  {
    button.src = "/share/src/web/images/plus.gif";
    button.alt = "+";
    n.display = "none";
  }
}
var allbuttons = [
"Felix <code>flx</code> tool.",
"Command line tool dflx.",
"Control Record.",
"Command line argument parser.",
"Calculate Dependent variables.",
"The execution manager.",
"The {flx} tool.",
"Bootflx",
"Plugin Client.",
"Bootstrap Felix."
];
function expand_all(dummy)
{
  for (i in allbuttons)
  {
    expand(allbuttons[i], allbuttons[i]+"_d");
  }
}
function collapse_all(dummy)
{
  for (i in allbuttons)
  {
    collapse(allbuttons[i], allbuttons[i]+"_d");
  }
}
</script>

<script>
function mouseover(id)
{
  var elt = document.getElementById(id);
  elt.style.display="none";
  var elt2 = document.getElementById(id+"_mo");
  elt2.style.display="inline";
}

function mouseout(id)
{
  var elt = document.getElementById(id+"_mo");
  elt.style.display="none";
  var elt2 = document.getElementById(id);
  elt2.style.display="inline";
}

</script>
<script> function nop(dummy) {} </script>
    <div class="container">
      <div class="toppanel">
    <!--Main Content top navbar-->
<span style="position:relative; bottom:6px"
  onmouseover="mouseover('expand')"
  onmouseout="mouseout('expand')"
  onclick="expand_all('expand')"
  ><span id="expand"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span><span id="expand_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span></span><span style="position:relative; bottom:6px"
  onmouseover="mouseover('collapse')"
  onmouseout="mouseout('collapse')"
  onclick="collapse_all('collapse')"
  ><span id="collapse"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span><span id="collapse_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span></span>    <!--Main Content top navbar End-->

      </div> <!-- toppanel end -->
      <div class="bottompanel">
        <span id="divider" class="divider"></span>

        <span id="left" class="leftpanel" >
          <div class="menucontent">
  <!--Left Margin Toc-->
  <div id="leftmargintoc">
    <!--Left Margin Toc Main Contents-->
      <div class=m1 onclick="mshow('menu1','#Felix <code>flx</code> tool._h')"> <a href="#Felix_<code>flx</code>_tool._h">Felix <code>flx</code> tool.</a></div>
      <div class=sm id=menu1>
      <div class=m2><a href="#Command_line_tool_dflx._h">Command line tool dflx.</a></div>
      <div class=m2><a href="#Control_Record._h">Control Record.</a></div>
      <div class=m2><a href="#Command_line_argument_parser._h">Command line argument parser.</a></div>
      <div class=m2><a href="#Calculate_Dependent_variables._h">Calculate Dependent variables.</a></div>
      <div class=m2><a href="#The_execution_manager._h">The execution manager.</a></div>
      <div class=m2><a href="#The_{flx}_tool._h">The {flx} tool.</a></div>
      <div class=m2><a href="#Bootflx_h">Bootflx</a></div>
      <div class=m2><a href="#Plugin_Client._h">Plugin Client.</a></div>
      <div class=m2><a href="#Bootstrap_Felix._h">Bootstrap Felix.</a></div>
      </div>
    <script>counter_max=1;</script>
  </div>
  <!--End Left Margin Toc-->

          </div> <!-- leftpanel contents end -->
        </span> <!-- leftpanel end -->

        <span id="right" class="rightpanel">
          <div class="maincontent">
<!--Main Content Body-->
<h1 id='Felix_<code>flx</code>_tool._h'><img src='/share/src/web/images/minus.gif' id='Felix <code>flx</code> tool.' onclick='toggle(this,"Felix_<code>flx</code>_tool._d")' alt='+'/> 1 Felix <code>flx</code> tool.</h1><div id='Felix_<code>flx</code>_tool._d' style='display:block'>
<p>This is exactly the same as the dflx tool, it just runs
the @[flxrun} library function with command line arguments.
However it preloads some plugins that might be used to avoid
run time loading.
</p><pre class='inclusion'>
$PWD/src/tools/flx.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// flx plugin linker</span>
<span class="lineno" id=line2></span>  <span class="comment">//</span>
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> FlxPluginSymbols 
<span class="lineno" id=line4></span>  {
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>    <span class="comment">// We have to do this dummy requirements because static</span>
<span class="lineno" id=line7></span>    <span class="comment">// linking removes</span>
<span class="lineno" id=line8></span>    <span class="big_keyword" title="specify requirements">requires</span> <span class="small_keyword" title="specifies an abstract package name">package</span> <span class="fstring">"re2"</span>;
<span class="lineno" id=line9></span>    <span class="big_keyword" title="specify requirements">requires</span> <span class="small_keyword" title="specifies an abstract package name">package</span> <span class="fstring">"faio"</span>;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="specify requirements">requires</span> <span class="small_keyword" title="specifies an abstract package name">package</span> <span class="fstring">"flx_arun"</span>;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Open a module or class">open</span> Dynlink;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>    <span class="comment">// Now add all the symbols.</span>
<span class="lineno" id=line15></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> addsymbols ()
<span class="lineno" id=line16></span>    {
<span class="lineno" id=line17></span>      static-link-plugin 
<span class="lineno" id=line18></span>        toolchain_clang_macosx,
<span class="lineno" id=line19></span>        toolchain_iphoneos,
<span class="lineno" id=line20></span>        toolchain_iphonesimulator,
<span class="lineno" id=line21></span>        toolchain_clang_linux,
<span class="lineno" id=line22></span>        toolchain_gcc_macosx,
<span class="lineno" id=line23></span>        toolchain_gcc_linux,
<span class="lineno" id=line24></span>        toolchain_msvc_win
<span class="lineno" id=line25></span>      ;
<span class="lineno" id=line26></span>      <span class="comment">// flx</span>
<span class="lineno" id=line27></span>      static-link-symbol dflx_create_thread_frame <span class="small_keyword" title="membership operator, function mem">in</span> plugin dflx;
<span class="lineno" id=line28></span>      static-link-symbol dflx_flx_start <span class="small_keyword" title="membership operator, function mem">in</span> plugin dflx;
<span class="lineno" id=line29></span>      
<span class="lineno" id=line30></span>    }
<span class="lineno" id=line31></span>  }
<span class="lineno" id=line32></span>  
<span class="lineno" id=line33></span>  <span class="comment">// Add the symbols</span>
<span class="lineno" id=line34></span>  FlxPluginSymbols::addsymbols;
<span class="lineno" id=line35></span>  
<span class="lineno" id=line36></span>  <span class="comment">// Now invoke the program!</span>
<span class="lineno" id=line37></span>  <span class="big_keyword" title="Define an immutable value">val</span> linstance =  Dynlink::prepare_lib(<span class="fstring">"dflx"</span>);
<span class="lineno" id=line38></span>  <span class="big_keyword" title="Define a mutable variable">var</span> init: cont = Dynlink::get_init linstance;
<span class="lineno" id=line39></span>  
<span class="lineno" id=line40></span>  Fibres::chain init;
<span class="lineno" id=line41></span>  
<span class="lineno" id=line42></span>  
</pre></p><h2 id='Command_line_tool_dflx._h'><img src='/share/src/web/images/minus.gif' id='Command line tool dflx.' onclick='toggle(this,"Command_line_tool_dflx._d")' alt='+'/> 1.1 Command line tool dflx.</h2><div id='Command_line_tool_dflx._d' style='display:block'>
<p>This tool just runs the <code>runflx</code> library function
with the executable command line arguments.
</p><pre class='inclusion'>
$PWD/src/tools/dflx.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  System::pexit$ Flx::runflx #System::args;
</pre></p></div><h2 id='Control_Record._h'><img src='/share/src/web/images/minus.gif' id='Control Record.' onclick='toggle(this,"Control_Record._d")' alt='+'/> 1.2 Control Record.</h2><div id='Control_Record._d' style='display:block'>
<p>Just initialises the base configuration data.
</p><pre class='inclusion'>
share/lib/std/felix/flx/flx_control.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxControl
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> print_options(control:control_type) {
<span class="lineno" id=line4></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"NOOPTIMISE         = "</span>+<span class="library" title="Convert a value to a string">str</span> control.NOOPTIMISE;
<span class="lineno" id=line5></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"STATIC             = "</span>+<span class="library" title="Convert a value to a string">str</span> control.STATIC;
<span class="lineno" id=line6></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"ECHO               = "</span>+<span class="library" title="Convert a value to a string">str</span> control.ECHO;
<span class="lineno" id=line7></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"NOSTDLIB           = "</span>+<span class="library" title="Convert a value to a string">str</span> control.NOSTDLIB;
<span class="lineno" id=line8></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"DEBUG              = "</span>+<span class="library" title="Convert a value to a string">str</span> control.DEBUG;
<span class="lineno" id=line9></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"DEBUG_COMPILER     = "</span>+<span class="library" title="Convert a value to a string">str</span> control.DEBUG_COMPILER;
<span class="lineno" id=line10></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"STDIMPORTS         = "</span>+<span class="library" title="Convert a value to a string">str</span> control.STDIMPORTS;
<span class="lineno" id=line11></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"STDGRAMMAR         = "</span>+<span class="library" title="Convert a value to a string">str</span> control.STDGRAMMAR;
<span class="lineno" id=line12></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"IMPORTS            = "</span>+<span class="library" title="Convert a value to a string">str</span> control.IMPORTS;
<span class="lineno" id=line13></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"RECOMPILE          = "</span>+<span class="library" title="Convert a value to a string">str</span> control.RECOMPILE;
<span class="lineno" id=line14></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLXG_FORCE         = "</span>+<span class="library" title="Convert a value to a string">str</span> control.FLXG_FORCE;
<span class="lineno" id=line15></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"ocamls             = "</span>+<span class="library" title="Convert a value to a string">str</span> control.ocamls;
<span class="lineno" id=line16></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"swifts             = "</span>+<span class="library" title="Convert a value to a string">str</span> control.swifts;
<span class="lineno" id=line17></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"cs                 = "</span>+<span class="library" title="Convert a value to a string">str</span> control.cs;
<span class="lineno" id=line18></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"cpps               = "</span>+<span class="library" title="Convert a value to a string">str</span> control.cpps;
<span class="lineno" id=line19></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"objcs              = "</span>+<span class="library" title="Convert a value to a string">str</span> control.objcs;
<span class="lineno" id=line20></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"objcpps            = "</span>+<span class="library" title="Convert a value to a string">str</span> control.objcpps;
<span class="lineno" id=line21></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"objs               = "</span>+<span class="library" title="Convert a value to a string">str</span> control.objs;
<span class="lineno" id=line22></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"cppobases          = "</span>+<span class="library" title="Convert a value to a string">str</span> control.cppobases;
<span class="lineno" id=line23></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"TIME               = "</span>+<span class="library" title="Convert a value to a string">str</span> control.TIME;
<span class="lineno" id=line24></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"COMPILER_TIME      = "</span>+<span class="library" title="Convert a value to a string">str</span> control.COMPILER_TIME;
<span class="lineno" id=line25></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"BUNDLE_DIR         = "</span>+<span class="library" title="Convert a value to a string">str</span> control.BUNDLE_DIR;
<span class="lineno" id=line26></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"RUNIT              = "</span>+<span class="library" title="Convert a value to a string">str</span> control.RUNIT;
<span class="lineno" id=line27></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"CCOMPILEIT         = "</span>+<span class="library" title="Convert a value to a string">str</span> control.CCOMPILEIT;
<span class="lineno" id=line28></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"LINKIT             = "</span>+<span class="library" title="Convert a value to a string">str</span> control.LINKIT;
<span class="lineno" id=line29></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"RUNONLY            = "</span>+<span class="library" title="Convert a value to a string">str</span> control.RUNONLY;
<span class="lineno" id=line30></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"CXXONLY            = "</span>+<span class="library" title="Convert a value to a string">str</span> control.CXXONLY;
<span class="lineno" id=line31></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"OCAMLONLY          = "</span>+<span class="library" title="Convert a value to a string">str</span> control.OCAMLONLY;
<span class="lineno" id=line32></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"SWIFTONLY          = "</span>+<span class="library" title="Convert a value to a string">str</span> control.SWIFTONLY;
<span class="lineno" id=line33></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FELIX              = "</span>+<span class="library" title="Convert a value to a string">str</span> control.FELIX;
<span class="lineno" id=line34></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"LINKER_SWITCHES    = "</span>+<span class="library" title="Convert a value to a string">str</span> control.LINKER_SWITCHES;
<span class="lineno" id=line35></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"LINKER_OUTPUT_FILENAME = "</span>+<span class="library" title="Convert a value to a string">str</span> control.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line36></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_INTERFACE_FILENAME = "</span>+<span class="library" title="Convert a value to a string">str</span> control.FLX_INTERFACE_FILENAME;
<span class="lineno" id=line37></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"CXX_INTERFACE_FILENAME = "</span>+<span class="library" title="Convert a value to a string">str</span> control.CXX_INTERFACE_FILENAME;
<span class="lineno" id=line38></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"MACROS             = "</span>+<span class="library" title="Convert a value to a string">str</span> control.MACROS;
<span class="lineno" id=line39></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"SHOWCODE           = "</span>+<span class="library" title="Convert a value to a string">str</span> control.SHOWCODE;
<span class="lineno" id=line40></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"USAGE              = "</span>+control.USAGE;
<span class="lineno" id=line41></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"DOREDUCE           = "</span>+<span class="library" title="Convert a value to a string">str</span> control.DOREDUCE;
<span class="lineno" id=line42></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"OPTIMISE           = "</span>+<span class="library" title="Convert a value to a string">str</span> control.OPTIMISE;
<span class="lineno" id=line43></span>  }
<span class="lineno" id=line44></span>  
<span class="lineno" id=line45></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> init_loopctl () =&gt; <span class="big_keyword" title="Define a structure">struct</span> {
<span class="lineno" id=line46></span>      <span class="comment">// Argument parsing loop</span>
<span class="lineno" id=line47></span>      <span class="big_keyword" title="Define a mutable variable">var</span> argno=1;
<span class="lineno" id=line48></span>      <span class="big_keyword" title="Define a mutable variable">var</span> grab=1;
<span class="lineno" id=line49></span>      <span class="big_keyword" title="Define a mutable variable">var</span> path=<span class="fstring">""</span>;
<span class="lineno" id=line50></span>      <span class="big_keyword" title="Define a mutable variable">var</span> ext=<span class="fstring">""</span>;
<span class="lineno" id=line51></span>      <span class="big_keyword" title="Define a mutable variable">var</span> base=<span class="fstring">""</span>;
<span class="lineno" id=line52></span>      <span class="big_keyword" title="Define a mutable variable">var</span> dir=<span class="fstring">""</span>;
<span class="lineno" id=line53></span>      <span class="big_keyword" title="Define a mutable variable">var</span> progname = <span class="fstring">""</span>;
<span class="lineno" id=line54></span>  };
<span class="lineno" id=line55></span>  <span class="big_keyword" title="Define an alias for a type expression">typedef</span> loopctl_type = typeof (#init_loopctl);
<span class="lineno" id=line56></span>  
<span class="lineno" id=line57></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> dflt_control () =&gt;
<span class="lineno" id=line58></span>    <span class="big_keyword" title="Define a structure">struct</span> {
<span class="lineno" id=line59></span>  
<span class="lineno" id=line60></span>      <span class="big_keyword" title="Define a mutable variable">var</span> PRINT_HELP=0;
<span class="lineno" id=line61></span>  
<span class="lineno" id=line62></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLXG_FORCE=0;
<span class="lineno" id=line63></span>      <span class="big_keyword" title="Define a mutable variable">var</span> RECOMPILE=0;
<span class="lineno" id=line64></span>      <span class="big_keyword" title="Define a mutable variable">var</span> RUNIT=1;
<span class="lineno" id=line65></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CCOMPILEIT=1;
<span class="lineno" id=line66></span>      <span class="big_keyword" title="Define a mutable variable">var</span> LINKIT=1;
<span class="lineno" id=line67></span>      <span class="big_keyword" title="Define a mutable variable">var</span> LINKEXE=0; <span class="comment">// default is to link a DLL</span>
<span class="lineno" id=line68></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FELIX=1;
<span class="lineno" id=line69></span>      <span class="big_keyword" title="Define a mutable variable">var</span> RUNONLY=0;
<span class="lineno" id=line70></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CXXONLY=0;
<span class="lineno" id=line71></span>      <span class="big_keyword" title="Define a mutable variable">var</span> OCAMLONLY=0;
<span class="lineno" id=line72></span>      <span class="big_keyword" title="Define a mutable variable">var</span> SWIFTONLY=0;
<span class="lineno" id=line73></span>      <span class="big_keyword" title="Define a mutable variable">var</span> ECHO=0;
<span class="lineno" id=line74></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DEBUG_FLX=<span class="library" title="false value">false</span>;
<span class="lineno" id=line75></span>      <span class="big_keyword" title="Define a mutable variable">var</span> VALIDATE_CACHE=1;
<span class="lineno" id=line76></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CHECK_DEPENDENCIES=1;
<span class="lineno" id=line77></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLX_TOOLCHAIN=<span class="fstring">""</span>;
<span class="lineno" id=line78></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLX_TARGET_SUBDIR=<span class="fstring">""</span>;
<span class="lineno" id=line79></span>      <span class="comment">// --------------------------------------------------</span>
<span class="lineno" id=line80></span>      <span class="comment">// processing options</span>
<span class="lineno" id=line81></span>      <span class="comment">// --------------------------------------------------</span>
<span class="lineno" id=line82></span>  
<span class="lineno" id=line83></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DIST_ROOT=<span class="fstring">""</span>;
<span class="lineno" id=line84></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DEBUG=0;
<span class="lineno" id=line85></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DEBUG_COMPILER=0;
<span class="lineno" id=line86></span>      <span class="big_keyword" title="Define a mutable variable">var</span> COMPILER_PHASE=<span class="fstring">""</span>;
<span class="lineno" id=line87></span>      <span class="big_keyword" title="Define a mutable variable">var</span> INLINE=25;
<span class="lineno" id=line88></span>      <span class="big_keyword" title="Define a mutable variable">var</span> COMPILER_TIME=0;
<span class="lineno" id=line89></span>      <span class="big_keyword" title="Define a mutable variable">var</span> TIME=0;
<span class="lineno" id=line90></span>      <span class="big_keyword" title="Define a mutable variable">var</span> NOOPTIMISE=0;
<span class="lineno" id=line91></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DOREDUCE=1;
<span class="lineno" id=line92></span>      <span class="big_keyword" title="Define a mutable variable">var</span> TIMECMD=<span class="fstring">"time -p"</span>;
<span class="lineno" id=line93></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STATIC=0;
<span class="lineno" id=line94></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STATICLIB=0;
<span class="lineno" id=line95></span>      <span class="big_keyword" title="Define a mutable variable">var</span> SHOWCODE=0;
<span class="lineno" id=line96></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CCFLAGS=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line97></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXTRA_CCFLAGS=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line98></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXTRA_PACKAGES=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line99></span>      <span class="big_keyword" title="Define a mutable variable">var</span> LINKER_SWITCHES=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line100></span>      <span class="big_keyword" title="Define a mutable variable">var</span> MACROS=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line101></span>  
<span class="lineno" id=line102></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cs=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line103></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cpps=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line104></span>      <span class="big_keyword" title="Define a mutable variable">var</span> objcs=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line105></span>      <span class="big_keyword" title="Define a mutable variable">var</span> objcpps=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line106></span>      <span class="big_keyword" title="Define a mutable variable">var</span> objs=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line107></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cppobases=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line108></span>  
<span class="lineno" id=line109></span>      <span class="big_keyword" title="Define a mutable variable">var</span> ocamls=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line110></span>      <span class="big_keyword" title="Define a mutable variable">var</span> swifts=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line111></span>  
<span class="lineno" id=line112></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STANDARD_INCLUDE_FILES=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line113></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXTRA_INCLUDE_DIRS=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line114></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXTRA_INCLUDE_FILES=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line115></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLX_STD_LIBS=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line116></span>      <span class="big_keyword" title="Define a mutable variable">var</span> NOSTDLIB=0;
<span class="lineno" id=line117></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STDOUT=<span class="fstring">""</span>;
<span class="lineno" id=line118></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXPECT=<span class="fstring">""</span>;
<span class="lineno" id=line119></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CHECK_EXPECT=0;
<span class="lineno" id=line120></span>      <span class="big_keyword" title="Define a mutable variable">var</span> SET_STDIN=0;
<span class="lineno" id=line121></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STDIN=<span class="fstring">""</span>;
<span class="lineno" id=line122></span>      <span class="big_keyword" title="Define a mutable variable">var</span> GRAMMAR_DIR=<span class="fstring">""</span>;
<span class="lineno" id=line123></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STDGRAMMAR=<span class="fstring">""</span>;
<span class="lineno" id=line124></span>      <span class="comment">//var STDIMPORTS  = Cons ("plat/flx.flxh", Cons ( "concordance/concordance.flxh", Empty[string]));</span>
<span class="lineno" id=line125></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STDIMPORTS  = ([<span class="fstring">"plat/flx.flxh"</span>, <span class="fstring">"concordance/concordance.flxh"</span>]);
<span class="lineno" id=line126></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CMDLINE_INPUT=<span class="library" title="false value">false</span>;
<span class="lineno" id=line127></span>      <span class="big_keyword" title="Define a mutable variable">var</span> REPL_MODE=<span class="library" title="false value">false</span>;
<span class="lineno" id=line128></span>      <span class="big_keyword" title="Define a mutable variable">var</span> AUTOMATON=<span class="fstring">""</span>;
<span class="lineno" id=line129></span>      <span class="big_keyword" title="Define a mutable variable">var</span> IMPORTS=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line130></span>      <span class="big_keyword" title="Define a mutable variable">var</span> USAGE = <span class="fstring">"production"</span>;
<span class="lineno" id=line131></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CLEAR_CACHE=0;
<span class="lineno" id=line132></span>      <span class="big_keyword" title="Define a mutable variable">var</span> BUNDLE_DIR = <span class="small_keyword" title="match statement or expression">match</span> Env::getenv(<span class="fstring">"FLX_BUNDLE_DIR"</span>) <span class="small_keyword" title="type-class constraint">with</span> | <span class="fstring">""</span> =&gt; None[<span class="library" title="binding of C++ string type">string</span>] | dir =&gt; Some dir <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line133></span>  
<span class="lineno" id=line134></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DRIVER_EXE = <span class="fstring">""</span>; <span class="comment">// dynamic linkage only </span>
<span class="lineno" id=line135></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DRIVER_OBJS = Empty[<span class="library" title="binding of C++ string type">string</span>]; <span class="comment">// static linkage only</span>
<span class="lineno" id=line136></span>      <span class="big_keyword" title="Define a mutable variable">var</span> LINK_STRINGS = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line137></span>  
<span class="lineno" id=line138></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line139></span>      <span class="big_keyword" title="Define a mutable variable">var</span> extra_pkgs = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line140></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLXG = <span class="fstring">""</span>;
<span class="lineno" id=line141></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLXRUN = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line142></span>      <span class="big_keyword" title="Define a mutable variable">var</span> LINKER_OUTPUT_FILENAME = <span class="fstring">""</span>;
<span class="lineno" id=line143></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLX_INTERFACE_FILENAME = <span class="fstring">""</span>;
<span class="lineno" id=line144></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CXX_INTERFACE_FILENAME = <span class="fstring">""</span>;
<span class="lineno" id=line145></span>      <span class="big_keyword" title="Define a mutable variable">var</span> OUTPUT_FILENAME_SPECIFIED = 0;
<span class="lineno" id=line146></span>      <span class="big_keyword" title="Define a mutable variable">var</span> OUTPUT_FILENAME_WITHOUT_EXTENSION_SPECIFIED = 0;
<span class="lineno" id=line147></span>      <span class="big_keyword" title="Define a mutable variable">var</span> OUTPUT_DIRECTORY_SPECIFIED = 0;
<span class="lineno" id=line148></span>      <span class="big_keyword" title="Define a mutable variable">var</span> USER_ARGS = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line149></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DLINK_STRINGS = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line150></span>      <span class="big_keyword" title="Define a mutable variable">var</span> SLINK_STRINGS = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line151></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cache_time = 0.0;
<span class="lineno" id=line152></span>      <span class="big_keyword" title="Define a mutable variable">var</span> INDIR = <span class="fstring">""</span>;
<span class="lineno" id=line153></span>      <span class="big_keyword" title="Define a mutable variable">var</span> INREGEX = <span class="fstring">""</span>;
<span class="lineno" id=line154></span>      <span class="big_keyword" title="Define a mutable variable">var</span> NONSTOP = 0;
<span class="lineno" id=line155></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FANCYLOG= 0;
<span class="lineno" id=line156></span>      <span class="big_keyword" title="Define a mutable variable">var</span> OPTIMISE = <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$ <span class="fstring">"-O1"</span>;
<span class="lineno" id=line157></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLXG_OPTIMISE= 0;
<span class="lineno" id=line158></span>    }
<span class="lineno" id=line159></span>  ;
<span class="lineno" id=line160></span>  
<span class="lineno" id=line161></span>  <span class="big_keyword" title="Define an alias for a type expression">typedef</span> control_type = typeof (#dflt_control);
<span class="lineno" id=line162></span>  }
<span class="lineno" id=line163></span>   
</pre></p></div><h2 id='Command_line_argument_parser._h'><img src='/share/src/web/images/minus.gif' id='Command line argument parser.' onclick='toggle(this,"Command_line_argument_parser._d")' alt='+'/> 1.3 Command line argument parser.</h2><div id='Command_line_argument_parser._d' style='display:block'>
<p>Parses the command line options.
</p><pre class='inclusion'>
share/lib/std/felix/flx/flx_cmdopt.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// NOTE: below the string "host" is used to help find files eg flxg.</span>
<span class="lineno" id=line2></span>  <span class="comment">// This is a temporary hack to get Felix working after filesystem reorgnisation.</span>
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Define a type class">class</span> FlxCmdOpt
<span class="lineno" id=line5></span>  {
<span class="lineno" id=line6></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> print_help() {
<span class="lineno" id=line7></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Usage: flx [options] filename[.flx] [args ..]"</span>;
<span class="lineno" id=line8></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"options:"</span>;
<span class="lineno" id=line9></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--cmd=text           : save text to file 'cmd.flx' and process that"</span>;
<span class="lineno" id=line10></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--repl               : enter REPL mode saving stuff in session.flx and library.flx"</span>;
<span class="lineno" id=line11></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--test               : use felix installation in current directory"</span>;
<span class="lineno" id=line12></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--test=dir           : use felix installation in dir"</span>;
<span class="lineno" id=line13></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--target=dir         : subdir of install dir containing target configuration (default 'host')"</span>;
<span class="lineno" id=line14></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--target-dir=dir     : dir containing target configuration (default '$FLX_INSTALL_DIR/host')"</span>;
<span class="lineno" id=line15></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--pkgconfig-path+=dir: prepend extra flx_pkgconfig search directory to standard path"</span>;
<span class="lineno" id=line16></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--pkg=pkg            : Add pkgconfig package to link"</span>;
<span class="lineno" id=line17></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--toolchain=toolchain: pick a non-default C++ compiler toolchain"</span>;
<span class="lineno" id=line18></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--felix=file         : get installation details from file"</span>;
<span class="lineno" id=line19></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--where              : print location of felix installation"</span>;
<span class="lineno" id=line20></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--show               : print the felix program to stdout"</span>;
<span class="lineno" id=line21></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-c                   : compile only, do not run"</span>;
<span class="lineno" id=line22></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-o                   : linker output filename"</span>;
<span class="lineno" id=line23></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-ox                  : linker output filename (without extension)"</span>;
<span class="lineno" id=line24></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-od                  : linker output directory"</span> ;
<span class="lineno" id=line25></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--usage=prototype    : fast compilation at the expense of slower executables"</span>;
<span class="lineno" id=line26></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--usage=debugging    : enable debugging aids"</span>;
<span class="lineno" id=line27></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--usage=production   : optimised code with run time safety checks retained"</span>;
<span class="lineno" id=line28></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--usage=hyperlight   : optimised code without run time safety checks"</span>;
<span class="lineno" id=line29></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--static             : make standalone statically linked executable"</span>;
<span class="lineno" id=line30></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--staticlib          : make standalone library of static objects"</span>;
<span class="lineno" id=line31></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--nofelix            : do not run felix translator, leave C++ outputs alone"</span>;
<span class="lineno" id=line32></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--nocc               : do not C/C++ compile; implies --nolink"</span>;
<span class="lineno" id=line33></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--nolink             : do not link object files to an executable"</span>;
<span class="lineno" id=line34></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--exe                : link executable"</span>;
<span class="lineno" id=line35></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--run-only           : run program without dependency checking or linking"</span>;
<span class="lineno" id=line36></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--c++                : Pure C++ build, no Felix code"</span>;
<span class="lineno" id=line37></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--ocaml              : Pure Ocaml build, no Felix code"</span>;
<span class="lineno" id=line38></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--swift              : Pure Swift build, no Felix code"</span>;
<span class="lineno" id=line39></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--options            : show option set"</span>;
<span class="lineno" id=line40></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--config             : show configuration"</span>;
<span class="lineno" id=line41></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--version            : show felix version"</span>;
<span class="lineno" id=line42></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--force              : force run Felix compiler"</span>;
<span class="lineno" id=line43></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--force-compiler     : force Felix compiler to rebuild everything"</span>;
<span class="lineno" id=line44></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--cache-dir=dir      : directory cache output from parser (*.par files), autocreated, default $HOME/.felix/cache"</span>;
<span class="lineno" id=line45></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--output-dir=dir     : directory to hold C++ output from translator, autocreated, default $HOME/.felix/cache"</span>;
<span class="lineno" id=line46></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"                       Felix stored by absolute pathname within directory (tree directory)."</span>;
<span class="lineno" id=line47></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--bundle-dir=dir     : directory to hold C++ output from translator, autocreated."</span>;
<span class="lineno" id=line48></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"                       Files directly in directory by basename (flat directory)."</span>;
<span class="lineno" id=line49></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--clean              : delete the caches first"</span>;
<span class="lineno" id=line50></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--help               : show this help"</span>;
<span class="lineno" id=line51></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--noinline           : force inlining off, may break things!"</span>;
<span class="lineno" id=line52></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--inline             : aggressive inlining"</span>; 
<span class="lineno" id=line53></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--inline=999         : set inline cap to 999 'instructions'"</span>; 
<span class="lineno" id=line54></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--echo               : print shell commands before running them"</span>;
<span class="lineno" id=line55></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--time               : print target program run time after it finishes"</span>;
<span class="lineno" id=line56></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--compile-time       : print time for compiler phases"</span>;
<span class="lineno" id=line57></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--nostdlib           : don't load the standard library"</span>;
<span class="lineno" id=line58></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--nooptimise         : disable C++ compiler optimisation"</span>;
<span class="lineno" id=line59></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--noreduce           : disable reductions (default for compilation speed)"</span>;
<span class="lineno" id=line60></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--doreduce           : enable reductions (default for performance)"</span>;
<span class="lineno" id=line61></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--debug              : put debug symbols in generated binaries"</span>;
<span class="lineno" id=line62></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--debug-compiler     : make felix compiler print progress diagnostics"</span>;
<span class="lineno" id=line63></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--debug-flx          : make flx tool print diagnostics"</span>;
<span class="lineno" id=line64></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--stdout=file        : run program with standard output redirected to file"</span>;
<span class="lineno" id=line65></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--expect=file        : compare stdout with expect file"</span>;
<span class="lineno" id=line66></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--expect             : compare stdout with basename.expect"</span>;
<span class="lineno" id=line67></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--input=file         : set standard input"</span>;
<span class="lineno" id=line68></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--input              : set standard input to basename.input"</span>;
<span class="lineno" id=line69></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--indir=dir          : set directory for regexp search, default current directory"</span>;
<span class="lineno" id=line70></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--regex=pattern      : Perl regexp for batch file processing"</span>;
<span class="lineno" id=line71></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--nonstop            : don't stop on error in batch processing"</span>;
<span class="lineno" id=line72></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--fancy-log          : colour log"</span>;
<span class="lineno" id=line73></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--backup             : backup working source tree to dir 'backup'"</span>;
<span class="lineno" id=line74></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--import=file        : add an import which is prefixed to all files being translated"</span>;
<span class="lineno" id=line75></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--import=@file       : add all the files listed in file as imports (recursive on @)"</span>;
<span class="lineno" id=line76></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--nostdimport        : don't import the standard imports nugram.flxh and flx.flxh"</span>;
<span class="lineno" id=line77></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--compiler-phase     : specify which phase of the compiler to run"</span>;
<span class="lineno" id=line78></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-Idir                : add dir to search path for both felix and C++ includes"</span>;                      
<span class="lineno" id=line79></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-Ldir                : add dir to linker search path"</span>; 
<span class="lineno" id=line80></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-llib                : add dir lib to linker command"</span>;
<span class="lineno" id=line81></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-foption             : add switch to compiler command"</span>;
<span class="lineno" id=line82></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-Woption             : add switch to compiler command"</span>;
<span class="lineno" id=line83></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-O0                  : add switch to compiler command"</span>;
<span class="lineno" id=line84></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-O1                  : add switch to compiler command"</span>;
<span class="lineno" id=line85></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-O2                  : add switch to compiler command"</span>;
<span class="lineno" id=line86></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-O3                  : add switch to compiler command"</span>;
<span class="lineno" id=line87></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--cflags=flags       : addd flags to compiler command"</span>;
<span class="lineno" id=line88></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"--obj=objfile_base   : add object to link, adds extension"</span>;
<span class="lineno" id=line89></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"                         so eg fred becomes fred_static.o"</span>;
<span class="lineno" id=line90></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-Dmac                : add macro def to C++ compiler command"</span>;
<span class="lineno" id=line91></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-DFLX_ENABLE_TRACE   : enable compilation of trace generators (defaults off)"</span>;
<span class="lineno" id=line92></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"-DFLX_CGOTO          : use gcc indirect gotos and use assembler hack for long jumps (default on if config detects support)"</span>;
<span class="lineno" id=line93></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">""</span>;
<span class="lineno" id=line94></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"*.c *.cc *.cpp *.cxx "</span>;
<span class="lineno" id=line95></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"                     : add files to C++ compilation (and linker) steps"</span>;
<span class="lineno" id=line96></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"*.o *.obj *.lib *.dll *.a *.so"</span>;
<span class="lineno" id=line97></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"                     : add files to linker steps"</span>;
<span class="lineno" id=line98></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"* *.flx *.fdoc       : Felix program name, terminates options and starts runtime arguments"</span>;
<span class="lineno" id=line99></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">""</span>;
<span class="lineno" id=line100></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Environment variables"</span>;
<span class="lineno" id=line101></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"---------------------"</span>;
<span class="lineno" id=line102></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Flx build tool"</span>;
<span class="lineno" id=line103></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_INSTALL_DIR=dir     : overrides default installation directory (as if --test=dir)"</span>;
<span class="lineno" id=line104></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_SHELL_ECHO=1        : show shell callouts (system,popen)"</span>;
<span class="lineno" id=line105></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_FILE_MONITOR=1      : reports on every file open (felix and flxg)"</span>;
<span class="lineno" id=line106></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_REPORT_FILECOPY=1   : reports on every file copy (felix)"</span>;
<span class="lineno" id=line107></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_FLX=1         : debug flx (as if --debug-flx set)"</span>;
<span class="lineno" id=line108></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">""</span>;
<span class="lineno" id=line109></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Flxg compiler"</span>;
<span class="lineno" id=line110></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_PARSER=1      : emit debug info from the Felix parser"</span>;
<span class="lineno" id=line111></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_COMPILER_UNIQ=1  : emit debug of uniq flow analyser, instruction and flow analysis"</span>;
<span class="lineno" id=line112></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_COMPILER_UNIQ_GETSET=1  : emit debug of uniq flow analyser, instruction analysis"</span>;
<span class="lineno" id=line113></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">""</span>;
<span class="lineno" id=line114></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Run time system (affects flx as well as any binary run)"</span>;
<span class="lineno" id=line115></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG               : enable debugging traces (default off)"</span>;
<span class="lineno" id=line116></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_ALLOCATIONS   : enable debugging allocator (default FLX_DEBUG)"</span>;
<span class="lineno" id=line117></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_COLLECTIONS   : enable debugging collector (default FLX_DEBUG)"</span>;
<span class="lineno" id=line118></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_REPORT_COLLECTIONS  : report collections (default FLX_DEBUG)"</span>;
<span class="lineno" id=line119></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_THREADS       : enable debugging collector (default FLX_DEBUG)"</span>;
<span class="lineno" id=line120></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_DRIVER        : enable debugging driver (default FLX_DEBUG)"</span>;
<span class="lineno" id=line121></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">""</span>;
<span class="lineno" id=line122></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Run time GC tuning (affects flx as well as any binary run)"</span>;
<span class="lineno" id=line123></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_FINALISE            : whether to cleanup on termination (default NO)"</span>;
<span class="lineno" id=line124></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_GC_FREQ=n           : how often to call garbage collector (default 1000)"</span>;
<span class="lineno" id=line125></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_MIN_MEM=n           : initial memory pool n Meg (default 10)"</span>;
<span class="lineno" id=line126></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_MAX_MEM=n           : maximum memory n Meg (default -1 = infinite)"</span>;
<span class="lineno" id=line127></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_FREE_FACTOR=n.m     : reset FLX_MIN_MEM to actual usage by n.m after gc (default 1.1)"</span>;
<span class="lineno" id=line128></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_ALLOW_COLLECTION_ANYWHERE # (default yes)"</span>;
<span class="lineno" id=line129></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">""</span>;
<span class="lineno" id=line130></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Felix Developer debugging"</span>;
<span class="lineno" id=line131></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"  FLX_DEBUG_USTR=1        : # Show malloc/realloc/free in ustr (default no)"</span>;
<span class="lineno" id=line132></span>  
<span class="lineno" id=line133></span>  
<span class="lineno" id=line134></span>  }
<span class="lineno" id=line135></span>  
<span class="lineno" id=line136></span>  <span class="comment">// TODO: change the names of everything to match exactly the command line</span>
<span class="lineno" id=line137></span>  <span class="comment">// switches so this can be used as a response file</span>
<span class="lineno" id=line138></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> setup-from-file (debugln: <span class="library" title="binding of C++ string type">string</span> -&gt; 0) 
<span class="lineno" id=line139></span>  (
<span class="lineno" id=line140></span>    config:&amp;Config::config_type,
<span class="lineno" id=line141></span>    control:&amp;FlxControl::control_type, 
<span class="lineno" id=line142></span>    arg:<span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line143></span>  )
<span class="lineno" id=line144></span>  {
<span class="lineno" id=line145></span>    debugln$ <span class="fstring">"Setup file: "</span> + arg;
<span class="lineno" id=line146></span>    <span class="big_keyword" title="Define a mutable variable">var</span> text = load arg;
<span class="lineno" id=line147></span>    Config::process_config_text config (text);
<span class="lineno" id=line148></span>    debugln$ <span class="fstring">"Config[after setupfile "</span>+arg+<span class="fstring">"] =\n"</span> + <span class="library" title="Convert a value to a string">str</span> (*config);
<span class="lineno" id=line149></span>    control &lt;- FlxControl::dflt_control();
<span class="lineno" id=line150></span>    <span class="small_keyword" title="conditional">if</span> control*.DEBUG_FLX <span class="small_keyword" title="call a procedure">call</span> FlxControl::print_options(*control);
<span class="lineno" id=line151></span>  
<span class="lineno" id=line152></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (a:<span class="library" title="binding of C++ string type">string</span>, b:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (a,b);
<span class="lineno" id=line153></span>    <span class="big_keyword" title="Define a mutable variable">var</span> re = RE2 (<span class="fstring">"([-_a-zA-Z0-9]+) *: *(.*)"</span>);
<span class="lineno" id=line154></span>    <span class="big_keyword" title="Define a mutable variable">var</span> lines = split (load arg,<span class="library" title="binding of C char type">char</span> <span class="fstring">"\n"</span>);
<span class="lineno" id=line155></span>    <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line156></span>      <span class="small_keyword" title="match statement or expression">match</span> Match (re,line) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line157></span>      | Some v =&gt; 
<span class="lineno" id=line158></span>        <span class="big_keyword" title="Define a mutable variable">var</span> field = v.1;
<span class="lineno" id=line159></span>        <span class="big_keyword" title="Define a mutable variable">var</span> data = strip v.2;
<span class="lineno" id=line160></span>        <span class="small_keyword" title="match statement or expression">match</span> field <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line161></span>        | <span class="fstring">"felix-compiler"</span> =&gt; debugln$ <span class="fstring">"set flxg "</span> + data; control.FLXG &lt;-data;
<span class="lineno" id=line162></span>        | <span class="fstring">"toolchain"</span> =&gt; debugln$ <span class="fstring">"set toolchain "</span>+data; control.FLX_TOOLCHAIN &lt;- data;
<span class="lineno" id=line163></span>        | <span class="fstring">"linker-switch"</span> =&gt; debugln$ <span class="fstring">"add linker switch "</span>+data; 
<span class="lineno" id=line164></span>            control.LINKER_SWITCHES &lt;- control*.LINKER_SWITCHES + data;
<span class="lineno" id=line165></span>        | <span class="fstring">"macro-switch"</span> =&gt; debugln$ <span class="fstring">"add macro switches "</span>+data; 
<span class="lineno" id=line166></span>            control.MACROS &lt;- control*.MACROS + data;
<span class="lineno" id=line167></span>        | <span class="fstring">"optimisation-switch"</span> =&gt; debugln$ <span class="fstring">"set C++ optimisation level "</span>+data; 
<span class="lineno" id=line168></span>            control.OPTIMISE &lt;- control*.OPTIMISE + data;
<span class="lineno" id=line169></span>        <span class="comment">// American spelling</span>
<span class="lineno" id=line170></span>        | <span class="fstring">"optimization-switch"</span> =&gt; debugln$ <span class="fstring">"set C++ optimization level "</span>+data; 
<span class="lineno" id=line171></span>            control.OPTIMISE &lt;- control*.OPTIMISE + data;
<span class="lineno" id=line172></span>        | <span class="fstring">"cflag"</span> =&gt; debugln$ <span class="fstring">"add C++ cflag "</span>+data; 
<span class="lineno" id=line173></span>            control.EXTRA_CCFLAGS &lt;- control*.EXTRA_CCFLAGS + data;
<span class="lineno" id=line174></span>        | <span class="fstring">"flx-include-dir"</span> =&gt; debugln$ <span class="fstring">"add Felix include dir "</span>+data; 
<span class="lineno" id=line175></span>            config.FLX_LIB_DIRS &lt;- config*.FLX_LIB_DIRS + data;
<span class="lineno" id=line176></span>        | <span class="fstring">"rtl-include-dir"</span> =&gt; debugln$ <span class="fstring">"add Felix and C++ rtl include dir "</span>+data; 
<span class="lineno" id=line177></span>            config.FLX_RTL_DIRS &lt;- config*.FLX_RTL_DIRS + data;
<span class="lineno" id=line178></span>        | <span class="fstring">"grammar-dir"</span> =&gt; debugln$ <span class="fstring">"set Felix grammar directory "</span>+data; 
<span class="lineno" id=line179></span>            control.GRAMMAR_DIR &lt;- data;
<span class="lineno" id=line180></span>        | <span class="fstring">"grammar"</span> =&gt; debugln$ <span class="fstring">"set Felix grammar (in stdlib) "</span>+data; 
<span class="lineno" id=line181></span>            control.STDGRAMMAR &lt;- data;
<span class="lineno" id=line182></span>        | <span class="fstring">"std-import"</span> =&gt; debugln$ <span class="fstring">"set Felix standard import (in stdlib) "</span>+data; 
<span class="lineno" id=line183></span>            control.STDIMPORTS &lt;- data ! control*.STDIMPORTS;
<span class="lineno" id=line184></span>        | <span class="fstring">"extra-import"</span> =&gt; debugln$ <span class="fstring">"set Felix extra import (in stdlib) "</span>+data; 
<span class="lineno" id=line185></span>            control.IMPORTS &lt;- control*.IMPORTS + data;
<span class="lineno" id=line186></span>        | <span class="fstring">"extra-c"</span> =&gt; debugln$ <span class="fstring">"set Felix extra C file "</span>+data; 
<span class="lineno" id=line187></span>            control.cs &lt;- control*.cs + data;
<span class="lineno" id=line188></span>        | <span class="fstring">"extra-cpp"</span> =&gt; debugln$ <span class="fstring">"set Felix extra C++ file "</span>+data; 
<span class="lineno" id=line189></span>            control.cpps &lt;- control*.cpps + data;
<span class="lineno" id=line190></span>        | <span class="fstring">"extra-obj"</span> =&gt; debugln$ <span class="fstring">"set Felix extra object file "</span>+data; 
<span class="lineno" id=line191></span>            control.objs &lt;- control*.objs + data;
<span class="lineno" id=line192></span>        | <span class="fstring">"flx-std-lib"</span> =&gt; debugln$ <span class="fstring">"add Felix standard (cached) library "</span>+data; 
<span class="lineno" id=line193></span>            control.FLX_STD_LIBS &lt;- control*.FLX_STD_LIBS+ data;
<span class="lineno" id=line194></span>        | _ =&gt; debugln$ <span class="fstring">"Unknown field "</span> + field;
<span class="lineno" id=line195></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line196></span>      | #None =&gt; ;
<span class="lineno" id=line197></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line198></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line199></span>  }
<span class="lineno" id=line200></span>  
<span class="lineno" id=line201></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handle_switch
<span class="lineno" id=line202></span>  (
<span class="lineno" id=line203></span>    config:&amp;Config::config_type,
<span class="lineno" id=line204></span>    control:&amp;FlxControl::control_type, 
<span class="lineno" id=line205></span>    arg:<span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line206></span>  )
<span class="lineno" id=line207></span>  {
<span class="lineno" id=line208></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> debugln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (x:T) {
<span class="lineno" id=line209></span>      <span class="small_keyword" title="conditional">if</span> control*.DEBUG_FLX <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line210></span>    }
<span class="lineno" id=line211></span>  
<span class="lineno" id=line212></span>    <span class="small_keyword" title="conditional">if</span> prefix(arg,<span class="fstring">"--cmd="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line213></span>      <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line214></span>        <span class="big_keyword" title="Define a mutable variable">var</span> text = arg.[6 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line215></span>        save( <span class="fstring">"cmd.flx"</span>, text+<span class="fstring">";\n"</span>);
<span class="lineno" id=line216></span>        control.CMDLINE_INPUT &lt;- <span class="library" title="truth value">true</span>;  
<span class="lineno" id=line217></span>        debugln(<span class="fstring">"Running command '"</span> + text + <span class="fstring">";'"</span>); 
<span class="lineno" id=line218></span>      <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line219></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--repl"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line220></span>      control.REPL_MODE &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line221></span>        debugln(<span class="fstring">"Set REPL mode"</span>);
<span class="lineno" id=line222></span>  
<span class="lineno" id=line223></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--nostdimport"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line224></span>      debugln <span class="fstring">"No standard library import"</span>;
<span class="lineno" id=line225></span>      <span class="comment">// Note: currently, Felix compiler generates code that REQUIRES</span>
<span class="lineno" id=line226></span>      <span class="comment">// the standard library, eg the driver passes a gc_profile_t record</span>
<span class="lineno" id=line227></span>      <span class="comment">// and the compiler generates _uctor_ objects, etc etc</span>
<span class="lineno" id=line228></span>      control.STDIMPORTS &lt;- <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]();
<span class="lineno" id=line229></span>  
<span class="lineno" id=line230></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--import="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line231></span>     debugln <span class="fstring">"Add import"</span>;
<span class="lineno" id=line232></span>     control.IMPORTS &lt;- control*.IMPORTS + arg.[9 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line233></span>  
<span class="lineno" id=line234></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--felix="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line235></span>      debugln <span class="fstring">"Set install details"</span>;
<span class="lineno" id=line236></span>      setup-from-file debugln[<span class="library" title="binding of C++ string type">string</span>] (config, control, arg.[8 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line237></span>  
<span class="lineno" id=line238></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line239></span>      <span class="small_keyword" title="end of extension">begin</span>    
<span class="lineno" id=line240></span>        debugln <span class="fstring">"Set target subdirectory"</span>;
<span class="lineno" id=line241></span>        <span class="big_keyword" title="Define a mutable variable">var</span> a = arg.[9 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line242></span>        control.FLX_TARGET_SUBDIR &lt;- a;
<span class="lineno" id=line243></span>  <span class="comment">//println$ "SET FLX_TARGET_SUBDIR TO " + control*.FLX_TARGET_SUBDIR;</span>
<span class="lineno" id=line244></span>  <span class="comment">//println$ "Current FLX_INSTALL_DIR IS " + config*.FLX_INSTALL_DIR;</span>
<span class="lineno" id=line245></span>        Config::cascade_FLX_TARGET_DIR config (Filename::join (config*.FLX_INSTALL_DIR, control*.FLX_TARGET_SUBDIR));
<span class="lineno" id=line246></span>  <span class="comment">//println$ "SET FLX_TARGET_DIR TO " + config*.FLX_TARGET_DIR;</span>
<span class="lineno" id=line247></span>      <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line248></span>  
<span class="lineno" id=line249></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line250></span>      debugln <span class="fstring">"Set target configuration directory"</span>;
<span class="lineno" id=line251></span>      Config::cascade_FLX_TARGET_DIR config arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line252></span>  
<span class="lineno" id=line253></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--pkgconfig-path+="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line254></span>      debugln <span class="fstring">"Prepend extra flx_pkgconfig directory to standard path"</span>;
<span class="lineno" id=line255></span>      config.FLX_CONFIG_DIRS &lt;- arg.[18 <span class="small_keyword" title="substring range separator">to</span>] + config*.FLX_CONFIG_DIRS;
<span class="lineno" id=line256></span>  
<span class="lineno" id=line257></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--toolchain="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line258></span>      debugln <span class="fstring">"Set toolchain"</span>;
<span class="lineno" id=line259></span>      control.FLX_TOOLCHAIN&lt;- arg.[12 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line260></span>  
<span class="lineno" id=line261></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--test="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line262></span>      <span class="big_keyword" title="Define a mutable variable">var</span> a = arg.[7 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line263></span>      debugln <span class="fstring">"Set test directory"</span>;
<span class="lineno" id=line264></span>      Config::cascade_FLX_INSTALL_DIR config a;
<span class="lineno" id=line265></span>      control.FLX_TARGET_SUBDIR &lt;- <span class="fstring">"host"</span>;
<span class="lineno" id=line266></span>  
<span class="lineno" id=line267></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--test"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line268></span>      <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line269></span>        debugln <span class="fstring">"Set test directory"</span>;
<span class="lineno" id=line270></span>        a = <span class="fstring">"."</span>;
<span class="lineno" id=line271></span>        Config::cascade_FLX_INSTALL_DIR config a;
<span class="lineno" id=line272></span>        control.FLX_TARGET_SUBDIR &lt;- <span class="fstring">"host"</span>;
<span class="lineno" id=line273></span>      <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line274></span>  
<span class="lineno" id=line275></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--stdout="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line276></span>      debugln <span class="fstring">"Redirect standard output"</span>;
<span class="lineno" id=line277></span>      <span class="comment">// of the Felix program only: used for saving the output</span>
<span class="lineno" id=line278></span>      <span class="comment">// to a file so the test harness can compare it with an .expect file</span>
<span class="lineno" id=line279></span>      control.STDOUT &lt;- arg.[9 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line280></span>  
<span class="lineno" id=line281></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--expect"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line282></span>      debugln <span class="fstring">"compare stdout with expect file (default name)"</span>;
<span class="lineno" id=line283></span>      <span class="comment">// of the Felix program only: used for saving the output</span>
<span class="lineno" id=line284></span>      <span class="comment">// to a file so the test harness can compare it with an .expect file</span>
<span class="lineno" id=line285></span>      control.CHECK_EXPECT &lt;- 1;
<span class="lineno" id=line286></span>  
<span class="lineno" id=line287></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--expect="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line288></span>      debugln <span class="fstring">"compare stdout with expect file"</span>;
<span class="lineno" id=line289></span>      <span class="comment">// of the Felix program only: used for saving the output</span>
<span class="lineno" id=line290></span>      <span class="comment">// to a file so the test harness can compare it with an .expect file</span>
<span class="lineno" id=line291></span>      control.EXPECT &lt;- arg.[9 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line292></span>      control.CHECK_EXPECT &lt;- 1;
<span class="lineno" id=line293></span>  
<span class="lineno" id=line294></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--input"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line295></span>      debugln <span class="fstring">"redirect stdin to (default name)"</span>;
<span class="lineno" id=line296></span>      control.SET_STDIN &lt;- 1;
<span class="lineno" id=line297></span>  
<span class="lineno" id=line298></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--input="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line299></span>      debugln <span class="fstring">"redirect stdin to file"</span>;
<span class="lineno" id=line300></span>      control.STDIN &lt;- arg.[8 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line301></span>      control.SET_STDIN &lt;- 1;
<span class="lineno" id=line302></span>  
<span class="lineno" id=line303></span>  
<span class="lineno" id=line304></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--show"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line305></span>      control.SHOWCODE &lt;- 1;
<span class="lineno" id=line306></span>  
<span class="lineno" id=line307></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--clean"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line308></span>      debugln <span class="fstring">"Clear caches"</span>;
<span class="lineno" id=line309></span>      control.CLEAR_CACHE &lt;- 1;
<span class="lineno" id=line310></span>  
<span class="lineno" id=line311></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--force"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line312></span>      debugln <span class="fstring">"Force recompilation"</span>;
<span class="lineno" id=line313></span>      <span class="comment">// of the felix code, runs Felix unless --nofelix is set</span>
<span class="lineno" id=line314></span>      <span class="comment">// the C++ compiler is run unless the felix compile failed</span>
<span class="lineno" id=line315></span>      control.RECOMPILE &lt;- 1;
<span class="lineno" id=line316></span>  
<span class="lineno" id=line317></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--force-compiler"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line318></span>      debugln <span class="fstring">"Force flxg compiler to rebuild everything"</span>;
<span class="lineno" id=line319></span>      <span class="comment">// of the felix code, runs Felix unless --nofelix is set</span>
<span class="lineno" id=line320></span>      <span class="comment">// the C++ compiler is run unless the felix compile failed</span>
<span class="lineno" id=line321></span>      control.RECOMPILE &lt;- 1;
<span class="lineno" id=line322></span>      control.FLXG_FORCE&lt;- 1;
<span class="lineno" id=line323></span>  
<span class="lineno" id=line324></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--debug-flx"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line325></span>      control.DEBUG_FLX &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line326></span>      control.ECHO &lt;- 1;
<span class="lineno" id=line327></span>      debugln <span class="fstring">"debug flx tool ON"</span>;
<span class="lineno" id=line328></span>      control.DEBUG &lt;- 1;
<span class="lineno" id=line329></span>  
<span class="lineno" id=line330></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--debug"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line331></span>      debugln <span class="fstring">"Enable runtime debugging"</span>;
<span class="lineno" id=line332></span>      control.DEBUG &lt;- 1;
<span class="lineno" id=line333></span>  
<span class="lineno" id=line334></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--debug-compiler"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line335></span>      debugln <span class="fstring">"Enable compiler debugging"</span>;
<span class="lineno" id=line336></span>      control.DEBUG_COMPILER &lt;- 1;
<span class="lineno" id=line337></span>  
<span class="lineno" id=line338></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--compiler-phase="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line339></span>      debugln <span class="fstring">"Change the compiler phase"</span>;
<span class="lineno" id=line340></span>      control.COMPILER_PHASE &lt;- arg.[<span class="library" title="number of elements in data structure">len</span> <span class="fstring">"--compiler-phase="</span> <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line341></span>      control.RUNIT &lt;- 0;
<span class="lineno" id=line342></span>  
<span class="lineno" id=line343></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--nooptimise"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line344></span>      debugln <span class="fstring">"Disable optimisation"</span>;
<span class="lineno" id=line345></span>      control.NOOPTIMISE &lt;- 1;
<span class="lineno" id=line346></span>      control.DOREDUCE &lt;- 0;
<span class="lineno" id=line347></span>    <span class="small_keyword" title="conditional">elif</span> arg <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">"--compiler-optimise"</span>,<span class="fstring">"--compiler-optimize"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line348></span>      debugln <span class="fstring">"Enable heavy flxg optimisation"</span>;
<span class="lineno" id=line349></span>      control.FLXG_OPTIMISE  &lt;- 1;
<span class="lineno" id=line350></span>  
<span class="lineno" id=line351></span>    <span class="small_keyword" title="conditional">elif</span> arg==<span class="fstring">"--nostdlib"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line352></span>      debugln <span class="fstring">"Do not load standard library"</span>;
<span class="lineno" id=line353></span>      control.NOSTDLIB &lt;- 1;
<span class="lineno" id=line354></span>  
<span class="lineno" id=line355></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--echo"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line356></span>      debugln <span class="fstring">"Echo commands sent to system"</span>;
<span class="lineno" id=line357></span>      control.ECHO &lt;- 1;
<span class="lineno" id=line358></span>  
<span class="lineno" id=line359></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--noreduce"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line360></span>      debugln <span class="fstring">"do not perform reductions"</span>;
<span class="lineno" id=line361></span>      control.DOREDUCE &lt;- 0;
<span class="lineno" id=line362></span>  
<span class="lineno" id=line363></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--doreduce"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line364></span>      debugln <span class="fstring">"do perform reductions"</span>;
<span class="lineno" id=line365></span>      control.DOREDUCE &lt;- 1;
<span class="lineno" id=line366></span>  
<span class="lineno" id=line367></span>  
<span class="lineno" id=line368></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--static"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line369></span>      debugln <span class="fstring">"Compile a statically linked program"</span>;
<span class="lineno" id=line370></span>      control.STATIC &lt;- 1;
<span class="lineno" id=line371></span>      control.LINKEXE&lt;- 1;
<span class="lineno" id=line372></span>  
<span class="lineno" id=line373></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--staticlib"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line374></span>      debugln <span class="fstring">"make a static link library (instead of a program)"</span>;
<span class="lineno" id=line375></span>      control.STATIC &lt;- 1;
<span class="lineno" id=line376></span>      control.STATICLIB &lt;- 1;
<span class="lineno" id=line377></span>      control.RUNIT &lt;- 0;
<span class="lineno" id=line378></span>      control.LINKEXE&lt;- 0;
<span class="lineno" id=line379></span>  
<span class="lineno" id=line380></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--exe"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line381></span>      debugln <span class="fstring">"make an executable"</span>;
<span class="lineno" id=line382></span>      control.LINKEXE&lt;- 1;
<span class="lineno" id=line383></span>  
<span class="lineno" id=line384></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--inline="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line385></span>      debugln <span class="fstring">"Set inline aggressiveness"</span>;
<span class="lineno" id=line386></span>      control.INLINE &lt;- <span class="library" title="binding of C int type">int</span>(arg.[9 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line387></span>  
<span class="lineno" id=line388></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--inline"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line389></span>      debugln <span class="fstring">"Set inline aggressiveness"</span>;
<span class="lineno" id=line390></span>      control.INLINE &lt;- 100;
<span class="lineno" id=line391></span>  
<span class="lineno" id=line392></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--noinline"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line393></span>      debugln <span class="fstring">"Disable inlining (NOT RECOMMENDED)"</span>;
<span class="lineno" id=line394></span>      control.INLINE &lt;- 0;
<span class="lineno" id=line395></span>  
<span class="lineno" id=line396></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--version"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line397></span>      debugln <span class="fstring">"Print Felix version and exit"</span>;
<span class="lineno" id=line398></span>      <span class="library" title="Print a string to standard output">print</span>(<span class="fstring">"version "</span>);
<span class="lineno" id=line399></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>(Version::felix_version);
<span class="lineno" id=line400></span>      System::exit(0);
<span class="lineno" id=line401></span>  
<span class="lineno" id=line402></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--config"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line403></span>      <span class="library" title="Print a string to standard output with newline appended">println</span> (*config);
<span class="lineno" id=line404></span>      System::exit(0);
<span class="lineno" id=line405></span>  
<span class="lineno" id=line406></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--options"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line407></span>      FlxControl::print_options(*control);
<span class="lineno" id=line408></span>      System::exit(0);
<span class="lineno" id=line409></span>  
<span class="lineno" id=line410></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--where"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line411></span>      debugln <span class="fstring">"Print location of install directory and exit"</span>;
<span class="lineno" id=line412></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>(config*.FLX_INSTALL_DIR);
<span class="lineno" id=line413></span>      System::exit(0);
<span class="lineno" id=line414></span>  
<span class="lineno" id=line415></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--time"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line416></span>      debugln <span class="fstring">"Time program execution and print after running"</span>;
<span class="lineno" id=line417></span>      control.TIME &lt;- 1;
<span class="lineno" id=line418></span>  
<span class="lineno" id=line419></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--compile-time"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line420></span>      debugln <span class="fstring">"Print time of Felix compiler phases"</span>;
<span class="lineno" id=line421></span>      control.COMPILER_TIME &lt;- 1;
<span class="lineno" id=line422></span>  
<span class="lineno" id=line423></span>  
<span class="lineno" id=line424></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--output_dir="</span>) <span class="small_keyword" title="logical disjunction">or</span> prefix(arg,<span class="fstring">"--output-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line425></span>      debugln <span class="fstring">"Set the directory for compiler generated C++ files"</span>;
<span class="lineno" id=line426></span>      config.FLX_OUTPUT_DIR &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line427></span>      
<span class="lineno" id=line428></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--bundle_dir="</span>) <span class="small_keyword" title="logical disjunction">or</span> prefix(arg,<span class="fstring">"--bundle-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line429></span>      debugln <span class="fstring">"Output files needed for C++ compilation into this folder (directly by basename)"</span>;
<span class="lineno" id=line430></span>      control.BUNDLE_DIR &lt;- Some arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line431></span>  
<span class="lineno" id=line432></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--cache_dir="</span>) <span class="small_keyword" title="logical disjunction">or</span> prefix(arg,<span class="fstring">"--cache-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line433></span>      debugln <span class="fstring">"Set the directory for compiler generated *.par files"</span>;
<span class="lineno" id=line434></span>      config.FLX_CACHE_DIR &lt;- arg.[12 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line435></span>  
<span class="lineno" id=line436></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--usage=prototype"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line437></span>      debugln <span class="fstring">"Set usage prototyping"</span>;
<span class="lineno" id=line438></span>      control.USAGE  &lt;-  <span class="fstring">"prototype"</span>;
<span class="lineno" id=line439></span>      control.NOOPTIMISE &lt;- 1;
<span class="lineno" id=line440></span>      control.OPTIMISE  &lt;-  <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$ <span class="fstring">"-O1"</span>;
<span class="lineno" id=line441></span>      control.DOREDUCE  &lt;-  0;
<span class="lineno" id=line442></span>      control.INLINE &lt;- 5;
<span class="lineno" id=line443></span>  
<span class="lineno" id=line444></span>    <span class="small_keyword" title="conditional">elif</span> arg <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">"--usage=debugging"</span>,<span class="fstring">"--usage=debug"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line445></span>      debugln <span class="fstring">"Set usage debugging"</span>;
<span class="lineno" id=line446></span>      control.USAGE  &lt;-  <span class="fstring">"debugging"</span>;
<span class="lineno" id=line447></span>      control.NOOPTIMISE &lt;- 1;
<span class="lineno" id=line448></span>      control.DEBUG  &lt;-  1;
<span class="lineno" id=line449></span>      control.DOREDUCE &lt;-  0;
<span class="lineno" id=line450></span>      control.OPTIMISE  &lt;-   <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$<span class="fstring">"-O0"</span>;
<span class="lineno" id=line451></span>      control.INLINE &lt;- 5;
<span class="lineno" id=line452></span>  
<span class="lineno" id=line453></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--usage=production"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line454></span>      debugln <span class="fstring">"Set usage production"</span>;
<span class="lineno" id=line455></span>      control.USAGE  &lt;-  <span class="fstring">"production"</span>;
<span class="lineno" id=line456></span>      control.DOREDUCE  &lt;-  1;
<span class="lineno" id=line457></span>      control.OPTIMISE  &lt;-   <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$<span class="fstring">"-O2"</span>;
<span class="lineno" id=line458></span>      control.INLINE &lt;- 25;
<span class="lineno" id=line459></span>      control.FLXG_OPTIMISE &lt;- 1;
<span class="lineno" id=line460></span>  
<span class="lineno" id=line461></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--usage=hyperlight"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line462></span>      debugln <span class="fstring">"Set usage hyperlight"</span>;
<span class="lineno" id=line463></span>      control.USAGE  &lt;-  <span class="fstring">"hyperlight"</span>;
<span class="lineno" id=line464></span>      control.DOREDUCE  &lt;-  1;
<span class="lineno" id=line465></span>      control.OPTIMISE  &lt;-   <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$<span class="fstring">"-O2"</span>;
<span class="lineno" id=line466></span>      control.INLINE &lt;- 100;
<span class="lineno" id=line467></span>      control.FLXG_OPTIMISE &lt;- 1;
<span class="lineno" id=line468></span>  
<span class="lineno" id=line469></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--help"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line470></span>      control.PRINT_HELP &lt;- 1;
<span class="lineno" id=line471></span>  
<span class="lineno" id=line472></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"-c"</span> <span class="small_keyword" title="logical disjunction">or</span> arg == <span class="fstring">"--norun"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line473></span>      debugln <span class="fstring">"Compile program but do not run it"</span>;
<span class="lineno" id=line474></span>      control.RUNIT &lt;- 0;
<span class="lineno" id=line475></span>  
<span class="lineno" id=line476></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"-I"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line477></span>      debugln <span class="fstring">"Set include directories for both Felix and C/C++"</span>;
<span class="lineno" id=line478></span>      config.FLX_LIB_DIRS&lt;- config*.FLX_LIB_DIRS + arg.[2 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line479></span>      config.FLX_RTL_DIRS&lt;- config*.FLX_RTL_DIRS + arg.[2 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line480></span>  
<span class="lineno" id=line481></span>    <span class="small_keyword" title="conditional">elif</span> arg== <span class="fstring">"--nofelix"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line482></span>      debugln <span class="fstring">"Do not translate Felix code, just compile generated C++ (used to debug at C++ level)"</span>;
<span class="lineno" id=line483></span>      control.FELIX &lt;- 0;
<span class="lineno" id=line484></span>  
<span class="lineno" id=line485></span>    <span class="small_keyword" title="conditional">elif</span> arg== <span class="fstring">"--nocc"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line486></span>      debugln <span class="fstring">"Do not run the C/C++ compiler, just generate C++ source code and exit; implies -c and --nolink"</span>;
<span class="lineno" id=line487></span>      control.CCOMPILEIT &lt;- 0;
<span class="lineno" id=line488></span>  
<span class="lineno" id=line489></span>    <span class="small_keyword" title="conditional">elif</span> arg== <span class="fstring">"--nolink"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line490></span>      debugln <span class="fstring">"Do not link object code to an executable, just generate and compile the C++ source code; implies -c"</span>;
<span class="lineno" id=line491></span>      control.RUNIT &lt;- 0;
<span class="lineno" id=line492></span>      control.LINKIT &lt;- 0;
<span class="lineno" id=line493></span>      control.LINKEXE &lt;- 0;
<span class="lineno" id=line494></span>  
<span class="lineno" id=line495></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--run-only"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line496></span>      debugln <span class="fstring">"Run the binary executable without any compilation. Must exist!"</span>;
<span class="lineno" id=line497></span>      control.FELIX &lt;-0;
<span class="lineno" id=line498></span>      control.CCOMPILEIT &lt;- 0;
<span class="lineno" id=line499></span>      control.LINKIT &lt;- 0;
<span class="lineno" id=line500></span>      control.LINKEXE &lt;- 0;
<span class="lineno" id=line501></span>      control.RUNIT &lt;- 1;
<span class="lineno" id=line502></span>      control.VALIDATE_CACHE &lt;- 0;
<span class="lineno" id=line503></span>      control.CHECK_DEPENDENCIES &lt;- 0;
<span class="lineno" id=line504></span>      control.RUNONLY &lt;- 1;
<span class="lineno" id=line505></span>  
<span class="lineno" id=line506></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"-l"</span>) <span class="small_keyword" title="logical disjunction">or</span> prefix(arg,<span class="fstring">"-L"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line507></span>      debugln <span class="fstring">"Set extra switched for linker"</span>;
<span class="lineno" id=line508></span>      control.LINKER_SWITCHES &lt;- control*.LINKER_SWITCHES + arg;
<span class="lineno" id=line509></span>  
<span class="lineno" id=line510></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"-D"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line511></span>      debugln <span class="fstring">"Set extra macros for C++ compilation"</span>;
<span class="lineno" id=line512></span>      control.MACROS &lt;- control*.MACROS + arg.[2 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line513></span>  
<span class="lineno" id=line514></span>    <span class="small_keyword" title="conditional">elif</span> arg <span class="tex_symbol" title="\in">\(\in\)</span> (<span class="fstring">"-O0"</span>, <span class="fstring">"-O1"</span>,<span class="fstring">"-O2"</span>,<span class="fstring">"-O3"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line515></span>      debugln$ <span class="fstring">"Set C++ compilation optimisation "</span> + arg;
<span class="lineno" id=line516></span>      control.OPTIMISE &lt;-  <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$ arg;
<span class="lineno" id=line517></span>  
<span class="lineno" id=line518></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"-f"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line519></span>      debugln$ <span class="fstring">"Set C++ compilation switch "</span>+arg;
<span class="lineno" id=line520></span>      control.EXTRA_CCFLAGS  &lt;-  control*.EXTRA_CCFLAGS + arg;
<span class="lineno" id=line521></span>  
<span class="lineno" id=line522></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--cflags="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line523></span>      {
<span class="lineno" id=line524></span>        <span class="big_keyword" title="Define a mutable variable">var</span> flags = arg.[9 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line525></span>        debugln$ <span class="fstring">"Set C++ compilation switch "</span>+ flags;
<span class="lineno" id=line526></span>        control.EXTRA_CCFLAGS  &lt;-  control*.EXTRA_CCFLAGS + flags;
<span class="lineno" id=line527></span>      };
<span class="lineno" id=line528></span>  
<span class="lineno" id=line529></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--obj="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line530></span>      {
<span class="lineno" id=line531></span>        <span class="big_keyword" title="Define a mutable variable">var</span> file = arg.[6 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line532></span>        control.cppobases &lt;- control*.cppobases + file; <span class="comment">// without suffix or extension, added later!</span>
<span class="lineno" id=line533></span>      };
<span class="lineno" id=line534></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"-W"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line535></span>      debugln$ <span class="fstring">"Set C++ warning switch "</span>+arg;
<span class="lineno" id=line536></span>      control.EXTRA_CCFLAGS  &lt;-  control*.EXTRA_CCFLAGS + arg;
<span class="lineno" id=line537></span>  
<span class="lineno" id=line538></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--pkg="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line539></span>      debugln <span class="fstring">"Add pkgconfig package to link"</span>;
<span class="lineno" id=line540></span>      control.pkgs &lt;-  control*.pkgs +arg.[6 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line541></span>  
<span class="lineno" id=line542></span>    <span class="small_keyword" title="conditional">elif</span> prefix (arg,<span class="fstring">"--indir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line543></span>      control.INDIR  &lt;-  arg.[8 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line544></span>      debugln$ <span class="fstring">"Set input directory for regexp to "</span> + control*.INDIR;
<span class="lineno" id=line545></span>  
<span class="lineno" id=line546></span>    <span class="small_keyword" title="conditional">elif</span> prefix (arg,<span class="fstring">"--regex="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line547></span>      control.INREGEX  &lt;-  arg.[8 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line548></span>      debugln$ <span class="fstring">"Set input regex to "</span> + control*.INREGEX;
<span class="lineno" id=line549></span>  
<span class="lineno" id=line550></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--nonstop"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line551></span>      control.NONSTOP &lt;- 1;
<span class="lineno" id=line552></span>      debugln$ <span class="fstring">"Set batch processing mode to nonstop "</span> + control*.NONSTOP;
<span class="lineno" id=line553></span>  
<span class="lineno" id=line554></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--fancy-log"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line555></span>      control.FANCYLOG &lt;- 1;
<span class="lineno" id=line556></span>      debugln$ <span class="fstring">"Set diagnostics to Fancy log"</span>;
<span class="lineno" id=line557></span>  
<span class="lineno" id=line558></span>  
<span class="lineno" id=line559></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--c++"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line560></span>      control.CXXONLY &lt;- 1;
<span class="lineno" id=line561></span>      control.FELIX &lt;- 0;
<span class="lineno" id=line562></span>      debugln$ <span class="fstring">"C++ only, no Felix"</span>;
<span class="lineno" id=line563></span>  
<span class="lineno" id=line564></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--ocaml"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line565></span>      control.OCAMLONLY &lt;- 1;
<span class="lineno" id=line566></span>      control.FELIX &lt;- 0;
<span class="lineno" id=line567></span>      debugln$ <span class="fstring">"Ocaml only, no Felix"</span>;
<span class="lineno" id=line568></span>  
<span class="lineno" id=line569></span>    <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--swift"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line570></span>      control.SWIFTONLY &lt;- 1;
<span class="lineno" id=line571></span>      control.FELIX &lt;- 0;
<span class="lineno" id=line572></span>      debugln$ <span class="fstring">"Swift only, no Felix"</span>;
<span class="lineno" id=line573></span>     
<span class="lineno" id=line574></span>  <span class="comment">// the main filename -- subsequent args are args to flx_run</span>
<span class="lineno" id=line575></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line576></span>      eprintln$ <span class="fstring">"Unknown switch '"</span> + arg+<span class="fstring">"'"</span>;
<span class="lineno" id=line577></span>      System::exit 1;
<span class="lineno" id=line578></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line579></span>  }
<span class="lineno" id=line580></span>  
<span class="lineno" id=line581></span>  
<span class="lineno" id=line582></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handle_filename
<span class="lineno" id=line583></span>  (
<span class="lineno" id=line584></span>    ploopctl:&amp;FlxControl::loopctl_type,
<span class="lineno" id=line585></span>    config:&amp;Config::config_type,
<span class="lineno" id=line586></span>    control:&amp;FlxControl::control_type, 
<span class="lineno" id=line587></span>    arg:<span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line588></span>  )
<span class="lineno" id=line589></span>  {
<span class="lineno" id=line590></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> debugln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (x:T) {
<span class="lineno" id=line591></span>      <span class="small_keyword" title="conditional">if</span> control*.DEBUG_FLX <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line592></span>    }
<span class="lineno" id=line593></span>  
<span class="lineno" id=line594></span>    ploopctl.progname &lt;- arg;
<span class="lineno" id=line595></span>    <span class="big_keyword" title="Define a mutable variable">var</span> path,ext = Filename::split_extension(arg);
<span class="lineno" id=line596></span>    ploopctl.path &lt;- path;
<span class="lineno" id=line597></span>    ploopctl.ext &lt;- ext;
<span class="lineno" id=line598></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dir,base = Filename::split1(ploopctl*.path);
<span class="lineno" id=line599></span>    ploopctl.dir &lt;- dir;
<span class="lineno" id=line600></span>    ploopctl.base &lt;- base;
<span class="lineno" id=line601></span>  
<span class="lineno" id=line602></span>    <span class="small_keyword" title="match statement or expression">match</span> check_ext $ Filename::get_extension arg <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line603></span>    | <span class="fstring">"cpp_compile"</span> =&gt; 
<span class="lineno" id=line604></span>       control.cpps &lt;- control*.cpps + arg;
<span class="lineno" id=line605></span>  
<span class="lineno" id=line606></span>    | <span class="fstring">"c_compile"</span> =&gt; 
<span class="lineno" id=line607></span>       control.cs &lt;- control*.cs + arg;
<span class="lineno" id=line608></span>  
<span class="lineno" id=line609></span>    | <span class="fstring">"objcpp_compile"</span> =&gt; 
<span class="lineno" id=line610></span>       control.objcpps &lt;- control*.cpps + arg;
<span class="lineno" id=line611></span>  
<span class="lineno" id=line612></span>    | <span class="fstring">"objc_compile"</span> =&gt; 
<span class="lineno" id=line613></span>       control.objcs &lt;- control*.cs + arg;
<span class="lineno" id=line614></span>  
<span class="lineno" id=line615></span>    | <span class="fstring">"link"</span> =&gt;
<span class="lineno" id=line616></span>       control.objs &lt;- control*.objs + arg;
<span class="lineno" id=line617></span>  
<span class="lineno" id=line618></span>    | <span class="fstring">"felix"</span> =&gt; 
<span class="lineno" id=line619></span>      ploopctl.grab &lt;- 0;
<span class="lineno" id=line620></span>  
<span class="lineno" id=line621></span>    | <span class="fstring">"none"</span> =&gt; 
<span class="lineno" id=line622></span>      ploopctl.grab &lt;- 0;
<span class="lineno" id=line623></span>  
<span class="lineno" id=line624></span>    | <span class="fstring">"unknown"</span> =&gt;
<span class="lineno" id=line625></span>      eprintln$ <span class="fstring">"Unknown file extension in "</span> + arg;
<span class="lineno" id=line626></span>      System::exit 1;
<span class="lineno" id=line627></span>  
<span class="lineno" id=line628></span>    | <span class="fstring">"ocaml"</span> =&gt;
<span class="lineno" id=line629></span>      control.ocamls&lt;- control*.ocamls + arg;
<span class="lineno" id=line630></span>  
<span class="lineno" id=line631></span>    | <span class="fstring">"swift"</span> =&gt;
<span class="lineno" id=line632></span>      control.swifts &lt;- control*.swifts + arg;
<span class="lineno" id=line633></span>  
<span class="lineno" id=line634></span>  
<span class="lineno" id=line635></span>    | _ =&gt; <span class="big_keyword" title="Run time assertion">assert</span> <span class="library" title="false value">false</span>;
<span class="lineno" id=line636></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line637></span>    ;
<span class="lineno" id=line638></span>  }
<span class="lineno" id=line639></span>  
<span class="lineno" id=line640></span>  <span class="comment">// --------------------------------------------------</span>
<span class="lineno" id=line641></span>  <span class="comment">// String Utilities </span>
<span class="lineno" id=line642></span>  <span class="comment">// --------------------------------------------------</span>
<span class="lineno" id=line643></span>  
<span class="lineno" id=line644></span>  <span class="comment">// utility to classify extensions.</span>
<span class="lineno" id=line645></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> exts () = {
<span class="lineno" id=line646></span>    <span class="big_keyword" title="Define a mutable variable">var</span> objcpp_compile_exts = <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'.mm'</span>);
<span class="lineno" id=line647></span>    <span class="big_keyword" title="Define a mutable variable">var</span> objc_compile_exts = <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'.m'</span>);
<span class="lineno" id=line648></span>    <span class="big_keyword" title="Define a mutable variable">var</span> cpp_compile_exts = <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'.cpp'</span>,<span class="fstring">'.cxx'</span>,<span class="fstring">'.cc'</span>);
<span class="lineno" id=line649></span>    <span class="big_keyword" title="Define a mutable variable">var</span> c_compile_exts = <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'.c'</span>);
<span class="lineno" id=line650></span>    <span class="big_keyword" title="Define a mutable variable">var</span> ocaml = <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'.mli'</span>,<span class="fstring">'.ml'</span>,<span class="fstring">'.cmi'</span>,<span class="fstring">'cmx'</span>,<span class="fstring">'.cmxa'</span>);
<span class="lineno" id=line651></span>    <span class="big_keyword" title="Define a mutable variable">var</span> swift = <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'.swift'</span>);
<span class="lineno" id=line652></span>  
<span class="lineno" id=line653></span>    <span class="big_keyword" title="Define a mutable variable">var</span> link_exts =  <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'.o'</span>,<span class="fstring">'.obj'</span>,<span class="fstring">'.lib'</span>,<span class="fstring">'.dll'</span>,<span class="fstring">'.a'</span>,<span class="fstring">'.so'</span>,<span class="fstring">'.dylib'</span>,<span class="fstring">'.os'</span>);
<span class="lineno" id=line654></span>    <span class="big_keyword" title="Define a mutable variable">var</span> felix_exts = <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">".flx"</span>,<span class="fstring">".fdoc"</span>);
<span class="lineno" id=line655></span>    <span class="big_keyword" title="Define a mutable variable">var</span> exts =
<span class="lineno" id=line656></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"ocaml"</span>) ocaml+
<span class="lineno" id=line657></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"swift"</span>) swift+
<span class="lineno" id=line658></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"objcpp_compile"</span>) objcpp_compile_exts +
<span class="lineno" id=line659></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"objc_compile"</span>) objc_compile_exts +
<span class="lineno" id=line660></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"cpp_compile"</span>) cpp_compile_exts +
<span class="lineno" id=line661></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"c_compile"</span>) c_compile_exts +
<span class="lineno" id=line662></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"link"</span>) link_exts +
<span class="lineno" id=line663></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s,<span class="fstring">"felix"</span>) felix_exts + 
<span class="lineno" id=line664></span>      (<span class="fstring">""</span>,<span class="fstring">"none"</span>)
<span class="lineno" id=line665></span>    ;
<span class="lineno" id=line666></span>    <span class="small_keyword" title="return">return</span> exts;
<span class="lineno" id=line667></span>  }
<span class="lineno" id=line668></span>  
<span class="lineno" id=line669></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> check_ext (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="small_keyword" title="match statement or expression">match</span> find #exts s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line670></span>    | Some tag =&gt; tag
<span class="lineno" id=line671></span>    | #None =&gt; <span class="fstring">"unknown"</span>
<span class="lineno" id=line672></span>  ;
<span class="lineno" id=line673></span>  
<span class="lineno" id=line674></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> xparse_cmd_line 
<span class="lineno" id=line675></span>  (
<span class="lineno" id=line676></span>    config:&amp;Config::config_type, 
<span class="lineno" id=line677></span>    control:&amp;FlxControl::control_type, 
<span class="lineno" id=line678></span>    ploopctl:&amp;FlxControl::loopctl_type,
<span class="lineno" id=line679></span>    vargs: <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line680></span>  )
<span class="lineno" id=line681></span>  {
<span class="lineno" id=line682></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> debugln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (x:T) {
<span class="lineno" id=line683></span>      <span class="small_keyword" title="conditional">if</span> control*.DEBUG_FLX <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line684></span>    }
<span class="lineno" id=line685></span>  
<span class="lineno" id=line686></span>    <span class="big_keyword" title="Define a mutable variable">var</span> SET_LINKER_OUTPUT = <span class="library" title="false value">false</span>;
<span class="lineno" id=line687></span>    <span class="big_keyword" title="Define a mutable variable">var</span> SET_LINKER_OUTPUT_WITHOUT_EXTENSION = <span class="library" title="false value">false</span>;
<span class="lineno" id=line688></span>    <span class="big_keyword" title="Define a mutable variable">var</span> SET_LINKER_OUTPUT_DIRECTORY = <span class="library" title="false value">false</span>;
<span class="lineno" id=line689></span>  
<span class="lineno" id=line690></span>  grabbing_args: <span class="small_keyword" title="while loop">while</span> ploopctl*.grab == 1 <span class="small_keyword" title="logical conjunction">and</span> ploopctl*.argno &lt; vargs.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line691></span>      <span class="big_keyword" title="Define a mutable variable">var</span> arg = vargs . (ploopctl*.argno);
<span class="lineno" id=line692></span>      debugln$ <span class="fstring">"ARGNO="</span>+<span class="library" title="Convert a value to a string">str</span>(ploopctl*.argno)+<span class="fstring">", arg='"</span>+arg+<span class="fstring">"'"</span>;
<span class="lineno" id=line693></span>  
<span class="lineno" id=line694></span>      <span class="small_keyword" title="conditional">if</span> SET_LINKER_OUTPUT <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line695></span>         control.LINKER_OUTPUT_FILENAME &lt;- arg;
<span class="lineno" id=line696></span>         debugln$ <span class="fstring">"Set linker output file="</span> + control*.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line697></span>         SET_LINKER_OUTPUT = <span class="library" title="false value">false</span>;
<span class="lineno" id=line698></span>         control.OUTPUT_FILENAME_SPECIFIED &lt;- 1;
<span class="lineno" id=line699></span>  
<span class="lineno" id=line700></span>      <span class="small_keyword" title="conditional">elif</span> SET_LINKER_OUTPUT_WITHOUT_EXTENSION <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line701></span>         control.LINKER_OUTPUT_FILENAME &lt;- arg;
<span class="lineno" id=line702></span>         debugln$ <span class="fstring">"Set linker output file="</span> + control*.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line703></span>         SET_LINKER_OUTPUT_WITHOUT_EXTENSION = <span class="library" title="false value">false</span>;
<span class="lineno" id=line704></span>         control.OUTPUT_FILENAME_WITHOUT_EXTENSION_SPECIFIED &lt;- 1;
<span class="lineno" id=line705></span>  
<span class="lineno" id=line706></span>      <span class="small_keyword" title="conditional">elif</span> SET_LINKER_OUTPUT_DIRECTORY <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line707></span>         control.LINKER_OUTPUT_FILENAME &lt;- arg;
<span class="lineno" id=line708></span>         debugln$ <span class="fstring">"Set linker output directory ="</span> + control*.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line709></span>         SET_LINKER_OUTPUT_DIRECTORY= <span class="library" title="false value">false</span>;
<span class="lineno" id=line710></span>         control.OUTPUT_DIRECTORY_SPECIFIED &lt;- 1;
<span class="lineno" id=line711></span>  
<span class="lineno" id=line712></span>  
<span class="lineno" id=line713></span>      <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"-o"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line714></span>        debugln <span class="fstring">"Set linker output name (next arg)"</span>;
<span class="lineno" id=line715></span>        SET_LINKER_OUTPUT=<span class="library" title="truth value">true</span>;
<span class="lineno" id=line716></span>  
<span class="lineno" id=line717></span>      <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"-ox"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line718></span>        debugln <span class="fstring">"Set linker output name (without extension) (next arg) "</span>;
<span class="lineno" id=line719></span>        SET_LINKER_OUTPUT_WITHOUT_EXTENSION=<span class="library" title="truth value">true</span>;
<span class="lineno" id=line720></span>  
<span class="lineno" id=line721></span>      <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"-od"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line722></span>        debugln <span class="fstring">"Set linker output directory (next arg) "</span>;
<span class="lineno" id=line723></span>        SET_LINKER_OUTPUT_DIRECTORY=<span class="library" title="truth value">true</span>;
<span class="lineno" id=line724></span>  
<span class="lineno" id=line725></span>  
<span class="lineno" id=line726></span>      <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line727></span>        ploopctl.grab &lt;- 0;
<span class="lineno" id=line728></span>  
<span class="lineno" id=line729></span>      <span class="small_keyword" title="conditional">elif</span> <span class="small_keyword" title="logical negation">not</span> (prefix (arg,<span class="fstring">"-"</span>)) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line730></span>        handle_filename(ploopctl,config,control,arg);
<span class="lineno" id=line731></span>  
<span class="lineno" id=line732></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line733></span>        handle_switch(config,control,arg);
<span class="lineno" id=line734></span>  
<span class="lineno" id=line735></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line736></span>      ploopctl.argno &lt;- ploopctl*.argno + 1;
<span class="lineno" id=line737></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line738></span>  
<span class="lineno" id=line739></span>    <span class="small_keyword" title="conditional">if</span> control*.CMDLINE_INPUT <span class="small_keyword" title="logical disjunction">or</span> control*.REPL_MODE <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line740></span>      handle_filename(ploopctl,config,control,<span class="fstring">"cmd.flx"</span>);
<span class="lineno" id=line741></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line742></span>     
<span class="lineno" id=line743></span>  }
<span class="lineno" id=line744></span>  
<span class="lineno" id=line745></span>  <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> processing_stage1
<span class="lineno" id=line746></span>  (
<span class="lineno" id=line747></span>    config:&amp;Config::config_type, 
<span class="lineno" id=line748></span>    control:&amp;FlxControl::control_type, 
<span class="lineno" id=line749></span>    xloopctl:&amp;FlxControl::loopctl_type,
<span class="lineno" id=line750></span>    vargs:<span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line751></span>  ) 
<span class="lineno" id=line752></span>  {
<span class="lineno" id=line753></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (x:<span class="library" title="binding of C++ string type">string</span>, y:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (x,y);
<span class="lineno" id=line754></span>  
<span class="lineno" id=line755></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> debugln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (x:T) {
<span class="lineno" id=line756></span>      <span class="small_keyword" title="conditional">if</span> control*.DEBUG_FLX <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line757></span>    }
<span class="lineno" id=line758></span>  
<span class="lineno" id=line759></span>    <span class="comment">// process environment variables</span>
<span class="lineno" id=line760></span>    <span class="small_keyword" title="conditional">if</span> Env::getenv <span class="fstring">"FLX_DEBUG_FLX"</span> != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line761></span>      control.DEBUG_FLX &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line762></span>      control.ECHO &lt;- 1;
<span class="lineno" id=line763></span>      debugln <span class="fstring">"debug flx tool ON"</span>;
<span class="lineno" id=line764></span>      control.DEBUG &lt;- 1;
<span class="lineno" id=line765></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line766></span>  
<span class="lineno" id=line767></span>    xparse_cmd_line(config,control,xloopctl, vargs);
<span class="lineno" id=line768></span>    <span class="small_keyword" title="conditional">if</span> control*.PRINT_HELP == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line769></span>      print_help;
<span class="lineno" id=line770></span>      System::exit(0);
<span class="lineno" id=line771></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line772></span>  
<span class="lineno" id=line773></span>    <span class="comment">//println$ "AFTER PROCESSING COMMAND LINE SWITCHES, prepend user package dir to flx_pkgconfig search path"; </span>
<span class="lineno" id=line774></span>    <span class="comment">//println $ "HOME:    Felix home dir is "+config*.FLX_HOME_DIR;</span>
<span class="lineno" id=line775></span>    <span class="comment">//println $ "BASE:    Felix package manager config directories are "+config*.FLX_CONFIG_DIRS.str;</span>
<span class="lineno" id=line776></span>    <span class="comment">//println $ "TARGET:  Felix target subdir  "+control*.FLX_TARGET_SUBDIR;</span>
<span class="lineno" id=line777></span>  <span class="big_keyword" title="Define a mutable variable">var</span> tgt =  control*.FLX_TARGET_SUBDIR;
<span class="lineno" id=line778></span>  tgt = <span class="small_keyword" title="conditional">if</span> tgt == <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">"host"</span> <span class="small_keyword" title="conditional">else</span> tgt;
<span class="lineno" id=line779></span>  config.FLX_CONFIG_DIRS &lt;- config*.FLX_HOME_DIR / tgt / <span class="fstring">"config"</span> + config*.FLX_CONFIG_DIRS;
<span class="lineno" id=line780></span>    <span class="comment">//println $ "UPDATED: Felix package manager config directories are "+config*.FLX_CONFIG_DIRS.str;</span>
<span class="lineno" id=line781></span>  
<span class="lineno" id=line782></span>    <span class="big_keyword" title="Define a mutable variable">var</span> xqt = dxqt (control*.ECHO==1 <span class="small_keyword" title="logical disjunction">or</span> control*.DEBUG_FLX);
<span class="lineno" id=line783></span>  
<span class="lineno" id=line784></span>    <span class="small_keyword" title="conditional">if</span> control*.LINKIT == 0 <span class="small_keyword" title="logical conjunction">and</span> control*.STATICLIB == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line785></span>      eprintln$ <span class="fstring">"Conflicting switches --nolink and --staticlib"</span>;
<span class="lineno" id=line786></span>      System::exit 1;
<span class="lineno" id=line787></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line788></span>  
<span class="lineno" id=line789></span>    debugln$ xloopctl*.grab, xloopctl*.argno, System::argc;
<span class="lineno" id=line790></span>  
<span class="lineno" id=line791></span>    <span class="comment">// Primary filename established.</span>
<span class="lineno" id=line792></span>    debugln <span class="fstring">"#--------"</span>;
<span class="lineno" id=line793></span>    debugln$ <span class="fstring">"DONE, option index = "</span>+<span class="library" title="Convert a value to a string">str</span>(xloopctl*.argno);
<span class="lineno" id=line794></span>    debugln$ <span class="fstring">"path="</span>+xloopctl*.path+<span class="fstring">": dir="</span>+xloopctl*.dir+<span class="fstring">",base="</span>+xloopctl*.base+<span class="fstring">", ext="</span>+xloopctl*.ext;
<span class="lineno" id=line795></span>    debugln$ <span class="fstring">"cs="</span>+<span class="library" title="Convert a value to a string">str</span> control*.cs;
<span class="lineno" id=line796></span>    debugln$ <span class="fstring">"cpps="</span>+<span class="library" title="Convert a value to a string">str</span> control*.cpps;
<span class="lineno" id=line797></span>    debugln$ <span class="fstring">"objcs="</span>+<span class="library" title="Convert a value to a string">str</span> control*.objcs;
<span class="lineno" id=line798></span>    debugln$ <span class="fstring">"objcpps="</span>+<span class="library" title="Convert a value to a string">str</span> control*.objcpps;
<span class="lineno" id=line799></span>    debugln$ <span class="fstring">"objs="</span>+<span class="library" title="Convert a value to a string">str</span> control*.objs;
<span class="lineno" id=line800></span>    debugln$ <span class="fstring">"cppobases="</span>+<span class="library" title="Convert a value to a string">str</span> control*.cppobases;
<span class="lineno" id=line801></span>  
<span class="lineno" id=line802></span>    debugln$ <span class="fstring">"ocamls="</span>+<span class="library" title="Convert a value to a string">str</span> control*.ocamls;
<span class="lineno" id=line803></span>    debugln$ <span class="fstring">"swifts="</span>+<span class="library" title="Convert a value to a string">str</span> control*.swifts;
<span class="lineno" id=line804></span>  
<span class="lineno" id=line805></span>  
<span class="lineno" id=line806></span>    <span class="comment">// Grab program arguments.</span>
<span class="lineno" id=line807></span>    <span class="small_keyword" title="while loop">while</span> xloopctl*.argno &lt; vargs.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line808></span>      control.USER_ARGS `(+=) vargs . (xloopctl*.argno); 
<span class="lineno" id=line809></span>      pre_incr (xloopctl.argno); 
<span class="lineno" id=line810></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line811></span>    debugln$ <span class="fstring">"USER_ARGS="</span> + <span class="library" title="Convert a value to a string">str</span> control*.USER_ARGS;
<span class="lineno" id=line812></span>  
<span class="lineno" id=line813></span>    debugln$ <span class="fstring">"config="</span> + <span class="library" title="Convert a value to a string">str</span> (*config);
<span class="lineno" id=line814></span>  
<span class="lineno" id=line815></span>    <span class="comment">// Establish C++ optimisation switches.</span>
<span class="lineno" id=line816></span>    <span class="small_keyword" title="conditional">if</span> control*.NOOPTIMISE == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line817></span>      debugln <span class="fstring">"Set C++ compiler optimisation switches"</span>;
<span class="lineno" id=line818></span>      control.CCFLAGS &lt;- control*.CCFLAGS+ control*.OPTIMISE;
<span class="lineno" id=line819></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line820></span>      debugln <span class="fstring">"What, no optimisation?"</span>;
<span class="lineno" id=line821></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line822></span>    <span class="comment">// Note we have to do it this way so the -f switches turn</span>
<span class="lineno" id=line823></span>    <span class="comment">// off optimisations previously introduced (order matters)</span>
<span class="lineno" id=line824></span>    control.CCFLAGS &lt;- control*.CCFLAGS + control*.EXTRA_CCFLAGS;
<span class="lineno" id=line825></span>    debugln$ <span class="fstring">"CCFLAGS ="</span> + <span class="library" title="Convert a value to a string">str</span> control*.CCFLAGS;
<span class="lineno" id=line826></span>  
<span class="lineno" id=line827></span>    <span class="comment">// Establish name of Felix compiler and run time library.</span>
<span class="lineno" id=line828></span>    <span class="comment">// The one in "host" is good enough for flxg, however the</span>
<span class="lineno" id=line829></span>    <span class="comment">// library location MUST be changed for cross compilation.</span>
<span class="lineno" id=line830></span>    <span class="comment">// FIXME!</span>
<span class="lineno" id=line831></span>    
<span class="lineno" id=line832></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dflt_flxg = <span class="fstring">""</span>;
<span class="lineno" id=line833></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dflt_flx_run = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line834></span>    <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line835></span>      dflt_flxg = Filename::join(config*.FLX_TARGET_DIR, <span class="fstring">'bin'</span>, <span class="fstring">'flxg.exe'</span>);
<span class="lineno" id=line836></span>      dflt_flx_run = <span class="library" title="functional, singly linked list">list</span>$ <span class="fstring">"set"</span>, <span class="fstring">"PATH="</span>+(Directory::mk_absolute_filename config*.FLX_TARGET_DIR)+<span class="fstring">"\\lib\\rtl;"</span>+<span class="fstring">"%PATH%&amp;&amp;"</span>;
<span class="lineno" id=line837></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line838></span>      dflt_flxg = config*.FLX_TARGET_DIR+<span class="fstring">"/bin/flxg"</span>;
<span class="lineno" id=line839></span>      <span class="comment">// the mac uses DYLD_LIBRARY_PATH instead of LD_LIBRARY_PATH</span>
<span class="lineno" id=line840></span>      <span class="small_keyword" title="conditional">if</span> PLAT_MACOSX <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line841></span>        dflt_flx_run = <span class="library" title="functional, singly linked list">list</span>$ <span class="fstring">"env"</span>,<span class="fstring">"DYLD_LIBRARY_PATH="</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl:$DYLD_LIBRARY_PATH"</span>;
<span class="lineno" id=line842></span>      <span class="small_keyword" title="conditional">elif</span> PLAT_CYGWIN <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line843></span>        <span class="comment">// hack: we need to set BOTH since PATH is used for load time dynamic linkage</span>
<span class="lineno" id=line844></span>        <span class="comment">// but LD_LIBRARY_PATH for run time (dlopen style) dynamic linkage</span>
<span class="lineno" id=line845></span>        dflt_flx_run = <span class="library" title="functional, singly linked list">list</span>$ <span class="fstring">"env"</span>,
<span class="lineno" id=line846></span>          <span class="fstring">"LD_LIBRARY_PATH="</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl:$LD_LIBRARY_PATH"</span>,
<span class="lineno" id=line847></span>          <span class="fstring">"PATH="</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl:$PATH"</span>
<span class="lineno" id=line848></span>      ;
<span class="lineno" id=line849></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line850></span>        dflt_flx_run = <span class="library" title="functional, singly linked list">list</span>$ <span class="fstring">"env"</span>, <span class="fstring">"LD_LIBRARY_PATH="</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl:$LD_LIBRARY_PATH"</span>;
<span class="lineno" id=line851></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line852></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line853></span>    control.FLXG &lt;- 
<span class="lineno" id=line854></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.FLXG <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line855></span>      | <span class="fstring">""</span> =&gt; dflt_flxg
<span class="lineno" id=line856></span>      | x =&gt; x
<span class="lineno" id=line857></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line858></span>    ;
<span class="lineno" id=line859></span>    debugln$ <span class="fstring">"FLXG = "</span> + control*.FLXG;
<span class="lineno" id=line860></span>    control.FLXRUN &lt;- 
<span class="lineno" id=line861></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.FLXRUN <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line862></span>      | #Empty =&gt; dflt_flx_run
<span class="lineno" id=line863></span>      | x =&gt; x
<span class="lineno" id=line864></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line865></span>    ;
<span class="lineno" id=line866></span>    debugln$ <span class="fstring">"FLXRUN = "</span> + control*.FLXRUN;
<span class="lineno" id=line867></span>  
<span class="lineno" id=line868></span>  
<span class="lineno" id=line869></span>    <span class="comment">// TEMPORARY HACK: use the right stuff from the felix.fpc file</span>
<span class="lineno" id=line870></span>    <span class="comment">// a bit later .. for now the OS selection macros will do ..</span>
<span class="lineno" id=line871></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> link_strings () = {
<span class="lineno" id=line872></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DLINK_STRING = <span class="fstring">""</span>;
<span class="lineno" id=line873></span>      <span class="big_keyword" title="Define a mutable variable">var</span> SLINK_STRING = <span class="fstring">""</span>;
<span class="lineno" id=line874></span>      <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// MSVC</span>
<span class="lineno" id=line875></span>        DLINK_STRING = <span class="fstring">"/LIBPATH:"</span>+config*.FLX_TARGET_DIR+r<span class="fstring">"\lib\rtl"</span>;
<span class="lineno" id=line876></span>        SLINK_STRING = <span class="fstring">"/LIBPATH:"</span>+config*.FLX_TARGET_DIR+r<span class="fstring">"\lib\rtl"</span>;
<span class="lineno" id=line877></span>      <span class="small_keyword" title="conditional">elif</span> PLAT_CYGWIN <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// gcc on Windows</span>
<span class="lineno" id=line878></span>        <span class="comment">//DLINK_STRING = "-L"+config*.FLX_TARGET_DIR+"/bin";</span>
<span class="lineno" id=line879></span>        DLINK_STRING = <span class="fstring">"-L"</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl"</span>;
<span class="lineno" id=line880></span>        SLINK_STRING = <span class="fstring">"-L"</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl"</span>;
<span class="lineno" id=line881></span>      <span class="small_keyword" title="conditional">else</span> <span class="comment">// Unix: gcc or clang</span>
<span class="lineno" id=line882></span>        DLINK_STRING = <span class="fstring">"-L"</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl"</span>;
<span class="lineno" id=line883></span>        SLINK_STRING = <span class="fstring">"-L"</span>+config*.FLX_TARGET_DIR+<span class="fstring">"/lib/rtl"</span>;
<span class="lineno" id=line884></span>      <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line885></span>      <span class="small_keyword" title="return">return</span> DLINK_STRING, SLINK_STRING;
<span class="lineno" id=line886></span>    }
<span class="lineno" id=line887></span>  
<span class="lineno" id=line888></span>  
<span class="lineno" id=line889></span>    <span class="comment">// Get linker names.</span>
<span class="lineno" id=line890></span>    <span class="big_keyword" title="Define a mutable variable">var</span> d,s = link_strings();
<span class="lineno" id=line891></span>    control.DLINK_STRINGS &lt;-  Shell::parse d;
<span class="lineno" id=line892></span>    control.SLINK_STRINGS &lt;-  Shell::parse s;
<span class="lineno" id=line893></span>  
<span class="lineno" id=line894></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> mkrel (d:<span class="library" title="binding of C++ string type">string</span>, f:<span class="library" title="binding of C++ string type">string</span>) =&gt; 
<span class="lineno" id=line895></span>      <span class="small_keyword" title="conditional">if</span> Filename::is_absolute_filename f <span class="small_keyword" title="conditional">then</span> f <span class="small_keyword" title="conditional">else</span> d / f <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line896></span>    ;
<span class="lineno" id=line897></span>  
<span class="lineno" id=line898></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dflt_grammar_dir = config*.FLX_SHARE_DIR/<span class="fstring">"lib"</span>;
<span class="lineno" id=line899></span>  
<span class="lineno" id=line900></span>    control.GRAMMAR_DIR &lt;-
<span class="lineno" id=line901></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.GRAMMAR_DIR <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line902></span>      | <span class="fstring">""</span> =&gt; dflt_grammar_dir 
<span class="lineno" id=line903></span>      | x =&gt; Directory::mk_absolute_filename x 
<span class="lineno" id=line904></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line905></span>    ;
<span class="lineno" id=line906></span>    debugln$ <span class="fstring">"GRAMMAR_DIR = "</span> + control*.GRAMMAR_DIR;
<span class="lineno" id=line907></span>  
<span class="lineno" id=line908></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dflt_grammar = Directory::mk_absolute_filename 
<span class="lineno" id=line909></span>      (Filename::join (control*.GRAMMAR_DIR,<span class="fstring">"grammar/grammar.files"</span>))
<span class="lineno" id=line910></span>    ;
<span class="lineno" id=line911></span>    control.STDGRAMMAR &lt;- 
<span class="lineno" id=line912></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.STDGRAMMAR <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line913></span>      | <span class="fstring">""</span> =&gt; dflt_grammar 
<span class="lineno" id=line914></span>      | x =&gt; 
<span class="lineno" id=line915></span>        <span class="small_keyword" title="conditional">if</span> Filename::is_absolute_filename x <span class="small_keyword" title="conditional">then</span> x 
<span class="lineno" id=line916></span>        <span class="small_keyword" title="conditional">else</span> Filename::join (control*.GRAMMAR_DIR, x) 
<span class="lineno" id=line917></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line918></span>    ;
<span class="lineno" id=line919></span>    debugln$ <span class="fstring">"STDGRAMMAR = "</span> + control*.STDGRAMMAR;
<span class="lineno" id=line920></span>  
<span class="lineno" id=line921></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dflt_automaton = 
<span class="lineno" id=line922></span>      cache_join
<span class="lineno" id=line923></span>      (
<span class="lineno" id=line924></span>        config*.FLX_CACHE_DIR, 
<span class="lineno" id=line925></span>        Filename::join (control*.STDGRAMMAR, <span class="fstring">"syntax.automaton"</span>)
<span class="lineno" id=line926></span>      )
<span class="lineno" id=line927></span>    ;
<span class="lineno" id=line928></span>    control.AUTOMATON &lt;- 
<span class="lineno" id=line929></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.AUTOMATON <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line930></span>      | <span class="fstring">""</span> =&gt; dflt_automaton 
<span class="lineno" id=line931></span>      | x =&gt; x 
<span class="lineno" id=line932></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line933></span>    ;
<span class="lineno" id=line934></span>    debugln$ <span class="fstring">"AUTOMATON = "</span> + control*.AUTOMATON;
<span class="lineno" id=line935></span>  
<span class="lineno" id=line936></span>  
<span class="lineno" id=line937></span>    <span class="comment">// this hack forces a directory name, because executing "prog"</span>
<span class="lineno" id=line938></span>    <span class="comment">// can fail if the currect directory is not on the PATH, </span>
<span class="lineno" id=line939></span>    <span class="comment">// or worse, the wrong program can execute. The PATH is not</span>
<span class="lineno" id=line940></span>    <span class="comment">// searched if the filename includes a / somewhere so force one in.</span>
<span class="lineno" id=line941></span>    <span class="comment">// similarly for dynamic loaders looking for shared libraries</span>
<span class="lineno" id=line942></span>    <span class="comment">//</span>
<span class="lineno" id=line943></span>    <span class="comment">// It would probably be better to convert any relative filename</span>
<span class="lineno" id=line944></span>    <span class="comment">// to an absolute one, however this only makes sense on Unix </span>
<span class="lineno" id=line945></span>    <span class="comment">// since Windows has multiple "drives" it is much harder to</span>
<span class="lineno" id=line946></span>    <span class="comment">// do the conversion.</span>
<span class="lineno" id=line947></span>    xloopctl.dir &lt;- 
<span class="lineno" id=line948></span>      <span class="small_keyword" title="conditional">if</span> xloopctl*.dir != <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> xloopctl*.dir 
<span class="lineno" id=line949></span>      <span class="small_keyword" title="conditional">else</span> <span class="fstring">"."</span>
<span class="lineno" id=line950></span>      <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line951></span>    ;
<span class="lineno" id=line952></span>  }
<span class="lineno" id=line953></span>  }
<span class="lineno" id=line954></span>  
</pre></p></div><h2 id='Calculate_Dependent_variables._h'><img src='/share/src/web/images/minus.gif' id='Calculate Dependent variables.' onclick='toggle(this,"Calculate_Dependent_variables._d")' alt='+'/> 1.4 Calculate Dependent variables.</h2><div id='Calculate_Dependent_variables._d' style='display:block'>
<p>Computes all the detailed variables needed to run the various
tools from a base configuration.
</p><pre class='inclusion'>
share/lib/std/felix/flx/flx_depvars.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_control"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> FlxDepvars
<span class="lineno" id=line4></span>  {
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Define an alias for a type expression">typedef</span> dvars_type = (
<span class="lineno" id=line6></span>      filebase:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line7></span>      cpp_filebase:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line8></span>      args: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line9></span>      use_ext:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line10></span>      FLX_STD_LIBS: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line11></span>      GRAMMAR_DIR: <span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line12></span>      STDGRAMMAR: <span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line13></span>      AUTOMATON: <span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line14></span>      DEBUGSWITCH:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line15></span>      STATIC_ENV:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line16></span>      VERBOSE: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line17></span>    );
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>  <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cal_depvars(
<span class="lineno" id=line20></span>    toolchain_maker: toolchain_config_t -&gt; toolchain_t, 
<span class="lineno" id=line21></span>    c_compiler_executable: <span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line22></span>    cxx_compiler_executable: <span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line23></span>    config:Config::config_type,
<span class="lineno" id=line24></span>    control:&amp;FlxControl::control_type, 
<span class="lineno" id=line25></span>    loopctl:FlxControl::loopctl_type) 
<span class="lineno" id=line26></span>    : dvars_type 
<span class="lineno" id=line27></span>    = 
<span class="lineno" id=line28></span>  {
<span class="lineno" id=line29></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> debugln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (x:T) {
<span class="lineno" id=line30></span>      <span class="small_keyword" title="conditional">if</span> control*.DEBUG_FLX <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line31></span>    }
<span class="lineno" id=line32></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (d:<span class="library" title="binding of C++ string type">string</span>, f:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (d,f);
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>    <span class="comment">// case 1 of dflt</span>
<span class="lineno" id=line35></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dflt_toolchain_config = (
<span class="lineno" id=line36></span>        c_compiler_executable = c_compiler_executable,
<span class="lineno" id=line37></span>        cxx_compiler_executable = cxx_compiler_executable,
<span class="lineno" id=line38></span>        header_search_dirs = Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line39></span>        macros = Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line40></span>        library_search_dirs= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line41></span>        ccflags= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line42></span>        dynamic_libraries= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line43></span>        static_libraries= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line44></span>        debugln = debugln[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line45></span>    );
<span class="lineno" id=line46></span>    <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker dflt_toolchain_config;
<span class="lineno" id=line47></span>    <span class="big_keyword" title="Define a mutable variable">var</span> EXT_LIB = #(tc.static_library_extension);
<span class="lineno" id=line48></span>    <span class="big_keyword" title="Define a mutable variable">var</span> EXT_SHLIB = #(tc.dynamic_library_extension);
<span class="lineno" id=line49></span>    <span class="big_keyword" title="Define a mutable variable">var</span> EXT_EXE = #(tc.executable_extension);
<span class="lineno" id=line50></span>    <span class="big_keyword" title="Define a mutable variable">var</span> EXT_STATIC_OBJ = #(tc.static_object_extension);
<span class="lineno" id=line51></span>    <span class="big_keyword" title="Define a mutable variable">var</span> EXT_SHARED_OBJ = #(tc.dynamic_object_extension);
<span class="lineno" id=line52></span>    <span class="big_keyword" title="Define a mutable variable">var</span> DEBUG_FLAGS = #(tc.debug_flags);
<span class="lineno" id=line53></span>  
<span class="lineno" id=line54></span>  
<span class="lineno" id=line55></span>    debugln$ <span class="fstring">"Felix package manager config directories are "</span>+config.FLX_CONFIG_DIRS.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line56></span>    <span class="comment">// make a list of any *.cpp files (or other g++ options ..)</span>
<span class="lineno" id=line57></span>  
<span class="lineno" id=line58></span>    debugln$ <span class="fstring">"FileDir= "</span> + loopctl.dir;
<span class="lineno" id=line59></span>    <span class="big_keyword" title="Define a mutable variable">var</span> rel_filebase = <span class="small_keyword" title="conditional">if</span> loopctl.dir == <span class="fstring">"."</span> <span class="small_keyword" title="conditional">then</span> loopctl.base <span class="small_keyword" title="conditional">else</span> Filename::join(loopctl.dir,loopctl.base);
<span class="lineno" id=line60></span>    debugln$ <span class="fstring">"Rel_filebase= "</span> + rel_filebase;
<span class="lineno" id=line61></span>    debugln$ <span class="fstring">"Given Extension="</span> + loopctl.ext;
<span class="lineno" id=line62></span>  
<span class="lineno" id=line63></span>      <span class="comment">// this is a hack! We should resolve the filename first.</span>
<span class="lineno" id=line64></span>    <span class="big_keyword" title="Define a mutable variable">var</span> use_ext = <span class="small_keyword" title="conditional">if</span> loopctl.ext != <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> loopctl.ext <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line65></span>      #{ 
<span class="lineno" id=line66></span>         <span class="big_keyword" title="Define a mutable variable">var</span> flxt = FileStat::dfiletime (rel_filebase+<span class="fstring">".flx"</span>,#FileStat::past_time);
<span class="lineno" id=line67></span>         <span class="big_keyword" title="Define a mutable variable">var</span> fdoct = FileStat::dfiletime (rel_filebase+<span class="fstring">".fdoc"</span>,#FileStat::past_time);
<span class="lineno" id=line68></span>         <span class="small_keyword" title="return">return</span> 
<span class="lineno" id=line69></span>           <span class="small_keyword" title="conditional">if</span> flxt &gt; fdoct <span class="small_keyword" title="conditional">then</span> <span class="fstring">".flx"</span>
<span class="lineno" id=line70></span>           <span class="small_keyword" title="conditional">elif</span> fdoct &gt; flxt <span class="small_keyword" title="conditional">then</span> <span class="fstring">".fdoc"</span>
<span class="lineno" id=line71></span>           <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span>
<span class="lineno" id=line72></span>         ;
<span class="lineno" id=line73></span>      }
<span class="lineno" id=line74></span>    ;
<span class="lineno" id=line75></span>    debugln$ <span class="fstring">"Computed Extension="</span> + use_ext;
<span class="lineno" id=line76></span>    <span class="big_keyword" title="Define a mutable variable">var</span> filebase = Directory::mk_absolute_filename$ rel_filebase;
<span class="lineno" id=line77></span>    debugln$ <span class="fstring">"User program base is "</span> + filebase;
<span class="lineno" id=line78></span>    <span class="big_keyword" title="Define a mutable variable">var</span> cpp_filebase =
<span class="lineno" id=line79></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.BUNDLE_DIR <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line80></span>      | Some dir =&gt; Filename::join(dir,Filename::basename filebase)
<span class="lineno" id=line81></span>      | #None =&gt;<span class="small_keyword" title="conditional">if</span> config.FLX_OUTPUT_DIR==<span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> filebase 
<span class="lineno" id=line82></span>               <span class="small_keyword" title="conditional">else</span> cache_join(config.FLX_OUTPUT_DIR,filebase) 
<span class="lineno" id=line83></span>               <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line84></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;         
<span class="lineno" id=line85></span>    debugln$ <span class="fstring">"C++ file base is "</span> + cpp_filebase;
<span class="lineno" id=line86></span>  
<span class="lineno" id=line87></span>    <span class="comment">// if we're supposed to check output against an expect file,</span>
<span class="lineno" id=line88></span>    <span class="comment">// and no stdout file name is given, then direct output</span>
<span class="lineno" id=line89></span>    <span class="comment">// into the cache.</span>
<span class="lineno" id=line90></span>    <span class="small_keyword" title="conditional">if</span> control*.CHECK_EXPECT != 0 <span class="small_keyword" title="logical conjunction">and</span> control*.STDOUT == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line91></span>      control.STDOUT &lt;- cache_join (config.FLX_OUTPUT_DIR,filebase + <span class="fstring">".stdout"</span>);
<span class="lineno" id=line92></span>      debugln$ <span class="fstring">"Set stdout to "</span> + control*.STDOUT;
<span class="lineno" id=line93></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line94></span>  
<span class="lineno" id=line95></span>    <span class="small_keyword" title="conditional">if</span> control*.SET_STDIN != 0 <span class="small_keyword" title="logical conjunction">and</span> control*.STDIN == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line96></span>      <span class="big_keyword" title="Define a mutable variable">var</span> stdin_name = filebase + <span class="fstring">".input"</span>; 
<span class="lineno" id=line97></span>      <span class="small_keyword" title="conditional">if</span> FileStat::fileexists stdin_name  <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line98></span>        control.STDIN &lt;- stdin_name;
<span class="lineno" id=line99></span>      <span class="small_keyword" title="conditional">elif</span> control*.INREGEX == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line100></span>        eprintln$ <span class="fstring">"WARNING: computed input file "</span> + stdin_name + <span class="fstring">" doesn't exist!"</span>;
<span class="lineno" id=line101></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line102></span>      debugln$ <span class="fstring">"Set stdin to "</span> + control*.STDIN;
<span class="lineno" id=line103></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line104></span>  
<span class="lineno" id=line105></span>  
<span class="lineno" id=line106></span>    <span class="comment">// if we're supposed to check output against an expect file,</span>
<span class="lineno" id=line107></span>    <span class="comment">// and no expect file name is given, then use the filebase</span>
<span class="lineno" id=line108></span>    <span class="comment">// with extension .expect.</span>
<span class="lineno" id=line109></span>    <span class="small_keyword" title="conditional">if</span> control*.CHECK_EXPECT != 0 <span class="small_keyword" title="logical conjunction">and</span> control*.EXPECT == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line110></span>      <span class="big_keyword" title="Define a mutable variable">var</span> expect_name = filebase + <span class="fstring">".expect"</span>;
<span class="lineno" id=line111></span>      <span class="small_keyword" title="conditional">if</span> FileStat::fileexists expect_name <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line112></span>        control.EXPECT &lt;- expect_name;
<span class="lineno" id=line113></span>      <span class="small_keyword" title="conditional">elif</span> control*.INREGEX == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line114></span>        eprintln$ <span class="fstring">"WARNING: computed expect file "</span> + expect_name + <span class="fstring">" doesn't exist!"</span>;
<span class="lineno" id=line115></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line116></span>      debugln$ <span class="fstring">"Set expect to "</span> + control*.EXPECT;
<span class="lineno" id=line117></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line118></span>  
<span class="lineno" id=line119></span>  
<span class="lineno" id=line120></span>    <span class="comment">// Find absolute pathname</span>
<span class="lineno" id=line121></span>  
<span class="lineno" id=line122></span>    <span class="small_keyword" title="conditional">if</span> loopctl.path == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line123></span>      fprint$ cstderr, (<span class="fstring">"No such felix program: "</span>+loopctl.path+<span class="fstring">"\n"</span>);
<span class="lineno" id=line124></span>      System::exit(1);
<span class="lineno" id=line125></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line126></span>  
<span class="lineno" id=line127></span>    control.FLX_INTERFACE_FILENAME &lt;- 
<span class="lineno" id=line128></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.BUNDLE_DIR <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line129></span>      | Some dir =&gt; Filename::join(dir,Filename::basename filebase+<span class="fstring">"_interface.flx"</span>)
<span class="lineno" id=line130></span>      | #None =&gt; cache_join (config.FLX_OUTPUT_DIR,filebase+<span class="fstring">"_interface.flx"</span>)
<span class="lineno" id=line131></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;         
<span class="lineno" id=line132></span>    debugln$ <span class="fstring">"Flx interface filename is "</span> + control*.FLX_INTERFACE_FILENAME;
<span class="lineno" id=line133></span>  
<span class="lineno" id=line134></span>    control.CXX_INTERFACE_FILENAME &lt;- 
<span class="lineno" id=line135></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.BUNDLE_DIR <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line136></span>      | Some dir =&gt; Filename::join(dir,Filename::basename filebase+<span class="fstring">".hpp"</span>)
<span class="lineno" id=line137></span>      | #None =&gt; cache_join (config.FLX_OUTPUT_DIR,filebase+<span class="fstring">".hpp"</span>)
<span class="lineno" id=line138></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;         
<span class="lineno" id=line139></span>    debugln$ <span class="fstring">"C++ interface filename is "</span> + control*.FLX_INTERFACE_FILENAME;
<span class="lineno" id=line140></span>  
<span class="lineno" id=line141></span>    <span class="small_keyword" title="conditional">if</span> control*.LINKER_OUTPUT_FILENAME == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line142></span>      <span class="small_keyword" title="conditional">if</span> control*.LINKIT == 1 <span class="small_keyword" title="logical disjunction">or</span> control*.RUNONLY == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line143></span>        <span class="small_keyword" title="conditional">if</span> control*.STATICLIB == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line144></span>          <span class="big_keyword" title="Define a mutable variable">var</span> f = filebase+EXT_LIB;
<span class="lineno" id=line145></span>        <span class="small_keyword" title="conditional">elif</span> control*.STATIC == 0 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// dynamic</span>
<span class="lineno" id=line146></span>          <span class="small_keyword" title="conditional">if</span> control*.LINKEXE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line147></span>            f = filebase+EXT_LIB;
<span class="lineno" id=line148></span>          <span class="small_keyword" title="conditional">else</span> <span class="comment">// DLL</span>
<span class="lineno" id=line149></span>            f = filebase+EXT_SHLIB;
<span class="lineno" id=line150></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line151></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line152></span>          f = filebase+EXT_EXE;
<span class="lineno" id=line153></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line154></span>      <span class="small_keyword" title="conditional">else</span> <span class="comment">// No link, name specifies object file only.</span>
<span class="lineno" id=line155></span>        <span class="small_keyword" title="conditional">if</span> control*.STATIC == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line156></span>          f = filebase+EXT_STATIC_OBJ;
<span class="lineno" id=line157></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line158></span>          f = filebase+EXT_SHARED_OBJ;
<span class="lineno" id=line159></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line160></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line161></span>      control.LINKER_OUTPUT_FILENAME &lt;- cache_join (config.FLX_CACHE_DIR,f);
<span class="lineno" id=line162></span>      debugln$ <span class="fstring">"Felx writing output binary to "</span> + control*.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line163></span>    <span class="small_keyword" title="conditional">elif</span> control*.OUTPUT_FILENAME_WITHOUT_EXTENSION_SPECIFIED == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line164></span>      <span class="small_keyword" title="conditional">if</span> control*.LINKIT == 1 <span class="small_keyword" title="logical disjunction">or</span> control*.RUNONLY == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line165></span>        <span class="small_keyword" title="conditional">if</span> control*.STATICLIB == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line166></span>          control.LINKER_OUTPUT_FILENAME `(+=) EXT_LIB;
<span class="lineno" id=line167></span>        <span class="small_keyword" title="conditional">elif</span> control*.STATIC == 0 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// dynamic</span>
<span class="lineno" id=line168></span>          <span class="small_keyword" title="conditional">if</span> control*.LINKEXE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line169></span>            control.LINKER_OUTPUT_FILENAME `(+=) EXT_EXE;
<span class="lineno" id=line170></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line171></span>            control.LINKER_OUTPUT_FILENAME `(+=) EXT_SHLIB;
<span class="lineno" id=line172></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line173></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line174></span>          control.LINKER_OUTPUT_FILENAME `(+=) EXT_EXE;
<span class="lineno" id=line175></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line176></span>      <span class="small_keyword" title="conditional">else</span> <span class="comment">// No link, name specifies object file only.</span>
<span class="lineno" id=line177></span>        <span class="small_keyword" title="conditional">if</span> control*.STATIC == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line178></span>          control.LINKER_OUTPUT_FILENAME `(+=) EXT_STATIC_OBJ;
<span class="lineno" id=line179></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line180></span>          control.LINKER_OUTPUT_FILENAME `(+=) EXT_SHARED_OBJ;
<span class="lineno" id=line181></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line182></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line183></span>    <span class="small_keyword" title="conditional">elif</span> control*.OUTPUT_DIRECTORY_SPECIFIED == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line184></span>      <span class="big_keyword" title="Define a mutable variable">var</span> basename = Filename::basename (Filename::strip_extension filebase);
<span class="lineno" id=line185></span>      <span class="small_keyword" title="conditional">if</span> control*.LINKIT == 1 <span class="small_keyword" title="logical disjunction">or</span> control*.RUNONLY == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line186></span>        <span class="small_keyword" title="conditional">if</span> control*.STATICLIB == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line187></span>          control.LINKER_OUTPUT_FILENAME &lt;- control*.LINKER_OUTPUT_FILENAME / basename + EXT_LIB;
<span class="lineno" id=line188></span>        <span class="small_keyword" title="conditional">elif</span> control*.STATIC == 0 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// dynamic</span>
<span class="lineno" id=line189></span>          <span class="small_keyword" title="conditional">if</span> control*.LINKEXE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line190></span>            control.LINKER_OUTPUT_FILENAME &lt;- control*.LINKER_OUTPUT_FILENAME / basename + EXT_EXE;
<span class="lineno" id=line191></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line192></span>            control.LINKER_OUTPUT_FILENAME &lt;- control*.LINKER_OUTPUT_FILENAME / basename + EXT_SHLIB;
<span class="lineno" id=line193></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line194></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line195></span>          control.LINKER_OUTPUT_FILENAME &lt;- control*.LINKER_OUTPUT_FILENAME / basename + EXT_EXE;
<span class="lineno" id=line196></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line197></span>      <span class="small_keyword" title="conditional">else</span> <span class="comment">// No link, name specifies object file only.</span>
<span class="lineno" id=line198></span>        <span class="small_keyword" title="conditional">if</span> control*.STATIC == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line199></span>          control.LINKER_OUTPUT_FILENAME &lt;- control*.LINKER_OUTPUT_FILENAME / basename + EXT_STATIC_OBJ;
<span class="lineno" id=line200></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line201></span>          control.LINKER_OUTPUT_FILENAME &lt;- control*.LINKER_OUTPUT_FILENAME / basename + EXT_SHARED_OBJ;
<span class="lineno" id=line202></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line203></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line204></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line205></span>    control.LINKER_OUTPUT_FILENAME &lt;-  Directory::mk_absolute_filename control*.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line206></span>    control.LINKER_OUTPUT_FILENAME &lt;-
<span class="lineno" id=line207></span>     <span class="small_keyword" title="match statement or expression">match</span> control*.BUNDLE_DIR <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line208></span>      | Some dir =&gt; Filename::join(dir,Filename::basename control*.LINKER_OUTPUT_FILENAME)
<span class="lineno" id=line209></span>      | #None =&gt; control*.LINKER_OUTPUT_FILENAME
<span class="lineno" id=line210></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;         
<span class="lineno" id=line211></span>    debugln$ <span class="fstring">"Linker output filename "</span> + control*.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line212></span>   
<span class="lineno" id=line213></span>  
<span class="lineno" id=line214></span>    <span class="big_keyword" title="Define an immutable value">val</span> args = control*.USER_ARGS;
<span class="lineno" id=line215></span>    debugln$ <span class="fstring">"Target program args = "</span>+args.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line216></span>  
<span class="lineno" id=line217></span>    <span class="small_keyword" title="conditional">if</span> control*.NOSTDLIB == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line218></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLX_STD_LIBS=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line219></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line220></span>      <span class="small_keyword" title="match statement or expression">match</span> control*.FLX_STD_LIBS <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line221></span>      | #Empty =&gt; FLX_STD_LIBS = <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] (<span class="fstring">"std"</span>);
<span class="lineno" id=line222></span>      | x =&gt; FLX_STD_LIBS = x;
<span class="lineno" id=line223></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line224></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line225></span>    debugln$ <span class="fstring">"Felix standard (cached) libraries: "</span> + <span class="library" title="Convert a value to a string">str</span> FLX_STD_LIBS;
<span class="lineno" id=line226></span>  
<span class="lineno" id=line227></span>    <span class="big_keyword" title="Define a mutable variable">var</span> STDGRAMMAR = Directory::mk_absolute_filename control*.STDGRAMMAR;
<span class="lineno" id=line228></span>    <span class="big_keyword" title="Define a mutable variable">var</span> GRAMMAR_DIR = Directory::mk_absolute_filename control*.GRAMMAR_DIR;
<span class="lineno" id=line229></span>    <span class="big_keyword" title="Define a mutable variable">var</span> AUTOMATON = Directory::mk_absolute_filename control*.AUTOMATON;
<span class="lineno" id=line230></span>  
<span class="lineno" id=line231></span>    <span class="big_keyword" title="Define a mutable variable">var</span> DEBUGSWITCH=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line232></span>    <span class="small_keyword" title="conditional">if</span> control*.DEBUG == 1 <span class="small_keyword" title="imperative code begins">do</span> DEBUGSWITCH=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$ <span class="fstring">"--debug"</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line233></span>  
<span class="lineno" id=line234></span>    <span class="big_keyword" title="Define a mutable variable">var</span> STATIC_ENV=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line235></span>    <span class="small_keyword" title="conditional">if</span> control*.DEBUG == 1 <span class="small_keyword" title="imperative code begins">do</span> STATIC_ENV=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] (<span class="fstring">"env"</span>,<span class="fstring">"FLX_DEBUG=1"</span>); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line236></span>  
<span class="lineno" id=line237></span>    debugln$ <span class="fstring">"RECOMPILE="</span>+<span class="library" title="Convert a value to a string">str</span> control*.RECOMPILE;
<span class="lineno" id=line238></span>    debugln$ <span class="fstring">"RUNIT="</span>+<span class="library" title="Convert a value to a string">str</span> control*.RUNIT;
<span class="lineno" id=line239></span>  
<span class="lineno" id=line240></span>    <span class="big_keyword" title="Define a mutable variable">var</span> VERBOSE = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line241></span>    <span class="small_keyword" title="conditional">if</span> control*.DEBUG_COMPILER == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line242></span>      VERBOSE=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] <span class="fstring">"-v"</span>;
<span class="lineno" id=line243></span>      debugln <span class="fstring">"Compiler debugging on"</span>;
<span class="lineno" id=line244></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line245></span>      VERBOSE=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]$  <span class="fstring">"-q"</span>;
<span class="lineno" id=line246></span>      debugln <span class="fstring">"Compiler debugging off"</span>;
<span class="lineno" id=line247></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line248></span>  
<span class="lineno" id=line249></span>    <span class="small_keyword" title="conditional">if</span> control*.DEBUG==1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line250></span>      control.CCFLAGS &lt;- control*.CCFLAGS+DEBUG_FLAGS;
<span class="lineno" id=line251></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line252></span>  
<span class="lineno" id=line253></span>  
<span class="lineno" id=line254></span>    <span class="small_keyword" title="return">return</span> <span class="big_keyword" title="Define a structure">struct</span> { 
<span class="lineno" id=line255></span>      <span class="big_keyword" title="Define a mutable variable">var</span> filebase=filebase;
<span class="lineno" id=line256></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cpp_filebase=cpp_filebase;
<span class="lineno" id=line257></span>      <span class="big_keyword" title="Define a mutable variable">var</span> args = args;
<span class="lineno" id=line258></span>      <span class="big_keyword" title="Define a mutable variable">var</span> use_ext = use_ext;
<span class="lineno" id=line259></span>      <span class="big_keyword" title="Define a mutable variable">var</span> FLX_STD_LIBS=FLX_STD_LIBS;
<span class="lineno" id=line260></span>      <span class="big_keyword" title="Define a mutable variable">var</span> AUTOMATON=AUTOMATON;
<span class="lineno" id=line261></span>      <span class="big_keyword" title="Define a mutable variable">var</span> GRAMMAR_DIR=GRAMMAR_DIR;
<span class="lineno" id=line262></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STDGRAMMAR=STDGRAMMAR;
<span class="lineno" id=line263></span>      <span class="big_keyword" title="Define a mutable variable">var</span> DEBUGSWITCH=DEBUGSWITCH;
<span class="lineno" id=line264></span>      <span class="big_keyword" title="Define a mutable variable">var</span> STATIC_ENV=STATIC_ENV;
<span class="lineno" id=line265></span>      <span class="big_keyword" title="Define a mutable variable">var</span> VERBOSE = VERBOSE;
<span class="lineno" id=line266></span>    };
<span class="lineno" id=line267></span>  
<span class="lineno" id=line268></span>  } <span class="comment">// fun cal_depvars</span>
<span class="lineno" id=line269></span>  } <span class="comment">// class FlxDepvars</span>
<span class="lineno" id=line270></span>  
</pre></p></div><h2 id='The_execution_manager._h'><img src='/share/src/web/images/minus.gif' id='The execution manager.' onclick='toggle(this,"The_execution_manager._d")' alt='+'/> 1.5 The execution manager.</h2><div id='The_execution_manager._d' style='display:block'>
<p>This part of the flx tool is responsible for
calculating dependencies and actually running the
external compilers.
</p><pre class='inclusion'>
share/lib/std/felix/flx/flx_run.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_depchk"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_control"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_depvars"</span>;
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> dxqt(DBG:bool) (cmd:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line6></span>    <span class="small_keyword" title="conditional">if</span> DBG <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"cmd="</span>+cmd);
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Define a mutable variable">var</span> now = #Time::time;
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span>,output = Shell::get_stdout(cmd);
<span class="lineno" id=line9></span>    <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line10></span>      n := 
<span class="lineno" id=line11></span>        <span class="small_keyword" title="match statement or expression">match</span> find_first_of (output, <span class="library" title="binding of C char type">char</span> <span class="fstring">"\n"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line12></span>        | Some n =&gt; n 
<span class="lineno" id=line13></span>        | #None =&gt; output.<span class="library" title="number of elements in data structure">len</span>
<span class="lineno" id=line14></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line15></span>      ; 
<span class="lineno" id=line16></span>      output = output.[<span class="small_keyword" title="substring range separator">to</span> n]; <span class="comment">// first line excluding newline</span>
<span class="lineno" id=line17></span>      <span class="big_keyword" title="Define a mutable variable">var</span> elapsed = #Time::time - now;
<span class="lineno" id=line18></span>      <span class="small_keyword" title="conditional">if</span> DBG <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"Popen:Elapsed: "</span> + fmt (elapsed, fixed(9,3)) + <span class="fstring">", output='"</span>+output+<span class="fstring">"'"</span>);
<span class="lineno" id=line19></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line20></span>      <span class="small_keyword" title="conditional">if</span> DBG <span class="small_keyword" title="call a procedure">call</span> eprintln <span class="fstring">"COMMAND FAILED"</span>;
<span class="lineno" id=line21></span>      fprint$ cstderr, (<span class="fstring">"Error "</span>+repr(<span class="small_keyword" title="value of function return used in post condition">result</span>)+<span class="fstring">" executing command "</span> + cmd + <span class="fstring">"\n"</span>);
<span class="lineno" id=line22></span>      System::pexit <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line23></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line24></span>    <span class="small_keyword" title="return">return</span> output;
<span class="lineno" id=line25></span>  }
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> xdebugln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (d:bool) (x:T) {
<span class="lineno" id=line28></span>    <span class="small_keyword" title="conditional">if</span> d <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line29></span>  }
<span class="lineno" id=line30></span>  
<span class="lineno" id=line31></span>  <span class="comment">// CLEAR_CACHE is set to 1 if the cache is reset</span>
<span class="lineno" id=line32></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> check_cache(
<span class="lineno" id=line33></span>    config:&amp;Config::config_type, 
<span class="lineno" id=line34></span>    control:&amp;FlxControl::control_type)
<span class="lineno" id=line35></span>  {
<span class="lineno" id=line36></span>    <span class="big_keyword" title="Define a mutable variable">var</span> cc,ct = validate_cache (
<span class="lineno" id=line37></span>      FLX_SHARE_DIR = config*.FLX_SHARE_DIR,
<span class="lineno" id=line38></span>      AUTOMATON = control*.AUTOMATON,
<span class="lineno" id=line39></span>      GRAMMAR_DIR = control*.GRAMMAR_DIR,
<span class="lineno" id=line40></span>      STDGRAMMAR = control*.STDGRAMMAR,
<span class="lineno" id=line41></span>      FLXG = control*.FLXG,
<span class="lineno" id=line42></span>      CACHE_DIR = config*.FLX_CACHE_DIR,
<span class="lineno" id=line43></span>      OUTPUT_DIR = config*.FLX_OUTPUT_DIR,
<span class="lineno" id=line44></span>      CLEAR_CACHE= control*.CLEAR_CACHE,
<span class="lineno" id=line45></span>      debugln = xdebugln[<span class="library" title="binding of C++ string type">string</span>] (control*.DEBUG_FLX),
<span class="lineno" id=line46></span>      xqt = dxqt (control*.ECHO == 1 <span class="small_keyword" title="logical disjunction">or</span> control*.DEBUG_FLX),
<span class="lineno" id=line47></span>      quote = Shell::quote_arg
<span class="lineno" id=line48></span>    );
<span class="lineno" id=line49></span>    control.CLEAR_CACHE &lt;- cc;
<span class="lineno" id=line50></span>    control.cache_time &lt;-  ct;
<span class="lineno" id=line51></span>  }
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>  <span class="big_keyword" title="define an object factory">object</span> processing_env(
<span class="lineno" id=line54></span>    toolchain_maker: toolchain_config_t -&gt; toolchain_t,
<span class="lineno" id=line55></span>    c_compiler_executable: <span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line56></span>    cxx_compiler_executable: <span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line57></span>    config:Config::config_type, 
<span class="lineno" id=line58></span>    <span class="big_keyword" title="Define a mutable variable">var</span> control:FlxControl::control_type,
<span class="lineno" id=line59></span>    dvars:FlxDepvars::dvars_type)
<span class="lineno" id=line60></span>  =
<span class="lineno" id=line61></span>  {
<span class="lineno" id=line62></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> debugln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (x:T) {
<span class="lineno" id=line63></span>      <span class="small_keyword" title="conditional">if</span> control.DEBUG_FLX <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line64></span>    }
<span class="lineno" id=line65></span>  
<span class="lineno" id=line66></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> echoln[T <span class="small_keyword" title="type-class constraint">with</span> Str[T]] (x:T) {
<span class="lineno" id=line67></span>      <span class="small_keyword" title="conditional">if</span> control.ECHO == 1 <span class="small_keyword" title="call a procedure">call</span> fprintln (cstderr, <span class="fstring">"[flx] "</span> + <span class="library" title="Convert a value to a string">str</span> x);
<span class="lineno" id=line68></span>    }
<span class="lineno" id=line69></span>  
<span class="lineno" id=line70></span>    <span class="comment">// case 2 of dflt</span>
<span class="lineno" id=line71></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dflt_toolchain_config = (
<span class="lineno" id=line72></span>        c_compiler_executable = c_compiler_executable,
<span class="lineno" id=line73></span>        cxx_compiler_executable = cxx_compiler_executable,
<span class="lineno" id=line74></span>        header_search_dirs = Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line75></span>        macros = Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line76></span>        library_search_dirs= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line77></span>        ccflags= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line78></span>        dynamic_libraries= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line79></span>        static_libraries= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line80></span>        debugln = debugln[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line81></span>    );
<span class="lineno" id=line82></span>  
<span class="lineno" id=line83></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> showtime(msg:<span class="library" title="binding of C++ string type">string</span>, t0:<span class="library" title="binding of C double float type">double</span>)
<span class="lineno" id=line84></span>    {
<span class="lineno" id=line85></span>      <span class="small_keyword" title="conditional">if</span> control.TIME == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line86></span>        <span class="big_keyword" title="Define a mutable variable">var</span> elapsed = #Time::time - t0;
<span class="lineno" id=line87></span>        <span class="big_keyword" title="Define a mutable variable">var</span> minutes = floor (elapsed / 60.0);
<span class="lineno" id=line88></span>        <span class="big_keyword" title="Define a mutable variable">var</span> seconds = elapsed - minutes * 60.0;
<span class="lineno" id=line89></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"[flx] Time : "</span> + fmt(minutes,fixed(2,0))+<span class="fstring">"m"</span> + fmt(seconds,fixed(4,1)) + <span class="fstring">"s for "</span> + msg;
<span class="lineno" id=line90></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line91></span>    }
<span class="lineno" id=line92></span>  
<span class="lineno" id=line93></span>  
<span class="lineno" id=line94></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> system(cmd:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C int type">int</span>= {
<span class="lineno" id=line95></span>      <span class="big_keyword" title="Define a mutable variable">var</span> now = #Time::time;
<span class="lineno" id=line96></span>      <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="imperative code begins">do</span> fprintln$ cstderr, cmd; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line97></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = System::system(cmd);
<span class="lineno" id=line98></span>      <span class="big_keyword" title="Define a mutable variable">var</span> elapsed = #Time::time - now;
<span class="lineno" id=line99></span>      <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line100></span>        fprintln$ cstderr, <span class="fstring">"System:Elapsed: "</span> + fmt (elapsed, fixed (8,3)) + 
<span class="lineno" id=line101></span>          <span class="fstring">", Result code "</span> + <span class="library" title="Convert a value to a string">str</span>(<span class="small_keyword" title="value of function return used in post condition">result</span>)
<span class="lineno" id=line102></span>        ; 
<span class="lineno" id=line103></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line104></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line105></span>    }
<span class="lineno" id=line106></span>  
<span class="lineno" id=line107></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line108></span>  <span class="comment">// CALPACKAGES</span>
<span class="lineno" id=line109></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line110></span>  
<span class="lineno" id=line111></span>    <span class="big_keyword" title="Define a mutable variable">var</span> calpackages_run = <span class="library" title="false value">false</span>;
<span class="lineno" id=line112></span>  
<span class="lineno" id=line113></span>  <span class="comment">/*
<span class="lineno" id=line114></span>    proc ehandler () {
<span class="lineno" id=line115></span>      eprintln$ "Flx: calpackages : failed, temporary ehandler invoked";
<span class="lineno" id=line116></span>      System::exit 1;
<span class="lineno" id=line117></span>    }
<span class="lineno" id=line118></span>  */</span>
<span class="lineno" id=line119></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> calpackages (ehandler:1-&gt;0) 
<span class="lineno" id=line120></span>    {
<span class="lineno" id=line121></span>      debugln$ <span class="fstring">"[flx:calpackages] Calculating package requirements (calpackages_run="</span>+<span class="library" title="Convert a value to a string">str</span> calpackages_run +<span class="fstring">")"</span>;
<span class="lineno" id=line122></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> calpackages_run  <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line123></span>        <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker dflt_toolchain_config;
<span class="lineno" id=line124></span>        <span class="big_keyword" title="Define a mutable variable">var</span> x = FlxPkg::map_package_requirements ehandler
<span class="lineno" id=line125></span>        (
<span class="lineno" id=line126></span>           FLX_TARGET_DIR = config.FLX_TARGET_DIR,
<span class="lineno" id=line127></span>           FLX_CONFIG_DIRS = config.FLX_CONFIG_DIRS,
<span class="lineno" id=line128></span>           EXT_EXE = #(tc.executable_extension),
<span class="lineno" id=line129></span>           EXT_STATIC_OBJ = #(tc.static_object_extension),
<span class="lineno" id=line130></span>           EXT_DYNAMIC_OBJ = #(tc.dynamic_object_extension),
<span class="lineno" id=line131></span>           STATIC = control.STATIC,
<span class="lineno" id=line132></span>           LINKEXE = control.LINKEXE,
<span class="lineno" id=line133></span>           SLINK_STRINGS = control.SLINK_STRINGS,
<span class="lineno" id=line134></span>           DLINK_STRINGS = control.DLINK_STRINGS,
<span class="lineno" id=line135></span>           LINKER_SWITCHES = control.LINKER_SWITCHES,
<span class="lineno" id=line136></span>           cpp_filebase = dvars.cpp_filebase,
<span class="lineno" id=line137></span>           EXTRA_PACKAGES = control.pkgs
<span class="lineno" id=line138></span>        );
<span class="lineno" id=line139></span>        <span class="comment">//control.EXTRA_CCFLAGS = control.EXTRA_CCFLAGS + x.CFLAGS;</span>
<span class="lineno" id=line140></span>        &amp;control.CCFLAGS &lt;- control.CCFLAGS + x.CFLAGS;
<span class="lineno" id=line141></span>        &amp;control.EXTRA_INCLUDE_FILES &lt;- x.INCLUDE_FILES;
<span class="lineno" id=line142></span>        &amp;control.DRIVER_EXE &lt;- x.DRIVER_EXE;
<span class="lineno" id=line143></span>        &amp;control.DRIVER_OBJS &lt;- x.DRIVER_OBJS;
<span class="lineno" id=line144></span>        &amp;control.LINK_STRINGS &lt;- x.LINK_STRINGS;
<span class="lineno" id=line145></span>        <span class="comment">//println$ "LINK STRINGS = " + x.LINK_STRINGS;</span>
<span class="lineno" id=line146></span>        calpackages_run = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line147></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line148></span>    }
<span class="lineno" id=line149></span>  
<span class="lineno" id=line150></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> find_cxx_pkgs (src:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] =
<span class="lineno" id=line151></span>    {
<span class="lineno" id=line152></span>      debugln$ <span class="fstring">"[flx:find_cxx_pkgs] Scanning "</span> + src + <span class="fstring">" for package requirements"</span>;
<span class="lineno" id=line153></span>      <span class="big_keyword" title="Define a mutable variable">var</span> out = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line154></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pat = RE2(<span class="fstring">'.*@requires package ([A-Za-z][A-Za-z0-9_-]*).*'</span>);
<span class="lineno" id=line155></span>      <span class="big_keyword" title="Define a mutable variable">var</span> f = fopen_input_text src;
<span class="lineno" id=line156></span>      <span class="small_keyword" title="conditional">if</span> valid f <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line157></span>        <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> f <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line158></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Match (pat,line);
<span class="lineno" id=line159></span>          <span class="small_keyword" title="match statement or expression">match</span> <span class="small_keyword" title="value of function return used in post condition">result</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line160></span>          | #None =&gt; ;
<span class="lineno" id=line161></span>          | Some v =&gt; out = v.1  + out;
<span class="lineno" id=line162></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line163></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line164></span>        fclose f;
<span class="lineno" id=line165></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line166></span>        eprintln(<span class="fstring">"Can't find C++ source file "</span> + src);
<span class="lineno" id=line167></span>        System::exit(1);
<span class="lineno" id=line168></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line169></span>      out = <span class="library" title="return data structure with elements reversed">rev</span> out;
<span class="lineno" id=line170></span>      <span class="small_keyword" title="conditional">if</span> out != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="call a procedure">call</span>
<span class="lineno" id=line171></span>        eprintln$ <span class="fstring">"[flx] C++ file "</span>+src+<span class="fstring">" requires packages "</span> + <span class="library" title="Convert a value to a string">str</span> (out);
<span class="lineno" id=line172></span>      <span class="small_keyword" title="return">return</span> out;
<span class="lineno" id=line173></span>    }
<span class="lineno" id=line174></span>  
<span class="lineno" id=line175></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line176></span>  <span class="comment">// FELIX COMPILATION</span>
<span class="lineno" id=line177></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line178></span>  
<span class="lineno" id=line179></span>    <span class="comment">// max time of Felix source files: #FileStat::future_time if any missing</span>
<span class="lineno" id=line180></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> cal_time_from_flxdepfile (debugln: string-&gt;0, df: <span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C double float type">double</span>=
<span class="lineno" id=line181></span>    {
<span class="lineno" id=line182></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> maxf (x: <span class="library" title="binding of C double float type">double</span>) (f:<span class="library" title="binding of C++ string type">string</span>) =
<span class="lineno" id=line183></span>      {
<span class="lineno" id=line184></span>        <span class="small_keyword" title="conditional">if</span> f == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> x; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line185></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ext = Filename::get_extension f;
<span class="lineno" id=line186></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ft = <span class="small_keyword" title="conditional">if</span> ext != <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> FileStat::dfiletime (f,#FileStat::past_time) <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line187></span>          max (FileStat::dfiletime (f+<span class="fstring">".fdoc"</span>, #FileStat::past_time), FileStat::dfiletime (f+<span class="fstring">".flx"</span>,#FileStat::past_time))
<span class="lineno" id=line188></span>        ;
<span class="lineno" id=line189></span>        debugln$ (<span class="fstring">"Time "</span>+f+<span class="fstring">" = "</span>+ FileStat::strfiletime ft);
<span class="lineno" id=line190></span>        ft = <span class="small_keyword" title="conditional">if</span> ft == #FileStat::past_time <span class="small_keyword" title="conditional">then</span> #FileStat::future_time <span class="small_keyword" title="conditional">else</span> ft; <span class="comment">// missing dependency</span>
<span class="lineno" id=line191></span>        <span class="small_keyword" title="return">return</span> max (x,ft);
<span class="lineno" id=line192></span>      }
<span class="lineno" id=line193></span>  
<span class="lineno" id=line194></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> cal_files_time (fs: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])=&gt; <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> maxf #FileStat::past_time fs;
<span class="lineno" id=line195></span>  
<span class="lineno" id=line196></span>      <span class="big_keyword" title="Define a mutable variable">var</span> deptext = load_text df;
<span class="lineno" id=line197></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lines = split (deptext, <span class="fstring">"\n"</span>); 
<span class="lineno" id=line198></span>      debugln$ <span class="fstring">"Deps="</span> + <span class="library" title="Convert a value to a string">str</span>(lines);
<span class="lineno" id=line199></span>      <span class="big_keyword" title="Define a mutable variable">var</span> deptime = 
<span class="lineno" id=line200></span>        <span class="small_keyword" title="let binder">let</span> ft = cal_files_time lines <span class="small_keyword" title="membership operator, function mem">in</span> 
<span class="lineno" id=line201></span>        <span class="small_keyword" title="conditional">if</span> ft == #FileStat::past_time <span class="small_keyword" title="conditional">then</span> #FileStat::future_time <span class="small_keyword" title="conditional">else</span> ft <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line202></span>      ;
<span class="lineno" id=line203></span>      debugln$ <span class="fstring">"Deptime="</span> + FileStat::strfiletime(deptime);
<span class="lineno" id=line204></span>      <span class="small_keyword" title="return">return</span> deptime;
<span class="lineno" id=line205></span>    }
<span class="lineno" id=line206></span>  
<span class="lineno" id=line207></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> cal_cxx_uptodate(debugln:<span class="library" title="binding of C++ string type">string</span> -&gt; 0, OUTPUT_DIR:<span class="library" title="binding of C++ string type">string</span>, f:<span class="library" title="binding of C++ string type">string</span>)= 
<span class="lineno" id=line208></span>    {
<span class="lineno" id=line209></span>      <span class="big_keyword" title="Define an immutable value">val</span> depfilename = cache_join (OUTPUT_DIR, f+<span class="fstring">".dep"</span>);
<span class="lineno" id=line210></span>      debugln$ <span class="fstring">"Dependency file name = "</span> + depfilename;
<span class="lineno" id=line211></span>      <span class="big_keyword" title="Define a mutable variable">var</span> depfiletime = FileStat::dfiletime (depfilename, #FileStat::future_time);
<span class="lineno" id=line212></span>      <span class="small_keyword" title="conditional">if</span> depfiletime == #FileStat::future_time <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line213></span>        debugln$ <span class="fstring">"Dependency file doesn't exist"</span>;
<span class="lineno" id=line214></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>;
<span class="lineno" id=line215></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line216></span>  
<span class="lineno" id=line217></span>      <span class="big_keyword" title="Define a mutable variable">var</span> deptime = cal_time_from_flxdepfile (debugln, depfilename);
<span class="lineno" id=line218></span>      debugln$ <span class="fstring">"dep time = "</span> + FileStat::strfiletime deptime;
<span class="lineno" id=line219></span>      debugln$ <span class="fstring">"depfile time = "</span> + FileStat::strfiletime depfiletime;
<span class="lineno" id=line220></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cxx_uptodate = deptime &lt; depfiletime;
<span class="lineno" id=line221></span>      debugln$ <span class="fstring">"cxx generated by flxg is = "</span> + <span class="small_keyword" title="conditional">if</span> cxx_uptodate <span class="small_keyword" title="conditional">then</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">" NOT "</span> <span class="small_keyword" title="conditional">endif</span> + <span class="fstring">"uptodate"</span>;
<span class="lineno" id=line222></span>      <span class="small_keyword" title="return">return</span> cxx_uptodate;
<span class="lineno" id=line223></span>    }
<span class="lineno" id=line224></span>   
<span class="lineno" id=line225></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> check_cxx_uptodate () : bool =
<span class="lineno" id=line226></span>    {
<span class="lineno" id=line227></span>      debugln <span class="fstring">"Check Felix-&gt;C++ uptodate"</span>;
<span class="lineno" id=line228></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE == 1 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line229></span>        debugln$ <span class="fstring">"Felix-&gt;C++ dependency checking skipped due to switch RECOMPILE=1: forced not uptodate"</span>;
<span class="lineno" id=line230></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>;
<span class="lineno" id=line231></span>      <span class="small_keyword" title="conditional">elif</span> control.CHECK_DEPENDENCIES == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line232></span>        debugln <span class="fstring">"Checking Felix-&gt;C++ dependencies since CHECK_DEPENDENCIES=1 to see if the cxx is uptodate"</span>;
<span class="lineno" id=line233></span>        <span class="small_keyword" title="return">return</span> cal_cxx_uptodate (debugln[<span class="library" title="binding of C++ string type">string</span>], config.FLX_OUTPUT_DIR, dvars.filebase);
<span class="lineno" id=line234></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line235></span>        debugln$ <span class="fstring">"Felix-&gt;C++ dependency checking skipped due to switch CHECK_DEPENDENCIES=0: forced uptodate"</span>;
<span class="lineno" id=line236></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="truth value">true</span>;
<span class="lineno" id=line237></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line238></span>    }
<span class="lineno" id=line239></span>  
<span class="lineno" id=line240></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_felix_compiler_if_required (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line241></span>    {
<span class="lineno" id=line242></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line243></span>      <span class="big_keyword" title="Define a mutable variable">var</span> uptodate = check_cxx_uptodate ();
<span class="lineno" id=line244></span>      debugln$ <span class="fstring">"[run_felix_compiler_if_required] Uptodate="</span> + uptodate.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line245></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> uptodate <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line246></span>        debugln$ <span class="fstring">"Running flxg because target is not uptodate"</span>;
<span class="lineno" id=line247></span>        <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line248></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = Flxg::run_felix_compiler
<span class="lineno" id=line249></span>        (
<span class="lineno" id=line250></span>          INLINE=control.INLINE,
<span class="lineno" id=line251></span>          OUTPUT_DIR=config.FLX_OUTPUT_DIR,
<span class="lineno" id=line252></span>          BUNDLE_DIR=control.BUNDLE_DIR,
<span class="lineno" id=line253></span>          CACHE_DIR=config.FLX_CACHE_DIR,
<span class="lineno" id=line254></span>          COMPILER_PHASE= control.COMPILER_PHASE,
<span class="lineno" id=line255></span>          DOREDUCE=control.DOREDUCE,
<span class="lineno" id=line256></span>          FLXG = control.FLXG,
<span class="lineno" id=line257></span>          VERBOSE = dvars.VERBOSE,
<span class="lineno" id=line258></span>          <span class="comment">// NOTE: BUG: Not passing grammar directory to compiler!</span>
<span class="lineno" id=line259></span>          <span class="comment">// flxg expects file in standard library</span>
<span class="lineno" id=line260></span>          STDGRAMMAR = <span class="fstring">"@"</span>+control.STDGRAMMAR, 
<span class="lineno" id=line261></span>          AUTOMATON = control.AUTOMATON,
<span class="lineno" id=line262></span>          IMPORTS = control.STDIMPORTS + control.IMPORTS,
<span class="lineno" id=line263></span>          FLXLIBS = dvars.FLX_STD_LIBS,
<span class="lineno" id=line264></span>          INCLUDE_DIRS = config.FLX_LIB_DIRS,
<span class="lineno" id=line265></span>          filebase = dvars.filebase,
<span class="lineno" id=line266></span>          use_ext = dvars.use_ext,
<span class="lineno" id=line267></span>          TIME = control.COMPILER_TIME,
<span class="lineno" id=line268></span>          FORCE = control.FLXG_FORCE,
<span class="lineno" id=line269></span>          FLAGS = <span class="small_keyword" title="conditional">if</span> control.FLXG_OPTIMISE == 0 <span class="small_keyword" title="conditional">then</span> Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] <span class="fstring">"--optimise"</span> <span class="small_keyword" title="conditional">endif</span>,
<span class="lineno" id=line270></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line271></span>        );
<span class="lineno" id=line272></span>        showtime(<span class="fstring">"Felix flxg   : "</span>+dvars.cpp_filebase, t0);
<span class="lineno" id=line273></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line274></span>          debugln$ <span class="fstring">"Felix compilation succeeded"</span>;
<span class="lineno" id=line275></span>          calpackages ehandler;
<span class="lineno" id=line276></span>          FlxPkg::write_include_file(dvars.cpp_filebase, control.EXTRA_INCLUDE_FILES);
<span class="lineno" id=line277></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line278></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line279></span>        debugln$ <span class="fstring">"skipping flxg because output is uptodate"</span>;
<span class="lineno" id=line280></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line281></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line282></span>    }
<span class="lineno" id=line283></span>  
<span class="lineno" id=line284></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line285></span>  <span class="comment">// OBJC COMPILATION: NOTE HACKED AT THE MOMENT TO USE C TOOLS</span>
<span class="lineno" id=line286></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line287></span>  
<span class="lineno" id=line288></span>    <span class="comment">// objC dynamic (one file)</span>
<span class="lineno" id=line289></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> objc_compile_dynamic1 (ehandler:1-&gt;0) (src:<span class="library" title="binding of C++ string type">string</span>, dst:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line290></span>    {
<span class="lineno" id=line291></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line292></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line293></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line294></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line295></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line296></span>        eprintln$ <span class="fstring">"[flx:objc_compile_dynamic1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line297></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line298></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line299></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line300></span>        ;
<span class="lineno" id=line301></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs + control.pkgs;
<span class="lineno" id=line302></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line303></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line304></span>          eprintln$ <span class="fstring">"[flx:objc_compile_dynamic1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line305></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line306></span>          <span class="comment">//System::exit (1);</span>
<span class="lineno" id=line307></span>          throw_continuation ehandler;
<span class="lineno" id=line308></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line309></span>        pkg_cflags = mycflags;
<span class="lineno" id=line310></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line311></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker
<span class="lineno" id=line312></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line313></span>        (
<span class="lineno" id=line314></span>          ccflags = <span class="comment">/* ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line315></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line316></span>          macros = control.MACROS,
<span class="lineno" id=line317></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line318></span>        )
<span class="lineno" id=line319></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line320></span>      ;
<span class="lineno" id=line321></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> c_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line322></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.c_dynamic_object_compiler (dst=dst,src=src);
<span class="lineno" id=line323></span>        showtime(<span class="fstring">"Dynamic objc  : "</span>+src, t0);
<span class="lineno" id=line324></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line325></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line326></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line327></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line328></span>    }
<span class="lineno" id=line329></span>  
<span class="lineno" id=line330></span>    <span class="comment">// objC static (one file)</span>
<span class="lineno" id=line331></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> objc_compile_static1 (ehandler:1-&gt;0) (src: <span class="library" title="binding of C++ string type">string</span>, dst: <span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line332></span>    {
<span class="lineno" id=line333></span>  <span class="comment">//println$ "objc_compile_static1: " + src " -&gt; " + dst;</span>
<span class="lineno" id=line334></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line335></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line336></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line337></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line338></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line339></span>        eprintln$ <span class="fstring">"[flx:objc_compile_static1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line340></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line341></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line342></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line343></span>        ;
<span class="lineno" id=line344></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs+control.pkgs;
<span class="lineno" id=line345></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line346></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line347></span>          eprintln$ <span class="fstring">"[flx:objc_compile_static1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line348></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line349></span>          System::exit (1);
<span class="lineno" id=line350></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line351></span>        pkg_cflags = mycflags;
<span class="lineno" id=line352></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line353></span>   
<span class="lineno" id=line354></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line355></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line356></span>        (
<span class="lineno" id=line357></span>          ccflags = <span class="comment">/*ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line358></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line359></span>          macros = control.MACROS,
<span class="lineno" id=line360></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line361></span>        )
<span class="lineno" id=line362></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line363></span>      ;
<span class="lineno" id=line364></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> c_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line365></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.c_static_object_compiler (dst=dst,src=src); 
<span class="lineno" id=line366></span>        showtime(<span class="fstring">"Static objc     : "</span>+src,t0);
<span class="lineno" id=line367></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line368></span>          eprintln$ <span class="fstring">"[flx] objC compilation "</span>+src+<span class="fstring">" failed"</span>;
<span class="lineno" id=line369></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line370></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line371></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line372></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line373></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line374></span>  
<span class="lineno" id=line375></span>    }
<span class="lineno" id=line376></span>  
<span class="lineno" id=line377></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line378></span>  <span class="comment">// C COMPILATION</span>
<span class="lineno" id=line379></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line380></span>  
<span class="lineno" id=line381></span>    <span class="comment">// C dynamic (one file)</span>
<span class="lineno" id=line382></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> c_compile_dynamic1 (ehandler:1-&gt;0) (src:<span class="library" title="binding of C++ string type">string</span>, dst:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line383></span>    {
<span class="lineno" id=line384></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line385></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line386></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line387></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line388></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line389></span>        eprintln$ <span class="fstring">"[flx:c_compile_dynamic1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line390></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line391></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line392></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line393></span>        ;
<span class="lineno" id=line394></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs + control.pkgs;
<span class="lineno" id=line395></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line396></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line397></span>          eprintln$ <span class="fstring">"[flx:c_compile_dynamic1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line398></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line399></span>          <span class="comment">//System::exit (1);</span>
<span class="lineno" id=line400></span>          throw_continuation ehandler;
<span class="lineno" id=line401></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line402></span>        pkg_cflags = mycflags;
<span class="lineno" id=line403></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line404></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker
<span class="lineno" id=line405></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line406></span>        (
<span class="lineno" id=line407></span>          ccflags = <span class="comment">/* ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line408></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line409></span>          macros = control.MACROS,
<span class="lineno" id=line410></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line411></span>        )
<span class="lineno" id=line412></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line413></span>      ;
<span class="lineno" id=line414></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> c_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line415></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.c_dynamic_object_compiler (dst=dst,src=src);
<span class="lineno" id=line416></span>        showtime(<span class="fstring">"Dynamic c  : "</span>+src, t0);
<span class="lineno" id=line417></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line418></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line419></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line420></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line421></span>    }
<span class="lineno" id=line422></span>  
<span class="lineno" id=line423></span>    <span class="comment">// C static (one file)</span>
<span class="lineno" id=line424></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> c_compile_static1 (ehandler:1-&gt;0) (src: <span class="library" title="binding of C++ string type">string</span>, dst: <span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line425></span>    {
<span class="lineno" id=line426></span>  <span class="comment">//println$ "c_compile_static1: " + src " -&gt; " + dst;</span>
<span class="lineno" id=line427></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line428></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line429></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line430></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line431></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line432></span>        eprintln$ <span class="fstring">"[flx:c_compile_static1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line433></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line434></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line435></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line436></span>        ;
<span class="lineno" id=line437></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs+control.pkgs;
<span class="lineno" id=line438></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line439></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line440></span>          eprintln$ <span class="fstring">"[flx:c_compile_static1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line441></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line442></span>          System::exit (1);
<span class="lineno" id=line443></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line444></span>        pkg_cflags = mycflags;
<span class="lineno" id=line445></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line446></span>   
<span class="lineno" id=line447></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line448></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line449></span>        (
<span class="lineno" id=line450></span>          ccflags = <span class="comment">/*ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line451></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line452></span>          macros = control.MACROS,
<span class="lineno" id=line453></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line454></span>        )
<span class="lineno" id=line455></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line456></span>      ;
<span class="lineno" id=line457></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> c_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line458></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.c_static_object_compiler (dst=dst,src=src); 
<span class="lineno" id=line459></span>        showtime(<span class="fstring">"Static c     : "</span>+src,t0);
<span class="lineno" id=line460></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line461></span>          eprintln$ <span class="fstring">"[flx] C compilation "</span>+src+<span class="fstring">" failed"</span>;
<span class="lineno" id=line462></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line463></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line464></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line465></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line466></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line467></span>  
<span class="lineno" id=line468></span>    }
<span class="lineno" id=line469></span>  
<span class="lineno" id=line470></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line471></span>  <span class="comment">// ObjC++ COMPILATION : NOTE HACKED AT THE MOMENT TO USE C TOOLS</span>
<span class="lineno" id=line472></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line473></span>  
<span class="lineno" id=line474></span>    <span class="comment">// C++ dynamic (one file)</span>
<span class="lineno" id=line475></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> objcxx_compile_dynamic1 (ehandler:1-&gt;0) (src:<span class="library" title="binding of C++ string type">string</span>, dst:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line476></span>    {
<span class="lineno" id=line477></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line478></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line479></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line480></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line481></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line482></span>        eprintln$ <span class="fstring">"[flx:objcxx_compile_dynamic1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line483></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line484></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line485></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line486></span>        ;
<span class="lineno" id=line487></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs + control.pkgs;
<span class="lineno" id=line488></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line489></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line490></span>          eprintln$ <span class="fstring">"[flx:objcxx_compile_dynamic1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line491></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line492></span>          <span class="comment">//System::exit (1);</span>
<span class="lineno" id=line493></span>          throw_continuation ehandler;
<span class="lineno" id=line494></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line495></span>        pkg_cflags = mycflags;
<span class="lineno" id=line496></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line497></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker
<span class="lineno" id=line498></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line499></span>        (
<span class="lineno" id=line500></span>          ccflags = <span class="comment">/* ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line501></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line502></span>          macros = control.MACROS,
<span class="lineno" id=line503></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line504></span>        )
<span class="lineno" id=line505></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line506></span>      ;
<span class="lineno" id=line507></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> cxx_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line508></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.cxx_dynamic_object_compiler (dst=dst,src=src);
<span class="lineno" id=line509></span>        showtime(<span class="fstring">"Dynamic objc++  : "</span>+src, t0);
<span class="lineno" id=line510></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line511></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line512></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line513></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line514></span>    }
<span class="lineno" id=line515></span>  
<span class="lineno" id=line516></span>    <span class="comment">// ObjC++ static (one files)</span>
<span class="lineno" id=line517></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> objcxx_compile_static1 (ehandler:1-&gt;0) (src: <span class="library" title="binding of C++ string type">string</span>, dst: <span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line518></span>    {
<span class="lineno" id=line519></span>  <span class="comment">//println$ "objcxx_compile_static1: " + src " -&gt; " + dst;</span>
<span class="lineno" id=line520></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line521></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line522></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line523></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line524></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line525></span>        eprintln$ <span class="fstring">"[flx:objcxx_compile_static1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line526></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line527></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line528></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line529></span>        ;
<span class="lineno" id=line530></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs+control.pkgs;
<span class="lineno" id=line531></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line532></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line533></span>          eprintln$ <span class="fstring">"[flx:objcxx_compile_static1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line534></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line535></span>          System::exit (1);
<span class="lineno" id=line536></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line537></span>        pkg_cflags = mycflags;
<span class="lineno" id=line538></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line539></span>   
<span class="lineno" id=line540></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line541></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line542></span>        (
<span class="lineno" id=line543></span>          ccflags = <span class="comment">/*ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line544></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line545></span>          macros = control.MACROS,
<span class="lineno" id=line546></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line547></span>        )
<span class="lineno" id=line548></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line549></span>      ;
<span class="lineno" id=line550></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> cxx_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line551></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.cxx_static_object_compiler (dst=dst,src=src); 
<span class="lineno" id=line552></span>        showtime(<span class="fstring">"Static objc++   : "</span>+src,t0);
<span class="lineno" id=line553></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line554></span>          eprintln$ <span class="fstring">"[flx] objC++ compilation "</span>+src+<span class="fstring">" failed"</span>;
<span class="lineno" id=line555></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line556></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line557></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line558></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line559></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line560></span>  
<span class="lineno" id=line561></span>    }
<span class="lineno" id=line562></span>  
<span class="lineno" id=line563></span>  
<span class="lineno" id=line564></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line565></span>  <span class="comment">// C++ COMPILATION</span>
<span class="lineno" id=line566></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line567></span>  
<span class="lineno" id=line568></span>    <span class="comment">// C++ dynamic (one file)</span>
<span class="lineno" id=line569></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_compile_dynamic1 (ehandler:1-&gt;0) (src:<span class="library" title="binding of C++ string type">string</span>, dst:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line570></span>    {
<span class="lineno" id=line571></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line572></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line573></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line574></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line575></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line576></span>        eprintln$ <span class="fstring">"[flx:cxx_compile_dynamic1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line577></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line578></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line579></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line580></span>        ;
<span class="lineno" id=line581></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs + control.pkgs;
<span class="lineno" id=line582></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line583></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line584></span>          eprintln$ <span class="fstring">"[flx:cxx_compile_dynamic1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line585></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line586></span>          <span class="comment">//System::exit (1);</span>
<span class="lineno" id=line587></span>          throw_continuation ehandler;
<span class="lineno" id=line588></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line589></span>        pkg_cflags = mycflags;
<span class="lineno" id=line590></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line591></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker
<span class="lineno" id=line592></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line593></span>        (
<span class="lineno" id=line594></span>          ccflags = <span class="comment">/* ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line595></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line596></span>          macros = control.MACROS,
<span class="lineno" id=line597></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line598></span>        )
<span class="lineno" id=line599></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line600></span>      ;
<span class="lineno" id=line601></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> cxx_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line602></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.cxx_dynamic_object_compiler (dst=dst,src=src);
<span class="lineno" id=line603></span>        showtime(<span class="fstring">"Dynamic c++  : "</span>+src, t0);
<span class="lineno" id=line604></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line605></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line606></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line607></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line608></span>    }
<span class="lineno" id=line609></span>  
<span class="lineno" id=line610></span>    <span class="comment">// MASTER C/C++ dynamic (many files)</span>
<span class="lineno" id=line611></span>    <span class="comment">// does both C and C++ compilation</span>
<span class="lineno" id=line612></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_compile_dynamic (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line613></span>    {
<span class="lineno" id=line614></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXT_SHARED_OBJ = #((toolchain_maker dflt_toolchain_config).dynamic_object_extension);
<span class="lineno" id=line615></span>      <span class="small_keyword" title="conditional">if</span> control.CXXONLY == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line616></span>        <span class="small_keyword" title="conditional">if</span> control.LINKIT == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line617></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_compile_dynamic1 ehandler (dvars.cpp_filebase+<span class="fstring">".cpp"</span>, control.LINKER_OUTPUT_FILENAME);
<span class="lineno" id=line618></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line619></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line620></span>          <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_compile_dynamic1 ehandler (dvars.cpp_filebase+<span class="fstring">".cpp"</span>, dvars.cpp_filebase+EXT_SHARED_OBJ);
<span class="lineno" id=line621></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line622></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line623></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line624></span>  
<span class="lineno" id=line625></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.objcs <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line626></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src + EXT_SHARED_OBJ;
<span class="lineno" id=line627></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = objc_compile_dynamic1 ehandler (src,dst);
<span class="lineno" id=line628></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line629></span>        += (&amp;control.objs, dst);
<span class="lineno" id=line630></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line631></span>  
<span class="lineno" id=line632></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.objcpps <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line633></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src + EXT_SHARED_OBJ;
<span class="lineno" id=line634></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = objcxx_compile_dynamic1 ehandler (src,dst);
<span class="lineno" id=line635></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line636></span>        += (&amp;control.objs, dst);
<span class="lineno" id=line637></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line638></span>  
<span class="lineno" id=line639></span>  
<span class="lineno" id=line640></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.cs <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line641></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src + EXT_SHARED_OBJ;
<span class="lineno" id=line642></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = c_compile_dynamic1 ehandler (src,dst);
<span class="lineno" id=line643></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line644></span>        += (&amp;control.objs, dst);
<span class="lineno" id=line645></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line646></span>  
<span class="lineno" id=line647></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.cpps <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line648></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src + EXT_SHARED_OBJ;
<span class="lineno" id=line649></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_compile_dynamic1 ehandler (src,dst);
<span class="lineno" id=line650></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line651></span>        += (&amp;control.objs, dst);
<span class="lineno" id=line652></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line653></span>  
<span class="lineno" id=line654></span>      <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line655></span>    }
<span class="lineno" id=line656></span>  
<span class="lineno" id=line657></span>    <span class="comment">// MASTER C/C++ static (one file)</span>
<span class="lineno" id=line658></span>    <span class="comment">// does both C and C++ compilation</span>
<span class="lineno" id=line659></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_compile_static (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line660></span>    {
<span class="lineno" id=line661></span>      <span class="comment">// we only need the thunk if we're linking OR -o switch was NOT specified</span>
<span class="lineno" id=line662></span>      <span class="comment">// i.e. skip compiling the thunk the output name was specified and </span>
<span class="lineno" id=line663></span>      <span class="comment">// represents an object file (or library archive?)</span>
<span class="lineno" id=line664></span>  <span class="comment">//println$ "cxx_compile_static";</span>
<span class="lineno" id=line665></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXT_STATIC_OBJ = #((toolchain_maker dflt_toolchain_config).static_object_extension);
<span class="lineno" id=line666></span>      <span class="small_keyword" title="conditional">if</span> 
<span class="lineno" id=line667></span>        control.CXXONLY == 0 <span class="small_keyword" title="logical conjunction">and</span> (
<span class="lineno" id=line668></span>        control.LINKIT == 1 <span class="small_keyword" title="logical disjunction">or</span> 
<span class="lineno" id=line669></span>        control.OUTPUT_FILENAME_SPECIFIED == 0 <span class="small_keyword" title="logical conjunction">and</span>
<span class="lineno" id=line670></span>        control.OUTPUT_FILENAME_WITHOUT_EXTENSION_SPECIFIED == 0)
<span class="lineno" id=line671></span>      <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line672></span>  <span class="comment">//println$ "Compiling thunk";</span>
<span class="lineno" id=line673></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_compile_static1 ehandler
<span class="lineno" id=line674></span>        (
<span class="lineno" id=line675></span>          dvars.cpp_filebase+<span class="fstring">"_static_link_thunk.cpp"</span>,
<span class="lineno" id=line676></span>          dvars.cpp_filebase+<span class="fstring">"_static_link_thunk"</span>+EXT_STATIC_OBJ
<span class="lineno" id=line677></span>        );
<span class="lineno" id=line678></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line679></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line680></span>  
<span class="lineno" id=line681></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.objcs <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line682></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src +EXT_STATIC_OBJ;
<span class="lineno" id=line683></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = objc_compile_static1 ehandler (src,dst);
<span class="lineno" id=line684></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line685></span>        += (&amp;control.objs,dst);
<span class="lineno" id=line686></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line687></span>     
<span class="lineno" id=line688></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.objcpps <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line689></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src +EXT_STATIC_OBJ;
<span class="lineno" id=line690></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = objcxx_compile_static1 ehandler (src,dst);
<span class="lineno" id=line691></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line692></span>        += (&amp;control.objs,dst);
<span class="lineno" id=line693></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line694></span>   
<span class="lineno" id=line695></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.cs <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line696></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src +EXT_STATIC_OBJ;
<span class="lineno" id=line697></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = c_compile_static1 ehandler (src,dst);
<span class="lineno" id=line698></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line699></span>        += (&amp;control.objs,dst);
<span class="lineno" id=line700></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line701></span>     
<span class="lineno" id=line702></span>      <span class="small_keyword" title="end of extension">begin</span> <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.cpps <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line703></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dst = Filename::strip_extension src +EXT_STATIC_OBJ;
<span class="lineno" id=line704></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_compile_static1 ehandler (src,dst);
<span class="lineno" id=line705></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line706></span>        += (&amp;control.objs,dst);
<span class="lineno" id=line707></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line708></span>     
<span class="lineno" id=line709></span>      <span class="small_keyword" title="conditional">if</span> control.CXXONLY == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line710></span>        <span class="small_keyword" title="conditional">if</span> control.LINKIT == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line711></span>    <span class="comment">//println$ "Compile only " + control.LINKER_OUTPUT_FILENAME;</span>
<span class="lineno" id=line712></span>          <span class="comment">// compile only</span>
<span class="lineno" id=line713></span>          <span class="small_keyword" title="return">return</span> cxx_compile_static1 ehandler
<span class="lineno" id=line714></span>            (dvars.cpp_filebase+<span class="fstring">".cpp"</span>,control.LINKER_OUTPUT_FILENAME);
<span class="lineno" id=line715></span>        <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line716></span>          <span class="comment">// compile and link</span>
<span class="lineno" id=line717></span>    <span class="comment">//println$ "Compile and link " + dvars.cpp_filebase+EXT_STATIC_OBJ;</span>
<span class="lineno" id=line718></span>          <span class="small_keyword" title="return">return</span> cxx_compile_static1 ehandler
<span class="lineno" id=line719></span>            (dvars.cpp_filebase+<span class="fstring">".cpp"</span>,dvars.cpp_filebase+EXT_STATIC_OBJ);
<span class="lineno" id=line720></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line721></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line722></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line723></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line724></span>    }
<span class="lineno" id=line725></span>  
<span class="lineno" id=line726></span>    <span class="comment">// C++ static (many files)</span>
<span class="lineno" id=line727></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_compile_static1 (ehandler:1-&gt;0) (src: <span class="library" title="binding of C++ string type">string</span>, dst: <span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line728></span>    {
<span class="lineno" id=line729></span>  <span class="comment">//println$ "cxx_compile_static1: " + src " -&gt; " + dst;</span>
<span class="lineno" id=line730></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line731></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = find_cxx_pkgs src;
<span class="lineno" id=line732></span>      control&amp;.extra_pkgs &lt;- control.extra_pkgs + pkgs;
<span class="lineno" id=line733></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_cflags = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line734></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line735></span>        eprintln$ <span class="fstring">"[flx:cxx_compile_static1] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line736></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line737></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line738></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line739></span>        ;
<span class="lineno" id=line740></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"--field=cflags"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs+control.pkgs;
<span class="lineno" id=line741></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mycflags = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line742></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line743></span>          eprintln$ <span class="fstring">"[flx:cxx_compile_static1] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line744></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line745></span>          System::exit (1);
<span class="lineno" id=line746></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line747></span>        pkg_cflags = mycflags;
<span class="lineno" id=line748></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line749></span>   
<span class="lineno" id=line750></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line751></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line752></span>        (
<span class="lineno" id=line753></span>          ccflags = <span class="comment">/*ccflags + */</span> control.CCFLAGS + pkg_cflags,
<span class="lineno" id=line754></span>          header_search_dirs = config.FLX_RTL_DIRS+control.EXTRA_INCLUDE_DIRS,
<span class="lineno" id=line755></span>          macros = control.MACROS,
<span class="lineno" id=line756></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line757></span>        )
<span class="lineno" id=line758></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line759></span>      ;
<span class="lineno" id=line760></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE==1 <span class="small_keyword" title="logical disjunction">or</span> <span class="small_keyword" title="logical negation">not</span> cxx_depcheck (tc,src,dst) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line761></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.cxx_static_object_compiler (dst=dst,src=src); 
<span class="lineno" id=line762></span>        showtime(<span class="fstring">"Static c++   : "</span>+src,t0);
<span class="lineno" id=line763></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line764></span>          eprintln$ <span class="fstring">"[flx] C++ compilation "</span>+src+<span class="fstring">" failed"</span>;
<span class="lineno" id=line765></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line766></span>        <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line767></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line768></span>        <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line769></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line770></span>  
<span class="lineno" id=line771></span>    }
<span class="lineno" id=line772></span>  
<span class="lineno" id=line773></span>    <span class="comment">// C++ (many files)</span>
<span class="lineno" id=line774></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_cxx_compiler_if_required (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line775></span>    {
<span class="lineno" id=line776></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line777></span>      <span class="small_keyword" title="conditional">if</span> control.STATIC == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line778></span>        debugln <span class="fstring">"Dynamic linkage"</span>;
<span class="lineno" id=line779></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_compile_dynamic ehandler;
<span class="lineno" id=line780></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line781></span>        debugln <span class="fstring">"Static linkage"</span>;
<span class="lineno" id=line782></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_compile_static ehandler;
<span class="lineno" id=line783></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line784></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line785></span>    }
<span class="lineno" id=line786></span>  
<span class="lineno" id=line787></span>  <span class="comment">//=========================================================</span>
<span class="lineno" id=line788></span>  <span class="comment">// OCAML</span>
<span class="lineno" id=line789></span>  <span class="comment">//=========================================================</span>
<span class="lineno" id=line790></span>   <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocaml_compile1 (ehandler:1-&gt;0) (deps:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>], s:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line791></span>      <span class="big_keyword" title="Define a mutable variable">var</span> xqt = dxqt (control.ECHO == 1 <span class="small_keyword" title="logical disjunction">or</span> control.DEBUG_FLX);
<span class="lineno" id=line792></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = xqt(<span class="fstring">"ocamlopt.opt -c "</span> + cat <span class="fstring">" "</span> deps + <span class="fstring">" "</span>+ s);
<span class="lineno" id=line793></span>      <span class="hack">C_hack</span>::ignore(<span class="small_keyword" title="value of function return used in post condition">result</span>);
<span class="lineno" id=line794></span>      <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line795></span>   }
<span class="lineno" id=line796></span>  
<span class="lineno" id=line797></span>   <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocaml_compile (ehandler:1-&gt;0) = {
<span class="lineno" id=line798></span>      <span class="big_keyword" title="Define a mutable variable">var</span> deps = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line799></span>      <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.ocamls <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line800></span>        <span class="small_keyword" title="conditional">if</span> suffix(src,<span class="fstring">".cmi"</span>) 
<span class="lineno" id=line801></span>        <span class="small_keyword" title="logical disjunction">or</span> suffix(src,<span class="fstring">".cmx"</span>) 
<span class="lineno" id=line802></span>        <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line803></span>          deps+=src;
<span class="lineno" id=line804></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line805></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = ocaml_compile1 ehandler (deps,src);
<span class="lineno" id=line806></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line807></span>          <span class="small_keyword" title="conditional">if</span> suffix(src,<span class="fstring">".mli"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line808></span>            deps+= src.[..-5]+<span class="fstring">".cmi"</span>;
<span class="lineno" id=line809></span>          <span class="small_keyword" title="conditional">elif</span> suffix(src,<span class="fstring">".ml"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line810></span>            deps+= src.[..-4]+<span class="fstring">".cmi"</span>;
<span class="lineno" id=line811></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line812></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line813></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line814></span>      <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line815></span>   }
<span class="lineno" id=line816></span>  
<span class="lineno" id=line817></span>   <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_ocaml_compiler_if_required (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line818></span>   {
<span class="lineno" id=line819></span>     <span class="small_keyword" title="return">return</span> ocaml_compile ehandler;
<span class="lineno" id=line820></span>   }
<span class="lineno" id=line821></span>  
<span class="lineno" id=line822></span>  <span class="comment">// SWIFT</span>
<span class="lineno" id=line823></span>  
<span class="lineno" id=line824></span>   <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> swift_compile1 (ehandler:1-&gt;0) (deps:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>], s:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line825></span>      <span class="big_keyword" title="Define a mutable variable">var</span> xqt = dxqt (control.ECHO == 1 <span class="small_keyword" title="logical disjunction">or</span> control.DEBUG_FLX);
<span class="lineno" id=line826></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = xqt(<span class="fstring">"swiftc -c "</span> + cat <span class="fstring">" "</span> deps + <span class="fstring">" "</span>+ s);
<span class="lineno" id=line827></span>      <span class="hack">C_hack</span>::ignore(<span class="small_keyword" title="value of function return used in post condition">result</span>);
<span class="lineno" id=line828></span>      <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line829></span>   }
<span class="lineno" id=line830></span>  
<span class="lineno" id=line831></span>   <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> swift_compile (ehandler:1-&gt;0) = {
<span class="lineno" id=line832></span>      <span class="big_keyword" title="Define a mutable variable">var</span> deps = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line833></span>      <span class="small_keyword" title="for loop">for</span> src <span class="small_keyword" title="membership operator, function mem">in</span> control.swifts <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line834></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = swift_compile1 ehandler (deps,src);
<span class="lineno" id=line835></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line836></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line837></span>      <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line838></span>   }
<span class="lineno" id=line839></span>  
<span class="lineno" id=line840></span>   <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_swift_compiler_if_required (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line841></span>   {
<span class="lineno" id=line842></span>     <span class="small_keyword" title="return">return</span> swift_compile ehandler;
<span class="lineno" id=line843></span>   }
<span class="lineno" id=line844></span>  
<span class="lineno" id=line845></span>  
<span class="lineno" id=line846></span>  <span class="comment">/*
<span class="lineno" id=line847></span>  
<span class="lineno" id=line848></span>    gen check_run_if_required_and_uptodate() : bool  =
<span class="lineno" id=line849></span>    {
<span class="lineno" id=line850></span>  
<span class="lineno" id=line851></span>      if control.RECOMPILE == 0 and control.RUNIT == 1 and control.CLEAR_CACHE == 0 do
<span class="lineno" id=line852></span>        var uptodate = #check_cxx_uptodate and #check_binary_uptodate;
<span class="lineno" id=line853></span>        if control.STATIC == 0 do
<span class="lineno" id=line854></span>          if uptodate do
<span class="lineno" id=line855></span>            debugln$ "Running dynamically linked binary";
<span class="lineno" id=line856></span>            return true;
<span class="lineno" id=line857></span>          else
<span class="lineno" id=line858></span>            debugln$ "Dynamically linked binary out of date or non-existant";
<span class="lineno" id=line859></span>          done
<span class="lineno" id=line860></span>        else
<span class="lineno" id=line861></span>          if uptodate do
<span class="lineno" id=line862></span>            debugln$ "Running statically linked binary";
<span class="lineno" id=line863></span>            return true;
<span class="lineno" id=line864></span>          else
<span class="lineno" id=line865></span>            debugln$ "Statically linked binary out of date or non-existant";
<span class="lineno" id=line866></span>          done
<span class="lineno" id=line867></span>        done
<span class="lineno" id=line868></span>      done
<span class="lineno" id=line869></span>      return false;
<span class="lineno" id=line870></span>  
<span class="lineno" id=line871></span>    }
<span class="lineno" id=line872></span>    gen run_with_calpackages () : int = 
<span class="lineno" id=line873></span>    {
<span class="lineno" id=line874></span>      if control.STATIC == 0 do
<span class="lineno" id=line875></span>        return #run_dynamic_with_calpackages;
<span class="lineno" id=line876></span>      else
<span class="lineno" id=line877></span>        return #run_program_static;
<span class="lineno" id=line878></span>      done
<span class="lineno" id=line879></span>    }
<span class="lineno" id=line880></span>  */</span>
<span class="lineno" id=line881></span>  
<span class="lineno" id=line882></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line883></span>  <span class="comment">// LINKAGE</span>
<span class="lineno" id=line884></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line885></span>  
<span class="lineno" id=line886></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line887></span>    <span class="comment">// Link shared library (dll)</span>
<span class="lineno" id=line888></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line889></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_link_shared_library (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line890></span>    {
<span class="lineno" id=line891></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line892></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_dstrings= Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line893></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = control.extra_pkgs;
<span class="lineno" id=line894></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line895></span>        eprintln$ <span class="fstring">"[flx:cxx_link_shared_library] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line896></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line897></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line898></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line899></span>        ;
<span class="lineno" id=line900></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"-r"</span>+<span class="fstring">"--field=provides_dlib"</span>+<span class="fstring">"--field=requires_dlibs"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs + control.pkgs;
<span class="lineno" id=line901></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mydstrings = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line902></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line903></span>          eprintln$ <span class="fstring">"[flx:cxx_link_shared_library] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line904></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line905></span>          <span class="comment">//System::exit (1);</span>
<span class="lineno" id=line906></span>          throw_continuation ehandler;
<span class="lineno" id=line907></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line908></span>        pkg_dstrings = FlxPkg::fix2word_flags mydstrings;
<span class="lineno" id=line909></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line910></span>   
<span class="lineno" id=line911></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker 
<span class="lineno" id=line912></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line913></span>        (
<span class="lineno" id=line914></span>          dynamic_libraries = control.LINK_STRINGS+pkg_dstrings, <span class="comment">// a bit of a hack ..</span>
<span class="lineno" id=line915></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line916></span>        )
<span class="lineno" id=line917></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line918></span>      ;
<span class="lineno" id=line919></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXT_SHARED_OBJ = #(tc.dynamic_object_extension);
<span class="lineno" id=line920></span>      <span class="big_keyword" title="Define a mutable variable">var</span> extra_objects = unbox$ <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; f + EXT_SHARED_OBJ) control.cppobases;
<span class="lineno" id=line921></span>      <span class="small_keyword" title="conditional">if</span> control.CXXONLY == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line922></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.dynamic_library_linker
<span class="lineno" id=line923></span>          (
<span class="lineno" id=line924></span>            dst=control.LINKER_OUTPUT_FILENAME,
<span class="lineno" id=line925></span>            srcs= control.objs + extra_objects + (dvars.cpp_filebase+EXT_SHARED_OBJ)
<span class="lineno" id=line926></span>          )
<span class="lineno" id=line927></span>        ;
<span class="lineno" id=line928></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line929></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.dynamic_library_linker
<span class="lineno" id=line930></span>          (
<span class="lineno" id=line931></span>            dst=control.LINKER_OUTPUT_FILENAME,
<span class="lineno" id=line932></span>            srcs= control.objs  + extra_objects
<span class="lineno" id=line933></span>          )
<span class="lineno" id=line934></span>        ;
<span class="lineno" id=line935></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line936></span>  
<span class="lineno" id=line937></span>      showtime(<span class="fstring">"Dynamic link : "</span>+control.LINKER_OUTPUT_FILENAME,t0);
<span class="lineno" id=line938></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line939></span>        eprintln$ <span class="fstring">"[flx] C++ clink "</span>+control.LINKER_OUTPUT_FILENAME+<span class="fstring">" failed"</span>;
<span class="lineno" id=line940></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line941></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line942></span>    }
<span class="lineno" id=line943></span>  
<span class="lineno" id=line944></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_link_shared_library_with_calpackages (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line945></span>    {
<span class="lineno" id=line946></span>      calpackages ehandler;
<span class="lineno" id=line947></span>      <span class="small_keyword" title="return">return</span> cxx_link_shared_library ehandler;
<span class="lineno" id=line948></span>    }
<span class="lineno" id=line949></span>  
<span class="lineno" id=line950></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line951></span>    <span class="comment">// Link shared exe</span>
<span class="lineno" id=line952></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line953></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_link_shared_exe (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line954></span>    {
<span class="lineno" id=line955></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line956></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_dstrings= Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line957></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = control.extra_pkgs;
<span class="lineno" id=line958></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line959></span>        eprintln$ <span class="fstring">"[flx:cxx_link_shared_exe] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line960></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line961></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line962></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line963></span>        ;
<span class="lineno" id=line964></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"-r"</span>+<span class="fstring">"--field=provides_dlib"</span>+<span class="fstring">"--field=requires_dlibs"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs + control.pkgs;
<span class="lineno" id=line965></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mydstrings = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line966></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line967></span>          eprintln$ <span class="fstring">"[flx:cxx_link_shared_exe] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line968></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line969></span>          <span class="comment">//System::exit (1);</span>
<span class="lineno" id=line970></span>          throw_continuation ehandler;
<span class="lineno" id=line971></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line972></span>        pkg_dstrings = FlxPkg::fix2word_flags mydstrings;
<span class="lineno" id=line973></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line974></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line975></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line976></span>        (
<span class="lineno" id=line977></span>          <span class="comment">//ccflags = ccflags + control.CCFLAGS + control.LINK_STRINGS, </span>
<span class="lineno" id=line978></span>          dynamic_libraries = control.LINK_STRINGS + pkg_dstrings, <span class="comment">// a bit of a hack</span>
<span class="lineno" id=line979></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line980></span>        )
<span class="lineno" id=line981></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line982></span>      ;
<span class="lineno" id=line983></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Toolchain loaded "</span> + #(tc.whatami);
<span class="lineno" id=line984></span>  <span class="comment">/*
<span class="lineno" id=line985></span>  println$ "flx, prior to calling toolchain: DRIVER OBJS = " + control.DRIVER_OBJS.str;
<span class="lineno" id=line986></span>  println$ "flx, prior to calling toolchain: objs = " + control.objs.str;
<span class="lineno" id=line987></span>  */</span>
<span class="lineno" id=line988></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXT_DYNAMIC_OBJ = #(tc.dynamic_object_extension);
<span class="lineno" id=line989></span>      <span class="big_keyword" title="Define a mutable variable">var</span> extra_objects = unbox$ <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; f + EXT_DYNAMIC_OBJ) control.cppobases;
<span class="lineno" id=line990></span>      <span class="small_keyword" title="conditional">if</span> control.CXXONLY == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line991></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.dynamic_executable_linker
<span class="lineno" id=line992></span>          (
<span class="lineno" id=line993></span>            dst=control.LINKER_OUTPUT_FILENAME,
<span class="lineno" id=line994></span>            srcs= 
<span class="lineno" id=line995></span>              control.DRIVER_OBJS +
<span class="lineno" id=line996></span>              control.objs + extra_objects +
<span class="lineno" id=line997></span>              (dvars.cpp_filebase+<span class="fstring">"_static_link_thunk"</span>+EXT_DYNAMIC_OBJ) + 
<span class="lineno" id=line998></span>              (dvars.cpp_filebase+EXT_DYNAMIC_OBJ)
<span class="lineno" id=line999></span>          )
<span class="lineno" id=line1000></span>        ;
<span class="lineno" id=line1001></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1002></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.dynamic_executable_linker
<span class="lineno" id=line1003></span>          (
<span class="lineno" id=line1004></span>            dst=control.LINKER_OUTPUT_FILENAME,
<span class="lineno" id=line1005></span>            srcs= 
<span class="lineno" id=line1006></span>              control.objs + extra_objects
<span class="lineno" id=line1007></span>          )
<span class="lineno" id=line1008></span>        ;
<span class="lineno" id=line1009></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1010></span>      showtime(<span class="fstring">"Dynamic executable link  : "</span>+control.LINKER_OUTPUT_FILENAME,t0);
<span class="lineno" id=line1011></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1012></span>        eprintln$ <span class="fstring">"[flx] C++ dynamic executable link "</span>+control.LINKER_OUTPUT_FILENAME+<span class="fstring">" failed"</span>;
<span class="lineno" id=line1013></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1014></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1015></span>    }
<span class="lineno" id=line1016></span>  
<span class="lineno" id=line1017></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_link_shared_exe_with_calpackages(ehandler:1-&gt;0) :  <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1018></span>    {
<span class="lineno" id=line1019></span>      calpackages ehandler;
<span class="lineno" id=line1020></span>      <span class="small_keyword" title="return">return</span> cxx_link_shared_exe ehandler;
<span class="lineno" id=line1021></span>    }
<span class="lineno" id=line1022></span>  
<span class="lineno" id=line1023></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line1024></span>    <span class="comment">// Link static exe</span>
<span class="lineno" id=line1025></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line1026></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_link_static_exe (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1027></span>    {
<span class="lineno" id=line1028></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line1029></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkg_sstrings= Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line1030></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgs = control.extra_pkgs;
<span class="lineno" id=line1031></span>      <span class="small_keyword" title="conditional">if</span> pkgs != Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1032></span>        eprintln$ <span class="fstring">"[flx:cxx_link_static] Adding packages "</span> + <span class="library" title="Convert a value to a string">str</span> pkgs;
<span class="lineno" id=line1033></span>        <span class="big_keyword" title="Define a mutable variable">var</span> PKGCONFIG_PATH=unbox$ <span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line1034></span>           (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="fstring">"--path+="</span>+s) 
<span class="lineno" id=line1035></span>           config.FLX_CONFIG_DIRS
<span class="lineno" id=line1036></span>        ;
<span class="lineno" id=line1037></span>        <span class="big_keyword" title="Define a mutable variable">var</span> allargs = PKGCONFIG_PATH+<span class="fstring">"-r"</span>+<span class="fstring">"--field=provides_slib"</span>+<span class="fstring">"--field=requires_slibs"</span>+<span class="fstring">"--keepleftmost"</span>+pkgs + control.pkgs;
<span class="lineno" id=line1038></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ret,mysstrings = FlxPkgConfig::flx_pkgconfig(allargs);
<span class="lineno" id=line1039></span>        <span class="small_keyword" title="conditional">if</span> ret != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1040></span>          eprintln$ <span class="fstring">"[flx:cxx_link_static] Error "</span> + <span class="library" title="Convert a value to a string">str</span> ret + <span class="fstring">" executing flx_pkgconfig, args="</span> + <span class="library" title="Convert a value to a string">str</span> allargs;
<span class="lineno" id=line1041></span>          <span class="comment">// FIXME</span>
<span class="lineno" id=line1042></span>          <span class="comment">//System::exit (1);</span>
<span class="lineno" id=line1043></span>          throw_continuation ehandler;
<span class="lineno" id=line1044></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1045></span>        pkg_sstrings = FlxPkg::fix2word_flags mysstrings;
<span class="lineno" id=line1046></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1047></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line1048></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line1049></span>        (
<span class="lineno" id=line1050></span>          <span class="comment">//ccflags = ccflags + control.CCFLAGS + control.LINK_STRINGS, </span>
<span class="lineno" id=line1051></span>          static_libraries = control.LINK_STRINGS + pkg_sstrings, <span class="comment">// a bit of a hack</span>
<span class="lineno" id=line1052></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line1053></span>        )
<span class="lineno" id=line1054></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line1055></span>      ;
<span class="lineno" id=line1056></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXT_STATIC_OBJ = #(tc.static_object_extension);
<span class="lineno" id=line1057></span>      <span class="big_keyword" title="Define a mutable variable">var</span> extra_objects = unbox$ <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; f + EXT_STATIC_OBJ) control.cppobases;
<span class="lineno" id=line1058></span>      <span class="small_keyword" title="conditional">if</span> control.CXXONLY == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1059></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.static_executable_linker
<span class="lineno" id=line1060></span>          (
<span class="lineno" id=line1061></span>            dst=control.LINKER_OUTPUT_FILENAME,
<span class="lineno" id=line1062></span>            srcs= 
<span class="lineno" id=line1063></span>              control.DRIVER_OBJS +
<span class="lineno" id=line1064></span>              control.objs + extra_objects +
<span class="lineno" id=line1065></span>              (dvars.cpp_filebase+<span class="fstring">"_static_link_thunk"</span>+EXT_STATIC_OBJ) + 
<span class="lineno" id=line1066></span>              (dvars.cpp_filebase+EXT_STATIC_OBJ)
<span class="lineno" id=line1067></span>          )
<span class="lineno" id=line1068></span>        ;
<span class="lineno" id=line1069></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1070></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = tc.static_executable_linker
<span class="lineno" id=line1071></span>          (
<span class="lineno" id=line1072></span>            dst=control.LINKER_OUTPUT_FILENAME,
<span class="lineno" id=line1073></span>            srcs= 
<span class="lineno" id=line1074></span>              control.objs + extra_objects
<span class="lineno" id=line1075></span>          )
<span class="lineno" id=line1076></span>        ;
<span class="lineno" id=line1077></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1078></span>      showtime(<span class="fstring">"Static executable link  : "</span>+control.LINKER_OUTPUT_FILENAME,t0);
<span class="lineno" id=line1079></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1080></span>        eprintln$ <span class="fstring">"[flx] C++ static executable link "</span>+control.LINKER_OUTPUT_FILENAME+<span class="fstring">" failed"</span>;
<span class="lineno" id=line1081></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1082></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1083></span>    }
<span class="lineno" id=line1084></span>  
<span class="lineno" id=line1085></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_link_static_exe_with_calpackages(ehandler:1-&gt;0) :  <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1086></span>    {
<span class="lineno" id=line1087></span>      calpackages ehandler;
<span class="lineno" id=line1088></span>      <span class="small_keyword" title="return">return</span> cxx_link_static_exe ehandler;
<span class="lineno" id=line1089></span>    }
<span class="lineno" id=line1090></span>  
<span class="lineno" id=line1091></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line1092></span>    <span class="comment">// Link static (archive) library</span>
<span class="lineno" id=line1093></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line1094></span>  
<span class="lineno" id=line1095></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cxx_static_library (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1096></span>    {
<span class="lineno" id=line1097></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line1098></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line1099></span>        <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line1100></span>        (
<span class="lineno" id=line1101></span>          <span class="comment">//ccflags = ccflags + control.CCFLAGS,</span>
<span class="lineno" id=line1102></span>          debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line1103></span>        )
<span class="lineno" id=line1104></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line1105></span>      ;
<span class="lineno" id=line1106></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXT_STATIC_OBJ = #(tc.static_object_extension);
<span class="lineno" id=line1107></span>      <span class="big_keyword" title="Define a mutable variable">var</span> extra_objects = unbox$ <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; f + EXT_STATIC_OBJ) control.cppobases;
<span class="lineno" id=line1108></span>      <span class="small_keyword" title="conditional">if</span> control.CXXONLY == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1109></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = tc . static_library_linker 
<span class="lineno" id=line1110></span>          (
<span class="lineno" id=line1111></span>            srcs=control.objs + extra_objects + (dvars.cpp_filebase+EXT_STATIC_OBJ) ,
<span class="lineno" id=line1112></span>            dst=control.LINKER_OUTPUT_FILENAME
<span class="lineno" id=line1113></span>          )
<span class="lineno" id=line1114></span>        ;
<span class="lineno" id=line1115></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1116></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = tc . static_library_linker 
<span class="lineno" id=line1117></span>          (
<span class="lineno" id=line1118></span>            srcs=control.objs + extra_objects,
<span class="lineno" id=line1119></span>            dst=control.LINKER_OUTPUT_FILENAME
<span class="lineno" id=line1120></span>          )
<span class="lineno" id=line1121></span>        ;
<span class="lineno" id=line1122></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1123></span>      showtime(<span class="fstring">"Static lib   : "</span>+control.LINKER_OUTPUT_FILENAME,t0);
<span class="lineno" id=line1124></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1125></span>        eprintln$ <span class="fstring">"[flx] C++ static library link "</span>+control.LINKER_OUTPUT_FILENAME+<span class="fstring">" failed"</span>;
<span class="lineno" id=line1126></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1127></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1128></span>    }
<span class="lineno" id=line1129></span>  
<span class="lineno" id=line1130></span>  
<span class="lineno" id=line1131></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> cal_object_extension () : <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line1132></span>    {
<span class="lineno" id=line1133></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tc = toolchain_maker  
<span class="lineno" id=line1134></span>      <span class="small_keyword" title="define an object interface">extend</span> dflt_toolchain_config <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line1135></span>      (
<span class="lineno" id=line1136></span>        <span class="comment">//ccflags = ccflags + control.CCFLAGS,</span>
<span class="lineno" id=line1137></span>        debugln = <span class="small_keyword" title="conditional">if</span> control.ECHO==1 <span class="small_keyword" title="conditional">then</span> echoln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">else</span> debugln[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line1138></span>      )
<span class="lineno" id=line1139></span>      <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line1140></span>      ;
<span class="lineno" id=line1141></span>      <span class="big_keyword" title="Define a mutable variable">var</span> EXT_OBJ = 
<span class="lineno" id=line1142></span>        <span class="small_keyword" title="conditional">if</span> control.STATIC == 0 
<span class="lineno" id=line1143></span>        <span class="small_keyword" title="conditional">then</span> #(tc.dynamic_object_extension)
<span class="lineno" id=line1144></span>        <span class="small_keyword" title="conditional">else</span> #(tc.static_object_extension)
<span class="lineno" id=line1145></span>      ;
<span class="lineno" id=line1146></span>      <span class="small_keyword" title="return">return</span> EXT_OBJ;
<span class="lineno" id=line1147></span>  }
<span class="lineno" id=line1148></span>  
<span class="lineno" id=line1149></span>    <span class="comment">// Assumes C++ generated by flxg (using timestamp of dep file)</span>
<span class="lineno" id=line1150></span>    <span class="comment">// Assumes command line C++ file includes older than the argument (fixme!)</span>
<span class="lineno" id=line1151></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> check_binary_uptodate () : bool =
<span class="lineno" id=line1152></span>    {
<span class="lineno" id=line1153></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> maxf (t:<span class="library" title="binding of C double float type">double</span>) (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; max (t, FileStat::dfiletime (f, #FileStat::future_time));
<span class="lineno" id=line1154></span>  
<span class="lineno" id=line1155></span>      debugln <span class="fstring">"Check C++-&gt;binary uptodate"</span>;
<span class="lineno" id=line1156></span>      <span class="small_keyword" title="conditional">if</span> control.RECOMPILE == 1 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1157></span>        debugln$ <span class="fstring">"C++-&gt;binary dependency checking skipped due to switch RECOMPILE=1: forced not uptodate"</span>;
<span class="lineno" id=line1158></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>;
<span class="lineno" id=line1159></span>      <span class="small_keyword" title="conditional">elif</span> control.CHECK_DEPENDENCIES == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1160></span>        debugln <span class="fstring">"Checking C++-&gt;binary dependencies since CHECK_DEPENDENCIES=1 to see if the output is uptodate"</span>;
<span class="lineno" id=line1161></span>        <span class="big_keyword" title="Define a mutable variable">var</span> EXT_OBJ = cal_object_extension();
<span class="lineno" id=line1162></span>        <span class="big_keyword" title="Define a mutable variable">var</span> extra_objects = unbox$ <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; f + EXT_OBJ) control.cppobases;
<span class="lineno" id=line1163></span>        <span class="big_keyword" title="Define a mutable variable">var</span> xtime = FileStat::dfiletime(control.LINKER_OUTPUT_FILENAME,#FileStat::past_time);
<span class="lineno" id=line1164></span>        <span class="big_keyword" title="Define an immutable value">val</span> depfilename = cache_join (config.FLX_OUTPUT_DIR, dvars.filebase+<span class="fstring">".dep"</span>);
<span class="lineno" id=line1165></span>        <span class="big_keyword" title="Define a mutable variable">var</span> flx_srctime = FileStat::dfiletime (depfilename,#FileStat::future_time);
<span class="lineno" id=line1166></span>        <span class="big_keyword" title="Define a mutable variable">var</span> c_srctime = <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> maxf #FileStat::past_time control.cs;
<span class="lineno" id=line1167></span>        <span class="big_keyword" title="Define a mutable variable">var</span> cpp_srctime = <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> maxf #FileStat::past_time control.cpps;
<span class="lineno" id=line1168></span>        <span class="big_keyword" title="Define a mutable variable">var</span> objc_srctime = <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> maxf #FileStat::past_time control.objcs;
<span class="lineno" id=line1169></span>        <span class="big_keyword" title="Define a mutable variable">var</span> objcpp_srctime = <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> maxf #FileStat::past_time control.objcpps;
<span class="lineno" id=line1170></span>        <span class="big_keyword" title="Define a mutable variable">var</span> obj_srctime = <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> maxf #FileStat::past_time (control.objs + extra_objects);
<span class="lineno" id=line1171></span>        <span class="big_keyword" title="Define a mutable variable">var</span> deptime = max (max (max (flx_srctime, cpp_srctime), c_srctime), obj_srctime);
<span class="lineno" id=line1172></span>        <span class="big_keyword" title="Define a mutable variable">var</span> uptodate = xtime &gt; deptime;
<span class="lineno" id=line1173></span>  
<span class="lineno" id=line1174></span>  
<span class="lineno" id=line1175></span>        debugln$ <span class="fstring">"Extra objc sources  "</span>+ <span class="library" title="Convert a value to a string">str</span> control.cs;
<span class="lineno" id=line1176></span>        debugln$ <span class="fstring">"Extra objc++ sources  "</span>+ <span class="library" title="Convert a value to a string">str</span> control.cpps;
<span class="lineno" id=line1177></span>        debugln$ <span class="fstring">"Extra c sources  "</span>+ <span class="library" title="Convert a value to a string">str</span> control.cs;
<span class="lineno" id=line1178></span>        debugln$ <span class="fstring">"Extra c++ sources  "</span>+ <span class="library" title="Convert a value to a string">str</span> control.cpps;
<span class="lineno" id=line1179></span>        debugln$ <span class="fstring">"Extra object files "</span>+ <span class="library" title="Convert a value to a string">str</span> control.objs;
<span class="lineno" id=line1180></span>        debugln$ <span class="fstring">"Extra object bases "</span>+ <span class="library" title="Convert a value to a string">str</span> control.cppobases;
<span class="lineno" id=line1181></span>  
<span class="lineno" id=line1182></span>        debugln$ <span class="fstring">"Extra ocaml files  "</span>+ <span class="library" title="Convert a value to a string">str</span> control.ocamls;
<span class="lineno" id=line1183></span>        debugln$ <span class="fstring">"Extra swift files  "</span>+ <span class="library" title="Convert a value to a string">str</span> control.swifts;
<span class="lineno" id=line1184></span>  
<span class="lineno" id=line1185></span>        debugln$ <span class="fstring">"Filebase = "</span> + dvars.filebase; 
<span class="lineno" id=line1186></span>  
<span class="lineno" id=line1187></span>        debugln$ <span class="fstring">"cache   time = "</span> + FileStat::strfiletime (control.cache_time);
<span class="lineno" id=line1188></span>        debugln$ <span class="fstring">"flx_src time = "</span> + FileStat::strfiletime (flx_srctime);
<span class="lineno" id=line1189></span>        debugln$ <span class="fstring">"objc_src time = "</span> + FileStat::strfiletime (objc_srctime);
<span class="lineno" id=line1190></span>        debugln$ <span class="fstring">"objcpp_src time = "</span> + FileStat::strfiletime (objcpp_srctime);
<span class="lineno" id=line1191></span>        debugln$ <span class="fstring">"c_src time = "</span> + FileStat::strfiletime (c_srctime);
<span class="lineno" id=line1192></span>        debugln$ <span class="fstring">"cpp_src time = "</span> + FileStat::strfiletime (cpp_srctime);
<span class="lineno" id=line1193></span>        debugln$ <span class="fstring">"obj_src time = "</span> + FileStat::strfiletime (obj_srctime);
<span class="lineno" id=line1194></span>  
<span class="lineno" id=line1195></span>        debugln$ <span class="fstring">"dep     time = "</span> + FileStat::strfiletime (deptime);
<span class="lineno" id=line1196></span>        debugln$ <span class="fstring">"Binary  time = "</span> + FileStat::strfiletime (xtime) + <span class="fstring">" for "</span> + control.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line1197></span>        debugln$ <span class="fstring">"output is "</span> + <span class="small_keyword" title="conditional">if</span> uptodate <span class="small_keyword" title="conditional">then</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">" NOT "</span> <span class="small_keyword" title="conditional">endif</span> + <span class="fstring">" up to date"</span>;
<span class="lineno" id=line1198></span>        <span class="small_keyword" title="return">return</span> uptodate;
<span class="lineno" id=line1199></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1200></span>        debugln$ <span class="fstring">"C++-&gt;binary dependency checking skipped due to switch CHECK_DEPENDENCIES=0: forced uptodate"</span>;
<span class="lineno" id=line1201></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="truth value">true</span>;
<span class="lineno" id=line1202></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1203></span>    }
<span class="lineno" id=line1204></span>  
<span class="lineno" id=line1205></span>  
<span class="lineno" id=line1206></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_linker_if_required(ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1207></span>    {
<span class="lineno" id=line1208></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line1209></span>      <span class="small_keyword" title="conditional">if</span> control.CCOMPILEIT == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1210></span>        debugln <span class="fstring">"C++ compilation (and linking and running) skipped by switch"</span>;
<span class="lineno" id=line1211></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1212></span>        <span class="big_keyword" title="Define a mutable variable">var</span> uptodate = #check_binary_uptodate;
<span class="lineno" id=line1213></span>        <span class="small_keyword" title="conditional">if</span> uptodate <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1214></span>          debugln <span class="fstring">"Linking skipped because binary is uptodate"</span>;
<span class="lineno" id=line1215></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1216></span>          <span class="small_keyword" title="conditional">if</span> control.STATIC == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1217></span>            debugln <span class="fstring">"Dynamic linkage"</span>;
<span class="lineno" id=line1218></span>            <span class="small_keyword" title="conditional">if</span> control.LINKEXE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1219></span>              <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_link_shared_exe_with_calpackages ehandler;
<span class="lineno" id=line1220></span>            <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1221></span>              <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_link_shared_library_with_calpackages ehandler;
<span class="lineno" id=line1222></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1223></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1224></span>            debugln <span class="fstring">"Static linkage"</span>;
<span class="lineno" id=line1225></span>            <span class="small_keyword" title="conditional">if</span> control.STATICLIB == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1226></span>              <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_static_library ehandler;
<span class="lineno" id=line1227></span>            <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1228></span>              <span class="small_keyword" title="value of function return used in post condition">result</span> = cxx_link_static_exe_with_calpackages ehandler;
<span class="lineno" id=line1229></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1230></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1231></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1232></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1233></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1234></span>    }
<span class="lineno" id=line1235></span>  
<span class="lineno" id=line1236></span>  
<span class="lineno" id=line1237></span>  
<span class="lineno" id=line1238></span>  <span class="comment">/*
<span class="lineno" id=line1239></span>    method gen runit() : int = {
<span class="lineno" id=line1240></span>      var immediate_run = #check_run_if_required_and_uptodate;
<span class="lineno" id=line1241></span>      if immediate_run do
<span class="lineno" id=line1242></span>        debugln$ "Uptodate so run immediately";
<span class="lineno" id=line1243></span>        return #run_with_calpackages;
<span class="lineno" id=line1244></span>      else
<span class="lineno" id=line1245></span>        var result = #run_felix_compiler_if_required;
<span class="lineno" id=line1246></span>        if result != 0 return result;
<span class="lineno" id=line1247></span>        return #run_cxx_and_exe_as_required;
<span class="lineno" id=line1248></span>      done
<span class="lineno" id=line1249></span>    }
<span class="lineno" id=line1250></span>  */</span>
<span class="lineno" id=line1251></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line1252></span>  <span class="comment">// EXECUTION</span>
<span class="lineno" id=line1253></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line1254></span>    
<span class="lineno" id=line1255></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_program_dynamic (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line1256></span>    {
<span class="lineno" id=line1257></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line1258></span>      <span class="small_keyword" title="conditional">if</span> control.CXXONLY == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1259></span>        <span class="big_keyword" title="Define a mutable variable">var</span> xargs =
<span class="lineno" id=line1260></span>          control.DRIVER_EXE +
<span class="lineno" id=line1261></span>          dvars.DEBUGSWITCH +
<span class="lineno" id=line1262></span>          control.LINKER_OUTPUT_FILENAME +
<span class="lineno" id=line1263></span>          dvars.args
<span class="lineno" id=line1264></span>        ;
<span class="lineno" id=line1265></span>        <span class="big_keyword" title="Define a mutable variable">var</span> CMD = strcat <span class="fstring">' '</span> control.FLXRUN + <span class="fstring">' '</span> + catmap <span class="fstring">' '</span> Shell::quote_arg xargs;
<span class="lineno" id=line1266></span>        <span class="small_keyword" title="conditional">if</span> control.STDOUT != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> CMD=CMD+<span class="fstring">" &gt; "</span> +Shell::quote_arg(control.STDOUT); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1267></span>        <span class="small_keyword" title="conditional">if</span> control.STDIN != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> CMD=CMD+<span class="fstring">" &lt; "</span> +Shell::quote_arg(control.STDIN); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1268></span>        debugln$ <span class="fstring">"Run command="</span>+CMD;
<span class="lineno" id=line1269></span>        <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line1270></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = system(CMD);
<span class="lineno" id=line1271></span>        showtime(<span class="fstring">"Dynamic Run : "</span>+control.LINKER_OUTPUT_FILENAME,t0);
<span class="lineno" id=line1272></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1273></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Cannot run C++ dynamic library "</span> + control.LINKER_OUTPUT_FILENAME;
<span class="lineno" id=line1274></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1275></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1276></span>    }
<span class="lineno" id=line1277></span>  
<span class="lineno" id=line1278></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_program_static (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1279></span>    {
<span class="lineno" id=line1280></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line1281></span>      <span class="big_keyword" title="Define a mutable variable">var</span> CMD = 
<span class="lineno" id=line1282></span>        catmap <span class="fstring">' '</span> Shell::quote_arg ( dvars.STATIC_ENV + control.LINKER_OUTPUT_FILENAME + dvars.args )
<span class="lineno" id=line1283></span>      ;
<span class="lineno" id=line1284></span>  
<span class="lineno" id=line1285></span>      <span class="small_keyword" title="conditional">if</span> control.STDOUT != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> CMD=CMD + <span class="fstring">" &gt; "</span>+Shell::quote_arg(control.STDOUT); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1286></span>      <span class="small_keyword" title="conditional">if</span> control.STDIN != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> CMD=CMD+<span class="fstring">" &lt; "</span> +Shell::quote_arg(control.STDIN); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1287></span>      debugln$ <span class="fstring">"Run command="</span>+CMD;
<span class="lineno" id=line1288></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t0 = #Time::time;
<span class="lineno" id=line1289></span>      <span class="small_keyword" title="value of function return used in post condition">result</span>=system(CMD);
<span class="lineno" id=line1290></span>      showtime(<span class="fstring">"Static Run   : "</span>+control.LINKER_OUTPUT_FILENAME,t0);
<span class="lineno" id=line1291></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1292></span>    }
<span class="lineno" id=line1293></span>  
<span class="lineno" id=line1294></span>  
<span class="lineno" id=line1295></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_dynamic_with_calpackages (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1296></span>    {
<span class="lineno" id=line1297></span>      calpackages ehandler;
<span class="lineno" id=line1298></span>      <span class="small_keyword" title="return">return</span> run_program_dynamic ehandler;
<span class="lineno" id=line1299></span>    }
<span class="lineno" id=line1300></span>  
<span class="lineno" id=line1301></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> run_program_if_required (ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1302></span>    {
<span class="lineno" id=line1303></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line1304></span>      <span class="small_keyword" title="conditional">if</span> control.STATIC == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1305></span>        debugln$ <span class="fstring">"Running dynamic program"</span>;
<span class="lineno" id=line1306></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_dynamic_with_calpackages ehandler;
<span class="lineno" id=line1307></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1308></span>        <span class="comment">// NOTE: since Felix sets environment variable for plugin loads ..</span>
<span class="lineno" id=line1309></span>        <span class="comment">// doesn't even a static program need calpackages?</span>
<span class="lineno" id=line1310></span>        debugln$ <span class="fstring">"Running static program"</span>;
<span class="lineno" id=line1311></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_program_static ehandler;
<span class="lineno" id=line1312></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1313></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1314></span>    }
<span class="lineno" id=line1315></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line1316></span>  <span class="comment">// OUTPUT VERIFICATION</span>
<span class="lineno" id=line1317></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line1318></span>  
<span class="lineno" id=line1319></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> check_output_if_required () : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line1320></span>    {
<span class="lineno" id=line1321></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line1322></span>      <span class="big_keyword" title="Define a mutable variable">var</span> expected = control.EXPECT;
<span class="lineno" id=line1323></span>      <span class="big_keyword" title="Define a mutable variable">var</span> output = control.STDOUT;
<span class="lineno" id=line1324></span>  
<span class="lineno" id=line1325></span>      <span class="comment">// possible bug in flx, if either missing it should have been</span>
<span class="lineno" id=line1326></span>      <span class="comment">// set by default based on program name</span>
<span class="lineno" id=line1327></span>      <span class="small_keyword" title="conditional">if</span> output == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1328></span>        eprintln$ <span class="fstring">"[flx] No output file given??"</span>;
<span class="lineno" id=line1329></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = 1;
<span class="lineno" id=line1330></span>      <span class="small_keyword" title="conditional">elif</span> expected == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1331></span>        eprintln$ <span class="fstring">"[flx] No expect file given??"</span>;
<span class="lineno" id=line1332></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = 1;
<span class="lineno" id=line1333></span>      <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line1334></span>        
<span class="lineno" id=line1335></span>        <span class="comment">// note load never fails, at worse loads empty string.</span>
<span class="lineno" id=line1336></span>        <span class="big_keyword" title="Define a mutable variable">var</span> output_text = load_text (output);
<span class="lineno" id=line1337></span>        <span class="big_keyword" title="Define a mutable variable">var</span> expected_text = load_text (expected);
<span class="lineno" id=line1338></span>        <span class="big_keyword" title="Define a mutable variable">var</span> bresult = output_text == expected_text;
<span class="lineno" id=line1339></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> bresult <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1340></span>          eprintln$ <span class="fstring">"[flx] Output "</span> + output + <span class="fstring">" doesn't match expected "</span> + expected;
<span class="lineno" id=line1341></span>          <span class="small_keyword" title="value of function return used in post condition">result</span> = 1;
<span class="lineno" id=line1342></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1343></span>      <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line1344></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1345></span>    }
<span class="lineno" id=line1346></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line1347></span>  <span class="comment">// ORDER OF OPERATION</span>
<span class="lineno" id=line1348></span>  <span class="comment">//----------------------------------------------------------------------------</span>
<span class="lineno" id=line1349></span>  
<span class="lineno" id=line1350></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> runit(ehandler:1-&gt;0) : <span class="library" title="binding of C int type">int</span> = {
<span class="lineno" id=line1351></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line1352></span>      <span class="small_keyword" title="conditional">if</span> control.FELIX == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1353></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_felix_compiler_if_required ehandler;
<span class="lineno" id=line1354></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1355></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1356></span>        debugln$ <span class="fstring">"Felix compilation skipped by switch"</span>;
<span class="lineno" id=line1357></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1358></span>  
<span class="lineno" id=line1359></span>      <span class="comment">// we should run this on demand? And split up calculations</span>
<span class="lineno" id=line1360></span>      <span class="comment">// for driver (needed to run dynamic program) and headers etc</span>
<span class="lineno" id=line1361></span>      <span class="comment">// (needed after flxg to complete C++ code gen) and link stuff</span>
<span class="lineno" id=line1362></span>      <span class="comment">// (needed for linkage)</span>
<span class="lineno" id=line1363></span>      calpackages ehandler;
<span class="lineno" id=line1364></span>      <span class="small_keyword" title="conditional">if</span> control.LINKER_OUTPUT_FILENAME != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1365></span>         Directory::mkdirs (Filename::dirname control.LINKER_OUTPUT_FILENAME);
<span class="lineno" id=line1366></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1367></span>  
<span class="lineno" id=line1368></span>      <span class="small_keyword" title="conditional">if</span> control.CCOMPILEIT == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1369></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_cxx_compiler_if_required ehandler;
<span class="lineno" id=line1370></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1371></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1372></span>        debugln <span class="fstring">"C++ compilation (and linking and running) skipped by switch"</span>;
<span class="lineno" id=line1373></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1374></span>  
<span class="lineno" id=line1375></span>      <span class="small_keyword" title="conditional">if</span> control.CCOMPILEIT == 1 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// use this switch for Ocaml compiles too</span>
<span class="lineno" id=line1376></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_ocaml_compiler_if_required ehandler;
<span class="lineno" id=line1377></span>      <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line1378></span>        debugln <span class="fstring">"Ocaml compilation skipped by switch"</span>;
<span class="lineno" id=line1379></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1380></span>  
<span class="lineno" id=line1381></span>      <span class="small_keyword" title="conditional">if</span> control.CCOMPILEIT == 1 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// use this switch for swift compiles too</span>
<span class="lineno" id=line1382></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_swift_compiler_if_required ehandler;
<span class="lineno" id=line1383></span>      <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line1384></span>        debugln <span class="fstring">"Swift compilation skipped by switch"</span>;
<span class="lineno" id=line1385></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1386></span>  
<span class="lineno" id=line1387></span>  
<span class="lineno" id=line1388></span>      <span class="small_keyword" title="conditional">if</span> control.LINKIT == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1389></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_linker_if_required ehandler;
<span class="lineno" id=line1390></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1391></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1392></span>        debugln <span class="fstring">"Link step skipped by switch"</span>;
<span class="lineno" id=line1393></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1394></span>  
<span class="lineno" id=line1395></span>      <span class="small_keyword" title="conditional">if</span> control.RUNIT == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1396></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = run_program_if_required ehandler;
<span class="lineno" id=line1397></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1398></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1399></span>        debugln <span class="fstring">"Running program skipped by switch"</span>;
<span class="lineno" id=line1400></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1401></span>  
<span class="lineno" id=line1402></span>      <span class="small_keyword" title="conditional">if</span> control.EXPECT != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1403></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = #check_output_if_required;
<span class="lineno" id=line1404></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1405></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1406></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line1407></span>    }
<span class="lineno" id=line1408></span>  
<span class="lineno" id=line1409></span>  }
<span class="lineno" id=line1410></span>  
</pre></p></div><h2 id='The_{flx}_tool._h'><img src='/share/src/web/images/minus.gif' id='The {flx} tool.' onclick='toggle(this,"The_{flx}_tool._d")' alt='+'/> 1.6 The {flx} tool.</h2><div id='The_{flx}_tool._d' style='display:block'>
<pre class='inclusion'>
share/lib/std/felix/flx/flx.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/config"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_cache"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_pkg"</span>;
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_flxg"</span>;
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_cxx"</span>;
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_control"</span>;
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_cmdopt"</span>;
<span class="lineno" id=line10></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_depvars"</span>;
<span class="lineno" id=line11></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_run"</span>;
<span class="lineno" id=line12></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_config"</span>;
<span class="lineno" id=line13></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_interface"</span>;
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>  <span class="big_keyword" title="Open a module or class">open</span> FlxCache;
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> startlib (x:<span class="library" title="binding of C++ string type">string</span>) =
<span class="lineno" id=line18></span>  {
<span class="lineno" id=line19></span>     <span class="small_keyword" title="return">return</span> x <span class="small_keyword" title="membership operator, function mem">in</span> RE2(<span class="fstring">" *(fun|proc|var|val|gen|union|struct|typedef).*\n"</span>);
<span class="lineno" id=line20></span>  }
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>  <span class="comment">// MOVE LATER!</span>
<span class="lineno" id=line23></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> repl()
<span class="lineno" id=line24></span>  {
<span class="lineno" id=line25></span>  
<span class="lineno" id=line26></span>  nextline:&gt;
<span class="lineno" id=line27></span>    <span class="library" title="Print a string to standard output">print</span> <span class="fstring">"&gt; "</span>; fflush stdout;
<span class="lineno" id=line28></span>    <span class="big_keyword" title="Define a mutable variable">var</span> text = <span class="library" title="Read a string from a stream including trailing newline">readln</span> stdin;
<span class="lineno" id=line29></span>    <span class="small_keyword" title="conditional">if</span> feof(stdin) <span class="small_keyword" title="return">return</span>;
<span class="lineno" id=line30></span>  
<span class="lineno" id=line31></span>    <span class="small_keyword" title="conditional">if</span> startlib(text) <span class="small_keyword" title="jump to label">goto</span> morelibrary;
<span class="lineno" id=line32></span>    <span class="small_keyword" title="jump to label">goto</span> executable;
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>  morelibrary:&gt;
<span class="lineno" id=line35></span>    <span class="library" title="Print a string to standard output">print</span> <span class="fstring">".. "</span>; fflush stdout;
<span class="lineno" id=line36></span>    <span class="big_keyword" title="Define a mutable variable">var</span> more = <span class="library" title="Read a string from a stream including trailing newline">readln</span> stdin;
<span class="lineno" id=line37></span>    <span class="small_keyword" title="conditional">if</span> feof(stdin) <span class="small_keyword" title="return">return</span>;
<span class="lineno" id=line38></span>  
<span class="lineno" id=line39></span>    <span class="small_keyword" title="conditional">if</span> more == <span class="fstring">"\n"</span> <span class="small_keyword" title="jump to label">goto</span> saveit;
<span class="lineno" id=line40></span>    text += more;
<span class="lineno" id=line41></span>    <span class="small_keyword" title="jump to label">goto</span> morelibrary;
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>  saveit:&gt;
<span class="lineno" id=line44></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dlibrary = load(<span class="fstring">"library.flx"</span>);
<span class="lineno" id=line45></span>    dlibrary += text;
<span class="lineno" id=line46></span>    save(<span class="fstring">"library.flx"</span>,dlibrary);
<span class="lineno" id=line47></span>    <span class="small_keyword" title="jump to label">goto</span> nextline;
<span class="lineno" id=line48></span>  
<span class="lineno" id=line49></span>  executable:&gt;
<span class="lineno" id=line50></span>     <span class="big_keyword" title="Define a mutable variable">var</span> session = load(<span class="fstring">"session.flx"</span>);
<span class="lineno" id=line51></span>     session += text;
<span class="lineno" id=line52></span>     save (<span class="fstring">"session.flx"</span>, session);
<span class="lineno" id=line53></span>     dlibrary = load(<span class="fstring">"library.flx"</span>);
<span class="lineno" id=line54></span>     <span class="big_keyword" title="Define a mutable variable">var</span> torun = dlibrary + text;
<span class="lineno" id=line55></span>     save (<span class="fstring">"cmd.flx"</span>, torun);
<span class="lineno" id=line56></span>  }
<span class="lineno" id=line57></span>  
<span class="lineno" id=line58></span>  
<span class="lineno" id=line59></span>  <span class="comment">// Felix version of THIS program (NOT the one being installed</span>
<span class="lineno" id=line60></span>  <span class="comment">// if you're using flx to install Felix)</span>
<span class="lineno" id=line61></span>  
<span class="lineno" id=line62></span>  
<span class="lineno" id=line63></span>  <span class="big_keyword" title="Define a type class">class</span> Flx
<span class="lineno" id=line64></span>  {
<span class="lineno" id=line65></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> flx_processing
<span class="lineno" id=line66></span>    (
<span class="lineno" id=line67></span>      config:&amp;Config::config_type, 
<span class="lineno" id=line68></span>      control:&amp;FlxControl::control_type,
<span class="lineno" id=line69></span>      loopctl:&amp;FlxControl::loopctl_type,
<span class="lineno" id=line70></span>      args:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line71></span>    ) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line72></span>    {
<span class="lineno" id=line73></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line74></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (a:<span class="library" title="binding of C++ string type">string</span>, b:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (a,b);
<span class="lineno" id=line75></span>      FlxCmdOpt::processing_stage1 (config,control,loopctl,<span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[<span class="library" title="binding of C++ string type">string</span>] args);
<span class="lineno" id=line76></span>      <span class="small_keyword" title="conditional">if</span> control*.VALIDATE_CACHE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line77></span>        check_cache(config, control);
<span class="lineno" id=line78></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line79></span>      <span class="small_keyword" title="conditional">if</span> 
<span class="lineno" id=line80></span>        loopctl*.base == <span class="fstring">""</span> <span class="small_keyword" title="logical conjunction">and</span> 
<span class="lineno" id=line81></span>        control*.INREGEX == <span class="fstring">""</span> 
<span class="lineno" id=line82></span>        <span class="small_keyword" title="logical conjunction">and</span> <span class="small_keyword" title="logical negation">not</span> control*.CMDLINE_INPUT 
<span class="lineno" id=line83></span>      <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line84></span>        <span class="small_keyword" title="conditional">if</span> control*.CLEAR_CACHE != 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line85></span>          <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"usage: flx [options] filename"</span>;
<span class="lineno" id=line86></span>          <span class="comment">// TOP LEVEL FLX, OK</span>
<span class="lineno" id=line87></span>          System::exit(1);
<span class="lineno" id=line88></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line89></span>        <span class="comment">// TOP LEVEL FLX, OK</span>
<span class="lineno" id=line90></span>        System::exit(0);
<span class="lineno" id=line91></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line92></span>  
<span class="lineno" id=line93></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgconfig = FlxPkgConfig::FlxPkgConfigQuery$ config*.FLX_CONFIG_DIRS;
<span class="lineno" id=line94></span>      <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ehandler () {
<span class="lineno" id=line95></span>        eprintln$ <span class="fstring">"Flx: default ehandler: temporary ehandler invoked"</span>;
<span class="lineno" id=line96></span>        System::exit 1;
<span class="lineno" id=line97></span>      }
<span class="lineno" id=line98></span>   
<span class="lineno" id=line99></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_name = 
<span class="lineno" id=line100></span>        <span class="comment">// toolchain pkg 1</span>
<span class="lineno" id=line101></span>        <span class="small_keyword" title="conditional">if</span> control*.FLX_TOOLCHAIN == <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> pkgconfig.getpkgfield1 ehandler (<span class="fstring">"toolchain"</span>, <span class="fstring">"toolchain"</span>)
<span class="lineno" id=line102></span>        <span class="small_keyword" title="conditional">else</span> control*.FLX_TOOLCHAIN
<span class="lineno" id=line103></span>      ;
<span class="lineno" id=line104></span>  
<span class="lineno" id=line105></span>      <span class="big_keyword" title="Define a mutable variable">var</span> c_compiler_executable = 
<span class="lineno" id=line106></span>        pkgconfig.getpkgfielddflt ehandler (toolchain_name+<span class="fstring">"_c_compiler_executable"</span>, <span class="fstring">"compiler"</span>)
<span class="lineno" id=line107></span>      ;
<span class="lineno" id=line108></span>  
<span class="lineno" id=line109></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cxx_compiler_executable = 
<span class="lineno" id=line110></span>        pkgconfig.getpkgfielddflt ehandler (toolchain_name+<span class="fstring">"_cxx_compiler_executable"</span>, <span class="fstring">"compiler"</span>)
<span class="lineno" id=line111></span>      ;
<span class="lineno" id=line112></span>  
<span class="lineno" id=line113></span>  
<span class="lineno" id=line114></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_maker =
<span class="lineno" id=line115></span>         <span class="small_keyword" title="match statement or expression">match</span> toolchain_name <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line116></span>         | x =&gt; 
<span class="lineno" id=line117></span>           Dynlink::load-plugin-func1 [toolchain_t,toolchain_config_t] ( dll-name=x, setup-str=<span class="fstring">""</span>)
<span class="lineno" id=line118></span>         <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line119></span>      ;
<span class="lineno" id=line120></span>  
<span class="lineno" id=line121></span>      <span class="comment">//println$ "[flx] Toolchain set to " + toolchain_name;</span>
<span class="lineno" id=line122></span>  
<span class="lineno" id=line123></span>      <span class="small_keyword" title="conditional">if</span> control*.INREGEX != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line124></span>  
<span class="lineno" id=line125></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line126></span>          <span class="comment">//control.USER_ARGS &lt;- Shell::quote_arg(loopctl*.progname) + ' ' + control*.USER_ARGS;</span>
<span class="lineno" id=line127></span>          <span class="comment">// this is a hack because -- argument translates to empty program name ..</span>
<span class="lineno" id=line128></span>          <span class="comment">// and also if there is no name in that slot ..</span>
<span class="lineno" id=line129></span>          <span class="small_keyword" title="conditional">if</span> loopctl*.progname != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line130></span>            control.USER_ARGS &lt;- loopctl*.progname ! control*.USER_ARGS;
<span class="lineno" id=line131></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line132></span>          <span class="small_keyword" title="conditional">if</span> control*.INDIR == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> control.INDIR &lt;- <span class="fstring">"."</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line133></span>          <span class="big_keyword" title="Define a mutable variable">var</span> regex = RE2 control*.INREGEX;
<span class="lineno" id=line134></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> regex.ok <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line135></span>            eprintln$ <span class="fstring">"Malformed regex "</span> + control*.INREGEX;
<span class="lineno" id=line136></span>            <span class="small_keyword" title="value of function return used in post condition">result</span> = 1;
<span class="lineno" id=line137></span>            <span class="small_keyword" title="jump to label">goto</span> endoff;
<span class="lineno" id=line138></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line139></span>          <span class="big_keyword" title="Define a mutable variable">var</span> files = FileSystem::regfilesin (control*.INDIR, regex);
<span class="lineno" id=line140></span>          <span class="big_keyword" title="Define a mutable variable">var</span> n = files.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line141></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Processing "</span> + files.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="Convert a value to a string">str</span> + <span class="fstring">" files"</span>;
<span class="lineno" id=line142></span>          <span class="big_keyword" title="Define a mutable variable">var</span> i = 1;
<span class="lineno" id=line143></span>          <span class="big_keyword" title="Define a mutable variable">var</span> pass = 0;
<span class="lineno" id=line144></span>          <span class="big_keyword" title="Define a mutable variable">var</span> fail = 0;
<span class="lineno" id=line145></span>          files = sort files;
<span class="lineno" id=line146></span>          <span class="big_keyword" title="Define a mutable variable">var</span> save_extra_cxx = control*.cpps;
<span class="lineno" id=line147></span>          <span class="small_keyword" title="for loop">for</span> file <span class="small_keyword" title="membership operator, function mem">in</span> files <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line148></span>            <span class="big_keyword" title="Define a mutable variable">var</span> arg = Filename::join (control*.INDIR, file);
<span class="lineno" id=line149></span>            <span class="big_keyword" title="Define a mutable variable">var</span> path,ext = Filename::split_extension(arg);
<span class="lineno" id=line150></span>            loopctl.path &lt;- path;
<span class="lineno" id=line151></span>            loopctl.ext &lt;- ext;
<span class="lineno" id=line152></span>            <span class="big_keyword" title="Define a mutable variable">var</span> dir,base = Filename::split1(loopctl*.path);
<span class="lineno" id=line153></span>            loopctl.dir &lt;- dir;
<span class="lineno" id=line154></span>            loopctl.base &lt;- base;
<span class="lineno" id=line155></span>            <span class="comment">// temporary hack, to force reset of the linker filename, stdout, and expect</span>
<span class="lineno" id=line156></span>            <span class="comment">// file names in cal_depvars so they depend on the current file.</span>
<span class="lineno" id=line157></span>            control.cpps &lt;- save_extra_cxx; <span class="comment">// because in C++ batch mode there's no main so we have to tack it on here</span>
<span class="lineno" id=line158></span>            <span class="small_keyword" title="conditional">if</span> control*.CXXONLY == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line159></span>              control.cpps &lt;- control*.cpps + file;
<span class="lineno" id=line160></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"[flx] --c++ set cpps = "</span> + control*.cpps._strr;
<span class="lineno" id=line161></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line162></span>            control.LINKER_OUTPUT_FILENAME &lt;- <span class="fstring">""</span>;
<span class="lineno" id=line163></span>            control.STDOUT &lt;- <span class="fstring">""</span>;
<span class="lineno" id=line164></span>            control.EXPECT &lt;- <span class="fstring">""</span>;
<span class="lineno" id=line165></span>            control.STDIN &lt;- <span class="fstring">""</span>;
<span class="lineno" id=line166></span>            <span class="big_keyword" title="Define a mutable variable">var</span> dvars = FlxDepvars::cal_depvars(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,control,*loopctl);
<span class="lineno" id=line167></span>            <span class="small_keyword" title="conditional">if</span> control*.FANCYLOG == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line168></span>              <span class="library" title="Print a string to standard output">print</span>$ f<span class="fstring">"Processing [%02d/%02d]: %S\r"</span> (i, n, (file+<span class="fstring">" "</span>*40).(0..40));
<span class="lineno" id=line169></span>              fflush stdout;
<span class="lineno" id=line170></span>            <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line171></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Processing [%02d/%02d]: %S"</span> (i, n, file);
<span class="lineno" id=line172></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line173></span>            <span class="big_keyword" title="Define a mutable variable">var</span> pe = processing_env(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,*control,dvars);
<span class="lineno" id=line174></span>            call_with_trap {
<span class="lineno" id=line175></span>              <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ehandler() {
<span class="lineno" id=line176></span>                eprintln(<span class="fstring">"BATCH MODE ERROR HANDLER"</span>);
<span class="lineno" id=line177></span>                <span class="small_keyword" title="value of function return used in post condition">result</span> = 1;
<span class="lineno" id=line178></span>                <span class="small_keyword" title="jump to label">goto</span> err;
<span class="lineno" id=line179></span>               }
<span class="lineno" id=line180></span>               <span class="small_keyword" title="value of function return used in post condition">result</span> = pe.runit(ehandler);
<span class="lineno" id=line181></span>             err:&gt;
<span class="lineno" id=line182></span>            };
<span class="lineno" id=line183></span>            <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> == 0 <span class="small_keyword" title="imperative code begins">do</span> ++pass; <span class="small_keyword" title="conditional">else</span> ++fail; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line184></span>            <span class="small_keyword" title="conditional">if</span> control*.NONSTOP==0 <span class="small_keyword" title="logical conjunction">and</span>  <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="jump to label">goto</span> endoff;
<span class="lineno" id=line185></span>            ++i;
<span class="lineno" id=line186></span>            collect();
<span class="lineno" id=line187></span>          <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line188></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Batch result (%02d OK + %02d FAIL)/%2d"</span> (pass, fail,n);
<span class="lineno" id=line189></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line190></span>      <span class="small_keyword" title="conditional">elif</span> control*.REPL_MODE <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line191></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line192></span>          again:&gt;
<span class="lineno" id=line193></span>          repl();
<span class="lineno" id=line194></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> feof (stdin) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line195></span>            <span class="big_keyword" title="Define a mutable variable">var</span> dvars = FlxDepvars::cal_depvars(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,control, *loopctl);
<span class="lineno" id=line196></span>            <span class="big_keyword" title="Define a mutable variable">var</span> pe = processing_env(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,*control,dvars);
<span class="lineno" id=line197></span>            <span class="small_keyword" title="value of function return used in post condition">result</span> = pe.runit(ehandler);
<span class="lineno" id=line198></span>            <span class="small_keyword" title="jump to label">goto</span> again;
<span class="lineno" id=line199></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line200></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Bye!"</span>;
<span class="lineno" id=line201></span>            <span class="comment">// TOP LEVEL REPL, OK</span>
<span class="lineno" id=line202></span>            System::exit 0;
<span class="lineno" id=line203></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line204></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line205></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line206></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line207></span>          <span class="small_keyword" title="conditional">if</span> control*.SHOWCODE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line208></span>              <span class="big_keyword" title="Define a mutable variable">var</span> prg = 
<span class="lineno" id=line209></span>                (<span class="small_keyword" title="conditional">if</span> dvars.use_ext == <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">"// No file "</span>+dvars.filebase+<span class="fstring">".(flx|fdoc) found"</span>
<span class="lineno" id=line210></span>                <span class="small_keyword" title="conditional">else</span> load(dvars.filebase+<span class="fstring">"."</span>+dvars.use_ext)
<span class="lineno" id=line211></span>              );
<span class="lineno" id=line212></span>              <span class="library" title="Print a string to standard output">print</span> prg;
<span class="lineno" id=line213></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line214></span>          <span class="big_keyword" title="Define a mutable variable">var</span> dvars = FlxDepvars::cal_depvars(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,control, *loopctl);
<span class="lineno" id=line215></span>          <span class="big_keyword" title="Define a mutable variable">var</span> pe = processing_env(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,*control,dvars);
<span class="lineno" id=line216></span>          <span class="small_keyword" title="value of function return used in post condition">result</span> = pe.runit(ehandler);
<span class="lineno" id=line217></span>        <span class="small_keyword" title="end of extension">end</span> 
<span class="lineno" id=line218></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line219></span>  endoff:&gt;
<span class="lineno" id=line220></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line221></span>    }
<span class="lineno" id=line222></span>  
<span class="lineno" id=line223></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> runflx(args:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line224></span>    {
<span class="lineno" id=line225></span>      <span class="big_keyword" title="Define a mutable variable">var</span> config = #Config::std_config;
<span class="lineno" id=line226></span>      <span class="big_keyword" title="Define a mutable variable">var</span> control = #FlxControl::dflt_control;
<span class="lineno" id=line227></span>      <span class="big_keyword" title="Define a mutable variable">var</span> loopctl = #FlxControl::init_loopctl;
<span class="lineno" id=line228></span>      <span class="small_keyword" title="return">return</span> flx_processing(&amp;config, &amp;control, &amp;loopctl, args);
<span class="lineno" id=line229></span>    }
<span class="lineno" id=line230></span>  }
<span class="lineno" id=line231></span>  
</pre></p></div><h2 id='Bootflx_h'><img src='/share/src/web/images/minus.gif' id='Bootflx' onclick='toggle(this,"Bootflx_d")' alt='+'/> 1.7 Bootflx</h2><div id='Bootflx_d' style='display:block'>
<p>This is supposed to be the same as the standard <code>flx</code>
tool, except it includes all the required source code
which means it takes a very long time to compile.
</p><pre class='inclusion'>
share/lib/std/felix/flx/bootflx.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/config"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_cache"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_pkg"</span>;
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_flxg"</span>;
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_cxx"</span>;
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_control"</span>;
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_cmdopt"</span>;
<span class="lineno" id=line10></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_depvars"</span>;
<span class="lineno" id=line11></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_run"</span>;
<span class="lineno" id=line12></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_config"</span>;
<span class="lineno" id=line13></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_interface"</span>;
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>  
<span class="lineno" id=line16></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain/clang_macosx"</span>;
<span class="lineno" id=line17></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain/clang_iOS_generic"</span>;
<span class="lineno" id=line18></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain/clang_linux"</span>;
<span class="lineno" id=line19></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain/gcc_macosx"</span>;
<span class="lineno" id=line20></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain/gcc_linux"</span>;
<span class="lineno" id=line21></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain/msvc_win"</span>;
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>  <span class="big_keyword" title="Open a module or class">open</span> FlxCache;
<span class="lineno" id=line25></span>  
<span class="lineno" id=line26></span>  <span class="comment">// Felix version of THIS program (NOT the one being installed</span>
<span class="lineno" id=line27></span>  <span class="comment">// if you're using flx to install Felix)</span>
<span class="lineno" id=line28></span>  
<span class="lineno" id=line29></span>  
<span class="lineno" id=line30></span>  <span class="big_keyword" title="Define a type class">class</span> BootFlx
<span class="lineno" id=line31></span>  {
<span class="lineno" id=line32></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> flx_processing
<span class="lineno" id=line33></span>    (
<span class="lineno" id=line34></span>      config:&amp;Config::config_type, 
<span class="lineno" id=line35></span>      control:&amp;FlxControl::control_type,
<span class="lineno" id=line36></span>      loopctl:&amp;FlxControl::loopctl_type,
<span class="lineno" id=line37></span>      args:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line38></span>    ) : <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line39></span>    {
<span class="lineno" id=line40></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = 0;
<span class="lineno" id=line41></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (a:<span class="library" title="binding of C++ string type">string</span>, b:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (a,b);
<span class="lineno" id=line42></span>      FlxCmdOpt::processing_stage1 (config,control,loopctl,<span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[<span class="library" title="binding of C++ string type">string</span>] args);
<span class="lineno" id=line43></span>      <span class="small_keyword" title="conditional">if</span> control*.VALIDATE_CACHE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line44></span>        check_cache(config, control);
<span class="lineno" id=line45></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line46></span>  
<span class="lineno" id=line47></span>      <span class="small_keyword" title="conditional">if</span> loopctl*.base == <span class="fstring">""</span> <span class="small_keyword" title="logical conjunction">and</span> control*.INREGEX == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line48></span>        <span class="small_keyword" title="conditional">if</span> control*.CLEAR_CACHE != 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line49></span>          <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"usage: flx [options] filename"</span>;
<span class="lineno" id=line50></span>          <span class="comment">// TOP LEVEL FLX, OK</span>
<span class="lineno" id=line51></span>          System::exit(1);
<span class="lineno" id=line52></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line53></span>        <span class="comment">// TOP LEVEL FLX, OK</span>
<span class="lineno" id=line54></span>        System::exit(0);
<span class="lineno" id=line55></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line56></span>  
<span class="lineno" id=line57></span>      <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ehandler () {
<span class="lineno" id=line58></span>        eprintln$ <span class="fstring">"BOOTFLX: Flx_pkgconfig getpkgfiled1 failed, temporary ehandler invoked"</span>;
<span class="lineno" id=line59></span>        System::exit 1;
<span class="lineno" id=line60></span>      }
<span class="lineno" id=line61></span>      <span class="big_keyword" title="Define a mutable variable">var</span> dbdir = config*.FLX_TARGET_DIR / <span class="fstring">"config"</span>;
<span class="lineno" id=line62></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgconfig = FlxPkgConfig::FlxPkgConfigQuery$ <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] dbdir;
<span class="lineno" id=line63></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_name = 
<span class="lineno" id=line64></span>        <span class="comment">// toolchain pkg 2</span>
<span class="lineno" id=line65></span>        <span class="small_keyword" title="conditional">if</span> control*.FLX_TOOLCHAIN == <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> pkgconfig.getpkgfield1 ehandler (<span class="fstring">"toolchain"</span>, <span class="fstring">"toolchain"</span>)
<span class="lineno" id=line66></span>        <span class="small_keyword" title="conditional">else</span> control*.FLX_TOOLCHAIN
<span class="lineno" id=line67></span>      ;
<span class="lineno" id=line68></span>  
<span class="lineno" id=line69></span>      <span class="big_keyword" title="Define a mutable variable">var</span> c_compiler_executable = <span class="fstring">""</span>;
<span class="lineno" id=line70></span>      c_compiler_executable =  
<span class="lineno" id=line71></span>        pkgconfig.getpkgfielddflt ehandler (toolchain_name+<span class="fstring">"_c_compiler_executable"</span>, <span class="fstring">"compiler"</span>)
<span class="lineno" id=line72></span>      ;
<span class="lineno" id=line73></span>  
<span class="lineno" id=line74></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cxx_compiler_executable = <span class="fstring">""</span>;
<span class="lineno" id=line75></span>      cxx_compiler_executable = 
<span class="lineno" id=line76></span>        pkgconfig.getpkgfielddflt ehandler (toolchain_name+<span class="fstring">"_cxx_compiler_executable"</span>, <span class="fstring">"compiler"</span>)
<span class="lineno" id=line77></span>      ;
<span class="lineno" id=line78></span>  
<span class="lineno" id=line79></span>  
<span class="lineno" id=line80></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_maker =
<span class="lineno" id=line81></span>         <span class="small_keyword" title="match statement or expression">match</span> toolchain_name <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line82></span>        
<span class="lineno" id=line83></span>         | <span class="fstring">"toolchain_clang_macosx"</span> =&gt; toolchain_clang_macosx 
<span class="lineno" id=line84></span>         <span class="comment">// not required in bootstrap, but the ONLY way to check for type errors ..</span>
<span class="lineno" id=line85></span>         | <span class="fstring">"toolchain_iphoneos"</span> =&gt; toolchain_clang_apple_iPhoneOS_armv7_arm64 
<span class="lineno" id=line86></span>         | <span class="fstring">"toolchain_iphonesimulator"</span> =&gt; toolchain_clang_apple_iPhoneSimulator
<span class="lineno" id=line87></span>  
<span class="lineno" id=line88></span>         | <span class="fstring">"toolchain_clang_linux"</span> =&gt; toolchain_clang_linux
<span class="lineno" id=line89></span>         | <span class="fstring">"toolchain_gcc_macosx"</span> =&gt; toolchain_gcc_macosx
<span class="lineno" id=line90></span>         | <span class="fstring">"toolchain_gcc_linux"</span> =&gt; toolchain_gcc_linux
<span class="lineno" id=line91></span>         | <span class="fstring">"toolchain_msvc_win"</span> =&gt; toolchain_msvc_win
<span class="lineno" id=line92></span>         | x =&gt; 
<span class="lineno" id=line93></span>           Dynlink::load-plugin-func1 [toolchain_t,toolchain_config_t] ( dll-name=x, setup-str=<span class="fstring">""</span>)
<span class="lineno" id=line94></span>         <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line95></span>      ;
<span class="lineno" id=line96></span>      <span class="small_keyword" title="conditional">if</span> control*.INREGEX != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line97></span>  
<span class="lineno" id=line98></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line99></span>          control.USER_ARGS &lt;- Shell::quote_arg(loopctl*.progname) + <span class="fstring">' '</span> + control*.USER_ARGS;
<span class="lineno" id=line100></span>          <span class="small_keyword" title="conditional">if</span> control*.INDIR == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> control.INDIR &lt;- <span class="fstring">"."</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line101></span>          <span class="big_keyword" title="Define a mutable variable">var</span> regex = RE2 control*.INREGEX;
<span class="lineno" id=line102></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> regex.ok <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line103></span>            eprintln$ <span class="fstring">"Malformed regex "</span> + control*.INREGEX;
<span class="lineno" id=line104></span>            <span class="small_keyword" title="value of function return used in post condition">result</span> = 1;
<span class="lineno" id=line105></span>            <span class="small_keyword" title="jump to label">goto</span> endoff;
<span class="lineno" id=line106></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line107></span>          <span class="big_keyword" title="Define a mutable variable">var</span> files = FileSystem::regfilesin (control*.INDIR, regex);
<span class="lineno" id=line108></span>          <span class="big_keyword" title="Define a mutable variable">var</span> n = files.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line109></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Processing "</span> + files.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="Convert a value to a string">str</span> + <span class="fstring">" files"</span>;
<span class="lineno" id=line110></span>          <span class="big_keyword" title="Define a mutable variable">var</span> i = 1;
<span class="lineno" id=line111></span>          <span class="big_keyword" title="Define a mutable variable">var</span> save_extra_cxx = control*.cpps;
<span class="lineno" id=line112></span>          <span class="small_keyword" title="for loop">for</span> file <span class="small_keyword" title="membership operator, function mem">in</span> files <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line113></span>            <span class="big_keyword" title="Define a mutable variable">var</span> arg = Filename::join (control*.INDIR, file);
<span class="lineno" id=line114></span>            <span class="big_keyword" title="Define a mutable variable">var</span> path,ext = Filename::split_extension(arg);
<span class="lineno" id=line115></span>            loopctl.path &lt;- path;
<span class="lineno" id=line116></span>            loopctl.ext &lt;- ext;
<span class="lineno" id=line117></span>            <span class="big_keyword" title="Define a mutable variable">var</span> dir,base = Filename::split1(loopctl*.path);
<span class="lineno" id=line118></span>            loopctl.dir &lt;- dir;
<span class="lineno" id=line119></span>            loopctl.base &lt;- base;
<span class="lineno" id=line120></span>            <span class="comment">// temporary hack, to force reset of the linker filename, stdout, and expect</span>
<span class="lineno" id=line121></span>            <span class="comment">// file names in cal_depvars so they depend on the current file.</span>
<span class="lineno" id=line122></span>            control.LINKER_OUTPUT_FILENAME &lt;- <span class="fstring">""</span>;
<span class="lineno" id=line123></span>            control.STDOUT &lt;- <span class="fstring">""</span>;
<span class="lineno" id=line124></span>            control.EXPECT &lt;- <span class="fstring">""</span>;
<span class="lineno" id=line125></span>            control.cpps &lt;- save_extra_cxx; <span class="comment">// because in C++ batch mode there's no main so we have to tack it on here</span>
<span class="lineno" id=line126></span>            <span class="small_keyword" title="conditional">if</span> control*.CXXONLY == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line127></span>              control.cpps &lt;- control*.cpps + file;
<span class="lineno" id=line128></span>              <span class="comment">//`println$ "[flx] --c++ set cpps = " + control*.cpps._strr;</span>
<span class="lineno" id=line129></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line130></span>            <span class="big_keyword" title="Define a mutable variable">var</span> dvars = FlxDepvars::cal_depvars(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,control,*loopctl);
<span class="lineno" id=line131></span>            <span class="small_keyword" title="conditional">if</span> control*.FANCYLOG == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line132></span>              <span class="library" title="Print a string to standard output">print</span>$ f<span class="fstring">"Processing [%02d/%02d]: %S\r"</span> (i, n, (file+<span class="fstring">" "</span>*40).(0..40));
<span class="lineno" id=line133></span>              fflush stdout;
<span class="lineno" id=line134></span>            <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line135></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Processing [%02d/%02d]: %S"</span> (i, n, file);
<span class="lineno" id=line136></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line137></span>            <span class="big_keyword" title="Define a mutable variable">var</span> pe = processing_env(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,*control,dvars);
<span class="lineno" id=line138></span>            <span class="small_keyword" title="value of function return used in post condition">result</span> = pe.runit(ehandler);
<span class="lineno" id=line139></span>            <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="jump to label">goto</span> endoff;
<span class="lineno" id=line140></span>            ++i;
<span class="lineno" id=line141></span>          <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line142></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line143></span>      <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line144></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line145></span>          <span class="small_keyword" title="conditional">if</span> control*.SHOWCODE == 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line146></span>              <span class="big_keyword" title="Define a mutable variable">var</span> prg = 
<span class="lineno" id=line147></span>                (<span class="small_keyword" title="conditional">if</span> dvars.use_ext == <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">"// No file "</span>+dvars.filebase+<span class="fstring">".(flx|fdoc) found"</span>
<span class="lineno" id=line148></span>                <span class="small_keyword" title="conditional">else</span> load(dvars.filebase+<span class="fstring">"."</span>+dvars.use_ext)
<span class="lineno" id=line149></span>              );
<span class="lineno" id=line150></span>              <span class="library" title="Print a string to standard output">print</span> prg;
<span class="lineno" id=line151></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line152></span>          <span class="big_keyword" title="Define a mutable variable">var</span> dvars = FlxDepvars::cal_depvars(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,control, *loopctl);
<span class="lineno" id=line153></span>          <span class="big_keyword" title="Define a mutable variable">var</span> pe = processing_env(toolchain_maker,c_compiler_executable, cxx_compiler_executable, *config,*control,dvars);
<span class="lineno" id=line154></span>          <span class="small_keyword" title="value of function return used in post condition">result</span> = pe.runit(ehandler);
<span class="lineno" id=line155></span>        <span class="small_keyword" title="end of extension">end</span> 
<span class="lineno" id=line156></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line157></span>  endoff:&gt;
<span class="lineno" id=line158></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line159></span>    }
<span class="lineno" id=line160></span>  
<span class="lineno" id=line161></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> runflx(args:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line162></span>    {
<span class="lineno" id=line163></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"[bootflx] "</span> + strcat <span class="fstring">" "</span> args;
<span class="lineno" id=line164></span>      <span class="big_keyword" title="Define a mutable variable">var</span> config = #Config::std_config;
<span class="lineno" id=line165></span>      <span class="big_keyword" title="Define a mutable variable">var</span> control = #FlxControl::dflt_control;
<span class="lineno" id=line166></span>      <span class="big_keyword" title="Define a mutable variable">var</span> loopctl = #FlxControl::init_loopctl;
<span class="lineno" id=line167></span>      <span class="small_keyword" title="return">return</span> flx_processing(&amp;config, &amp;control, &amp;loopctl, args);
<span class="lineno" id=line168></span>    }
<span class="lineno" id=line169></span>  }
<span class="lineno" id=line170></span>  
</pre></p></div><h2 id='Plugin_Client._h'><img src='/share/src/web/images/minus.gif' id='Plugin Client.' onclick='toggle(this,"Plugin_Client._d")' alt='+'/> 1.8 Plugin Client.</h2><div id='Plugin_Client._d' style='display:block'>
<p>Flx is also available as a plugin. This wrapper loads
it on demand so it is easy to call flx from any Felix
program.
</p><pre class='inclusion'>
share/lib/std/felix/flx/flx_plugin_client.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> Flx_client {
<span class="lineno" id=line2></span>    <span class="big_keyword" title="Define a mutable variable">var</span> runflx : <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] -&gt; <span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> setup ()
<span class="lineno" id=line4></span>    {
<span class="lineno" id=line5></span>      runflx = Dynlink::load-plugin-func1 [<span class="library" title="binding of C int type">int</span>,<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]] ( dll-name=<span class="fstring">"flx_plugin"</span>, setup-str=<span class="fstring">""</span>);
<span class="lineno" id=line6></span>    }
<span class="lineno" id=line7></span>  }
</pre></p></div><h2 id='Bootstrap_Felix._h'><img src='/share/src/web/images/minus.gif' id='Bootstrap Felix.' onclick='toggle(this,"Bootstrap_Felix._d")' alt='+'/> 1.9 Bootstrap Felix.</h2><div id='Bootstrap_Felix._d' style='display:block'>
<p>The same as the ordinary <code>flx</code> command, except the standard
toolchains are compiled in directly.
</p><pre class='inclusion'>
$PWD/src/tools/bootflx.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/bootflx"</span>;
<span class="lineno" id=line2></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"BOOTFLX"</span>;
<span class="lineno" id=line3></span>  System::pexit$ BootFlx::runflx #System::args;
<span class="lineno" id=line4></span>  
</pre></p></div></div><!--Main Content Body End-->

          </div> <!-- rightpanel contents end -->
          <hr>
        </span> <!-- rightpanel end -->

        <span id="panemover" style="cursor:col-resize;"
         onmousedown="dragStart(event, 'left', 'right'); return false;"
         onmousemove="drag(event, 'left', 'right');"
         onmouseout="dragRelease();"
         onmouseup="dragRelease();"
        >
        </span> <!-- panemover end -->
      </div> <!-- bottom panel end -->
    </div> <!-- container end -->
</body></html>

