<html><head>
<style type="text/css">
body {margin:3%; }
h1 {color:gray; font-size:120%;}
h2 {color:gray; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre.flxbg {background-color:#A0FFA0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.uncheckedflxbg {background-color:#D0D0D0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.cppbg {background-color:#80FF80; color:black; }
pre.prefmtbg {background-color:#D0D0D0; color:black; }
pre.expected {background-color:#E0FF80; color:black; }
pre.input {background-color:#E08080; color:black; }
pre.inclusion {background-color:#D070D0; color:black; }
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:#FF8080; color:black; }
</style>
<title>Http Server Support</title></head><body>
<style>
body {margin:3%; font-family: sans-serif; }
h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
h2 {color:#202020; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
pre.cppbg {background-color:#C2FDC2; }
pre.prefmtbg {background-color:#F1F1F1; }
pre.expected {background-color:hsla(74,94%,88%,1); }
pre.input {background-color:hsla(20,94%,88%,1); }
pre.inclusion {
    font-family: Arial;
    font-weight: normal;
    font-size: 0.9em;
    color: #555;
    border: none;
    box-shadow: none;
    text-align: right;
    margin: -7px 11px -12px 0;
    padding: 0;
    background-color:#fafafa;
}
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
.container {
  position: fixed;
  top:0px;
  left:0px;
  height : 100%;
  width: 100%;
  background-color: grey;
  margin: 0px;
  padding: 0px;
  border-width: 0px;
  color: #404040;
}
.maincontent {
  padding:4px;
  padding-left:8px;
  line-height:1.3em;
  color:#404040; background-color:#fafafa;
}
.maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
.maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent code { color:#902030; }
.toppanel {
  position:absolute; left:0px; top:0px; height:20px; right:0px;
  background-color: #e0e0e0;
}
.bottompanel {
  position:absolute; left:0px; top:22px; bottom:0px; right:0px;
  background-color: #fafafa;
  font-size:14px;
}
.leftpanel {
  position:absolute; left:0px; top:0px; bottom:0px; width: 150px;
  background-color: #eaeaea; overflow: auto;
}
.rightpanel {
  position:absolute; right: 0px; left:160px; top:0px; bottom: 0px;
  background-color: #fafafa; overflow: auto;
}
.divider {
  position:absolute; left: 150px; top:0px; bottom:0px;
  background-color: black; width:2px;
  box-shadow: 0 0 8px #000;
}

#panemover {
    position:absolute;
    left: 150px;
    width : 10px;
    top: 0px;
    bottom: 0px;
    opacity: 0.3;
    cursor:col-resize;
}

div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}
</style>

<style>
div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}


</style>

    <script async="true">
      function dragStart(e, left, right){
        document.getElementById("panemover").style.width="70%";
        document.getElementById("panemover").style.left="50px";
        mousedown = true;
        x = e.clientX
        dragOffsetLeft =
          document.getElementById(left).getBoundingClientRect().right -
          document.getElementById(left).getBoundingClientRect().left -
          x
        ;
        dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x;
        dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
      }
      function dragRelease(){
        document.getElementById('panemover').style.width = '10px';
        document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
        mousedown = false;
      }
      function drag(e, left, right){
        if(!mousedown){return}
        x = e.clientX
        tmpLeft = dragOffsetLeft + x
        tmpDivider= dragOffsetDivider + x
        tmpRight = dragOffsetRight + x
        document.getElementById(left).style.width= tmpLeft + 'px';
        document.getElementById("divider").style.left= tmpDivider + 'px';
        document.getElementById(right).style.left = tmpRight + 'px';
      };
    </script>

<script type="text/javascript">

  function mexpand(id)
  {
    var n = document.getElementById(id).style;
    n.display = "block";
  }

  function mcollapse(id)
  {
    var n = document.getElementById(id).style;
    n.display = "none";
  }

  var counter_max = 0;
  function mshow(id,loc)
  {
    var i;
    for(i=1; i<=counter_max; ++i)
      mcollapse("menu"+String(i));
    mexpand(id);
    window.location.replace(loc);
  }
</script>

<script type="text/javascript">

function expand(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/minus.gif";
  button.alt = "-";
  n.display = "block";
}
function collapse(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/plus.gif";
  button.alt = "+";
  n.display = "none";
}
function toggle(button,id)
{
  var n = document.getElementById(id).style;
  if (n.display == "none")
  {
    button.src = "/share/src/web/images/minus.gif";
    button.alt = "-";
    n.display = "block";
  }
  else
  {
    button.src = "/share/src/web/images/plus.gif";
    button.alt = "+";
    n.display = "none";
  }
}
var allbuttons = [
"Web Server Support Library"
];
function expand_all(dummy)
{
  for (i in allbuttons)
  {
    expand(allbuttons[i], allbuttons[i]+"_d");
  }
}
function collapse_all(dummy)
{
  for (i in allbuttons)
  {
    collapse(allbuttons[i], allbuttons[i]+"_d");
  }
}
</script>

<script>
function mouseover(id)
{
  var elt = document.getElementById(id);
  elt.style.display="none";
  var elt2 = document.getElementById(id+"_mo");
  elt2.style.display="inline";
}

function mouseout(id)
{
  var elt = document.getElementById(id+"_mo");
  elt.style.display="none";
  var elt2 = document.getElementById(id);
  elt2.style.display="inline";
}

</script>
<script> function nop(dummy) {} </script>
    <div class="container">
      <div class="toppanel">
    <!--Main Content top navbar-->
<span style="position:relative; bottom:6px"
  onmouseover="mouseover('expand')"
  onmouseout="mouseout('expand')"
  onclick="expand_all('expand')"
  ><span id="expand"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span><span id="expand_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span></span><span style="position:relative; bottom:6px"
  onmouseover="mouseover('collapse')"
  onmouseout="mouseout('collapse')"
  onclick="collapse_all('collapse')"
  ><span id="collapse"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span><span id="collapse_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span></span>    <!--Main Content top navbar End-->

      </div> <!-- toppanel end -->
      <div class="bottompanel">
        <span id="divider" class="divider"></span>

        <span id="left" class="leftpanel" >
          <div class="menucontent">
  <!--Left Margin Toc-->
  <div id="leftmargintoc">
    <!--Left Margin Toc Main Contents-->
      <div class=m1 onclick="mshow('menu1','#Web Server Support Library_h')"> <a href="#Web_Server_Support_Library_h">Web Server Support Library</a></div>
      <div class=sm id=menu1>
      </div>
    <script>counter_max=1;</script>
  </div>
  <!--End Left Margin Toc-->

          </div> <!-- leftpanel contents end -->
        </span> <!-- leftpanel end -->

        <span id="right" class="rightpanel">
          <div class="maincontent">
<!--Main Content Body-->
<h1 id='Web_Server_Support_Library_h'><img src='/share/src/web/images/minus.gif' id='Web Server Support Library' onclick='toggle(this,"Web_Server_Support_Library_d")' alt='+'/> 1 Web Server Support Library</h1><div id='Web_Server_Support_Library_d' style='display:block'>
<pre class='inclusion'>
share/lib/web/__init__.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// codecs</span>
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/json"</span>;                    
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/mime_type"</span>;
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>  <span class="comment">// http protocol handlers</span>
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/web_util"</span>; 
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/http_handler"</span>;            
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/http_connection"</span>;         
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/http_request"</span>;            
<span class="lineno" id=line10></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/http_status_code"</span>;        
<span class="lineno" id=line11></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/http_response"</span>;           
<span class="lineno" id=line12></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/http_auth"</span>;               
<span class="lineno" id=line13></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/cookie"</span>;                  
<span class="lineno" id=line14></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/low_res_time"</span>;
<span class="lineno" id=line15></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/server_config"</span>;
<span class="lineno" id=line16></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/sundown"</span>;
<span class="lineno" id=line17></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/logger"</span>;
<span class="lineno" id=line18></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/simple_config"</span>;
</pre></p><pre class='inclusion'>
share/lib/web/web_util.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> WebUtil {
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_attribute_list(lst:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]):<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>^2] =&gt;
<span class="lineno" id=line4></span>      <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="small_keyword" title="match statement or expression">match</span> split_first(s,<span class="fstring">"="</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line5></span>                               |Some (i,j) =&gt; (strip i),(strip j)
<span class="lineno" id=line6></span>                               |_       =&gt; <span class="fstring">""</span>,<span class="fstring">""</span>
<span class="lineno" id=line7></span>                             <span class="small_keyword" title="end a match statement or expression">endmatch</span> ) lst;
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  
<span class="lineno" id=line10></span>    
<span class="lineno" id=line11></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/http_auth.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/__init__"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  publish <span class="fstring">""" Implements Basic HTTP Authentication
<span class="lineno" id=line4></span>  """</span>
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Define a type class">class</span> HTTPBasicAuth {
<span class="lineno" id=line6></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPConnection;
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPRequest;
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Open a module or class">open</span> Assoc_list;
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPResponse;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Open a module or class">open</span> Base64;
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Open a module or class">open</span> ServerConfig;
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPHandler;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>    publish <span class="fstring">"""
<span class="lineno" id=line15></span>    A default app_handler for implementing Basic Auth. You must supply a function that 
<span class="lineno" id=line16></span>    takes a user name and password and returns fru or fals if authenticated. You must
<span class="lineno" id=line17></span>    also supply a realm string which appears in the Authentication Prompt of the browser.
<span class="lineno" id=line18></span>    This app_handler uses a route that applies to all pages
<span class="lineno" id=line19></span>    """</span>
<span class="lineno" id=line20></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> app_handlers(auth_source:(<span class="library" title="binding of C++ string type">string</span>*string-&gt;bool),realm:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line21></span>      (Cons (http_handler(http_basic_auth_route,(http_basic_auth(auth_source,realm))),
<span class="lineno" id=line22></span>       Empty[http_handler]));
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>    publish <span class="fstring">"""
<span class="lineno" id=line25></span>    A default route for http auth applies to all pages
<span class="lineno" id=line26></span>    """</span>
<span class="lineno" id=line27></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> http_basic_auth_route(config:server_config,request:http_request) =&gt; 
<span class="lineno" id=line28></span>      <span class="library" title="truth value">true</span>;
<span class="lineno" id=line29></span>  
<span class="lineno" id=line30></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> basic(s:<span class="library" title="binding of C++ string type">string</span>) =&gt;ltrim s <span class="fstring">"Basic "</span>;
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>    publish <span class="fstring">"""
<span class="lineno" id=line33></span>    Handler for http_basic_auth if Authorization header supplied by browser attemps to authenticate against auth source.
<span class="lineno" id=line34></span>    If Authorization header not supplied send WWW-Authenticate header
<span class="lineno" id=line35></span>    """</span>
<span class="lineno" id=line36></span>    
<span class="lineno" id=line37></span>  
<span class="lineno" id=line38></span>    
<span class="lineno" id=line39></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> http_basic_auth (auth_source:(<span class="library" title="binding of C++ string type">string</span>*string-&gt;bool),realm:<span class="library" title="binding of C++ string type">string</span>) (conn:http_connection, request:http_request) =  {
<span class="lineno" id=line40></span>      http_basic_auth (auth_source,realm,<span class="fstring">"Unauthorized"</span>) (conn, request);
<span class="lineno" id=line41></span>  }
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> http_basic_auth (auth_source:(<span class="library" title="binding of C++ string type">string</span>*string-&gt;bool),realm:<span class="library" title="binding of C++ string type">string</span>,unauth_content:<span class="library" title="binding of C++ string type">string</span>) (conn:http_connection, request:http_request) =  {
<span class="lineno" id=line44></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="match statement or expression">match</span> (find (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>)=&gt;x==<span class="fstring">"Authorization"</span>) request.headers) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line45></span>        |Some a =&gt; <span class="small_keyword" title="match statement or expression">match</span> split(decode(basic(a)),<span class="fstring">":"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line46></span>                        |Cons(n,Cons(p,Empty)) =&gt; auth_source(n,p)
<span class="lineno" id=line47></span>                        |_ =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line48></span>                      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line49></span>         |_       =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line50></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line51></span>          set_dirty(conn,<span class="library" title="false value">false</span>);
<span class="lineno" id=line52></span>          <span class="small_keyword" title="return">return</span> ;
<span class="lineno" id=line53></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line54></span>        <span class="big_keyword" title="Define an immutable value">val</span> hdrs:assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>] = Cons ((<span class="fstring">"WWW-Authenticate"</span>,<span class="fstring">"Basic realm=\"</span><span class="fstring">"+realm+"</span>\<span class="fstring">""</span>), Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]);
<span class="lineno" id=line55></span>        <span class="big_keyword" title="Define a mutable variable">var</span> us = make_unauthorized(hdrs,unauth_content);
<span class="lineno" id=line56></span>        <span class="library" title="Print a string to a stream">write</span>(conn,us);  
<span class="lineno" id=line57></span>      <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line58></span>      set_dirty(conn,<span class="library" title="truth value">true</span>);
<span class="lineno" id=line59></span>      <span class="small_keyword" title="return">return</span> ;
<span class="lineno" id=line60></span>    }
<span class="lineno" id=line61></span>  
<span class="lineno" id=line62></span>  publish <span class="fstring">"""Authentication wrapper for a http_handler function, prcesses HTTP Authentication
<span class="lineno" id=line63></span>  and passes control to handler if Authentication succedes otherwise returns Unauthorized response 
<span class="lineno" id=line64></span>  to the browser"""</span>
<span class="lineno" id=line65></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> requires_auth (auth_source:(<span class="library" title="binding of C++ string type">string</span>*string-&gt;bool),realm:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line66></span>                       handler_fn:(http_connection*http_request) -&gt; <span class="library" title="Type with no values, returning void indicates a procedure">void</span>)
<span class="lineno" id=line67></span>                      (conn:http_connection, request:http_request ) = {
<span class="lineno" id=line68></span>      http_basic_auth (auth_source,realm) (conn, request);
<span class="lineno" id=line69></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> *conn.dirty <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line70></span>        handler_fn(conn,request);
<span class="lineno" id=line71></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line72></span>    }
<span class="lineno" id=line73></span>   
<span class="lineno" id=line74></span>     <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> requires_auth (auth_source:(<span class="library" title="binding of C++ string type">string</span>*string-&gt;bool),realm:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line75></span>                       handler_fn:(http_connection*http_request) -&gt; <span class="library" title="Type with no values, returning void indicates a procedure">void</span>,
<span class="lineno" id=line76></span>                       unauthorized_content:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line77></span>                      (conn:http_connection, request:http_request ) = {
<span class="lineno" id=line78></span>      http_basic_auth (auth_source,realm,unauthorized_content) (conn, request);
<span class="lineno" id=line79></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> *conn.dirty <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line80></span>        handler_fn(conn,request);
<span class="lineno" id=line81></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line82></span>    }
<span class="lineno" id=line83></span>  
<span class="lineno" id=line84></span>    
<span class="lineno" id=line85></span>   
<span class="lineno" id=line86></span>  
<span class="lineno" id=line87></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> authorized_user (conn:http_connection, request:http_request) =&gt;
<span class="lineno" id=line88></span>       <span class="small_keyword" title="match statement or expression">match</span> (find (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>)=&gt;x==<span class="fstring">"Authorization"</span>) request.headers) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line89></span>        |Some a =&gt; <span class="small_keyword" title="match statement or expression">match</span> split(decode(basic(a)),<span class="fstring">":"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line90></span>                        |Cons(n,Cons(p,Empty)) =&gt; Some n
<span class="lineno" id=line91></span>                        |_ =&gt; None[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line92></span>                      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line93></span>         |_       =&gt; None[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line94></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span> ;
<span class="lineno" id=line95></span>  
<span class="lineno" id=line96></span>  
<span class="lineno" id=line97></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/http_request.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/__init__"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  publish <span class="fstring">"""
<span class="lineno" id=line4></span>  Defines types and container for http_request.
<span class="lineno" id=line5></span>  Main entry points are get_param (helper to extract params from http_request)
<span class="lineno" id=line6></span>  and get_http_request which extracts request from stream
<span class="lineno" id=line7></span>  """</span>  
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Define a type class">class</span> HTTPRequest {
<span class="lineno" id=line10></span>     <span class="big_keyword" title="Open a module or class">open</span> HTTPConnection;
<span class="lineno" id=line11></span>     <span class="big_keyword" title="Open a module or class">open</span> Assoc_list;   
<span class="lineno" id=line12></span>     <span class="big_keyword" title="Open a module or class">open</span> URICodec;
<span class="lineno" id=line13></span>     <span class="big_keyword" title="Open a module or class">open</span> Logger;
<span class="lineno" id=line14></span>     <span class="big_keyword" title="Open a module or class">open</span> Cookie;
<span class="lineno" id=line15></span>     <span class="big_keyword" title="Open a module or class">open</span> IOStream;
<span class="lineno" id=line16></span>     <span class="big_keyword" title="Open a module or class">open</span> Socket;
<span class="lineno" id=line17></span>     <span class="big_keyword" title="Open a module or class">open</span> TerminalIOByteStream[socket_t];
<span class="lineno" id=line18></span>     <span class="big_keyword" title="Open a module or class">open</span> WebUtil;
<span class="lineno" id=line19></span>   
<span class="lineno" id=line20></span>     variant http_method = 
<span class="lineno" id=line21></span>       | GET
<span class="lineno" id=line22></span>       | POST
<span class="lineno" id=line23></span>       | BAD;
<span class="lineno" id=line24></span>  
<span class="lineno" id=line25></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[http_method] {
<span class="lineno" id=line26></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : http_method -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line27></span>        | #GET =&gt; <span class="fstring">"GET"</span>
<span class="lineno" id=line28></span>        | #POST =&gt; <span class="fstring">"POST"</span>
<span class="lineno" id=line29></span>        | #BAD =&gt; <span class="fstring">"BAD"</span>;
<span class="lineno" id=line30></span>     }
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Eq[http_method] {
<span class="lineno" id=line33></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> == : http_method*http_method-&gt;bool = <span class="fstring">"$1==$2"</span>;
<span class="lineno" id=line34></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> != : http_method*http_method-&gt;bool = <span class="fstring">"$1!=$2"</span>;
<span class="lineno" id=line35></span>    }
<span class="lineno" id=line36></span>    
<span class="lineno" id=line37></span>  
<span class="lineno" id=line38></span>     <span class="big_keyword" title="Define a structure">struct</span> http_request {
<span class="lineno" id=line39></span>      hmethod: http_method;
<span class="lineno" id=line40></span>      uri: <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line41></span>      path:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line42></span>      params:assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line43></span>      entity_params:assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line44></span>      headers:assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>];    
<span class="lineno" id=line45></span>    }
<span class="lineno" id=line46></span>  
<span class="lineno" id=line47></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[http_request] {
<span class="lineno" id=line48></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> (request: http_request) =&gt; 
<span class="lineno" id=line49></span>        <span class="fstring">"HTTP Request\n"</span>+
<span class="lineno" id=line50></span>        <span class="fstring">"\tMethod:"</span>+<span class="library" title="Convert a value to a string">str</span>(request.hmethod)+<span class="fstring">"\n"</span>+
<span class="lineno" id=line51></span>        <span class="comment">//"\tURI:"""+request.uri+"\n"+</span>
<span class="lineno" id=line52></span>        <span class="fstring">"\tPath:"</span><span class="fstring">""</span>+request.path+<span class="fstring">"\n"</span>+
<span class="lineno" id=line53></span>        <span class="fstring">"\tParams:"</span><span class="fstring">""</span>+<span class="library" title="Convert a value to a string">str</span>(request.params)+<span class="fstring">"\n"</span>+
<span class="lineno" id=line54></span>        <span class="fstring">"\tHeaders:"</span><span class="fstring">""</span>+<span class="library" title="Convert a value to a string">str</span>(request.headers)+<span class="fstring">"\n"</span>;
<span class="lineno" id=line55></span>    } 
<span class="lineno" id=line56></span>        
<span class="lineno" id=line57></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> copy_request(orig:&amp;http_request,cpy:&amp;http_request) = {
<span class="lineno" id=line58></span>      cpy.hmethod &lt;- *orig.hmethod;
<span class="lineno" id=line59></span>      cpy.uri &lt;- *orig.uri;
<span class="lineno" id=line60></span>      cpy.path &lt;- *orig.path;
<span class="lineno" id=line61></span>      cpy.params &lt;- *orig.params;
<span class="lineno" id=line62></span>    }
<span class="lineno" id=line63></span>  
<span class="lineno" id=line64></span>    publish <span class="fstring">"""
<span class="lineno" id=line65></span>    Parses a list of URI encoded key value parameters and returns as an assoc_list.
<span class="lineno" id=line66></span>    """</span>
<span class="lineno" id=line67></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_params(p:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>] ={
<span class="lineno" id=line68></span>       <span class="big_keyword" title="Define a mutable variable">var</span> params = split(p,<span class="fstring">'&amp;'</span>);
<span class="lineno" id=line69></span>       <span class="small_keyword" title="return">return</span>   <span class="library" title="return data structure with function applied to each value">map</span>  (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span> =&gt;<span class="small_keyword" title="let binder">let</span> Cons(hd,tl) = split(x,<span class="fstring">'='</span>) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line70></span>                       (uri_decode(hd),uri_decode((<span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>) (y:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> =&gt; x + y) <span class="fstring">""</span> tl)))
<span class="lineno" id=line71></span>                       ) params;
<span class="lineno" id=line72></span>    }
<span class="lineno" id=line73></span>  
<span class="lineno" id=line74></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> get_headers(conn:http_connection,headers:&amp;<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>^2])  {
<span class="lineno" id=line75></span>      <span class="big_keyword" title="Define a mutable variable">var</span> line:<span class="library" title="binding of C++ string type">string</span> = <span class="fstring">""</span>;
<span class="lineno" id=line76></span>      get_line(conn.sock, &amp;line);  <span class="comment">// shouldg be the GET line.</span>
<span class="lineno" id=line77></span>      <span class="small_keyword" title="while loop">while</span> line != <span class="fstring">""</span> <span class="small_keyword" title="logical conjunction">and</span> line != <span class="fstring">"\r"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line78></span>        get_line(conn.sock, &amp;line); 
<span class="lineno" id=line79></span>        <span class="small_keyword" title="match statement or expression">match</span> split(line,<span class="fstring">':'</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line80></span>          | Cons(key,value) =&gt;
<span class="lineno" id=line81></span>                headers &lt;- Cons((uri_decode(strip(key)),   
<span class="lineno" id=line82></span>  	      uri_decode(strip(<span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>) (y:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> =&gt; x + y) <span class="fstring">""</span> value))),
<span class="lineno" id=line83></span>                *headers);
<span class="lineno" id=line84></span>           | x =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>(<span class="fstring">"WARNING:Possible malformed request headerline:"</span>+x); 
<span class="lineno" id=line85></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line86></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line87></span>    }
<span class="lineno" id=line88></span>  
<span class="lineno" id=line89></span>    publish <span class="fstring">""" Main entry point for extracting HTTP request from stream """</span>
<span class="lineno" id=line90></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> get_request(conn:http_connection,request:&amp;http_request) = {
<span class="lineno" id=line91></span>      <span class="big_keyword" title="Define a mutable variable">var</span> k = conn.sock;
<span class="lineno" id=line92></span>      <span class="big_keyword" title="Define a mutable variable">var</span> line: <span class="library" title="binding of C++ string type">string</span> = <span class="fstring">""</span>;
<span class="lineno" id=line93></span>      get_line(k, &amp;line);  <span class="comment">// shouldg be the GET line.</span>
<span class="lineno" id=line94></span>      <span class="big_keyword" title="Define a mutable variable">var</span> got = <span class="small_keyword" title="match statement or expression">match</span> split(line,<span class="fstring">' '</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line95></span>        | Cons (hmethod,Cons(uri,Cons(prot,_))) =&gt; <span class="small_keyword" title="match statement or expression">match</span> (hmethod,uri,prot) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line96></span>          | (<span class="fstring">"GET"</span>,uri,prot)  =&gt; <span class="small_keyword" title="match statement or expression">match</span> (GET,uri,split(uri,<span class="fstring">'?'</span>),prot) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line97></span>            | (GET,uri,Cons(path,rest),prot) =&gt; 
<span class="lineno" id=line98></span>                 http_request(GET,uri,path,
<span class="lineno" id=line99></span>                  get_params((<span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>) (y:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> =&gt; x + y) <span class="fstring">""</span> rest)),
<span class="lineno" id=line100></span>                  Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line101></span>              <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line102></span>          | (<span class="fstring">"POST"</span>,uri,prot)  =&gt; <span class="small_keyword" title="match statement or expression">match</span> (POST,uri,split(uri,<span class="fstring">'?'</span>),prot) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line103></span>            | (POST,uri,Cons(path,rest),prot) =&gt; http_request(POST,uri,path,
<span class="lineno" id=line104></span>                  get_params((<span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>) (y:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> =&gt; x + y) <span class="fstring">""</span> rest)),
<span class="lineno" id=line105></span>                  Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line106></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line107></span>  	  <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line108></span>          | _ =&gt;  http_request(BAD,<span class="fstring">""</span>,<span class="fstring">""</span>,Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line109></span>                               Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line110></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;  
<span class="lineno" id=line111></span>      <span class="big_keyword" title="Define a mutable variable">var</span> headers = Empty[<span class="library" title="binding of C++ string type">string</span>^2];
<span class="lineno" id=line112></span>      get_headers(conn,&amp;headers);
<span class="lineno" id=line113></span>      got&amp;.headers &lt;- headers;
<span class="lineno" id=line114></span>      copy_request(&amp;got,request); 
<span class="lineno" id=line115></span>      request.headers &lt;- headers;
<span class="lineno" id=line116></span>    }
<span class="lineno" id=line117></span>  
<span class="lineno" id=line118></span>  
<span class="lineno" id=line119></span>    
<span class="lineno" id=line120></span>  
<span class="lineno" id=line121></span>    publish <span class="fstring">"""
<span class="lineno" id=line122></span>    Populates entity_params in request. Entity params are URI encoded key value pairs in
<span class="lineno" id=line123></span>    request body that are supplied when a POST request is made by the browser.
<span class="lineno" id=line124></span>    """</span>
<span class="lineno" id=line125></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> get_entity_params(conn:http_connection,request:&amp;http_request,attribs:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>^2]) = {
<span class="lineno" id=line126></span>      <span class="big_keyword" title="Define an immutable value">val</span> olen = <span class="small_keyword" title="match statement or expression">match</span> get_header(*request,<span class="fstring">"Content-Length"</span>) <span class="small_keyword" title="type-class constraint">with</span> |Some s=&gt; <span class="library" title="binding of C int type">int</span>(s) |_ =&gt; 0 <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line127></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="library" title="number of elements in data structure">len</span> = olen;
<span class="lineno" id=line128></span>      <span class="big_keyword" title="Define a mutable variable">var</span> eof=<span class="library" title="false value">false</span>;
<span class="lineno" id=line129></span>      <span class="big_keyword" title="Define a mutable variable">var</span> params:assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>] = Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line130></span>      <span class="small_keyword" title="conditional">if</span> olen &gt; 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line131></span>        <span class="big_keyword" title="Define a mutable variable">var</span> buf = <span class="hack">C_hack</span>::cast[+<span class="library" title="binding of C char type">char</span>] (Memory::malloc(<span class="library" title="number of elements in data structure">len</span>+1));
<span class="lineno" id=line132></span>        <span class="big_keyword" title="Define a mutable variable">var</span> buf_a = <span class="library" title="special binding of C void* type">address</span>(buf);
<span class="lineno" id=line133></span>        read(conn.sock,&amp;<span class="library" title="number of elements in data structure">len</span>,buf_a,&amp;eof);
<span class="lineno" id=line134></span>        <span class="small_keyword" title="conditional">if</span> <span class="library" title="number of elements in data structure">len</span> &gt; 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line135></span>          params = get_params(<span class="library" title="binding of C++ string type">string</span>(buf,<span class="library" title="number of elements in data structure">len</span>));
<span class="lineno" id=line136></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line137></span>        Memory::free(buf_a);
<span class="lineno" id=line138></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line139></span>      request.entity_params &lt;- params;
<span class="lineno" id=line140></span>      <span class="small_keyword" title="return">return</span> ; 
<span class="lineno" id=line141></span>    }
<span class="lineno" id=line142></span>  
<span class="lineno" id=line143></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> read_bytes(conn:http_connection,olen:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line144></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="library" title="number of elements in data structure">len</span> = olen;
<span class="lineno" id=line145></span>      <span class="big_keyword" title="Define a mutable variable">var</span> eof=<span class="library" title="false value">false</span>;
<span class="lineno" id=line146></span>      
<span class="lineno" id=line147></span>      <span class="big_keyword" title="Define a mutable variable">var</span> ret:<span class="library" title="binding of C++ string type">string</span> = <span class="fstring">""</span>;
<span class="lineno" id=line148></span>      <span class="small_keyword" title="conditional">if</span> olen &gt; 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line149></span>        <span class="big_keyword" title="Define a mutable variable">var</span> buf = <span class="hack">C_hack</span>::cast[+<span class="library" title="binding of C char type">char</span>] (Memory::malloc(<span class="library" title="number of elements in data structure">len</span>+1));
<span class="lineno" id=line150></span>        <span class="big_keyword" title="Define a mutable variable">var</span> buf_a = <span class="library" title="special binding of C void* type">address</span>(buf);
<span class="lineno" id=line151></span>        read(conn.sock,&amp;<span class="library" title="number of elements in data structure">len</span>,buf_a,&amp;eof);
<span class="lineno" id=line152></span>        ret= <span class="library" title="Convert a value to a string">str</span>(buf);
<span class="lineno" id=line153></span>        Memory::free(buf_a);
<span class="lineno" id=line154></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line155></span>       <span class="small_keyword" title="return">return</span> ret; 
<span class="lineno" id=line156></span>    }
<span class="lineno" id=line157></span>  
<span class="lineno" id=line158></span>  
<span class="lineno" id=line159></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> get_multipart_params(conn:http_connection,request:&amp;http_request,attribs:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>^2]) {
<span class="lineno" id=line160></span>      <span class="big_keyword" title="Define a mutable variable">var</span> line:<span class="library" title="binding of C++ string type">string</span> = <span class="fstring">""</span>;
<span class="lineno" id=line161></span>      <span class="big_keyword" title="Define an immutable value">val</span> llen = <span class="small_keyword" title="match statement or expression">match</span> get_header(*request,<span class="fstring">"Content-Length"</span>) <span class="small_keyword" title="type-class constraint">with</span> |Some s=&gt; <span class="library" title="binding of C int type">int</span>(s) |_ =&gt; 0 <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line162></span>      <span class="big_keyword" title="Define a mutable variable">var</span> rest = read_bytes(conn,llen);
<span class="lineno" id=line163></span>      <span class="library" title="Print a string to a stream">write</span>(conn,HTTPResponse::make_continue());
<span class="lineno" id=line164></span>      conn.dirty &lt;- <span class="library" title="false value">false</span>;
<span class="lineno" id=line165></span>  
<span class="lineno" id=line166></span>      <span class="small_keyword" title="match statement or expression">match</span> (find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s == <span class="fstring">"boundary"</span>) attribs) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line167></span>        |Some b =&gt; { get_line(conn.sock, &amp;line); 
<span class="lineno" id=line168></span>          <span class="big_keyword" title="Define a mutable variable">var</span> headers = Empty[<span class="library" title="binding of C++ string type">string</span>^2];
<span class="lineno" id=line169></span>          get_headers(conn,&amp;headers);
<span class="lineno" id=line170></span>        }
<span class="lineno" id=line171></span>       |_ =&gt; {conn.config.log(DEBUG,<span class="fstring">"No Boundry"</span>); }
<span class="lineno" id=line172></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line173></span>       request.entity_params &lt;- Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line174></span>    }
<span class="lineno" id=line175></span>  
<span class="lineno" id=line176></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_fname(request:http_request) ={
<span class="lineno" id=line177></span>      <span class="big_keyword" title="Define an immutable value">val</span> v = <span class="small_keyword" title="match statement or expression">match</span> unbox (<span class="library" title="return data structure with elements reversed">rev</span>(split(request.path,<span class="fstring">'/'</span>))) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line178></span>        | Cons(hd,_) =&gt; Some(hd) 
<span class="lineno" id=line179></span>        | _ =&gt; None[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line180></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line181></span>      <span class="small_keyword" title="return">return</span> v;
<span class="lineno" id=line182></span>    }
<span class="lineno" id=line183></span>  
<span class="lineno" id=line184></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_path_and_fname(request:http_request):<span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C++ string type">string</span>^2] ={
<span class="lineno" id=line185></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="match statement or expression">match</span> unbox (<span class="library" title="return data structure with elements reversed">rev</span>(split(request.path,<span class="fstring">'/'</span>))) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line186></span>        | Cons(hd,tl) =&gt; Some(
<span class="lineno" id=line187></span>              (<span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>) (y:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> =&gt; x +<span class="fstring">"/"</span>+ y) <span class="fstring">""</span> (<span class="library" title="return data structure with elements reversed">rev</span>(tl))), hd)
<span class="lineno" id=line188></span>        | _ =&gt; None[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line189></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line190></span>    }
<span class="lineno" id=line191></span>  
<span class="lineno" id=line192></span>    publish <span class="fstring">""" Return opt[string] parameter value for given name """</span>
<span class="lineno" id=line193></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_param(request:http_request,name:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line194></span>       find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) request.params name;
<span class="lineno" id=line195></span>  
<span class="lineno" id=line196></span>    publish <span class="fstring">""" Return opt[string] post parameter value for given name """</span>
<span class="lineno" id=line197></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_post_param(request:http_request,name:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line198></span>       find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) request.entity_params name;
<span class="lineno" id=line199></span>  
<span class="lineno" id=line200></span>    publish <span class="fstring">""" Return opt[string] request header value for given name """</span>
<span class="lineno" id=line201></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_header(request:http_request,name:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line202></span>       find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) request.headers name;
<span class="lineno" id=line203></span>  
<span class="lineno" id=line204></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_cookies(request:http_request):<span class="library" title="functional, singly linked list">list</span>[cookie] = {
<span class="lineno" id=line205></span>      
<span class="lineno" id=line206></span>       <span class="big_keyword" title="Define an immutable value">val</span> cline= Assoc_list::find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) (request.headers)  (<span class="fstring">'Cookie'</span>);
<span class="lineno" id=line207></span>       <span class="big_keyword" title="Define an immutable value">val</span> lines = <span class="small_keyword" title="match statement or expression">match</span> cline <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line208></span>         | Some s =&gt; (<span class="small_keyword" title="match statement or expression">match</span> split(s,<span class="fstring">';'</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line209></span>                         |Cons (h,t) =&gt; Cons(h,t)
<span class="lineno" id=line210></span>                         |_            =&gt; Empty[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line211></span>                       <span class="small_keyword" title="end a match statement or expression">endmatch</span>)
<span class="lineno" id=line212></span>         | _        =&gt; Empty[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line213></span>       <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line214></span>       <span class="big_keyword" title="Define an immutable value">val</span> pairs = filter (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (sl:<span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C++ string type">string</span>^2]) =&gt; <span class="small_keyword" title="match statement or expression">match</span> sl <span class="small_keyword" title="type-class constraint">with</span> |Some _ =&gt; <span class="library" title="truth value">true</span> |_ =&gt; <span class="library" title="false value">false</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>) (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (cl:<span class="library" title="binding of C++ string type">string</span>) =&gt; split_first(cl,<span class="fstring">"="</span>)) lines);
<span class="lineno" id=line215></span>        <span class="small_keyword" title="return">return</span> (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (p:<span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C++ string type">string</span>^2]) =&gt; <span class="small_keyword" title="let binder">let</span> Some q = p <span class="small_keyword" title="membership operator, function mem">in</span> cookie(q.(0),q.(1))) pairs);
<span class="lineno" id=line216></span>  }
<span class="lineno" id=line217></span>  
<span class="lineno" id=line218></span>  }
<span class="lineno" id=line219></span>  
</pre></p><pre class='inclusion'>
share/lib/web/http_response.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/__init__"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  publish <span class="fstring">"""
<span class="lineno" id=line4></span>  Use make_&lt;response type&gt; to wrap html in an apropriate response
<span class="lineno" id=line5></span>  """</span>
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Define a type class">class</span> HTTPResponse {
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Open a module or class">open</span> LowResTime;
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPStatusCodes;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Open a module or class">open</span> MIMEType;
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Open a module or class">open</span> Assoc_list;
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a structure">struct</span> http_response {
<span class="lineno" id=line13></span>      status_code:status_code;
<span class="lineno" id=line14></span>      last_modified:tm;
<span class="lineno" id=line15></span>      content_type:mime_type;
<span class="lineno" id=line16></span>      headers:assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line17></span>      content:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line18></span>    }
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> headers_t = assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line21></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> no_headers ():headers_t =&gt; Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> http_header (response:http_response) =&gt;
<span class="lineno" id=line24></span>  <span class="fstring">"""HTTP/1.0 """</span> + <span class="library" title="Convert a value to a string">str</span>(response.status_code) +<span class="fstring">"""\r
<span class="lineno" id=line25></span>  Date: """</span> + rfc1123_date() + <span class="fstring">"""\r
<span class="lineno" id=line26></span>  Server: felix web server\r
<span class="lineno" id=line27></span>  Last-Modified: """</span> + rfc1123_date(response.last_modified) +<span class="fstring">"""\r
<span class="lineno" id=line28></span>  Connection: close\r
<span class="lineno" id=line29></span>  Content-Type: """</span> + <span class="library" title="Convert a value to a string">str</span>(response.content_type) + <span class="fstring">"""\r
<span class="lineno" id=line30></span>  Content-Length: """</span> + <span class="library" title="Convert a value to a string">str</span> (<span class="library" title="number of elements in data structure">len</span> response.content) + <span class="fstring">"""\r
<span class="lineno" id=line31></span>  """</span>+(<span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>) (y:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> =&gt; x + y) <span class="fstring">""</span> (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (n:<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>) =&gt; n.(0)+<span class="fstring">": "</span>+n.(1)+<span class="fstring">"\r\n"</span>) response.headers))+<span class="fstring">"""\r
<span class="lineno" id=line32></span>  """</span>;
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>    
<span class="lineno" id=line35></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_image(mime:mime_type, content:<span class="library" title="binding of C++ string type">string</span>) =&gt; 
<span class="lineno" id=line36></span>      http_header(http_response(SC_OK,localtime(#time_t),mime,#no_headers,content)) +
<span class="lineno" id=line37></span>        content; 
<span class="lineno" id=line38></span>  
<span class="lineno" id=line39></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_image(mime:mime_type, content:<span class="library" title="binding of C++ string type">string</span>, headers:headers_t) =&gt; 
<span class="lineno" id=line40></span>      http_header(http_response(SC_OK,localtime(#time_t),mime,headers,content)) +
<span class="lineno" id=line41></span>        content; 
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_css (content:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line44></span>      http_header(http_response(SC_OK,localtime(#time_t),text css,#no_headers,content)) +
<span class="lineno" id=line45></span>        content; 
<span class="lineno" id=line46></span>  
<span class="lineno" id=line47></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_js (content:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line48></span>      http_header(http_response(SC_OK,localtime(#time_t),application javascript,#no_headers,content)) +
<span class="lineno" id=line49></span>        content; 
<span class="lineno" id=line50></span>  
<span class="lineno" id=line51></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_json (content:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line52></span>      http_header(http_response(SC_OK,localtime(#time_t),application json,#no_headers,content)) +
<span class="lineno" id=line53></span>        content; 
<span class="lineno" id=line54></span>  
<span class="lineno" id=line55></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_not_found (content:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line56></span>      <span class="small_keyword" title="let binder">let</span> response = http_response(SC_NOT_FOUND,localtime(#time_t),text html,#no_headers,
<span class="lineno" id=line57></span>  				  content) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line58></span>      	http_header(response) + response.content; 
<span class="lineno" id=line59></span>  
<span class="lineno" id=line60></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_not_implemented (content:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line61></span>      <span class="small_keyword" title="let binder">let</span> response = http_response(SC_NOT_IMPLEMENTED,localtime(#time_t),text html,#no_headers,
<span class="lineno" id=line62></span>  				  content) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line63></span>      	http_header(response) + response.content; 
<span class="lineno" id=line64></span>    
<span class="lineno" id=line65></span>    
<span class="lineno" id=line66></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_see_other (location:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line67></span>      <span class="small_keyword" title="let binder">let</span> response = http_response(SC_SEE_OTHER,localtime(#time_t),text html,Cons((<span class="fstring">"Location"</span>,location),Empty[<span class="library" title="binding of C++ string type">string</span>^2]),<span class="fstring">""</span>) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line68></span>      	http_header(response) + response.content; 
<span class="lineno" id=line69></span>  
<span class="lineno" id=line70></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_forbidden (content:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line71></span>      <span class="small_keyword" title="let binder">let</span> response = http_response(SC_FORBIDDEN,localtime(#time_t),text html,#no_headers,
<span class="lineno" id=line72></span>  				  <span class="fstring">"Forbidden: "</span>+content) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line73></span>      	http_header(response) + response.content; 
<span class="lineno" id=line74></span>  
<span class="lineno" id=line75></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_unauthorized (headers:headers_t) =&gt;
<span class="lineno" id=line76></span>      <span class="small_keyword" title="let binder">let</span> response = http_response(SC_UNAUTHORIZED,localtime(#time_t),text html,headers,
<span class="lineno" id=line77></span>  				  <span class="fstring">""</span>) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line78></span>      	http_header(response) +<span class="fstring">"\nUnauthorized"</span>; 
<span class="lineno" id=line79></span>  
<span class="lineno" id=line80></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_unauthorized (headers:headers_t,content:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line81></span>      <span class="small_keyword" title="let binder">let</span> response = http_response(SC_UNAUTHORIZED,localtime(#time_t),text html,headers,
<span class="lineno" id=line82></span>  				  <span class="fstring">""</span>) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line83></span>      	http_header(response) +<span class="fstring">"\n"</span>+content; 
<span class="lineno" id=line84></span>  
<span class="lineno" id=line85></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_continue () =&gt;
<span class="lineno" id=line86></span>      <span class="small_keyword" title="let binder">let</span> response = http_response(SC_CONTINUE,localtime(#time_t),text html,#no_headers,
<span class="lineno" id=line87></span>  				  <span class="fstring">""</span>) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line88></span>      	http_header(response) +<span class="fstring">"\r"</span>;   
<span class="lineno" id=line89></span>  
<span class="lineno" id=line90></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_raw (content:<span class="library" title="binding of C++ string type">string</span>) =&gt; make_raw(content,#no_headers);
<span class="lineno" id=line91></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_raw (content:<span class="library" title="binding of C++ string type">string</span>,headers:headers_t) =&gt;
<span class="lineno" id=line92></span>      http_header(http_response(SC_OK,localtime(#time_t),application octet_DASH_stream,
<span class="lineno" id=line93></span>                                headers,content)) + content; 
<span class="lineno" id=line94></span>  
<span class="lineno" id=line95></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_html (content:<span class="library" title="binding of C++ string type">string</span>) =&gt; make_html(content,#no_headers);
<span class="lineno" id=line96></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_html (content:<span class="library" title="binding of C++ string type">string</span>,headers:headers_t) =&gt;
<span class="lineno" id=line97></span>      http_header(http_response(SC_OK,localtime(#time_t),text html,
<span class="lineno" id=line98></span>                                headers,content)) + content; 
<span class="lineno" id=line99></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_xhtml (content:<span class="library" title="binding of C++ string type">string</span>) =&gt; make_xhtml(content,#no_headers);
<span class="lineno" id=line100></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_xhtml (content:<span class="library" title="binding of C++ string type">string</span>,headers:headers_t) =&gt;
<span class="lineno" id=line101></span>      http_header(http_response(SC_OK,localtime(#time_t),application xhtml_PLUS_xml,
<span class="lineno" id=line102></span>                                headers,content)) + content; 
<span class="lineno" id=line103></span>  
<span class="lineno" id=line104></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_mime (mime:mime_type, content:<span class="library" title="binding of C++ string type">string</span>) =&gt; make_mime(mime,content, #no_headers);
<span class="lineno" id=line105></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_mime (mime:mime_type, content:<span class="library" title="binding of C++ string type">string</span>, headers:headers_t) =&gt;
<span class="lineno" id=line106></span>      http_header(http_response(SC_OK,localtime(#time_t),mime,
<span class="lineno" id=line107></span>                                headers,content)) + content; 
<span class="lineno" id=line108></span>  
<span class="lineno" id=line109></span>  
<span class="lineno" id=line110></span>  }
<span class="lineno" id=line111></span>  <span class="comment">//WWW-Authenticate: Basic realm="WallyWorld"</span>
</pre></p><pre class='inclusion'>
share/lib/web/http_handler.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/__init__"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  publish <span class="fstring">"""
<span class="lineno" id=line4></span>  Implements default handlers for static content and error pages.
<span class="lineno" id=line5></span>  Defines container http_hadler for use in constructing custom handlers
<span class="lineno" id=line6></span>  for use in WebServer """</span>
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Define a type class">class</span> HTTPHandler {
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPResponse;
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPRequest;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPConnection;
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Open a module or class">open</span> ServerConfig;
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Open a module or class">open</span> MIMEType;
<span class="lineno" id=line13></span>    <span class="big_keyword" title="Open a module or class">open</span> Tord[mime_type];
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>    publish <span class="fstring">""" handles determines what requests are handleded by handler_fn.
<span class="lineno" id=line16></span>    handler_fn handles http request and respons on http_connection """</span>
<span class="lineno" id=line17></span>    <span class="big_keyword" title="Define a structure">struct</span> http_handler {
<span class="lineno" id=line18></span>      handles: (server_config*http_request)-&gt;bool;
<span class="lineno" id=line19></span>      handler_fn: (http_connection*http_request) -&gt; <span class="library" title="Type with no values, returning void indicates a procedure">void</span>;
<span class="lineno" id=line20></span>    }
<span class="lineno" id=line21></span>   
<span class="lineno" id=line22></span>    publish <span class="fstring">""" return option of the first element in a list mapped to type V satisfying 
<span class="lineno" id=line23></span>    the combined transformer and predicate xf """</span>
<span class="lineno" id=line24></span>  
<span class="lineno" id=line25></span>   <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (x:<span class="library" title="binding of C++ string type">string</span>, y:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (x,y);
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> find_and_map[T,V] (xf:T -&gt; <span class="library" title="option type: Some x or None">opt</span>[V]) (xs:<span class="library" title="functional, singly linked list">list</span>[T]) : <span class="library" title="option type: Some x or None">opt</span>[V] =&gt;
<span class="lineno" id=line28></span>      <span class="small_keyword" title="match statement or expression">match</span> xs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line29></span>      | #Empty =&gt; None[V]
<span class="lineno" id=line30></span>      | Cons (h,t) =&gt; <span class="small_keyword" title="match statement or expression">match</span> xf(h) <span class="small_keyword" title="type-class constraint">with</span> |Some (v) =&gt; Some(v) |_ =&gt; find_and_map xf t <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line31></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line32></span>    ;
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>  
<span class="lineno" id=line35></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_fs_path (config:server_config,request:http_request) =&gt; 
<span class="lineno" id=line36></span>      <span class="small_keyword" title="match statement or expression">match</span> get_path_and_fname(request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line37></span>        | Some(path,fname) =&gt; find_and_map[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>] (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (r:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C++ string type">string</span>] =&gt; (<span class="small_keyword" title="let binder">let</span> fs_path =
<span class="lineno" id=line38></span>          Filename::join(Filename::join(r,path),fname) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line39></span>          <span class="small_keyword" title="conditional">if</span> (FileStat::fileexists fs_path) <span class="small_keyword" title="conditional">then</span>
<span class="lineno" id=line40></span>            Some(fs_path)
<span class="lineno" id=line41></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line42></span>            None[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line43></span>          <span class="small_keyword" title="conditional">endif</span>)) (<span class="library" title="functional, singly linked list">list</span>(config.document_root,
<span class="lineno" id=line44></span>            Filename::join(Filename::join(Filename::join(#Config::std_config.FLX_SHARE_DIR,<span class="fstring">"lib"</span>),<span class="fstring">"web"</span>),<span class="fstring">"html"</span>)))
<span class="lineno" id=line45></span>        | _ =&gt; None[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line46></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line47></span>  
<span class="lineno" id=line48></span>  
<span class="lineno" id=line49></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> txt2html (x:<span class="library" title="binding of C++ string type">string</span>) =
<span class="lineno" id=line50></span>    {
<span class="lineno" id=line51></span>      <span class="big_keyword" title="Define a mutable variable">var</span> out2 = <span class="fstring">""</span>;
<span class="lineno" id=line52></span>      <span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line53></span>      <span class="small_keyword" title="for loop">for</span> i <span class="small_keyword" title="membership operator, function mem">in</span> 0 <span class="small_keyword" title="upwards counting for loop">upto</span> (<span class="library" title="binding of C int type">int</span>(<span class="library" title="number of elements in data structure">len</span> x) - 1) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line54></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ch = x.[i];
<span class="lineno" id=line55></span>        <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line56></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line57></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line58></span>        <span class="small_keyword" title="conditional">else</span> out2+=ch;
<span class="lineno" id=line59></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line60></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line61></span>     <span class="small_keyword" title="return">return</span> out2;
<span class="lineno" id=line62></span>    }
<span class="lineno" id=line63></span>  
<span class="lineno" id=line64></span>     <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> handle_not_found(conn:http_connection, request:http_request) =  {
<span class="lineno" id=line65></span>       <span class="big_keyword" title="Define a mutable variable">var</span> txt = <span class="fstring">"&lt;div style='text-color:red;'&gt;Page "</span>+ 
<span class="lineno" id=line66></span>         (<span class="small_keyword" title="match statement or expression">match</span> get_fname request <span class="small_keyword" title="type-class constraint">with</span> | Some(fname) =&gt; fname | _ =&gt; <span class="fstring">"NONE"</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>)+
<span class="lineno" id=line67></span>         <span class="fstring">" not found.&lt;/div&gt;"</span>;
<span class="lineno" id=line68></span>       <span class="big_keyword" title="Define an immutable value">val</span> data = make_not_found txt;
<span class="lineno" id=line69></span>       <span class="library" title="Print a string to a stream">write</span>(conn,data);
<span class="lineno" id=line70></span>       <span class="small_keyword" title="return">return</span> ;
<span class="lineno" id=line71></span>     }
<span class="lineno" id=line72></span>    
<span class="lineno" id=line73></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> do_handle_not_found(conn:http_connection, request:http_request) {
<span class="lineno" id=line74></span>      handle_not_found(conn,request);
<span class="lineno" id=line75></span>    }
<span class="lineno" id=line76></span>     
<span class="lineno" id=line77></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> handle_not_found_route (config:server_config, request:http_request) =&gt; <span class="library" title="truth value">true</span>; 
<span class="lineno" id=line78></span>  
<span class="lineno" id=line79></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> handle_css(conn:http_connection, request:http_request) = {
<span class="lineno" id=line80></span>      <span class="small_keyword" title="match statement or expression">match</span> get_fs_path(conn.config,request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line81></span>        | Some(file) =&gt; {
<span class="lineno" id=line82></span>                         <span class="big_keyword" title="Define an immutable value">val</span> txt = load (file);
<span class="lineno" id=line83></span>        		       <span class="library" title="Print a string to a stream">write</span>(conn,(make_css txt));
<span class="lineno" id=line84></span>                         }
<span class="lineno" id=line85></span>        | _ =&gt; {do_handle_not_found(conn,request);}
<span class="lineno" id=line86></span>     <span class="small_keyword" title="end a match statement or expression">endmatch</span>;  
<span class="lineno" id=line87></span>     <span class="small_keyword" title="return">return</span> ;
<span class="lineno" id=line88></span>    }
<span class="lineno" id=line89></span>  
<span class="lineno" id=line90></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> handle_css_route (config:server_config, request:http_request) =&gt;
<span class="lineno" id=line91></span>      <span class="small_keyword" title="match statement or expression">match</span> (get_path_and_fname request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line92></span>         | Some (p,f) =&gt; (<span class="small_keyword" title="match statement or expression">match</span> (mime_type_from_file f) <span class="small_keyword" title="type-class constraint">with</span> |text css =&gt; <span class="library" title="truth value">true</span> | _ =&gt; <span class="library" title="false value">false</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>)
<span class="lineno" id=line93></span>         | _ =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line94></span>       <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line95></span>  
<span class="lineno" id=line96></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> handle_js(conn:http_connection, request:http_request) = {
<span class="lineno" id=line97></span>      <span class="small_keyword" title="match statement or expression">match</span> get_fs_path(conn.config,request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line98></span>        | Some(file) =&gt; {
<span class="lineno" id=line99></span>                         <span class="big_keyword" title="Define an immutable value">val</span> txt = load (file);
<span class="lineno" id=line100></span>        		       <span class="library" title="Print a string to a stream">write</span>(conn,(make_js txt));
<span class="lineno" id=line101></span>                         }
<span class="lineno" id=line102></span>        | _ =&gt; {do_handle_not_found(conn,request);}
<span class="lineno" id=line103></span>     <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line104></span>     <span class="small_keyword" title="return">return</span> ;
<span class="lineno" id=line105></span>    }
<span class="lineno" id=line106></span>  
<span class="lineno" id=line107></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> handle_js_route (config:server_config, request:http_request) =&gt;
<span class="lineno" id=line108></span>      <span class="small_keyword" title="match statement or expression">match</span> (get_path_and_fname request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line109></span>        | Some (p,f) =&gt; (<span class="small_keyword" title="match statement or expression">match</span> (mime_type_from_file f) <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line110></span>          |application javascript =&gt; <span class="library" title="truth value">true</span> | _ =&gt; <span class="library" title="false value">false</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>)
<span class="lineno" id=line111></span>        | _ =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line112></span>       <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line113></span>  
<span class="lineno" id=line114></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> handle_image(conn:http_connection, request:http_request) = {
<span class="lineno" id=line115></span>      <span class="small_keyword" title="match statement or expression">match</span> get_fs_path(conn.config,request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line116></span>        | Some(file) =&gt; {
<span class="lineno" id=line117></span>                         <span class="big_keyword" title="Define an immutable value">val</span> txt = load (file);
<span class="lineno" id=line118></span>        		       <span class="library" title="Print a string to a stream">write</span>(conn,make_image((mime_type_from_file file), txt));
<span class="lineno" id=line119></span>                         }
<span class="lineno" id=line120></span>        | _ =&gt; {do_handle_not_found(conn,request);}
<span class="lineno" id=line121></span>     <span class="small_keyword" title="end a match statement or expression">endmatch</span>;  
<span class="lineno" id=line122></span>     <span class="small_keyword" title="return">return</span> ;
<span class="lineno" id=line123></span>    }
<span class="lineno" id=line124></span>  
<span class="lineno" id=line125></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> handle_image_route (config:server_config,request:http_request) =&gt; 
<span class="lineno" id=line126></span>       <span class="small_keyword" title="match statement or expression">match</span> (get_path_and_fname request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line127></span>         | Some (p,f) =&gt; (<span class="small_keyword" title="match statement or expression">match</span> (mime_type_from_file f) <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line128></span>              |image gif =&gt; <span class="library" title="truth value">true</span> 
<span class="lineno" id=line129></span>              |image jpeg =&gt; <span class="library" title="truth value">true</span> 
<span class="lineno" id=line130></span>              |image png =&gt; <span class="library" title="truth value">true</span> 
<span class="lineno" id=line131></span>              |image tiff =&gt; <span class="library" title="truth value">true</span> 
<span class="lineno" id=line132></span>              | _ =&gt; <span class="library" title="false value">false</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>)
<span class="lineno" id=line133></span>         | _ =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line134></span>       <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line135></span>  
<span class="lineno" id=line136></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> handle_html(conn:http_connection, request:http_request) = {
<span class="lineno" id=line137></span>      <span class="small_keyword" title="conditional">if</span> (request.uri == <span class="fstring">"/"</span> <span class="small_keyword" title="logical conjunction">and</span> request.path == <span class="fstring">"/"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line138></span>        <span class="big_keyword" title="Define an immutable value">val</span> txt = load (conn.config.document_root+<span class="fstring">"/index.html"</span>);
<span class="lineno" id=line139></span>        <span class="library" title="Print a string to a stream">write</span>(conn,(make_html txt));
<span class="lineno" id=line140></span>      <span class="small_keyword" title="conditional">else</span>                   
<span class="lineno" id=line141></span>        <span class="small_keyword" title="match statement or expression">match</span> get_fs_path(conn.config,request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line142></span>          | Some(file) =&gt; {
<span class="lineno" id=line143></span>                         <span class="big_keyword" title="Define an immutable value">val</span> txt = load (file);
<span class="lineno" id=line144></span>        		       <span class="library" title="Print a string to a stream">write</span>(conn,(make_html txt));
<span class="lineno" id=line145></span>                         }
<span class="lineno" id=line146></span>          | _ =&gt; {do_handle_not_found(conn,request);}
<span class="lineno" id=line147></span>         <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line148></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line149></span>      <span class="small_keyword" title="return">return</span> ;
<span class="lineno" id=line150></span>    }
<span class="lineno" id=line151></span>  
<span class="lineno" id=line152></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> handle_html_route (config:server_config,request:http_request):bool =&gt;
<span class="lineno" id=line153></span>       <span class="small_keyword" title="conditional">if</span> (request.uri == <span class="fstring">"/"</span> <span class="small_keyword" title="logical conjunction">and</span> request.path == <span class="fstring">"/"</span>) <span class="small_keyword" title="conditional">then</span> 
<span class="lineno" id=line154></span>         <span class="library" title="truth value">true</span>
<span class="lineno" id=line155></span>       <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line156></span>         <span class="small_keyword" title="match statement or expression">match</span> (get_path_and_fname request) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line157></span>           | Some (p,f) =&gt; (<span class="small_keyword" title="match statement or expression">match</span> (mime_type_from_file f) <span class="small_keyword" title="type-class constraint">with</span> |text html =&gt; <span class="library" title="truth value">true</span> | _ =&gt; <span class="library" title="false value">false</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>)
<span class="lineno" id=line158></span>           | _ =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line159></span>         <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line160></span>       <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line161></span>  
<span class="lineno" id=line162></span>    publish <span class="fstring">""" Returns list of Stock handlers """</span>
<span class="lineno" id=line163></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> default_handlers() =&gt; <span class="library" title="functional, singly linked list">list</span> (
<span class="lineno" id=line164></span>      http_handler(handle_html_route,handle_html),
<span class="lineno" id=line165></span>  	  http_handler(handle_image_route,handle_image),
<span class="lineno" id=line166></span>      http_handler(handle_css_route,handle_css),
<span class="lineno" id=line167></span>  		http_handler(handle_js_route,handle_js),
<span class="lineno" id=line168></span>      http_handler(handle_not_found_route,handle_not_found)
<span class="lineno" id=line169></span>    );
<span class="lineno" id=line170></span>    
<span class="lineno" id=line171></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/http_connection.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/__init__"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  publish <span class="fstring">"""
<span class="lineno" id=line4></span>  Container for server config and socket_t
<span class="lineno" id=line5></span>  """</span>
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Define a type class">class</span> HTTPConnection {
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Open a module or class">open</span> ServerConfig;
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Open a module or class">open</span> Socket;
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Open a module or class">open</span> Logger;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Open a module or class">open</span> IOStream;
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Open a module or class">open</span> Socket;
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Open a module or class">open</span> TerminalIOByteStream[socket_t];
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>    <span class="big_keyword" title="Define a structure">struct</span> http_connection {
<span class="lineno" id=line15></span>      config:server_config;
<span class="lineno" id=line16></span>      sock:socket_t;
<span class="lineno" id=line17></span>      dirty:&amp;bool;
<span class="lineno" id=line18></span>    };
<span class="lineno" id=line19></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_http_connection(config:server_config,sock:socket_t) = {
<span class="lineno" id=line20></span>      <span class="big_keyword" title="Define a mutable variable">var</span> b:bool = <span class="library" title="false value">false</span>;
<span class="lineno" id=line21></span>      <span class="small_keyword" title="return">return</span> http_connection(config,sock,&amp;b);
<span class="lineno" id=line22></span>    }
<span class="lineno" id=line23></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set_dirty(conn:http_connection,state:bool) {
<span class="lineno" id=line24></span>      conn.dirty &lt;- state;
<span class="lineno" id=line25></span>    }
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> <span class="library" title="Print a string to a stream">write</span>(<span class="big_keyword" title="Define a mutable variable">var</span> conn:http_connection,<span class="big_keyword" title="Define a mutable variable">var</span> content:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line28></span>      
<span class="lineno" id=line29></span>      <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line30></span>      <span class="big_keyword" title="Define an immutable value">val</span> content_len = content.<span class="library" title="number of elements in data structure">len</span>;
<span class="lineno" id=line31></span>      conn.config.log(DEBUG,<span class="fstring">"Content Size:"</span>+<span class="library" title="Convert a value to a string">str</span>(content_len));
<span class="lineno" id=line32></span>      <span class="big_keyword" title="Define an immutable value">val</span> chunk_size = <span class="library" title="binding of C size_t type">size</span>(1024);
<span class="lineno" id=line33></span>      <span class="big_keyword" title="Define a mutable variable">var</span> chunks:<span class="library" title="binding of C size_t type">size</span> = content.<span class="library" title="number of elements in data structure">len</span> / chunk_size;
<span class="lineno" id=line34></span>      <span class="big_keyword" title="Define a mutable variable">var</span> remainder = content.<span class="library" title="number of elements in data structure">len</span> % chunk_size;
<span class="lineno" id=line35></span>      <span class="big_keyword" title="Define a mutable variable">var</span> base = <span class="library" title="binding of C size_t type">size</span>(0);
<span class="lineno" id=line36></span>      <span class="small_keyword" title="for loop">for</span> <span class="big_keyword" title="Define a mutable variable">var</span> i <span class="small_keyword" title="membership operator, function mem">in</span> <span class="library" title="binding of C size_t type">size</span>(1) <span class="small_keyword" title="upwards counting for loop">upto</span> chunks <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line37></span>        conn.config.log(DEBUG,<span class="fstring">"Writing[sock="</span>+<span class="library" title="Convert a value to a string">str</span> conn.sock+<span class="fstring">"]:"</span>+<span class="library" title="Convert a value to a string">str</span>(base)+<span class="fstring">" to "</span>+<span class="library" title="Convert a value to a string">str</span>(base+chunk_size));
<span class="lineno" id=line38></span>        write_string(conn.sock,content.[base <span class="small_keyword" title="substring range separator">to</span> (base+chunk_size)],&amp;eof_flag);
<span class="lineno" id=line39></span>        base = base + chunk_size;
<span class="lineno" id=line40></span>        
<span class="lineno" id=line41></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line42></span>      <span class="small_keyword" title="conditional">if</span> remainder &gt; <span class="library" title="binding of C size_t type">size</span>(0) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line43></span>         conn.config.log(DEBUG,<span class="fstring">"Writing[sock="</span>+<span class="library" title="Convert a value to a string">str</span> conn.sock+<span class="fstring">"] Remainder:"</span>+<span class="library" title="Convert a value to a string">str</span>(base)+<span class="fstring">" to "</span>+<span class="library" title="Convert a value to a string">str</span>(content_len));
<span class="lineno" id=line44></span>         write_string(conn.sock,content.[base <span class="small_keyword" title="substring range separator">to</span> ],&amp;eof_flag);
<span class="lineno" id=line45></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line46></span>      set_dirty(conn,<span class="library" title="truth value">true</span>);  
<span class="lineno" id=line47></span>    }
<span class="lineno" id=line48></span>  
<span class="lineno" id=line49></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/http_status_code.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">/*
<span class="lineno" id=line2></span>  Example:
<span class="lineno" id=line3></span>    println$ str SC_OK;
<span class="lineno" id=line4></span>  */</span>
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Define a type class">class</span> HTTPStatusCodes {
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Elaborate an enumeration, a simple sum type">enum</span> status_code {
<span class="lineno" id=line8></span>      SC_OK,
<span class="lineno" id=line9></span>      SC_CREATED,
<span class="lineno" id=line10></span>      SC_NO_CONTENT,
<span class="lineno" id=line11></span>      SC_MOVED_PERMANENTLY,
<span class="lineno" id=line12></span>      SC_TEMPORARY_REDIRECT,
<span class="lineno" id=line13></span>      SC_BAD_REQUEST,
<span class="lineno" id=line14></span>      SC_UNAUTHORIZED,
<span class="lineno" id=line15></span>      SC_FORBIDDEN,
<span class="lineno" id=line16></span>      SC_NOT_FOUND,
<span class="lineno" id=line17></span>      SC_METHOD_NOT_ALLOWED,
<span class="lineno" id=line18></span>      SC_INTERNAL_SERVER_ERROR,
<span class="lineno" id=line19></span>      SC_NOT_IMPLEMENTED,
<span class="lineno" id=line20></span>      SC_SERVICE_UNAVAILABLE,
<span class="lineno" id=line21></span>      SC_SEE_OTHER,
<span class="lineno" id=line22></span>      SC_CONTINUE
<span class="lineno" id=line23></span>    }
<span class="lineno" id=line24></span>            
<span class="lineno" id=line25></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[status_code] {          
<span class="lineno" id=line26></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span>: status_code -&gt; <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line27></span>        |  #SC_CONTINUE =&gt; <span class="fstring">"100 Continue"</span>
<span class="lineno" id=line28></span>        |  #SC_OK =&gt; <span class="fstring">"200 OK"</span>
<span class="lineno" id=line29></span>        |  #SC_CREATED =&gt; <span class="fstring">"201 Created"</span>
<span class="lineno" id=line30></span>        |  #SC_NO_CONTENT =&gt; <span class="fstring">"204 No Content"</span>
<span class="lineno" id=line31></span>        |  #SC_MOVED_PERMANENTLY =&gt; <span class="fstring">"301 Moved Permanently"</span>
<span class="lineno" id=line32></span>        |  #SC_SEE_OTHER =&gt; <span class="fstring">"303 See Other"</span>
<span class="lineno" id=line33></span>        |  #SC_TEMPORARY_REDIRECT =&gt; <span class="fstring">"307 Temporary Redirect"</span>
<span class="lineno" id=line34></span>        |  #SC_BAD_REQUEST =&gt; <span class="fstring">"400 Bad Request"</span>
<span class="lineno" id=line35></span>        |  #SC_UNAUTHORIZED =&gt; <span class="fstring">"401 Unauthorized"</span>
<span class="lineno" id=line36></span>        |  #SC_FORBIDDEN =&gt; <span class="fstring">"403 Forbidden"</span>
<span class="lineno" id=line37></span>        |  #SC_NOT_FOUND =&gt; <span class="fstring">"404 Not Found"</span>
<span class="lineno" id=line38></span>        |  #SC_METHOD_NOT_ALLOWED =&gt; <span class="fstring">"405 Not Allowed"</span>
<span class="lineno" id=line39></span>        |  #SC_INTERNAL_SERVER_ERROR =&gt; <span class="fstring">"500 Internal Server Error"</span>
<span class="lineno" id=line40></span>        |  #SC_NOT_IMPLEMENTED =&gt; <span class="fstring">"501 Not Implemented"</span>
<span class="lineno" id=line41></span>        |  #SC_SERVICE_UNAVAILABLE =&gt; <span class="fstring">"503 Service Unavailable"</span>
<span class="lineno" id=line42></span>      ;
<span class="lineno" id=line43></span>    }
<span class="lineno" id=line44></span>  
<span class="lineno" id=line45></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/mime_type.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  publish <span class="fstring">"""
<span class="lineno" id=line2></span>  Implements variant types representing MIME types.
<span class="lineno" id=line3></span>  Also implements Str instance for mime types and parses MIME type from string
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>  Example: 
<span class="lineno" id=line6></span>    open MIMETypes;
<span class="lineno" id=line7></span>    println (javascript);
<span class="lineno" id=line8></span>    println from_str("application/atom+xml");
<span class="lineno" id=line9></span>    println (application zip);
<span class="lineno" id=line10></span>  """</span>
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>  <span class="big_keyword" title="Define a type class">class</span> MIMEType {
<span class="lineno" id=line13></span>  <span class="comment">/*
<span class="lineno" id=line14></span>  TODO: implement more MIME types.
<span class="lineno" id=line15></span>  */</span>  
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>    <span class="big_keyword" title="Open a module or class">open</span> WebUtil;
<span class="lineno" id=line18></span>    variant application_mime_subtype =
<span class="lineno" id=line19></span>      | atom_PLUS_xml <span class="comment">//: Atom feeds</span>
<span class="lineno" id=line20></span>      | ecmascript <span class="comment">// ECMAScript/JavaScript; Defined in RFC 4329</span>
<span class="lineno" id=line21></span>      | EDI_DASH_X12 <span class="comment">// EDI X12 data; Defined in RFC 1767</span>
<span class="lineno" id=line22></span>      | EDIFACT  <span class="comment">//EDI EDIFACT data; Defined in RFC 1767</span>
<span class="lineno" id=line23></span>      | json <span class="comment">// JavaScript Object Notation JSON; Defined in RFC 4627</span>
<span class="lineno" id=line24></span>      | javascript <span class="comment">// ECMAScript/JavaScript; Defined in RFC 4329</span>
<span class="lineno" id=line25></span>      | octet_DASH_stream <span class="comment">// Arbitrary binary data.</span>
<span class="lineno" id=line26></span>      | ogg <span class="comment">// Ogg, a multimedia bitstream container format;</span>
<span class="lineno" id=line27></span>      | pdf <span class="comment">// Portable Document Format, </span>
<span class="lineno" id=line28></span>      | postscript <span class="comment">// PostScript; Defined in RFC 2046</span>
<span class="lineno" id=line29></span>      | rss_PLUS_xml <span class="comment">// RSS feeds</span>
<span class="lineno" id=line30></span>      | soap_PLUS_xml <span class="comment">//SOAP; Defined by RFC 3902</span>
<span class="lineno" id=line31></span>      | font_DASH_woff <span class="comment">//: Web Open Font Format;</span>
<span class="lineno" id=line32></span>      | xhtml_PLUS_xml <span class="comment">//: XHTML; Defined by RFC 3236</span>
<span class="lineno" id=line33></span>      | xml_DASH_dtd <span class="comment">//: DTD files; Defined by RFC 3023</span>
<span class="lineno" id=line34></span>      | xop_PLUS_xml <span class="comment">//:XOP</span>
<span class="lineno" id=line35></span>      | zip <span class="comment">//: ZIP archive files; Registered[7]</span>
<span class="lineno" id=line36></span>      | x_DASH_gzip <span class="comment">//: Gzip</span>
<span class="lineno" id=line37></span>      | x_DASH_www_DASH_form_DASH_urlencoded;  
<span class="lineno" id=line38></span>  
<span class="lineno" id=line39></span>    variant audio_mime_subtype =
<span class="lineno" id=line40></span>      | basic <span class="comment">//: mulaw audio at 8 kHz, 1 channel; Defined in RFC 2046</span>
<span class="lineno" id=line41></span>      | L24 <span class="comment">//: 24bit Linear PCM audio at 8-48kHz, 1-N channels; Defined in RFC 3190</span>
<span class="lineno" id=line42></span>      | mp4 <span class="comment">//: MP4 audio</span>
<span class="lineno" id=line43></span>      | mpeg <span class="comment">//: MP3 or other MPEG audio; Defined in RFC 3003</span>
<span class="lineno" id=line44></span>      | ogg1 <span class="comment">//: Ogg Vorbis, Speex, Flac and other audio; Defined in RFC 5334</span>
<span class="lineno" id=line45></span>      | vorbis <span class="comment">//: Vorbis encoded audio; Defined in RFC 5215</span>
<span class="lineno" id=line46></span>      | x_DASH_ms_DASH_wma <span class="comment">//: Windows Media Audio; Documented in Microsoft KB 288102</span>
<span class="lineno" id=line47></span>      | x_DASH_ms_DASH_wax <span class="comment">//: Windows Media Audio Redirector</span>
<span class="lineno" id=line48></span>      | vnd_DOT_rn_DASH_realaudio <span class="comment">//: RealAudio; Documented in RealPlayer</span>
<span class="lineno" id=line49></span>      | vnd_DOT_wave <span class="comment">//: WAV audio; Defined in RFC 2361</span>
<span class="lineno" id=line50></span>      | webm <span class="comment">//: WebM open media format</span>
<span class="lineno" id=line51></span>    ;   
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>    variant image_mime_subtype =
<span class="lineno" id=line54></span>      | gif <span class="comment">//: GIF image; Defined in RFC 2045 and RFC 2046</span>
<span class="lineno" id=line55></span>      | jpeg <span class="comment">// JPEG JFIF image; Defined in RFC 2045 and RFC 2046</span>
<span class="lineno" id=line56></span>      | pjpeg <span class="comment">//: JPEG JFIF image; Associated with Internet Explorer;</span>
<span class="lineno" id=line57></span>      | png <span class="comment">//: Portable Network Graphics; Registered,[8] Defined in RFC 2083</span>
<span class="lineno" id=line58></span>      | svg_PLUS_xml <span class="comment">//: SVG vector image; Defined in SVG Tiny 1.2 Specification Appendix M</span>
<span class="lineno" id=line59></span>      | tiff <span class="comment">// Tag Image File Format (only for Baseline TIFF); Defined in RFC 3302</span>
<span class="lineno" id=line60></span>      | vnd_DOT_microsoft_DOT_icon <span class="comment">//: ICO image; Registered[9]</span>
<span class="lineno" id=line61></span>    ;
<span class="lineno" id=line62></span>  
<span class="lineno" id=line63></span>    variant text_mime_subtype =
<span class="lineno" id=line64></span>      | cmd <span class="comment">//: commands; subtype resident in Gecko browsers like Firefox 3.5</span>
<span class="lineno" id=line65></span>      | css <span class="comment">//: Cascading Style Sheets; Defined in RFC 2318</span>
<span class="lineno" id=line66></span>      | csv <span class="comment">//: Comma-separated values; Defined in RFC 4180</span>
<span class="lineno" id=line67></span>      | html <span class="comment">//: HTML; Defined in RFC 2854</span>
<span class="lineno" id=line68></span>      | javascript1 <span class="comment">//(Obsolete): JavaScript; Defined in and obsoleted by RFC 4329</span>
<span class="lineno" id=line69></span>      | plain <span class="comment">//: Textual data; Defined in RFC 2046 and RFC 3676</span>
<span class="lineno" id=line70></span>      | vcard <span class="comment">//: vCard (contact information); Defined in RFC 6350</span>
<span class="lineno" id=line71></span>      | xml <span class="comment">//: Extensible Markup Language; Defined in RFC 3023</span>
<span class="lineno" id=line72></span>      | x_DASH_felix
<span class="lineno" id=line73></span>      | x_DASH_fdoc
<span class="lineno" id=line74></span>      | x_DASH_fpc
<span class="lineno" id=line75></span>      | x_DASH_c
<span class="lineno" id=line76></span>      | x_DASH_ocaml
<span class="lineno" id=line77></span>      | x_DASH_python
<span class="lineno" id=line78></span>    ;
<span class="lineno" id=line79></span>   
<span class="lineno" id=line80></span>    variant multipart_mime_subtype =
<span class="lineno" id=line81></span>      | mixed
<span class="lineno" id=line82></span>      | alternative
<span class="lineno" id=line83></span>      | related
<span class="lineno" id=line84></span>      | form-data
<span class="lineno" id=line85></span>      | signed
<span class="lineno" id=line86></span>      | encrypted;
<span class="lineno" id=line87></span>  
<span class="lineno" id=line88></span>    variant mime_type =
<span class="lineno" id=line89></span>      | application of application_mime_subtype
<span class="lineno" id=line90></span>      | audio of audio_mime_subtype
<span class="lineno" id=line91></span>      | image of image_mime_subtype
<span class="lineno" id=line92></span>      | text of text_mime_subtype
<span class="lineno" id=line93></span>      | multipart of multipart_mime_subtype;
<span class="lineno" id=line94></span>  
<span class="lineno" id=line95></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> media_type =  mime_type * <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>^2];
<span class="lineno" id=line96></span>  
<span class="lineno" id=line97></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[application_mime_subtype] {
<span class="lineno" id=line98></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : application_mime_subtype -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line99></span>        | #atom_PLUS_xml =&gt; <span class="fstring">"application/atom+xml"</span> 
<span class="lineno" id=line100></span>        | #ecmascript =&gt; <span class="fstring">"application/ecmascript"</span> 
<span class="lineno" id=line101></span>        | #EDI_DASH_X12 =&gt; <span class="fstring">"application/EDI-X12"</span> 
<span class="lineno" id=line102></span>        | #EDIFACT =&gt; <span class="fstring">"application/EDIFACT"</span> 
<span class="lineno" id=line103></span>        | #json =&gt; <span class="fstring">"application/json"</span> 
<span class="lineno" id=line104></span>        | #javascript =&gt; <span class="fstring">"application/javascript"</span> 
<span class="lineno" id=line105></span>        | #octet_DASH_stream =&gt; <span class="fstring">"application/octet-stream"</span> 
<span class="lineno" id=line106></span>        | #ogg =&gt; <span class="fstring">"application/ogg"</span> 
<span class="lineno" id=line107></span>        | #pdf =&gt; <span class="fstring">"application/pdf"</span> 
<span class="lineno" id=line108></span>        | #postscript =&gt; <span class="fstring">"appliction/postscript"</span> 
<span class="lineno" id=line109></span>        | #rss_PLUS_xml =&gt; <span class="fstring">"application/rss+xml"</span>
<span class="lineno" id=line110></span>        | #soap_PLUS_xml =&gt; <span class="fstring">"application/soap+xml"</span> 
<span class="lineno" id=line111></span>        | #font_DASH_woff =&gt; <span class="fstring">"application/font-woff"</span> 
<span class="lineno" id=line112></span>        | #xhtml_PLUS_xml =&gt; <span class="fstring">"application/xhtml+xml"</span>
<span class="lineno" id=line113></span>        | #xml_DASH_dtd =&gt; <span class="fstring">"application/xml-dtd"</span> 
<span class="lineno" id=line114></span>        | #xop_PLUS_xml =&gt; <span class="fstring">"application/xop+xml"</span> 
<span class="lineno" id=line115></span>        | #zip =&gt; <span class="fstring">"application/zip"</span> 
<span class="lineno" id=line116></span>        | #x_DASH_gzip =&gt; <span class="fstring">"application/x-gzip"</span> 
<span class="lineno" id=line117></span>        | #x_DASH_www_DASH_form_DASH_urlencoded =&gt; <span class="fstring">"application/x-www-form-urlencoded"</span>;
<span class="lineno" id=line118></span>   }
<span class="lineno" id=line119></span>  
<span class="lineno" id=line120></span>   <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[audio_mime_subtype] {
<span class="lineno" id=line121></span>     <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : audio_mime_subtype -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line122></span>       | #basic =&gt; <span class="fstring">"audio/basic"</span> 
<span class="lineno" id=line123></span>       | #L24 =&gt; <span class="fstring">"audio/L24"</span> 
<span class="lineno" id=line124></span>       | #mp4 =&gt; <span class="fstring">"audio/mp4"</span>
<span class="lineno" id=line125></span>       | #mpeg =&gt; <span class="fstring">"audio/mpeg"</span>
<span class="lineno" id=line126></span>       | #ogg1 =&gt; <span class="fstring">"audop/ogg"</span>
<span class="lineno" id=line127></span>       | #vorbis =&gt; <span class="fstring">"audio/vorbis"</span>
<span class="lineno" id=line128></span>       | #x_DASH_ms_DASH_wma =&gt; <span class="fstring">"audio/x-ms-wma"</span>
<span class="lineno" id=line129></span>       | #x_DASH_ms_DASH_wax =&gt; <span class="fstring">"audio/x-ms-wax"</span>
<span class="lineno" id=line130></span>       | #vnd_DOT_rn_DASH_realaudio =&gt; <span class="fstring">"audio/vnd.rn-realaudio"</span>
<span class="lineno" id=line131></span>       | #vnd_DOT_wave =&gt; <span class="fstring">"audio/vnd.wave"</span>
<span class="lineno" id=line132></span>       | #webm =&gt; <span class="fstring">"audio/webm"</span>;
<span class="lineno" id=line133></span>    }
<span class="lineno" id=line134></span>  
<span class="lineno" id=line135></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[image_mime_subtype] {
<span class="lineno" id=line136></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : image_mime_subtype -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line137></span>        | #gif =&gt; <span class="fstring">"image/gif"</span>
<span class="lineno" id=line138></span>        | #jpeg =&gt; <span class="fstring">"image/jpeg"</span>
<span class="lineno" id=line139></span>        | #pjpeg =&gt; <span class="fstring">"image/pjpeg"</span>
<span class="lineno" id=line140></span>        | #png =&gt; <span class="fstring">"image/png"</span>
<span class="lineno" id=line141></span>        | #svg_PLUS_xml =&gt; <span class="fstring">"image/svg+xml"</span>
<span class="lineno" id=line142></span>        | #tiff =&gt; <span class="fstring">"image/tiff"</span>
<span class="lineno" id=line143></span>        | #vnd_DOT_microsoft_DOT_icon =&gt; <span class="fstring">"image/vnd.microsoft.icon"</span>; 
<span class="lineno" id=line144></span>    }
<span class="lineno" id=line145></span>  
<span class="lineno" id=line146></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[text_mime_subtype] {
<span class="lineno" id=line147></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : text_mime_subtype -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line148></span>        | #cmd =&gt; <span class="fstring">"text/cmd"</span>
<span class="lineno" id=line149></span>        | #css =&gt; <span class="fstring">"text/css"</span>
<span class="lineno" id=line150></span>        | #csv =&gt; <span class="fstring">"text/csv"</span>
<span class="lineno" id=line151></span>        | #html =&gt; <span class="fstring">"text/html"</span>
<span class="lineno" id=line152></span>        | #javascript1 =&gt; <span class="fstring">"text/javascript"</span>
<span class="lineno" id=line153></span>        | #plain =&gt; <span class="fstring">"text/plain"</span>
<span class="lineno" id=line154></span>        | #vcard =&gt; <span class="fstring">"text/vcard"</span>
<span class="lineno" id=line155></span>        | #xml =&gt; <span class="fstring">"text/xml"</span>
<span class="lineno" id=line156></span>        | #x_DASH_felix =&gt; <span class="fstring">"text/x-felix"</span>
<span class="lineno" id=line157></span>        | #x_DASH_fdoc =&gt; <span class="fstring">"text/x-fdoc"</span>
<span class="lineno" id=line158></span>        | #x_DASH_fpc =&gt; <span class="fstring">"text/x-fpc"</span>
<span class="lineno" id=line159></span>        | #x_DASH_c =&gt; <span class="fstring">"text/x-c"</span>
<span class="lineno" id=line160></span>        | #x_DASH_ocaml =&gt; <span class="fstring">"text/x-ocaml"</span>
<span class="lineno" id=line161></span>        | #x_DASH_python =&gt; <span class="fstring">"text/x-python"</span>;
<span class="lineno" id=line162></span>    }
<span class="lineno" id=line163></span>    
<span class="lineno" id=line164></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[multipart_mime_subtype] {
<span class="lineno" id=line165></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : multipart_mime_subtype -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line166></span>        | #mixed =&gt; <span class="fstring">"multipart/mixed"</span>
<span class="lineno" id=line167></span>        | #alternative =&gt; <span class="fstring">"multipart/alternative"</span>
<span class="lineno" id=line168></span>        | #related =&gt; <span class="fstring">"multipart/related"</span>
<span class="lineno" id=line169></span>        | #form-data =&gt; <span class="fstring">"multipart/form-data"</span>
<span class="lineno" id=line170></span>        | #signed =&gt; <span class="fstring">"multipart/signed"</span>
<span class="lineno" id=line171></span>        | #encrypted =&gt; <span class="fstring">"multipart/encrypted"</span>;
<span class="lineno" id=line172></span>    }
<span class="lineno" id=line173></span>  
<span class="lineno" id=line174></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[mime_type] {
<span class="lineno" id=line175></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : mime_type -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line176></span>        | application  a =&gt; <span class="library" title="Convert a value to a string">str</span> a
<span class="lineno" id=line177></span>        | audio  a =&gt; <span class="library" title="Convert a value to a string">str</span> a
<span class="lineno" id=line178></span>        | image  a =&gt; <span class="library" title="Convert a value to a string">str</span> a
<span class="lineno" id=line179></span>        | text  a =&gt; <span class="library" title="Convert a value to a string">str</span> a
<span class="lineno" id=line180></span>        | multipart  a =&gt; <span class="library" title="Convert a value to a string">str</span> a;
<span class="lineno" id=line181></span>    }
<span class="lineno" id=line182></span>  
<span class="lineno" id=line183></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> application_type_from_str : <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="option type: Some x or None">opt</span>[application_mime_subtype] =
<span class="lineno" id=line184></span>      | <span class="fstring">"application/atom+xml"</span>     =&gt; Some atom_PLUS_xml 
<span class="lineno" id=line185></span>      | <span class="fstring">"application/ecmascript"</span>   =&gt; Some ecmascript 
<span class="lineno" id=line186></span>      | <span class="fstring">"application/EDI-X12"</span>      =&gt; Some EDI_DASH_X12 
<span class="lineno" id=line187></span>      | <span class="fstring">"application/EDIFACT"</span>      =&gt; Some EDIFACT 
<span class="lineno" id=line188></span>      | <span class="fstring">"application/json"</span>         =&gt; Some json 
<span class="lineno" id=line189></span>      | <span class="fstring">"application/javascript"</span>   =&gt; Some javascript 
<span class="lineno" id=line190></span>      | <span class="fstring">"application/octet-stream"</span> =&gt; Some octet_DASH_stream 
<span class="lineno" id=line191></span>      | <span class="fstring">"application/ogg"</span>          =&gt; Some ogg 
<span class="lineno" id=line192></span>      | <span class="fstring">"application/pdf"</span>          =&gt; Some pdf 
<span class="lineno" id=line193></span>      | <span class="fstring">"appliction/postscript"</span>    =&gt; Some postscript 
<span class="lineno" id=line194></span>      | <span class="fstring">"application/rss+xml"</span>      =&gt; Some rss_PLUS_xml 
<span class="lineno" id=line195></span>      | <span class="fstring">"application/soap+xml"</span>     =&gt; Some soap_PLUS_xml 
<span class="lineno" id=line196></span>      | <span class="fstring">"application/font-woff"</span>    =&gt; Some font_DASH_woff 
<span class="lineno" id=line197></span>      | <span class="fstring">"application/xhtml+xml"</span>    =&gt; Some xhtml_PLUS_xml 
<span class="lineno" id=line198></span>      | <span class="fstring">"application/xml-dtd"</span>      =&gt; Some xml_DASH_dtd 
<span class="lineno" id=line199></span>      | <span class="fstring">"application/xop+xml"</span>      =&gt; Some xop_PLUS_xml 
<span class="lineno" id=line200></span>      | <span class="fstring">"application/zip"</span>          =&gt; Some zip 
<span class="lineno" id=line201></span>      | <span class="fstring">"application/x-gzip"</span>       =&gt; Some x_DASH_gzip
<span class="lineno" id=line202></span>      | <span class="fstring">"application/x-www-form-urlencoded"</span> =&gt; Some x_DASH_www_DASH_form_DASH_urlencoded
<span class="lineno" id=line203></span>      | _                          =&gt; None[application_mime_subtype];
<span class="lineno" id=line204></span>    
<span class="lineno" id=line205></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> audio_type_from_str : <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="option type: Some x or None">opt</span>[audio_mime_subtype] =
<span class="lineno" id=line206></span>      |  <span class="fstring">"audio/basic"</span> =&gt; Some basic
<span class="lineno" id=line207></span>      |  <span class="fstring">"audio/L24"</span> =&gt; Some L24
<span class="lineno" id=line208></span>      |  <span class="fstring">"audio/mp4"</span> =&gt; Some mp4
<span class="lineno" id=line209></span>      |  <span class="fstring">"audio/mpeg"</span> =&gt; Some mpeg
<span class="lineno" id=line210></span>      |  <span class="fstring">"audop/ogg"</span> =&gt; Some ogg1
<span class="lineno" id=line211></span>      |  <span class="fstring">"audio/vorbis"</span> =&gt; Some vorbis
<span class="lineno" id=line212></span>      |  <span class="fstring">"audio/x-ms-wma"</span> =&gt; Some x_DASH_ms_DASH_wma
<span class="lineno" id=line213></span>      |  <span class="fstring">"audio/x-ms-wax"</span> =&gt; Some x_DASH_ms_DASH_wax
<span class="lineno" id=line214></span>      |  <span class="fstring">"audio/vnd.rn-realaudio"</span> =&gt; Some vnd_DOT_rn_DASH_realaudio
<span class="lineno" id=line215></span>      |  <span class="fstring">"audio/vnd.wave"</span> =&gt; Some vnd_DOT_wave
<span class="lineno" id=line216></span>      |  <span class="fstring">"audio/webm"</span> =&gt; Some webm 
<span class="lineno" id=line217></span>      |  _ =&gt; None[audio_mime_subtype] ;
<span class="lineno" id=line218></span>  
<span class="lineno" id=line219></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> image_type_from_str : <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="option type: Some x or None">opt</span>[image_mime_subtype] =
<span class="lineno" id=line220></span>      | <span class="fstring">"image/gif"</span> =&gt; Some gif 
<span class="lineno" id=line221></span>      | <span class="fstring">"image/jpeg"</span> =&gt; Some jpeg 
<span class="lineno" id=line222></span>      | <span class="fstring">"image/pjpeg"</span> =&gt; Some pjpeg 
<span class="lineno" id=line223></span>      | <span class="fstring">"image/png"</span> =&gt; Some png 
<span class="lineno" id=line224></span>      | <span class="fstring">"image/svg+xml"</span> =&gt; Some svg_PLUS_xml 
<span class="lineno" id=line225></span>      | <span class="fstring">"image/tiff"</span> =&gt; Some tiff 
<span class="lineno" id=line226></span>      | <span class="fstring">"image/vnd.microsoft.icon"</span> =&gt; Some vnd_DOT_microsoft_DOT_icon 
<span class="lineno" id=line227></span>      | _ =&gt; None[image_mime_subtype]; 
<span class="lineno" id=line228></span>    
<span class="lineno" id=line229></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> text_type_from_str : <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="option type: Some x or None">opt</span>[text_mime_subtype] =
<span class="lineno" id=line230></span>      | <span class="fstring">"text/cmd"</span> =&gt; Some cmd 
<span class="lineno" id=line231></span>      | <span class="fstring">"text/css"</span> =&gt; Some css 
<span class="lineno" id=line232></span>      | <span class="fstring">"text/csv"</span> =&gt; Some csv 
<span class="lineno" id=line233></span>      | <span class="fstring">"text/html"</span> =&gt; Some html 
<span class="lineno" id=line234></span>      | <span class="fstring">"text/javascript"</span> =&gt; Some javascript1 
<span class="lineno" id=line235></span>      | <span class="fstring">"text/plain"</span> =&gt; Some plain 
<span class="lineno" id=line236></span>      | <span class="fstring">"text/vcard"</span> =&gt; Some vcard 
<span class="lineno" id=line237></span>      | <span class="fstring">"text/xml"</span> =&gt; Some xml 
<span class="lineno" id=line238></span>      | <span class="fstring">"text/x-felix"</span> =&gt; Some x_DASH_felix
<span class="lineno" id=line239></span>      | <span class="fstring">"text/x-fdoc"</span> =&gt; Some x_DASH_fdoc
<span class="lineno" id=line240></span>      | <span class="fstring">"text/x-fpc"</span> =&gt;  Some x_DASH_fpc
<span class="lineno" id=line241></span>      | <span class="fstring">"text/x-c"</span>  =&gt; Some x_DASH_c
<span class="lineno" id=line242></span>      | <span class="fstring">"text/x-ocaml"</span>  =&gt; Some x_DASH_ocaml
<span class="lineno" id=line243></span>      | <span class="fstring">"text/x-python"</span> =&gt; Some x_DASH_python
<span class="lineno" id=line244></span>      | _ =&gt; None[text_mime_subtype];
<span class="lineno" id=line245></span>  
<span class="lineno" id=line246></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> multipart_type_from_str : <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="option type: Some x or None">opt</span>[multipart_mime_subtype] =
<span class="lineno" id=line247></span>      | <span class="fstring">"multipart/mixed"</span> =&gt; Some mixed
<span class="lineno" id=line248></span>      | <span class="fstring">"multipart/alternative"</span> =&gt; Some alternative
<span class="lineno" id=line249></span>      | <span class="fstring">"multipart/related"</span> =&gt; Some related
<span class="lineno" id=line250></span>      | <span class="fstring">"multipart/form-data"</span> =&gt; Some form-data
<span class="lineno" id=line251></span>      | <span class="fstring">"multipart/signed"</span> =&gt; Some signed
<span class="lineno" id=line252></span>      | <span class="fstring">"multipart/encrypted"</span> =&gt; Some encrypted
<span class="lineno" id=line253></span>    ;
<span class="lineno" id=line254></span>  
<span class="lineno" id=line255></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> from_str (s:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="option type: Some x or None">opt</span>[mime_type] =&gt; 
<span class="lineno" id=line256></span>      <span class="small_keyword" title="match statement or expression">match</span> application_type_from_str s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line257></span>        | Some t =&gt; Some (application t)
<span class="lineno" id=line258></span>        | #None =&gt; <span class="small_keyword" title="match statement or expression">match</span> audio_type_from_str s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line259></span>          | Some t =&gt;  Some (audio t)
<span class="lineno" id=line260></span>          | #None =&gt; <span class="small_keyword" title="match statement or expression">match</span> image_type_from_str s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line261></span>             | Some t =&gt; Some (image t)
<span class="lineno" id=line262></span>             | #None =&gt; <span class="small_keyword" title="match statement or expression">match</span> text_type_from_str s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line263></span>               | Some t =&gt; Some (text t)
<span class="lineno" id=line264></span>               | #None =&gt; <span class="small_keyword" title="match statement or expression">match</span> multipart_type_from_str s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line265></span>                 | Some t =&gt; Some (multipart t)
<span class="lineno" id=line266></span>                 | #None =&gt; None[mime_type]
<span class="lineno" id=line267></span>               <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line268></span>             <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line269></span>           <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line270></span>         <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line271></span>       <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line272></span>    
<span class="lineno" id=line273></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> mime_type_from_file(file:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line274></span>      <span class="small_keyword" title="match statement or expression">match</span> unbox (<span class="library" title="return data structure with elements reversed">rev</span>(split(file,<span class="fstring">'.'</span>))) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line275></span>      | Cons(hd,_) =&gt; mime_type_from_extension hd
<span class="lineno" id=line276></span>      | _ =&gt; text plain
<span class="lineno" id=line277></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line278></span>  
<span class="lineno" id=line279></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> mime_type_from_extension: <span class="library" title="binding of C++ string type">string</span> -&gt; mime_type =
<span class="lineno" id=line280></span>      | <span class="fstring">"atom"</span> =&gt; application atom_PLUS_xml 
<span class="lineno" id=line281></span>      | <span class="fstring">"ecma"</span> =&gt; application ecmascript 
<span class="lineno" id=line282></span>      | <span class="fstring">"json"</span> =&gt; application json 
<span class="lineno" id=line283></span>      | <span class="fstring">"js"</span> =&gt; application javascript 
<span class="lineno" id=line284></span>      | <span class="fstring">"application/octet-stream"</span> =&gt; application octet_DASH_stream 
<span class="lineno" id=line285></span>      | <span class="fstring">"ogg"</span> =&gt; application ogg 
<span class="lineno" id=line286></span>      | <span class="fstring">"ogx"</span> =&gt; application ogg 
<span class="lineno" id=line287></span>      | <span class="fstring">"pdf"</span> =&gt; application pdf 
<span class="lineno" id=line288></span>      | <span class="fstring">"ps"</span> =&gt; application postscript 
<span class="lineno" id=line289></span>      | <span class="fstring">"eps"</span> =&gt; application postscript 
<span class="lineno" id=line290></span>      | <span class="fstring">"ai"</span> =&gt; application postscript 
<span class="lineno" id=line291></span>      | <span class="fstring">"xhtml"</span> =&gt; application xhtml_PLUS_xml 
<span class="lineno" id=line292></span>      | <span class="fstring">"xht"</span> =&gt; application xhtml_PLUS_xml 
<span class="lineno" id=line293></span>      | <span class="fstring">"dtd"</span> =&gt; application xml_DASH_dtd 
<span class="lineno" id=line294></span>      | <span class="fstring">"xop"</span> =&gt; application xop_PLUS_xml 
<span class="lineno" id=line295></span>      | <span class="fstring">"zip"</span> =&gt; application zip 
<span class="lineno" id=line296></span>      | <span class="fstring">"x-gzip"</span> =&gt; application x_DASH_gzip
<span class="lineno" id=line297></span>      | <span class="fstring">"au"</span> =&gt; audio basic
<span class="lineno" id=line298></span>      | <span class="fstring">"snd"</span> =&gt; audio basic
<span class="lineno" id=line299></span>      | <span class="fstring">"mp4a"</span> =&gt; audio mp4
<span class="lineno" id=line300></span>      | <span class="fstring">"mpega"</span> =&gt; audio mpeg
<span class="lineno" id=line301></span>      | <span class="fstring">"mpga"</span> =&gt; audio mpeg
<span class="lineno" id=line302></span>      | <span class="fstring">"mp2a"</span> =&gt; audio mpeg
<span class="lineno" id=line303></span>      | <span class="fstring">"mp3a"</span> =&gt; audio mpeg
<span class="lineno" id=line304></span>      | <span class="fstring">"mp4a"</span> =&gt; audio mpeg
<span class="lineno" id=line305></span>      | <span class="fstring">"mp2"</span> =&gt; audio mpeg
<span class="lineno" id=line306></span>      | <span class="fstring">"mp3"</span> =&gt; audio mpeg
<span class="lineno" id=line307></span>      | <span class="fstring">"ogg"</span> =&gt; audio ogg1
<span class="lineno" id=line308></span>      | <span class="fstring">"oga"</span> =&gt; audio ogg1
<span class="lineno" id=line309></span>      | <span class="fstring">"spx"</span> =&gt; audio ogg1
<span class="lineno" id=line310></span>      | <span class="fstring">"wma"</span> =&gt; audio x_DASH_ms_DASH_wma
<span class="lineno" id=line311></span>      | <span class="fstring">"wax"</span> =&gt; audio x_DASH_ms_DASH_wax
<span class="lineno" id=line312></span>      | <span class="fstring">"ra"</span> =&gt; audio vnd_DOT_rn_DASH_realaudio
<span class="lineno" id=line313></span>      | <span class="fstring">"wav"</span> =&gt; audio vnd_DOT_wave
<span class="lineno" id=line314></span>      | <span class="fstring">"webma"</span> =&gt; audio webm 
<span class="lineno" id=line315></span>      | <span class="fstring">"gif"</span> =&gt; image gif 
<span class="lineno" id=line316></span>      | <span class="fstring">"image/jpeg"</span> =&gt; image jpeg 
<span class="lineno" id=line317></span>      | <span class="fstring">"jpg"</span> =&gt; image jpeg 
<span class="lineno" id=line318></span>      | <span class="fstring">"pjpeg"</span> =&gt; image pjpeg 
<span class="lineno" id=line319></span>      | <span class="fstring">"png"</span> =&gt; image png 
<span class="lineno" id=line320></span>      | <span class="fstring">"svg"</span> =&gt; image svg_PLUS_xml 
<span class="lineno" id=line321></span>      | <span class="fstring">"tiff"</span> =&gt; image tiff 
<span class="lineno" id=line322></span>      | <span class="fstring">"css"</span> =&gt; text css 
<span class="lineno" id=line323></span>      | <span class="fstring">"csv"</span> =&gt; text csv 
<span class="lineno" id=line324></span>      | <span class="fstring">"html"</span> =&gt; text html 
<span class="lineno" id=line325></span>      | <span class="fstring">"htm"</span> =&gt; text html 
<span class="lineno" id=line326></span>      | <span class="fstring">"shtm"</span> =&gt; text html 
<span class="lineno" id=line327></span>      | <span class="fstring">"text/plain"</span> =&gt; text plain 
<span class="lineno" id=line328></span>      | <span class="fstring">"asc"</span> =&gt; text plain 
<span class="lineno" id=line329></span>      | <span class="fstring">"conf"</span> =&gt; text plain 
<span class="lineno" id=line330></span>      | <span class="fstring">"def"</span> =&gt; text plain 
<span class="lineno" id=line331></span>      | <span class="fstring">"diff"</span> =&gt; text plain 
<span class="lineno" id=line332></span>      | <span class="fstring">"in"</span> =&gt; text plain 
<span class="lineno" id=line333></span>      | <span class="fstring">"list"</span> =&gt; text plain 
<span class="lineno" id=line334></span>      | <span class="fstring">"log"</span> =&gt; text plain 
<span class="lineno" id=line335></span>      | <span class="fstring">"pot"</span> =&gt; text plain 
<span class="lineno" id=line336></span>      | <span class="fstring">"text"</span> =&gt; text plain 
<span class="lineno" id=line337></span>      | <span class="fstring">"txt"</span> =&gt; text plain 
<span class="lineno" id=line338></span>      | _ =&gt; text plain
<span class="lineno" id=line339></span>    ;
<span class="lineno" id=line340></span>  
<span class="lineno" id=line341></span>          
<span class="lineno" id=line342></span>  <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Eq[mime_type]  {
<span class="lineno" id=line343></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> == : mime_type * mime_type -&gt; bool = <span class="fstring">"$1==$2"</span>;
<span class="lineno" id=line344></span>  }
<span class="lineno" id=line345></span>  
<span class="lineno" id=line346></span>  
<span class="lineno" id=line347></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_media_type (s:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="option type: Some x or None">opt</span>[media_type] =&gt;
<span class="lineno" id=line348></span>      <span class="small_keyword" title="match statement or expression">match</span> split( s, <span class="fstring">";"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line349></span>      | Cons(h,t) =&gt; 
<span class="lineno" id=line350></span>        <span class="small_keyword" title="match statement or expression">match</span> from_str(h) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line351></span>        | Some m =&gt; Some (m,parse_attribute_list(t))
<span class="lineno" id=line352></span>        | _       =&gt; None[media_type]
<span class="lineno" id=line353></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span> 
<span class="lineno" id=line354></span>      | _ =&gt; None[media_type]
<span class="lineno" id=line355></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line356></span>    ;
<span class="lineno" id=line357></span>  
<span class="lineno" id=line358></span>  <span class="comment">//instance Tord[test_mime_subtype] {</span>
<span class="lineno" id=line359></span>  <span class="comment">//    fun eq: t * t -&gt; bool = "$1==$2";</span>
<span class="lineno" id=line360></span>  <span class="comment">//}</span>
<span class="lineno" id=line361></span>  <span class="comment">//open Tord[text_mime_subtype];</span>
<span class="lineno" id=line362></span>  <span class="big_keyword" title="Open a module or class">open</span> Tord[mime_type];
<span class="lineno" id=line363></span>  <span class="comment">/*
<span class="lineno" id=line364></span>  Other unimplemented types:
<span class="lineno" id=line365></span>  Type message
<span class="lineno" id=line366></span>  message/http: Defined in RFC 2616
<span class="lineno" id=line367></span>  message/imdn+xml: IMDN Instant Message Disposition Notification; Defined in RFC 5438
<span class="lineno" id=line368></span>  message/partial: Email; Defined in RFC 2045 and RFC 2046
<span class="lineno" id=line369></span>  message/rfc822: Email; EML files, MIME files, MHT files, MHTML files; Defined in RFC 2045 and RFC 2046
<span class="lineno" id=line370></span>  Type model
<span class="lineno" id=line371></span>  For 3D models.
<span class="lineno" id=line372></span>  model/example: Defined in RFC 4735
<span class="lineno" id=line373></span>  model/iges: IGS files, IGES files; Defined in RFC 2077
<span class="lineno" id=line374></span>  model/mesh: MSH files, MESH files; Defined in RFC 2077, SILO files
<span class="lineno" id=line375></span>  model/vrml: WRL files, VRML files; Defined in RFC 2077
<span class="lineno" id=line376></span>  model/x3d+binary: X3D ISO standard for representing 3D computer graphics, X3DB binary files
<span class="lineno" id=line377></span>  model/x3d+vrml: X3D ISO standard for representing 3D computer graphics, X3DV VRML files
<span class="lineno" id=line378></span>  model/x3d+xml: X3D ISO standard for representing 3D computer graphics, X3D XML files
<span class="lineno" id=line379></span>  Type multipart
<span class="lineno" id=line380></span>  Type video
<span class="lineno" id=line381></span>  For video.
<span class="lineno" id=line382></span>  video/mpeg: MPEG-1 video with multiplexed audio; Defined in RFC 2045 and RFC 2046
<span class="lineno" id=line383></span>  video/mp4: MP4 video; Defined in RFC 4337
<span class="lineno" id=line384></span>  video/ogg: Ogg Theora or other video (with audio); Defined in RFC 5334
<span class="lineno" id=line385></span>  video/quicktime: QuickTime video; Registered[10]
<span class="lineno" id=line386></span>  video/webm: WebM Matroska-based open media format
<span class="lineno" id=line387></span>  video/x-matroska: Matroska open media format
<span class="lineno" id=line388></span>  video/x-ms-wmv: Windows Media Video; Documented in Microsoft KB 288102
<span class="lineno" id=line389></span>  Type vnd
<span class="lineno" id=line390></span>  For vendor-specific files.
<span class="lineno" id=line391></span>  application/vnd.oasis.opendocument.text: OpenDocument Text; Registered[11]
<span class="lineno" id=line392></span>  application/vnd.oasis.opendocument.spreadsheet: OpenDocument Spreadsheet; Registered[12]
<span class="lineno" id=line393></span>  application/vnd.oasis.opendocument.presentation: OpenDocument Presentation; Registered[13]
<span class="lineno" id=line394></span>  application/vnd.oasis.opendocument.graphics: OpenDocument Graphics; Registered[14]
<span class="lineno" id=line395></span>  application/vnd.ms-excel: Microsoft Excel files
<span class="lineno" id=line396></span>  application/vnd.openxmlformats-officedocument.spreadsheetml.sheet: Microsoft Excel 2007 files
<span class="lineno" id=line397></span>  application/vnd.ms-powerpoint: Microsoft Powerpoint files
<span class="lineno" id=line398></span>  application/vnd.openxmlformats-officedocument.presentationml.presentation: Microsoft Powerpoint 2007 files
<span class="lineno" id=line399></span>  application/msword: Microsoft Word files
<span class="lineno" id=line400></span>  application/vnd.openxmlformats-officedocument.wordprocessingml.document: Microsoft Word 2007 files
<span class="lineno" id=line401></span>  application/vnd.mozilla.xul+xml: Mozilla XUL files
<span class="lineno" id=line402></span>  application/vnd.google-earth.kml+xml: KML files (e.g. for Google Earth)
<span class="lineno" id=line403></span>  Type x
<span class="lineno" id=line404></span>  For non-standard files.
<span class="lineno" id=line405></span>  application/x-www-form-urlencoded Form Encoded Data; Documented in HTML 4.01 Specification, Section 17.13.4.1
<span class="lineno" id=line406></span>  application/x-dvi: device-independent document in DVI format
<span class="lineno" id=line407></span>  application/x-latex: LaTeX files
<span class="lineno" id=line408></span>  application/x-font-ttf: TrueType Font No registered MIME type, but this is the most commonly used
<span class="lineno" id=line409></span>  application/x-shockwave-flash: Adobe Flash files for example with the extension .swf
<span class="lineno" id=line410></span>  application/x-stuffit: StuffIt archive files
<span class="lineno" id=line411></span>  application/x-rar-compressed: RAR archive files
<span class="lineno" id=line412></span>  application/x-tar: Tarball files
<span class="lineno" id=line413></span>  text/x-gwt-rpc: GoogleWebToolkit data
<span class="lineno" id=line414></span>  text/x-jquery-tmpl: jQuery template data
<span class="lineno" id=line415></span>  application/x-javascript:
<span class="lineno" id=line416></span>  application/x-deb: deb_(file_format), a software package format used by the Debian project
<span class="lineno" id=line417></span>  [edit]Type x-pkcs
<span class="lineno" id=line418></span>  For PKCS standard files.
<span class="lineno" id=line419></span>  application/x-pkcs12: p12 files
<span class="lineno" id=line420></span>  application/x-pkcs12: pfx files
<span class="lineno" id=line421></span>  application/x-pkcs7-certificates: p7b files
<span class="lineno" id=line422></span>  application/x-pkcs7-certificates: spc files
<span class="lineno" id=line423></span>  application/x-pkcs7-certreqresp: p7r files
<span class="lineno" id=line424></span>  application/x-pkcs7-mime: p7c files
<span class="lineno" id=line425></span>  application/x-pkcs7-mime: p7m files
<span class="lineno" id=line426></span>  application/x-pkcs7-signature: p7s files
<span class="lineno" id=line427></span>  */</span>
<span class="lineno" id=line428></span>  }
<span class="lineno" id=line429></span>  
</pre></p><pre class='inclusion'>
share/lib/web/cookie.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/low_res_time"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> Cookie {
<span class="lineno" id=line4></span>    <span class="big_keyword" title="Open a module or class">open</span> LowResTime;
<span class="lineno" id=line5></span>    <span class="big_keyword" title="Open a module or class">open</span> WebUtil;
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Define a structure">struct</span> cookie {
<span class="lineno" id=line8></span>      name:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line9></span>      value:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line10></span>      domain:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line11></span>      path:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line12></span>      expires:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line13></span>      secure:bool;
<span class="lineno" id=line14></span>      http_only:bool;
<span class="lineno" id=line15></span>    }
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_cookie (n:<span class="library" title="binding of C++ string type">string</span>,v:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line18></span>      <span class="big_keyword" title="Define a mutable variable">var</span> c:cookie;c&amp;.name&lt;-n;c&amp;.value&lt;-v;<span class="small_keyword" title="return">return</span> c;}
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>  
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[cookie] {
<span class="lineno" id=line23></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> (c:cookie) =&gt; c.name+<span class="fstring">"="</span>+c.value+<span class="fstring">"; "</span>+<span class="small_keyword" title="match statement or expression">match</span> c.domain <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line24></span>        |<span class="fstring">''</span> =&gt; <span class="fstring">' '</span> | d =&gt; <span class="fstring">"Domain="</span>+d+<span class="fstring">"; "</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>+
<span class="lineno" id=line25></span>        <span class="small_keyword" title="match statement or expression">match</span> c.path <span class="small_keyword" title="type-class constraint">with</span> |<span class="fstring">''</span> =&gt; <span class="fstring">' '</span> |p =&gt; <span class="fstring">"Path="</span>+p+<span class="fstring">"; "</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>+
<span class="lineno" id=line26></span>        <span class="small_keyword" title="match statement or expression">match</span> c.expires <span class="small_keyword" title="type-class constraint">with</span> |<span class="fstring">''</span> =&gt; <span class="fstring">' '</span> |e =&gt; <span class="fstring">" Expires="</span>+e+<span class="fstring">"; "</span> <span class="small_keyword" title="end a match statement or expression">endmatch</span>+
<span class="lineno" id=line27></span>        (<span class="small_keyword" title="conditional">if</span> c.secure <span class="small_keyword" title="conditional">then</span> <span class="fstring">"Secure; "</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">" "</span> <span class="small_keyword" title="conditional">endif</span>)+
<span class="lineno" id=line28></span>        (<span class="small_keyword" title="conditional">if</span> c.http_only <span class="small_keyword" title="conditional">then</span> <span class="fstring">"HttpOnly;"</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span>);
<span class="lineno" id=line29></span>    }
<span class="lineno" id=line30></span>  
<span class="lineno" id=line31></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> set_cookie (c:cookie):<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span> =&gt; (<span class="fstring">"Set-Cookie"</span>,<span class="library" title="Convert a value to a string">str</span>(c));
<span class="lineno" id=line32></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> set_cookies (c:<span class="library" title="functional, singly linked list">list</span>[cookie]):<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span> =&gt; (<span class="fstring">"Set-Cookie"</span>,
<span class="lineno" id=line33></span>      <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(x:<span class="library" title="binding of C++ string type">string</span>) (y:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> =&gt; y +<span class="fstring">"\r"</span>+ x) <span class="fstring">""</span> 
<span class="lineno" id=line34></span>        (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(z:cookie):<span class="library" title="binding of C++ string type">string</span> =&gt; <span class="library" title="Convert a value to a string">str</span>(z)) c));
<span class="lineno" id=line35></span>  
<span class="lineno" id=line36></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/low_res_time.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> LowResTime
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Open a module or class">open</span> <span class="hack">C_hack</span>;
<span class="lineno" id=line4></span>    
<span class="lineno" id=line5></span>    <span class="big_keyword" title="specify requirements">requires</span> C89_headers::time_h;
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> time_t = <span class="fstring">"time_t"</span>;
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> +: time_t*time_t -&gt; time_t = <span class="fstring">"$1+$2"</span>;
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> +: time_t*<span class="library" title="binding of C int type">int</span> -&gt; time_t = <span class="fstring">"$1+(time_t)$2"</span>;
<span class="lineno" id=line10></span>  
<span class="lineno" id=line11></span>    <span class="doccomment">Current time</span>
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> time: &amp;time_t = <span class="fstring">"time($1);"</span>;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>    <span class="doccomment">Current time</span>
<span class="lineno" id=line15></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> time_t () = {
<span class="lineno" id=line16></span>      <span class="big_keyword" title="Define a mutable variable">var</span> time_v:time_t;
<span class="lineno" id=line17></span>      time(&amp;time_v);
<span class="lineno" id=line18></span>      <span class="small_keyword" title="return">return</span> time_v;
<span class="lineno" id=line19></span>    }
<span class="lineno" id=line20></span>   
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>    <span class="comment">// cast integer (in second since epoch) to time</span>
<span class="lineno" id=line23></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> time_t: !ints = <span class="fstring">"(time_t)$1:cast"</span> is cast;
<span class="lineno" id=line24></span>  
<span class="lineno" id=line25></span>    <span class="big_keyword" title="Provide a model for an existing C struct">cstruct</span> tm {
<span class="lineno" id=line26></span>      tm_sec:<span class="library" title="binding of C int type">int</span>;         <span class="comment">/* seconds */</span>
<span class="lineno" id=line27></span>      tm_min:<span class="library" title="binding of C int type">int</span>;         <span class="comment">/* minutes */</span>
<span class="lineno" id=line28></span>      tm_hour:<span class="library" title="binding of C int type">int</span>;        <span class="comment">/* hours */</span>
<span class="lineno" id=line29></span>      tm_mday:<span class="library" title="binding of C int type">int</span>;        <span class="comment">/* day of the month */</span>
<span class="lineno" id=line30></span>      tm_mon:<span class="library" title="binding of C int type">int</span>;         <span class="comment">/* month */</span>
<span class="lineno" id=line31></span>      tm_year:<span class="library" title="binding of C int type">int</span>;        <span class="comment">/* year */</span>
<span class="lineno" id=line32></span>      tm_wday:<span class="library" title="binding of C int type">int</span>;        <span class="comment">/* day of the week */</span>
<span class="lineno" id=line33></span>      tm_yday:<span class="library" title="binding of C int type">int</span>;        <span class="comment">/* day in the year */</span>
<span class="lineno" id=line34></span>      tm_isdst:<span class="library" title="binding of C int type">int</span>;       <span class="comment">/* daylight saving time */</span>
<span class="lineno" id=line35></span>    };
<span class="lineno" id=line36></span>  
<span class="lineno" id=line37></span>    
<span class="lineno" id=line38></span>  <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line39></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> gmtime:&amp;time_t * &amp;tm = <span class="fstring">"gmtime_s($2,$1);"</span>;
<span class="lineno" id=line40></span>  <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line41></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> gmtime:&amp;time_t * &amp;tm = <span class="fstring">"gmtime_r($1,$2);"</span>;
<span class="lineno" id=line42></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line43></span>  
<span class="lineno" id=line44></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> gmtime (<span class="big_keyword" title="Define a mutable variable">var</span> t:time_t) :tm =
<span class="lineno" id=line45></span>    {
<span class="lineno" id=line46></span>      <span class="big_keyword" title="Define a mutable variable">var</span> atm : tm; gmtime (&amp;t, &amp;atm);
<span class="lineno" id=line47></span>      <span class="small_keyword" title="return">return</span> atm;
<span class="lineno" id=line48></span>    }
<span class="lineno" id=line49></span>  
<span class="lineno" id=line50></span>  <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line51></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> localtime:&amp;time_t * &amp;tm = <span class="fstring">"localtime_s($2,$1);"</span>;
<span class="lineno" id=line52></span>  <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line53></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> localtime:&amp;time_t * &amp;tm = <span class="fstring">"localtime_r($1,$2);"</span>;
<span class="lineno" id=line54></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line55></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> localtime (<span class="big_keyword" title="Define a mutable variable">var</span> t:time_t) :tm =
<span class="lineno" id=line56></span>    {
<span class="lineno" id=line57></span>      <span class="big_keyword" title="Define a mutable variable">var</span> atm : tm; localtime (&amp;t, &amp;atm);
<span class="lineno" id=line58></span>      <span class="small_keyword" title="return">return</span> atm;
<span class="lineno" id=line59></span>    }
<span class="lineno" id=line60></span>  
<span class="lineno" id=line61></span>    <span class="big_keyword" title="Specify C code to be inserted into header file">header</span> """<span class="embedded_c">
<span class="lineno" id=line62></span>      string asctime_helper(<span class="big_keyword">struct</span> tm <span class="qualifier">const</span> * ti);
<span class="lineno" id=line63></span>    </span>""";
<span class="lineno" id=line64></span>  
<span class="lineno" id=line65></span>  <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line66></span>    <span class="big_keyword" title="Specify C code to be inserted into implementation file">body</span> """<span class="embedded_c">
<span class="lineno" id=line67></span>      string asctime_helper(<span class="big_keyword">struct</span> tm <span class="qualifier">const</span> * ti) {
<span class="lineno" id=line68></span>        <span class="qualifier">int</span> len = 64;
<span class="lineno" id=line69></span>        <span class="qualifier">char</span> *fmted = (<span class="qualifier">char</span>*) ::<span class="small_keyword">std</span>::malloc(sizeof(<span class="qualifier">char</span>)*64);
<span class="lineno" id=line70></span>        asctime_s(fmted,64,ti);
<span class="lineno" id=line71></span>        string s = string(fmted);
<span class="lineno" id=line72></span>        ::<span class="small_keyword">std</span>::free(fmted);
<span class="lineno" id=line73></span>        <span class="small_keyword">return</span> s;
<span class="lineno" id=line74></span>      }
<span class="lineno" id=line75></span>    </span>""";
<span class="lineno" id=line76></span>  <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line77></span>    <span class="big_keyword" title="Specify C code to be inserted into implementation file">body</span> """<span class="embedded_c">
<span class="lineno" id=line78></span>      string asctime_helper(<span class="big_keyword">struct</span> tm <span class="qualifier">const</span> * ti) {
<span class="lineno" id=line79></span>        <span class="qualifier">int</span> len = 64;
<span class="lineno" id=line80></span>        <span class="qualifier">char</span> *fmted = (<span class="qualifier">char</span>*) ::<span class="small_keyword">std</span>::malloc(sizeof(<span class="qualifier">char</span>)*64);
<span class="lineno" id=line81></span>        asctime_r(ti,fmted);
<span class="lineno" id=line82></span>        string s = string(fmted);
<span class="lineno" id=line83></span>        ::<span class="small_keyword">std</span>::free(fmted);
<span class="lineno" id=line84></span>        <span class="small_keyword">return</span> s;
<span class="lineno" id=line85></span>      }
<span class="lineno" id=line86></span>    </span>""";
<span class="lineno" id=line87></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line88></span>  
<span class="lineno" id=line89></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> asctime:&amp;tm -&gt; <span class="library" title="binding of C++ string type">string</span> = <span class="fstring">"asctime_helper($1)"</span>;
<span class="lineno" id=line90></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> asctime (<span class="big_keyword" title="Define a mutable variable">var</span> t:tm) : <span class="library" title="binding of C++ string type">string</span> =&gt; asctime (&amp;t);
<span class="lineno" id=line91></span>  
<span class="lineno" id=line92></span>    <span class="big_keyword" title="Specify C code to be inserted into header file">header</span> """<span class="embedded_c">
<span class="lineno" id=line93></span>      string strftime_helper(<span class="qualifier">const</span> <span class="qualifier">char</span> *pat,    <span class="qualifier">const</span> <span class="big_keyword">struct</span> tm * ti);
<span class="lineno" id=line94></span>    </span>""";
<span class="lineno" id=line95></span>  
<span class="lineno" id=line96></span>    <span class="big_keyword" title="Specify C code to be inserted into implementation file">body</span> """<span class="embedded_c">
<span class="lineno" id=line97></span>      string strftime_helper(<span class="qualifier">const</span> <span class="qualifier">char</span> *pat,    <span class="qualifier">const</span> <span class="big_keyword">struct</span> tm * ti) {
<span class="lineno" id=line98></span>        <span class="qualifier">int</span> len = 64;
<span class="lineno" id=line99></span>        <span class="qualifier">char</span> *fmted = (<span class="qualifier">char</span>*) ::<span class="small_keyword">std</span>::malloc(sizeof(<span class="qualifier">char</span>)*64);
<span class="lineno" id=line100></span>        strftime(fmted,len,pat,ti);
<span class="lineno" id=line101></span>        string s = string(fmted);
<span class="lineno" id=line102></span>        ::<span class="small_keyword">std</span>::free(fmted);
<span class="lineno" id=line103></span>        <span class="small_keyword">return</span> s;
<span class="lineno" id=line104></span>      }
<span class="lineno" id=line105></span>    </span>""";
<span class="lineno" id=line106></span>  
<span class="lineno" id=line107></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> strftime: <span class="library" title="binding of C++ string type">string</span> * &amp;tm -&gt; <span class="library" title="binding of C++ string type">string</span> = <span class="fstring">"strftime_helper(($1.c_str()),$2)"</span>;
<span class="lineno" id=line108></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> strftime (fmt: <span class="library" title="binding of C++ string type">string</span>, <span class="big_keyword" title="Define a mutable variable">var</span> t: tm ) :<span class="library" title="binding of C++ string type">string</span> = 
<span class="lineno" id=line109></span>    {
<span class="lineno" id=line110></span>       <span class="small_keyword" title="return">return</span> strftime (fmt, &amp;t); 
<span class="lineno" id=line111></span>    }
<span class="lineno" id=line112></span>  
<span class="lineno" id=line113></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> rfc1123_date (dt:&amp;tm) =&gt; strftime(<span class="fstring">"%a, %d %b %Y %H:%M:%S %Z"</span>,dt);
<span class="lineno" id=line114></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> rfc1123_date (dt:tm) =&gt; strftime(<span class="fstring">"%a, %d %b %Y %H:%M:%S %Z"</span>,dt);
<span class="lineno" id=line115></span>  
<span class="lineno" id=line116></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> rfc1123_date () = {
<span class="lineno" id=line117></span>      <span class="big_keyword" title="Define a mutable variable">var</span> time_epoch_seconds = time_t();
<span class="lineno" id=line118></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tm_struct : tm;
<span class="lineno" id=line119></span>      gmtime(&amp;time_epoch_seconds, &amp;tm_struct);
<span class="lineno" id=line120></span>      <span class="small_keyword" title="return">return</span> rfc1123_date(&amp;tm_struct);
<span class="lineno" id=line121></span>    }
<span class="lineno" id=line122></span>  
<span class="lineno" id=line123></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> hour() =&gt; 3600;
<span class="lineno" id=line124></span>  
<span class="lineno" id=line125></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> day() =&gt; 86400;
<span class="lineno" id=line126></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> expires_seconds_from_now(seconds:<span class="library" title="binding of C int type">int</span>) ={ 
<span class="lineno" id=line127></span>      <span class="big_keyword" title="Define a mutable variable">var</span> time_epoch_seconds = time_t() +seconds;
<span class="lineno" id=line128></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tm_struct : tm;
<span class="lineno" id=line129></span>      gmtime(&amp;time_epoch_seconds, &amp;tm_struct);
<span class="lineno" id=line130></span>     <span class="small_keyword" title="return">return</span> rfc1123_date (&amp;tm_struct);
<span class="lineno" id=line131></span>   }
<span class="lineno" id=line132></span>  
<span class="lineno" id=line133></span>  }
<span class="lineno" id=line134></span>  
<span class="lineno" id=line135></span>   
</pre></p><pre class='inclusion'>
share/lib/web/json.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Open a module or class">open</span> <span class="big_keyword" title="Define a type class">class</span> Json 
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    variant Jvalue = 
<span class="lineno" id=line4></span>    | Jstring of <span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line5></span>    | Jnumber of <span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line6></span>    | Jdictionary of <span class="library" title="functional, singly linked list">list</span>[Jpair]
<span class="lineno" id=line7></span>    | Jarray of <span class="library" title="functional, singly linked list">list</span> [Jvalue]
<span class="lineno" id=line8></span>    | Jname of <span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line9></span>    ;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> Jpair = Jvalue * Jvalue;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> (s:Jvalue, v:Jvalue) : <span class="library" title="binding of C++ string type">string</span> =&gt; <span class="library" title="Convert a value to a string">str</span> s + <span class="fstring">': '</span> + <span class="library" title="Convert a value to a string">str</span> v;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> (v: Jvalue) : <span class="library" title="binding of C++ string type">string</span> =&gt; <span class="small_keyword" title="match statement or expression">match</span> v <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line15></span>    | Jstring s =&gt; <span class="fstring">'"'</span> + s + <span class="fstring">'"'</span> <span class="comment">// hack, ignores quoting rules</span>
<span class="lineno" id=line16></span>    | Jnumber i =&gt; i
<span class="lineno" id=line17></span>    | Jdictionary d =&gt; <span class="fstring">"{"</span> + cat <span class="fstring">", "</span> (<span class="library" title="return data structure with function applied to each value">map</span> <span class="library" title="Convert a value to a string">str</span> of (Jpair) d) + <span class="fstring">"}"</span>
<span class="lineno" id=line18></span>    | Jarray a =&gt; <span class="fstring">"["</span> + cat <span class="fstring">", "</span> (<span class="library" title="return data structure with function applied to each value">map</span> <span class="library" title="Convert a value to a string">str</span> of (Jvalue) a) + <span class="fstring">"]"</span>
<span class="lineno" id=line19></span>    | Jname a =&gt; a
<span class="lineno" id=line20></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line21></span>    ;
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>    variant ParseResult =
<span class="lineno" id=line24></span>    | Good of Jvalue
<span class="lineno" id=line25></span>    | Bad of <span class="library" title="binding of C int type">int</span>
<span class="lineno" id=line26></span>    ;
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_json(s:<span class="library" title="binding of C++ string type">string</span>): ParseResult = {
<span class="lineno" id=line29></span>      <span class="big_keyword" title="Define a mutable variable">var</span> i = skip_white s 0;
<span class="lineno" id=line30></span>      def i, <span class="big_keyword" title="Define a mutable variable">var</span> v = parse_value s i;
<span class="lineno" id=line31></span>      i = skip_white s i;
<span class="lineno" id=line32></span>      <span class="small_keyword" title="conditional">if</span> s.[i] != <span class="fstring">""</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line33></span>        <span class="small_keyword" title="return">return</span> Bad i;
<span class="lineno" id=line34></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line35></span>        <span class="small_keyword" title="return">return</span> v;
<span class="lineno" id=line36></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line37></span>    }
<span class="lineno" id=line38></span>  
<span class="lineno" id=line39></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> skip_white (s:<span class="library" title="binding of C++ string type">string</span>) (<span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line40></span>      <span class="small_keyword" title="while loop">while</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">" \t\r\n"</span> <span class="small_keyword" title="imperative code begins">do</span> ++i; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line41></span>      <span class="small_keyword" title="return">return</span> i;
<span class="lineno" id=line42></span>    }
<span class="lineno" id=line43></span>  
<span class="lineno" id=line44></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_value (s:<span class="library" title="binding of C++ string type">string</span>) (i:<span class="library" title="binding of C int type">int</span>): <span class="library" title="binding of C int type">int</span> * ParseResult =&gt;
<span class="lineno" id=line45></span>      <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"-0123456789"</span> <span class="small_keyword" title="conditional">then</span> parse_number s i
<span class="lineno" id=line46></span>      <span class="small_keyword" title="conditional">elif</span> s.[i] == <span class="fstring">'"'</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="conditional">then</span> parse_string s (i+1)
<span class="lineno" id=line47></span>      <span class="small_keyword" title="conditional">elif</span> s.[i] == <span class="fstring">"{"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="conditional">then</span> parse_dictionary s (i+1)
<span class="lineno" id=line48></span>      <span class="small_keyword" title="conditional">elif</span> s.[i] ==  <span class="fstring">"["</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="conditional">then</span> parse_array s (i+1)
<span class="lineno" id=line49></span>      <span class="small_keyword" title="conditional">elif</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"</span> <span class="small_keyword" title="conditional">then</span> parse_name s i
<span class="lineno" id=line50></span>      <span class="small_keyword" title="conditional">else</span> i, Bad i
<span class="lineno" id=line51></span>      <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line52></span>    ;
<span class="lineno" id=line53></span>  
<span class="lineno" id=line54></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_name (s:<span class="library" title="binding of C++ string type">string</span>) (<span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line55></span>      <span class="big_keyword" title="Define a mutable variable">var</span> j = s.[i].<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line56></span>      ++i; 
<span class="lineno" id=line57></span>      <span class="small_keyword" title="while loop">while</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line58></span>         j += s.[i];
<span class="lineno" id=line59></span>         ++i;
<span class="lineno" id=line60></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line61></span>      <span class="small_keyword" title="conditional">if</span> j <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">"true"</span>,<span class="fstring">"false"</span>,<span class="fstring">"null"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line62></span>        <span class="small_keyword" title="return">return</span> i,Good (Jname j);
<span class="lineno" id=line63></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line64></span>        <span class="small_keyword" title="return">return</span> i, Bad i;
<span class="lineno" id=line65></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line66></span>    }
<span class="lineno" id=line67></span>  
<span class="lineno" id=line68></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_number (s:<span class="library" title="binding of C++ string type">string</span>) (<span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line69></span>      <span class="big_keyword" title="Define a mutable variable">var</span> j = <span class="fstring">""</span>;
<span class="lineno" id=line70></span>  
<span class="lineno" id=line71></span>      <span class="comment">// optional leading sign</span>
<span class="lineno" id=line72></span>      <span class="small_keyword" title="conditional">if</span> s.[i] == <span class="fstring">"-"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line73></span>        j += s.[i]; 
<span class="lineno" id=line74></span>        ++i;
<span class="lineno" id=line75></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line76></span>  
<span class="lineno" id=line77></span>      <span class="comment">// zero integral part</span>
<span class="lineno" id=line78></span>      <span class="small_keyword" title="conditional">if</span> s.[i] == <span class="fstring">"0"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line79></span>        j+= s.[i];
<span class="lineno" id=line80></span>        ++i;
<span class="lineno" id=line81></span>        <span class="small_keyword" title="jump to label">goto</span> point;
<span class="lineno" id=line82></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line83></span>  
<span class="lineno" id=line84></span>      <span class="comment">// nonzero integral part</span>
<span class="lineno" id=line85></span>      <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"123456789"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line86></span>        j += s.[i];
<span class="lineno" id=line87></span>        ++i;
<span class="lineno" id=line88></span>      <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line89></span>        <span class="small_keyword" title="jump to label">goto</span> bad;
<span class="lineno" id=line90></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line91></span>  
<span class="lineno" id=line92></span>      <span class="comment">// rest of integral part</span>
<span class="lineno" id=line93></span>      <span class="small_keyword" title="while loop">while</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line94></span>         j += s.[i];
<span class="lineno" id=line95></span>         ++i;
<span class="lineno" id=line96></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line97></span>  
<span class="lineno" id=line98></span>  point:&gt;
<span class="lineno" id=line99></span>      <span class="small_keyword" title="conditional">if</span> s.[i] != <span class="fstring">"."</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="jump to label">goto</span> exponent;
<span class="lineno" id=line100></span>      j += s.[i];
<span class="lineno" id=line101></span>      ++i;
<span class="lineno" id=line102></span>  
<span class="lineno" id=line103></span>  fraction:&gt;
<span class="lineno" id=line104></span>      <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line105></span>        <span class="small_keyword" title="while loop">while</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line106></span>           j += s.[i];
<span class="lineno" id=line107></span>           ++i;
<span class="lineno" id=line108></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line109></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line110></span>        <span class="small_keyword" title="jump to label">goto</span> bad;
<span class="lineno" id=line111></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line112></span>  
<span class="lineno" id=line113></span>  exponent:&gt;
<span class="lineno" id=line114></span>      <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"eE"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line115></span>        j += s.[i];
<span class="lineno" id=line116></span>        ++i;
<span class="lineno" id=line117></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line118></span>        <span class="small_keyword" title="jump to label">goto</span> good;
<span class="lineno" id=line119></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line120></span>  
<span class="lineno" id=line121></span>      <span class="comment">// sign of exponent</span>
<span class="lineno" id=line122></span>      <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"+-"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line123></span>        j += s.[i];
<span class="lineno" id=line124></span>        ++i;
<span class="lineno" id=line125></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line126></span>  
<span class="lineno" id=line127></span>      <span class="comment">// exponent value</span>
<span class="lineno" id=line128></span>      <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line129></span>        <span class="small_keyword" title="while loop">while</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line130></span>        j += s.[i];
<span class="lineno" id=line131></span>        ++i;
<span class="lineno" id=line132></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line133></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line134></span>        <span class="small_keyword" title="jump to label">goto</span> bad;
<span class="lineno" id=line135></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line136></span>  good:&gt;
<span class="lineno" id=line137></span>      <span class="small_keyword" title="return">return</span> i,Good (Jnumber j);
<span class="lineno" id=line138></span>  bad:&gt;
<span class="lineno" id=line139></span>      <span class="small_keyword" title="return">return</span> i, Bad i;
<span class="lineno" id=line140></span>    }
<span class="lineno" id=line141></span>  
<span class="lineno" id=line142></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_string (s:<span class="library" title="binding of C++ string type">string</span>) (<span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line143></span>      <span class="big_keyword" title="Define a mutable variable">var</span> r = <span class="fstring">""</span>;
<span class="lineno" id=line144></span>  ordinary:&gt;
<span class="lineno" id=line145></span>      <span class="small_keyword" title="while loop">while</span> s.[i] != <span class="fstring">""</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="logical conjunction">and</span> s.[i] != <span class="fstring">'"'</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="logical conjunction">and</span> s.[i] != <span class="fstring">"\\"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line146></span>        <span class="small_keyword" title="conditional">if</span> s.[i].ord &lt; 32 <span class="small_keyword" title="jump to label">goto</span> bad; <span class="comment">// control chars are not allowed</span>
<span class="lineno" id=line147></span>        r += s.[i];
<span class="lineno" id=line148></span>        ++i;
<span class="lineno" id=line149></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line150></span>  
<span class="lineno" id=line151></span>      <span class="small_keyword" title="conditional">if</span> s.[i] == <span class="fstring">'"'</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// closing quote</span>
<span class="lineno" id=line152></span>        ++i;
<span class="lineno" id=line153></span>        <span class="small_keyword" title="jump to label">goto</span> good;
<span class="lineno" id=line154></span>      <span class="small_keyword" title="conditional">elif</span> s.[i] == <span class="fstring">"\\"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// escape</span>
<span class="lineno" id=line155></span>        r += s.[i];
<span class="lineno" id=line156></span>        ++i;
<span class="lineno" id=line157></span>        <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">'"\\/bfnrt'</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// one char escape code</span>
<span class="lineno" id=line158></span>          r += s.[i];
<span class="lineno" id=line159></span>          ++i;
<span class="lineno" id=line160></span>          <span class="small_keyword" title="jump to label">goto</span> ordinary; 
<span class="lineno" id=line161></span>        <span class="small_keyword" title="conditional">elif</span> s.[i] == <span class="fstring">"u"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// hex escape</span>
<span class="lineno" id=line162></span>          r += s.[i];
<span class="lineno" id=line163></span>          ++i;
<span class="lineno" id=line164></span>          <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789ABCDEFabcdef"</span> <span class="small_keyword" title="imperative code begins">do</span> r += s.[i]; ++i; <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> bad; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line165></span>          <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789ABCDEFabcdef"</span> <span class="small_keyword" title="imperative code begins">do</span> r += s.[i]; ++i; <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> bad; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line166></span>          <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789ABCDEFabcdef"</span> <span class="small_keyword" title="imperative code begins">do</span> r += s.[i]; ++i; <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> bad; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line167></span>          <span class="small_keyword" title="conditional">if</span> s.[i] <span class="small_keyword" title="membership operator, function mem">in</span> <span class="fstring">"0123456789ABCDEFabcdef"</span> <span class="small_keyword" title="imperative code begins">do</span> r += s.[i]; ++i; <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> bad; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line168></span>          <span class="small_keyword" title="jump to label">goto</span> ordinary;
<span class="lineno" id=line169></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line170></span>          <span class="small_keyword" title="jump to label">goto</span> bad;
<span class="lineno" id=line171></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line172></span>      <span class="small_keyword" title="conditional">else</span> <span class="comment">// end of input</span>
<span class="lineno" id=line173></span>        <span class="small_keyword" title="jump to label">goto</span> bad;
<span class="lineno" id=line174></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line175></span>  
<span class="lineno" id=line176></span>  good:&gt;
<span class="lineno" id=line177></span>      <span class="small_keyword" title="return">return</span> i,Good (Jstring r);
<span class="lineno" id=line178></span>  bad:&gt;
<span class="lineno" id=line179></span>      <span class="small_keyword" title="return">return</span> i, Bad i;
<span class="lineno" id=line180></span>  }
<span class="lineno" id=line181></span>  
<span class="lineno" id=line182></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_dictionary (s:<span class="library" title="binding of C++ string type">string</span>) (<span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line183></span>      <span class="big_keyword" title="Define a mutable variable">var</span> elts = #<span class="library" title="functional, singly linked list">list</span>[Jvalue * Jvalue];
<span class="lineno" id=line184></span>      i = skip_white s i;
<span class="lineno" id=line185></span>      <span class="small_keyword" title="while loop">while</span> s.[i] != <span class="fstring">"}"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line186></span>        <span class="small_keyword" title="conditional">if</span> s.[i] == <span class="fstring">'"'</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line187></span>          def i, <span class="big_keyword" title="Define a mutable variable">var</span> ms = parse_string s (i+1);
<span class="lineno" id=line188></span>          <span class="small_keyword" title="match statement or expression">match</span> ms <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line189></span>          | Good sv =&gt; 
<span class="lineno" id=line190></span>            i = skip_white s i;
<span class="lineno" id=line191></span>            <span class="small_keyword" title="conditional">if</span> s.[i] == <span class="fstring">":"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line192></span>              ++i;
<span class="lineno" id=line193></span>              i = skip_white s i;
<span class="lineno" id=line194></span>              def i, <span class="big_keyword" title="Define a mutable variable">var</span> mv = parse_value s i;
<span class="lineno" id=line195></span>              <span class="small_keyword" title="match statement or expression">match</span> mv <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line196></span>              | Good v =&gt;
<span class="lineno" id=line197></span>                elts += sv,v;
<span class="lineno" id=line198></span>                i = skip_white s i;
<span class="lineno" id=line199></span>              | Bad j =&gt; <span class="small_keyword" title="return">return</span> i, Bad j;
<span class="lineno" id=line200></span>              <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line201></span>            <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line202></span>              <span class="small_keyword" title="return">return</span> i, Bad i;
<span class="lineno" id=line203></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line204></span>            <span class="small_keyword" title="conditional">if</span> s.[i] == <span class="fstring">","</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line205></span>              ++i; 
<span class="lineno" id=line206></span>              i = skip_white s i;
<span class="lineno" id=line207></span>            <span class="small_keyword" title="conditional">elif</span> s.[i] == <span class="fstring">"}"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span> ; 
<span class="lineno" id=line208></span>            <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line209></span>              <span class="small_keyword" title="return">return</span> i, Bad i;
<span class="lineno" id=line210></span>            <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line211></span>          | Bad j =&gt; <span class="small_keyword" title="return">return</span> i, Bad j;
<span class="lineno" id=line212></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line213></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line214></span>          <span class="small_keyword" title="return">return</span> i, Bad i;
<span class="lineno" id=line215></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line216></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line217></span>      ++i;
<span class="lineno" id=line218></span>      i = skip_white s i;
<span class="lineno" id=line219></span>      <span class="small_keyword" title="return">return</span> i, Good (Jdictionary elts);
<span class="lineno" id=line220></span>    }
<span class="lineno" id=line221></span>  
<span class="lineno" id=line222></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_array (s:<span class="library" title="binding of C++ string type">string</span>) (<span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line223></span>      <span class="big_keyword" title="Define a mutable variable">var</span> elts = #<span class="library" title="functional, singly linked list">list</span>[Jvalue];
<span class="lineno" id=line224></span>      i = skip_white s i;
<span class="lineno" id=line225></span>      <span class="small_keyword" title="while loop">while</span> s.[i] != <span class="fstring">"]"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line226></span>        def i, <span class="big_keyword" title="Define a mutable variable">var</span> mv = parse_value s i;
<span class="lineno" id=line227></span>        <span class="small_keyword" title="match statement or expression">match</span> mv <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line228></span>        | Good v =&gt; elts += v; 
<span class="lineno" id=line229></span>          i = skip_white s i;
<span class="lineno" id=line230></span>          <span class="small_keyword" title="conditional">if</span> s.[i] == <span class="fstring">","</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line231></span>            ++i; 
<span class="lineno" id=line232></span>            i = skip_white s i;
<span class="lineno" id=line233></span>          <span class="small_keyword" title="conditional">elif</span> s.[i] == <span class="fstring">"]"</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="imperative code begins">do</span> ; 
<span class="lineno" id=line234></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line235></span>            <span class="small_keyword" title="return">return</span> i, Bad i;
<span class="lineno" id=line236></span>          <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line237></span>        | Bad j =&gt; <span class="small_keyword" title="return">return</span> i, Bad j;
<span class="lineno" id=line238></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line239></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line240></span>      ++i;
<span class="lineno" id=line241></span>      i = skip_white s i;
<span class="lineno" id=line242></span>      <span class="small_keyword" title="return">return</span> i, Good (Jarray elts);
<span class="lineno" id=line243></span>    }
<span class="lineno" id=line244></span>  }
<span class="lineno" id=line245></span>  
</pre></p><pre class='inclusion'>
share/lib/web/logger.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  publish <span class="fstring">"""
<span class="lineno" id=line2></span>  Extensible Flexible Logger
<span class="lineno" id=line3></span>  example:
<span class="lineno" id=line4></span>  /* Creates two log files, my_info.log rolls over when log size exceeds 1024 bytes
<span class="lineno" id=line5></span>     and is archived 4 times. my_debug.log does not roll over and will grow to infinite size.
<span class="lineno" id=line6></span>     log messages with log_level INFO are routed to my_info.log.log messages with log level DEBUG
<span class="lineno" id=line7></span>     are routed to my_debug.log */
<span class="lineno" id=line8></span>  open Logger;
<span class="lineno" id=line9></span>  var mylog = logger(simple_logger(
<span class="lineno" id=line10></span>    Logger::log("log","my.log",size(1024),4ui),   INFO)+
<span class="lineno" id=line11></span>    simple_logger(Logger::log("log","my_debug.log",size(0),0ui),  DEBUG));
<span class="lineno" id=line12></span>  mylog(DEBUG,"Debugging enabled");
<span class="lineno" id=line13></span>  """</span>
<span class="lineno" id=line14></span>  <span class="big_keyword" title="Define a type class">class</span> Logger {
<span class="lineno" id=line15></span>  
<span class="lineno" id=line16></span>    <span class="big_keyword" title="Open a module or class">open</span> LowResTime;
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>    <span class="big_keyword" title="Define a structure">struct</span> log {
<span class="lineno" id=line19></span>      path:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line20></span>      name:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line21></span>      max_size:<span class="library" title="binding of C size_t type">size</span>;
<span class="lineno" id=line22></span>      archives:<span class="library" title="binding of C unsigned int type">uint</span>;
<span class="lineno" id=line23></span>    }
<span class="lineno" id=line24></span>  
<span class="lineno" id=line25></span>    publish <span class="fstring">""" Log Level definitions """</span>
<span class="lineno" id=line26></span>    variant log_level = 
<span class="lineno" id=line27></span>      | INFO
<span class="lineno" id=line28></span>      | WARNING
<span class="lineno" id=line29></span>      | ERROR
<span class="lineno" id=line30></span>      | ACCESS
<span class="lineno" id=line31></span>      | DEBUG
<span class="lineno" id=line32></span>      | CUSTOM1
<span class="lineno" id=line33></span>      | CUSTOM2;
<span class="lineno" id=line34></span>  
<span class="lineno" id=line35></span>    publish <span class="fstring">""" Definition of log_message """</span>
<span class="lineno" id=line36></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> log_message = log_level*<span class="library" title="binding of C++ string type">string</span>; 
<span class="lineno" id=line37></span>  
<span class="lineno" id=line38></span>    publish <span class="fstring">"""
<span class="lineno" id=line39></span>    Container for log handler. handles governs what log messages are sent to handles_fn
<span class="lineno" id=line40></span>    """</span>  
<span class="lineno" id=line41></span>    <span class="big_keyword" title="Define a structure">struct</span> log_handler {
<span class="lineno" id=line42></span>      handles: (log_message)-&gt;bool;
<span class="lineno" id=line43></span>      handler_fn: (log_message) -&gt; <span class="library" title="Type with no values, returning void indicates a procedure">void</span>;
<span class="lineno" id=line44></span>    }
<span class="lineno" id=line45></span>   
<span class="lineno" id=line46></span>    publish <span class="fstring">"""
<span class="lineno" id=line47></span>    Simple predicate generator. Returns closusre matching message against curried 
<span class="lineno" id=line48></span>    parameter handles
<span class="lineno" id=line49></span>    """</span>
<span class="lineno" id=line50></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> simple_log_handles [<span class="small_keyword" title="type-class constraint">with</span> Eq[log_level]] (handles:log_level) (message:log_message) =&gt;
<span class="lineno" id=line51></span>      handles == message.(0);
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>    publish <span class="fstring">"""
<span class="lineno" id=line54></span>    Simple log handler implementation. Creates log file give log_path and log_file
<span class="lineno" id=line55></span>    and returns clousre accepting log_message writeing to files specified
<span class="lineno" id=line56></span>    """</span>
<span class="lineno" id=line57></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> simple_log_handler_fn (l:log):(log_message)-&gt;<span class="library" title="Type with no values, returning void indicates a procedure">void</span> = {
<span class="lineno" id=line58></span>      <span class="big_keyword" title="Define a mutable variable">var</span> log_handle = open_log(l); <span class="comment">//fopen_output (l.path+"/"+l.name);</span>
<span class="lineno" id=line59></span>      <span class="small_keyword" title="return">return</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (message:log_message)  {
<span class="lineno" id=line60></span>                log_handle = rotate_when_larger_than_max_size(log_handle,l);
<span class="lineno" id=line61></span>                fprintln (log_handle, <span class="fstring">"["</span>+log_date()+<span class="fstring">"]"</span>+<span class="fstring">" "</span>+to_str(message));
<span class="lineno" id=line62></span>                fflush(log_handle);
<span class="lineno" id=line63></span>              });
<span class="lineno" id=line64></span>    }
<span class="lineno" id=line65></span>    
<span class="lineno" id=line66></span>    publish <span class="fstring">"""
<span class="lineno" id=line67></span>    Simple log handler implementation for logging to console.
<span class="lineno" id=line68></span>    """</span>
<span class="lineno" id=line69></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> console_log_handler_fn ():(log_message)-&gt;<span class="library" title="Type with no values, returning void indicates a procedure">void</span> = {
<span class="lineno" id=line70></span>      <span class="small_keyword" title="return">return</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (message:log_message)  {
<span class="lineno" id=line71></span>                <span class="library" title="Print a string to standard output with newline appended">println</span> (<span class="fstring">"["</span>+log_date()+<span class="fstring">"]"</span>+<span class="fstring">" "</span>+to_str(message));
<span class="lineno" id=line72></span>              });
<span class="lineno" id=line73></span>    }
<span class="lineno" id=line74></span>  
<span class="lineno" id=line75></span>    publish <span class="fstring">"""
<span class="lineno" id=line76></span>    Convience log_handler creator for simple logger
<span class="lineno" id=line77></span>    """</span> 
<span class="lineno" id=line78></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> simple_logger (l:log,level:log_level):<span class="library" title="functional, singly linked list">list</span>[log_handler] =&gt;   
<span class="lineno" id=line79></span>     <span class="library" title="functional, singly linked list">list</span>(log_handler ((simple_log_handles(level))  ,
<span class="lineno" id=line80></span>                  simple_log_handler_fn(l)));
<span class="lineno" id=line81></span>  
<span class="lineno" id=line82></span>    publish <span class="fstring">"""
<span class="lineno" id=line83></span>    Convience log_handler creator for simple console logger
<span class="lineno" id=line84></span>    """</span> 
<span class="lineno" id=line85></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> console_logger (level:log_level):<span class="library" title="functional, singly linked list">list</span>[log_handler] =&gt;   
<span class="lineno" id=line86></span>     <span class="library" title="functional, singly linked list">list</span>(log_handler ((simple_log_handles(level))  ,
<span class="lineno" id=line87></span>                        console_log_handler_fn()));
<span class="lineno" id=line88></span>  
<span class="lineno" id=line89></span>  
<span class="lineno" id=line90></span>    publish <span class="fstring">"""
<span class="lineno" id=line91></span>    Generates logger handle used for sending messages to defined loggers.
<span class="lineno" id=line92></span>    Accepts a list of log_handler and returns a closure accepting log_message
<span class="lineno" id=line93></span>    writing to matching log handler
<span class="lineno" id=line94></span>    """</span>
<span class="lineno" id=line95></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> logger(handlers:<span class="library" title="functional, singly linked list">list</span>[log_handler]):log_message-&gt;<span class="library" title="Type with no values, returning void indicates a procedure">void</span> =  {
<span class="lineno" id=line96></span>      <span class="big_keyword" title="Define a mutable variable">var</span> channel = mk_schannel[log_message]();
<span class="lineno" id=line97></span>      <span class="big_keyword" title="Spawn a cooperative fibre">spawn_fthread</span> (listener(channel,handlers));
<span class="lineno" id=line98></span>      <span class="small_keyword" title="return">return</span> sender(channel);
<span class="lineno" id=line99></span>    }
<span class="lineno" id=line100></span>  
<span class="lineno" id=line101></span>    publish  <span class="fstring">"""Log writer runs as fthread"""</span>
<span class="lineno" id=line102></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> listener(chan:schannel[log_message],log_handlers:<span class="library" title="functional, singly linked list">list</span>[log_handler]) (){
<span class="lineno" id=line103></span>      <span class="small_keyword" title="while loop">while</span> <span class="library" title="truth value">true</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line104></span>        <span class="big_keyword" title="Define a mutable variable">var</span> log_req:log_message = read chan;
<span class="lineno" id=line105></span>        <span class="library" title="call procedure on each element of data structure">iter</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (handler:log_handler) {
<span class="lineno" id=line106></span>          <span class="small_keyword" title="conditional">if</span> handler.handles log_req <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line107></span>            handler.handler_fn(log_req);
<span class="lineno" id=line108></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line109></span>        }) log_handlers;
<span class="lineno" id=line110></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line111></span>      <span class="small_keyword" title="return">return</span>;
<span class="lineno" id=line112></span>    }
<span class="lineno" id=line113></span>  
<span class="lineno" id=line114></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> sender (log_channel:schannel[log_message]) (message:log_message) {
<span class="lineno" id=line115></span>      <span class="library" title="Print a string to a stream">write</span> (log_channel,message);
<span class="lineno" id=line116></span>    }
<span class="lineno" id=line117></span>  
<span class="lineno" id=line118></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[log_level] {
<span class="lineno" id=line119></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> : log_level -&gt;<span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line120></span>        | #INFO =&gt; <span class="fstring">"[INFO]"</span>
<span class="lineno" id=line121></span>        | #WARNING  =&gt; <span class="fstring">"[WARNING]"</span>
<span class="lineno" id=line122></span>        | #ERROR  =&gt; <span class="fstring">"[ERROR]"</span>
<span class="lineno" id=line123></span>        | #ACCESS =&gt; <span class="fstring">"[ACCESS]"</span>
<span class="lineno" id=line124></span>        | #DEBUG =&gt; <span class="fstring">"[DEBUG]"</span>
<span class="lineno" id=line125></span>        | #CUSTOM1 =&gt; <span class="fstring">"[CUSTOM1]"</span>
<span class="lineno" id=line126></span>        | #CUSTOM2 =&gt; <span class="fstring">"[CUSTOM2]"</span>;
<span class="lineno" id=line127></span>    }
<span class="lineno" id=line128></span>  
<span class="lineno" id=line129></span>    
<span class="lineno" id=line130></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Eq[log_level]  {
<span class="lineno" id=line131></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> == : log_level * log_level -&gt; bool = <span class="fstring">"$1==$2"</span>;
<span class="lineno" id=line132></span>    }
<span class="lineno" id=line133></span>  
<span class="lineno" id=line134></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> to_str (m:log_message):<span class="library" title="binding of C++ string type">string</span>  =&gt;
<span class="lineno" id=line135></span>         <span class="library" title="Convert a value to a string">str</span>(m.(0))+<span class="fstring">"\t"</span>+m.(1);
<span class="lineno" id=line136></span>  
<span class="lineno" id=line137></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> log_date_fmt (dt:tm) =&gt; strftime(<span class="fstring">"%d/%b/%Y:%H:%M:%S %Z"</span>,dt);
<span class="lineno" id=line138></span>  
<span class="lineno" id=line139></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> log_date () = {
<span class="lineno" id=line140></span>      <span class="big_keyword" title="Define a mutable variable">var</span> time_epoch_seconds = time_t();
<span class="lineno" id=line141></span>      <span class="big_keyword" title="Define an immutable value">val</span> tm_struct =  gmtime(time_epoch_seconds);
<span class="lineno" id=line142></span>      <span class="small_keyword" title="return">return</span> log_date_fmt(tm_struct);
<span class="lineno" id=line143></span>    }
<span class="lineno" id=line144></span>  
<span class="lineno" id=line145></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> open_log(l:log):ofile = {
<span class="lineno" id=line146></span>      <span class="big_keyword" title="Define an immutable value">val</span> log_file = l.path+<span class="fstring">"/"</span>+l.name;
<span class="lineno" id=line147></span>      <span class="small_keyword" title="conditional">if</span> (FileStat::fileexists log_file) <span class="small_keyword" title="logical conjunction">and</span> l.archives &gt; 0ui <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line148></span>        l.rotate();
<span class="lineno" id=line149></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line150></span>      <span class="big_keyword" title="Define a mutable variable">var</span> log_handle = fopen_output (log_file);
<span class="lineno" id=line151></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> valid log_handle <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line152></span>        eprintln(<span class="fstring">"Unable to open log at "</span>+log_file+<span class="fstring">".\nLogging to console instead."</span>);
<span class="lineno" id=line153></span>        <span class="small_keyword" title="return">return</span> stdout;
<span class="lineno" id=line154></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line155></span>        <span class="small_keyword" title="return">return</span> log_handle;
<span class="lineno" id=line156></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line157></span>    }
<span class="lineno" id=line158></span>  
<span class="lineno" id=line159></span>  
<span class="lineno" id=line160></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> rotate(l:log) {
<span class="lineno" id=line161></span>      <span class="big_keyword" title="Define an immutable value">val</span> log_file = l.path+<span class="fstring">"/"</span>+l.name;
<span class="lineno" id=line162></span>      <span class="small_keyword" title="conditional">if</span> FileStat::fileexists log_file <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line163></span>        <span class="big_keyword" title="Define a mutable variable">var</span> last =<span class="fstring">""</span>;
<span class="lineno" id=line164></span>        <span class="small_keyword" title="for loop">for</span> <span class="big_keyword" title="Define a mutable variable">var</span> i <span class="small_keyword" title="membership operator, function mem">in</span> l.archives <span class="small_keyword" title="downwards counting for loop">downto</span> 1ui  <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line165></span>          <span class="big_keyword" title="Define an immutable value">val</span> rlog =  log_file+<span class="fstring">"."</span>+<span class="library" title="Convert a value to a string">str</span>(i) ;
<span class="lineno" id=line166></span>          <span class="small_keyword" title="conditional">if</span> FileStat::fileexists rlog <span class="small_keyword" title="logical conjunction">and</span> last != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line167></span>            <span class="small_keyword" title="conditional">if</span> 0 != (FileSystem::rename_file (rlog, (log_file+<span class="fstring">"."</span>+<span class="library" title="Convert a value to a string">str</span>(i+1ui)))) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line168></span>              eprintln(<span class="fstring">"Unable to rotate log "</span>+rlog+<span class="fstring">" to "</span>+log_file+<span class="fstring">"."</span>+<span class="library" title="Convert a value to a string">str</span>(i+1ui));
<span class="lineno" id=line169></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line170></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line171></span>          last = rlog;
<span class="lineno" id=line172></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line173></span>        <span class="small_keyword" title="conditional">if</span> 0 != (FileSystem::rename_file (log_file,(log_file+<span class="fstring">".1"</span>))) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line174></span>          eprintln(<span class="fstring">"Unable to rotate log "</span>+log_file+<span class="fstring">" to "</span>+log_file+<span class="fstring">".1"</span>);
<span class="lineno" id=line175></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line176></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line177></span>    }
<span class="lineno" id=line178></span>  
<span class="lineno" id=line179></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> rotate_when_larger_than_max_size(handle:ofile,l:log) = {
<span class="lineno" id=line180></span>      <span class="small_keyword" title="conditional">if</span>  l.max_size &gt; <span class="library" title="binding of C size_t type">size</span>(0) <span class="small_keyword" title="logical conjunction">and</span> fsize(l.path+<span class="fstring">"/"</span>+l.name) &gt; l.max_size <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line181></span>         <span class="small_keyword" title="conditional">if</span> valid(handle) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line182></span>           fclose(handle);
<span class="lineno" id=line183></span>         <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line184></span>         <span class="small_keyword" title="return">return</span> open_log(l);
<span class="lineno" id=line185></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line186></span>        <span class="small_keyword" title="return">return</span> handle;
<span class="lineno" id=line187></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line188></span>    }
<span class="lineno" id=line189></span>  
<span class="lineno" id=line190></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> fsize_: <span class="library" title="binding of C++ string type">string</span>*&amp;<span class="library" title="binding of C size_t type">size</span> = <span class="fstring">"""
<span class="lineno" id=line191></span>      {struct stat st;
<span class="lineno" id=line192></span>       stat($1.c_str(), &amp;st);
<span class="lineno" id=line193></span>       *$2 = st.st_size;}
<span class="lineno" id=line194></span>    """</span>;
<span class="lineno" id=line195></span>  
<span class="lineno" id=line196></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> fsize(name:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C size_t type">size</span> = {
<span class="lineno" id=line197></span>      <span class="big_keyword" title="Define a mutable variable">var</span> sz:<span class="library" title="binding of C size_t type">size</span>;
<span class="lineno" id=line198></span>      fsize_(name,&amp;sz);
<span class="lineno" id=line199></span>      <span class="small_keyword" title="return">return</span> sz;
<span class="lineno" id=line200></span>    }
<span class="lineno" id=line201></span>  }
<span class="lineno" id=line202></span>  
</pre></p><pre class='inclusion'>
share/lib/web/simple_config.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  publish <span class="fstring">"""
<span class="lineno" id=line2></span>  Simple config file reader. Splits key value pairs seperated by the equals character.
<span class="lineno" id=line3></span>  Skips lines where first non-space character is the # character. Max configuration file size 
<span class="lineno" id=line4></span>  is 65535 bytes
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>  Example input:
<span class="lineno" id=line7></span>    # Sample configuration file
<span class="lineno" id=line8></span>    delay         =    0.05
<span class="lineno" id=line9></span>    port          =    1234
<span class="lineno" id=line10></span>    document_root =  ./html
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>  Example code:
<span class="lineno" id=line13></span>    open SimpleConfig;
<span class="lineno" id=line14></span>    if System::argc &gt; 0 do
<span class="lineno" id=line15></span>      var arg = System::argv 1;
<span class="lineno" id=line16></span>      println$ "config file:" + arg;
<span class="lineno" id=line17></span>      iter (proc (kv:string*string) { println(kv.(0)+":"+kv.(1)); })  
<span class="lineno" id=line18></span>           (read_config(System::argv 1));
<span class="lineno" id=line19></span>    else
<span class="lineno" id=line20></span>      println("No config file specified");
<span class="lineno" id=line21></span>    done
<span class="lineno" id=line22></span>  """</span>
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>  <span class="big_keyword" title="Define a type class">class</span> SimpleConfig {
<span class="lineno" id=line25></span>    <span class="big_keyword" title="specify requirements">requires</span> <span class="big_keyword" title="Specify C code to be inserted into header file">header</span> '<span class="embedded_c">#<span class="preproc">include</span> <span class="fstring">&lt;sys/stat.h&gt;</span></span>';
<span class="lineno" id=line26></span>    <span class="big_keyword" title="Open a module or class">open</span> Assoc_list;
<span class="lineno" id=line27></span>    <span class="big_keyword" title="Open a module or class">open</span> Csv;
<span class="lineno" id=line28></span>  
<span class="lineno" id=line29></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> configuration = assoc_list[<span class="library" title="binding of C++ string type">string</span>,<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line30></span>  
<span class="lineno" id=line31></span>    publish <span class="fstring">"""
<span class="lineno" id=line32></span>    Reads configuration file and returns associative list
<span class="lineno" id=line33></span>    """</span>
<span class="lineno" id=line34></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> read_config(config_file:<span class="library" title="binding of C++ string type">string</span>):configuration = {
<span class="lineno" id=line35></span>      <span class="big_keyword" title="Define an immutable value">val</span> fsz =  fsize(config_file);
<span class="lineno" id=line36></span>      <span class="big_keyword" title="Define a mutable variable">var</span> config = Empty[<span class="library" title="binding of C++ string type">string</span>^2];
<span class="lineno" id=line37></span>      <span class="small_keyword" title="conditional">if</span> fsz &gt; <span class="library" title="binding of C size_t type">size</span>(0) <span class="small_keyword" title="logical conjunction">and</span> fsz &lt; <span class="library" title="binding of C size_t type">size</span>(65535) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line38></span>        <span class="big_keyword" title="Define an immutable value">val</span> handle = fopen_input config_file;
<span class="lineno" id=line39></span>        <span class="small_keyword" title="conditional">if</span> valid handle <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line40></span>          <span class="big_keyword" title="Define an immutable value">val</span> config_text = load(handle);
<span class="lineno" id=line41></span>          fclose(handle);
<span class="lineno" id=line42></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Loaded config file "</span> + config_file;
<span class="lineno" id=line43></span>          config = config + read_config_text(config_text);
<span class="lineno" id=line44></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line45></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line46></span>      <span class="small_keyword" title="return">return</span> config;
<span class="lineno" id=line47></span>    }
<span class="lineno" id=line48></span>    
<span class="lineno" id=line49></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> read_config_text(config_text:<span class="library" title="binding of C++ string type">string</span>):configuration ={
<span class="lineno" id=line50></span>      <span class="library" title="Print a string to standard output">print</span>$ <span class="fstring">"[Config Data]\n"</span> + config_text+<span class="fstring">"[End Config Data]\n"</span>;
<span class="lineno" id=line51></span>      <span class="big_keyword" title="Define a mutable variable">var</span> config = Cons((<span class="fstring">'INSTALL_ROOT'</span>,#Config::std_config.FLX_SHARE_DIR.[<span class="small_keyword" title="substring range separator">to</span> -6]),
<span class="lineno" id=line52></span>                        Empty[<span class="library" title="binding of C++ string type">string</span>^2]);
<span class="lineno" id=line53></span>      <span class="library" title="call procedure on each element of data structure">iter</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (line:<span class="library" title="binding of C++ string type">string</span>) {config = config + xparse(line);})  
<span class="lineno" id=line54></span>               (split(<span class="library" title="Convert a value to a string">str</span>(config_text),<span class="fstring">"\n"</span>));
<span class="lineno" id=line55></span>      <span class="small_keyword" title="return">return</span> apply_param_vars(config);
<span class="lineno" id=line56></span>    }    
<span class="lineno" id=line57></span>  
<span class="lineno" id=line58></span>  
<span class="lineno" id=line59></span>    publish <span class="fstring">"""
<span class="lineno" id=line60></span>      returns opt param value for given key
<span class="lineno" id=line61></span>    """</span>
<span class="lineno" id=line62></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_param(params:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],name:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line63></span>       find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) params name;
<span class="lineno" id=line64></span>  
<span class="lineno" id=line65></span>    publish <span class="fstring">"""
<span class="lineno" id=line66></span>      return list strings from comma seperated parameter value
<span class="lineno" id=line67></span>    """</span>
<span class="lineno" id=line68></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_param_list(params:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],name:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line69></span>      <span class="small_keyword" title="match statement or expression">match</span> get_param(params,name) <span class="small_keyword" title="type-class constraint">with</span> |Some v =&gt; get_csv_values(v) |_ =&gt; Empty[<span class="library" title="binding of C++ string type">string</span>] <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line70></span>    
<span class="lineno" id=line71></span>    publish <span class="fstring">"""
<span class="lineno" id=line72></span>       Supports $variables in config files. Uses previously defined paramater keys
<span class="lineno" id=line73></span>       as $ variables. Only supports first occurance of $variable. Also
<span class="lineno" id=line74></span>       $INSTALL_ROOT is available nad populated with the value for the felix
<span class="lineno" id=line75></span>       install root
<span class="lineno" id=line76></span>    """</span>
<span class="lineno" id=line77></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> apply_param_vars (par:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]):<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>] ={
<span class="lineno" id=line78></span>      <span class="big_keyword" title="Define a mutable variable">var</span> kp:<span class="library" title="binding of C++ string type">string</span> = <span class="fstring">""</span>; <span class="big_keyword" title="Define a mutable variable">var</span> vp:<span class="library" title="binding of C++ string type">string</span> = <span class="fstring">""</span>; 
<span class="lineno" id=line79></span>      <span class="small_keyword" title="return">return</span> <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (k:<span class="library" title="binding of C++ string type">string</span>,v:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line80></span>        kp = k; vp = v; 
<span class="lineno" id=line81></span>        <span class="library" title="call procedure on each element of data structure">iter</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (k1:<span class="library" title="binding of C++ string type">string</span>,v1:<span class="library" title="binding of C++ string type">string</span>) { 
<span class="lineno" id=line82></span>          kp,vp = <span class="small_keyword" title="match statement or expression">match</span> find(vp,k1) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line83></span>            |Some p =&gt; (kp, substring(vp,0,(p - 1)) + v1 +
<span class="lineno" id=line84></span>                            substring(vp,p+<span class="library" title="binding of C int type">int</span>(k1.<span class="library" title="number of elements in data structure">len</span>),vp.<span class="library" title="number of elements in data structure">len</span>))
<span class="lineno" id=line85></span>            |_ =&gt; (kp,vp)
<span class="lineno" id=line86></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line87></span>        }) par;
<span class="lineno" id=line88></span>        <span class="small_keyword" title="return">return</span> (kp,vp);
<span class="lineno" id=line89></span>      }) par;
<span class="lineno" id=line90></span>    }
<span class="lineno" id=line91></span>  
<span class="lineno" id=line92></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> apply_param_vars_to (par:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],v:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span> ={
<span class="lineno" id=line93></span>      <span class="big_keyword" title="Define a mutable variable">var</span> vp:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line94></span>      vp = v; 
<span class="lineno" id=line95></span>      <span class="library" title="call procedure on each element of data structure">iter</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (k1:<span class="library" title="binding of C++ string type">string</span>,v1:<span class="library" title="binding of C++ string type">string</span>) { 
<span class="lineno" id=line96></span>        vp = <span class="small_keyword" title="match statement or expression">match</span> find(vp,k1) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line97></span>            |Some p =&gt; substring(vp,0,(p - 1)) + v1 +
<span class="lineno" id=line98></span>                        substring(vp,p+<span class="library" title="binding of C int type">int</span>(k1.<span class="library" title="number of elements in data structure">len</span>),vp.<span class="library" title="number of elements in data structure">len</span>)
<span class="lineno" id=line99></span>            |_ =&gt; vp
<span class="lineno" id=line100></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line101></span>        }) par;
<span class="lineno" id=line102></span>        <span class="small_keyword" title="return">return</span> vp;
<span class="lineno" id=line103></span>    }
<span class="lineno" id=line104></span>  
<span class="lineno" id=line105></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> apply_param_vars_to (par:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],l:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]):<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] =&gt;
<span class="lineno" id=line106></span>      (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; apply_param_vars_to (par,s)) (l));
<span class="lineno" id=line107></span>  
<span class="lineno" id=line108></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> xparse(line:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>] =&gt;
<span class="lineno" id=line109></span>      <span class="small_keyword" title="conditional">if</span> startswith (strip line) (<span class="library" title="binding of C char type">char</span> <span class="fstring">'#'</span>) <span class="small_keyword" title="conditional">then</span>
<span class="lineno" id=line110></span>        Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line111></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line112></span>        <span class="small_keyword" title="match statement or expression">match</span> split_first(line, <span class="fstring">"="</span>) <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line113></span>          |Some s =&gt; <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((strip(s.(0)),strip(s.(1)))) 
<span class="lineno" id=line114></span>          |None =&gt; Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>] 
<span class="lineno" id=line115></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span> 
<span class="lineno" id=line116></span>      <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line117></span>    
<span class="lineno" id=line118></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> split_first (x:<span class="library" title="binding of C++ string type">string</span>, c:<span class="library" title="binding of C++ string type">string</span>): <span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>] ={
<span class="lineno" id=line119></span>      <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="match statement or expression">match</span> find_first_of (x, c) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line120></span>        | #None =&gt; None[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line121></span>        | Some n =&gt; Some(strip(x.[<span class="small_keyword" title="substring range separator">to</span> n]),strip(x.[n+1 <span class="small_keyword" title="substring range separator">to</span>]))
<span class="lineno" id=line122></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line123></span>      ;
<span class="lineno" id=line124></span>    }
<span class="lineno" id=line125></span>  
<span class="lineno" id=line126></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> fsize_: <span class="library" title="binding of C++ string type">string</span>*&amp;<span class="library" title="binding of C size_t type">size</span> = <span class="fstring">"""
<span class="lineno" id=line127></span>      {struct stat st;
<span class="lineno" id=line128></span>       stat($1.c_str(), &amp;st);
<span class="lineno" id=line129></span>       *$2 = st.st_size;}
<span class="lineno" id=line130></span>    """</span>;
<span class="lineno" id=line131></span>  
<span class="lineno" id=line132></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> fsize(name:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C size_t type">size</span> = {
<span class="lineno" id=line133></span>      <span class="big_keyword" title="Define a mutable variable">var</span> sz:<span class="library" title="binding of C size_t type">size</span>;
<span class="lineno" id=line134></span>      fsize_(name,&amp;sz);
<span class="lineno" id=line135></span>      <span class="small_keyword" title="return">return</span> sz;
<span class="lineno" id=line136></span>    }
<span class="lineno" id=line137></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/server_config.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/__init__"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> ServerConfig {
<span class="lineno" id=line4></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPHandler;
<span class="lineno" id=line5></span>    <span class="big_keyword" title="Open a module or class">open</span> Logger;
<span class="lineno" id=line6></span>    <span class="big_keyword" title="Open a module or class">open</span> SimpleConfig;
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Open a module or class">open</span> Assoc_list;
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Define a structure">struct</span> server_config {
<span class="lineno" id=line10></span>          delay : <span class="library" title="binding of C double float type">double</span>;
<span class="lineno" id=line11></span>          port : <span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line12></span>          server_root : <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line13></span>          document_root : <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line14></span>          handlers: <span class="library" title="functional, singly linked list">list</span>[http_handler];
<span class="lineno" id=line15></span>          log:log_message-&gt;<span class="library" title="Type with no values, returning void indicates a procedure">void</span>;
<span class="lineno" id=line16></span>          params:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line17></span>          file_name:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line18></span>          application:<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line19></span>    };
<span class="lineno" id=line20></span>  
<span class="lineno" id=line21></span>    
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> server_config(handlers:<span class="library" title="functional, singly linked list">list</span>[http_handler]) =&gt; 
<span class="lineno" id=line24></span>      server_config(0.05,8080,<span class="fstring">"."</span>,<span class="fstring">"./html"</span>,handlers,
<span class="lineno" id=line25></span>      logger(console_logger(INFO)+console_logger(ERROR)),Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],<span class="fstring">""</span>,<span class="fstring">""</span>);
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> server_config(handlers:<span class="library" title="functional, singly linked list">list</span>[http_handler],app:<span class="library" title="binding of C++ string type">string</span>) =&gt; 
<span class="lineno" id=line28></span>      server_config(0.05,8080,<span class="fstring">"."</span>,<span class="fstring">"./html"</span>,handlers,
<span class="lineno" id=line29></span>      logger(console_logger(INFO)+console_logger(ERROR)),Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>],<span class="fstring">""</span>,app);
<span class="lineno" id=line30></span>  
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> basic_server_config(handlers:<span class="library" title="functional, singly linked list">list</span>[http_handler]):server_config = { 
<span class="lineno" id=line33></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cfg = server_config(handlers);
<span class="lineno" id=line34></span>      <span class="small_keyword" title="match statement or expression">match</span> enhance_with_config_file( 
<span class="lineno" id=line35></span>       enhance_with_command_line_arguments(cfg)) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line36></span>      |Some(cfg),_ =&gt; <span class="small_keyword" title="return">return</span> cfg;
<span class="lineno" id=line37></span>      |None,m =&gt; <span class="small_keyword" title="return">return</span> cfg;
<span class="lineno" id=line38></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line39></span>      
<span class="lineno" id=line40></span>    }
<span class="lineno" id=line41></span>    
<span class="lineno" id=line42></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> basic_server_config(handlers:<span class="library" title="functional, singly linked list">list</span>[http_handler],application:<span class="library" title="binding of C++ string type">string</span>,default_config:<span class="library" title="binding of C++ string type">string</span>):server_config = {
<span class="lineno" id=line43></span>      <span class="big_keyword" title="Define a mutable variable">var</span> config = server_config(handlers,application);
<span class="lineno" id=line44></span>      <span class="small_keyword" title="match statement or expression">match</span> enhance_with_config_file( 
<span class="lineno" id=line45></span>        enhance_with_command_line_arguments(config)) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line46></span>      |Some(cfg),_ =&gt; <span class="small_keyword" title="return">return</span> cfg;
<span class="lineno" id=line47></span>      |None,m =&gt;  set_params(&amp;config,read_config_text(default_config));
<span class="lineno" id=line48></span>                   <span class="small_keyword" title="return">return</span> config;
<span class="lineno" id=line49></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line50></span>  
<span class="lineno" id=line51></span>   }
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> enhance_with_command_line_arguments(<span class="big_keyword" title="Define a mutable variable">var</span> config:server_config):server_config = {
<span class="lineno" id=line54></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cfg:server_config = config;
<span class="lineno" id=line55></span>      <span class="big_keyword" title="Define a mutable variable">var</span> arg = <span class="fstring">""</span>;
<span class="lineno" id=line56></span>      <span class="big_keyword" title="Define a mutable variable">var</span> argno = 1;
<span class="lineno" id=line57></span>      <span class="small_keyword" title="while loop">while</span> argno&lt;System::argc <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line58></span>        arg = System::argv argno;
<span class="lineno" id=line59></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"ARG="</span> + arg;
<span class="lineno" id=line60></span>        <span class="small_keyword" title="conditional">if</span> prefix(arg,<span class="fstring">"--document_root="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line61></span>          cfg&amp;.document_root &lt;- arg.[16 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line62></span>        <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--server_root="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line63></span>          cfg&amp;.server_root &lt;- arg.[14 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line64></span>        <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--port="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line65></span>          cfg&amp;.port &lt;- atoi arg.[7 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line66></span>        <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--config="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line67></span>          cfg&amp;.file_name &lt;- arg.[9 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line68></span>          <span class="small_keyword" title="conditional">if</span>( <span class="small_keyword" title="logical negation">not</span> (FileStat::fileexists(cfg.file_name))) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line69></span>            proc_fail(<span class="fstring">"unable to open config file:"</span>+cfg.file_name); 
<span class="lineno" id=line70></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line71></span>        <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--debug"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line72></span>          <span class="big_keyword" title="Define a mutable variable">var</span> dbg_log:<span class="library" title="functional, singly linked list">list</span>[log_handler];
<span class="lineno" id=line73></span>          <span class="small_keyword" title="conditional">if</span> prefix(arg,<span class="fstring">"--debug="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line74></span>            <span class="big_keyword" title="Define an immutable value">val</span> file:<span class="library" title="binding of C++ string type">string</span> =  <span class="library" title="Convert a value to a string">str</span>(arg.[8 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line75></span>            dbg_log = simple_logger(Logger::log(<span class="fstring">"log"</span>,file,<span class="library" title="binding of C size_t type">size</span>(0),0ui),DEBUG);
<span class="lineno" id=line76></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line77></span>            dbg_log = console_logger(DEBUG);
<span class="lineno" id=line78></span>          <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line79></span>          cfg&amp;.log &lt;- logger(console_logger(INFO)+console_logger(ERROR)+dbg_log);
<span class="lineno" id=line80></span>        <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--help"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line81></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>(<span class="fstring">"Usage: "</span>+(System::argv 0)+<span class="fstring">""" [OPTION]
<span class="lineno" id=line82></span>    --document-root=PATH    Path to document root directory defaults to ./html
<span class="lineno" id=line83></span>    --server-root=PATH      Path to server root direcory defaults to cwd
<span class="lineno" id=line84></span>    --port=PORT             Port to listen on
<span class="lineno" id=line85></span>    --debug                 Logs DEBUG messages to STDOUT
<span class="lineno" id=line86></span>    --debug=FILE            Logs DEBUG to log/FILE
<span class="lineno" id=line87></span>  """</span>);
<span class="lineno" id=line88></span>          System::exit(0);      
<span class="lineno" id=line89></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line90></span>        ++argno;
<span class="lineno" id=line91></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line92></span>      <span class="small_keyword" title="return">return</span> (cfg);
<span class="lineno" id=line93></span>    }
<span class="lineno" id=line94></span>  
<span class="lineno" id=line95></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> tolower: char-&gt;<span class="library" title="binding of C char type">char</span> = <span class="fstring">"(char)::std::tolower($1)"</span> <span class="big_keyword" title="specify requirements">requires</span> Cxx_headers::cctype ;
<span class="lineno" id=line96></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> toupper: char-&gt;<span class="library" title="binding of C char type">char</span> = <span class="fstring">"(char)::std::toupper($1)"</span> <span class="big_keyword" title="specify requirements">requires</span> Cxx_headers::cctype ;
<span class="lineno" id=line97></span>  
<span class="lineno" id=line98></span>  
<span class="lineno" id=line99></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> enhance_with_config_file(<span class="big_keyword" title="Define a mutable variable">var</span> config:server_config):<span class="library" title="option type: Some x or None">opt</span>[server_config]*<span class="library" title="binding of C++ string type">string</span> = {
<span class="lineno" id=line100></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cfg = config;
<span class="lineno" id=line101></span>      <span class="big_keyword" title="Define an immutable value">val</span> config_file_default = Filename::join(<span class="fstring">"config"</span>,<span class="fstring">"server_config.cfg"</span>);
<span class="lineno" id=line102></span>      <span class="big_keyword" title="Define an immutable value">val</span> enviro_config = Env::getenv((<span class="library" title="return data structure with function applied to each value">map</span> toupper cfg.application)+<span class="fstring">"_CFG"</span>,<span class="fstring">""</span>);
<span class="lineno" id=line103></span>      <span class="small_keyword" title="conditional">if</span> cfg.file_name == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line104></span>          <span class="small_keyword" title="conditional">if</span> enviro_config  == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line105></span>              <span class="big_keyword" title="Define a mutable variable">var</span> cwd_config = Filename::join(<span class="fstring">"."</span>,config_file_default);
<span class="lineno" id=line106></span>              <span class="small_keyword" title="conditional">if</span> FileStat::fileexists(cwd_config) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line107></span>                  cfg&amp;.file_name &lt;- cwd_config;
<span class="lineno" id=line108></span>              <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line109></span>                  <span class="big_keyword" title="Define a mutable variable">var</span> home = Env::getenv(<span class="fstring">"HOME"</span>,<span class="fstring">""</span>);
<span class="lineno" id=line110></span>                  <span class="small_keyword" title="conditional">if</span> home == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line111></span>                     <span class="small_keyword" title="return">return</span> None[server_config],<span class="fstring">"Unable to open configuration file HOME environment variable undefined."</span>;
<span class="lineno" id=line112></span>                  <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line113></span>                      <span class="big_keyword" title="Define a mutable variable">var</span> home_config = Filename::join(home,
<span class="lineno" id=line114></span>                      Filename::join(<span class="fstring">".felix"</span>,Filename::join(cfg.application,config_file_default)));
<span class="lineno" id=line115></span>                      <span class="small_keyword" title="conditional">if</span> FileStat::fileexists(home_config) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line116></span>                          cfg&amp;.file_name &lt;- home_config;
<span class="lineno" id=line117></span>                      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line118></span>                          <span class="small_keyword" title="return">return</span> None[server_config],(<span class="fstring">"Unable to open configurationfile:"</span> + home_config);
<span class="lineno" id=line119></span>                      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line120></span>                  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line121></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line122></span>          <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line123></span>              <span class="small_keyword" title="conditional">if</span> FileStat::fileexists(enviro_config) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line124></span>                  cfg&amp;.file_name &lt;- enviro_config;
<span class="lineno" id=line125></span>              <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line126></span>                  <span class="small_keyword" title="return">return</span> None[server_config],(<span class="fstring">"Unable to open configurationfile:"</span> + enviro_config);
<span class="lineno" id=line127></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line128></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line129></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line130></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span>(FileStat::fileexists(cfg.file_name)) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line131></span>              <span class="small_keyword" title="return">return</span> None[server_config], (<span class="fstring">"Unable to open configurationfile:"</span> + cfg.file_name);
<span class="lineno" id=line132></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line133></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line134></span>      set_params(&amp;cfg,read_config(cfg.file_name));
<span class="lineno" id=line135></span>      <span class="small_keyword" title="return">return</span> Some(cfg),(<span class="fstring">"Configuration file "</span> + cfg.file_name + <span class="fstring">" read."</span>);
<span class="lineno" id=line136></span>    }
<span class="lineno" id=line137></span>  
<span class="lineno" id=line138></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set_params(cfg:&amp;server_config,params:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>^2]) {
<span class="lineno" id=line139></span>      cfg.params &lt;- params;
<span class="lineno" id=line140></span>      <span class="small_keyword" title="match statement or expression">match</span> find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) params <span class="fstring">"port"</span> <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line141></span>        |Some s =&gt; cfg.port &lt;- <span class="library" title="binding of C int type">int</span>(s);
<span class="lineno" id=line142></span>        |_ =&gt; {}();
<span class="lineno" id=line143></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line144></span>      <span class="small_keyword" title="match statement or expression">match</span> find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) params <span class="fstring">"server_root"</span> <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line145></span>        |Some s =&gt; cfg.server_root &lt;- s;
<span class="lineno" id=line146></span>        |_ =&gt; {}();
<span class="lineno" id=line147></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line148></span>      <span class="small_keyword" title="match statement or expression">match</span> find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) params <span class="fstring">"document_root"</span> <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line149></span>        |Some s =&gt; cfg.document_root &lt;- s;
<span class="lineno" id=line150></span>        |_ =&gt; {}();
<span class="lineno" id=line151></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line152></span>      <span class="small_keyword" title="match statement or expression">match</span> find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (a:<span class="library" title="binding of C++ string type">string</span>,b:<span class="library" title="binding of C++ string type">string</span>) =&gt; eq(a,b)) params <span class="fstring">"delay"</span> <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line153></span>        |Some s =&gt; cfg.delay &lt;- <span class="library" title="binding of C double float type">double</span>(s);
<span class="lineno" id=line154></span>        |_ =&gt; {}();
<span class="lineno" id=line155></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line156></span>  
<span class="lineno" id=line157></span>    }
<span class="lineno" id=line158></span>  
<span class="lineno" id=line159></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> strtod: <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C double float type">double</span> = <span class="fstring">"strtod($1.data(),0)"</span>;
<span class="lineno" id=line160></span>  
<span class="lineno" id=line161></span>  
<span class="lineno" id=line162></span>    <span class="big_keyword" title="Provide an instance of a typeclass">instance</span> Str[server_config] {
<span class="lineno" id=line163></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span> (cfg : server_config):<span class="library" title="binding of C++ string type">string</span> =&gt;
<span class="lineno" id=line164></span>         <span class="fstring">"Config file:"</span> + cfg.file_name <span class="fstring">"\n"</span> +
<span class="lineno" id=line165></span>         (<span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span>(i:<span class="library" title="binding of C++ string type">string</span>) (c:<span class="library" title="binding of C++ string type">string</span>^2):<span class="library" title="binding of C++ string type">string</span> =&gt; 
<span class="lineno" id=line166></span>           (i + c.(0) + <span class="fstring">" = "</span> + c.(1) + <span class="fstring">"\n"</span>) ) <span class="fstring">""</span> (cfg.params));
<span class="lineno" id=line167></span>    }
<span class="lineno" id=line168></span>  
<span class="lineno" id=line169></span>  }
<span class="lineno" id=line170></span>  
</pre></p><pre class='inclusion'>
share/lib/web/sundown.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="doccomment">A Markdown to Html translator.</span>
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Define a type class">class</span> SunDown
<span class="lineno" id=line3></span>  {
<span class="lineno" id=line4></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> sundown: <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C++ string type">string</span> <span class="big_keyword" title="specify requirements">requires</span> <span class="small_keyword" title="specifies an abstract package name">package</span> <span class="fstring">"sundown"</span>;
<span class="lineno" id=line5></span>  }
</pre></p><pre class='inclusion'>
share/lib/web/web_server.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  publish <span class="fstring">""" 
<span class="lineno" id=line2></span>  Accepts connection and spawns fthread to handle request 
<span class="lineno" id=line3></span>  See webapp.flx for usage example 
<span class="lineno" id=line4></span>  """</span>
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>  <span class="small_keyword" title="conditional">if</span> PLAT_POSIX <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line7></span>  PosixSignal::ignore_signal(PosixSignal::SIGPIPE);
<span class="lineno" id=line8></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line9></span>  
<span class="lineno" id=line10></span>  <span class="big_keyword" title="Open a module or class">open</span> Socket;
<span class="lineno" id=line11></span>  <span class="big_keyword" title="Open a module or class">open</span> IOStream;
<span class="lineno" id=line12></span>  
<span class="lineno" id=line13></span>  <span class="big_keyword" title="Open a module or class">open</span> TerminalIByteStream[fd_t];
<span class="lineno" id=line14></span>  <span class="big_keyword" title="Open a module or class">open</span> TerminalIOByteStream[socket_t];
<span class="lineno" id=line15></span>  
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>  <span class="comment">// this is a hack to make close work on a listenter</span>
<span class="lineno" id=line18></span>  <span class="comment">// RF got this right the first time:</span>
<span class="lineno" id=line19></span>  <span class="comment">// in the abstract a listener is NOT a socket</span>
<span class="lineno" id=line20></span>  <span class="comment">// In fact, it is a socket server, with accept() a way to</span>
<span class="lineno" id=line21></span>  <span class="comment">// read new sockets off it ..</span>
<span class="lineno" id=line22></span>  <span class="big_keyword" title="Open a module or class">open</span> TerminalIByteStream[socket_t];
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>  <span class="big_keyword" title="specify requirements">requires</span> <span class="big_keyword" title="Specify C code to be inserted into header file">header</span> '<span class="embedded_c">#<span class="preproc">include</span> <span class="fstring">&lt;stdlib.h&gt;</span></span>';
<span class="lineno" id=line25></span>  
<span class="lineno" id=line26></span>  <span class="big_keyword" title="Define a type class">class</span> WebServer {
<span class="lineno" id=line27></span>    <span class="big_keyword" title="Open a module or class">open</span> ServerConfig;
<span class="lineno" id=line28></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPRequest;
<span class="lineno" id=line29></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPConnection;
<span class="lineno" id=line30></span>    <span class="big_keyword" title="Open a module or class">open</span> MIMEType;
<span class="lineno" id=line31></span>    <span class="big_keyword" title="Open a module or class">open</span> Eq[mime_type];
<span class="lineno" id=line32></span>    <span class="big_keyword" title="Open a module or class">open</span> Assoc_list;  
<span class="lineno" id=line33></span>    <span class="big_keyword" title="Open a module or class">open</span> HTTPHandler;  
<span class="lineno" id=line34></span>    <span class="big_keyword" title="Open a module or class">open</span> Logger;
<span class="lineno" id=line35></span>  
<span class="lineno" id=line36></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve(conn:http_connection, request: http_request)
<span class="lineno" id=line37></span>    {
<span class="lineno" id=line38></span>      <span class="big_keyword" title="Define an immutable value">val</span> s = conn.sock;
<span class="lineno" id=line39></span>      <span class="library" title="call procedure on each element of data structure">iter</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (handler:http_handler) { 
<span class="lineno" id=line40></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> *conn.dirty  <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line41></span>          <span class="small_keyword" title="conditional">if</span> handler.handles(conn.config,request) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line42></span>            handler.handler_fn(conn,request);
<span class="lineno" id=line43></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line44></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line45></span>          <span class="small_keyword" title="jump to label">goto</span> finished; 
<span class="lineno" id=line46></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line47></span>        }) conn.config.handlers;
<span class="lineno" id=line48></span>      finished:&gt; 
<span class="lineno" id=line49></span>      <span class="small_keyword" title="return">return</span>;
<span class="lineno" id=line50></span>    }
<span class="lineno" id=line51></span>  
<span class="lineno" id=line52></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> start_webserver(config:server_config) {
<span class="lineno" id=line53></span>      <span class="big_keyword" title="Define an immutable value">val</span> webby_port = config.port;
<span class="lineno" id=line54></span>      config.log(INFO, <span class="fstring">"Server started, listenting on "</span>+<span class="library" title="Convert a value to a string">str</span> config.port);
<span class="lineno" id=line55></span>      <span class="comment">// up the queue len for stress testing</span>
<span class="lineno" id=line56></span>      <span class="big_keyword" title="Define a mutable variable">var</span> p = webby_port;
<span class="lineno" id=line57></span>      <span class="big_keyword" title="Define a mutable variable">var</span> listener: socket_t;
<span class="lineno" id=line58></span>      mk_listener(&amp;listener, &amp;p, 10);
<span class="lineno" id=line59></span>      <span class="big_keyword" title="Define a mutable variable">var</span> clock = Faio::mk_alarm_clock();
<span class="lineno" id=line60></span>      <span class="comment">// noinline is necessary to stop the closure being</span>
<span class="lineno" id=line61></span>      <span class="comment">// inlined into the loop, preventing the socket variable k</span>
<span class="lineno" id=line62></span>      <span class="comment">// being duplicated as it must be [a bug in Felix]</span>
<span class="lineno" id=line63></span>      <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handler (<span class="big_keyword" title="Define a mutable variable">var</span> k:socket_t) ()
<span class="lineno" id=line64></span>      {
<span class="lineno" id=line65></span>        config.log(DEBUG,<span class="fstring">"Spawned fthread running for socket "</span>+<span class="library" title="Convert a value to a string">str</span> k);
<span class="lineno" id=line66></span>        <span class="comment">// should spawn fthread here to allow for more io overlap</span>
<span class="lineno" id=line67></span>        <span class="big_keyword" title="Define an immutable value">val</span> conn = http_connection(config ,k);
<span class="lineno" id=line68></span>        <span class="big_keyword" title="Define a mutable variable">var</span> request:http_request;
<span class="lineno" id=line69></span>        <span class="big_keyword" title="Open a module or class">open</span> HTTPRequest;
<span class="lineno" id=line70></span>        <span class="big_keyword" title="Open a module or class">open</span>  Eq[http_method];
<span class="lineno" id=line71></span>        <span class="big_keyword" title="Open a module or class">open</span> MIMEType;
<span class="lineno" id=line72></span>        HTTPRequest::get_request(conn,&amp;request);
<span class="lineno" id=line73></span>         Faio::sleep(clock,config.delay);
<span class="lineno" id=line74></span>        <span class="comment">/*Get entity form parameters if method is post and 
<span class="lineno" id=line75></span>          content type is application/x-www-form-urlencoded */</span>
<span class="lineno" id=line76></span>        <span class="comment">//if str(request.hmethod) == str(POST) do</span>
<span class="lineno" id=line77></span>        <span class="small_keyword" title="match statement or expression">match</span> get_header(request,<span class="fstring">"Content-Type"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line78></span>          | Some c =&gt; { 
<span class="lineno" id=line79></span>            <span class="small_keyword" title="match statement or expression">match</span> parse_media_type(c) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line80></span>              | Some (m,a) =&gt; {
<span class="lineno" id=line81></span>                <span class="small_keyword" title="conditional">if</span> <span class="library" title="Convert a value to a string">str</span>(m) == <span class="library" title="Convert a value to a string">str</span>(application x_DASH_www_DASH_form_DASH_urlencoded) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line82></span>                  HTTPRequest::get_entity_params(conn,&amp;request,a);
<span class="lineno" id=line83></span>                <span class="small_keyword" title="conditional">elif</span> <span class="library" title="Convert a value to a string">str</span>(m) == <span class="library" title="Convert a value to a string">str</span>(form-data) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line84></span>                  HTTPRequest::get_multipart_params(conn,&amp;request,a);
<span class="lineno" id=line85></span>                <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line86></span>                  request.entity_params=Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line87></span>                <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line88></span>                }
<span class="lineno" id=line89></span>              |_ =&gt;  { request.entity_params=Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]; }
<span class="lineno" id=line90></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>; }
<span class="lineno" id=line91></span>          |_ =&gt; { request.entity_params=Empty[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]; }
<span class="lineno" id=line92></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line93></span>        serve(conn,request);
<span class="lineno" id=line94></span>        Faio::sleep(clock,config.delay); <span class="comment">// give OS time to empty its buffers</span>
<span class="lineno" id=line95></span>        <span class="comment">// try this:</span>
<span class="lineno" id=line96></span>        <span class="comment">// Advised by: koettermarkus@gmx.de, MANY THANKS!</span>
<span class="lineno" id=line97></span>  
<span class="lineno" id=line98></span>        <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> hack_recv: socket_t * &amp;<span class="library" title="binding of C char type">char</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> -&gt; <span class="library" title="binding of C int type">int</span> = <span class="fstring">"recv($1,$2,$3,$4)"</span>;
<span class="lineno" id=line99></span>  
<span class="lineno" id=line100></span>        <span class="big_keyword" title="Define a mutable variable">var</span> buf:<span class="library" title="binding of C char type">char</span> ^1025;
<span class="lineno" id=line101></span>        <span class="big_keyword" title="Define a mutable variable">var</span> counter = 0;
<span class="lineno" id=line102></span>        <span class="big_keyword" title="Define a mutable variable">var</span> extra = 0;
<span class="lineno" id=line103></span>        shutdown(k,1); <span class="comment">// shutdown write</span>
<span class="lineno" id=line104></span>        retry:&gt;
<span class="lineno" id=line105></span>          <span class="big_keyword" title="Define a mutable variable">var</span> b = hack_recv(k,<span class="hack">C_hack</span>::cast[&amp;<span class="library" title="binding of C char type">char</span>] (&amp;buf),1024,0);
<span class="lineno" id=line106></span>          <span class="comment">//println$ "Error code " + str b + " from read after shutdown";</span>
<span class="lineno" id=line107></span>          <span class="small_keyword" title="conditional">if</span> b &gt; 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line108></span>            extra += b;
<span class="lineno" id=line109></span>            <span class="small_keyword" title="conditional">if</span> extra &gt; 2000 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line110></span>              config.log(WARNING,<span class="fstring">"Read too many extraneous bytes from OS buffer"</span>);
<span class="lineno" id=line111></span>              <span class="small_keyword" title="jump to label">goto</span> force_close;
<span class="lineno" id=line112></span>            <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line113></span>            <span class="small_keyword" title="jump to label">goto</span> retry;
<span class="lineno" id=line114></span>          <span class="small_keyword" title="conditional">elif</span> b == -1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line115></span>          ++counter;
<span class="lineno" id=line116></span>          <span class="small_keyword" title="conditional">if</span> counter &gt; 200 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line117></span>            config.log(WARNING,<span class="fstring">"Timeout waiting for write buffers to be flushed"</span>);
<span class="lineno" id=line118></span>            <span class="small_keyword" title="jump to label">goto</span> force_close;
<span class="lineno" id=line119></span>          <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line120></span>          Faio::sleep(clock,0.1); <span class="comment">// 100 ms</span>
<span class="lineno" id=line121></span>          <span class="small_keyword" title="jump to label">goto</span> retry;
<span class="lineno" id=line122></span>        <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line123></span>        <span class="big_keyword" title="Run time assertion">assert</span> b==0;
<span class="lineno" id=line124></span>  
<span class="lineno" id=line125></span>        force_close:&gt; 
<span class="lineno" id=line126></span>        Socket::shutdown(k,2); 
<span class="lineno" id=line127></span>        ioclose(k);
<span class="lineno" id=line128></span>        
<span class="lineno" id=line129></span>      };
<span class="lineno" id=line130></span>  
<span class="lineno" id=line131></span>      <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> stuff {
<span class="lineno" id=line132></span>        <span class="big_keyword" title="Define a mutable variable">var</span> s: socket_t;
<span class="lineno" id=line133></span>        config.log(DEBUG,<span class="fstring">"Waiting for connection"</span>);
<span class="lineno" id=line134></span>        accept(listener, &amp;s);  <span class="comment">// blocking</span>
<span class="lineno" id=line135></span>        config.log(DEBUG,<span class="fstring">"got connection "</span>+<span class="library" title="Convert a value to a string">str</span> s);  <span class="comment">// error check here</span>
<span class="lineno" id=line136></span>  
<span class="lineno" id=line137></span>        <span class="comment">//  - spawning an fthread is blocking the web server. don't know why</span>
<span class="lineno" id=line138></span>        config.log(DEBUG,<span class="fstring">"spawning fthread to handle connection "</span>+<span class="library" title="Convert a value to a string">str</span> s);
<span class="lineno" id=line139></span>        <span class="big_keyword" title="Spawn a cooperative fibre">spawn_fthread</span>$  handler s; 
<span class="lineno" id=line140></span>        collect(); <span class="comment">// this hangs everything, no idea why!</span>
<span class="lineno" id=line141></span>      };
<span class="lineno" id=line142></span>      <span class="small_keyword" title="while loop">while</span> <span class="library" title="truth value">true</span> <span class="small_keyword" title="imperative code begins">do</span> stuff; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line143></span>  
<span class="lineno" id=line144></span>      config.log(INFO,<span class="fstring">"WEB SERVER SHUTDOWN"</span>);
<span class="lineno" id=line145></span>      iclose (listener);
<span class="lineno" id=line146></span>    }
<span class="lineno" id=line147></span>  
<span class="lineno" id=line148></span>  }
</pre></p></div><!--Main Content Body End-->

          </div> <!-- rightpanel contents end -->
          <hr>
        </span> <!-- rightpanel end -->

        <span id="panemover" style="cursor:col-resize;"
         onmousedown="dragStart(event, 'left', 'right'); return false;"
         onmousemove="drag(event, 'left', 'right');"
         onmouseout="dragRelease();"
         onmouseup="dragRelease();"
        >
        </span> <!-- panemover end -->
      </div> <!-- bottom panel end -->
    </div> <!-- container end -->
</body></html>

