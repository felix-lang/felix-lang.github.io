<html><head>
<style type="text/css">
body {margin:3%; }
h1 {color:gray; font-size:120%;}
h2 {color:gray; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre.flxbg {background-color:#A0FFA0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.uncheckedflxbg {background-color:#D0D0D0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.cppbg {background-color:#80FF80; color:black; }
pre.prefmtbg {background-color:#D0D0D0; color:black; }
pre.expected {background-color:#E0FF80; color:black; }
pre.input {background-color:#E08080; color:black; }
pre.inclusion {background-color:#D070D0; color:black; }
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:#FF8080; color:black; }
</style>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
        skipTags: ["script","noscript","style","textarea"]
    }
  });
</script>
<title>/Users/skaller/felix/src/packages/gui.fdoc</title></head><body>
<style>
body {margin:3%; font-family: sans-serif; }
h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
h2 {color:#202020; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
pre.cppbg {background-color:#C2FDC2; }
pre.prefmtbg {background-color:#F1F1F1; }
pre.expected {background-color:hsla(74,94%,88%,1); }
pre.input {background-color:hsla(20,94%,88%,1); }
pre.inclusion {
    font-family: Arial;
    font-weight: normal;
    font-size: 0.9em;
    color: #555;
    border: none;
    box-shadow: none;
    text-align: right;
    margin: -7px 11px -12px 0;
    padding: 0;
    background-color:#fafafa;
}
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
.container {
  position: fixed;
  top:0px;
  left:0px;
  height : 100%;
  width: 100%;
  background-color: grey;
  margin: 0px;
  padding: 0px;
  border-width: 0px;
  color: #404040;
}
.maincontent {
  padding:4px;
  padding-left:8px;
  line-height:1.3em;
  color:#404040; background-color:#fafafa;
}
.maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
.maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent code { color:#902030; }
.toppanel {
  position:absolute; left:0px; top:0px; height:20px; right:0px;
  background-color: #e0e0e0;
}
.bottompanel {
  position:absolute; left:0px; top:22px; bottom:0px; right:0px;
  background-color: #fafafa;
  font-size:14px;
}
.leftpanel {
  position:absolute; left:0px; top:0px; bottom:0px; width: 150px;
  background-color: #eaeaea; overflow: auto;
}
.rightpanel {
  position:absolute; right: 0px; left:160px; top:0px; bottom: 0px;
  background-color: #fafafa; overflow: auto;
}
.divider {
  position:absolute; left: 150px; top:0px; bottom:0px;
  background-color: black; width:2px;
  box-shadow: 0 0 8px #000;
}

#panemover {
    position:absolute;
    left: 150px;
    width : 10px;
    top: 0px;
    bottom: 0px;
    opacity: 0.3;
    cursor:col-resize;
}

div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}
</style>

<style>
div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}


</style>

    <script async="true">
      function dragStart(e, left, right){
        document.getElementById("panemover").style.width="70%";
        document.getElementById("panemover").style.left="50px";
        mousedown = true;
        x = e.clientX
        dragOffsetLeft =
          document.getElementById(left).getBoundingClientRect().right -
          document.getElementById(left).getBoundingClientRect().left -
          x
        ;
        dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x;
        dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
      }
      function dragRelease(){
        document.getElementById('panemover').style.width = '10px';
        document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
        mousedown = false;
      }
      function drag(e, left, right){
        if(!mousedown){return}
        x = e.clientX
        tmpLeft = dragOffsetLeft + x
        tmpDivider= dragOffsetDivider + x
        tmpRight = dragOffsetRight + x
        document.getElementById(left).style.width= tmpLeft + 'px';
        document.getElementById("divider").style.left= tmpDivider + 'px';
        document.getElementById(right).style.left = tmpRight + 'px';
      };
    </script>

<script type="text/javascript">

  function mexpand(id)
  {
    var n = document.getElementById(id).style;
    n.display = "block";
  }

  function mcollapse(id)
  {
    var n = document.getElementById(id).style;
    n.display = "none";
  }

  var counter_max = 0;
  function mshow(id,loc)
  {
    var i;
    for(i=1; i<=counter_max; ++i)
      mcollapse("menu"+String(i));
    mexpand(id);
    window.location.replace(loc);
  }
</script>

<script type="text/javascript">

function expand(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/minus.gif";
  button.alt = "-";
  n.display = "block";
}
function collapse(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/plus.gif";
  button.alt = "+";
  n.display = "none";
}
function toggle(button,id)
{
  var n = document.getElementById(id).style;
  if (n.display == "none")
  {
    button.src = "/share/src/web/images/minus.gif";
    button.alt = "-";
    n.display = "block";
  }
  else
  {
    button.src = "/share/src/web/images/plus.gif";
    button.alt = "+";
    n.display = "none";
  }
}
var allbuttons = [
"Basics",
"Widgets",
"Button and Menu",
"One line edit widget",
"Integrated presentation.",
"Core types",
"Subsystem initialisation.",
"Font handling.",
"Colours.",
"Surfaces.",
"Drawables",
"Draw Chain",
"Windows",
"The Window Controller.",
"The Window Manager.",
"Widgets",
"Simple Click Button",
"Cascading Menu",
"Tools"
];
function expand_all(dummy)
{
  for (i in allbuttons)
  {
    expand(allbuttons[i], allbuttons[i]+"_d");
  }
}
function collapse_all(dummy)
{
  for (i in allbuttons)
  {
    collapse(allbuttons[i], allbuttons[i]+"_d");
  }
}
</script>

<script>
function mouseover(id)
{
  var elt = document.getElementById(id);
  elt.style.display="none";
  var elt2 = document.getElementById(id+"_mo");
  elt2.style.display="inline";
}

function mouseout(id)
{
  var elt = document.getElementById(id+"_mo");
  elt.style.display="none";
  var elt2 = document.getElementById(id);
  elt2.style.display="inline";
}

</script>
<script> function nop(dummy) {} </script>
    <div class="container">
      <div class="toppanel">
    <!--Main Content top navbar-->
<span style="position:relative; bottom:6px"
  onmouseover="mouseover('expand')"
  onmouseout="mouseout('expand')"
  onclick="expand_all('expand')"
  ><span id="expand"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span><span id="expand_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span></span><span style="position:relative; bottom:6px"
  onmouseover="mouseover('collapse')"
  onmouseout="mouseout('collapse')"
  onclick="collapse_all('collapse')"
  ><span id="collapse"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span><span id="collapse_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span></span>    <!--Main Content top navbar End-->

      </div> <!-- toppanel end -->
      <div class="bottompanel">
        <span id="divider" class="divider"></span>

        <span id="left" class="leftpanel" >
          <div class="menucontent">
  <!--Left Margin Toc-->
  <div id="leftmargintoc">
    <!--Left Margin Toc Main Contents-->
      <div class=m1 onclick="mshow('menu1','#Basics_h')"> <a href="#Basics_h">Basics</a></div>
      <div class=sm id=menu1>
      <div class=m2><a href="#Widgets_h">Widgets</a></div>
      <div class=m2><a href="#Integrated_presentation._h">Integrated presentation.</a></div>
      </div>
      <div class=m1 onclick="mshow('menu2','#Core types_h')"> <a href="#Core_types_h">Core types</a></div>
      <div class=sm id=menu2>
      <div class=m2><a href="#Subsystem_initialisation._h">Subsystem initialisation.</a></div>
      </div>
      <div class=m1 onclick="mshow('menu3','#Font handling._h')"> <a href="#Font_handling._h">Font handling.</a></div>
      <div class=sm id=menu3>
      <div class=m2><a href="#Colours._h">Colours.</a></div>
      <div class=m2><a href="#Surfaces._h">Surfaces.</a></div>
      <div class=m2><a href="#Drawables_h">Drawables</a></div>
      <div class=m2><a href="#Draw_Chain_h">Draw Chain</a></div>
      </div>
      <div class=m1 onclick="mshow('menu4','#Windows_h')"> <a href="#Windows_h">Windows</a></div>
      <div class=sm id=menu4>
      <div class=m2><a href="#The_Window_Controller._h">The Window Controller.</a></div>
      <div class=m2><a href="#The_Window_Manager._h">The Window Manager.</a></div>
      </div>
      <div class=m1 onclick="mshow('menu5','#Widgets_h')"> <a href="#Widgets_h">Widgets</a></div>
      <div class=sm id=menu5>
      <div class=m2><a href="#Simple_Click_Button_h">Simple Click Button</a></div>
      <div class=m2><a href="#Cascading_Menu_h">Cascading Menu</a></div>
      </div>
      <div class=m1 onclick="mshow('menu6','#Tools_h')"> <a href="#Tools_h">Tools</a></div>
      <div class=sm id=menu6>
      </div>
    <script>counter_max=6;</script>
  </div>
  <!--End Left Margin Toc-->

          </div> <!-- leftpanel contents end -->
        </span> <!-- leftpanel end -->

        <span id="right" class="rightpanel">
          <div class="maincontent">
<!--Main Content Body-->
<p>utitle GUI
</p><h1 id='Basics_h'><img src='/share/src/web/images/minus.gif' id='Basics' onclick='toggle(this,"Basics_d")' alt='+'/> 1 Basics</h1><div id='Basics_d' style='display:block'>
<p>The Felix portable GUI is based on the portable SDL library
and the Felix bindings thereof. SDL_ttf and SDL_image are
required too for font and image handling.
</p><pre class='inclusion'>
share/lib/gui/__init__.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"sdl/SDL2"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"sdl/SDL_ttf"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"sdl/SDL_image"</span>;
</pre></p><p>The basic SDL initialisation stuff.
</p><pre class='inclusion'>
share/lib/gui/__init__.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/init"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/types"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/events"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/font"</span>;
</pre></p><p>Basic GUI abstractions. Felix uses the Model-View-Controller (MVC)
design idea. 
</p><p>The <em>model</em> is representation of the abstract state.
independent of the visual interface.
</p><p>The <em>view</em> provides the operations required to render
the abstract state onto a graphical surface.
</p><p>The <em>controller</em> is responsible for event management
and in particular state mutations and scheduling display
updates corresponding to them in the view, based on input
from the client mouse and keyboard.
</p><pre class='inclusion'>
share/lib/gui/__init__.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/color"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/surface"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/drawable"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/drawchain"</span>;
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/window"</span>;
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/window_controller_interface"</span>;
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/window_controller"</span>;
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/window_manager"</span>;
<span class="lineno" id=line9></span>  
</pre></p><h2 id='Widgets_h'><img src='/share/src/web/images/minus.gif' id='Widgets' onclick='toggle(this,"Widgets_d")' alt='+'/> 1.1 Widgets</h2><div id='Widgets_d' style='display:block'>
<p>And of course now for some Widgets!
Felix uses a novel mechanism. It is not like other GUIs.
Where other systems use subtyping and callbacks, in Felix
the controllers for widgets are active threads of control
modelled by Felix fthreads (synchronous fibres).
</p><p>Widgets, and the window manager communicate using
schannels (synchronous channels) instead of using 
callbacks for message passing. This avoids the catastrophic
design failing of other GUI systems in which components
are reactive slaves. In Felix, the components are autonomous
active actors.
</p><p>In particular interfaces are primarily based on communication
protocols which allow plugins to provide services.
</p><h3 id='Button_and_Menu_h'><img src='/share/src/web/images/minus.gif' id='Button and Menu' onclick='toggle(this,"Button_and_Menu_d")' alt='+'/> 1.1.1 Button and Menu</h3><div id='Button_and_Menu_d' style='display:block'>
<p>Buttons and menus.
</p><pre class='inclusion'>
share/lib/gui/__init__.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/button"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/menu"</span>;
</pre></p></div><h3 id='One_line_edit_widget_h'><img src='/share/src/web/images/minus.gif' id='One line edit widget' onclick='toggle(this,"One_line_edit_widget_d")' alt='+'/> 1.1.2 One line edit widget</h3><div id='One_line_edit_widget_d' style='display:block'>
<pre class='inclusion'>
share/lib/gui/__init__.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/line_buffer_interface"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/line_buffer_object"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/line_buffer_display_controller_interface"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/line_buffer_display_controller"</span>;
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/line_editor"</span>;
</pre></p></div></div><h2 id='Integrated_presentation._h'><img src='/share/src/web/images/minus.gif' id='Integrated presentation.' onclick='toggle(this,"Integrated_presentation._d")' alt='+'/> 1.2 Integrated presentation.</h2><div id='Integrated_presentation._d' style='display:block'>
<p>Merge all the separate classes into a single
class to make it a all a bit easier to use.
</p><pre class='inclusion'>
share/lib/gui/__init__.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGui 
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiInit;
<span class="lineno" id=line4></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiTypes;
<span class="lineno" id=line5></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiEvents;
<span class="lineno" id=line6></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiFont;
<span class="lineno" id=line7></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiColor;
<span class="lineno" id=line8></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiSurface;
<span class="lineno" id=line9></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiDrawable;
<span class="lineno" id=line10></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiDrawChain;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiWindow;
<span class="lineno" id=line13></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiWindowController;
<span class="lineno" id=line14></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiWindowControllerInterface;
<span class="lineno" id=line15></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiWindowManager;
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiButton;
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiMenu;
<span class="lineno" id=line20></span>  
<span class="lineno" id=line21></span>   <span class="comment">// text field editor</span>
<span class="lineno" id=line22></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiLineBufferInterface;
<span class="lineno" id=line23></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiLineBuffer;
<span class="lineno" id=line24></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiLineBufferDisplayControllerInterface;
<span class="lineno" id=line25></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiLineBufferDisplayController;
<span class="lineno" id=line26></span>   <span class="big_keyword" title="Inherit symbols into a module or typeclass">inherit</span> FlxGuiLineEditor; 
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>  } <span class="comment">// class FlxGui</span>
<span class="lineno" id=line29></span>  
</pre></p></div></div><h1 id='Core_types_h'><img src='/share/src/web/images/minus.gif' id='Core types' onclick='toggle(this,"Core_types_d")' alt='+'/> 2 Core types</h1><div id='Core_types_d' style='display:block'>
<p>Mostly we just lift them from the sdl library
which in turn lifts them from the C SDL2 library.
</p><p>The result is somewhat messy, especially for messages,
since SDL's emulation of unions in C is a long way 
from the well presented sum type Felix would use.
</p><pre class='inclusion'>
share/lib/gui/types.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiTypes
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> font_t = TTF_Font;
<span class="lineno" id=line4></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> colour_t = SDL_Color;
<span class="lineno" id=line5></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> color_t = colour_t; <span class="comment">// dang yanks ..</span>
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>    <span class="comment">// rectangular shape without origin</span>
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> box_t = (w:<span class="library" title="binding of C int type">int</span>,h:<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> box_t(w:<span class="library" title="binding of C int type">int</span>,h:<span class="library" title="binding of C int type">int</span>)=&gt;(w=w,h=h);
<span class="lineno" id=line10></span>  
<span class="lineno" id=line11></span>    <span class="comment">// point</span>
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> point_t = SDL_Point;
<span class="lineno" id=line13></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> point_t(x:<span class="library" title="binding of C int type">int</span>,y:<span class="library" title="binding of C int type">int</span>)=&gt;SDL_Point(x,y);
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>    <span class="comment">// box with origin for label (margin, baseline)</span>
<span class="lineno" id=line16></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> label_box_t = (box:box_t, label_origin: point_t);
<span class="lineno" id=line17></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> label_box_t (box:box_t, label_origin: point_t)=&gt; (box=box,label_origin=label_origin);
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>    <span class="comment">// rectangular shape with top left origin</span>
<span class="lineno" id=line20></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> rect_t = SDL_Rect;
<span class="lineno" id=line21></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> rect_t (x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, w:<span class="library" title="binding of C int type">int</span>, h:<span class="library" title="binding of C int type">int</span>) =&gt; SDL_Rect (x,y,w,h);
<span class="lineno" id=line22></span>    <span class="big_keyword" title="Define a value constructor or conversion operator for a type">ctor</span> rect_t (xy:point_t, dim:box_t) =&gt; SDL_Rect (xy.x,xy.y,dim.w,dim.h);
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>    <span class="comment">// label rect</span>
<span class="lineno" id=line25></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> label_rect_t = (xy:point_t, lb: label_box_t);
<span class="lineno" id=line26></span>  }
<span class="lineno" id=line27></span>  
</pre></p><pre class='inclusion'>
share/lib/gui/events.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiEvents
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> event_t = SDL_Event;
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_QUIT (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_QUIT.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line6></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_WINDOWEVENT (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_WINDOWEVENT.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_WINDOWEVENT (e:event_t) =&gt; e.window;
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_KEYDOWN (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_KEYDOWN.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_KEYDOWN (e:event_t) =&gt; e.key;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_KEYUP (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_KEYUP.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line13></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_KEYUP(e:event_t) =&gt; e.key;
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_MOUSEMOTION (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_MOUSEMOTION.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line16></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_MOUSEMOTION (e:event_t) =&gt; e.motion;
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_MOUSEBUTTONDOWN (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_MOUSEBUTTONDOWN.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line19></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_MOUSEBUTTONDOWN (e:event_t) =&gt; e.button;
<span class="lineno" id=line20></span>  
<span class="lineno" id=line21></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_MOUSEBUTTONUP (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_MOUSEBUTTONUP.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line22></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_MOUSEBUTTONUP (e:event_t) =&gt; e.button;
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_MOUSEWHEEL  (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_MOUSEWHEEL.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line25></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_MOUSEWHEEL (e:event_t) =&gt; e.wheel;
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_TEXTINPUT (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_TEXTINPUT.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line28></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_TEXTINPUT (e:event_t) =&gt; e.text;
<span class="lineno" id=line29></span>  
<span class="lineno" id=line30></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _match_ctor_TEXTEDITING (e:event_t) =&gt; e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> == SDL_TEXTEDITING.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line31></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> _ctor_arg_TEXTEDITING (e:event_t) =&gt; e.edit;
<span class="lineno" id=line32></span>  
<span class="lineno" id=line33></span>    <span class="big_keyword" title="defines a coroutine using chip idiom">chip</span> event_source
<span class="lineno" id=line34></span>      <span class="small_keyword" title="the parameter of a chip">connector</span> events
<span class="lineno" id=line35></span>        <span class="small_keyword" title="a field of the chip parameter">pin</span> src : %&gt; event_t
<span class="lineno" id=line36></span>    {
<span class="lineno" id=line37></span>        <span class="big_keyword" title="Define a mutable variable">var</span> clock = Faio::mk_alarm_clock();
<span class="lineno" id=line38></span>        <span class="big_keyword" title="Define a mutable variable">var</span> e : SDL_Event;
<span class="lineno" id=line39></span>        <span class="comment">// dummy first event</span>
<span class="lineno" id=line40></span>        e&amp;.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> &lt;- SDL_FIRSTEVENT.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line41></span>        <span class="library" title="Print a string to a stream">write</span>$ events.src,e;
<span class="lineno" id=line42></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> waitevent()
<span class="lineno" id=line43></span>        {
<span class="lineno" id=line44></span>        nexte:&gt;
<span class="lineno" id=line45></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = SDL_PollEvent$ &amp;e;
<span class="lineno" id=line46></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line47></span>            Faio::sleep(clock,0.1);
<span class="lineno" id=line48></span>            <span class="small_keyword" title="jump to label">goto</span> nexte;
<span class="lineno" id=line49></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line50></span>        }
<span class="lineno" id=line51></span>        waitevent;
<span class="lineno" id=line52></span>        <span class="small_keyword" title="while loop">while</span> e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span>.SDL_EventType != SDL_QUIT <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line53></span>  <span class="comment">//println$ "SDL EVENT: " + e.type.SDL_EventType.str + " SDL window #" + e.window.windowID.str;</span>
<span class="lineno" id=line54></span>          <span class="library" title="Print a string to a stream">write</span>$ events.src, e;
<span class="lineno" id=line55></span>          waitevent;
<span class="lineno" id=line56></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line57></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"[event_source] SDL_QUIT seen!"</span>;
<span class="lineno" id=line58></span>        <span class="library" title="Print a string to a stream">write</span>$ events.src, e;
<span class="lineno" id=line59></span>        <span class="small_keyword" title="return">return</span>;
<span class="lineno" id=line60></span>    } <span class="comment">// chip event_source</span>
<span class="lineno" id=line61></span>  
<span class="lineno" id=line62></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> demo_timer (quit:&amp;bool) (<span class="big_keyword" title="Define a mutable variable">var</span> d:<span class="library" title="binding of C double float type">double</span>) ()
<span class="lineno" id=line63></span>    {
<span class="lineno" id=line64></span>      <span class="big_keyword" title="Define a mutable variable">var</span> delta = 0.1;
<span class="lineno" id=line65></span>      <span class="big_keyword" title="Define a mutable variable">var</span> clock = Faio::mk_alarm_clock();
<span class="lineno" id=line66></span>    again:&gt;
<span class="lineno" id=line67></span>      Faio::sleep(clock,delta);
<span class="lineno" id=line68></span>      d -= delta;
<span class="lineno" id=line69></span>      <span class="small_keyword" title="conditional">if</span> *quit <span class="small_keyword" title="jump to label">goto</span> doquit;
<span class="lineno" id=line70></span>      <span class="small_keyword" title="conditional">if</span> d &gt; 0.0 <span class="small_keyword" title="jump to label">goto</span> again;
<span class="lineno" id=line71></span>      quit &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line72></span>      <span class="big_keyword" title="Define a mutable variable">var</span> quitmsg : SDL_Event;
<span class="lineno" id=line73></span>      quitmsg&amp;.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> &lt;- SDL_QUIT.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line74></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"TIMEOUT"</span>;
<span class="lineno" id=line75></span>      <span class="hack">C_hack</span>::ignore(SDL_PushEvent(&amp;quitmsg)); 
<span class="lineno" id=line76></span>  doquit:&gt;
<span class="lineno" id=line77></span>    }
<span class="lineno" id=line78></span>  
<span class="lineno" id=line79></span>  }
</pre></p><h2 id='Subsystem_initialisation._h'><img src='/share/src/web/images/minus.gif' id='Subsystem initialisation.' onclick='toggle(this,"Subsystem_initialisation._d")' alt='+'/> 2.1 Subsystem initialisation.</h2><div id='Subsystem_initialisation._d' style='display:block'>
<p>Ensures we have visuals, sound, fonts, and images.
Display versions of libraries, both the one from
the compiled header files and the binary linked in.
</p><pre class='inclusion'>
share/lib/gui/init.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiInit
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> init()
<span class="lineno" id=line4></span>    {
<span class="lineno" id=line5></span>      <span class="small_keyword" title="conditional">if</span> SDL_Init(SDL_INIT_AUDIO \| SDL_INIT_VIDEO) &lt; 0  <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line6></span>        eprintln$ f<span class="fstring">"Unable to init SDL: %S\n"</span> #SDL_GetError;
<span class="lineno" id=line7></span>        System::exit(1);
<span class="lineno" id=line8></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line9></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"SDL_init OK"</span>;
<span class="lineno" id=line10></span>      <span class="small_keyword" title="conditional">if</span> TTF_Init() &lt; 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line11></span>        eprintln$ f<span class="fstring">"Unable to init TTF: %S\n"</span> #TTF_GetError;
<span class="lineno" id=line12></span>        System::exit(1);
<span class="lineno" id=line13></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line14></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"TTF_init OK"</span>;
<span class="lineno" id=line15></span>      <span class="small_keyword" title="conditional">if</span> IMG_Init(IMG_INIT_PNG) &lt; 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line16></span>        eprintln$ f<span class="fstring">"Unable to init IMG with PNG: %S\n"</span> #IMG_GetError;
<span class="lineno" id=line17></span>        System::exit(1);
<span class="lineno" id=line18></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line19></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"IMG_init OK"</span>;
<span class="lineno" id=line20></span>    }
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> quit() { SDL_Quit(); }
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> versions ()
<span class="lineno" id=line25></span>    {
<span class="lineno" id=line26></span>      <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line27></span>        <span class="big_keyword" title="Define a mutable variable">var</span> compiled = #SDL_Compiled_Version;
<span class="lineno" id=line28></span>        <span class="big_keyword" title="Define a mutable variable">var</span> linked = #SDL_Linked_Version;
<span class="lineno" id=line29></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"We compiled against SDL version %d.%d.%d ..."</span>
<span class="lineno" id=line30></span>          (compiled.major.<span class="library" title="binding of C int type">int</span>, compiled.minor.<span class="library" title="binding of C int type">int</span>, compiled.patch.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line31></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"But we are linking against SDL version %d.%d.%d."</span>
<span class="lineno" id=line32></span>          (linked.major.<span class="library" title="binding of C int type">int</span>, linked.minor.<span class="library" title="binding of C int type">int</span>, linked.patch.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line33></span>      <span class="small_keyword" title="end of extension">end</span> 
<span class="lineno" id=line34></span>  
<span class="lineno" id=line35></span>      <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line36></span>        <span class="big_keyword" title="Define a mutable variable">var</span> compiled = #TTF_Compiled_Version;
<span class="lineno" id=line37></span>        <span class="big_keyword" title="Define a mutable variable">var</span> linked = #TTF_Linked_Version;
<span class="lineno" id=line38></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"We compiled against TTF version %d.%d.%d ..."</span>
<span class="lineno" id=line39></span>          (compiled.major.<span class="library" title="binding of C int type">int</span>, compiled.minor.<span class="library" title="binding of C int type">int</span>, compiled.patch.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line40></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"But we are linking against TTF version %d.%d.%d."</span>
<span class="lineno" id=line41></span>          (linked.major.<span class="library" title="binding of C int type">int</span>, linked.minor.<span class="library" title="binding of C int type">int</span>, linked.patch.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line42></span>      <span class="small_keyword" title="end of extension">end</span> 
<span class="lineno" id=line43></span>  
<span class="lineno" id=line44></span>      <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line45></span>        <span class="big_keyword" title="Define a mutable variable">var</span> compiled = #IMG_Compiled_Version;
<span class="lineno" id=line46></span>        <span class="big_keyword" title="Define a mutable variable">var</span> linked = #IMG_Linked_Version;
<span class="lineno" id=line47></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"We compiled against IMG version %d.%d.%d ..."</span>
<span class="lineno" id=line48></span>          (compiled.major.<span class="library" title="binding of C int type">int</span>, compiled.minor.<span class="library" title="binding of C int type">int</span>, compiled.patch.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line49></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"But we are linking against IMG version %d.%d.%d."</span>
<span class="lineno" id=line50></span>          (linked.major.<span class="library" title="binding of C int type">int</span>, linked.minor.<span class="library" title="binding of C int type">int</span>, linked.patch.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line51></span>      <span class="small_keyword" title="end of extension">end</span> 
<span class="lineno" id=line52></span>    } 
<span class="lineno" id=line53></span>  
<span class="lineno" id=line54></span>  }
</pre></p></div></div><h1 id='Font_handling._h'><img src='/share/src/web/images/minus.gif' id='Font handling.' onclick='toggle(this,"Font_handling._d")' alt='+'/> 3 Font handling.</h1><div id='Font_handling._d' style='display:block'>
<p>Felix uses SDL_ttf which in turn uses Freetype to render
TrueType fonts with some hinting. Unfortunately in my experience
the rending is appalling. The glyphs are barely readable.
It is not known if this problem is with SDL_ttf or Freetype.
The rending is just barely good enough for GUI tools such as game
scenario editors, it wouldn't be useful in game.
</p><p>Felix provides three fonts borrowed from Apple to save the user
from having to set up a font library Felix knows about.
</p><pre class='inclusion'>
share/lib/gui/font.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiFont
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (s:<span class="library" title="binding of C++ string type">string</span>, t:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (s,t);
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> dflt_mono_font() =&gt; #Config::std_config.FLX_SHARE_DIR/ <span class="fstring">"src"</span>/<span class="fstring">"lib"</span>/<span class="fstring">"fonts"</span>/ <span class="fstring">"Courier New.ttf"</span>;  
<span class="lineno" id=line6></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> dflt_sans_serif_font() =&gt; #Config::std_config.FLX_SHARE_DIR/ <span class="fstring">"src"</span>/<span class="fstring">"lib"</span>/<span class="fstring">"fonts"</span>/ <span class="fstring">"Arial.ttf"</span>;  
<span class="lineno" id=line7></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> dflt_serif_font() =&gt; #Config::std_config.FLX_SHARE_DIR/ <span class="fstring">"src"</span>/<span class="fstring">"lib"</span>/<span class="fstring">"fonts"</span>/ <span class="fstring">"Times New Roman.ttf"</span>;  
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> get_font (font_file:<span class="library" title="binding of C++ string type">string</span>, ptsize:<span class="library" title="binding of C int type">int</span>) = {
<span class="lineno" id=line10></span>      <span class="big_keyword" title="Define a mutable variable">var</span> font = TTF_OpenFont (font_file,ptsize);
<span class="lineno" id=line11></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> (TTF_ValidFont font) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line12></span>        eprintln$ f<span class="fstring">"Unable to open TTF font %S\n"</span> font_file;
<span class="lineno" id=line13></span>        System::exit 1;
<span class="lineno" id=line14></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line15></span>      TTF_SetFontKerning (font,0);
<span class="lineno" id=line16></span>      <span class="big_keyword" title="Define a mutable variable">var</span> isfixed = TTF_FontFaceIsFixedWidth (font);
<span class="lineno" id=line17></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Opened Font "</span> + font_file + 
<span class="lineno" id=line18></span>        <span class="fstring">" Facename: "</span> + TTF_FontFaceFamilyName font + 
<span class="lineno" id=line19></span>        (<span class="small_keyword" title="conditional">if</span> isfixed&gt;0 <span class="small_keyword" title="conditional">then</span> <span class="fstring">" MONOSPACED "</span>+ isfixed.<span class="library" title="Convert a value to a string">str</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">" VARIABLE WIDTH"</span>);
<span class="lineno" id=line20></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Metrics: Height "</span>+font.TTF_FontHeight.<span class="library" title="Convert a value to a string">str</span> + 
<span class="lineno" id=line21></span>        <span class="fstring">", Ascent "</span>+ font.TTF_FontAscent.<span class="library" title="Convert a value to a string">str</span> +
<span class="lineno" id=line22></span>        <span class="fstring">", Descent "</span>+ font.TTF_FontDescent.<span class="library" title="Convert a value to a string">str</span> +
<span class="lineno" id=line23></span>        <span class="fstring">", Lineskip"</span>+ font.TTF_FontLineSkip.<span class="library" title="Convert a value to a string">str</span>
<span class="lineno" id=line24></span>      ;
<span class="lineno" id=line25></span>      TTF_SetFontHinting (font,TTF_HINTING_MONO); <span class="comment">// guess...</span>
<span class="lineno" id=line26></span>      <span class="small_keyword" title="return">return</span> font;
<span class="lineno" id=line27></span>    }
<span class="lineno" id=line28></span>  
<span class="lineno" id=line29></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_lineskip (f: font_t) =&gt; TTF_FontLineSkip(f) + 1;
<span class="lineno" id=line30></span>  
<span class="lineno" id=line31></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_textsize (f: font_t, s:<span class="library" title="binding of C++ string type">string</span>) = 
<span class="lineno" id=line32></span>    {
<span class="lineno" id=line33></span>      <span class="big_keyword" title="Define a mutable variable">var</span> w: <span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> h: <span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line34></span>      <span class="hack">C_hack</span>::ignore$ TTF_SizeText (f,s,&amp;w, &amp;h);
<span class="lineno" id=line35></span>      <span class="small_keyword" title="return">return</span> w,h;
<span class="lineno" id=line36></span>    }
<span class="lineno" id=line37></span>  
<span class="lineno" id=line38></span>    <span class="comment">// x,y is the origin  of the first character</span>
<span class="lineno" id=line39></span>    <span class="comment">// The bounding box is 2 pixels up from the highest char</span>
<span class="lineno" id=line40></span>    <span class="comment">// 2 pixies down from the lowest char</span>
<span class="lineno" id=line41></span>    <span class="comment">// 2 pixies to the left of the first character's orgin</span>
<span class="lineno" id=line42></span>    <span class="comment">// and 2 pix right from the origin of the last char + the notional advance</span>
<span class="lineno" id=line43></span>    <span class="comment">// this ONLY works right for a monospaced font!</span>
<span class="lineno" id=line44></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> bounding_box (f:font_t, x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, s:<span class="library" title="binding of C++ string type">string</span>) : rect_t =
<span class="lineno" id=line45></span>    {
<span class="lineno" id=line46></span>      <span class="big_keyword" title="Define a mutable variable">var</span> n = s.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line47></span>      <span class="big_keyword" title="Define a mutable variable">var</span> w = 
<span class="lineno" id=line48></span>        #{ 
<span class="lineno" id=line49></span>          <span class="big_keyword" title="Define a mutable variable">var</span> minx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> miny:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxy:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> advance:<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line50></span>          <span class="hack">C_hack</span>::ignore$ TTF_GlyphMetrics(f,<span class="fstring">"m"</span>.<span class="library" title="binding of C char type">char</span>.ord.<span class="library" title="binding of C uint16_t type">uint16</span>,&amp;minx, &amp;maxx, &amp;miny, &amp;maxy, &amp;advance);
<span class="lineno" id=line51></span>          <span class="small_keyword" title="return">return</span> advance;
<span class="lineno" id=line52></span>        }
<span class="lineno" id=line53></span>      ;
<span class="lineno" id=line54></span>      <span class="big_keyword" title="Define a mutable variable">var</span> a = f.TTF_FontAscent;
<span class="lineno" id=line55></span>      <span class="big_keyword" title="Define a mutable variable">var</span> d = f.TTF_FontDescent;
<span class="lineno" id=line56></span>      <span class="comment">// the 5 = 4 + 1 is due to what looks like a BUG in SDL or TTF:</span>
<span class="lineno" id=line57></span>      <span class="comment">// for at least one font, height = ascent - descent + 1</span>
<span class="lineno" id=line58></span>      <span class="comment">// even though lineskip = ascent - descent</span>
<span class="lineno" id=line59></span>      <span class="small_keyword" title="return">return</span> SDL_Rect (x - 2,y - a - 2, w * n +4, a - d + 5);
<span class="lineno" id=line60></span>    }
<span class="lineno" id=line61></span>  }
<span class="lineno" id=line62></span>  
</pre></p><h2 id='Colours._h'><img src='/share/src/web/images/minus.gif' id='Colours.' onclick='toggle(this,"Colours._d")' alt='+'/> 3.1 Colours.</h2><div id='Colours._d' style='display:block'>
<p>Felix uses RGBA colour scheme: 8 bits of Red, Blue and Green
followed by 8 bits of transparency, where 0 means no colour
and full transparency, and 255 means maximum colour and opaque
rendering.
</p><pre class='inclusion'>
share/lib/gui/color.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiColor
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> RGB (r:<span class="library" title="binding of C int type">int</span>, g:<span class="library" title="binding of C int type">int</span>, b:<span class="library" title="binding of C int type">int</span>) =&gt; 
<span class="lineno" id=line4></span>      SDL_Color (r.<span class="library" title="binding of C uint8_t type">uint8</span>, g.<span class="library" title="binding of C uint8_t type">uint8</span>, b.<span class="library" title="binding of C uint8_t type">uint8</span>, 255u8)
<span class="lineno" id=line5></span>    ;
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>    <span class="comment">// create some colours and clear the window</span>
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Define a mutable variable">var</span> white = RGB (255,255,255);
<span class="lineno" id=line9></span>    <span class="big_keyword" title="Define a mutable variable">var</span> black = RGB (0,0,0);
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Define a mutable variable">var</span> lightgrey = RGB (180,180,180);
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Define a mutable variable">var</span> grey = RGB (100,100,100);
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a mutable variable">var</span> darkgrey = RGB (60,60,60);
<span class="lineno" id=line13></span>    <span class="big_keyword" title="Define a mutable variable">var</span> red = RGB(255,0,0);
<span class="lineno" id=line14></span>    <span class="big_keyword" title="Define a mutable variable">var</span> green = RGB (0,255,0);
<span class="lineno" id=line15></span>    <span class="big_keyword" title="Define a mutable variable">var</span> blue = RGB (0,0,255);
<span class="lineno" id=line16></span>    <span class="big_keyword" title="Define a mutable variable">var</span> purple = RGB (255,0,255);
<span class="lineno" id=line17></span>    <span class="big_keyword" title="Define a mutable variable">var</span> yellow = RGB (255,255,0);
<span class="lineno" id=line18></span>    <span class="big_keyword" title="Define a mutable variable">var</span> orange = RGB (100,255,100);
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>  }
<span class="lineno" id=line21></span>  
</pre></p></div><h2 id='Surfaces._h'><img src='/share/src/web/images/minus.gif' id='Surfaces.' onclick='toggle(this,"Surfaces._d")' alt='+'/> 3.2 Surfaces.</h2><div id='Surfaces._d' style='display:block'>
<p>A surface is something you can do simple drawing on.
It is basically a representation of a rectangular grid
of pixels. The pixels may support full RGBA or not,
depending on construction. For example we might provide
a bitmap which supports only black and white using a 1
bit encoding.
</p><p>Each window will have a native surface onto which we must
render the imagery we wish to appear on the client display
device. In general, however, we should be using full RGBA
arrays for rendering and then blit those arrays onto hardware
dependent surfaces.
</p><p>SDL only provides a very limited set of operations on
surfaces! Complex rendering requires OpenGL. But we do
not need that in GUI.
</p><pre class='inclusion'>
share/lib/gui/surface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiSurface
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> clear(surf:&amp;SDL_Surface) (c: colour_t)
<span class="lineno" id=line4></span>    {
<span class="lineno" id=line5></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pixelformat : &amp;SDL_PixelFormat  = surf*.format;
<span class="lineno" id=line6></span>      <span class="big_keyword" title="Define a mutable variable">var</span> bgpixels = SDL_MapRGB(pixelformat,c.r,c.g,c.b);
<span class="lineno" id=line7></span>      SDL_ClearClipRect (surf);
<span class="lineno" id=line8></span>      <span class="hack">C_hack</span>::ignore$ SDL_FillSurface (surf, bgpixels);
<span class="lineno" id=line9></span>    }
<span class="lineno" id=line10></span>  
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> fill (surf:&amp;SDL_Surface) (<span class="big_keyword" title="Define a mutable variable">var</span> r:rect_t, c:colour_t)
<span class="lineno" id=line12></span>    {
<span class="lineno" id=line13></span>      SDL_ClearClipRect (surf);
<span class="lineno" id=line14></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pixelformat : &amp;SDL_PixelFormat  = surf*.format;
<span class="lineno" id=line15></span>      <span class="big_keyword" title="Define a mutable variable">var</span> bgpixels = SDL_MapRGB(pixelformat,c.r,c.g,c.b);
<span class="lineno" id=line16></span>      <span class="hack">C_hack</span>::ignore$ SDL_FillRect (surf, &amp;r, bgpixels);
<span class="lineno" id=line17></span>      SDL_ClearClipRect (surf);
<span class="lineno" id=line18></span>    }
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> draw_line (surf:&amp;SDL_Surface)  (c:color_t, x0:<span class="library" title="binding of C int type">int</span>, y0:<span class="library" title="binding of C int type">int</span>, x1:<span class="library" title="binding of C int type">int</span>, y1:<span class="library" title="binding of C int type">int</span>)
<span class="lineno" id=line21></span>    {
<span class="lineno" id=line22></span>       <span class="big_keyword" title="Define a mutable variable">var</span> r: SDL_Renderer = SDL_CreateSoftwareRenderer surf;
<span class="lineno" id=line23></span>       <span class="hack">C_hack</span>::ignore$ SDL_SetRenderDrawColor (r, c.r, c.g, c.b, c.a);
<span class="lineno" id=line24></span>       <span class="hack">C_hack</span>::ignore$ SDL_RenderDrawLine (r, x0, y0, x1, y1);
<span class="lineno" id=line25></span>       SDL_DestroyRenderer r;
<span class="lineno" id=line26></span>    }
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> <span class="library" title="Print a string to a stream">write</span>(surf:&amp;SDL_Surface) (x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, font:font_t, c: colour_t, s:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line29></span>    {
<span class="lineno" id=line30></span>      <span class="big_keyword" title="Define a mutable variable">var</span> rendered = TTF_RenderText_Solid (font,s,c);
<span class="lineno" id=line31></span>      <span class="big_keyword" title="Define a mutable variable">var</span> rect : SDL_Rect;
<span class="lineno" id=line32></span>  
<span class="lineno" id=line33></span>      <span class="big_keyword" title="Define a mutable variable">var</span> minx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> miny:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxy:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> advance:<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line34></span>      <span class="hack">C_hack</span>::ignore$ TTF_GlyphMetrics(font,<span class="fstring">"m"</span>.<span class="library" title="binding of C char type">char</span>.ord.<span class="library" title="binding of C uint16_t type">uint16</span>,&amp;minx, &amp;maxx, &amp;miny, &amp;maxy, &amp;advance);
<span class="lineno" id=line35></span>      
<span class="lineno" id=line36></span>      rect&amp;.x &lt;- x + (min (minx,0));
<span class="lineno" id=line37></span>      rect&amp;.y &lt;- y - maxy;
<span class="lineno" id=line38></span>      <span class="big_keyword" title="Define a mutable variable">var</span> nullRect = <span class="hack">C_hack</span>::null[SDL_Rect];
<span class="lineno" id=line39></span>  
<span class="lineno" id=line40></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = SDL_BlitSurface (rendered, nullRect, surf, &amp;rect); 
<span class="lineno" id=line41></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line42></span>        eprintln$ <span class="fstring">"Unable to blit text to surface"</span>;
<span class="lineno" id=line43></span>        System::exit 1;
<span class="lineno" id=line44></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line45></span>      SDL_FreeSurface rendered;
<span class="lineno" id=line46></span>    }
<span class="lineno" id=line47></span>  
<span class="lineno" id=line48></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> blit (surf:&amp;SDL_Surface) (dstx:<span class="library" title="binding of C int type">int</span>, dsty:<span class="library" title="binding of C int type">int</span>, src: &amp;SDL_Surface)
<span class="lineno" id=line49></span>    {
<span class="lineno" id=line50></span>      <span class="big_keyword" title="Define a mutable variable">var</span> nullRect = <span class="hack">C_hack</span>::null[SDL_Rect];
<span class="lineno" id=line51></span>      <span class="big_keyword" title="Define a mutable variable">var</span> dstRect = rect_t (dstx, dsty,0,0);
<span class="lineno" id=line52></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = SDL_BlitSurface (src, nullRect, surf, &amp;dstRect);
<span class="lineno" id=line53></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line54></span>        eprintln$ <span class="fstring">"Unable to blit surface to surface at ("</span> + dstx.<span class="library" title="Convert a value to a string">str</span> + <span class="fstring">","</span> + dsty.<span class="library" title="Convert a value to a string">str</span> + <span class="fstring">")"</span>;
<span class="lineno" id=line55></span>        <span class="comment">//System::exit 1;</span>
<span class="lineno" id=line56></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line57></span>  
<span class="lineno" id=line58></span>    } 
<span class="lineno" id=line59></span>  
<span class="lineno" id=line60></span>    <span class="big_keyword" title="define an object interface">interface</span> surface_t {
<span class="lineno" id=line61></span>      get_sdl_surface: 1 -&gt; &amp;SDL_Surface;
<span class="lineno" id=line62></span>      get_width : 1 -&gt; <span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line63></span>      get_height: 1 -&gt; <span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line64></span>      clear: colour_t -&gt; 0;
<span class="lineno" id=line65></span>      fill: rect_t * colour_t -&gt; 0;
<span class="lineno" id=line66></span>      draw_line: colour_t * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> -&gt; 0; <span class="comment">// x0,y0,x1,y1</span>
<span class="lineno" id=line67></span>      <span class="library" title="Print a string to a stream">write</span>: <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * font_t * colour_t * <span class="library" title="binding of C++ string type">string</span> -&gt; 0;
<span class="lineno" id=line68></span>    }
<span class="lineno" id=line69></span>  
<span class="lineno" id=line70></span>    <span class="comment">// Wrapper around SDL surface</span>
<span class="lineno" id=line71></span>    <span class="comment">// borrows the SDL_Surface!! Does not own or delete</span>
<span class="lineno" id=line72></span>    <span class="big_keyword" title="define an object factory">object</span> surface (surf: &amp;SDL_Surface) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> surface_t =
<span class="lineno" id=line73></span>    {
<span class="lineno" id=line74></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_sdl_surface () =&gt; surf;
<span class="lineno" id=line75></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_width () =&gt; surf*.w;
<span class="lineno" id=line76></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_height() =&gt; surf*.h;
<span class="lineno" id=line77></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> clear (c:colour_t) =&gt; FlxGuiSurface::clear surf c;
<span class="lineno" id=line78></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> fill (r:rect_t, c:colour_t) =&gt; FlxGuiSurface::fill surf (r,c);
<span class="lineno" id=line79></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> draw_line (c:colour_t, x0:<span class="library" title="binding of C int type">int</span>, y0:<span class="library" title="binding of C int type">int</span>, x1:<span class="library" title="binding of C int type">int</span>, y1:<span class="library" title="binding of C int type">int</span>) { FlxGuiSurface::draw_line surf (c,x0,y0,x1,y1); }
<span class="lineno" id=line80></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> <span class="library" title="Print a string to a stream">write</span> (x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, font:font_t, c: colour_t, s:<span class="library" title="binding of C++ string type">string</span>) { FlxGuiSurface::<span class="library" title="Print a string to a stream">write</span> surf (x,y,font,c,s); }
<span class="lineno" id=line81></span>    }
<span class="lineno" id=line82></span>  
<span class="lineno" id=line83></span>    <span class="comment">// Takes possession of the surface</span>
<span class="lineno" id=line84></span>    <span class="comment">// Frees surface when object is freed by GC</span>
<span class="lineno" id=line85></span>  
<span class="lineno" id=line86></span>    <span class="big_keyword" title="Specify C code to be inserted into header file">header</span> surface_deleter = """<span class="embedded_c">
<span class="lineno" id=line87></span>      <span class="big_keyword">struct</span> _SDL_SurfaceDeleter {
<span class="lineno" id=line88></span>         _SDL_Surface *p;
<span class="lineno" id=line89></span>         _SDL_SurfaceDeleter () : p (nullptr) {}
<span class="lineno" id=line90></span>         ~_SDL_SurfaceDeleter () { SDL_FreeSurface (p); }
<span class="lineno" id=line91></span>      };
<span class="lineno" id=line92></span>    </span>""";
<span class="lineno" id=line93></span>    <span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> surface_holder_t = <span class="fstring">"surface_deleter"</span> <span class="big_keyword" title="specify requirements">requires</span> surface_deleter;
<span class="lineno" id=line94></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set : &amp;surface_holder_t * &amp;SDL_Surface = <span class="fstring">"$1-&gt;p=$2;"</span>;
<span class="lineno" id=line95></span>  
<span class="lineno" id=line96></span>    <span class="big_keyword" title="define an object factory">object</span> owned_surface (surf: &amp;SDL_Surface) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> surface_t =
<span class="lineno" id=line97></span>    {
<span class="lineno" id=line98></span>      <span class="big_keyword" title="Define a mutable variable">var</span> holder: surface_holder_t;
<span class="lineno" id=line99></span>      set (&amp;holder, surf);
<span class="lineno" id=line100></span>  
<span class="lineno" id=line101></span>      <span class="comment">// returns a LOAN of the surface only</span>
<span class="lineno" id=line102></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_sdl_surface () =&gt; surf;
<span class="lineno" id=line103></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_width () =&gt; surf*.w;
<span class="lineno" id=line104></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_height() =&gt; surf*.h;
<span class="lineno" id=line105></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> clear (c:colour_t) =&gt; FlxGuiSurface::clear surf c;
<span class="lineno" id=line106></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> fill (r:rect_t, c:colour_t) =&gt; FlxGuiSurface::fill surf (r,c);
<span class="lineno" id=line107></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> draw_line (c:colour_t, x0:<span class="library" title="binding of C int type">int</span>, y0:<span class="library" title="binding of C int type">int</span>, x1:<span class="library" title="binding of C int type">int</span>, y1:<span class="library" title="binding of C int type">int</span>) { FlxGuiSurface::draw_line surf (c,x0,y0,x1,y1); }
<span class="lineno" id=line108></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> <span class="library" title="Print a string to a stream">write</span> (x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, font:font_t, c: colour_t, s:<span class="library" title="binding of C++ string type">string</span>) { FlxGuiSurface::<span class="library" title="Print a string to a stream">write</span> surf (x,y,font,c,s); }
<span class="lineno" id=line109></span>    }
<span class="lineno" id=line110></span>  
<span class="lineno" id=line111></span>  }
</pre></p></div><h2 id='Drawables_h'><img src='/share/src/web/images/minus.gif' id='Drawables' onclick='toggle(this,"Drawables_d")' alt='+'/> 3.3 Drawables</h2><div id='Drawables_d' style='display:block'>
<p>Things which can draw on surface planes.
A surface provides x,y coordinates, a plane adds a z coordinate.
The z coordinate is used to control drawing order: the drawables
with lowest z are applied first.
</p><pre class='inclusion'>
share/lib/gui/drawable.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiDrawable
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="define an object interface">interface</span> drawable_t {
<span class="lineno" id=line4></span>       draw: surface_t -&gt; 0;
<span class="lineno" id=line5></span>       get_z: 1 -&gt; <span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line6></span>       get_tag: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line7></span>    }
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>    <span class="big_keyword" title="define an object factory">object</span> drawable (tag:<span class="library" title="binding of C++ string type">string</span>) (z:<span class="library" title="binding of C uint32_t type">uint32</span>) (d: surface_t -&gt; 0) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> drawable_t = 
<span class="lineno" id=line10></span>    {
<span class="lineno" id=line11></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_z () =&gt; z;
<span class="lineno" id=line12></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> draw (surf:surface_t) =&gt; d surf;
<span class="lineno" id=line13></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_tag () =&gt; tag;
<span class="lineno" id=line14></span>    }
<span class="lineno" id=line15></span>  
<span class="lineno" id=line16></span>    <span class="comment">// given some routine like draw_line (s:&amp;SDL_surface) (p:parameters)</span>
<span class="lineno" id=line17></span>    <span class="comment">// this wrapper constructs a drawable by adding a tag name, a Z coordinate</span>
<span class="lineno" id=line18></span>    <span class="comment">// and binding the parameters.</span>
<span class="lineno" id=line19></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> mk_drawable[T] (tag:<span class="library" title="binding of C++ string type">string</span>) (z:<span class="library" title="binding of C uint32_t type">uint32</span>) (d: &amp;SDL_Surface -&gt; T -&gt; 0) (<span class="big_keyword" title="Define a mutable variable">var</span> a:T) : drawable_t =&gt; 
<span class="lineno" id=line20></span>      drawable tag z (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (s:surface_t) { d (s.get_sdl_surface()) a; })
<span class="lineno" id=line21></span>    ;
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> mk_drawable[T] (d: &amp;SDL_Surface -&gt; T -&gt; 0) (<span class="big_keyword" title="Define a mutable variable">var</span> a:T) : drawable_t =&gt; 
<span class="lineno" id=line24></span>      drawable <span class="fstring">"notag"</span> 100u32 (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (s:surface_t) { d (s.get_sdl_surface()) a; })
<span class="lineno" id=line25></span>    ;
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> mk_drawable[T] (tag:<span class="library" title="binding of C++ string type">string</span>) (d: &amp;SDL_Surface -&gt; T -&gt; 0) (<span class="big_keyword" title="Define a mutable variable">var</span> a:T) : drawable_t =&gt; 
<span class="lineno" id=line28></span>      drawable tag 100u32 (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (s:surface_t) { d (s.get_sdl_surface()) a; })
<span class="lineno" id=line29></span>    ;
<span class="lineno" id=line30></span>    
<span class="lineno" id=line31></span>  }
<span class="lineno" id=line32></span>  
</pre></p></div><h2 id='Draw_Chain_h'><img src='/share/src/web/images/minus.gif' id='Draw Chain' onclick='toggle(this,"Draw_Chain_d")' alt='+'/> 3.4 Draw Chain</h2><div id='Draw_Chain_d' style='display:block'>
<p>A dynamic set of drawables, maintained in Z order.
The draw method draws the drawables in the stored Z order.
Drawchains are used to schedule and manage the appearance of
a window surface for which drawing is demanded asynchronously
from the scheduling. This is usual in windowing systems where
the window can be hidden, exposed, or require display 
by events occuring at times different to the events such as mouse
clicks triggering state changes.
</p><pre class='inclusion'>
share/lib/gui/drawchain.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/__init__"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiDrawChain
<span class="lineno" id=line3></span>  {
<span class="lineno" id=line4></span>    <span class="big_keyword" title="Open a module or class">open</span> FlxGui;
<span class="lineno" id=line5></span>    <span class="big_keyword" title="define an object interface">interface</span> drawchain_t {
<span class="lineno" id=line6></span>      draw: surface_t -&gt; 0;
<span class="lineno" id=line7></span>      remove: <span class="library" title="binding of C++ string type">string</span> -&gt; 0;
<span class="lineno" id=line8></span>      add: drawable_t -&gt; 0;
<span class="lineno" id=line9></span>      <span class="library" title="number of elements in data structure">len</span>: 1 -&gt; <span class="library" title="binding of C size_t type">size</span>;
<span class="lineno" id=line10></span>      get_drawables : 1 -&gt; <span class="library" title="array with unbounded dynamically variable limit">darray</span>[drawable_t];
<span class="lineno" id=line11></span>    }
<span class="lineno" id=line12></span>  
<span class="lineno" id=line13></span>    <span class="big_keyword" title="define an object factory">object</span> drawchain() <span class="small_keyword" title="specify what interfaces an object implements">implements</span> drawchain_t = 
<span class="lineno" id=line14></span>    {
<span class="lineno" id=line15></span>      <span class="big_keyword" title="Define a mutable variable">var</span> drawables = <span class="library" title="array with unbounded dynamically variable limit">darray</span>[drawable_t] ();
<span class="lineno" id=line16></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="number of elements in data structure">len</span> () =&gt; drawables.<span class="library" title="number of elements in data structure">len</span>;
<span class="lineno" id=line17></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_drawables () =&gt; drawables;
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> draw (surf: surface_t) 
<span class="lineno" id=line20></span>      {
<span class="lineno" id=line21></span>  <span class="comment">//println$ "----";</span>
<span class="lineno" id=line22></span>        <span class="small_keyword" title="for loop">for</span> d <span class="small_keyword" title="membership operator, function mem">in</span> drawables <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line23></span>          d.draw surf; 
<span class="lineno" id=line24></span>  <span class="comment">//println$ "Drawn " + d.get_tag() + " " + #(d.get_z).str;</span>
<span class="lineno" id=line25></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line26></span>      }
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> remove (tag:<span class="library" title="binding of C++ string type">string</span>)  
<span class="lineno" id=line29></span>      {
<span class="lineno" id=line30></span>  <span class="comment">//println$ "remove " + tag;</span>
<span class="lineno" id=line31></span>        <span class="big_keyword" title="Define a mutable variable">var</span> i = 0;
<span class="lineno" id=line32></span>        <span class="small_keyword" title="while loop">while</span> i &lt; drawables.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line33></span>          <span class="small_keyword" title="conditional">if</span> drawables.i.get_tag () == tag <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line34></span>            erase (drawables, i);
<span class="lineno" id=line35></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line36></span>            ++i;
<span class="lineno" id=line37></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line38></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line39></span>      }
<span class="lineno" id=line40></span>  
<span class="lineno" id=line41></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> add (d:drawable_t) 
<span class="lineno" id=line42></span>      {
<span class="lineno" id=line43></span>        <span class="big_keyword" title="Define a mutable variable">var</span> z = d.get_z ();
<span class="lineno" id=line44></span>        <span class="big_keyword" title="Define a mutable variable">var</span> i = 0;
<span class="lineno" id=line45></span>      next:&gt;
<span class="lineno" id=line46></span>        <span class="small_keyword" title="conditional">if</span> i == drawables.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line47></span>          push_back (drawables, d);
<span class="lineno" id=line48></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line49></span>          <span class="small_keyword" title="conditional">if</span> drawables.i.get_z() &gt; z <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line50></span>            insert(drawables, i, d);
<span class="lineno" id=line51></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line52></span>            ++i;
<span class="lineno" id=line53></span>            <span class="small_keyword" title="jump to label">goto</span> next;
<span class="lineno" id=line54></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line55></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line56></span>      }
<span class="lineno" id=line57></span>    }
<span class="lineno" id=line58></span>  }
<span class="lineno" id=line59></span>  
<span class="lineno" id=line60></span>  
</pre></p></div></div><h1 id='Windows_h'><img src='/share/src/web/images/minus.gif' id='Windows' onclick='toggle(this,"Windows_d")' alt='+'/> 4 Windows</h1><div id='Windows_d' style='display:block'>
<p>We provide a model for a platform dependent top level overlapping window.
Windows provide a method to get a surface in the same pixel format
as the window. We draw on that then use update operation to synchronise
transfer of the surface to the hardware screen. 
</p><p>The provided surface may be the actual window surface in video ram, 
or it may be a software surface which is blitted to the hardware by 
system dependent operations.
</p><p>NOTE: in earlier SDL2 versions there is a catastrophic bug when
a window is hidden: the surface becomes invalid. So it is not
possible to create the window hidden, initialise it with 
imagery, and then display it. This means there may be a flicker
on window creation as the unpopulated window image is shown then
replaced by a populated display.
</p><pre class='inclusion'>
share/lib/gui/window.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiWindow
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="define an object interface">interface</span> window_t {
<span class="lineno" id=line4></span>      get_sdl_window : 1 -&gt; SDL_Window;
<span class="lineno" id=line5></span>      get_sdl_surface: 1 -&gt; &amp;SDL_Surface;
<span class="lineno" id=line6></span>      get_sdl_window_id : 1 -&gt; <span class="library" title="binding of C uint32_t type">uint32</span>; 
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>      get_surface: 1 -&gt; surface_t;
<span class="lineno" id=line9></span>      add: drawable_t -&gt; 0;
<span class="lineno" id=line10></span>      remove: <span class="library" title="binding of C++ string type">string</span> -&gt; 0;
<span class="lineno" id=line11></span>      get_drawchain: 1 -&gt; drawchain_t;
<span class="lineno" id=line12></span>      draw: 1 -&gt; 0;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>      show: 1 -&gt; 0;
<span class="lineno" id=line15></span>      hide: 1 -&gt; 0;
<span class="lineno" id=line16></span>      raise: 1 -&gt; 0;
<span class="lineno" id=line17></span>      prim_update: 1 -&gt; 0;
<span class="lineno" id=line18></span>      update: 1 -&gt; 0; <span class="comment">// does a draw then prim_update</span>
<span class="lineno" id=line19></span>      destroy: 1 -&gt; 0;
<span class="lineno" id=line20></span>    }
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>    <span class="big_keyword" title="define an object factory">object</span> window (title:<span class="library" title="binding of C++ string type">string</span>, xpos:<span class="library" title="binding of C int type">int</span>, ypos:<span class="library" title="binding of C int type">int</span>, width:<span class="library" title="binding of C int type">int</span>,height:<span class="library" title="binding of C int type">int</span>, flag:<span class="library" title="binding of C uint32_t type">uint32</span>) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> window_t =
<span class="lineno" id=line23></span>    {
<span class="lineno" id=line24></span>      <span class="big_keyword" title="Define a mutable variable">var</span> w = SDL_CreateWindow(
<span class="lineno" id=line25></span>        title,
<span class="lineno" id=line26></span>        xpos,ypos,
<span class="lineno" id=line27></span>        width, height,
<span class="lineno" id=line28></span>        flag
<span class="lineno" id=line29></span>      );
<span class="lineno" id=line30></span>      <span class="big_keyword" title="Define a mutable variable">var</span> dc = drawchain ();
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_drawchain () =&gt; dc;
<span class="lineno" id=line33></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> add (d:drawable_t) =&gt; dc.add d;
<span class="lineno" id=line34></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> remove (tag:<span class="library" title="binding of C++ string type">string</span>) =&gt; dc.remove tag;
<span class="lineno" id=line35></span>  
<span class="lineno" id=line36></span>  
<span class="lineno" id=line37></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_sdl_window_id () =&gt; SDL_GetWindowID w;
<span class="lineno" id=line38></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_sdl_window () =&gt; w;
<span class="lineno" id=line39></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_sdl_surface() =&gt; SDL_GetWindowSurface w;
<span class="lineno" id=line40></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_surface () : surface_t =&gt; surface (SDL_GetWindowSurface w);
<span class="lineno" id=line41></span>  
<span class="lineno" id=line42></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> show () { SDL_ShowWindow w; }
<span class="lineno" id=line43></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> hide () { SDL_HideWindow w; }
<span class="lineno" id=line44></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> raise () { SDL_RaiseWindow w; }
<span class="lineno" id=line45></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> destroy () { SDL_DestroyWindow w; }
<span class="lineno" id=line46></span>  
<span class="lineno" id=line47></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> prim_update()
<span class="lineno" id=line48></span>      {
<span class="lineno" id=line49></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = SDL_UpdateWindowSurface w;
<span class="lineno" id=line50></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line51></span>          eprintln$ <span class="fstring">"Unable to update window"</span>;
<span class="lineno" id=line52></span>          System::exit 1;
<span class="lineno" id=line53></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line54></span>      }
<span class="lineno" id=line55></span>  
<span class="lineno" id=line56></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> draw () 
<span class="lineno" id=line57></span>      {
<span class="lineno" id=line58></span>        <span class="big_keyword" title="Define a mutable variable">var</span> surf =  surface (SDL_GetWindowSurface w);
<span class="lineno" id=line59></span>        dc.draw surf;
<span class="lineno" id=line60></span>      }
<span class="lineno" id=line61></span>  
<span class="lineno" id=line62></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> update () { draw(); prim_update(); }
<span class="lineno" id=line63></span>   
<span class="lineno" id=line64></span>    }
<span class="lineno" id=line65></span>  
<span class="lineno" id=line66></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> create_fixed_window (title:<span class="library" title="binding of C++ string type">string</span>, x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, width:<span class="library" title="binding of C int type">int</span>, height:<span class="library" title="binding of C int type">int</span>) : window_t =&gt;
<span class="lineno" id=line67></span>      window (title, x,y,width,height, SDL_WINDOW_SHOWN \| SDL_WINDOW_ALLOW_HIGHDPI)
<span class="lineno" id=line68></span>    ;
<span class="lineno" id=line69></span>  
<span class="lineno" id=line70></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> create_resizable_window (title:<span class="library" title="binding of C++ string type">string</span>, x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, width:<span class="library" title="binding of C int type">int</span>, height:<span class="library" title="binding of C int type">int</span>) : window_t =&gt;
<span class="lineno" id=line71></span>      window (title, x,y,width,height, SDL_WINDOW_RESIZABLE \| SDL_WINDOW_ALLOW_HIGHDPI)
<span class="lineno" id=line72></span>    ;
<span class="lineno" id=line73></span>  
<span class="lineno" id=line74></span>  
<span class="lineno" id=line75></span>  }
<span class="lineno" id=line76></span>  
</pre></p><h2 id='The_Window_Controller._h'><img src='/share/src/web/images/minus.gif' id='The Window Controller.' onclick='toggle(this,"The_Window_Controller._d")' alt='+'/> 4.1 The Window Controller.</h2><div id='The_Window_Controller._d' style='display:block'>
<p>In Felix, the window controller is an object which
dispatches events read from an input schannel.
</p><p>The user provides a procedure which can handle the events
by reading on an schannel of events. The window controller
creates an schannel of events and starts the user procedure
as an fthread, passing it the input end of the schannel.
</p><p>After creation, the window controller object provides
a method so the client can fetch the output end of this
schannel on which the client writes events. These will
then be serviced by the procedure the client provided
since the window controller has started it running.
</p><p>The controller is basically a Felix kind of RAII:
on construction an active process is started which can
service events.
</p><pre class='inclusion'>
share/lib/gui/window_controller_interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiWindowControllerInterface
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line4></span>    <span class="comment">// Window controller is responsible for all the work</span>
<span class="lineno" id=line5></span>    <span class="comment">// being done on a window. It requires support for</span>
<span class="lineno" id=line6></span>    <span class="comment">// dispatching events on its event channel.</span>
<span class="lineno" id=line7></span>    <span class="big_keyword" title="define an object interface">interface</span> window_controller_interface {
<span class="lineno" id=line8></span>      get_window_id : 1 -&gt; <span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line9></span>      get_oschannel : 1 -&gt; oschannel[event_t];
<span class="lineno" id=line10></span>      destroy_window : 1 -&gt; 0;
<span class="lineno" id=line11></span>      display: 1 -&gt; 0;
<span class="lineno" id=line12></span>    }
<span class="lineno" id=line13></span>  }
</pre></p><pre class='inclusion'>
share/lib/gui/window_controller.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiWindowController
<span class="lineno" id=line3></span>  {
<span class="lineno" id=line4></span>    <span class="big_keyword" title="define an object factory">object</span> window_controller 
<span class="lineno" id=line5></span>    (
<span class="lineno" id=line6></span>      w:window_t, 
<span class="lineno" id=line7></span>      p:(input:ischannel[event_t]) -&gt; 1-&gt;0 <span class="comment">// chip interface</span>
<span class="lineno" id=line8></span>    ) 
<span class="lineno" id=line9></span>      <span class="small_keyword" title="specify what interfaces an object implements">implements</span> window_controller_interface = 
<span class="lineno" id=line10></span>    {
<span class="lineno" id=line11></span>      <span class="big_keyword" title="Define a mutable variable">var</span> imsgs,omsgs = #mk_ioschannel_pair[event_t]; 
<span class="lineno" id=line12></span>      
<span class="lineno" id=line13></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_window_id () =&gt; w.get_sdl_window_id ();
<span class="lineno" id=line14></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> destroy_window () =&gt; w.destroy ();
<span class="lineno" id=line15></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_oschannel () =&gt; omsgs;
<span class="lineno" id=line16></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> display() { w.update(); }
<span class="lineno" id=line17></span>      <span class="small_keyword" title="defines the topology of chip connections">circuit</span>
<span class="lineno" id=line18></span>        wire imsgs <span class="small_keyword" title="substring range separator">to</span> p.input
<span class="lineno" id=line19></span>      <span class="small_keyword" title="defines the topology of chip connections">endcircuit</span>
<span class="lineno" id=line20></span>      <span class="comment">//spawn_fthread (p imsgs);</span>
<span class="lineno" id=line21></span>    }
<span class="lineno" id=line22></span>  }
</pre></p></div><h2 id='The_Window_Manager._h'><img src='/share/src/web/images/minus.gif' id='The Window Manager.' onclick='toggle(this,"The_Window_Manager._d")' alt='+'/> 4.2 The Window Manager.</h2><div id='The_Window_Manager._d' style='display:block'>
<p>The Window manager is a top level object that is used to
fetch process level events such as mouse clicks and dispatch
them to the appropriate window event handler.
</p><p>Note that the Window manager MUST run in the main thread!
This is because some system GUI's maintain separate event
queues for each thread (Windows) or may provide a unified
queue (X-Windows). 
</p><p>Windows managed by the window manager have two identifying
tags: the window ID, maintained by SDL, and the window index,
which is the slot number in an array the Felix Window manager
uses to store the window controller associated with the window.
</p><p>The window manager creates the SDL event queue and reads
events from the queue. It dispatches them to the appropriate
windows based on the SDL window ID if the even has one,
or all windows if there isn't one.
</p><p>The dispatch, of course, is done by writing the event down the
schannel of the window controller associated with the window.
</p><p>Note carefully that the window manager is the equivalent of
a traditional event dispatch loop, and underneath, Felix indeed
implements fthreads with schannel I/O using callbacks. However
this is transparent to the client programmer! For all intents
and purpose the dispatching is done by a background thread
to windows each of which is running an active process that
listens for events.
</p><pre class='inclusion'>
share/lib/gui/window_manager.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiWindowManager
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>  <span class="comment">// Window Manager is responsible for a set of windows,</span>
<span class="lineno" id=line4></span>  <span class="comment">// and dispatching events specific to a particular</span>
<span class="lineno" id=line5></span>  <span class="comment">// window to that window.</span>
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="comment">// ------------------------------------------------------------------</span>
<span class="lineno" id=line8></span>  <span class="big_keyword" title="define an object factory">object</span> window_manager () = 
<span class="lineno" id=line9></span>  {
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Define a mutable variable">var</span> windows = <span class="library" title="array with unbounded dynamically variable limit">darray</span>[window_controller_interface]();
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_n_windows () =&gt; windows.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>    <span class="comment">// add a new window to the controlled set</span>
<span class="lineno" id=line15></span>    <span class="comment">// return its current index</span>
<span class="lineno" id=line16></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> add_window (w:window_controller_interface) : <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line17></span>    { 
<span class="lineno" id=line18></span>      windows += w; 
<span class="lineno" id=line19></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"add_window: index = "</span> + (windows.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> - 1  ).<span class="library" title="Convert a value to a string">str</span> + <span class="fstring">" SDL windows id = "</span> + #(w.get_window_id).<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line20></span>      <span class="small_keyword" title="return">return</span> windows.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> - 1; 
<span class="lineno" id=line21></span>    }
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> find_window(wid: <span class="library" title="binding of C uint32_t type">uint32</span>) : <span class="library" title="option type: Some x or None">opt</span>[window_controller_interface] =
<span class="lineno" id=line24></span>    {
<span class="lineno" id=line25></span>      <span class="small_keyword" title="for loop">for</span> wobj <span class="small_keyword" title="membership operator, function mem">in</span> windows <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line26></span>        <span class="small_keyword" title="conditional">if</span> wid == #(wobj.get_window_id) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line27></span>          <span class="small_keyword" title="return">return</span> Some wobj;
<span class="lineno" id=line28></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line29></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line30></span>      <span class="small_keyword" title="return">return</span> None[window_controller_interface];
<span class="lineno" id=line31></span>    }
<span class="lineno" id=line32></span>  
<span class="lineno" id=line33></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> find_window_index (wid: <span class="library" title="binding of C uint32_t type">uint32</span>) : <span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C int type">int</span>] =
<span class="lineno" id=line34></span>    {
<span class="lineno" id=line35></span>      <span class="small_keyword" title="for loop">for</span> <span class="big_keyword" title="Define a mutable variable">var</span> i <span class="small_keyword" title="membership operator, function mem">in</span> 0 <span class="small_keyword" title="upwards counting for loop">upto</span> windows.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> - 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line36></span>        <span class="small_keyword" title="conditional">if</span> wid == #(windows.i.get_window_id) <span class="small_keyword" title="return">return</span> Some i;
<span class="lineno" id=line37></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line38></span>      <span class="small_keyword" title="return">return</span> None[<span class="library" title="binding of C int type">int</span>];
<span class="lineno" id=line39></span>    }
<span class="lineno" id=line40></span>  
<span class="lineno" id=line41></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_window_controller_from_index (i:<span class="library" title="binding of C int type">int</span>) =&gt; windows.i;
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> delete_window (wid: <span class="library" title="binding of C uint32_t type">uint32</span>)
<span class="lineno" id=line44></span>    {
<span class="lineno" id=line45></span>      <span class="small_keyword" title="match statement or expression">match</span> find_window_index wid <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line46></span>      | #None =&gt; ;
<span class="lineno" id=line47></span>      | Some i =&gt; 
<span class="lineno" id=line48></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"delete window found index "</span> + i.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line49></span>        windows.i.destroy_window (); 
<span class="lineno" id=line50></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"SDL destroyed"</span>;
<span class="lineno" id=line51></span>        erase (windows, i);
<span class="lineno" id=line52></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Window erased"</span>;
<span class="lineno" id=line53></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line54></span>    }
<span class="lineno" id=line55></span>  
<span class="lineno" id=line56></span>    <span class="big_keyword" title="defines a coroutine using chip idiom">chip</span> window_event_dispatcher 
<span class="lineno" id=line57></span>     <span class="small_keyword" title="the parameter of a chip">connector</span> events
<span class="lineno" id=line58></span>       <span class="small_keyword" title="a field of the chip parameter">pin</span> eventin : %&lt;event_t
<span class="lineno" id=line59></span>       <span class="small_keyword" title="a field of the chip parameter">pin</span> quit: %&gt;<span class="library" title="binding of C int type">int</span>
<span class="lineno" id=line60></span>    {
<span class="lineno" id=line61></span>      forever:<span class="small_keyword" title="while loop">while</span> <span class="library" title="truth value">true</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line62></span>        <span class="big_keyword" title="Define a mutable variable">var</span> e = read events.eventin;
<span class="lineno" id=line63></span>        <span class="small_keyword" title="conditional">if</span> e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span>.SDL_EventType == SDL_QUIT break forever
<span class="lineno" id=line64></span>        dispatch_window_event e;
<span class="lineno" id=line65></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line66></span>      <span class="library" title="Print a string to a stream">write</span>$ events.quit,1;
<span class="lineno" id=line67></span>    }
<span class="lineno" id=line68></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_window_event_dispatcher () =&gt; window_event_dispatcher;
<span class="lineno" id=line69></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> dispatch_window_event (e:event_t) 
<span class="lineno" id=line70></span>    {
<span class="lineno" id=line71></span>      <span class="small_keyword" title="match statement or expression">match</span> SDL_GetWindowID e <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line72></span>      | Some wid =&gt;
<span class="lineno" id=line73></span>        <span class="small_keyword" title="match statement or expression">match</span> find_window wid <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line74></span>        | Some wobj =&gt;
<span class="lineno" id=line75></span>          <span class="big_keyword" title="Define a mutable variable">var</span> omsgs = #(wobj.get_oschannel);
<span class="lineno" id=line76></span>          <span class="library" title="Print a string to a stream">write</span> (omsgs, e);
<span class="lineno" id=line77></span>          <span class="small_keyword" title="conditional">if</span> e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span>.SDL_EventType == SDL_WINDOWEVENT <span class="small_keyword" title="logical conjunction">and</span> 
<span class="lineno" id=line78></span>            e.window.event.SDL_WindowEventID == SDL_WINDOWEVENT_CLOSE 
<span class="lineno" id=line79></span>          <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line80></span>            #(wobj.get_window_id).delete_window;
<span class="lineno" id=line81></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"dispatch: window deleted!"</span>;
<span class="lineno" id=line82></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line83></span>            wobj.display();
<span class="lineno" id=line84></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line85></span>        | #None =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Can't find window ID = "</span> + <span class="library" title="Convert a value to a string">str</span> wid;
<span class="lineno" id=line86></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line87></span>      | #None =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"No window for message: Event type "</span> + e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span>.SDL_EventType.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line88></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line89></span>    }
<span class="lineno" id=line90></span>  
<span class="lineno" id=line91></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> delete_all() 
<span class="lineno" id=line92></span>    {
<span class="lineno" id=line93></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Delete all"</span>;
<span class="lineno" id=line94></span>      <span class="big_keyword" title="Define a mutable variable">var</span> e : SDL_Event;
<span class="lineno" id=line95></span>      e&amp;.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span> &lt;- SDL_WINDOWEVENT.<span class="library" title="binding of C uint32_t type">uint32</span>;
<span class="lineno" id=line96></span>      e&amp;.window.event &lt;- SDL_WINDOWEVENT_CLOSE.<span class="library" title="binding of C uint8_t type">uint8</span>;
<span class="lineno" id=line97></span>      <span class="small_keyword" title="for loop">for</span> wobj <span class="small_keyword" title="membership operator, function mem">in</span> windows <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line98></span>        <span class="big_keyword" title="Define a mutable variable">var</span> omsgs = #(wobj.get_oschannel);
<span class="lineno" id=line99></span>        e&amp;.window.windowID &lt;- #(wobj.get_window_id);
<span class="lineno" id=line100></span>        <span class="library" title="Print a string to a stream">write</span> (omsgs, e);
<span class="lineno" id=line101></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line102></span>      <span class="comment">// note: not bothering to delete the darray :)</span>
<span class="lineno" id=line103></span>    }
<span class="lineno" id=line104></span>  
<span class="lineno" id=line105></span>    <span class="comment">// the quit channel is deliberately connected to a dummy channel</span>
<span class="lineno" id=line106></span>    <span class="comment">// (a dummy is used to suppress compiler non-connection warning)</span>
<span class="lineno" id=line107></span>    <span class="comment">// the WM will suicide when it gets a SDL_QUIT message</span>
<span class="lineno" id=line108></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> start ()
<span class="lineno" id=line109></span>    {
<span class="lineno" id=line110></span>      <span class="big_keyword" title="Define a mutable variable">var</span> qin,qout = mk_ioschannel_pair[<span class="library" title="binding of C int type">int</span>]();
<span class="lineno" id=line111></span>      <span class="small_keyword" title="defines the topology of chip connections">circuit</span>
<span class="lineno" id=line112></span>        <span class="small_keyword" title="connects two pins with a channel">connect</span> window_event_dispatcher.eventin, event_source.src
<span class="lineno" id=line113></span>        wire qout <span class="small_keyword" title="substring range separator">to</span> window_event_dispatcher.quit
<span class="lineno" id=line114></span>      <span class="small_keyword" title="defines the topology of chip connections">endcircuit</span> 
<span class="lineno" id=line115></span>    }
<span class="lineno" id=line116></span>  
<span class="lineno" id=line117></span>    <span class="comment">// start WM, wait until SDL_QUIT seen</span>
<span class="lineno" id=line118></span>    <span class="comment">// closes windows before returning</span>
<span class="lineno" id=line119></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> run_until_quit ()
<span class="lineno" id=line120></span>    {
<span class="lineno" id=line121></span>      <span class="big_keyword" title="Define a mutable variable">var</span> qin,qout = mk_ioschannel_pair[<span class="library" title="binding of C int type">int</span>]();
<span class="lineno" id=line122></span>  
<span class="lineno" id=line123></span>      <span class="small_keyword" title="defines the topology of chip connections">circuit</span>
<span class="lineno" id=line124></span>        <span class="small_keyword" title="connects two pins with a channel">connect</span> window_event_dispatcher.eventin, event_source.src
<span class="lineno" id=line125></span>        wire qout <span class="small_keyword" title="substring range separator">to</span> window_event_dispatcher.quit
<span class="lineno" id=line126></span>      <span class="small_keyword" title="defines the topology of chip connections">endcircuit</span> 
<span class="lineno" id=line127></span>  
<span class="lineno" id=line128></span>      <span class="hack">C_hack</span>::ignore(read qin);
<span class="lineno" id=line129></span>  
<span class="lineno" id=line130></span>      <span class="comment">// we must have got a quit ..</span>
<span class="lineno" id=line131></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"QUIT EVENT, deleting all windows"</span>;
<span class="lineno" id=line132></span>      delete_all();
<span class="lineno" id=line133></span>    }
<span class="lineno" id=line134></span>  
<span class="lineno" id=line135></span>    <span class="comment">// start WM, wait until SDL_QUIT issued by either</span>
<span class="lineno" id=line136></span>    <span class="comment">// the user or the timer</span>
<span class="lineno" id=line137></span>    <span class="comment">// closes windows before returning</span>
<span class="lineno" id=line138></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> run_with_timeout (<span class="big_keyword" title="Define a mutable variable">var</span> timeout: <span class="library" title="binding of C double float type">double</span>)
<span class="lineno" id=line139></span>    {
<span class="lineno" id=line140></span>      <span class="big_keyword" title="Define a mutable variable">var</span> qin,qout = mk_ioschannel_pair[<span class="library" title="binding of C int type">int</span>]();
<span class="lineno" id=line141></span>  
<span class="lineno" id=line142></span>      <span class="small_keyword" title="defines the topology of chip connections">circuit</span>
<span class="lineno" id=line143></span>        <span class="small_keyword" title="connects two pins with a channel">connect</span> window_event_dispatcher.eventin, event_source.src
<span class="lineno" id=line144></span>        wire qout <span class="small_keyword" title="substring range separator">to</span> window_event_dispatcher.quit
<span class="lineno" id=line145></span>      <span class="small_keyword" title="defines the topology of chip connections">endcircuit</span> 
<span class="lineno" id=line146></span>  
<span class="lineno" id=line147></span>      <span class="big_keyword" title="Define a mutable variable">var</span> quit = <span class="library" title="false value">false</span>;
<span class="lineno" id=line148></span>      <span class="big_keyword" title="Spawn a cooperative fibre">spawn_fthread</span>$ demo_timer &amp;quit timeout;
<span class="lineno" id=line149></span>      <span class="hack">C_hack</span>::ignore(read qin);
<span class="lineno" id=line150></span>      quit = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line151></span>  
<span class="lineno" id=line152></span>      <span class="comment">// we must have got a quit ..</span>
<span class="lineno" id=line153></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"QUIT EVENT, deleting all windows"</span>;
<span class="lineno" id=line154></span>      delete_all();
<span class="lineno" id=line155></span>    }
<span class="lineno" id=line156></span>  }
<span class="lineno" id=line157></span>  
<span class="lineno" id=line158></span>  <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> create_SDL_event_source () : ischannel[event_t]  =
<span class="lineno" id=line159></span>  {
<span class="lineno" id=line160></span>    <span class="big_keyword" title="Define a mutable variable">var</span> imsgs, omsgs = mk_ioschannel_pair[event_t]();
<span class="lineno" id=line161></span>    <span class="small_keyword" title="defines the topology of chip connections">circuit</span>
<span class="lineno" id=line162></span>      wire omsgs <span class="small_keyword" title="substring range separator">to</span> event_source.src
<span class="lineno" id=line163></span>    <span class="small_keyword" title="defines the topology of chip connections">endcircuit</span>
<span class="lineno" id=line164></span>    <span class="small_keyword" title="return">return</span> imsgs;
<span class="lineno" id=line165></span>  }
<span class="lineno" id=line166></span>  }
<span class="lineno" id=line167></span>  
</pre></p></div></div><h1 id='Widgets_h'><img src='/share/src/web/images/minus.gif' id='Widgets' onclick='toggle(this,"Widgets_d")' alt='+'/> 5 Widgets</h1><div id='Widgets_d' style='display:block'>
<h2 id='Simple_Click_Button_h'><img src='/share/src/web/images/minus.gif' id='Simple Click Button' onclick='toggle(this,"Simple_Click_Button_d")' alt='+'/> 5.1 Simple Click Button</h2><div id='Simple_Click_Button_d' style='display:block'>
<pre class='inclusion'>
share/lib/gui/button.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiButton
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    variant button_state_t =  
<span class="lineno" id=line4></span>      | Up       <span class="comment">// ready</span>
<span class="lineno" id=line5></span>      | Down     <span class="comment">// being clicked</span>
<span class="lineno" id=line6></span>      | Disabled <span class="comment">// inactive</span>
<span class="lineno" id=line7></span>      | Mouseover <span class="comment">// ready and mouse is over</span>
<span class="lineno" id=line8></span>    ;
<span class="lineno" id=line9></span>  
<span class="lineno" id=line10></span>    variant button_action_t =
<span class="lineno" id=line11></span>      | NoAction
<span class="lineno" id=line12></span>      | ClickAction of <span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line13></span>    ;
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>    <span class="big_keyword" title="define an object interface">interface</span> button_model_t 
<span class="lineno" id=line16></span>    {
<span class="lineno" id=line17></span>      get_state: 1 -&gt; button_state_t;
<span class="lineno" id=line18></span>      set_state: button_state_t -&gt; 0;
<span class="lineno" id=line19></span>      get_tag: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line20></span>    }
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>    <span class="big_keyword" title="define an object factory">object</span> ButtonModel 
<span class="lineno" id=line23></span>      (<span class="big_keyword" title="Define a mutable variable">var</span> tag: <span class="library" title="binding of C++ string type">string</span>, init_state:button_state_t) 
<span class="lineno" id=line24></span>      <span class="small_keyword" title="specify what interfaces an object implements">implements</span> button_model_t 
<span class="lineno" id=line25></span>    =
<span class="lineno" id=line26></span>    {
<span class="lineno" id=line27></span>      <span class="big_keyword" title="Define a mutable variable">var</span> state = init_state;
<span class="lineno" id=line28></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_state() =&gt; state;
<span class="lineno" id=line29></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set_state (s:button_state_t) =&gt; state = s;
<span class="lineno" id=line30></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_tag () =&gt; tag;
<span class="lineno" id=line31></span>    }
<span class="lineno" id=line32></span>  
<span class="lineno" id=line33></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> button_colour_scheme_t = 
<span class="lineno" id=line34></span>    (
<span class="lineno" id=line35></span>      label_colour: colour_t,
<span class="lineno" id=line36></span>      bg_colour: colour_t,
<span class="lineno" id=line37></span>      top_colour: colour_t,
<span class="lineno" id=line38></span>      left_colour: colour_t,
<span class="lineno" id=line39></span>      bottom_colour: colour_t,
<span class="lineno" id=line40></span>      right_colour: colour_t
<span class="lineno" id=line41></span>    );
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> button_skin_t =
<span class="lineno" id=line44></span>    (
<span class="lineno" id=line45></span>      up: button_colour_scheme_t,
<span class="lineno" id=line46></span>      down: button_colour_scheme_t,
<span class="lineno" id=line47></span>      disabled: button_colour_scheme_t,
<span class="lineno" id=line48></span>      mouseover: button_colour_scheme_t
<span class="lineno" id=line49></span>    );
<span class="lineno" id=line50></span>  
<span class="lineno" id=line51></span>    <span class="big_keyword" title="define an object interface">interface</span> button_display_t {
<span class="lineno" id=line52></span>      display: 1 -&gt; 0;
<span class="lineno" id=line53></span>      get_client_rect: 1 -&gt; rect_t;
<span class="lineno" id=line54></span>      get_label : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line55></span>      get_tag: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line56></span>    }
<span class="lineno" id=line57></span>  
<span class="lineno" id=line58></span>    <span class="big_keyword" title="define an object factory">object</span> ButtonDisplay (b:button_model_t) 
<span class="lineno" id=line59></span>    (
<span class="lineno" id=line60></span>      w:window_t, <span class="comment">// change to surface later</span>
<span class="lineno" id=line61></span>      font:font_t, 
<span class="lineno" id=line62></span>      label:<span class="library" title="binding of C++ string type">string</span>, 
<span class="lineno" id=line63></span>      tag: <span class="library" title="binding of C++ string type">string</span>, <span class="comment">// note: NOT the same as the button's tag!</span>
<span class="lineno" id=line64></span>      skin : button_skin_t,
<span class="lineno" id=line65></span>      coords: rect_t,
<span class="lineno" id=line66></span>      origin: point_t
<span class="lineno" id=line67></span>     ) 
<span class="lineno" id=line68></span>     <span class="small_keyword" title="specify what interfaces an object implements">implements</span> button_display_t =
<span class="lineno" id=line69></span>     {
<span class="lineno" id=line70></span>       <span class="comment">// NOTE: the tag must be unique per button-display on each window.</span>
<span class="lineno" id=line71></span>       <span class="comment">// it is used to *remove* the drawing instructions from the window</span>
<span class="lineno" id=line72></span>       <span class="comment">// for the previous button state prior to adding new instructions.</span>
<span class="lineno" id=line73></span>       <span class="comment">// Dont confuse with the label (which might change per display)</span>
<span class="lineno" id=line74></span>       <span class="comment">// or the button state tag (which is not enough if the same button state</span>
<span class="lineno" id=line75></span>       <span class="comment">// drives two displays on the same window).</span>
<span class="lineno" id=line76></span>       <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_tag () =&gt; tag;
<span class="lineno" id=line77></span>  
<span class="lineno" id=line78></span>       <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_client_rect () =&gt; coords;
<span class="lineno" id=line79></span>  
<span class="lineno" id=line80></span>       <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_label () =&gt; label;
<span class="lineno" id=line81></span>       <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> display()
<span class="lineno" id=line82></span>       {
<span class="lineno" id=line83></span>        <span class="big_keyword" title="Define a mutable variable">var</span> state = b.get_state ();
<span class="lineno" id=line84></span>        <span class="big_keyword" title="Define a mutable variable">var</span> scheme = <span class="small_keyword" title="match statement or expression">match</span> state <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line85></span>          | #Up =&gt; skin.up
<span class="lineno" id=line86></span>          | #Down =&gt; skin.down
<span class="lineno" id=line87></span>          | #Disabled =&gt; skin.disabled
<span class="lineno" id=line88></span>          | #Mouseover =&gt; skin.mouseover
<span class="lineno" id=line89></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line90></span>        ;
<span class="lineno" id=line91></span>        w.remove tag;
<span class="lineno" id=line92></span>        <span class="big_keyword" title="Define a mutable variable">var</span> left_x = coords.x;
<span class="lineno" id=line93></span>        <span class="big_keyword" title="Define a mutable variable">var</span> right_x = coords.x + coords.w - 1;
<span class="lineno" id=line94></span>        <span class="big_keyword" title="Define a mutable variable">var</span> top_y = coords.y;
<span class="lineno" id=line95></span>        <span class="big_keyword" title="Define a mutable variable">var</span> bottom_y = coords.y + coords.h - 1;
<span class="lineno" id=line96></span>        <span class="big_keyword" title="Define a mutable variable">var</span> origin_x = origin.x;
<span class="lineno" id=line97></span>        <span class="big_keyword" title="Define a mutable variable">var</span> origin_y = origin.y;
<span class="lineno" id=line98></span>  
<span class="lineno" id=line99></span>        <span class="comment">// top</span>
<span class="lineno" id=line100></span>        w.add$ mk_drawable tag draw_line (scheme.top_colour, left_x - 2,top_y - 2,right_x + 2, top_y - 2) ; 
<span class="lineno" id=line101></span>        w.add$ mk_drawable tag draw_line (scheme.top_colour, left_x - 1,top_y - 1,right_x + 1, top_y - 1); 
<span class="lineno" id=line102></span>        <span class="comment">// left</span>
<span class="lineno" id=line103></span>        w.add$ mk_drawable tag draw_line (scheme.left_colour, left_x - 2,top_y - 2,left_x - 2, bottom_y + 2); 
<span class="lineno" id=line104></span>        w.add$ mk_drawable tag draw_line (scheme.left_colour, left_x - 1,top_y - 1,left_x - 1, bottom_y + 1); 
<span class="lineno" id=line105></span>        <span class="comment">// right</span>
<span class="lineno" id=line106></span>        w.add$ mk_drawable tag draw_line (scheme.right_colour, right_x + 2,top_y - 2,right_x + 2, bottom_y + 2); 
<span class="lineno" id=line107></span>        w.add$ mk_drawable tag draw_line (scheme.right_colour, right_x + 1,top_y - 1,right_x + 1, bottom_y + 1); 
<span class="lineno" id=line108></span>        <span class="comment">// bottom</span>
<span class="lineno" id=line109></span>        w.add$ mk_drawable tag draw_line (scheme.bottom_colour, left_x - 1,bottom_y + 1,right_x + 1, bottom_y + 1); 
<span class="lineno" id=line110></span>        w.add$ mk_drawable tag draw_line (scheme.bottom_colour, left_x - 2,bottom_y + 2,right_x + 2, bottom_y + 2); 
<span class="lineno" id=line111></span>  
<span class="lineno" id=line112></span>        w.add$ mk_drawable tag fill(SDL_Rect (left_x, top_y, right_x - left_x + 1, bottom_y - top_y + 1), scheme.bg_colour);
<span class="lineno" id=line113></span>        w.add$ mk_drawable tag FlxGuiSurface::<span class="library" title="Print a string to a stream">write</span> (origin_x, origin_y, font, scheme.label_colour, label);
<span class="lineno" id=line114></span>      } <span class="comment">// draw</span>
<span class="lineno" id=line115></span>      display();
<span class="lineno" id=line116></span>    } <span class="comment">//button</span>
<span class="lineno" id=line117></span>  
<span class="lineno" id=line118></span>  <span class="big_keyword" title="defines a coroutine using chip idiom">chip</span> button_controller 
<span class="lineno" id=line119></span>  (
<span class="lineno" id=line120></span>    bm: button_model_t, 
<span class="lineno" id=line121></span>    bd: button_display_t 
<span class="lineno" id=line122></span>  )
<span class="lineno" id=line123></span>  <span class="small_keyword" title="the parameter of a chip">connector</span> but
<span class="lineno" id=line124></span>    <span class="small_keyword" title="a field of the chip parameter">pin</span> ec: %&lt;event_t
<span class="lineno" id=line125></span>    <span class="small_keyword" title="a field of the chip parameter">pin</span> response: %&gt;button_action_t 
<span class="lineno" id=line126></span>  {
<span class="lineno" id=line127></span>    bd.display();
<span class="lineno" id=line128></span>    <span class="big_keyword" title="Define a mutable variable">var</span> run = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line129></span>    <span class="big_keyword" title="Define a mutable variable">var</span> e = read but.ec;
<span class="lineno" id=line130></span>    <span class="small_keyword" title="while loop">while</span> run <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line131></span>      <span class="small_keyword" title="match statement or expression">match</span> e <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line132></span>      | MOUSEMOTION mm =&gt;
<span class="lineno" id=line133></span>        <span class="big_keyword" title="Define a mutable variable">var</span> x,y = mm.x,mm.y; <span class="comment">//int32</span>
<span class="lineno" id=line134></span>        <span class="small_keyword" title="conditional">if</span> SDL_Point (x.<span class="library" title="binding of C int type">int</span>,y.<span class="library" title="binding of C int type">int</span>) <span class="tex_symbol" title="\in">\(\in\)</span> bd.get_client_rect () <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line135></span>          <span class="comment">//println$ "Motion in client rect of button " + bd.get_label();</span>
<span class="lineno" id=line136></span>          <span class="small_keyword" title="match statement or expression">match</span> bm.get_state () <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line137></span>          | #Up =&gt; bm.set_state Mouseover; bd.display(); <span class="comment">// Enter</span>
<span class="lineno" id=line138></span>          | _ =&gt; ;
<span class="lineno" id=line139></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line140></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line141></span>          <span class="small_keyword" title="match statement or expression">match</span> bm.get_state () <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line142></span>          | #Mouseover =&gt; bm.set_state Up; bd.display(); <span class="comment">// Leave</span>
<span class="lineno" id=line143></span>          | #Down =&gt; bm.set_state Up; bd.display(); <span class="comment">// Leave</span>
<span class="lineno" id=line144></span>          | _ =&gt; ;
<span class="lineno" id=line145></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line146></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line147></span>        <span class="library" title="Print a string to a stream">write</span>$ but.response, NoAction;
<span class="lineno" id=line148></span>   
<span class="lineno" id=line149></span>      | MOUSEBUTTONDOWN mbd =&gt;
<span class="lineno" id=line150></span>        x,y = mbd.x,mbd.y; <span class="comment">//int32</span>
<span class="lineno" id=line151></span>        <span class="small_keyword" title="conditional">if</span> SDL_Point (x.<span class="library" title="binding of C int type">int</span>,y.<span class="library" title="binding of C int type">int</span>) <span class="tex_symbol" title="\in">\(\in\)</span> bd.get_client_rect () <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line152></span>          <span class="comment">//println$ "Button down in client rect of button " + bd.get_label();</span>
<span class="lineno" id=line153></span>          bm.set_state Down; bd.display();
<span class="lineno" id=line154></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line155></span>        <span class="library" title="Print a string to a stream">write</span>$ but.response, NoAction;
<span class="lineno" id=line156></span>   
<span class="lineno" id=line157></span>      | MOUSEBUTTONUP mbu =&gt; 
<span class="lineno" id=line158></span>        x,y = mbu.x,mbu.y; <span class="comment">//int32</span>
<span class="lineno" id=line159></span>        <span class="small_keyword" title="conditional">if</span> SDL_Point (x.<span class="library" title="binding of C int type">int</span>,y.<span class="library" title="binding of C int type">int</span>) <span class="tex_symbol" title="\in">\(\in\)</span> bd.get_client_rect () <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line160></span>          <span class="comment">//println$ "Button up in client rect of button " + bd.get_label();</span>
<span class="lineno" id=line161></span>          bm.set_state Mouseover; bd.display();
<span class="lineno" id=line162></span>          <span class="library" title="Print a string to a stream">write</span>$ but.response, ClickAction #(bm.get_tag);
<span class="lineno" id=line163></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line164></span>          bm.set_state Up; bd.display();
<span class="lineno" id=line165></span>          <span class="library" title="Print a string to a stream">write</span>$ but.response, NoAction;
<span class="lineno" id=line166></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line167></span>      | WINDOWEVENT we <span class="small_keyword" title="predicative type constraint or precondition">when</span> we.event == SDL_WINDOWEVENT_LEAVE.<span class="library" title="binding of C uint8_t type">uint8</span>  =&gt;
<span class="lineno" id=line168></span>        bm.set_state Up; bd.display();
<span class="lineno" id=line169></span>        <span class="library" title="Print a string to a stream">write</span>$ but.response, NoAction;
<span class="lineno" id=line170></span>  
<span class="lineno" id=line171></span>      | _ =&gt; 
<span class="lineno" id=line172></span>        <span class="library" title="Print a string to a stream">write</span>$ but.response, NoAction;
<span class="lineno" id=line173></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line174></span>      e = read but.ec;
<span class="lineno" id=line175></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line176></span>  
<span class="lineno" id=line177></span>  }
<span class="lineno" id=line178></span>  
<span class="lineno" id=line179></span>  } <span class="comment">// class</span>
</pre></p></div><h2 id='Cascading_Menu_h'><img src='/share/src/web/images/minus.gif' id='Cascading Menu' onclick='toggle(this,"Cascading_Menu_d")' alt='+'/> 5.2 Cascading Menu</h2><div id='Cascading_Menu_d' style='display:block'>
<pre class='inclusion'>
share/lib/gui/menu.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// interim menu stuff</span>
<span class="lineno" id=line2></span>  <span class="comment">// these menus are transient, retaining state only when open</span>
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/datatype/lsexpr"</span>;
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiMenu
<span class="lineno" id=line8></span>  {
<span class="lineno" id=line9></span>    <span class="comment">// A menu entry is either some text or a separator</span>
<span class="lineno" id=line10></span>    <span class="comment">// The text has a visual label and a separate tag </span>
<span class="lineno" id=line11></span>    <span class="comment">// returned when an entry is selected</span>
<span class="lineno" id=line12></span>    variant menu_entry_active_t = Active | Disabled;
<span class="lineno" id=line13></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> menu_text_entry_t = (tag:<span class="library" title="binding of C++ string type">string</span>, label:<span class="library" title="binding of C++ string type">string</span>, active:menu_entry_active_t);
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>    variant menu_entry_t = Separator | Text of menu_text_entry_t;
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>    <span class="comment">// A menu is a list of trees with both leaves and nodes labelled</span>
<span class="lineno" id=line18></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> menu_item_t = LS_expr::lsexpr[menu_entry_t, menu_entry_t];
<span class="lineno" id=line19></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> menu_data_t = <span class="library" title="functional, singly linked list">list</span>[menu_item_t];
<span class="lineno" id=line20></span>  
<span class="lineno" id=line21></span>    <span class="comment">// A position in the tree is a list of integers</span>
<span class="lineno" id=line22></span>    <span class="comment">// Separators do not count</span>
<span class="lineno" id=line23></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> menu_position_t = <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span>];
<span class="lineno" id=line24></span>  
<span class="lineno" id=line25></span>    <span class="comment">// A menu is either closed, or open at a particular position</span>
<span class="lineno" id=line26></span>    variant menu_state_t = Closed | Open of menu_position_t;
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>    variant menu_action_t = NoAction | ChangedPosition | SelectedAction of <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line29></span>  
<span class="lineno" id=line30></span>    <span class="big_keyword" title="define an object interface">interface</span> menu_model_t
<span class="lineno" id=line31></span>    {
<span class="lineno" id=line32></span>      get_menu: 1 -&gt; menu_data_t;
<span class="lineno" id=line33></span>      get_state: 1 -&gt; menu_state_t;
<span class="lineno" id=line34></span>      set_state: menu_state_t -&gt; 0;
<span class="lineno" id=line35></span>      get_current_tag: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>; <span class="comment">// empty string if closed</span>
<span class="lineno" id=line36></span>      get_current_tag_chain: 1 -&gt; <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]; <span class="comment">// from the top</span>
<span class="lineno" id=line37></span>    }
<span class="lineno" id=line38></span>  
<span class="lineno" id=line39></span>    <span class="big_keyword" title="define an object factory">object</span> MenuModel (m:menu_data_t) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> menu_model_t =
<span class="lineno" id=line40></span>    {
<span class="lineno" id=line41></span>      <span class="big_keyword" title="Define a mutable variable">var</span> state = Closed;
<span class="lineno" id=line42></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_menu () =&gt; m;
<span class="lineno" id=line43></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_state () =&gt; state;
<span class="lineno" id=line44></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set_state (s:menu_state_t) =&gt; state = s;
<span class="lineno" id=line45></span>  
<span class="lineno" id=line46></span>      <span class="comment">// find ix'th entry in a menu if it exists,</span>
<span class="lineno" id=line47></span>      <span class="comment">// separators not counted</span>
<span class="lineno" id=line48></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> find (m:menu_data_t, ix:<span class="library" title="binding of C int type">int</span>) : <span class="library" title="option type: Some x or None">opt</span>[menu_item_t] =&gt;
<span class="lineno" id=line49></span>        <span class="small_keyword" title="match statement or expression">match</span> m <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line50></span>        | #Empty =&gt; None[menu_item_t]
<span class="lineno" id=line51></span>        | Cons (h,t) =&gt; 
<span class="lineno" id=line52></span>          <span class="small_keyword" title="match statement or expression">match</span> h <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line53></span>          | Leaf (Separator) =&gt; find (t,ix)
<span class="lineno" id=line54></span>          | x =&gt; <span class="small_keyword" title="conditional">if</span> ix == 0 <span class="small_keyword" title="conditional">then</span> Some x <span class="small_keyword" title="conditional">else</span> find (t,ix - 1)
<span class="lineno" id=line55></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line56></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line57></span>      ;
<span class="lineno" id=line58></span>        
<span class="lineno" id=line59></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> find_tag (pos: menu_position_t, menu:menu_data_t) : <span class="library" title="binding of C++ string type">string</span> =&gt;
<span class="lineno" id=line60></span>        <span class="small_keyword" title="match statement or expression">match</span> pos,menu <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line61></span>        | #Empty, _ =&gt; <span class="fstring">"Empty"</span>
<span class="lineno" id=line62></span>        | Cons (i,t), m =&gt; 
<span class="lineno" id=line63></span>          <span class="small_keyword" title="match statement or expression">match</span> find (m,i),t <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line64></span>          | Some (Leaf (Text (tag=tag))), Empty =&gt; tag
<span class="lineno" id=line65></span>          | Some (Tree (Text (tag=tag), _)), Empty =&gt; tag
<span class="lineno" id=line66></span>          | Some (Tree (_, subtree)), _=&gt; find_tag (t,subtree)
<span class="lineno" id=line67></span>          | _ =&gt; <span class="fstring">"Error"</span>
<span class="lineno" id=line68></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line69></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line70></span>      ; 
<span class="lineno" id=line71></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_current_tag () =&gt; 
<span class="lineno" id=line72></span>       <span class="small_keyword" title="match statement or expression">match</span> state <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line73></span>       | #Closed =&gt; <span class="fstring">"Closed"</span>
<span class="lineno" id=line74></span>       | Open pos =&gt;
<span class="lineno" id=line75></span>          find_tag (pos,m)
<span class="lineno" id=line76></span>       <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line77></span>      ;
<span class="lineno" id=line78></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_current_tag_chain () =&gt; Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line79></span>    }
<span class="lineno" id=line80></span>  
<span class="lineno" id=line81></span>    <span class="big_keyword" title="define an object interface">interface</span> menu_display_t 
<span class="lineno" id=line82></span>    {
<span class="lineno" id=line83></span>      display: 1 -&gt; 0;
<span class="lineno" id=line84></span>      get_hotrects: 1 -&gt; <span class="library" title="functional, singly linked list">list</span>[rect_t * menu_position_t];
<span class="lineno" id=line85></span>      get_tag: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line86></span>    }
<span class="lineno" id=line87></span>  
<span class="lineno" id=line88></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> submenu_icon_t = (open_icon: surface_t, closed_icon: surface_t);
<span class="lineno" id=line89></span>  
<span class="lineno" id=line90></span>    <span class="big_keyword" title="define an object factory">object</span> MenuDisplay 
<span class="lineno" id=line91></span>    (
<span class="lineno" id=line92></span>      tag:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line93></span>      m:menu_model_t,
<span class="lineno" id=line94></span>      w:window_t,
<span class="lineno" id=line95></span>      x:<span class="library" title="binding of C int type">int</span>,y:<span class="library" title="binding of C int type">int</span>,
<span class="lineno" id=line96></span>      font:font_t,
<span class="lineno" id=line97></span>      text_colour: button_colour_scheme_t,
<span class="lineno" id=line98></span>      disabled_colour: button_colour_scheme_t,
<span class="lineno" id=line99></span>      selected_colour: button_colour_scheme_t,
<span class="lineno" id=line100></span>      submenu_icons: submenu_icon_t
<span class="lineno" id=line101></span>    ) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> menu_display_t =
<span class="lineno" id=line102></span>    {
<span class="lineno" id=line103></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_tag () =&gt; tag;
<span class="lineno" id=line104></span>  
<span class="lineno" id=line105></span>      <span class="big_keyword" title="Define a mutable variable">var</span> icon_width = max (submenu_icons.open_icon.get_width(), submenu_icons.closed_icon.get_width());
<span class="lineno" id=line106></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lineskip = get_lineskip font;
<span class="lineno" id=line107></span>      <span class="big_keyword" title="Define a mutable variable">var</span> baseline_offset = font.TTF_FontAscent; 
<span class="lineno" id=line108></span>      <span class="big_keyword" title="Define a mutable variable">var</span> border_width = 2;
<span class="lineno" id=line109></span>      <span class="big_keyword" title="Define a mutable variable">var</span> left_padding = 4;
<span class="lineno" id=line110></span>      <span class="big_keyword" title="Define a mutable variable">var</span> right_padding = 10 + icon_width;
<span class="lineno" id=line111></span>      <span class="big_keyword" title="Define a mutable variable">var</span> min_width = 20;
<span class="lineno" id=line112></span>      <span class="big_keyword" title="Define a mutable variable">var</span> separator_depth = 1;
<span class="lineno" id=line113></span>      <span class="big_keyword" title="Define a mutable variable">var</span> top_padding = 1;
<span class="lineno" id=line114></span>      <span class="big_keyword" title="Define a mutable variable">var</span> bottom_padding = 1;
<span class="lineno" id=line115></span>  
<span class="lineno" id=line116></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; (FlxGuiFont::get_textsize (font,s)).0;
<span class="lineno" id=line117></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width: menu_entry_t -&gt; <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line118></span>        | #Separator =&gt; left_padding + right_padding + min_width
<span class="lineno" id=line119></span>        | Text s =&gt; left_padding + right_padding + width s.label
<span class="lineno" id=line120></span>      ;
<span class="lineno" id=line121></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> depth : menu_entry_t -&gt; <span class="library" title="binding of C int type">int</span> = 
<span class="lineno" id=line122></span>        | #Separator =&gt; top_padding + bottom_padding + separator_depth
<span class="lineno" id=line123></span>        | Text s =&gt; top_padding + bottom_padding + lineskip
<span class="lineno" id=line124></span>      ;
<span class="lineno" id=line125></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width : menu_item_t -&gt; <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line126></span>        | Leaf menu_entry =&gt; width menu_entry
<span class="lineno" id=line127></span>        | Tree (menu_entries ,_) =&gt; width menu_entries
<span class="lineno" id=line128></span>      ;
<span class="lineno" id=line129></span>  
<span class="lineno" id=line130></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> depth : menu_item_t -&gt; <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line131></span>        | Leaf menu_entry =&gt; depth menu_entry
<span class="lineno" id=line132></span>        | Tree (menu_entry ,_) =&gt; depth menu_entry
<span class="lineno" id=line133></span>      ;
<span class="lineno" id=line134></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width (ls: menu_data_t) =&gt; <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> 
<span class="lineno" id=line135></span>        (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (w:<span class="library" title="binding of C int type">int</span>) (menu_item:menu_item_t) =&gt; max (w, width menu_item)) 
<span class="lineno" id=line136></span>        0 
<span class="lineno" id=line137></span>        ls
<span class="lineno" id=line138></span>      ;
<span class="lineno" id=line139></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> depth (ls: menu_data_t) =&gt; <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span>
<span class="lineno" id=line140></span>        (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (d:<span class="library" title="binding of C int type">int</span>) (menu_item:menu_item_t) =&gt; d + depth menu_item)
<span class="lineno" id=line141></span>        0
<span class="lineno" id=line142></span>        ls
<span class="lineno" id=line143></span>      ;
<span class="lineno" id=line144></span>      <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> display_menu(x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, menu:menu_data_t, position:menu_position_t) 
<span class="lineno" id=line145></span>      {
<span class="lineno" id=line146></span>        <span class="big_keyword" title="Define a mutable variable">var</span> left_x = x;
<span class="lineno" id=line147></span>        <span class="big_keyword" title="Define a mutable variable">var</span> top_y = y;
<span class="lineno" id=line148></span>        <span class="big_keyword" title="Define a mutable variable">var</span> right_x = left_x + width menu;
<span class="lineno" id=line149></span>        <span class="big_keyword" title="Define a mutable variable">var</span> bottom_y = top_y + depth menu;
<span class="lineno" id=line150></span>        <span class="big_keyword" title="Define a mutable variable">var</span> scheme = text_colour;
<span class="lineno" id=line151></span>  
<span class="lineno" id=line152></span>        <span class="comment">// top</span>
<span class="lineno" id=line153></span>        w.add$ mk_drawable tag draw_line (scheme.top_colour, left_x - 2,top_y - 2,right_x + 2, top_y - 2); 
<span class="lineno" id=line154></span>        w.add$ mk_drawable tag draw_line (scheme.top_colour, left_x - 1,top_y - 1,right_x + 1, top_y - 1); 
<span class="lineno" id=line155></span>        <span class="comment">// left</span>
<span class="lineno" id=line156></span>        w.add$ mk_drawable tag draw_line (scheme.left_colour, left_x - 2,top_y - 2,left_x - 2, bottom_y + 2); 
<span class="lineno" id=line157></span>        w.add$ mk_drawable tag draw_line (scheme.left_colour, left_x - 1,top_y - 1,left_x - 1, bottom_y + 1); 
<span class="lineno" id=line158></span>        <span class="comment">// right</span>
<span class="lineno" id=line159></span>        w.add$ mk_drawable tag draw_line (scheme.right_colour, right_x + 2,top_y - 2,right_x + 2, bottom_y + 2); 
<span class="lineno" id=line160></span>        w.add$ mk_drawable tag draw_line (scheme.right_colour, right_x + 1,top_y - 1,right_x + 1, bottom_y + 1); 
<span class="lineno" id=line161></span>        <span class="comment">// bottom</span>
<span class="lineno" id=line162></span>        w.add$ mk_drawable tag draw_line (scheme.bottom_colour, left_x - 1,bottom_y + 1,right_x + 1, bottom_y + 1); 
<span class="lineno" id=line163></span>        w.add$ mk_drawable tag draw_line (scheme.bottom_colour, left_x - 2,bottom_y + 2,right_x + 2, bottom_y + 2); 
<span class="lineno" id=line164></span>  
<span class="lineno" id=line165></span>        w.add$ mk_drawable tag fill(SDL_Rect (left_x, top_y, right_x - left_x + 1, bottom_y - top_y + 1), scheme.bg_colour);
<span class="lineno" id=line166></span>  
<span class="lineno" id=line167></span>        <span class="big_keyword" title="Define a mutable variable">var</span> selected = <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line168></span>          | #Empty =&gt; 0 <span class="comment">// ignore for the moment</span>
<span class="lineno" id=line169></span>          | Cons (h,_) =&gt; h
<span class="lineno" id=line170></span>        ;
<span class="lineno" id=line171></span>  
<span class="lineno" id=line172></span>        <span class="big_keyword" title="Define a mutable variable">var</span> counter = 0;
<span class="lineno" id=line173></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ypos = top_y + top_padding;
<span class="lineno" id=line174></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> show_entry (entry: menu_entry_t) (submenu:menu_data_t) =&gt; 
<span class="lineno" id=line175></span>          <span class="small_keyword" title="match statement or expression">match</span> entry <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line176></span>          | #Separator =&gt; 
<span class="lineno" id=line177></span>            <span class="big_keyword" title="Define a mutable variable">var</span> y = ypos;
<span class="lineno" id=line178></span>            w.add$ mk_drawable tag draw_line (RGB(0,0,0), left_x, y, right_x, y); 
<span class="lineno" id=line179></span>            ypos = ypos + separator_depth + bottom_padding + top_padding;
<span class="lineno" id=line180></span>  
<span class="lineno" id=line181></span>          | Text (label=s,active=active) =&gt;
<span class="lineno" id=line182></span>            y = ypos + baseline_offset;
<span class="lineno" id=line183></span>            <span class="big_keyword" title="Define a mutable variable">var</span> scheme, dosub = <span class="small_keyword" title="match statement or expression">match</span> active <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line184></span>              | #Active =&gt; <span class="small_keyword" title="conditional">if</span> counter == selected <span class="small_keyword" title="conditional">then</span> selected_colour, <span class="library" title="truth value">true</span> <span class="small_keyword" title="conditional">else</span> text_colour, <span class="library" title="false value">false</span>
<span class="lineno" id=line185></span>              | #Disabled =&gt; disabled_colour, <span class="library" title="false value">false</span>
<span class="lineno" id=line186></span>            ;
<span class="lineno" id=line187></span>            <span class="big_keyword" title="Define a mutable variable">var</span> client_area = rect_t (
<span class="lineno" id=line188></span>              left_x+border_width,
<span class="lineno" id=line189></span>              ypos+top_padding,
<span class="lineno" id=line190></span>              right_x - left_x - 2 * border_width, 
<span class="lineno" id=line191></span>              lineskip
<span class="lineno" id=line192></span>            );
<span class="lineno" id=line193></span>            w.add$ mk_drawable tag fill (client_area, scheme.bg_colour);
<span class="lineno" id=line194></span>            w.add$ mk_drawable tag FlxGui::<span class="library" title="Print a string to a stream">write</span> (left_x+left_padding, y,font,scheme.label_colour,s);
<span class="lineno" id=line195></span>  
<span class="lineno" id=line196></span>            <span class="small_keyword" title="match statement or expression">match</span> submenu <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line197></span>            | #Empty =&gt; ;
<span class="lineno" id=line198></span>            | _ =&gt;
<span class="lineno" id=line199></span>              <span class="big_keyword" title="Define a mutable variable">var</span> icon = <span class="small_keyword" title="conditional">if</span> selected == counter <span class="small_keyword" title="conditional">then</span> submenu_icons.open_icon <span class="small_keyword" title="conditional">else</span> submenu_icons.closed_icon; 
<span class="lineno" id=line200></span>              <span class="big_keyword" title="Define a mutable variable">var</span> dst = rect_t (right_x - icon_width - border_width - 1, ypos, 0,0);
<span class="lineno" id=line201></span>              w.add$ mk_drawable tag blit (dst.x, dst.y, icon.get_sdl_surface());
<span class="lineno" id=line202></span>              <span class="small_keyword" title="conditional">if</span> dosub <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line203></span>                <span class="big_keyword" title="Define a mutable variable">var</span> subpos = <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line204></span>                  | Cons (_,tail) =&gt; tail
<span class="lineno" id=line205></span>                  | _ =&gt; position <span class="comment">// empty</span>
<span class="lineno" id=line206></span>                ;
<span class="lineno" id=line207></span>                display_menu (right_x+border_width,ypos+border_width,submenu,subpos);
<span class="lineno" id=line208></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line209></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line210></span>            ypos = ypos + lineskip + bottom_padding+top_padding;
<span class="lineno" id=line211></span>            ++counter;
<span class="lineno" id=line212></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line213></span>        ;
<span class="lineno" id=line214></span>        <span class="small_keyword" title="for loop">for</span> item <span class="small_keyword" title="membership operator, function mem">in</span> menu <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line215></span>          <span class="small_keyword" title="match statement or expression">match</span> item <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line216></span>          | Leaf entry =&gt; show_entry entry Empty[LS_expr::lsexpr[menu_entry_t, menu_entry_t]];
<span class="lineno" id=line217></span>          | Tree (entry, submenu) =&gt; show_entry entry submenu;
<span class="lineno" id=line218></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line219></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line220></span>      }  
<span class="lineno" id=line221></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> display() {
<span class="lineno" id=line222></span>        <span class="big_keyword" title="Define an immutable value">val</span> position = <span class="small_keyword" title="match statement or expression">match</span> #(m.get_state) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line223></span>          | #Closed =&gt; <span class="library" title="functional, singly linked list">list</span> (0)
<span class="lineno" id=line224></span>          | Open p =&gt; p
<span class="lineno" id=line225></span>        ;
<span class="lineno" id=line226></span>        display_menu (x,y,#(m.get_menu), position);
<span class="lineno" id=line227></span>        <span class="comment">//w.update(); </span>
<span class="lineno" id=line228></span>      }
<span class="lineno" id=line229></span>  
<span class="lineno" id=line230></span>      <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> get_hotrecs(x:<span class="library" title="binding of C int type">int</span>, <span class="big_keyword" title="Define a mutable variable">var</span> y:<span class="library" title="binding of C int type">int</span>, menu:menu_data_t, position:menu_position_t) 
<span class="lineno" id=line231></span>        (revtrail: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span>]) 
<span class="lineno" id=line232></span>        (photrecs:&amp;<span class="library" title="functional, singly linked list">list</span>[rect_t * menu_position_t])=
<span class="lineno" id=line233></span>      {
<span class="lineno" id=line234></span>  <span class="comment">//println$ "get_hotrecs, revtrail=" + revtrail.str+", pos=" + position.str;</span>
<span class="lineno" id=line235></span>        <span class="big_keyword" title="Define a mutable variable">var</span> left_x = x;
<span class="lineno" id=line236></span>        <span class="big_keyword" title="Define a mutable variable">var</span> top_y = y;
<span class="lineno" id=line237></span>        <span class="big_keyword" title="Define a mutable variable">var</span> right_x = left_x + width menu;
<span class="lineno" id=line238></span>        <span class="big_keyword" title="Define a mutable variable">var</span> bottom_y = top_y + depth menu;
<span class="lineno" id=line239></span>  
<span class="lineno" id=line240></span>        <span class="big_keyword" title="Define a mutable variable">var</span> selected = <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line241></span>          | #Empty =&gt; 0 <span class="comment">// ignore for the moment</span>
<span class="lineno" id=line242></span>          | Cons (h,_) =&gt; h
<span class="lineno" id=line243></span>        ;
<span class="lineno" id=line244></span>  
<span class="lineno" id=line245></span>        <span class="big_keyword" title="Define a mutable variable">var</span> counter = 0;
<span class="lineno" id=line246></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ypos = top_y + top_padding;
<span class="lineno" id=line247></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> hotrecs (entry: menu_entry_t) (submenu:menu_data_t) 
<span class="lineno" id=line248></span>        {
<span class="lineno" id=line249></span>          <span class="small_keyword" title="match statement or expression">match</span> entry <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line250></span>          | #Separator =&gt; 
<span class="lineno" id=line251></span>            ypos = ypos + separator_depth + bottom_padding + top_padding;
<span class="lineno" id=line252></span>  <span class="comment">//println$ "SEPARATOR : Counter="+counter.str;</span>
<span class="lineno" id=line253></span>  
<span class="lineno" id=line254></span>          | Text (label=s,active=active) =&gt;
<span class="lineno" id=line255></span>            y = ypos + baseline_offset;
<span class="lineno" id=line256></span>            <span class="big_keyword" title="Define a mutable variable">var</span> dosub = <span class="small_keyword" title="match statement or expression">match</span> active <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line257></span>              | #Active =&gt; counter == selected
<span class="lineno" id=line258></span>              | #Disabled =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line259></span>            ;
<span class="lineno" id=line260></span>            <span class="big_keyword" title="Define a mutable variable">var</span> client_area = rect_t (
<span class="lineno" id=line261></span>              left_x+border_width,
<span class="lineno" id=line262></span>              ypos+top_padding,
<span class="lineno" id=line263></span>              right_x - left_x - 2 * border_width, 
<span class="lineno" id=line264></span>              lineskip
<span class="lineno" id=line265></span>            );
<span class="lineno" id=line266></span>  <span class="comment">//println$ "TEXT: Counter="+counter.str+", Rect=" + client_area.str;</span>
<span class="lineno" id=line267></span>            <span class="small_keyword" title="match statement or expression">match</span> active <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line268></span>            | #Active =&gt; photrecs &lt;- (client_area, <span class="library" title="return data structure with elements reversed">rev</span> (counter + revtrail)) + *photrecs;
<span class="lineno" id=line269></span>            | #Disabled =&gt; ;
<span class="lineno" id=line270></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line271></span>            <span class="small_keyword" title="match statement or expression">match</span> submenu <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line272></span>            | #Empty =&gt; ;
<span class="lineno" id=line273></span>            | _ =&gt;
<span class="lineno" id=line274></span>              <span class="small_keyword" title="conditional">if</span> dosub <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line275></span>                <span class="big_keyword" title="Define a mutable variable">var</span> subpos = <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line276></span>                  | Cons (_,tail) =&gt; tail
<span class="lineno" id=line277></span>                  | _ =&gt; position <span class="comment">// empty</span>
<span class="lineno" id=line278></span>                ;
<span class="lineno" id=line279></span>                get_hotrecs (right_x+border_width,ypos+border_width,submenu,subpos) (counter+revtrail) photrecs;
<span class="lineno" id=line280></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line281></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line282></span>            ypos = ypos + lineskip + bottom_padding+top_padding;
<span class="lineno" id=line283></span>            ++counter;
<span class="lineno" id=line284></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line285></span>        }
<span class="lineno" id=line286></span>        <span class="small_keyword" title="for loop">for</span> item <span class="small_keyword" title="membership operator, function mem">in</span> menu <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line287></span>          <span class="small_keyword" title="match statement or expression">match</span> item <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line288></span>          | Leaf entry =&gt; hotrecs entry Empty[LS_expr::lsexpr[menu_entry_t, menu_entry_t]];
<span class="lineno" id=line289></span>          | Tree (entry, submenu) =&gt; hotrecs entry submenu;
<span class="lineno" id=line290></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line291></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line292></span>      }  
<span class="lineno" id=line293></span>  
<span class="lineno" id=line294></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_hotrects() : <span class="library" title="functional, singly linked list">list</span>[rect_t * menu_position_t] =
<span class="lineno" id=line295></span>      {
<span class="lineno" id=line296></span>        <span class="big_keyword" title="Define an immutable value">val</span> position = <span class="small_keyword" title="match statement or expression">match</span> #(m.get_state) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line297></span>          | #Closed =&gt; <span class="library" title="functional, singly linked list">list</span> (0)
<span class="lineno" id=line298></span>          | Open p =&gt; p
<span class="lineno" id=line299></span>        ;
<span class="lineno" id=line300></span>        <span class="big_keyword" title="Define a mutable variable">var</span> hotrecs = Empty[rect_t * menu_position_t];
<span class="lineno" id=line301></span>        get_hotrecs (x,y,#(m.get_menu),position) Empty[<span class="library" title="binding of C int type">int</span>] &amp;hotrecs;
<span class="lineno" id=line302></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="return data structure with elements reversed">rev</span> hotrecs;
<span class="lineno" id=line303></span>      }
<span class="lineno" id=line304></span>  
<span class="lineno" id=line305></span>    }
<span class="lineno" id=line306></span>  
<span class="lineno" id=line307></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> hotpos (point:SDL_Point, hot:<span class="library" title="functional, singly linked list">list</span>[rect_t * menu_position_t]) : <span class="library" title="option type: Some x or None">opt</span>[menu_position_t] =&gt;
<span class="lineno" id=line308></span>      <span class="small_keyword" title="match statement or expression">match</span> hot <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line309></span>      | #Empty =&gt; None[menu_position_t]
<span class="lineno" id=line310></span>      | Cons ((r,pos),tail) =&gt;
<span class="lineno" id=line311></span>        <span class="small_keyword" title="conditional">if</span> point <span class="tex_symbol" title="\in">\(\in\)</span> r <span class="small_keyword" title="conditional">then</span> Some pos <span class="small_keyword" title="conditional">else</span> hotpos (point, tail)
<span class="lineno" id=line312></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line313></span>    ;
<span class="lineno" id=line314></span>  
<span class="lineno" id=line315></span>    <span class="comment">// ===============================================================================</span>
<span class="lineno" id=line316></span>    <span class="big_keyword" title="define an object factory">object</span> MenuBarDisplay 
<span class="lineno" id=line317></span>    (
<span class="lineno" id=line318></span>      tag:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line319></span>      m:menu_model_t,
<span class="lineno" id=line320></span>      w:window_t,
<span class="lineno" id=line321></span>      x:<span class="library" title="binding of C int type">int</span>,y:<span class="library" title="binding of C int type">int</span>,
<span class="lineno" id=line322></span>      font:font_t,
<span class="lineno" id=line323></span>      text_colour: button_colour_scheme_t,
<span class="lineno" id=line324></span>      disabled_colour: button_colour_scheme_t,
<span class="lineno" id=line325></span>      selected_colour: button_colour_scheme_t,
<span class="lineno" id=line326></span>      submenu_icons: submenu_icon_t
<span class="lineno" id=line327></span>    ) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> menu_display_t =
<span class="lineno" id=line328></span>    {
<span class="lineno" id=line329></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_tag() =&gt; tag;
<span class="lineno" id=line330></span>      <span class="big_keyword" title="Define a mutable variable">var</span> icon_width = max (submenu_icons.open_icon.get_width(), submenu_icons.closed_icon.get_width());
<span class="lineno" id=line331></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lineskip = get_lineskip font;
<span class="lineno" id=line332></span>      <span class="big_keyword" title="Define a mutable variable">var</span> baseline_offset = font.TTF_FontAscent; 
<span class="lineno" id=line333></span>      <span class="big_keyword" title="Define a mutable variable">var</span> border_width = 2;
<span class="lineno" id=line334></span>      <span class="big_keyword" title="Define a mutable variable">var</span> left_padding = 4;
<span class="lineno" id=line335></span>      <span class="big_keyword" title="Define a mutable variable">var</span> right_padding = 4; 
<span class="lineno" id=line336></span>      <span class="big_keyword" title="Define a mutable variable">var</span> min_width = 20;
<span class="lineno" id=line337></span>      <span class="big_keyword" title="Define a mutable variable">var</span> separator_width = 1;
<span class="lineno" id=line338></span>      <span class="big_keyword" title="Define a mutable variable">var</span> top_padding = 1;
<span class="lineno" id=line339></span>      <span class="big_keyword" title="Define a mutable variable">var</span> bottom_padding = 1;
<span class="lineno" id=line340></span>      <span class="big_keyword" title="Define a mutable variable">var</span> bar_depth =
<span class="lineno" id=line341></span>        top_padding + bottom_padding + lineskip
<span class="lineno" id=line342></span>      ;
<span class="lineno" id=line343></span>  
<span class="lineno" id=line344></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; (FlxGuiFont::get_textsize (font,s)).0;
<span class="lineno" id=line345></span>  
<span class="lineno" id=line346></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width: menu_entry_t -&gt; <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line347></span>        | #Separator =&gt; left_padding + right_padding + separator_width
<span class="lineno" id=line348></span>        | Text s =&gt; left_padding + right_padding + max(min_width, width s.label)
<span class="lineno" id=line349></span>      ;
<span class="lineno" id=line350></span>  
<span class="lineno" id=line351></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width : menu_item_t -&gt; <span class="library" title="binding of C int type">int</span> =
<span class="lineno" id=line352></span>        | Leaf menu_entry =&gt; width menu_entry
<span class="lineno" id=line353></span>        | Tree (menu_entry,_) =&gt; width menu_entry
<span class="lineno" id=line354></span>      ;
<span class="lineno" id=line355></span>  
<span class="lineno" id=line356></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> width (ls: menu_data_t) =&gt; <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> 
<span class="lineno" id=line357></span>        (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (w:<span class="library" title="binding of C int type">int</span>) (menu_item:menu_item_t) =&gt; w + width menu_item)
<span class="lineno" id=line358></span>        0 
<span class="lineno" id=line359></span>        ls
<span class="lineno" id=line360></span>      ;
<span class="lineno" id=line361></span>  
<span class="lineno" id=line362></span>      <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> display_menu(x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, menu:menu_data_t, position:menu_position_t) 
<span class="lineno" id=line363></span>      {
<span class="lineno" id=line364></span>        <span class="big_keyword" title="Define a mutable variable">var</span> left_x = x;
<span class="lineno" id=line365></span>        <span class="big_keyword" title="Define a mutable variable">var</span> top_y = y;
<span class="lineno" id=line366></span>        <span class="big_keyword" title="Define a mutable variable">var</span> right_x = left_x + width menu;
<span class="lineno" id=line367></span>        <span class="big_keyword" title="Define a mutable variable">var</span> bottom_y = top_y + bar_depth;
<span class="lineno" id=line368></span>        <span class="big_keyword" title="Define a mutable variable">var</span> scheme = text_colour;
<span class="lineno" id=line369></span>  
<span class="lineno" id=line370></span>        w.remove tag;
<span class="lineno" id=line371></span>        <span class="comment">// top</span>
<span class="lineno" id=line372></span>        w.add$ mk_drawable tag draw_line (scheme.top_colour, left_x - 2,top_y - 2,right_x + 2, top_y - 2); 
<span class="lineno" id=line373></span>        w.add$ mk_drawable tag draw_line (scheme.top_colour, left_x - 1,top_y - 1,right_x + 1, top_y - 1); 
<span class="lineno" id=line374></span>        <span class="comment">// left</span>
<span class="lineno" id=line375></span>        w.add$ mk_drawable tag draw_line (scheme.left_colour, left_x - 2,top_y - 2,left_x - 2, bottom_y + 2); 
<span class="lineno" id=line376></span>        w.add$ mk_drawable tag draw_line (scheme.left_colour, left_x - 1,top_y - 1,left_x - 1, bottom_y + 1); 
<span class="lineno" id=line377></span>        <span class="comment">// right</span>
<span class="lineno" id=line378></span>        w.add$ mk_drawable tag draw_line (scheme.right_colour, right_x + 2,top_y - 2,right_x + 2, bottom_y + 2); 
<span class="lineno" id=line379></span>        w.add$ mk_drawable tag draw_line (scheme.right_colour, right_x + 1,top_y - 1,right_x + 1, bottom_y + 1); 
<span class="lineno" id=line380></span>        <span class="comment">// bottom</span>
<span class="lineno" id=line381></span>        w.add$ mk_drawable tag draw_line (scheme.bottom_colour, left_x - 1,bottom_y + 1,right_x + 1, bottom_y + 1); 
<span class="lineno" id=line382></span>        w.add$ mk_drawable tag draw_line (scheme.bottom_colour, left_x - 2,bottom_y + 2,right_x + 2, bottom_y + 2); 
<span class="lineno" id=line383></span>  
<span class="lineno" id=line384></span>        w.add$ mk_drawable tag fill(SDL_Rect (left_x, top_y, right_x - left_x + 1, bottom_y - top_y + 1), scheme.bg_colour);
<span class="lineno" id=line385></span>  
<span class="lineno" id=line386></span>        <span class="big_keyword" title="Define a mutable variable">var</span> selected = <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line387></span>          | #Empty =&gt; 0 <span class="comment">// ignore for the moment</span>
<span class="lineno" id=line388></span>          | Cons (h,_) =&gt; h
<span class="lineno" id=line389></span>        ;
<span class="lineno" id=line390></span>  
<span class="lineno" id=line391></span>        <span class="big_keyword" title="Define a mutable variable">var</span> counter = 0;
<span class="lineno" id=line392></span>        <span class="big_keyword" title="Define a mutable variable">var</span> xpos = left_x + left_padding;
<span class="lineno" id=line393></span>  <span class="comment">//println$ "Display Menu "+ tag;</span>
<span class="lineno" id=line394></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> show_entry (entry: menu_entry_t) (submenu:menu_data_t) =&gt; 
<span class="lineno" id=line395></span>          <span class="small_keyword" title="match statement or expression">match</span> entry <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line396></span>          | #Separator =&gt; 
<span class="lineno" id=line397></span>            w.add$ mk_drawable tag draw_line (RGB(0,0,0), xpos, top_y, xpos, top_y+bar_depth); 
<span class="lineno" id=line398></span>            xpos = xpos + separator_width + right_padding + left_padding;
<span class="lineno" id=line399></span>  
<span class="lineno" id=line400></span>          | Text (label=s,active=active) =&gt;
<span class="lineno" id=line401></span>            <span class="big_keyword" title="Define a mutable variable">var</span> scheme, dosub = <span class="small_keyword" title="match statement or expression">match</span> active <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line402></span>              | #Active =&gt; <span class="small_keyword" title="conditional">if</span> counter == selected <span class="small_keyword" title="conditional">then</span> selected_colour, <span class="library" title="truth value">true</span> <span class="small_keyword" title="conditional">else</span> text_colour, <span class="library" title="false value">false</span>
<span class="lineno" id=line403></span>              | #Disabled =&gt; disabled_colour, <span class="library" title="false value">false</span>
<span class="lineno" id=line404></span>            ;
<span class="lineno" id=line405></span>            <span class="big_keyword" title="Define a mutable variable">var</span> item_width =  max (width s, min_width);
<span class="lineno" id=line406></span>            <span class="big_keyword" title="Define a mutable variable">var</span> client_area = rect_t (
<span class="lineno" id=line407></span>              xpos+border_width,
<span class="lineno" id=line408></span>              top_y+top_padding,
<span class="lineno" id=line409></span>              item_width,
<span class="lineno" id=line410></span>              lineskip
<span class="lineno" id=line411></span>            );
<span class="lineno" id=line412></span>            w.add$ mk_drawable tag fill (client_area, scheme.bg_colour);
<span class="lineno" id=line413></span>  <span class="comment">//println$ "Menu bar counter=" + counter.str + ", xpos= " + xpos.str + ", text="+s.str;</span>
<span class="lineno" id=line414></span>            w.add$ mk_drawable tag FlxGui::<span class="library" title="Print a string to a stream">write</span> (
<span class="lineno" id=line415></span>              xpos+left_padding, 
<span class="lineno" id=line416></span>              top_y+baseline_offset,
<span class="lineno" id=line417></span>              font,
<span class="lineno" id=line418></span>              scheme.label_colour,
<span class="lineno" id=line419></span>              s
<span class="lineno" id=line420></span>            );
<span class="lineno" id=line421></span>  
<span class="lineno" id=line422></span>            <span class="small_keyword" title="match statement or expression">match</span> submenu <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line423></span>            | #Empty =&gt; ;
<span class="lineno" id=line424></span>            | _ =&gt; 
<span class="lineno" id=line425></span>              <span class="small_keyword" title="conditional">if</span> dosub <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line426></span>                <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"SUBMENU SELECTED"</span>;
<span class="lineno" id=line427></span>                <span class="big_keyword" title="Define a mutable variable">var</span> smm = MenuModel ( submenu );
<span class="lineno" id=line428></span>                <span class="big_keyword" title="Define a mutable variable">var</span> smd = MenuDisplay ( tag,
<span class="lineno" id=line429></span>                  smm,
<span class="lineno" id=line430></span>                  w,
<span class="lineno" id=line431></span>                  xpos,bottom_y+border_width,
<span class="lineno" id=line432></span>                  font,
<span class="lineno" id=line433></span>                  text_colour,
<span class="lineno" id=line434></span>                  disabled_colour,
<span class="lineno" id=line435></span>                  selected_colour,
<span class="lineno" id=line436></span>                  submenu_icons
<span class="lineno" id=line437></span>                );
<span class="lineno" id=line438></span>                <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line439></span>                | Cons (_,tail) =&gt; smm.set_state (Open tail);
<span class="lineno" id=line440></span>                | _ =&gt; ;
<span class="lineno" id=line441></span>                <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line442></span>                smd.display();
<span class="lineno" id=line443></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line444></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line445></span>            xpos = xpos + item_width + right_padding+left_padding;
<span class="lineno" id=line446></span>            ++counter;
<span class="lineno" id=line447></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line448></span>        ;
<span class="lineno" id=line449></span>        <span class="small_keyword" title="for loop">for</span> item <span class="small_keyword" title="membership operator, function mem">in</span> menu <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line450></span>          <span class="small_keyword" title="match statement or expression">match</span> item <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line451></span>          | Leaf entry =&gt; show_entry entry Empty[LS_expr::lsexpr[menu_entry_t, menu_entry_t]];
<span class="lineno" id=line452></span>          | Tree (entry, submenu) =&gt; show_entry entry submenu;
<span class="lineno" id=line453></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line454></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line455></span>      }  
<span class="lineno" id=line456></span>  
<span class="lineno" id=line457></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> display() {
<span class="lineno" id=line458></span>        <span class="big_keyword" title="Define an immutable value">val</span> position = <span class="small_keyword" title="match statement or expression">match</span> #(m.get_state) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line459></span>          | #Closed =&gt; <span class="library" title="functional, singly linked list">list</span> (0)
<span class="lineno" id=line460></span>          | Open p =&gt; p
<span class="lineno" id=line461></span>        ;
<span class="lineno" id=line462></span>        display_menu (x,y,#(m.get_menu), position);
<span class="lineno" id=line463></span>        <span class="comment">//w.update(); </span>
<span class="lineno" id=line464></span>      }
<span class="lineno" id=line465></span>      <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> get_hotrecs(x:<span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, menu:menu_data_t, position:menu_position_t) 
<span class="lineno" id=line466></span>        (revtrail: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span>]) 
<span class="lineno" id=line467></span>        (photrecs:&amp;<span class="library" title="functional, singly linked list">list</span>[rect_t * menu_position_t])=
<span class="lineno" id=line468></span>      {
<span class="lineno" id=line469></span>  <span class="comment">//println$ "get_hotrecs, revtrail=" + revtrail.str+", pos=" + position.str;</span>
<span class="lineno" id=line470></span>        <span class="big_keyword" title="Define a mutable variable">var</span> left_x = x;
<span class="lineno" id=line471></span>        <span class="big_keyword" title="Define a mutable variable">var</span> top_y = y;
<span class="lineno" id=line472></span>        <span class="big_keyword" title="Define a mutable variable">var</span> right_x = left_x + width menu;
<span class="lineno" id=line473></span>        <span class="big_keyword" title="Define a mutable variable">var</span> bottom_y = top_y + bar_depth;
<span class="lineno" id=line474></span>  
<span class="lineno" id=line475></span>        <span class="big_keyword" title="Define a mutable variable">var</span> selected = <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line476></span>          | #Empty =&gt; 0 <span class="comment">// ignore for the moment</span>
<span class="lineno" id=line477></span>          | Cons (h,_) =&gt; h
<span class="lineno" id=line478></span>        ;
<span class="lineno" id=line479></span>  
<span class="lineno" id=line480></span>        <span class="big_keyword" title="Define a mutable variable">var</span> counter = 0;
<span class="lineno" id=line481></span>        <span class="big_keyword" title="Define a mutable variable">var</span> xpos = left_x + left_padding;
<span class="lineno" id=line482></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> hotrecs (entry: menu_entry_t) (submenu:menu_data_t) 
<span class="lineno" id=line483></span>        {
<span class="lineno" id=line484></span>          <span class="small_keyword" title="match statement or expression">match</span> entry <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line485></span>          | #Separator =&gt; 
<span class="lineno" id=line486></span>            xpos = xpos + separator_width + right_padding + left_padding;
<span class="lineno" id=line487></span>  <span class="comment">//println$ "SEPARATOR : Counter="+counter.str;</span>
<span class="lineno" id=line488></span>  
<span class="lineno" id=line489></span>          | Text (label=s,active=active) =&gt;
<span class="lineno" id=line490></span>            <span class="big_keyword" title="Define a mutable variable">var</span> dosub = <span class="small_keyword" title="match statement or expression">match</span> active <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line491></span>              | #Active =&gt; counter == selected
<span class="lineno" id=line492></span>              | #Disabled =&gt; <span class="library" title="false value">false</span>
<span class="lineno" id=line493></span>            ;
<span class="lineno" id=line494></span>            <span class="big_keyword" title="Define a mutable variable">var</span> item_width = max (width s, min_width);
<span class="lineno" id=line495></span>            <span class="big_keyword" title="Define a mutable variable">var</span> client_area = rect_t (
<span class="lineno" id=line496></span>              xpos+border_width,
<span class="lineno" id=line497></span>              top_y+top_padding,
<span class="lineno" id=line498></span>              item_width,
<span class="lineno" id=line499></span>              lineskip
<span class="lineno" id=line500></span>            );
<span class="lineno" id=line501></span>  <span class="comment">//println$ "TEXT: Counter="+counter.str+", Rect=" + client_area.str;</span>
<span class="lineno" id=line502></span>            <span class="small_keyword" title="match statement or expression">match</span> active <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line503></span>            | #Active =&gt; photrecs &lt;- (client_area, <span class="library" title="return data structure with elements reversed">rev</span> (counter + revtrail)) + *photrecs;
<span class="lineno" id=line504></span>            | #Disabled =&gt; ;
<span class="lineno" id=line505></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line506></span>            <span class="small_keyword" title="match statement or expression">match</span> submenu <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line507></span>            | #Empty =&gt; ;
<span class="lineno" id=line508></span>            | _ =&gt; 
<span class="lineno" id=line509></span>              <span class="small_keyword" title="conditional">if</span> dosub <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line510></span>                <span class="big_keyword" title="Define a mutable variable">var</span> smm = MenuModel ( submenu );
<span class="lineno" id=line511></span>                <span class="big_keyword" title="Define a mutable variable">var</span> smd = MenuDisplay (tag,
<span class="lineno" id=line512></span>                  smm,
<span class="lineno" id=line513></span>                  w,
<span class="lineno" id=line514></span>                  xpos,bottom_y+border_width,
<span class="lineno" id=line515></span>                  font,
<span class="lineno" id=line516></span>                  text_colour,
<span class="lineno" id=line517></span>                  disabled_colour,
<span class="lineno" id=line518></span>                  selected_colour,
<span class="lineno" id=line519></span>                  submenu_icons
<span class="lineno" id=line520></span>                );
<span class="lineno" id=line521></span>                <span class="small_keyword" title="match statement or expression">match</span> position <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line522></span>                | Cons (_,tail) =&gt; smm.set_state (Open tail);
<span class="lineno" id=line523></span>                | _ =&gt; ;
<span class="lineno" id=line524></span>                <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line525></span>                <span class="big_keyword" title="Define a mutable variable">var</span> shots = smd.get_hotrects();
<span class="lineno" id=line526></span>                shots = unbox$ <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (h:rect_t,pos:menu_position_t) =&gt; (h,Cons(counter,pos) )) shots;
<span class="lineno" id=line527></span>                photrecs &lt;- *photrecs + shots;
<span class="lineno" id=line528></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line529></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line530></span>            xpos = xpos + item_width + right_padding +left_padding;
<span class="lineno" id=line531></span>            ++counter;
<span class="lineno" id=line532></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line533></span>        }
<span class="lineno" id=line534></span>        <span class="small_keyword" title="for loop">for</span> item <span class="small_keyword" title="membership operator, function mem">in</span> menu <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line535></span>          <span class="small_keyword" title="match statement or expression">match</span> item <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line536></span>          | Leaf entry =&gt; hotrecs entry Empty[LS_expr::lsexpr[menu_entry_t, menu_entry_t]];
<span class="lineno" id=line537></span>          | Tree (entry, submenu) =&gt; hotrecs entry submenu;
<span class="lineno" id=line538></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line539></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line540></span>      }  
<span class="lineno" id=line541></span>  
<span class="lineno" id=line542></span>  
<span class="lineno" id=line543></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_hotrects() : <span class="library" title="functional, singly linked list">list</span>[rect_t * menu_position_t] =
<span class="lineno" id=line544></span>      {
<span class="lineno" id=line545></span>        <span class="big_keyword" title="Define an immutable value">val</span> position = <span class="small_keyword" title="match statement or expression">match</span> #(m.get_state) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line546></span>          | #Closed =&gt; <span class="library" title="functional, singly linked list">list</span> (0)
<span class="lineno" id=line547></span>          | Open p =&gt; p
<span class="lineno" id=line548></span>        ;
<span class="lineno" id=line549></span>        <span class="big_keyword" title="Define a mutable variable">var</span> hotrecs = Empty[rect_t * menu_position_t];
<span class="lineno" id=line550></span>        get_hotrecs (x,y,#(m.get_menu),position) Empty[<span class="library" title="binding of C int type">int</span>] &amp;hotrecs;
<span class="lineno" id=line551></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="return data structure with elements reversed">rev</span> hotrecs;
<span class="lineno" id=line552></span>      }
<span class="lineno" id=line553></span>  
<span class="lineno" id=line554></span>    } 
<span class="lineno" id=line555></span>    <span class="comment">// ===============================================================================</span>
<span class="lineno" id=line556></span>  
<span class="lineno" id=line557></span>  
<span class="lineno" id=line558></span>    <span class="big_keyword" title="defines a coroutine using chip idiom">chip</span> menu_controller 
<span class="lineno" id=line559></span>    (
<span class="lineno" id=line560></span>      mm: menu_model_t,
<span class="lineno" id=line561></span>      md: menu_display_t
<span class="lineno" id=line562></span>    )
<span class="lineno" id=line563></span>    <span class="small_keyword" title="the parameter of a chip">connector</span> mio
<span class="lineno" id=line564></span>      <span class="small_keyword" title="a field of the chip parameter">pin</span> ec: %&lt;event_t
<span class="lineno" id=line565></span>      <span class="small_keyword" title="a field of the chip parameter">pin</span> response: %&gt;menu_action_t
<span class="lineno" id=line566></span>    {
<span class="lineno" id=line567></span>      md.display();
<span class="lineno" id=line568></span>      <span class="big_keyword" title="Define a mutable variable">var</span> run = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line569></span>      <span class="big_keyword" title="Define a mutable variable">var</span> e = read mio.ec;
<span class="lineno" id=line570></span>      <span class="small_keyword" title="while loop">while</span> run <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line571></span>        <span class="small_keyword" title="match statement or expression">match</span> e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span>.SDL_EventType <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line572></span>        | $(SDL_WINDOWEVENT) =&gt;
<span class="lineno" id=line573></span>          <span class="small_keyword" title="match statement or expression">match</span> e.window.event.SDL_WindowEventID <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line574></span>          | $(SDL_WINDOWEVENT_RESIZED) =&gt;
<span class="lineno" id=line575></span>            md.display();
<span class="lineno" id=line576></span>            <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line577></span>  
<span class="lineno" id=line578></span>          | _ =&gt; <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line579></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line580></span>  
<span class="lineno" id=line581></span>        | $(SDL_MOUSEMOTION) =&gt;
<span class="lineno" id=line582></span>          <span class="big_keyword" title="Define a mutable variable">var</span> hotrecs = md.get_hotrects();
<span class="lineno" id=line583></span>          <span class="comment">//List::iter proc (r:rect_t, pos:menu_position_t) { println$ "Rect=" + r.str + ", Pos=" + pos.str; } hotrecs; </span>
<span class="lineno" id=line584></span>          
<span class="lineno" id=line585></span>          <span class="big_keyword" title="Define a mutable variable">var</span> x,y = e.motion.x,e.motion.y; <span class="comment">//int32</span>
<span class="lineno" id=line586></span>          <span class="small_keyword" title="match statement or expression">match</span> hotpos ( SDL_Point (x.<span class="library" title="binding of C int type">int</span>,y.<span class="library" title="binding of C int type">int</span>), hotrecs) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line587></span>          | #None =&gt;
<span class="lineno" id=line588></span>            <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line589></span>          | Some pos =&gt;
<span class="lineno" id=line590></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Mouse Move Position "</span> + pos.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line591></span>            <span class="small_keyword" title="match statement or expression">match</span> #(mm.get_state) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line592></span>            | #Closed =&gt;
<span class="lineno" id=line593></span>              <span class="library" title="Print a string to a stream">write</span>$ mio.response, ChangedPosition;
<span class="lineno" id=line594></span>            | Open oldpos =&gt;
<span class="lineno" id=line595></span>              <span class="small_keyword" title="conditional">if</span> oldpos == pos <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line596></span>                <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line597></span>              <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line598></span>                mm.set_state (Open pos);
<span class="lineno" id=line599></span>                <span class="library" title="Print a string to a stream">write</span>$ mio.response, ChangedPosition;
<span class="lineno" id=line600></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line601></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line602></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line603></span>     
<span class="lineno" id=line604></span>        | $(SDL_MOUSEBUTTONDOWN) =&gt; 
<span class="lineno" id=line605></span>          hotrecs = md.get_hotrects();
<span class="lineno" id=line606></span>          x,y = e.button.x,e.button.y; <span class="comment">//int32</span>
<span class="lineno" id=line607></span>          <span class="small_keyword" title="match statement or expression">match</span> hotpos ( SDL_Point (x.<span class="library" title="binding of C int type">int</span>,y.<span class="library" title="binding of C int type">int</span>), hotrecs) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line608></span>          | #None =&gt;
<span class="lineno" id=line609></span>            <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line610></span>          | Some pos =&gt;
<span class="lineno" id=line611></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Mouse down Position "</span> + pos.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line612></span>            <span class="small_keyword" title="match statement or expression">match</span> #(mm.get_state) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line613></span>            | #Closed =&gt;
<span class="lineno" id=line614></span>              <span class="library" title="Print a string to a stream">write</span>$ mio.response, ChangedPosition;
<span class="lineno" id=line615></span>            | Open oldpos =&gt;
<span class="lineno" id=line616></span>              <span class="small_keyword" title="conditional">if</span> oldpos == pos <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line617></span>                <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line618></span>              <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line619></span>                mm.set_state (Open pos);
<span class="lineno" id=line620></span>                <span class="library" title="Print a string to a stream">write</span>$ mio.response, ChangedPosition;
<span class="lineno" id=line621></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line622></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line623></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line624></span>  
<span class="lineno" id=line625></span>        | $(SDL_MOUSEBUTTONUP) =&gt; 
<span class="lineno" id=line626></span>          hotrecs = md.get_hotrects();
<span class="lineno" id=line627></span>          x,y = e.button.x,e.button.y; <span class="comment">//int32</span>
<span class="lineno" id=line628></span>          <span class="small_keyword" title="match statement or expression">match</span> hotpos ( SDL_Point (x.<span class="library" title="binding of C int type">int</span>,y.<span class="library" title="binding of C int type">int</span>), hotrecs) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line629></span>          | #None =&gt;
<span class="lineno" id=line630></span>            <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line631></span>          | Some pos =&gt;
<span class="lineno" id=line632></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Mouse up Position "</span> + pos.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line633></span>            <span class="small_keyword" title="match statement or expression">match</span> #(mm.get_state) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line634></span>            | #Closed =&gt;
<span class="lineno" id=line635></span>              <span class="library" title="Print a string to a stream">write</span>$ mio.response, ChangedPosition;
<span class="lineno" id=line636></span>            | Open oldpos =&gt;
<span class="lineno" id=line637></span>              <span class="small_keyword" title="conditional">if</span> oldpos == pos <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line638></span>                <span class="big_keyword" title="Define a mutable variable">var</span> selected_tag = #(mm.get_current_tag);
<span class="lineno" id=line639></span>                <span class="library" title="Print a string to a stream">write</span>$ mio.response, SelectedAction selected_tag;
<span class="lineno" id=line640></span>              <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line641></span>                mm.set_state (Open pos);
<span class="lineno" id=line642></span>                <span class="library" title="Print a string to a stream">write</span>$ mio.response, ChangedPosition;
<span class="lineno" id=line643></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line644></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line645></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line646></span>  
<span class="lineno" id=line647></span>  
<span class="lineno" id=line648></span>  
<span class="lineno" id=line649></span>        | $(SDL_WINDOWEVENT) <span class="small_keyword" title="predicative type constraint or precondition">when</span> e.window.event == SDL_WINDOWEVENT_LEAVE.<span class="library" title="binding of C uint8_t type">uint8</span>  =&gt;
<span class="lineno" id=line650></span>          <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line651></span>  
<span class="lineno" id=line652></span>        | _ =&gt; 
<span class="lineno" id=line653></span>          <span class="library" title="Print a string to a stream">write</span>$ mio.response, NoAction;
<span class="lineno" id=line654></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line655></span>        e = read mio.ec;
<span class="lineno" id=line656></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line657></span>  
<span class="lineno" id=line658></span>    }
<span class="lineno" id=line659></span>  
<span class="lineno" id=line660></span>  }
<span class="lineno" id=line661></span>  
</pre></p><pre class='inclusion'>
share/lib/gui/line_buffer_display_controller_interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiLineBufferDisplayControllerInterface
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>  <span class="big_keyword" title="define an object interface">interface</span> line_buffer_display_controller_interface
<span class="lineno" id=line4></span>  {
<span class="lineno" id=line5></span>    get_tag : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line6></span>    get_client_rect : 1 -&gt; rect_t;
<span class="lineno" id=line7></span>    get_char_width : 1 -&gt; <span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line8></span>    display : 1 -&gt; 0;
<span class="lineno" id=line9></span>    set_focus_gained: 1 -&gt; 0; <span class="comment">// </span>
<span class="lineno" id=line10></span>    set_focus_lost: 1 -&gt; 0;
<span class="lineno" id=line11></span>  }
<span class="lineno" id=line12></span>  }
<span class="lineno" id=line13></span>  
</pre></p><pre class='inclusion'>
share/lib/gui/line_buffer_display_controller.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/line_buffer_display_controller_interface"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiLineBufferDisplayController
<span class="lineno" id=line4></span>  {
<span class="lineno" id=line5></span>  <span class="big_keyword" title="define an object factory">object</span> line_buffer_display_controller
<span class="lineno" id=line6></span>  (
<span class="lineno" id=line7></span>    w:window_t, tag:<span class="library" title="binding of C++ string type">string</span>, f:font_t, c:colour_t, bg:colour_t,
<span class="lineno" id=line8></span>    x: <span class="library" title="binding of C int type">int</span>, y:<span class="library" title="binding of C int type">int</span>, b:line_buffer_interface
<span class="lineno" id=line9></span>  ) 
<span class="lineno" id=line10></span>  <span class="small_keyword" title="specify what interfaces an object implements">implements</span> line_buffer_display_controller_interface =
<span class="lineno" id=line11></span>  {
<span class="lineno" id=line12></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_tag() =&gt; tag;
<span class="lineno" id=line13></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_client_rect () =&gt; bounding_box (f,x,y,b.get());
<span class="lineno" id=line14></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_char_width () = {
<span class="lineno" id=line15></span>      <span class="big_keyword" title="Define a mutable variable">var</span> minx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> miny:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxy:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> advance:<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line16></span>      <span class="hack">C_hack</span>::ignore$ TTF_GlyphMetrics(f,<span class="fstring">"m"</span>.<span class="library" title="binding of C char type">char</span>.ord.<span class="library" title="binding of C uint16_t type">uint16</span>,&amp;minx, &amp;maxx, &amp;miny, &amp;maxy, &amp;advance);
<span class="lineno" id=line17></span>      <span class="small_keyword" title="return">return</span> advance;
<span class="lineno" id=line18></span>    }
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>    <span class="big_keyword" title="Define a mutable variable">var</span> has_focus = <span class="library" title="false value">false</span>;
<span class="lineno" id=line21></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set_focus_gained () =&gt; has_focus = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line22></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set_focus_lost () =&gt; has_focus = <span class="library" title="false value">false</span>;
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> display ()
<span class="lineno" id=line25></span>    {
<span class="lineno" id=line26></span>      <span class="big_keyword" title="Define a mutable variable">var</span> nullRect = <span class="hack">C_hack</span>::null[SDL_Rect];
<span class="lineno" id=line27></span>      <span class="big_keyword" title="Define a mutable variable">var</span> s = #(b.get);
<span class="lineno" id=line28></span>  <span class="comment">//  println$ "Edit box = '" + s + "'";</span>
<span class="lineno" id=line29></span>      <span class="big_keyword" title="Define a mutable variable">var</span> text_rendered = TTF_RenderText_Blended(f,s,c);
<span class="lineno" id=line30></span>      <span class="big_keyword" title="Define a mutable variable">var</span> bbox = bounding_box (f,x,y,s);
<span class="lineno" id=line31></span>  <span class="comment">//println$ "Bounding box for ("+x.str+","+y.str+")=("+bbox.x.str+","+bbox.y.str+","+bbox.w.str+","+bbox.h.str+")";</span>
<span class="lineno" id=line32></span>      w.remove tag;
<span class="lineno" id=line33></span>      w.add$ mk_drawable tag fill (bbox,bg);
<span class="lineno" id=line34></span>      <span class="big_keyword" title="Define a mutable variable">var</span> viewport: SDL_Rect;
<span class="lineno" id=line35></span>      <span class="big_keyword" title="Define a mutable variable">var</span> minx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> miny:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxy:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> advance:<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line36></span>      <span class="hack">C_hack</span>::ignore$ TTF_GlyphMetrics(f,<span class="fstring">"m"</span>.<span class="library" title="binding of C char type">char</span>.ord.<span class="library" title="binding of C uint16_t type">uint16</span>,&amp;minx, &amp;maxx, &amp;miny, &amp;maxy, &amp;advance);
<span class="lineno" id=line37></span>        
<span class="lineno" id=line38></span>      viewport&amp;.x &lt;- bbox.x + min(minx,0) + 2; 
<span class="lineno" id=line39></span>      viewport&amp;.y &lt;- bbox.y + 2; <span class="comment">// actually y + font.ascent + 2</span>
<span class="lineno" id=line40></span>      viewport&amp;.h &lt;-  bbox.h;
<span class="lineno" id=line41></span>  <span class="comment">//println$ "Viewpos for ("+x.str+","+y.str+")=("+viewport.x.str+","+viewport.y.str;</span>
<span class="lineno" id=line42></span>      w.add$ mk_drawable tag blit (viewport.x, viewport.y, text_rendered); 
<span class="lineno" id=line43></span>      <span class="comment">//SDL_FreeSurface text_rendered;</span>
<span class="lineno" id=line44></span>      <span class="small_keyword" title="conditional">if</span> has_focus <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line45></span>        <span class="big_keyword" title="Define a mutable variable">var</span> charwidth = 
<span class="lineno" id=line46></span>          #{ 
<span class="lineno" id=line47></span>            <span class="big_keyword" title="Define a mutable variable">var</span> minx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxx:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> miny:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> maxy:<span class="library" title="binding of C int type">int</span>; <span class="big_keyword" title="Define a mutable variable">var</span> advance:<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line48></span>            <span class="hack">C_hack</span>::ignore$ TTF_GlyphMetrics(f,<span class="fstring">"m"</span>.<span class="library" title="binding of C char type">char</span>.ord.<span class="library" title="binding of C uint16_t type">uint16</span>,&amp;minx, &amp;maxx, &amp;miny, &amp;maxy, &amp;advance);
<span class="lineno" id=line49></span>            <span class="small_keyword" title="return">return</span> advance;
<span class="lineno" id=line50></span>          }
<span class="lineno" id=line51></span>        ;
<span class="lineno" id=line52></span>        <span class="big_keyword" title="Define a mutable variable">var</span> curpos = x + charwidth * #(b.get_pos);
<span class="lineno" id=line53></span>        w.add$ mk_drawable tag draw_line(red,curpos,viewport.y - 1,curpos,viewport.y + viewport.h - 2);
<span class="lineno" id=line54></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line55></span>    } 
<span class="lineno" id=line56></span>    display();
<span class="lineno" id=line57></span>  }
<span class="lineno" id=line58></span>  }
<span class="lineno" id=line59></span>  
</pre></p><pre class='inclusion'>
share/lib/gui/line_buffer_interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiLineBufferInterface
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="define an object interface">interface</span> line_buffer_interface 
<span class="lineno" id=line4></span>    {
<span class="lineno" id=line5></span>      get: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line6></span>      get_pos: 1 -&gt; <span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line7></span>      set_pos: <span class="library" title="binding of C int type">int</span> -&gt; 0;
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>      <span class="comment">// movement</span>
<span class="lineno" id=line10></span>      mv_left : 1 -&gt; 0;
<span class="lineno" id=line11></span>      mv_right : 1 -&gt; 0;
<span class="lineno" id=line12></span>      mv_start : 1 -&gt; 0;
<span class="lineno" id=line13></span>      mv_end : 1 -&gt; 0;
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>      <span class="comment">// insert and overwrite</span>
<span class="lineno" id=line16></span>      ins: <span class="library" title="binding of C char type">char</span> -&gt; 0;
<span class="lineno" id=line17></span>      ovr: <span class="library" title="binding of C char type">char</span> -&gt; 0;
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>      <span class="comment">// delete</span>
<span class="lineno" id=line20></span>      del_left: 1 -&gt; 0;
<span class="lineno" id=line21></span>      del_right: 1 -&gt; 0;
<span class="lineno" id=line22></span>      clear : 1 -&gt;0;
<span class="lineno" id=line23></span>      clear_right : 1 -&gt; 0;
<span class="lineno" id=line24></span>      clear_left : 1 -&gt; 0;
<span class="lineno" id=line25></span>    }
<span class="lineno" id=line26></span>  }
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>  
</pre></p><pre class='inclusion'>
share/lib/gui/line_buffer_object.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/line_buffer_interface"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiLineBuffer
<span class="lineno" id=line4></span>  {
<span class="lineno" id=line5></span>    <span class="big_keyword" title="define an object factory">object</span> line_buffer (n:<span class="library" title="binding of C int type">int</span>, <span class="big_keyword" title="Define a mutable variable">var</span> b:<span class="library" title="binding of C++ string type">string</span>) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> line_buffer_interface =
<span class="lineno" id=line6></span>    {
<span class="lineno" id=line7></span>      b = substring (b+ <span class="fstring">' '</span> *n,0,n); <span class="comment">//clip and pad to n chars</span>
<span class="lineno" id=line8></span>      <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line9></span>  
<span class="lineno" id=line10></span>      <span class="comment">// caret position: can range between 0 and n inclusive!</span>
<span class="lineno" id=line11></span>      <span class="comment">// its the position *between* two characters!!</span>
<span class="lineno" id=line12></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pos = 0; 
<span class="lineno" id=line13></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get() =&gt; b;
<span class="lineno" id=line14></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_pos () =&gt; pos;
<span class="lineno" id=line15></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> set_pos (x:<span class="library" title="binding of C int type">int</span>) =&gt; pos = x;
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>      <span class="comment">// movement</span>
<span class="lineno" id=line18></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> mv_left () =&gt; pos = max (0,pos - 1);
<span class="lineno" id=line19></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> mv_right () =&gt; pos = min (n, pos + 1);
<span class="lineno" id=line20></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> mv_start () =&gt; pos = 0;
<span class="lineno" id=line21></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> mv_end () =&gt; pos = n;
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>      <span class="comment">// insert and move right</span>
<span class="lineno" id=line24></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ins (ch:<span class="library" title="binding of C char type">char</span>) 
<span class="lineno" id=line25></span>      {
<span class="lineno" id=line26></span>        b = substring (b, 0, pos) + ch + substring (b, pos, n);
<span class="lineno" id=line27></span>        pos = min (pos + 1, n);
<span class="lineno" id=line28></span>        <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line29></span>      }
<span class="lineno" id=line30></span>      <span class="comment">// overwrite and move right</span>
<span class="lineno" id=line31></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ovr (ch:<span class="library" title="binding of C char type">char</span>) 
<span class="lineno" id=line32></span>      {
<span class="lineno" id=line33></span>        <span class="small_keyword" title="conditional">if</span> pos &lt; n <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line34></span>          b = substring (b, 0, pos) + ch + substring (b, pos+1, n);
<span class="lineno" id=line35></span>          pos = min (pos + 1, n);
<span class="lineno" id=line36></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line37></span>        <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line38></span>      }
<span class="lineno" id=line39></span>      <span class="comment">// delete to the left</span>
<span class="lineno" id=line40></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> del_left ()
<span class="lineno" id=line41></span>      {
<span class="lineno" id=line42></span>        <span class="small_keyword" title="conditional">if</span> pos &gt; 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line43></span>          b = substring (b, 0, pos - 1) + substring (b, pos, n) + <span class="fstring">' '</span>;
<span class="lineno" id=line44></span>          pos = max (0, pos - 1);
<span class="lineno" id=line45></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line46></span>        <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line47></span>      }
<span class="lineno" id=line48></span>      <span class="comment">// delete to the right</span>
<span class="lineno" id=line49></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> del_right ()
<span class="lineno" id=line50></span>      {
<span class="lineno" id=line51></span>        <span class="small_keyword" title="conditional">if</span> pos &lt; n <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line52></span>          b = substring (b, 0, pos) + substring (b, pos + 1, n) + <span class="fstring">' '</span>;
<span class="lineno" id=line53></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line54></span>        <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line55></span>      }
<span class="lineno" id=line56></span>      <span class="comment">// clear all</span>
<span class="lineno" id=line57></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> clear () 
<span class="lineno" id=line58></span>      {
<span class="lineno" id=line59></span>        b = <span class="fstring">' '</span> *n; 
<span class="lineno" id=line60></span>        pos = 0;
<span class="lineno" id=line61></span>        <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line62></span>      }
<span class="lineno" id=line63></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> clear_right ()
<span class="lineno" id=line64></span>      {
<span class="lineno" id=line65></span>        b = substring (b, 0, pos) + <span class="fstring">' '</span> * (n - pos);
<span class="lineno" id=line66></span>        <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line67></span>      }
<span class="lineno" id=line68></span>      <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> clear_left ()
<span class="lineno" id=line69></span>      {
<span class="lineno" id=line70></span>        b = substring (b, pos, n) + <span class="fstring">' '</span> * pos;
<span class="lineno" id=line71></span>        pos = 0;
<span class="lineno" id=line72></span>        <span class="big_keyword" title="Run time assertion">assert</span> b.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> == n;
<span class="lineno" id=line73></span>      }
<span class="lineno" id=line74></span>    }
<span class="lineno" id=line75></span>  
<span class="lineno" id=line76></span>  }
</pre></p><pre class='inclusion'>
share/lib/gui/line_editor.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> FlxGuiLineEditor
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>  <span class="big_keyword" title="defines a coroutine using chip idiom">chip</span> line_edit 
<span class="lineno" id=line4></span>    (b:line_buffer_interface)
<span class="lineno" id=line5></span>    (d:line_buffer_display_controller_interface) 
<span class="lineno" id=line6></span>    <span class="small_keyword" title="the parameter of a chip">connector</span> lin
<span class="lineno" id=line7></span>      <span class="small_keyword" title="a field of the chip parameter">pin</span> ec: %&lt;event_t
<span class="lineno" id=line8></span>  {
<span class="lineno" id=line9></span>    <span class="comment">//println$ "Line buffer running";</span>
<span class="lineno" id=line10></span>    d.display();
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Define a mutable variable">var</span> run = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a mutable variable">var</span> e : event_t = read lin.ec;
<span class="lineno" id=line13></span>    <span class="small_keyword" title="while loop">while</span> run <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line14></span>      <span class="small_keyword" title="match statement or expression">match</span> e.<span class="big_keyword" title="Define a primitive type by binding to a C type">type</span>.SDL_EventType <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line15></span>      | $(SDL_WINDOWEVENT) =&gt;
<span class="lineno" id=line16></span>        <span class="small_keyword" title="match statement or expression">match</span> e.window.event.SDL_WindowEventID <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line17></span>        | $(SDL_WINDOWEVENT_FOCUS_GAINED) =&gt; d.set_focus_gained (); d.display();
<span class="lineno" id=line18></span>        | $(SDL_WINDOWEVENT_FOCUS_LOST) =&gt; d.set_focus_lost (); d.display();
<span class="lineno" id=line19></span>        | $(SDL_WINDOWEVENT_RESIZED) =&gt;  d.display();
<span class="lineno" id=line20></span>        | _ =&gt; ;
<span class="lineno" id=line21></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>      | $(SDL_MOUSEBUTTONDOWN) =&gt; 
<span class="lineno" id=line24></span>        <span class="big_keyword" title="Define a mutable variable">var</span> x,y = e.button.x,e.button.y; <span class="comment">//int32</span>
<span class="lineno" id=line25></span>        <span class="small_keyword" title="conditional">if</span> SDL_Point (x.<span class="library" title="binding of C int type">int</span>,y.<span class="library" title="binding of C int type">int</span>) <span class="tex_symbol" title="\in">\(\in\)</span> d.get_client_rect () <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line26></span>          <span class="big_keyword" title="Define a mutable variable">var</span> w = d.get_char_width();
<span class="lineno" id=line27></span>          <span class="big_keyword" title="Define a mutable variable">var</span> inchar = (x.<span class="library" title="binding of C int type">int</span> - (d.get_client_rect()).x + w / 2) / w;
<span class="lineno" id=line28></span>          <span class="comment">//println$ "Button down in client rect of line edit " + d.get_tag() + ", pos = " + inchar.str;</span>
<span class="lineno" id=line29></span>          b.set_pos inchar; 
<span class="lineno" id=line30></span>          d.display();
<span class="lineno" id=line31></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line32></span>   
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>      | $(SDL_KEYDOWN) =&gt;
<span class="lineno" id=line35></span>        <span class="big_keyword" title="Define a mutable variable">var</span> vkey = e.key.keysym.sym;
<span class="lineno" id=line36></span>        <span class="small_keyword" title="match statement or expression">match</span> vkey <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line37></span>        | $(SDLK_LEFT) =&gt; b.mv_left (); d.display();
<span class="lineno" id=line38></span>        | $(SDLK_RIGHT) =&gt; b.mv_right (); d.display();
<span class="lineno" id=line39></span>        | $(SDLK_HOME) =&gt; b.mv_start (); d.display();
<span class="lineno" id=line40></span>        | $(SDLK_END) =&gt; b.mv_end (); d.display();
<span class="lineno" id=line41></span>        | $(SDLK_DELETE) =&gt; b.del_right(); d.display();
<span class="lineno" id=line42></span>        | $(SDLK_BACKSPACE) =&gt; b.del_left(); d.display();
<span class="lineno" id=line43></span>        | $(SDLK_RETURN) =&gt; b.mv_start(); d.display();
<span class="lineno" id=line44></span>        | $(SDLK_TAB) =&gt; b.mv_start(); d.display();
<span class="lineno" id=line45></span>        | _ =&gt; ;
<span class="lineno" id=line46></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line47></span>      | $(SDL_TEXTINPUT) =&gt;
<span class="lineno" id=line48></span>        <span class="big_keyword" title="Define a mutable variable">var</span> text_buffer : +<span class="library" title="binding of C char type">char</span> = e.text.text;
<span class="lineno" id=line49></span>        <span class="big_keyword" title="Define a mutable variable">var</span> ch = text_buffer . 0;
<span class="lineno" id=line50></span>        b.ovr ch; 
<span class="lineno" id=line51></span>        d.display();
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>      <span class="comment">// NOTE: not an actual SDL_QUIT!</span>
<span class="lineno" id=line54></span>      <span class="comment">// We just need something to terminate.</span>
<span class="lineno" id=line55></span>      <span class="comment">// Should be sent on window close actually.</span>
<span class="lineno" id=line56></span>      | $(SDL_QUIT) =&gt;  
<span class="lineno" id=line57></span>        run = <span class="library" title="false value">false</span>;
<span class="lineno" id=line58></span>      | _ =&gt; ;
<span class="lineno" id=line59></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line60></span>      e = read lin.ec;
<span class="lineno" id=line61></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line62></span>  } <span class="comment">//chip</span>
<span class="lineno" id=line63></span>  } <span class="comment">//class</span>
<span class="lineno" id=line64></span>   
</pre></p></div></div><h1 id='Tools_h'><img src='/share/src/web/images/minus.gif' id='Tools' onclick='toggle(this,"Tools_d")' alt='+'/> 6 Tools</h1><div id='Tools_d' style='display:block'>
<pre class='inclusion'>
share/lib/gui/linegraph.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"gui/__init__"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  library GraphTools {
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Open a module or class">open</span> FlxGui;
<span class="lineno" id=line6></span>    <span class="big_keyword" title="define an object interface">interface</span> linegraph_t {
<span class="lineno" id=line7></span>      title: <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line8></span>      func: <span class="library" title="binding of C double float type">double</span> -&gt; <span class="library" title="binding of C double float type">double</span>;
<span class="lineno" id=line9></span>      xmin: <span class="library" title="binding of C double float type">double</span>;
<span class="lineno" id=line10></span>      xmax: <span class="library" title="binding of C double float type">double</span>;
<span class="lineno" id=line11></span>      ymin: <span class="library" title="binding of C double float type">double</span>;
<span class="lineno" id=line12></span>      ymax: <span class="library" title="binding of C double float type">double</span>;
<span class="lineno" id=line13></span>      client: rect_t;
<span class="lineno" id=line14></span>    }
<span class="lineno" id=line15></span>  
<span class="lineno" id=line16></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> linegraph (g:linegraph_t) {
<span class="lineno" id=line17></span>      <span class="comment">// SDL</span>
<span class="lineno" id=line18></span>      FlxGui::init();
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>      <span class="comment">// window</span>
<span class="lineno" id=line21></span>      <span class="big_keyword" title="Define a mutable variable">var</span> w = create_resizable_window(g.title, 
<span class="lineno" id=line22></span>        g.client.x,g.client.y,g.client.w,g.client.h
<span class="lineno" id=line23></span>      );
<span class="lineno" id=line24></span>      w.add$ mk_drawable FlxGui::clear lightgrey;
<span class="lineno" id=line25></span>  
<span class="lineno" id=line26></span>      <span class="comment">// font and label</span>
<span class="lineno" id=line27></span>      <span class="big_keyword" title="Define a mutable variable">var</span> font_name = dflt_sans_serif_font();
<span class="lineno" id=line28></span>      <span class="big_keyword" title="Define a mutable variable">var</span> font : font_t = get_font(font_name, 12);
<span class="lineno" id=line29></span>      <span class="big_keyword" title="Define a mutable variable">var</span> bigfont : font_t = get_font(font_name, 14);
<span class="lineno" id=line30></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lineskip = get_lineskip font;
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>      <span class="comment">// bounding box for graph</span>
<span class="lineno" id=line33></span>      <span class="big_keyword" title="Define a mutable variable">var</span> t = 20;
<span class="lineno" id=line34></span>      <span class="big_keyword" title="Define a mutable variable">var</span> l = 50;
<span class="lineno" id=line35></span>      <span class="big_keyword" title="Define a mutable variable">var</span> b = g.client.h - 90;
<span class="lineno" id=line36></span>      <span class="big_keyword" title="Define a mutable variable">var</span> r = g.client.w - 10;
<span class="lineno" id=line37></span>      w.add$ mk_drawable FlxGui::<span class="library" title="Print a string to a stream">write</span> (l+(r - l)/2,10,bigfont,black,g.title);
<span class="lineno" id=line38></span>  
<span class="lineno" id=line39></span>  
<span class="lineno" id=line40></span>      <span class="big_keyword" title="Define a mutable variable">var</span> c = RGB(0,0,255);
<span class="lineno" id=line41></span>      <span class="big_keyword" title="Define a mutable variable">var</span> c2 = RGB(0,0,0);
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>      <span class="comment">// top</span>
<span class="lineno" id=line44></span>      w.add$ mk_drawable draw_line (c, l - 5,t,r,t);
<span class="lineno" id=line45></span>      w.add$ mk_drawable FlxGui::<span class="library" title="Print a string to a stream">write</span> (l - 40,t,font,black,g.ymax.<span class="library" title="Convert a value to a string">str</span>);
<span class="lineno" id=line46></span>  
<span class="lineno" id=line47></span>      <span class="comment">// bottom</span>
<span class="lineno" id=line48></span>      w.add$ mk_drawable draw_line (c, l - 5,b,r,b);
<span class="lineno" id=line49></span>      w.add$ mk_drawable FlxGui::<span class="library" title="Print a string to a stream">write</span> (l - 40,b,font,black,g.ymin.<span class="library" title="Convert a value to a string">str</span>);
<span class="lineno" id=line50></span>  
<span class="lineno" id=line51></span>      <span class="comment">// left</span>
<span class="lineno" id=line52></span>      w.add$ mk_drawable draw_line (c, l,t,l,b + 5);
<span class="lineno" id=line53></span>      w.add$ mk_drawable FlxGui::<span class="library" title="Print a string to a stream">write</span> (l,b + 15,font,black,g.xmin.<span class="library" title="Convert a value to a string">str</span>);
<span class="lineno" id=line54></span>  
<span class="lineno" id=line55></span>      <span class="comment">// right</span>
<span class="lineno" id=line56></span>      w.add$ mk_drawable draw_line (c, r,t,r,b + 5);
<span class="lineno" id=line57></span>      w.add$ mk_drawable FlxGui::<span class="library" title="Print a string to a stream">write</span> (r - 40,b + 15,font,black,g.xmax.<span class="library" title="Convert a value to a string">str</span>);
<span class="lineno" id=line58></span>  
<span class="lineno" id=line59></span>      <span class="comment">// coordinate transforms</span>
<span class="lineno" id=line60></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> i2x (i:<span class="library" title="binding of C int type">int</span>): <span class="library" title="binding of C double float type">double</span> =&gt;  (i - l).<span class="library" title="binding of C double float type">double</span> / (r - l).<span class="library" title="binding of C double float type">double</span> * (g.xmax - g.xmin) + g.xmin; 
<span class="lineno" id=line61></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> y2j (y:<span class="library" title="binding of C double float type">double</span>) : <span class="library" title="binding of C int type">int</span> =&gt; b-((y - g.ymin)/ (g.ymax - g.ymin) * (b - t).<span class="library" title="binding of C double float type">double</span>).<span class="library" title="binding of C int type">int</span>; 
<span class="lineno" id=line62></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> x2i (x:<span class="library" title="binding of C double float type">double</span>) : <span class="library" title="binding of C int type">int</span> =&gt; ((x - g.xmin) / (g.xmax - g.xmin) * (r - l).<span class="library" title="binding of C double float type">double</span>).<span class="library" title="binding of C int type">int</span> + l;
<span class="lineno" id=line63></span>  
<span class="lineno" id=line64></span>      <span class="comment">// x axis (y=0)</span>
<span class="lineno" id=line65></span>      <span class="big_keyword" title="Define a mutable variable">var</span> jorig = y2j 0.0;
<span class="lineno" id=line66></span>      w.add$ mk_drawable FlxGui::<span class="library" title="Print a string to a stream">write</span> (l - 40,jorig,font,black,<span class="fstring">"0"</span>);
<span class="lineno" id=line67></span>      w.add$ mk_drawable draw_line (blue,l,jorig,r,jorig);
<span class="lineno" id=line68></span>  
<span class="lineno" id=line69></span>      <span class="comment">// y axis (x=0)</span>
<span class="lineno" id=line70></span>      <span class="big_keyword" title="Define a mutable variable">var</span> iorig = x2i 0.0;
<span class="lineno" id=line71></span>      w.add$ mk_drawable draw_line (red,iorig,t,iorig,b+5);
<span class="lineno" id=line72></span>      w.add$ mk_drawable FlxGui::<span class="library" title="Print a string to a stream">write</span> (iorig,b+15,font,black,<span class="fstring">"0"</span>);
<span class="lineno" id=line73></span>  
<span class="lineno" id=line74></span>      w.update();
<span class="lineno" id=line75></span>      w.show();
<span class="lineno" id=line76></span>  
<span class="lineno" id=line77></span>  
<span class="lineno" id=line78></span>      <span class="big_keyword" title="Define a mutable variable">var</span> oldi = -2000;
<span class="lineno" id=line79></span>      <span class="big_keyword" title="Define a mutable variable">var</span> oldj = 0;
<span class="lineno" id=line80></span>      rfor i <span class="small_keyword" title="membership operator, function mem">in</span> l..r <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line81></span>        <span class="big_keyword" title="Define a mutable variable">var</span> x = i2x i;
<span class="lineno" id=line82></span>        <span class="big_keyword" title="Define a mutable variable">var</span> y = g.func x;
<span class="lineno" id=line83></span>        <span class="big_keyword" title="Define a mutable variable">var</span> j = y2j y;
<span class="lineno" id=line84></span>        <span class="comment">//println$ g.title+"(" + x.str + ")=" y.str + ", coord(" + i.str + "," + j.str + ")";</span>
<span class="lineno" id=line85></span>        <span class="big_keyword" title="Define a mutable variable">var</span> data = c2,oldi,oldj,i,j;
<span class="lineno" id=line86></span>        <span class="small_keyword" title="conditional">if</span> oldi != -2000 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line87></span>          w.add$ mk_drawable draw_line data;
<span class="lineno" id=line88></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line89></span>        oldi = i;
<span class="lineno" id=line90></span>        oldj= j;
<span class="lineno" id=line91></span>        w.update();
<span class="lineno" id=line92></span>        sleep(0.01);
<span class="lineno" id=line93></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line94></span>      w.add$ mk_drawable draw_line (c, l,t,r,b);
<span class="lineno" id=line95></span>  
<span class="lineno" id=line96></span>      w.update();
<span class="lineno" id=line97></span>      <span class="big_keyword" title="Define a mutable variable">var</span> wm = window_manager();
<span class="lineno" id=line98></span>      wm.run_with_timeout 15.0;
<span class="lineno" id=line99></span>      FlxGui::quit();
<span class="lineno" id=line100></span>    } <span class="comment">// lilnegraph</span>
<span class="lineno" id=line101></span>  } <span class="comment">// GraphTools</span>
<span class="lineno" id=line102></span>  
<span class="lineno" id=line103></span>  
<span class="lineno" id=line104></span>  
</pre></p></div><!--Main Content Body End-->

          </div> <!-- rightpanel contents end -->
          <hr>
        </span> <!-- rightpanel end -->

        <span id="panemover" style="cursor:col-resize;"
         onmousedown="dragStart(event, 'left', 'right'); return false;"
         onmousemove="drag(event, 'left', 'right');"
         onmouseout="dragRelease();"
         onmouseup="dragRelease();"
        >
        </span> <!-- panemover end -->
      </div> <!-- bottom panel end -->
    </div> <!-- container end -->
</body></html>

