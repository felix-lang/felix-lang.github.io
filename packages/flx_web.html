<html><head>
<style type="text/css">
body {margin:3%; }
h1 {color:gray; font-size:120%;}
h2 {color:gray; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre.flxbg {background-color:#A0FFA0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.uncheckedflxbg {background-color:#D0D0D0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.cppbg {background-color:#80FF80; color:black; }
pre.prefmtbg {background-color:#D0D0D0; color:black; }
pre.expected {background-color:#E0FF80; color:black; }
pre.input {background-color:#E08080; color:black; }
pre.inclusion {background-color:#D070D0; color:black; }
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:#FF8080; color:black; }
</style>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
        skipTags: ["script","noscript","style","textarea"]
    }
  });
</script>
<title>Webserver and Plugins</title></head><body>
<style>
body {margin:3%; font-family: sans-serif; }
h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
h2 {color:#202020; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
pre.cppbg {background-color:#C2FDC2; }
pre.prefmtbg {background-color:#F1F1F1; }
pre.expected {background-color:hsla(74,94%,88%,1); }
pre.input {background-color:hsla(20,94%,88%,1); }
pre.inclusion {
    font-family: Arial;
    font-weight: normal;
    font-size: 0.9em;
    color: #555;
    border: none;
    box-shadow: none;
    text-align: right;
    margin: -7px 11px -12px 0;
    padding: 0;
    background-color:#fafafa;
}
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
.container {
  position: fixed;
  top:0px;
  left:0px;
  height : 100%;
  width: 100%;
  background-color: grey;
  margin: 0px;
  padding: 0px;
  border-width: 0px;
  color: #404040;
}
.maincontent {
  padding:4px;
  padding-left:8px;
  line-height:1.3em;
  color:#404040; background-color:#fafafa;
}
.maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
.maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent code { color:#902030; }
.toppanel {
  position:absolute; left:0px; top:0px; height:20px; right:0px;
  background-color: #e0e0e0;
}
.bottompanel {
  position:absolute; left:0px; top:22px; bottom:0px; right:0px;
  background-color: #fafafa;
  font-size:14px;
}
.leftpanel {
  position:absolute; left:0px; top:0px; bottom:0px; width: 150px;
  background-color: #eaeaea; overflow: auto;
}
.rightpanel {
  position:absolute; right: 0px; left:160px; top:0px; bottom: 0px;
  background-color: #fafafa; overflow: auto;
}
.divider {
  position:absolute; left: 150px; top:0px; bottom:0px;
  background-color: black; width:2px;
  box-shadow: 0 0 8px #000;
}

#panemover {
    position:absolute;
    left: 150px;
    width : 10px;
    top: 0px;
    bottom: 0px;
    opacity: 0.3;
    cursor:col-resize;
}

div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}
</style>

<style>
div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}


</style>

    <script async="true">
      function dragStart(e, left, right){
        document.getElementById("panemover").style.width="70%";
        document.getElementById("panemover").style.left="50px";
        mousedown = true;
        x = e.clientX
        dragOffsetLeft =
          document.getElementById(left).getBoundingClientRect().right -
          document.getElementById(left).getBoundingClientRect().left -
          x
        ;
        dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x;
        dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
      }
      function dragRelease(){
        document.getElementById('panemover').style.width = '10px';
        document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
        mousedown = false;
      }
      function drag(e, left, right){
        if(!mousedown){return}
        x = e.clientX
        tmpLeft = dragOffsetLeft + x
        tmpDivider= dragOffsetDivider + x
        tmpRight = dragOffsetRight + x
        document.getElementById(left).style.width= tmpLeft + 'px';
        document.getElementById("divider").style.left= tmpDivider + 'px';
        document.getElementById(right).style.left = tmpRight + 'px';
      };
    </script>

<script type="text/javascript">

  function mexpand(id)
  {
    var n = document.getElementById(id).style;
    n.display = "block";
  }

  function mcollapse(id)
  {
    var n = document.getElementById(id).style;
    n.display = "none";
  }

  var counter_max = 0;
  function mshow(id,loc)
  {
    var i;
    for(i=1; i<=counter_max; ++i)
      mcollapse("menu"+String(i));
    mexpand(id);
    window.location.replace(loc);
  }
</script>

<script type="text/javascript">

function expand(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/minus.gif";
  button.alt = "-";
  n.display = "block";
}
function collapse(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/plus.gif";
  button.alt = "+";
  n.display = "none";
}
function toggle(button,id)
{
  var n = document.getElementById(id).style;
  if (n.display == "none")
  {
    button.src = "/share/src/web/images/minus.gif";
    button.alt = "-";
    n.display = "block";
  }
  else
  {
    button.src = "/share/src/web/images/plus.gif";
    button.alt = "+";
    n.display = "none";
  }
}
var allbuttons = [
"Webserver",
"Mainline for dynamic loading.",
"Mainline with preloaded plugins.",
"Language Translators.",
"Felix Package Config <code>fpc</code> format.",
"Ocaml",
"Python",
"Felix <code>flx</code> format.",
"C and C++ code.",
"Top level Felix <code>html</code> format.",
"Decorator Interfaces.",
"Decorator Implementations."
];
function expand_all(dummy)
{
  for (i in allbuttons)
  {
    expand(allbuttons[i], allbuttons[i]+"_d");
  }
}
function collapse_all(dummy)
{
  for (i in allbuttons)
  {
    collapse(allbuttons[i], allbuttons[i]+"_d");
  }
}
</script>

<script>
function mouseover(id)
{
  var elt = document.getElementById(id);
  elt.style.display="none";
  var elt2 = document.getElementById(id+"_mo");
  elt2.style.display="inline";
}

function mouseout(id)
{
  var elt = document.getElementById(id+"_mo");
  elt.style.display="none";
  var elt2 = document.getElementById(id);
  elt2.style.display="inline";
}

</script>
<script> function nop(dummy) {} </script>
    <div class="container">
      <div class="toppanel">
    <!--Main Content top navbar-->
<span style="position:relative; bottom:6px"
  onmouseover="mouseover('expand')"
  onmouseout="mouseout('expand')"
  onclick="expand_all('expand')"
  ><span id="expand"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span><span id="expand_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span></span><span style="position:relative; bottom:6px"
  onmouseover="mouseover('collapse')"
  onmouseout="mouseout('collapse')"
  onclick="collapse_all('collapse')"
  ><span id="collapse"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span><span id="collapse_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span></span>    <!--Main Content top navbar End-->

      </div> <!-- toppanel end -->
      <div class="bottompanel">
        <span id="divider" class="divider"></span>

        <span id="left" class="leftpanel" >
          <div class="menucontent">
  <!--Left Margin Toc-->
  <div id="leftmargintoc">
    <!--Left Margin Toc Main Contents-->
      <div class=m1 onclick="mshow('menu1','#Webserver_h')"> <a href="#Webserver_h">Webserver</a></div>
      <div class=sm id=menu1>
      <div class=m2><a href="#Mainline_for_dynamic_loading._h">Mainline for dynamic loading.</a></div>
      <div class=m2><a href="#Mainline_with_preloaded_plugins._h">Mainline with preloaded plugins.</a></div>
      </div>
      <div class=m1 onclick="mshow('menu2','#Language Translators._h')"> <a href="#Language_Translators._h">Language Translators.</a></div>
      <div class=sm id=menu2>
      <div class=m2><a href="#Felix_Package_Config_<code>fpc</code>_format._h">Felix Package Config <code>fpc</code> format.</a></div>
      <div class=m2><a href="#Ocaml_h">Ocaml</a></div>
      <div class=m2><a href="#Python_h">Python</a></div>
      <div class=m2><a href="#Felix_<code>flx</code>_format._h">Felix <code>flx</code> format.</a></div>
      <div class=m2><a href="#C_and_C++_code._h">C and C++ code.</a></div>
      <div class=m2><a href="#Top_level_Felix_<code>html</code>_format._h">Top level Felix <code>html</code> format.</a></div>
      </div>
      <div class=m1 onclick="mshow('menu3','#Decorator Interfaces._h')"> <a href="#Decorator_Interfaces._h">Decorator Interfaces.</a></div>
      <div class=sm id=menu3>
      </div>
      <div class=m1 onclick="mshow('menu4','#Decorator Implementations._h')"> <a href="#Decorator_Implementations._h">Decorator Implementations.</a></div>
      <div class=sm id=menu4>
      </div>
    <script>counter_max=4;</script>
  </div>
  <!--End Left Margin Toc-->

          </div> <!-- leftpanel contents end -->
        </span> <!-- leftpanel end -->

        <span id="right" class="rightpanel">
          <div class="maincontent">
<!--Main Content Body-->
<h1 id='Webserver_h'><img src='/share/src/web/images/minus.gif' id='Webserver' onclick='toggle(this,"Webserver_d")' alt='+'/> 1 Webserver</h1><div id='Webserver_d' style='display:block'>
<p>Standalone pretty printer for Felix <code>flx</code> format files.
</p><pre class='inclusion'>
$PWD/src/tools/flx_pretty.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// pretty printer for *.flx files</span>
<span class="lineno" id=line2></span>  <span class="comment">// uses the flx2html plugin</span>
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  <span class="comment">// COPIED from dflx_web .. </span>
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Define a type class">class</span> Css4Html {
<span class="lineno" id=line6></span>  flx_head := <span class="fstring">"""
<span class="lineno" id=line7></span>  &lt;style type="text/css"&gt;
<span class="lineno" id=line8></span>  body {margin:3%; }
<span class="lineno" id=line9></span>  h1 {color:gray; font-size:120%;}
<span class="lineno" id=line10></span>  h2 {color:gray; font-size:105%;}
<span class="lineno" id=line11></span>  h3 {font-size:100%;}
<span class="lineno" id=line12></span>  h4 {font-size:95%;}
<span class="lineno" id=line13></span>  h5 {font-size:95%;}
<span class="lineno" id=line14></span>  span.fstring {color:darkblue; font-style:italic; }
<span class="lineno" id=line15></span>  span.comment {font-family:arial; color:blue; font-style:italic; }
<span class="lineno" id=line16></span>  span.doccomment {font-family:arial; color:green; font-style:italic; }
<span class="lineno" id=line17></span>  span.big_keyword {color:#FF1010; }
<span class="lineno" id=line18></span>  span.small_keyword {color:#802040; }
<span class="lineno" id=line19></span>  span.qualifier {color:#A02020; }
<span class="lineno" id=line20></span>  span.library {color:#A02000; }
<span class="lineno" id=line21></span>  span.ctor {color:#406020; }
<span class="lineno" id=line22></span>  span.hack {color:#66DD00; }
<span class="lineno" id=line23></span>  span.preproc {color:#005500; }
<span class="lineno" id=line24></span>  span.embedded_c{background-color:#DDDDDD; }
<span class="lineno" id=line25></span>  span.fpc_fieldname {color:#DD0000; }
<span class="lineno" id=line26></span>  span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
<span class="lineno" id=line27></span>  pre.flxbg {background-color:#A0FFA0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
<span class="lineno" id=line28></span>  pre.uncheckedflxbg {background-color:#D0D0D0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
<span class="lineno" id=line29></span>  pre.cppbg {background-color:#80FF80; color:black; }
<span class="lineno" id=line30></span>  pre.prefmtbg {background-color:#D0D0D0; color:black; }
<span class="lineno" id=line31></span>  pre.expected {background-color:#E0FF80; color:black; }
<span class="lineno" id=line32></span>  pre.input {background-color:#E08080; color:black; }
<span class="lineno" id=line33></span>  pre.inclusion {background-color:#D070D0; color:black; }
<span class="lineno" id=line34></span>  code.inclusion {background-color:#D070D0; color:black; }
<span class="lineno" id=line35></span>  .obsolete { background-color:#FFEFEF; font-size: small; color:black; }
<span class="lineno" id=line36></span>  .future { background-color:#FF8080; font-size: small; color:black; }
<span class="lineno" id=line37></span>  .implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
<span class="lineno" id=line38></span>  .bug { background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line39></span>  .fixed{ background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line40></span>  .done { background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line41></span>  .caveat { background-color:#FF8080; color:black; }
<span class="lineno" id=line42></span>  &lt;/style&gt;
<span class="lineno" id=line43></span>  """</span>;
<span class="lineno" id=line44></span>  }
<span class="lineno" id=line45></span>  mathjax := <span class="fstring">'''
<span class="lineno" id=line46></span>  &lt;script type="text/javascript" async
<span class="lineno" id=line47></span>    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"&gt;
<span class="lineno" id=line48></span>  &lt;/script&gt;
<span class="lineno" id=line49></span>  &lt;script type="text/x-mathjax-config"&gt;
<span class="lineno" id=line50></span>    MathJax.Hub.Config({
<span class="lineno" id=line51></span>      tex2jax: {
<span class="lineno" id=line52></span>          skipTags: ["script","noscript","style","textarea"]
<span class="lineno" id=line53></span>      }
<span class="lineno" id=line54></span>    });
<span class="lineno" id=line55></span>  &lt;/script&gt;
<span class="lineno" id=line56></span>  '''</span>;
<span class="lineno" id=line57></span>  
<span class="lineno" id=line58></span>  
<span class="lineno" id=line59></span>  <span class="big_keyword" title="Define a mutable variable">var</span> xlat_felix: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; bool * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line60></span>  
<span class="lineno" id=line61></span>  xlat_felix = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line62></span>    dll-name=<span class="fstring">"flx2html"</span>, setup-str=<span class="fstring">""</span>, entry-point=<span class="fstring">"flx2html"</span>
<span class="lineno" id=line63></span>  );
<span class="lineno" id=line64></span>  
<span class="lineno" id=line65></span>  <span class="big_keyword" title="define an object interface">interface</span> html_t {
<span class="lineno" id=line66></span>    whatami : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line67></span>    html_raw : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line68></span>    html_page : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line69></span>    html_title: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line70></span>    mathjax_required: 1 -&gt; bool;
<span class="lineno" id=line71></span>  }
<span class="lineno" id=line72></span>  
<span class="lineno" id=line73></span>  
<span class="lineno" id=line74></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  xlat_html = Dynlink::load-plugin-func2 [html_t, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line75></span>      dll-name=<span class="fstring">"html2html"</span>, setup-str=<span class="fstring">""</span>, entry-point=<span class="fstring">"html2html"</span>
<span class="lineno" id=line76></span>    );
<span class="lineno" id=line77></span>  
<span class="lineno" id=line78></span>  
<span class="lineno" id=line79></span>  
<span class="lineno" id=line80></span>  <span class="big_keyword" title="Define a mutable variable">var</span> filename = System::argv 1;
<span class="lineno" id=line81></span>  <span class="small_keyword" title="conditional">if</span> filename == <span class="fstring">"--style"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line82></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ Css4Html::flx_head;
<span class="lineno" id=line83></span>  <span class="small_keyword" title="conditional">elif</span> filename == <span class="fstring">"--mathjax"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line84></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ mathjax;
<span class="lineno" id=line85></span>  <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line86></span>    <span class="small_keyword" title="conditional">if</span> startswith filename <span class="fstring">"--outdir="</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line87></span>      <span class="big_keyword" title="Define a mutable variable">var</span> outdir = filename.[9 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line88></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Outdir is "</span> + outdir;
<span class="lineno" id=line89></span>      <span class="hack">C_hack</span>::ignore(Directory::mkdir outdir);
<span class="lineno" id=line90></span>      filename = System::argv 2;
<span class="lineno" id=line91></span>      <span class="big_keyword" title="Define a mutable variable">var</span> outfile = Filename::join 
<span class="lineno" id=line92></span>      (
<span class="lineno" id=line93></span>        outdir, 
<span class="lineno" id=line94></span>        Filename::strip_extension (Filename::basename filename)
<span class="lineno" id=line95></span>      ) + <span class="fstring">".html"</span>;
<span class="lineno" id=line96></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line97></span>      outfile = Filename::strip_extension filename + <span class="fstring">".html"</span>;
<span class="lineno" id=line98></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line99></span>    eprintln$ <span class="fstring">"Formatting file "</span> + filename;
<span class="lineno" id=line100></span>    eprintln$ <span class="fstring">"Outfile is "</span> + outfile;
<span class="lineno" id=line101></span>    <span class="big_keyword" title="Define a mutable variable">var</span> b = load filename;
<span class="lineno" id=line102></span>    <span class="small_keyword" title="match statement or expression">match</span> Filename::get_extension filename <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line103></span>    | <span class="fstring">".flx"</span> =&gt; 
<span class="lineno" id=line104></span>      def <span class="big_keyword" title="Define a mutable variable">var</span> needs_mathjax', <span class="big_keyword" title="Define a mutable variable">var</span> txt = xlat_felix (b,<span class="fstring">""</span>);
<span class="lineno" id=line105></span>      save (outfile, <span class="fstring">"&lt;pre class='flxbg'&gt;\n"</span>+txt+<span class="fstring">"\n&lt;/pre&gt;"</span>)
<span class="lineno" id=line106></span>  ;
<span class="lineno" id=line107></span>    | <span class="fstring">".html"</span> =&gt;
<span class="lineno" id=line108></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = xlat_html (b, filename);
<span class="lineno" id=line109></span>      <span class="big_keyword" title="Define a mutable variable">var</span> needs_mathjax = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.mathjax_required);
<span class="lineno" id=line110></span>      <span class="big_keyword" title="Define a mutable variable">var</span> html = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.html_page);
<span class="lineno" id=line111></span>      <span class="big_keyword" title="Define a mutable variable">var</span> title = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.html_title);
<span class="lineno" id=line112></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = 
<span class="lineno" id=line113></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+Css4Html::flx_head+
<span class="lineno" id=line114></span>        <span class="small_keyword" title="conditional">if</span> needs_mathjax <span class="small_keyword" title="conditional">then</span> mathjax <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line115></span>        <span class="small_keyword" title="conditional">if</span> title != <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">"&lt;title&gt;"</span>+title+<span class="fstring">"&lt;/title&gt;"</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line116></span>        <span class="fstring">"&lt;/head&gt;&lt;body&gt;"</span>+
<span class="lineno" id=line117></span>        html+
<span class="lineno" id=line118></span>        <span class="fstring">"&lt;/body&gt;&lt;/html&gt;\n\r"</span>
<span class="lineno" id=line119></span>      ;
<span class="lineno" id=line120></span>      save(outfile,data+<span class="fstring">"\n"</span>);
<span class="lineno" id=line121></span>    | _ =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"NO FILE"</span>;
<span class="lineno" id=line122></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line123></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line124></span>  
</pre></p><h2 id='Mainline_for_dynamic_loading._h'><img src='/share/src/web/images/minus.gif' id='Mainline for dynamic loading.' onclick='toggle(this,"Mainline_for_dynamic_loading._d")' alt='+'/> 1.1 Mainline for dynamic loading.</h2><div id='Mainline_for_dynamic_loading._d' style='display:block'>
<p>This is the actual webserver code.
</p><pre class='inclusion'>
$PWD/src/tools/dflx_web.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="small_keyword" title="conditional">if</span> PLAT_POSIX <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line2></span>  PosixSignal::ignore_signal(PosixSignal::SIGPIPE);
<span class="lineno" id=line3></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Define a type class">class</span> Css4Html {
<span class="lineno" id=line8></span>  flx_head := <span class="fstring">"""
<span class="lineno" id=line9></span>  &lt;style type="text/css"&gt;
<span class="lineno" id=line10></span>  body {margin:3%; font-family: sans-serif; }
<span class="lineno" id=line11></span>  h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
<span class="lineno" id=line12></span>  h2 {color:#202020; font-size:105%;}
<span class="lineno" id=line13></span>  h3 {font-size:100%;}
<span class="lineno" id=line14></span>  h4 {font-size:95%;}
<span class="lineno" id=line15></span>  h5 {font-size:95%;}
<span class="lineno" id=line16></span>  span.fstring {color:darkblue; font-style:italic; }
<span class="lineno" id=line17></span>  span.comment {font-family:arial; color:blue; font-style:italic; }
<span class="lineno" id=line18></span>  span.doccomment {font-family:arial; color:green; font-style:italic; }
<span class="lineno" id=line19></span>  span.big_keyword {color:#FF1010; }
<span class="lineno" id=line20></span>  span.small_keyword {color:#802040; }
<span class="lineno" id=line21></span>  span.qualifier {color:#A02020; }
<span class="lineno" id=line22></span>  span.library {color:#A02000; }
<span class="lineno" id=line23></span>  span.ctor {color:#406020; }
<span class="lineno" id=line24></span>  span.hack {color:#66DD00; }
<span class="lineno" id=line25></span>  span.preproc {color:#005500; }
<span class="lineno" id=line26></span>  span.embedded_c{background-color:#DDDDDD; }
<span class="lineno" id=line27></span>  span.fpc_fieldname {color:#DD0000; }
<span class="lineno" id=line28></span>  span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
<span class="lineno" id=line29></span>  pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
<span class="lineno" id=line30></span>  pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
<span class="lineno" id=line31></span>  pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
<span class="lineno" id=line32></span>  pre.cppbg {background-color:#C2FDC2; }
<span class="lineno" id=line33></span>  pre.prefmtbg {background-color:#F1F1F1; }
<span class="lineno" id=line34></span>  pre.expected {background-color:hsla(74,94%,88%,1); }
<span class="lineno" id=line35></span>  pre.input {background-color:hsla(20,94%,88%,1); }
<span class="lineno" id=line36></span>  pre.inclusion {
<span class="lineno" id=line37></span>      font-family: Arial;
<span class="lineno" id=line38></span>      font-weight: normal;
<span class="lineno" id=line39></span>      font-size: 0.9em;
<span class="lineno" id=line40></span>      color: #555;
<span class="lineno" id=line41></span>      border: none;
<span class="lineno" id=line42></span>      box-shadow: none;
<span class="lineno" id=line43></span>      text-align: right;
<span class="lineno" id=line44></span>      margin: -7px 11px -12px 0;
<span class="lineno" id=line45></span>      padding: 0;
<span class="lineno" id=line46></span>      background-color:#fafafa;
<span class="lineno" id=line47></span>  }
<span class="lineno" id=line48></span>  code.inclusion {background-color:#D070D0; color:black; }
<span class="lineno" id=line49></span>  .obsolete { background-color:#FFEFEF; font-size: small; color:black; }
<span class="lineno" id=line50></span>  .future { background-color:#FF8080; font-size: small; color:black; }
<span class="lineno" id=line51></span>  .implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
<span class="lineno" id=line52></span>  .bug { background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line53></span>  .fixed{ background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line54></span>  .done { background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line55></span>  .caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
<span class="lineno" id=line56></span>  &lt;/style&gt;
<span class="lineno" id=line57></span>  """</span>;
<span class="lineno" id=line58></span>  }
<span class="lineno" id=line59></span>  
<span class="lineno" id=line60></span>  <span class="big_keyword" title="Open a module or class">open</span> Socket;
<span class="lineno" id=line61></span>  <span class="big_keyword" title="Open a module or class">open</span> IOStream;
<span class="lineno" id=line62></span>  
<span class="lineno" id=line63></span>  <span class="big_keyword" title="Open a module or class">open</span> TerminalIByteStream[fd_t];
<span class="lineno" id=line64></span>  <span class="big_keyword" title="Open a module or class">open</span> TerminalIOByteStream[socket_t];
<span class="lineno" id=line65></span>  
<span class="lineno" id=line66></span>  <span class="comment">// this is a hack to make close work on a listener</span>
<span class="lineno" id=line67></span>  <span class="comment">// RF got this right the first time:</span>
<span class="lineno" id=line68></span>  <span class="comment">// in the abstract a listener is NOT a socket</span>
<span class="lineno" id=line69></span>  <span class="comment">// In fact, it is a socket server, with accept() a way to</span>
<span class="lineno" id=line70></span>  <span class="comment">// read new sockets off it ..</span>
<span class="lineno" id=line71></span>  <span class="big_keyword" title="Open a module or class">open</span> TerminalIByteStream[socket_t];
<span class="lineno" id=line72></span>  
<span class="lineno" id=line73></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/http_response"</span>;
<span class="lineno" id=line74></span>  <span class="big_keyword" title="Open a module or class">open</span> HTTPResponse;
<span class="lineno" id=line75></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"web/mime_type"</span>;
<span class="lineno" id=line76></span>  
<span class="lineno" id=line77></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"plugins/plugin_common"</span>;
<span class="lineno" id=line78></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"plugins/html-interface"</span>;
<span class="lineno" id=line79></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"plugins/edit-interface"</span>;
<span class="lineno" id=line80></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"plugins/toc_menu-interface"</span>;
<span class="lineno" id=line81></span>  
<span class="lineno" id=line82></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> dbg(x:<span class="library" title="binding of C++ string type">string</span>) { fprint (cstderr,x); };
<span class="lineno" id=line83></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (x:<span class="library" title="binding of C++ string type">string</span>, y:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (x,y);
<span class="lineno" id=line84></span>  
<span class="lineno" id=line85></span>  <span class="big_keyword" title="specify requirements">requires</span> <span class="big_keyword" title="Specify C code to be inserted into header file">header</span> '<span class="embedded_c">#<span class="preproc">include</span> <span class="fstring">&lt;stdlib.h&gt;</span></span>';
<span class="lineno" id=line86></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> strtod: <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C double float type">double</span> = <span class="fstring">"strtod($1.data(),0)"</span>;
<span class="lineno" id=line87></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> atoi: <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C int type">int</span> = <span class="fstring">"atoi($1.data())"</span>;
<span class="lineno" id=line88></span>  
<span class="lineno" id=line89></span>  <span class="comment">// command line argument processing</span>
<span class="lineno" id=line90></span>  
<span class="lineno" id=line91></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line92></span>  <span class="comment">// Setup the fixed defaults.</span>
<span class="lineno" id=line93></span>  <span class="big_keyword" title="Define a mutable variable">var</span> arg = <span class="fstring">""</span>;
<span class="lineno" id=line94></span>  <span class="big_keyword" title="Define a mutable variable">var</span> argno = 1;
<span class="lineno" id=line95></span>  <span class="big_keyword" title="Define a mutable variable">var</span> SHARE = #Config::std_config.FLX_SHARE_DIR;
<span class="lineno" id=line96></span>  <span class="big_keyword" title="Define a mutable variable">var</span> TARGET = #Config::std_config.FLX_TARGET_DIR;
<span class="lineno" id=line97></span>  <span class="big_keyword" title="Define a mutable variable">var</span> INSTALL_ROOT = SHARE.[<span class="small_keyword" title="substring range separator">to</span> -6]; <span class="comment">// cut off the /share suffix</span>
<span class="lineno" id=line98></span>   
<span class="lineno" id=line99></span>  <span class="big_keyword" title="Define a mutable variable">var</span> DELAY = 0.1;
<span class="lineno" id=line100></span>  <span class="big_keyword" title="Define a mutable variable">var</span> PORT=1234;
<span class="lineno" id=line101></span>  
<span class="lineno" id=line102></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PATH=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line103></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FDOC_PATH=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line104></span>  
<span class="lineno" id=line105></span>  <span class="big_keyword" title="Define a mutable variable">var</span> C_PATH=<span class="library" title="functional, singly linked list">list</span>(
<span class="lineno" id=line106></span>    <span class="fstring">"/usr/local/include"</span>,
<span class="lineno" id=line107></span>    <span class="fstring">"/usr/include"</span>
<span class="lineno" id=line108></span>  );
<span class="lineno" id=line109></span>  
<span class="lineno" id=line110></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PKGCONFIG_PATH=Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line111></span>  
<span class="lineno" id=line112></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_WEBSERVER_PLUGIN_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line113></span>  <span class="big_keyword" title="Define a mutable variable">var</span> PLUGIN_MAP = Empty[<span class="library" title="binding of C++ string type">string</span>^3];
<span class="lineno" id=line114></span>  
<span class="lineno" id=line115></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line116></span>  <span class="comment">// Set the hard coded default config.</span>
<span class="lineno" id=line117></span>  <span class="comment">// This sucks totally, its just a hack based on my</span>
<span class="lineno" id=line118></span>  <span class="comment">// local requirements. And even that screws up by</span>
<span class="lineno" id=line119></span>  <span class="comment">// confusing multiple gcc installs and clang installs.</span>
<span class="lineno" id=line120></span>  
<span class="lineno" id=line121></span>  <span class="big_keyword" title="Define a mutable variable">var</span> default_config = <span class="library" title="functional, singly linked list">list</span> (
<span class="lineno" id=line122></span>    <span class="fstring">"C_PATH += /usr/include/c++/4.2.1"</span>, 
<span class="lineno" id=line123></span>    <span class="fstring">"C_PATH += /usr/include/c++/4.2.1/x86_64-apple-darwin10"</span>, 
<span class="lineno" id=line124></span>  
<span class="lineno" id=line125></span>    <span class="fstring">"C_PATH += /usr/include/c++/4.6"</span>, 
<span class="lineno" id=line126></span>    <span class="fstring">"C_PATH += /usr/include/c++/4.6.3"</span>, 
<span class="lineno" id=line127></span>    <span class="fstring">"C_PATH += /usr/lib/gcc/x86_64-linux-gnu/4.6.3/include"</span>,
<span class="lineno" id=line128></span>     <span class="fstring">""</span>
<span class="lineno" id=line129></span>  );
<span class="lineno" id=line130></span>  
<span class="lineno" id=line131></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line132></span>  <span class="comment">// Now find the users HOME directory.</span>
<span class="lineno" id=line133></span>  <span class="comment">// Try to get the config string from there.</span>
<span class="lineno" id=line134></span>  <span class="big_keyword" title="Define a mutable variable">var</span> HOME: <span class="library" title="binding of C++ string type">string</span> = Env::getenv <span class="fstring">"HOME"</span>;
<span class="lineno" id=line135></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Home="</span> + HOME;
<span class="lineno" id=line136></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_HOME : <span class="library" title="binding of C++ string type">string</span>= Filename::join (HOME, <span class="fstring">".felix"</span>);
<span class="lineno" id=line137></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FlxHome="</span> + FLX_HOME;
<span class="lineno" id=line138></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_CONFIG : <span class="library" title="binding of C++ string type">string</span>= Filename::join (FLX_HOME,<span class="fstring">"webserver.config"</span>);
<span class="lineno" id=line139></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Flxconfig="</span> + FLX_CONFIG;
<span class="lineno" id=line140></span>  <span class="big_keyword" title="Define a mutable variable">var</span> config_data = load(FLX_CONFIG);
<span class="lineno" id=line141></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"loaded webserver config data = "</span> + config_data;
<span class="lineno" id=line142></span>  <span class="big_keyword" title="Define a mutable variable">var</span> config_lines = split(config_data, <span class="fstring">"\n"</span>);
<span class="lineno" id=line143></span>  
<span class="lineno" id=line144></span>  
<span class="lineno" id=line145></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line146></span>  <span class="comment">// If we couldn't get the webserver config string</span>
<span class="lineno" id=line147></span>  <span class="comment">// from the HOME directory, use the fixed default.</span>
<span class="lineno" id=line148></span>  <span class="small_keyword" title="conditional">if</span> <span class="library" title="number of elements in data structure">len</span> config_data == 0.<span class="library" title="binding of C size_t type">size</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line149></span>    <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Using default config"</span>;
<span class="lineno" id=line150></span>    config_lines = default_config;
<span class="lineno" id=line151></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line152></span>  
<span class="lineno" id=line153></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line154></span>  <span class="comment">// Parse the config string.</span>
<span class="lineno" id=line155></span>  config_lines = <span class="library" title="return data structure with function applied to each value">map</span> (strip of (<span class="library" title="binding of C++ string type">string</span>)) config_lines; 
<span class="lineno" id=line156></span>  <span class="big_keyword" title="Define a mutable variable">var</span> pathext = RE2(<span class="fstring">"(.*)\\+=(.*)"</span>);
<span class="lineno" id=line157></span>  <span class="big_keyword" title="Define a mutable variable">var</span> varset = RE2(<span class="fstring">"(.*)=(.*)"</span>);
<span class="lineno" id=line158></span>  
<span class="lineno" id=line159></span>  <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (4.<span class="library" title="binding of C size_t type">size</span>,StringPiece(<span class="fstring">""</span>));
<span class="lineno" id=line160></span>  <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> config_lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line161></span>    <span class="big_keyword" title="Define a mutable variable">var</span> match_result = Match(pathext, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line162></span>    <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line163></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line164></span>      <span class="big_keyword" title="Define a mutable variable">var</span> rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line165></span>      <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line166></span>      | <span class="fstring">"C_PATH"</span> =&gt; C_PATH += rhs;
<span class="lineno" id=line167></span>      | <span class="fstring">"FLX_PATH"</span> =&gt; FLX_PATH += rhs; 
<span class="lineno" id=line168></span>      | <span class="fstring">"FLX_PKGCONFIG_PATH"</span> =&gt; FLX_PKGCONFIG_PATH += rhs;
<span class="lineno" id=line169></span>      | <span class="fstring">"FLX_WEBSERVER_PLUGIN_PATH"</span> =&gt; FLX_WEBSERVER_PLUGIN_PATH += rhs;
<span class="lineno" id=line170></span>      | <span class="fstring">"FDOC_PATH"</span> =&gt; FDOC_PATH += rhs;
<span class="lineno" id=line171></span>      | _ =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unknown variable '"</span> + lhs +<span class="fstring">"'"</span>;
<span class="lineno" id=line172></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line173></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line174></span>    match_result = Match(varset, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line175></span>    <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line176></span>      lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line177></span>      rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line178></span>      <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line179></span>      | <span class="fstring">"PORT"</span> =&gt; PORT = atoi rhs;
<span class="lineno" id=line180></span>      | <span class="fstring">"INSTALL_ROOT"</span> =&gt; INSTALL_ROOT = rhs;
<span class="lineno" id=line181></span>      | _ =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unknown variable '"</span> + lhs +<span class="fstring">"'"</span>;
<span class="lineno" id=line182></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line183></span>    <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line184></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line185></span>  
<span class="lineno" id=line186></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line187></span>  <span class="comment">// Process command line options.</span>
<span class="lineno" id=line188></span>  <span class="comment">// These can reset the INSTALL_ROOT</span>
<span class="lineno" id=line189></span>  <span class="comment">// or augment the C_PATH.</span>
<span class="lineno" id=line190></span>  <span class="small_keyword" title="while loop">while</span> argno&lt;System::argc <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line191></span>    arg = System::argv argno;
<span class="lineno" id=line192></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"ARG="</span> + arg;
<span class="lineno" id=line193></span>    <span class="small_keyword" title="conditional">if</span> prefix(arg,<span class="fstring">"--root="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line194></span>      INSTALL_ROOT=arg.[7 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line195></span>      SHARE = INSTALL_ROOT/<span class="fstring">"share"</span>;
<span class="lineno" id=line196></span>      TARGET = INSTALL_ROOT/<span class="fstring">"host"</span>;
<span class="lineno" id=line197></span>  
<span class="lineno" id=line198></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--close-delay="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line199></span>      DELAY=strtod arg.[14 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line200></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--port="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line201></span>      PORT=atoi arg.[7 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line202></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--cpath="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line203></span>      C_PATH+=arg.[8 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line204></span>    <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--plugin-path="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line205></span>      FLX_WEBSERVER_PLUGIN_PATH+=arg.[14 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line206></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line207></span>    ++argno;
<span class="lineno" id=line208></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line209></span>  
<span class="lineno" id=line210></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line211></span>  <span class="comment">// Now, use the INSTALL_ROOT to augment</span>
<span class="lineno" id=line212></span>  <span class="comment">// the search paths.</span>
<span class="lineno" id=line213></span>  C_PATH+= TARGET+<span class="fstring">"/lib/rtl"</span>;
<span class="lineno" id=line214></span>  C_PATH+= INSTALL_ROOT+<span class="fstring">"/share/lib/rtl"</span>;
<span class="lineno" id=line215></span>  FLX_PATH+=INSTALL_ROOT+<span class="fstring">"/share/lib"</span>;
<span class="lineno" id=line216></span>  FLX_PATH+= TARGET+<span class="fstring">"/lib"</span>;
<span class="lineno" id=line217></span>  FDOC_PATH+=INSTALL_ROOT;
<span class="lineno" id=line218></span>  FLX_PKGCONFIG_PATH+= TARGET+<span class="fstring">"/config"</span>;
<span class="lineno" id=line219></span>  FLX_WEBSERVER_PLUGIN_PATH+= TARGET+<span class="fstring">"/lib"</span>;
<span class="lineno" id=line220></span>  
<span class="lineno" id=line221></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line222></span>  <span class="comment">// Print the configuation.</span>
<span class="lineno" id=line223></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"INSTALL_ROOT="</span>+INSTALL_ROOT;
<span class="lineno" id=line224></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_PATH="</span>+<span class="library" title="Convert a value to a string">str</span> FLX_PATH;
<span class="lineno" id=line225></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"C_PATH="</span>+<span class="library" title="Convert a value to a string">str</span> C_PATH;
<span class="lineno" id=line226></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_PKGCONFIG_PATH="</span>+<span class="library" title="Convert a value to a string">str</span> FLX_PKGCONFIG_PATH;
<span class="lineno" id=line227></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_WEBSERVER_PLUGIN_PATH="</span>+<span class="library" title="Convert a value to a string">str</span> FLX_WEBSERVER_PLUGIN_PATH;
<span class="lineno" id=line228></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FDOC_PATH="</span>+<span class="library" title="Convert a value to a string">str</span> FDOC_PATH;
<span class="lineno" id=line229></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"DELAY="</span>+<span class="library" title="Convert a value to a string">str</span> DELAY;
<span class="lineno" id=line230></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"PORT="</span>+<span class="library" title="Convert a value to a string">str</span> PORT;
<span class="lineno" id=line231></span>  
<span class="lineno" id=line232></span>  
<span class="lineno" id=line233></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line234></span>  <span class="comment">// Build consolidated configuration string</span>
<span class="lineno" id=line235></span>  <span class="comment">// for plugins.</span>
<span class="lineno" id=line236></span>  
<span class="lineno" id=line237></span>  <span class="big_keyword" title="Define an immutable value">val</span> newline=<span class="fstring">"\n"</span>;
<span class="lineno" id=line238></span>  
<span class="lineno" id=line239></span>  <span class="big_keyword" title="Define a mutable variable">var</span> config = <span class="fstring">"INSTALL_ROOT = "</span> + INSTALL_ROOT + newline;
<span class="lineno" id=line240></span>  <span class="small_keyword" title="for loop">for</span> d <span class="small_keyword" title="membership operator, function mem">in</span> FLX_PATH <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line241></span>    config += <span class="fstring">"FLX_PATH += "</span> + d + newline;
<span class="lineno" id=line242></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line243></span>  
<span class="lineno" id=line244></span>  <span class="small_keyword" title="for loop">for</span> d <span class="small_keyword" title="membership operator, function mem">in</span> C_PATH <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line245></span>    config += <span class="fstring">"C_PATH += "</span> + d + newline;
<span class="lineno" id=line246></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line247></span>  
<span class="lineno" id=line248></span>  <span class="small_keyword" title="for loop">for</span> d <span class="small_keyword" title="membership operator, function mem">in</span> FDOC_PATH <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line249></span>    config += <span class="fstring">"FDOC_PATH += "</span> + d + newline;
<span class="lineno" id=line250></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line251></span>  
<span class="lineno" id=line252></span>  <span class="small_keyword" title="for loop">for</span> d <span class="small_keyword" title="membership operator, function mem">in</span> FLX_PKGCONFIG_PATH <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line253></span>    config += <span class="fstring">"FLX_PKGCONFIG_PATH += "</span> + d + newline;
<span class="lineno" id=line254></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line255></span>  
<span class="lineno" id=line256></span>  <span class="small_keyword" title="for loop">for</span> d <span class="small_keyword" title="membership operator, function mem">in</span> FLX_WEBSERVER_PLUGIN_PATH <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line257></span>    config += <span class="fstring">"FLX_WEBSERVER_PLUGIN_PATH += "</span> + d + newline;
<span class="lineno" id=line258></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line259></span>  
<span class="lineno" id=line260></span>  <span class="library" title="Print a string to standard output">print</span>$ <span class="fstring">"CONSOLIDATED CONFIG:\n"</span> + config;
<span class="lineno" id=line261></span>  
<span class="lineno" id=line262></span>  <span class="comment">// -------------------------------------------------------------------------</span>
<span class="lineno" id=line263></span>  <span class="comment">// Now load the plugins.</span>
<span class="lineno" id=line264></span>  
<span class="lineno" id=line265></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  xlat_felix = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line266></span>      dll-name=<span class="fstring">"flx2html"</span>, setup-str=config, entry-point=<span class="fstring">"flx2html"</span>
<span class="lineno" id=line267></span>    );
<span class="lineno" id=line268></span>  
<span class="lineno" id=line269></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  xlat_html = Dynlink::load-plugin-func2 [html_t, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line270></span>      dll-name=<span class="fstring">"html2html"</span>, setup-str=config, entry-point=<span class="fstring">"html2html"</span>
<span class="lineno" id=line271></span>    );
<span class="lineno" id=line272></span>  
<span class="lineno" id=line273></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  xlat_fpc = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line274></span>      dll-name=<span class="fstring">"fpc2html"</span>, setup-str=config, entry-point=<span class="fstring">"fpc2html"</span>
<span class="lineno" id=line275></span>    );
<span class="lineno" id=line276></span>  
<span class="lineno" id=line277></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  xlat_py = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line278></span>      dll-name=<span class="fstring">"py2html"</span>, setup-str=config, entry-point=<span class="fstring">"py2html"</span>
<span class="lineno" id=line279></span>    );
<span class="lineno" id=line280></span>  
<span class="lineno" id=line281></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  xlat_ocaml = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line282></span>      dll-name=<span class="fstring">"ocaml2html"</span>, setup-str=config, entry-point=<span class="fstring">"ocaml2html"</span>
<span class="lineno" id=line283></span>    );
<span class="lineno" id=line284></span>  
<span class="lineno" id=line285></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  xlat_cpp = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line286></span>      dll-name=<span class="fstring">"cpp2html"</span>, setup-str=config, entry-point=<span class="fstring">"cpp2html"</span>
<span class="lineno" id=line287></span>    );
<span class="lineno" id=line288></span>  
<span class="lineno" id=line289></span>  <span class="big_keyword" title="Define a mutable variable">var</span> editor_maker = Dynlink::load-plugin-func1 [edit-interface_t, 1] (
<span class="lineno" id=line290></span>    dll-name=<span class="fstring">"html_edit"</span>, setup-str=config, entry-point=<span class="fstring">"html_edit"</span>
<span class="lineno" id=line291></span>    );
<span class="lineno" id=line292></span>  
<span class="lineno" id=line293></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  toc_menu = Dynlink::load-plugin-func1 [toc_menu_interface, <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>]] (
<span class="lineno" id=line294></span>      dll-name=<span class="fstring">"toc_menu"</span>, setup-str=<span class="fstring">"loaded-from-html_frame"</span>, entry-point=<span class="fstring">"toc_menu"</span>
<span class="lineno" id=line295></span>    );
<span class="lineno" id=line296></span>  
<span class="lineno" id=line297></span>  
<span class="lineno" id=line298></span>  <span class="comment">// MOVE THIS ELSEWHERE!</span>
<span class="lineno" id=line299></span>  
<span class="lineno" id=line300></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> getline_to_url (get:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line301></span>    <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> startswith get <span class="fstring">"GET "</span> <span class="small_keyword" title="conditional">then</span>
<span class="lineno" id=line302></span>      <span class="fstring">""</span>
<span class="lineno" id=line303></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line304></span>      <span class="small_keyword" title="match statement or expression">match</span> find (get, <span class="fstring">' '</span>, 4uz) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line305></span>      | #None =&gt; <span class="fstring">""</span>
<span class="lineno" id=line306></span>      | Some pos =&gt; get.[4 <span class="small_keyword" title="substring range separator">to</span> pos]
<span class="lineno" id=line307></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line308></span>    <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line309></span>  ;
<span class="lineno" id=line310></span>  
<span class="lineno" id=line311></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> postline_to_url (get:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line312></span>    <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> startswith get <span class="fstring">"POST "</span> <span class="small_keyword" title="conditional">then</span>
<span class="lineno" id=line313></span>      <span class="fstring">""</span>
<span class="lineno" id=line314></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line315></span>      <span class="small_keyword" title="match statement or expression">match</span> find (get, <span class="fstring">' '</span>, 5uz) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line316></span>      | #None =&gt; <span class="fstring">""</span>
<span class="lineno" id=line317></span>      | Some pos =&gt; get.[5 <span class="small_keyword" title="substring range separator">to</span> pos]
<span class="lineno" id=line318></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line319></span>    <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line320></span>  ;
<span class="lineno" id=line321></span>  
<span class="lineno" id=line322></span>  
<span class="lineno" id=line323></span>  <span class="comment">// strip off the leading http:// then split on the next /</span>
<span class="lineno" id=line324></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> split_url (inurl:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line325></span>    <span class="big_keyword" title="Define an immutable value">val</span> url =
<span class="lineno" id=line326></span>      <span class="small_keyword" title="conditional">if</span> startswith inurl <span class="fstring">"http://"</span> <span class="small_keyword" title="conditional">then</span>
<span class="lineno" id=line327></span>        inurl.[<span class="small_keyword" title="substring range separator">to</span> 7]
<span class="lineno" id=line328></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line329></span>        inurl
<span class="lineno" id=line330></span>      <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line331></span>    ;
<span class="lineno" id=line332></span>  
<span class="lineno" id=line333></span>    <span class="small_keyword" title="return">return</span>
<span class="lineno" id=line334></span>      <span class="small_keyword" title="match statement or expression">match</span> find (url, <span class="fstring">'/'</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line335></span>      | #None =&gt; None[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line336></span>      | Some pos =&gt; Some$ url.[0 <span class="small_keyword" title="substring range separator">to</span> pos], url.[pos + 1 <span class="small_keyword" title="substring range separator">to</span>]
<span class="lineno" id=line337></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line338></span>    ;
<span class="lineno" id=line339></span>  }
<span class="lineno" id=line340></span>  
<span class="lineno" id=line341></span>  <span class="comment">// parse balance of HTTP GET request (after gthe GET keyword)</span>
<span class="lineno" id=line342></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_get_line (get:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line343></span>    split_url$ getline_to_url get
<span class="lineno" id=line344></span>  ;
<span class="lineno" id=line345></span>  
<span class="lineno" id=line346></span>  <span class="comment">// parse balance of HTTP GET request (after gthe GET keyword)</span>
<span class="lineno" id=line347></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_post_line (get:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line348></span>    split_url$ postline_to_url get
<span class="lineno" id=line349></span>  ;
<span class="lineno" id=line350></span>  
<span class="lineno" id=line351></span>  variant request_type = reqGET | reqPOST | reqHEAD | reqERROR;
<span class="lineno" id=line352></span>  
<span class="lineno" id=line353></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_request_type (r:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line354></span>    <span class="small_keyword" title="conditional">if</span> startswith r <span class="fstring">"GET"</span> <span class="small_keyword" title="conditional">then</span> reqGET
<span class="lineno" id=line355></span>    <span class="small_keyword" title="conditional">elif</span> startswith r <span class="fstring">"HEAD"</span> <span class="small_keyword" title="conditional">then</span> reqHEAD
<span class="lineno" id=line356></span>    <span class="small_keyword" title="conditional">elif</span> startswith r <span class="fstring">"POST"</span> <span class="small_keyword" title="conditional">then</span> reqPOST
<span class="lineno" id=line357></span>    <span class="small_keyword" title="conditional">else</span> reqERROR
<span class="lineno" id=line358></span>    <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line359></span>  ;
<span class="lineno" id=line360></span>    
<span class="lineno" id=line361></span>  <span class="comment">// fixup text by replacing &lt; &gt; and &amp; characters</span>
<span class="lineno" id=line362></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> txt2html (x:<span class="library" title="binding of C++ string type">string</span>) =
<span class="lineno" id=line363></span>  {
<span class="lineno" id=line364></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out2 = <span class="fstring">""</span>;
<span class="lineno" id=line365></span>    <span class="small_keyword" title="for loop">for</span> <span class="big_keyword" title="Define a mutable variable">var</span> i <span class="small_keyword" title="membership operator, function mem">in</span> 0 <span class="small_keyword" title="upwards counting for loop">upto</span> x.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> - 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line366></span>      <span class="big_keyword" title="Define a mutable variable">var</span> ch = x.[i];
<span class="lineno" id=line367></span>      <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line368></span>      <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line369></span>      <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line370></span>      <span class="small_keyword" title="conditional">else</span> out2+=ch;
<span class="lineno" id=line371></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line372></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line373></span>  
<span class="lineno" id=line374></span>    <span class="small_keyword" title="return">return</span> out2;
<span class="lineno" id=line375></span>  }
<span class="lineno" id=line376></span>  
<span class="lineno" id=line377></span>  <span class="comment">// put into &lt;head&gt; of document</span>
<span class="lineno" id=line378></span>  <span class="comment">// http://www.mathjax.org/docs/1.1/start.html#mathjax-cdn</span>
<span class="lineno" id=line379></span>  mathjax := <span class="fstring">'''
<span class="lineno" id=line380></span>  &lt;script type="text/x-mathjax-config"&gt;
<span class="lineno" id=line381></span>    MathJax.Hub.Config({
<span class="lineno" id=line382></span>      tex2jax: {
<span class="lineno" id=line383></span>          skipTags: ["script","noscript","style","textarea"]
<span class="lineno" id=line384></span>      }
<span class="lineno" id=line385></span>    });
<span class="lineno" id=line386></span>  &lt;/script&gt; 
<span class="lineno" id=line387></span>  &lt;script type="text/javascript"
<span class="lineno" id=line388></span>    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"&gt;
<span class="lineno" id=line389></span>  &lt;/script&gt;
<span class="lineno" id=line390></span>  '''</span>;
<span class="lineno" id=line391></span>  
<span class="lineno" id=line392></span>  
<span class="lineno" id=line393></span>  <span class="comment">// functions to make responses</span>
<span class="lineno" id=line394></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_image_from_suffix (suffix:<span class="library" title="binding of C++ string type">string</span>, contents:<span class="library" title="binding of C++ string type">string</span>, headers:headers_t) =&gt;
<span class="lineno" id=line395></span>    make_image(MIMEType::mime_type_from_extension suffix,contents, headers)
<span class="lineno" id=line396></span>  ;
<span class="lineno" id=line397></span>  
<span class="lineno" id=line398></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_not_found (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line399></span>     <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line400></span>     <span class="big_keyword" title="Define an immutable value">val</span> data = make_not_found(fname);
<span class="lineno" id=line401></span>     write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line402></span>  }
<span class="lineno" id=line403></span>  
<span class="lineno" id=line404></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_not_implemented (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line405></span>     <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line406></span>     <span class="big_keyword" title="Define an immutable value">val</span> data = make_not_implemented(fname);
<span class="lineno" id=line407></span>     write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line408></span>  }
<span class="lineno" id=line409></span>  
<span class="lineno" id=line410></span>  
<span class="lineno" id=line411></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_forbidden (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line412></span>     <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line413></span>     <span class="big_keyword" title="Define an immutable value">val</span> data = make_forbidden(fname);
<span class="lineno" id=line414></span>     write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line415></span>  }
<span class="lineno" id=line416></span>  
<span class="lineno" id=line417></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> find_defs (lines:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="array with unbounded dynamically variable limit">darray</span>[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span>] =
<span class="lineno" id=line418></span>  {
<span class="lineno" id=line419></span>  
<span class="lineno" id=line420></span>    <span class="big_keyword" title="Define a mutable variable">var</span> fregex = <span class="fstring">".*\\.(flx|html)"</span>;
<span class="lineno" id=line421></span>    <span class="big_keyword" title="Open a module or class">open</span> Regdef;
<span class="lineno" id=line422></span>    <span class="big_keyword" title="define named regular expression">regdef</span> anychar = perl (<span class="fstring">"."</span>);
<span class="lineno" id=line423></span>  
<span class="lineno" id=line424></span>    <span class="big_keyword" title="define named regular expression">regdef</span> letter = charset <span class="fstring">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;
<span class="lineno" id=line425></span>    <span class="big_keyword" title="define named regular expression">regdef</span> digit = charset <span class="fstring">"0123456789"</span>;
<span class="lineno" id=line426></span>    <span class="big_keyword" title="define named regular expression">regdef</span> id1 = letter | <span class="fstring">"_"</span>;
<span class="lineno" id=line427></span>    <span class="big_keyword" title="define named regular expression">regdef</span> id2 = id1 | digit | <span class="fstring">"-"</span> | <span class="fstring">"'"</span>;
<span class="lineno" id=line428></span>    <span class="big_keyword" title="define named regular expression">regdef</span> id = id1 id2*;
<span class="lineno" id=line429></span>  
<span class="lineno" id=line430></span>    <span class="big_keyword" title="define named regular expression">regdef</span> tex = <span class="fstring">"\\"</span> letter*;
<span class="lineno" id=line431></span>    <span class="big_keyword" title="define named regular expression">regdef</span> symbol1 = <span class="fstring">"+-*/%^"</span>;
<span class="lineno" id=line432></span>    <span class="big_keyword" title="define named regular expression">regdef</span> symbol = symbol1 | symbol1 symbol1 | symbol1 symbol1 symbol1;
<span class="lineno" id=line433></span>    <span class="big_keyword" title="define named regular expression">regdef</span> name = id | symbol;
<span class="lineno" id=line434></span>    <span class="big_keyword" title="define named regular expression">regdef</span> spaces = <span class="fstring">" "</span>*;
<span class="lineno" id=line435></span>    <span class="big_keyword" title="define named regular expression">regdef</span> vlist =  <span class="fstring">"["</span> spaces id (spaces <span class="fstring">","</span> spaces id)* spaces <span class="fstring">"]"</span>;
<span class="lineno" id=line436></span>     
<span class="lineno" id=line437></span>    <span class="big_keyword" title="define named regular expression">regdef</span> adjective = <span class="fstring">"pure"</span> | <span class="fstring">"inline"</span> | <span class="fstring">"noinline"</span> | <span class="fstring">"pod"</span> | <span class="fstring">"open"</span> | <span class="fstring">"virtual"</span>;
<span class="lineno" id=line438></span>    <span class="big_keyword" title="define named regular expression">regdef</span> binder = <span class="fstring">"fun"</span> | <span class="fstring">"proc"</span> | <span class="fstring">"gen"</span> | <span class="fstring">"class"</span> | <span class="fstring">"union"</span> | <span class="fstring">"struct"</span> | <span class="fstring">"type"</span> | <span class="fstring">"typedef"</span> | <span class="fstring">"ctor"</span> (spaces vlist)?;
<span class="lineno" id=line439></span>  
<span class="lineno" id=line440></span>    <span class="big_keyword" title="define named regular expression">regdef</span> indent2 = <span class="fstring">"  "</span>;
<span class="lineno" id=line441></span>  
<span class="lineno" id=line442></span>    <span class="big_keyword" title="define named regular expression">regdef</span> classbind= group (<span class="fstring">"class"</span> | <span class="fstring">"open class"</span>);
<span class="lineno" id=line443></span>    <span class="big_keyword" title="define named regular expression">regdef</span> otherbind= indent2 ? group (adjective* spaces binder);
<span class="lineno" id=line444></span>  
<span class="lineno" id=line445></span>    <span class="comment">// Group 1 = class</span>
<span class="lineno" id=line446></span>    <span class="comment">// Group 2 = other </span>
<span class="lineno" id=line447></span>    <span class="comment">// group 3 = identifier</span>
<span class="lineno" id=line448></span>    <span class="big_keyword" title="define named regular expression">regdef</span> decl = (classbind | otherbind) spaces group (name) anychar*;
<span class="lineno" id=line449></span>  
<span class="lineno" id=line450></span>    <span class="big_keyword" title="Define a mutable variable">var</span> emptystring = <span class="fstring">""</span>;
<span class="lineno" id=line451></span>    <span class="big_keyword" title="Define a mutable variable">var</span> emptystringpiece = StringPiece emptystring;
<span class="lineno" id=line452></span>  
<span class="lineno" id=line453></span>    <span class="big_keyword" title="Define a mutable variable">var</span> lregex = decl . render;
<span class="lineno" id=line454></span>    <span class="big_keyword" title="Define a mutable variable">var</span> lgrep = RE2 lregex;
<span class="lineno" id=line455></span>    <span class="big_keyword" title="Define a mutable variable">var</span> n = NumberOfCapturingGroups(lgrep)+1;
<span class="lineno" id=line456></span>    <span class="big_keyword" title="Define a mutable variable">var</span> v = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (n.<span class="library" title="binding of C size_t type">size</span>,emptystringpiece);
<span class="lineno" id=line457></span>  
<span class="lineno" id=line458></span>    <span class="big_keyword" title="Define a mutable variable">var</span> extract = RE2 <span class="fstring">" *([^={]*) *(=|{|;).*"</span>;
<span class="lineno" id=line459></span>    <span class="big_keyword" title="Define a mutable variable">var</span> n2 = NumberOfCapturingGroups(extract)+1;
<span class="lineno" id=line460></span>    <span class="big_keyword" title="Define a mutable variable">var</span> v2 = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (n2.<span class="library" title="binding of C size_t type">size</span>,emptystringpiece);
<span class="lineno" id=line461></span>  
<span class="lineno" id=line462></span>    <span class="big_keyword" title="Define a mutable variable">var</span> scomment = RE2 <span class="fstring">" *//[$](.*)"</span>;
<span class="lineno" id=line463></span>    <span class="big_keyword" title="Define a mutable variable">var</span> vcomment = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (2.<span class="library" title="binding of C size_t type">size</span>, emptystringpiece);
<span class="lineno" id=line464></span>    <span class="big_keyword" title="Define a mutable variable">var</span> count = 0;
<span class="lineno" id=line465></span>    <span class="big_keyword" title="Define a mutable variable">var</span> comments = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line466></span>  
<span class="lineno" id=line467></span>    <span class="big_keyword" title="Define a mutable variable">var</span> h = <span class="library" title="array with unbounded dynamically variable limit">darray</span>[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span>] ();
<span class="lineno" id=line468></span>    <span class="big_keyword" title="Define a mutable variable">var</span> lno = 1;
<span class="lineno" id=line469></span>    <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> split (lines,<span class="library" title="binding of C char type">char</span> <span class="fstring">"\n"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line470></span>      ++count;
<span class="lineno" id=line471></span>      <span class="big_keyword" title="Define a mutable variable">var</span> spl = StringPiece line;
<span class="lineno" id=line472></span>  
<span class="lineno" id=line473></span>      <span class="small_keyword" title="match statement or expression">match</span> lgrep line <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line474></span>      | Some v =&gt;
<span class="lineno" id=line475></span>        <span class="big_keyword" title="Define a mutable variable">var</span> sym = v.3;
<span class="lineno" id=line476></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dfn = <span class="fstring">""</span>;
<span class="lineno" id=line477></span>        <span class="big_keyword" title="Define a mutable variable">var</span> m2 = Match (extract, spl, 0, ANCHOR_BOTH, v2.stl_begin, n2);
<span class="lineno" id=line478></span>        <span class="small_keyword" title="conditional">if</span> m2 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line479></span>          dfn = v2 . 1 . <span class="library" title="binding of C++ string type">string</span> . strip;
<span class="lineno" id=line480></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line481></span>          dfn = line . strip;
<span class="lineno" id=line482></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line483></span>        <span class="comment">//println$ "DEFN: " + dfn;</span>
<span class="lineno" id=line484></span>        <span class="big_keyword" title="Define a mutable variable">var</span> level = <span class="small_keyword" title="conditional">if</span> line.[0] == <span class="fstring">" "</span> <span class="small_keyword" title="conditional">then</span> 2 <span class="small_keyword" title="conditional">else</span> 1 <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line485></span>        push_back (h, (level, lno, dfn));
<span class="lineno" id=line486></span>  
<span class="lineno" id=line487></span>      | #None =&gt; ;
<span class="lineno" id=line488></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>; <span class="comment">//d grexp</span>
<span class="lineno" id=line489></span>      ++lno;
<span class="lineno" id=line490></span>    <span class="small_keyword" title="end of body">done</span> <span class="comment">// line</span>
<span class="lineno" id=line491></span>    <span class="small_keyword" title="return">return</span> h;
<span class="lineno" id=line492></span>  }
<span class="lineno" id=line493></span>  
<span class="lineno" id=line494></span>  <span class="big_keyword" title="Define a mutable variable">var</span> frame_style= <span class="fstring">""" 
<span class="lineno" id=line495></span>  &lt;style&gt;
<span class="lineno" id=line496></span>  .container {
<span class="lineno" id=line497></span>    position: fixed;
<span class="lineno" id=line498></span>    top:0px;
<span class="lineno" id=line499></span>    left:0px;
<span class="lineno" id=line500></span>    height : 100%;
<span class="lineno" id=line501></span>    width: 100%;
<span class="lineno" id=line502></span>    background-color: grey;
<span class="lineno" id=line503></span>    margin: 0px;
<span class="lineno" id=line504></span>    padding: 0px;
<span class="lineno" id=line505></span>    border-width: 0px;
<span class="lineno" id=line506></span>    color: #404040;
<span class="lineno" id=line507></span>  }
<span class="lineno" id=line508></span>  .maincontent {
<span class="lineno" id=line509></span>    padding:4px;
<span class="lineno" id=line510></span>    padding-left:8px;
<span class="lineno" id=line511></span>    line-height:1.3em;
<span class="lineno" id=line512></span>    color:#404040; background-color:#fafafa;
<span class="lineno" id=line513></span>  }
<span class="lineno" id=line514></span>  .maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
<span class="lineno" id=line515></span>  .maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
<span class="lineno" id=line516></span>  .maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
<span class="lineno" id=line517></span>  .maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
<span class="lineno" id=line518></span>  .maincontent code { color:#902030; }
<span class="lineno" id=line519></span>  .toppanel {
<span class="lineno" id=line520></span>    position:absolute; left:0px; top:0px; height:20px; right:0px; 
<span class="lineno" id=line521></span>    background-color: #e0e0e0;
<span class="lineno" id=line522></span>  }
<span class="lineno" id=line523></span>  .bottompanel {
<span class="lineno" id=line524></span>    position:absolute; left:0px; top:22px; bottom:0px; right:0px; 
<span class="lineno" id=line525></span>    background-color: #fafafa;
<span class="lineno" id=line526></span>    font-size:14px;
<span class="lineno" id=line527></span>  }
<span class="lineno" id=line528></span>  .leftpanel {
<span class="lineno" id=line529></span>    position:absolute; left:0px; top:0px; bottom:0px; width: 150px; 
<span class="lineno" id=line530></span>    background-color: #eaeaea; overflow: auto;
<span class="lineno" id=line531></span>  }
<span class="lineno" id=line532></span>  .rightpanel {
<span class="lineno" id=line533></span>    position:absolute; right: 0px; left:160px; top:0px; bottom: 0px; 
<span class="lineno" id=line534></span>    background-color: #fafafa; overflow: auto;
<span class="lineno" id=line535></span>  }
<span class="lineno" id=line536></span>  .divider {
<span class="lineno" id=line537></span>    position:absolute; left: 150px; top:0px; bottom:0px; 
<span class="lineno" id=line538></span>    background-color: black; width:2px;
<span class="lineno" id=line539></span>    box-shadow: 0 0 8px #000;
<span class="lineno" id=line540></span>  }
<span class="lineno" id=line541></span>  
<span class="lineno" id=line542></span>  #panemover {
<span class="lineno" id=line543></span>      position:absolute;
<span class="lineno" id=line544></span>      left: 150px;
<span class="lineno" id=line545></span>      width : 10px;
<span class="lineno" id=line546></span>      top: 0px;
<span class="lineno" id=line547></span>      bottom: 0px;
<span class="lineno" id=line548></span>      opacity: 0.3;
<span class="lineno" id=line549></span>      cursor:col-resize;
<span class="lineno" id=line550></span>  }
<span class="lineno" id=line551></span>  
<span class="lineno" id=line552></span>  div.m {
<span class="lineno" id=line553></span>      margin: 0px;
<span class="lineno" id=line554></span>      padding:0px;
<span class="lineno" id=line555></span>      border-width:2px;
<span class="lineno" id=line556></span>      border-color: green;
<span class="lineno" id=line557></span>  }
<span class="lineno" id=line558></span>  
<span class="lineno" id=line559></span>  div.m1 {
<span class="lineno" id=line560></span>      background-color: #86E870;
<span class="lineno" id=line561></span>      border-style:outset;
<span class="lineno" id=line562></span>      border-color:#ccc;
<span class="lineno" id=line563></span>      border-width:2px 0;
<span class="lineno" id=line564></span>      font-size:90%;
<span class="lineno" id=line565></span>      padding: 1px 0 2px 10px;
<span class="lineno" id=line566></span>  }
<span class="lineno" id=line567></span>  
<span class="lineno" id=line568></span>  div.m2 {
<span class="lineno" id=line569></span>      background-color: #70C070;
<span class="lineno" id=line570></span>      padding-left:15px;
<span class="lineno" id=line571></span>      padding-top:2px;
<span class="lineno" id=line572></span>      border-style:outset;
<span class="lineno" id=line573></span>      border-color:green;
<span class="lineno" id=line574></span>      border-width:0 0 1px 0;
<span class="lineno" id=line575></span>      font-size:80%;
<span class="lineno" id=line576></span>  }
<span class="lineno" id=line577></span>  
<span class="lineno" id=line578></span>  div.m1:hover, div.m2:hover {
<span class="lineno" id=line579></span>      background-color: white;
<span class="lineno" id=line580></span>  }
<span class="lineno" id=line581></span>  
<span class="lineno" id=line582></span>  #leftmargintoc a {
<span class="lineno" id=line583></span>      text-decoration: none;
<span class="lineno" id=line584></span>      color: #404040;
<span class="lineno" id=line585></span>  }
<span class="lineno" id=line586></span>  &lt;/style&gt;
<span class="lineno" id=line587></span>  """</span>;
<span class="lineno" id=line588></span>  
<span class="lineno" id=line589></span>  <span class="big_keyword" title="Define a mutable variable">var</span> frame_js = <span class="fstring">"""
<span class="lineno" id=line590></span>      &lt;script async="true"&gt;
<span class="lineno" id=line591></span>        function dragStart(e, left, right){
<span class="lineno" id=line592></span>          document.getElementById("panemover").style.width="70%";
<span class="lineno" id=line593></span>          document.getElementById("panemover").style.left="50px";
<span class="lineno" id=line594></span>          mousedown = true;
<span class="lineno" id=line595></span>          x = e.clientX
<span class="lineno" id=line596></span>          dragOffsetLeft =  
<span class="lineno" id=line597></span>            document.getElementById(left).getBoundingClientRect().right - 
<span class="lineno" id=line598></span>            document.getElementById(left).getBoundingClientRect().left - 
<span class="lineno" id=line599></span>            x 
<span class="lineno" id=line600></span>          ; 
<span class="lineno" id=line601></span>          dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x; 
<span class="lineno" id=line602></span>          dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
<span class="lineno" id=line603></span>        }
<span class="lineno" id=line604></span>        function dragRelease(){
<span class="lineno" id=line605></span>          document.getElementById('panemover').style.width = '6px';
<span class="lineno" id=line606></span>          document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
<span class="lineno" id=line607></span>          mousedown = false;
<span class="lineno" id=line608></span>        }
<span class="lineno" id=line609></span>        function drag(e, left, right){
<span class="lineno" id=line610></span>          if(!mousedown){return}
<span class="lineno" id=line611></span>          x = e.clientX
<span class="lineno" id=line612></span>          tmpLeft = dragOffsetLeft + x
<span class="lineno" id=line613></span>          tmpDivider= dragOffsetDivider + x
<span class="lineno" id=line614></span>          tmpRight = dragOffsetRight + x
<span class="lineno" id=line615></span>          document.getElementById(left).style.width= tmpLeft + 'px';
<span class="lineno" id=line616></span>          document.getElementById("divider").style.left= tmpDivider + 'px';
<span class="lineno" id=line617></span>          document.getElementById(right).style.left = tmpRight + 'px';
<span class="lineno" id=line618></span>        };
<span class="lineno" id=line619></span>      &lt;/script&gt;
<span class="lineno" id=line620></span>  """</span>;
<span class="lineno" id=line621></span>  
<span class="lineno" id=line622></span>  <span class="big_keyword" title="Define an alias for a type expression">typedef</span> code_data_t = <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line623></span>  <span class="big_keyword" title="Define an alias for a type expression">typedef</span> menu_data_t = <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line624></span>  
<span class="lineno" id=line625></span>  <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> wrap_html (h:<span class="library" title="array with unbounded dynamically variable limit">darray</span>[code_data_t], out:<span class="library" title="binding of C++ string type">string</span>) :<span class="library" title="binding of C++ string type">string</span> = {
<span class="lineno" id=line626></span>    <span class="big_keyword" title="Define a mutable variable">var</span> h3 =  <span class="library" title="accumulated values of data structure from right into initial value using function">fold_right</span> 
<span class="lineno" id=line627></span>      (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (level:<span class="library" title="binding of C int type">int</span>, lno:<span class="library" title="binding of C int type">int</span>, text:<span class="library" title="binding of C++ string type">string</span>) (lst:<span class="library" title="functional, singly linked list">list</span>[menu_data_t]) =&gt; 
<span class="lineno" id=line628></span>        (level, text, <span class="fstring">"#line"</span> + lno.<span class="library" title="Convert a value to a string">str</span>) + lst
<span class="lineno" id=line629></span>      )
<span class="lineno" id=line630></span>      h Empty[menu_data_t]
<span class="lineno" id=line631></span>    ; 
<span class="lineno" id=line632></span>      <span class="big_keyword" title="Define a mutable variable">var</span> menu = toc_menu (h3);
<span class="lineno" id=line633></span>  
<span class="lineno" id=line634></span>      <span class="big_keyword" title="Define a mutable variable">var</span> o = <span class="fstring">""</span>;
<span class="lineno" id=line635></span>      reserve(&amp;o,10000+out.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line636></span>  
<span class="lineno" id=line637></span>      o+=frame_style;
<span class="lineno" id=line638></span>      o+=#(menu.get_style);
<span class="lineno" id=line639></span>      o+=frame_js;
<span class="lineno" id=line640></span>      o+=#(menu.get_js);
<span class="lineno" id=line641></span>  
<span class="lineno" id=line642></span>      <span class="comment">// MAIN CONTENT</span>
<span class="lineno" id=line643></span>      <span class="big_keyword" title="Define a mutable variable">var</span> topcontent =
<span class="lineno" id=line644></span>        <span class="fstring">'    &lt;!--Main Content top navbar--&gt;\n'</span>  +
<span class="lineno" id=line645></span>        <span class="fstring">'    &lt;!--Main Content top navbar End--&gt;\n'</span>
<span class="lineno" id=line646></span>      ;
<span class="lineno" id=line647></span>  
<span class="lineno" id=line648></span>      <span class="big_keyword" title="Define a mutable variable">var</span> leftcontent = #(menu.make_menu);
<span class="lineno" id=line649></span>  
<span class="lineno" id=line650></span>      <span class="big_keyword" title="Define a mutable variable">var</span> rightcontent =
<span class="lineno" id=line651></span>        <span class="fstring">'&lt;!--Main Content Body--&gt;\n'</span> + 
<span class="lineno" id=line652></span>        out +
<span class="lineno" id=line653></span>        <span class="fstring">'&lt;!--Main Content Body End--&gt;\n'</span>
<span class="lineno" id=line654></span>      ;
<span class="lineno" id=line655></span>   
<span class="lineno" id=line656></span>      <span class="big_keyword" title="Define a mutable variable">var</span> html = <span class="fstring">"""
<span class="lineno" id=line657></span>      &lt;div class="container"&gt;
<span class="lineno" id=line658></span>        &lt;div class="toppanel"&gt;
<span class="lineno" id=line659></span>  """</span> + topcontent + <span class="fstring">"""
<span class="lineno" id=line660></span>        &lt;/div&gt; &lt;!-- toppanel end --&gt;
<span class="lineno" id=line661></span>        &lt;div class="bottompanel"&gt;
<span class="lineno" id=line662></span>  
<span class="lineno" id=line663></span>          &lt;span id="divider" class="divider"&gt;&lt;/span&gt;
<span class="lineno" id=line664></span>  
<span class="lineno" id=line665></span>          &lt;span id="left" class="leftpanel" &gt;
<span class="lineno" id=line666></span>            &lt;div class="menucontent"&gt;
<span class="lineno" id=line667></span>  """</span> + leftcontent + <span class="fstring">"""
<span class="lineno" id=line668></span>            &lt;/div&gt; &lt;!-- leftpanel contents end --&gt;
<span class="lineno" id=line669></span>          &lt;/span&gt; &lt;!-- leftpanel end --&gt;
<span class="lineno" id=line670></span>  
<span class="lineno" id=line671></span>  
<span class="lineno" id=line672></span>          &lt;span id="right" class="rightpanel"&gt;
<span class="lineno" id=line673></span>            &lt;div class="maincontent"&gt;
<span class="lineno" id=line674></span>  """</span> + rightcontent + <span class="fstring">"""
<span class="lineno" id=line675></span>            &lt;/div&gt; &lt;!-- rightpanel contents end --&gt;
<span class="lineno" id=line676></span>            &lt;hr&gt;
<span class="lineno" id=line677></span>          &lt;/span&gt; &lt;!-- rightpanel end --&gt;
<span class="lineno" id=line678></span>  
<span class="lineno" id=line679></span>          &lt;span id="panemover" style="cursor:col-resize;" 
<span class="lineno" id=line680></span>           onmousedown="dragStart(event, 'left', 'right'); return false;" 
<span class="lineno" id=line681></span>           onmousemove="drag(event, 'left', 'right');" 
<span class="lineno" id=line682></span>           onmouseout="dragRelease();" 
<span class="lineno" id=line683></span>           onmouseup="dragRelease();"
<span class="lineno" id=line684></span>          &gt;
<span class="lineno" id=line685></span>          &lt;/span&gt; &lt;!-- panemover end --&gt;
<span class="lineno" id=line686></span>        &lt;/div&gt; &lt;!-- bottom panel end --&gt;
<span class="lineno" id=line687></span>      &lt;/div&gt; &lt;!-- container end --&gt;
<span class="lineno" id=line688></span>  """</span>;
<span class="lineno" id=line689></span>      o+= html;
<span class="lineno" id=line690></span>      <span class="small_keyword" title="return">return</span> o;
<span class="lineno" id=line691></span>  }
<span class="lineno" id=line692></span>  
<span class="lineno" id=line693></span>  
<span class="lineno" id=line694></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_felix (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line695></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line696></span>  
<span class="lineno" id=line697></span>    <span class="small_keyword" title="match statement or expression">match</span> get_file(fname,INSTALL_ROOT,FLX_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line698></span>    | Some path =&gt;
<span class="lineno" id=line699></span>      <span class="big_keyword" title="Define an immutable value">val</span> text = load path;
<span class="lineno" id=line700></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Loaded felix file "</span> + fname+<span class="fstring">", len="</span>+<span class="library" title="Convert a value to a string">str</span> (text.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line701></span>      <span class="big_keyword" title="Define a mutable variable">var</span> h =find_defs (text); 
<span class="lineno" id=line702></span>      <span class="big_keyword" title="Define an immutable value">val</span> dirname = Filename::dirname path;
<span class="lineno" id=line703></span>      def <span class="big_keyword" title="Define an immutable value">val</span> needs_mathjax, <span class="big_keyword" title="Define an immutable value">val</span> html = xlat_felix(text,dirname);
<span class="lineno" id=line704></span>      <span class="big_keyword" title="Define a mutable variable">var</span> wrapped_html = wrap_html (h,<span class="fstring">"&lt;pre&gt;"</span>+html+<span class="fstring">"&lt;/pre&gt;"</span>);
<span class="lineno" id=line705></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = make_html$
<span class="lineno" id=line706></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+Css4Html::flx_head+
<span class="lineno" id=line707></span>         <span class="small_keyword" title="conditional">if</span> needs_mathjax <span class="small_keyword" title="conditional">then</span> mathjax <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line708></span>        <span class="fstring">"&lt;/head&gt;&lt;body&gt;"</span>+ wrapped_html +
<span class="lineno" id=line709></span>        <span class="fstring">"&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line710></span>        <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line711></span>      ;
<span class="lineno" id=line712></span>      write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line713></span>    | #None =&gt;
<span class="lineno" id=line714></span>        serve_not_found (k,fname,get);
<span class="lineno" id=line715></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line716></span>  }
<span class="lineno" id=line717></span>  
<span class="lineno" id=line718></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_fpc (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line719></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line720></span>  
<span class="lineno" id=line721></span>    <span class="small_keyword" title="match statement or expression">match</span> get_file (fname, INSTALL_ROOT,FLX_PKGCONFIG_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line722></span>    | Some path =&gt;
<span class="lineno" id=line723></span>      <span class="big_keyword" title="Define an immutable value">val</span> text=load path;
<span class="lineno" id=line724></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Loaded fpc file "</span> + fname+<span class="fstring">", len="</span>+<span class="library" title="Convert a value to a string">str</span> (text.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line725></span>      <span class="big_keyword" title="Define an immutable value">val</span> dirname = Filename::dirname path;
<span class="lineno" id=line726></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = make_html$
<span class="lineno" id=line727></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+Css4Html::flx_head+<span class="fstring">"&lt;/head&gt;&lt;body&gt;&lt;pre&gt;"</span>+
<span class="lineno" id=line728></span>        (xlat_fpc (text, dirname)).1
<span class="lineno" id=line729></span>        +<span class="fstring">"&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line730></span>        <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>](<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>)
<span class="lineno" id=line731></span>      ;
<span class="lineno" id=line732></span>      write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line733></span>    | #None =&gt;
<span class="lineno" id=line734></span>        serve_not_found (k,fname,get);
<span class="lineno" id=line735></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line736></span>  
<span class="lineno" id=line737></span>  }
<span class="lineno" id=line738></span>  
<span class="lineno" id=line739></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_py (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line740></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line741></span>    <span class="small_keyword" title="match statement or expression">match</span> get_file(fname,INSTALL_ROOT,FLX_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line742></span>    | Some path =&gt;
<span class="lineno" id=line743></span>      <span class="big_keyword" title="Define a mutable variable">var</span> flx = load path;
<span class="lineno" id=line744></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = make_html$
<span class="lineno" id=line745></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+Css4Html::flx_head+<span class="fstring">"&lt;/head&gt;&lt;body&gt;&lt;pre&gt;"</span>+ 
<span class="lineno" id=line746></span>        (xlat_py (flx,<span class="fstring">""</span>)).1 +<span class="fstring">"&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line747></span>         <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line748></span>      ;
<span class="lineno" id=line749></span>      write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line750></span>    | #None =&gt;
<span class="lineno" id=line751></span>      serve_not_found (k,fname,get);
<span class="lineno" id=line752></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line753></span>  }
<span class="lineno" id=line754></span>  
<span class="lineno" id=line755></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_ocaml (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line756></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line757></span>    <span class="small_keyword" title="match statement or expression">match</span> get_file (fname, INSTALL_ROOT,FLX_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line758></span>    | Some path =&gt;
<span class="lineno" id=line759></span>      <span class="big_keyword" title="Define a mutable variable">var</span> flx = load path;
<span class="lineno" id=line760></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded Ocaml file %S, len=%d"</span> (fname, flx.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line761></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = make_html$
<span class="lineno" id=line762></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+ Css4Html::flx_head +<span class="fstring">"&lt;/head&gt;&lt;body&gt;&lt;pre&gt;"</span>+
<span class="lineno" id=line763></span>        (xlat_ocaml (flx,<span class="fstring">""</span>)).1
<span class="lineno" id=line764></span>        +<span class="fstring">"&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line765></span>        <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line766></span>      ;
<span class="lineno" id=line767></span>      write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line768></span>    | #None =&gt;
<span class="lineno" id=line769></span>      serve_not_found (k,fname,get);
<span class="lineno" id=line770></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line771></span>  }
<span class="lineno" id=line772></span>  
<span class="lineno" id=line773></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_cpp (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line774></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line775></span>    <span class="small_keyword" title="match statement or expression">match</span> get_file(fname,INSTALL_ROOT,C_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line776></span>    | Some path =&gt;
<span class="lineno" id=line777></span>      <span class="big_keyword" title="Define an immutable value">val</span> text=load path;
<span class="lineno" id=line778></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded C++ file %S, len=%d"</span> (fname, text.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line779></span>      <span class="big_keyword" title="Define an immutable value">val</span> dirname = Filename::dirname path;
<span class="lineno" id=line780></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = make_html$
<span class="lineno" id=line781></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+ Css4Html::flx_head +<span class="fstring">"&lt;/head&gt;&lt;body&gt;&lt;pre&gt;"</span>+
<span class="lineno" id=line782></span>        (xlat_cpp (text, dirname)).1
<span class="lineno" id=line783></span>        +<span class="fstring">"&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line784></span>        <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line785></span>      ;
<span class="lineno" id=line786></span>      write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line787></span>    | #None =&gt;
<span class="lineno" id=line788></span>        serve_not_found (k,fname,get);
<span class="lineno" id=line789></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line790></span>  }
<span class="lineno" id=line791></span>  
<span class="lineno" id=line792></span>  <span class="big_keyword" title="Define an immutable value">val</span> text_suffices = (
<span class="lineno" id=line793></span>    <span class="fstring">"txt"</span>,<span class="fstring">"py"</span>,<span class="fstring">"ml"</span>,<span class="fstring">"mli"</span>,
<span class="lineno" id=line794></span>    <span class="fstring">"tex"</span>,<span class="fstring">"pl"</span>,<span class="fstring">"dyp"</span>,
<span class="lineno" id=line795></span>    <span class="fstring">"why"</span>,<span class="fstring">"resh"</span>,<span class="fstring">"pak"</span>,<span class="fstring">"ipk"</span>,
<span class="lineno" id=line796></span>    <span class="fstring">"dep"</span>,<span class="fstring">"stdout"</span>,<span class="fstring">"expect"</span>
<span class="lineno" id=line797></span>  );
<span class="lineno" id=line798></span>  
<span class="lineno" id=line799></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_text (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line800></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line801></span>    <span class="big_keyword" title="Define a mutable variable">var</span> txt = load(fname);
<span class="lineno" id=line802></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded text file %S, len=%d"</span> (fname, txt.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line803></span>    <span class="big_keyword" title="Define an immutable value">val</span> data = make_html$
<span class="lineno" id=line804></span>      <span class="fstring">"&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;"</span>+
<span class="lineno" id=line805></span>      txt
<span class="lineno" id=line806></span>      +<span class="fstring">"&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line807></span>      <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line808></span>    ;
<span class="lineno" id=line809></span>    write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line810></span>  }
<span class="lineno" id=line811></span>  
<span class="lineno" id=line812></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_html (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line813></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line814></span>    <span class="big_keyword" title="Define a mutable variable">var</span> txt = load fname;
<span class="lineno" id=line815></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded html file %S, len=%d"</span> (fname, txt.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line816></span>    <span class="big_keyword" title="Define an immutable value">val</span> data = make_html$ txt,
<span class="lineno" id=line817></span>      <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line818></span>    ;
<span class="lineno" id=line819></span>    write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line820></span>  }
<span class="lineno" id=line821></span>  
<span class="lineno" id=line822></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_xhtml (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line823></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line824></span>    <span class="big_keyword" title="Define a mutable variable">var</span> txt = load fname;
<span class="lineno" id=line825></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded xhtml file %S, len=%d"</span> (fname, txt.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line826></span>    <span class="big_keyword" title="Define an immutable value">val</span> data = make_xhtml$ txt,
<span class="lineno" id=line827></span>      <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line828></span>    ;
<span class="lineno" id=line829></span>    write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line830></span>  }
<span class="lineno" id=line831></span>  
<span class="lineno" id=line832></span>  
<span class="lineno" id=line833></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_html (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line834></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line835></span>    <span class="small_keyword" title="match statement or expression">match</span> get_file(fname,INSTALL_ROOT,FDOC_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line836></span>    | Some path=&gt; 
<span class="lineno" id=line837></span>      <span class="big_keyword" title="Define a mutable variable">var</span> txt = load(path);
<span class="lineno" id=line838></span>      <span class="comment">//println$ "Contents=" + flx;</span>
<span class="lineno" id=line839></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = xlat_html (txt, fname);
<span class="lineno" id=line840></span>      <span class="big_keyword" title="Define a mutable variable">var</span> needs_mathjax = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.mathjax_required);
<span class="lineno" id=line841></span>      <span class="big_keyword" title="Define a mutable variable">var</span> html = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.html_page);
<span class="lineno" id=line842></span>      <span class="big_keyword" title="Define a mutable variable">var</span> title = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.html_title);
<span class="lineno" id=line843></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = make_html(
<span class="lineno" id=line844></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+Css4Html::flx_head+
<span class="lineno" id=line845></span>        <span class="small_keyword" title="conditional">if</span> needs_mathjax <span class="small_keyword" title="conditional">then</span> mathjax <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line846></span>        <span class="small_keyword" title="conditional">if</span> title != <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">"&lt;title&gt;"</span>+title+<span class="fstring">"&lt;/title&gt;"</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line847></span>        <span class="fstring">"&lt;/head&gt;&lt;body&gt;"</span>+
<span class="lineno" id=line848></span>        html+
<span class="lineno" id=line849></span>        <span class="fstring">"&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line850></span>        <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line851></span>      );
<span class="lineno" id=line852></span>      write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line853></span>    | #None =&gt; serve_not_found(k,fname,get); 
<span class="lineno" id=line854></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line855></span>  }
<span class="lineno" id=line856></span>  
<span class="lineno" id=line857></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_xhtml (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line858></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line859></span>    <span class="small_keyword" title="match statement or expression">match</span> get_file(fname,INSTALL_ROOT,FDOC_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line860></span>    | Some path=&gt; 
<span class="lineno" id=line861></span>      <span class="big_keyword" title="Define a mutable variable">var</span> txt = load(path);
<span class="lineno" id=line862></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Serve html "</span>+fname+<span class="fstring">" as xhtml"</span>;
<span class="lineno" id=line863></span>      <span class="comment">//println$ "Contents=" + flx;</span>
<span class="lineno" id=line864></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = xlat_html (txt, fname);
<span class="lineno" id=line865></span>      <span class="big_keyword" title="Define a mutable variable">var</span> needs_mathjax = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.mathjax_required);
<span class="lineno" id=line866></span>      <span class="big_keyword" title="Define a mutable variable">var</span> html = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.html_page);
<span class="lineno" id=line867></span>      <span class="big_keyword" title="Define a mutable variable">var</span> title = #(<span class="small_keyword" title="value of function return used in post condition">result</span>.html_title);
<span class="lineno" id=line868></span>      <span class="big_keyword" title="Define an immutable value">val</span> data = make_html(
<span class="lineno" id=line869></span>        <span class="fstring">"&lt;html&gt;&lt;head&gt;"</span>+Css4Html::flx_head+
<span class="lineno" id=line870></span>        <span class="small_keyword" title="conditional">if</span> needs_mathjax <span class="small_keyword" title="conditional">then</span> mathjax <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line871></span>        <span class="small_keyword" title="conditional">if</span> title != <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">"&lt;title&gt;"</span>+title+<span class="fstring">"&lt;/title&gt;"</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line872></span>        <span class="fstring">"&lt;/head&gt;"</span>+
<span class="lineno" id=line873></span>        <span class="fstring">"&lt;body&gt;"</span>+ html
<span class="lineno" id=line874></span>        <span class="fstring">"&lt;/body&gt;&lt;/html&gt;\n\r"</span>,
<span class="lineno" id=line875></span>        <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line876></span>      );
<span class="lineno" id=line877></span>      write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line878></span>    | #None =&gt; serve_not_found(k,fname,get); 
<span class="lineno" id=line879></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line880></span>  }
<span class="lineno" id=line881></span>  
<span class="lineno" id=line882></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_raw (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, suffix:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line883></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line884></span>    <span class="big_keyword" title="Define a mutable variable">var</span> txt = load fname;
<span class="lineno" id=line885></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded raw file %S, len=%d"</span> (fname, txt.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line886></span>    <span class="big_keyword" title="Define a mutable variable">var</span> mime = MIMEType::mime_type_from_file fname;
<span class="lineno" id=line887></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"File "</span> + fname + <span class="fstring">" taken to be "</span> + <span class="library" title="Convert a value to a string">str</span> mime;
<span class="lineno" id=line888></span>    <span class="comment">//println$ "Contents=" + flx;</span>
<span class="lineno" id=line889></span>    <span class="big_keyword" title="Define an immutable value">val</span> data = make_mime (mime,txt);
<span class="lineno" id=line890></span>    <span class="comment">//val data = make_raw txt;</span>
<span class="lineno" id=line891></span>    write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line892></span>  }
<span class="lineno" id=line893></span>  
<span class="lineno" id=line894></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_image (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, suffix:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line895></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line896></span>    <span class="big_keyword" title="Define a mutable variable">var</span> txt = load fname;
<span class="lineno" id=line897></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded image file %S, len=%d"</span> (fname, txt.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line898></span>    <span class="comment">//println$ "Contents=" + flx;</span>
<span class="lineno" id=line899></span>    <span class="big_keyword" title="Define an immutable value">val</span> data = make_image_from_suffix (suffix,txt,
<span class="lineno" id=line900></span>      <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line901></span>    );
<span class="lineno" id=line902></span>    write_string (k, data, &amp;eof_flag);
<span class="lineno" id=line903></span>  }
<span class="lineno" id=line904></span>  
<span class="lineno" id=line905></span>  <span class="comment">// NOTE: TRICKY! serving css to be used in a page</span>
<span class="lineno" id=line906></span>  <span class="comment">// is quite different to serving a css file to be</span>
<span class="lineno" id=line907></span>  <span class="comment">// used by some program! In the first case it has to</span>
<span class="lineno" id=line908></span>  <span class="comment">// to be sent verbatim. In the second it is colourised.</span>
<span class="lineno" id=line909></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_css(k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, suffix:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line910></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line911></span>    <span class="big_keyword" title="Define a mutable variable">var</span> txt = load fname;
<span class="lineno" id=line912></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"Loaded css file %S, len=%d"</span> (fname, txt.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line913></span>    <span class="comment">//println$ "Contents=" + flx;</span>
<span class="lineno" id=line914></span>    <span class="big_keyword" title="Define an immutable value">val</span> data = make_css txt;
<span class="lineno" id=line915></span>    write_string(k,data,&amp;eof_flag);
<span class="lineno" id=line916></span>  }
<span class="lineno" id=line917></span>  
<span class="lineno" id=line918></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> mk_dir_lines (fname:<span class="library" title="binding of C++ string type">string</span>, dirs: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) = {
<span class="lineno" id=line919></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> rf(f:<span class="library" title="binding of C++ string type">string</span>)=&gt;<span class="fstring">'  &lt;a href="/$'</span>+ fname + <span class="fstring">'/'</span> +f+<span class="fstring">'"&gt;'</span>+f+<span class="fstring">'&lt;/a&gt;'</span>;
<span class="lineno" id=line920></span>    <span class="small_keyword" title="return">return</span> 
<span class="lineno" id=line921></span>      <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (acc: <span class="library" title="binding of C++ string type">string</span>) (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; 
<span class="lineno" id=line922></span>        <span class="small_keyword" title="match statement or expression">match</span> f <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line923></span>        | <span class="fstring">"."</span> =&gt; acc 
<span class="lineno" id=line924></span>        | <span class="fstring">".."</span> =&gt; acc
<span class="lineno" id=line925></span>        | _ =&gt; acc + rf f + <span class="fstring">"\r\n"</span> 
<span class="lineno" id=line926></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line927></span>      ) 
<span class="lineno" id=line928></span>      <span class="fstring">""</span> 
<span class="lineno" id=line929></span>      dirs
<span class="lineno" id=line930></span>    ;
<span class="lineno" id=line931></span>  }
<span class="lineno" id=line932></span>  
<span class="lineno" id=line933></span>    
<span class="lineno" id=line934></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> mk_reg_lines (fname:<span class="library" title="binding of C++ string type">string</span>, files: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) = {
<span class="lineno" id=line935></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof = <span class="library" title="false value">false</span>;
<span class="lineno" id=line936></span>    <span class="big_keyword" title="Define a mutable variable">var</span> s = <span class="fstring">""</span>;
<span class="lineno" id=line937></span>    <span class="big_keyword" title="Define a mutable variable">var</span> old_base = <span class="fstring">""</span>;
<span class="lineno" id=line938></span>    <span class="big_keyword" title="Define a mutable variable">var</span> base = <span class="fstring">""</span>;
<span class="lineno" id=line939></span>    <span class="big_keyword" title="Define a mutable variable">var</span> extn = <span class="fstring">""</span>;
<span class="lineno" id=line940></span>    <span class="big_keyword" title="Define a mutable variable">var</span> entry = <span class="fstring">""</span>;
<span class="lineno" id=line941></span>    <span class="big_keyword" title="Define a mutable variable">var</span> exts = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line942></span>    <span class="big_keyword" title="Define a mutable variable">var</span> rest = files;
<span class="lineno" id=line943></span>  
<span class="lineno" id=line944></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> hd() { chd; }
<span class="lineno" id=line945></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> chd() { exts=<span class="library" title="functional, singly linked list">list</span>(extn); old_base=base; }
<span class="lineno" id=line946></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cft() {
<span class="lineno" id=line947></span>      <span class="comment">//println$ "Cft for key " + old_base + " exts=" + str exts;</span>
<span class="lineno" id=line948></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> rf(x:<span class="library" title="binding of C++ string type">string</span>)=&gt;
<span class="lineno" id=line949></span>        <span class="fstring">'  &lt;a href="/$'</span>+ fname + <span class="fstring">'/'</span> +old_base+x+<span class="fstring">'"&gt;'</span>+
<span class="lineno" id=line950></span>        <span class="small_keyword" title="conditional">if</span> x == <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">"(none)"</span> <span class="small_keyword" title="conditional">else</span> x <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line951></span>        <span class="fstring">'&lt;/a&gt;'</span>
<span class="lineno" id=line952></span>      ;
<span class="lineno" id=line953></span>      def <span class="big_keyword" title="Define a mutable variable">var</span> extn, <span class="big_keyword" title="Define a mutable variable">var</span> rest = <span class="small_keyword" title="match statement or expression">match</span> exts <span class="small_keyword" title="type-class constraint">with</span> | Cons(h,t)=&gt; h,t <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line954></span>      s+= <span class="fstring">'  &lt;a href="/$'</span>+ fname + <span class="fstring">'/'</span> +old_base+extn +<span class="fstring">'"&gt;'</span>+old_base+extn+<span class="fstring">'&lt;/a&gt;'</span>;
<span class="lineno" id=line955></span>      List::<span class="library" title="call procedure on each element of data structure">iter</span> (<span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (x:<span class="library" title="binding of C++ string type">string</span>){ s+=<span class="fstring">" "</span>+rf x; }) rest;
<span class="lineno" id=line956></span>    }
<span class="lineno" id=line957></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ft() { cft; s+=<span class="fstring">"\r\n"</span>; }
<span class="lineno" id=line958></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> twixt() { s+=<span class="fstring">"\r\n"</span>; }
<span class="lineno" id=line959></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cbrk () { cft; twixt; chd; }
<span class="lineno" id=line960></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> nxt() { 
<span class="lineno" id=line961></span>      <span class="small_keyword" title="match statement or expression">match</span> rest <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line962></span>      | Cons(h,t) =&gt; 
<span class="lineno" id=line963></span>        entry = h; rest = t;
<span class="lineno" id=line964></span>        base,extn =
<span class="lineno" id=line965></span>          <span class="small_keyword" title="match statement or expression">match</span> rfind (entry, <span class="fstring">"."</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line966></span>          | #None =&gt; entry, <span class="fstring">""</span> 
<span class="lineno" id=line967></span>          | Some pos =&gt; entry.[<span class="small_keyword" title="substring range separator">to</span> pos], entry.[pos <span class="small_keyword" title="substring range separator">to</span>]
<span class="lineno" id=line968></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line969></span>        ;
<span class="lineno" id=line970></span>      | #Empty =&gt; eof = <span class="library" title="truth value">true</span>;   
<span class="lineno" id=line971></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line972></span>    }
<span class="lineno" id=line973></span>  
<span class="lineno" id=line974></span>    <span class="comment">//special case for empty list</span>
<span class="lineno" id=line975></span>    <span class="small_keyword" title="conditional">if</span> <span class="library" title="number of elements in data structure">len</span> files == 0uz <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> <span class="fstring">""</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line976></span>  
<span class="lineno" id=line977></span>    nxt;                    <span class="comment">//prime the system</span>
<span class="lineno" id=line978></span>    hd;                     <span class="comment">// head off</span>
<span class="lineno" id=line979></span>  
<span class="lineno" id=line980></span>  again:&gt;
<span class="lineno" id=line981></span>    nxt;
<span class="lineno" id=line982></span>    <span class="small_keyword" title="conditional">if</span> eof <span class="small_keyword" title="jump to label">goto</span> fin;        <span class="comment">//check for eof</span>
<span class="lineno" id=line983></span>    <span class="small_keyword" title="conditional">if</span> base == old_base <span class="small_keyword" title="imperative code begins">do</span>  <span class="comment">//check for control break</span>
<span class="lineno" id=line984></span>      exts += extn;         <span class="comment">// nope, same key</span>
<span class="lineno" id=line985></span>    <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line986></span>      cbrk;                 <span class="comment">// key changed</span>
<span class="lineno" id=line987></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line988></span>    <span class="small_keyword" title="jump to label">goto</span> again;
<span class="lineno" id=line989></span>  fin:&gt;
<span class="lineno" id=line990></span>    ft;                     <span class="comment">// foot off</span>
<span class="lineno" id=line991></span>    <span class="small_keyword" title="return">return</span> s;
<span class="lineno" id=line992></span>  }
<span class="lineno" id=line993></span>  
<span class="lineno" id=line994></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_directory (k:socket_t, fname:<span class="library" title="binding of C++ string type">string</span>, get:bool) {
<span class="lineno" id=line995></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dirname = Filename::basename fname;
<span class="lineno" id=line996></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line997></span>    <span class="big_keyword" title="Define an immutable value">val</span> top = <span class="fstring">"A DIRECTORY "</span> + fname + <span class="fstring">"\r\n"</span>;
<span class="lineno" id=line998></span>    <span class="big_keyword" title="Define an immutable value">val</span> flist = 
<span class="lineno" id=line999></span>      <span class="small_keyword" title="match statement or expression">match</span> Directory::filesin fname <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1000></span>      | Some files =&gt;
<span class="lineno" id=line1001></span>        <span class="small_keyword" title="let binder">let</span> aux = 
<span class="lineno" id=line1002></span>            <span class="big_keyword" title="Define a function with no side-effects">fun</span> (ls2:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] * <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) (f:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line1003></span>            <span class="small_keyword" title="match statement or expression">match</span> ls2 <span class="small_keyword" title="type-class constraint">with</span> | ds,rs =&gt; <span class="small_keyword" title="match statement or expression">match</span> FileStat::filetype (Filename::join (fname,f)) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1004></span>              | #DIRECTORY =&gt; Cons (f,ds), rs
<span class="lineno" id=line1005></span>              | #REGULAR =&gt; ds, Cons (f,rs)
<span class="lineno" id=line1006></span>              | _ =&gt; ls2
<span class="lineno" id=line1007></span>              <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line1008></span>            <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line1009></span>        <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line1010></span>        <span class="small_keyword" title="let binder">let</span> dirs,regs = <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> aux (Empty[<span class="library" title="binding of C++ string type">string</span>], Empty[<span class="library" title="binding of C++ string type">string</span>]) files <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line1011></span>        <span class="small_keyword" title="let binder">let</span> dirs,regs = sort dirs, sort regs <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line1012></span>        <span class="small_keyword" title="let binder">let</span> dir_lines = mk_dir_lines (fname,dirs) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line1013></span>        <span class="small_keyword" title="let binder">let</span> reg_lines = mk_reg_lines (fname,regs) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line1014></span>          <span class="fstring">"&lt;pre&gt;"</span>+ 
<span class="lineno" id=line1015></span>          <span class="fstring">'  &lt;a href="/"&gt;&lt;em&gt;home&lt;/em&gt;&lt;/a&gt;\r\n'</span>+
<span class="lineno" id=line1016></span>          <span class="small_keyword" title="conditional">if</span> dir_lines.<span class="library" title="number of elements in data structure">len</span> != 0uz <span class="small_keyword" title="conditional">then</span> <span class="fstring">' Directories: \r\n'</span> + dir_lines <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line1017></span>          <span class="small_keyword" title="conditional">if</span> reg_lines.<span class="library" title="number of elements in data structure">len</span> != 0uz <span class="small_keyword" title="conditional">then</span> <span class="fstring">' Files: \r\n'</span> + reg_lines <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span> <span class="small_keyword" title="conditional">endif</span> +
<span class="lineno" id=line1018></span>          <span class="fstring">"&lt;/pre&gt;"</span>
<span class="lineno" id=line1019></span>      | #None =&gt; <span class="fstring">"ERROR ACCESSING DIRECTORY"</span>
<span class="lineno" id=line1020></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line1021></span>    ;
<span class="lineno" id=line1022></span>    <span class="big_keyword" title="Define an immutable value">val</span> page = make_html(top + flist,
<span class="lineno" id=line1023></span>      <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span>]((<span class="fstring">"Cache-control"</span>,<span class="fstring">"max-age=86400"</span>))
<span class="lineno" id=line1024></span>    );
<span class="lineno" id=line1025></span>    write_string(k,page,&amp;eof_flag);
<span class="lineno" id=line1026></span>  }
<span class="lineno" id=line1027></span>  
<span class="lineno" id=line1028></span>  
<span class="lineno" id=line1029></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_file(s: socket_t, infname: <span class="library" title="binding of C++ string type">string</span>) =&gt; serve (s, infname, <span class="library" title="truth value">true</span>);
<span class="lineno" id=line1030></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve_head(s: socket_t, infname: <span class="library" title="binding of C++ string type">string</span>) =&gt; serve (s,infname,<span class="library" title="false value">false</span>);
<span class="lineno" id=line1031></span>  
<span class="lineno" id=line1032></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> serve(s: socket_t, infname: <span class="library" title="binding of C++ string type">string</span>, get:bool)
<span class="lineno" id=line1033></span>  {
<span class="lineno" id=line1034></span>    <span class="big_keyword" title="Define a mutable variable">var</span> eof_flag = <span class="library" title="false value">false</span>;
<span class="lineno" id=line1035></span>    <span class="comment">// if empty string, serve index.html</span>
<span class="lineno" id=line1036></span>    <span class="comment">// not quite right - needs to handle directories too, so</span>
<span class="lineno" id=line1037></span>    <span class="comment">// not only foo.com/ -&gt; index.html, but foo.com/images/ -&gt; images/index.html</span>
<span class="lineno" id=line1038></span>    <span class="big_keyword" title="Define a mutable variable">var</span> fname = <span class="small_keyword" title="conditional">if</span> <span class="fstring">""</span> == infname <span class="small_keyword" title="conditional">then</span> <span class="fstring">"share/src/web/index.html"</span> <span class="small_keyword" title="conditional">else</span> infname <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line1039></span>  
<span class="lineno" id=line1040></span>    fname = 
<span class="lineno" id=line1041></span>      <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"$"</span> <span class="small_keyword" title="conditional">then</span> fname.[1 <span class="small_keyword" title="substring range separator">to</span>] 
<span class="lineno" id=line1042></span>      <span class="small_keyword" title="conditional">elif</span> fname.[0 <span class="small_keyword" title="substring range separator">to</span> 3] == <span class="fstring">"%24"</span> <span class="small_keyword" title="conditional">then</span> fname.[3 <span class="small_keyword" title="substring range separator">to</span>]  
<span class="lineno" id=line1043></span>      <span class="small_keyword" title="conditional">else</span> fname 
<span class="lineno" id=line1044></span>      <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line1045></span>    ;
<span class="lineno" id=line1046></span>  
<span class="lineno" id=line1047></span>    <span class="comment">// set mime type depending on extension...</span>
<span class="lineno" id=line1048></span>    <span class="comment">// serve a "not found page" for that case (check for recursion)</span>
<span class="lineno" id=line1049></span>    <span class="comment">//print "serve file: "; print fname; endl;</span>
<span class="lineno" id=line1050></span>  
<span class="lineno" id=line1051></span>    <span class="comment">// figure out the filetype</span>
<span class="lineno" id=line1052></span>    <span class="comment">// we first check if the filename has a suffix like cpp</span>
<span class="lineno" id=line1053></span>    <span class="comment">// which is a trick done by us to force the filetype</span>
<span class="lineno" id=line1054></span>    <span class="comment">// to be "c++" for C++ standard include file names </span>
<span class="lineno" id=line1055></span>    <span class="comment">// which have no suffix. If we find that, we strip it</span>
<span class="lineno" id=line1056></span>    <span class="comment">// out of the filename too. Otherwise we just find</span>
<span class="lineno" id=line1057></span>    <span class="comment">// the suffix.</span>
<span class="lineno" id=line1058></span>  
<span class="lineno" id=line1059></span>    <span class="big_keyword" title="Define a mutable variable">var</span> suffix = <span class="fstring">""</span>;
<span class="lineno" id=line1060></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> split_suffix (fname:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line1061></span>      <span class="small_keyword" title="match statement or expression">match</span> rfind (fname, <span class="fstring">"?"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1062></span>      | Some pos =&gt; fname.[pos + 1 <span class="small_keyword" title="substring range separator">to</span>], fname.[0 <span class="small_keyword" title="substring range separator">to</span> pos]
<span class="lineno" id=line1063></span>      | #None =&gt;
<span class="lineno" id=line1064></span>          <span class="small_keyword" title="match statement or expression">match</span> rfind (fname, <span class="fstring">"."</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1065></span>          | #None =&gt; <span class="fstring">""</span>,fname
<span class="lineno" id=line1066></span>          | Some pos =&gt; fname.[pos + 1 <span class="small_keyword" title="substring range separator">to</span>], fname
<span class="lineno" id=line1067></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line1068></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line1069></span>    ;
<span class="lineno" id=line1070></span>    suffix,fname = split_suffix fname;
<span class="lineno" id=line1071></span>  
<span class="lineno" id=line1072></span>    <span class="small_keyword" title="conditional">if</span> fname == <span class="fstring">"STOP"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1073></span>      run = <span class="library" title="false value">false</span>;
<span class="lineno" id=line1074></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"STOP DETECTED"</span>;
<span class="lineno" id=line1075></span>    <span class="small_keyword" title="conditional">elif</span> fname == <span class="fstring">"robots.txt"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1076></span>      serve_raw (s,INSTALL_ROOT + <span class="fstring">"/robots.txt"</span>,<span class="fstring">"txt"</span>, get);
<span class="lineno" id=line1077></span>    <span class="small_keyword" title="conditional">elif</span> suffix <span class="tex_symbol" title="\in">\(\in\)</span> <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">"flx"</span>,<span class="fstring">"flxh"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1078></span>      serve_felix(s, fname, get);
<span class="lineno" id=line1079></span>    <span class="small_keyword" title="conditional">elif</span> suffix <span class="tex_symbol" title="\in">\(\in\)</span> <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">"py"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1080></span>      serve_py(s, fname, get);
<span class="lineno" id=line1081></span>    <span class="small_keyword" title="conditional">elif</span> suffix <span class="tex_symbol" title="\in">\(\in\)</span> <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">"ml"</span>,<span class="fstring">"mli"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1082></span>      serve_ocaml(s, fname, get);
<span class="lineno" id=line1083></span>    <span class="small_keyword" title="conditional">elif</span> suffix <span class="tex_symbol" title="\in">\(\in\)</span> <span class="library" title="functional, singly linked list">list</span>(<span class="fstring">"cpp"</span>,<span class="fstring">"hpp"</span>,<span class="fstring">"h"</span>,<span class="fstring">"c"</span>,<span class="fstring">"cc"</span>,<span class="fstring">"i"</span>,<span class="fstring">"cxx"</span>,<span class="fstring">"rtti"</span>,<span class="fstring">"includes"</span>,<span class="fstring">"ctors_cpp"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1084></span>      serve_cpp(s, fname, get);
<span class="lineno" id=line1085></span>    <span class="small_keyword" title="conditional">elif</span> suffix == <span class="fstring">"fpc"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1086></span>      serve_fpc(s, fname, get);
<span class="lineno" id=line1087></span>    <span class="small_keyword" title="conditional">elif</span> suffix == <span class="fstring">"html"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line1088></span>      serve_xhtml(s, fname, get);
<span class="lineno" id=line1089></span>    <span class="small_keyword" title="conditional">elif</span> suffix <span class="tex_symbol" title="\in">\(\in\)</span> (<span class="fstring">"html"</span>,<span class="fstring">"htm"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1090></span>      fname = <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="conditional">then</span> fname <span class="small_keyword" title="conditional">else</span> INSTALL_ROOT+<span class="fstring">"/"</span>+fname <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line1091></span>      serve_html(s,fname, get);
<span class="lineno" id=line1092></span>    <span class="small_keyword" title="conditional">elif</span> suffix == <span class="fstring">"xhtml"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1093></span>      fname = <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="conditional">then</span> fname <span class="small_keyword" title="conditional">else</span> INSTALL_ROOT+<span class="fstring">"/"</span>+fname <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line1094></span>      serve_xhtml(s,fname, get);
<span class="lineno" id=line1095></span>    <span class="small_keyword" title="conditional">elif</span> suffix <span class="tex_symbol" title="\in">\(\in\)</span> text_suffices <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1096></span>      fname = <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="conditional">then</span> fname <span class="small_keyword" title="conditional">else</span> INSTALL_ROOT+<span class="fstring">"/"</span>+fname <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line1097></span>      serve_text(s,fname, get);
<span class="lineno" id=line1098></span>    <span class="small_keyword" title="conditional">elif</span> suffix <span class="tex_symbol" title="\in">\(\in\)</span> (<span class="fstring">"gif"</span>,<span class="fstring">"png"</span>,<span class="fstring">"jpg"</span>,<span class="fstring">"svg"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1099></span>      fname = <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="conditional">then</span> fname <span class="small_keyword" title="conditional">else</span> INSTALL_ROOT+<span class="fstring">"/"</span>+fname <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line1100></span>      serve_image(s,fname,suffix, get);
<span class="lineno" id=line1101></span>    <span class="small_keyword" title="conditional">elif</span> suffix == <span class="fstring">"css"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1102></span>      <span class="comment">// path lookup for css files</span>
<span class="lineno" id=line1103></span>      fname = <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="conditional">then</span> fname <span class="small_keyword" title="conditional">else</span> INSTALL_ROOT+<span class="fstring">"/"</span>+fname <span class="small_keyword" title="conditional">endif</span>;
<span class="lineno" id=line1104></span>      serve_css(s,fname,suffix, get);
<span class="lineno" id=line1105></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1106></span>      <span class="small_keyword" title="match statement or expression">match</span> get_file(fname, INSTALL_ROOT,Empty[<span class="library" title="binding of C++ string type">string</span>]) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1107></span>      | #None =&gt; serve_not_found(s,fname, get);
<span class="lineno" id=line1108></span>      | Some f =&gt;
<span class="lineno" id=line1109></span>          <span class="small_keyword" title="conditional">if</span> prefix(fname,<span class="fstring">"/etc"</span>) <span class="small_keyword" title="imperative code begins">do</span> serve_forbidden(s,fname, get);
<span class="lineno" id=line1110></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line1111></span>          <span class="small_keyword" title="match statement or expression">match</span> FileStat::filetype f <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1112></span>          | #REGULAR =&gt; serve_raw(s,f,suffix, get);
<span class="lineno" id=line1113></span>          | #DIRECTORY =&gt; serve_directory (s,f, get);
<span class="lineno" id=line1114></span>          | _ =&gt; serve_not_found(s,f, get); 
<span class="lineno" id=line1115></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line1116></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1117></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line1118></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1119></span>  }
<span class="lineno" id=line1120></span>  <span class="big_keyword" title="Define an immutable value">val</span> webby_port = PORT;
<span class="lineno" id=line1121></span>  <span class="big_keyword" title="Define a mutable variable">var</span> run = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line1122></span>  
<span class="lineno" id=line1123></span>  <span class="library" title="Print a string to standard output">print</span> <span class="fstring">"FLX WEB!!! listening on port "</span>; <span class="library" title="Print a string to standard output">print</span> webby_port; endl;
<span class="lineno" id=line1124></span>  
<span class="lineno" id=line1125></span>  <span class="comment">// up the queue len for stress testing</span>
<span class="lineno" id=line1126></span>  <span class="big_keyword" title="Define a mutable variable">var</span> p = webby_port;
<span class="lineno" id=line1127></span>  <span class="big_keyword" title="Define a mutable variable">var</span> listener: socket_t;
<span class="lineno" id=line1128></span>  mk_listener(&amp;listener, &amp;p, 10);
<span class="lineno" id=line1129></span>  
<span class="lineno" id=line1130></span>  <span class="big_keyword" title="Define a mutable variable">var</span> clock = Faio::mk_alarm_clock();
<span class="lineno" id=line1131></span>  
<span class="lineno" id=line1132></span>  <span class="comment">// noinline is necessary to stop the closure being</span>
<span class="lineno" id=line1133></span>  <span class="comment">// inlined into the loop, preventing the socket variable k</span>
<span class="lineno" id=line1134></span>  <span class="comment">// being duplicated as it must be [a bug in Felix]</span>
<span class="lineno" id=line1135></span>  <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handler (<span class="big_keyword" title="Define a mutable variable">var</span> k:socket_t) ()
<span class="lineno" id=line1136></span>  {
<span class="lineno" id=line1137></span>    <span class="comment">//dbg$ "Spawned fthread running for socket "+str k+"\n";</span>
<span class="lineno" id=line1138></span>    <span class="comment">// should spawn fthread here to allow for more io overlap</span>
<span class="lineno" id=line1139></span>    <span class="comment">//dbg$ "here we go .. read a line\n";</span>
<span class="lineno" id=line1140></span>  
<span class="lineno" id=line1141></span>    <span class="big_keyword" title="Define a mutable variable">var</span> line: <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line1142></span>    get_line(k, &amp;line);  <span class="comment">// should be the GET line.</span>
<span class="lineno" id=line1143></span>    <span class="comment">//dbg$ "Got a line from socket " + str k + "\n";</span>
<span class="lineno" id=line1144></span>    <span class="comment">//cat(s, DEVNULL);</span>
<span class="lineno" id=line1145></span>  
<span class="lineno" id=line1146></span>  
<span class="lineno" id=line1147></span>    <span class="comment">// now I need to parse the GET line, get a file name out of its url</span>
<span class="lineno" id=line1148></span>    <span class="comment">// (e.g. unqualfied -&gt; index.html and name/flx.jpg -&gt; flx.jpg</span>
<span class="lineno" id=line1149></span>    <span class="big_keyword" title="Define a mutable variable">var</span> req = parse_request_type line;
<span class="lineno" id=line1150></span>  
<span class="lineno" id=line1151></span>    <span class="small_keyword" title="match statement or expression">match</span> req <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1152></span>    | #reqGET =&gt;
<span class="lineno" id=line1153></span>      <span class="small_keyword" title="match statement or expression">match</span> parse_get_line line <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1154></span>      | Some (base, file) =&gt; 
<span class="lineno" id=line1155></span>        <span class="library" title="Print a string to standard output">print</span> <span class="fstring">"file="</span>; <span class="library" title="Print a string to standard output">print</span> file; endl;
<span class="lineno" id=line1156></span>        serve_file(k,file);
<span class="lineno" id=line1157></span>      | #None =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"BAD GET line: '"</span>+line+<span class="fstring">"'"</span>;
<span class="lineno" id=line1158></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line1159></span>    | #reqHEAD =&gt;
<span class="lineno" id=line1160></span>      <span class="small_keyword" title="match statement or expression">match</span> parse_get_line line <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line1161></span>      | Some (base, file) =&gt; 
<span class="lineno" id=line1162></span>        <span class="library" title="Print a string to standard output">print</span> <span class="fstring">"file="</span>; <span class="library" title="Print a string to standard output">print</span> file; endl;
<span class="lineno" id=line1163></span>        serve_head(k,file);
<span class="lineno" id=line1164></span>      | #None =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"BAD HEAD line: '"</span>+line+<span class="fstring">"'"</span>;
<span class="lineno" id=line1165></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line1166></span>    | #reqPOST =&gt;
<span class="lineno" id=line1167></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unsupported POST; line: '"</span>+line+<span class="fstring">"'"</span>;        
<span class="lineno" id=line1168></span>    | #reqERROR =&gt;
<span class="lineno" id=line1169></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"BAD request line: '"</span>+line+<span class="fstring">"'"</span>;
<span class="lineno" id=line1170></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line1171></span>  
<span class="lineno" id=line1172></span>  broken:&gt;
<span class="lineno" id=line1173></span>  
<span class="lineno" id=line1174></span>    <span class="comment">// we've only read the GET line, so let's flush out the rest of</span>
<span class="lineno" id=line1175></span>    <span class="comment">// the http request so we don't get connection reset errors when</span>
<span class="lineno" id=line1176></span>    <span class="comment">// we close the socket. shutting down stops cat blocking (?)</span>
<span class="lineno" id=line1177></span>    <span class="comment">//Faio_posix::shutdown(s, 1); // disallow further sends.</span>
<span class="lineno" id=line1178></span>    <span class="comment">//cat(s, DEVNULL);</span>
<span class="lineno" id=line1179></span>  
<span class="lineno" id=line1180></span>    <span class="comment">//fprint$ cstderr,"fthread socket "+str k+" close delay ..\n";</span>
<span class="lineno" id=line1181></span>    Faio::sleep(clock,DELAY); <span class="comment">// give OS time to empty its buffers</span>
<span class="lineno" id=line1182></span>    <span class="comment">//fprint$ cstderr,"fthread socket "+str k+" shutdown now\n";</span>
<span class="lineno" id=line1183></span>  
<span class="lineno" id=line1184></span>  <span class="comment">// try this:</span>
<span class="lineno" id=line1185></span>  <span class="comment">// Advised by: koettermarkus@gmx.de, MANY THANKS!</span>
<span class="lineno" id=line1186></span>  
<span class="lineno" id=line1187></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> hack_recv: socket_t * &amp;<span class="library" title="binding of C char type">char</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C int type">int</span> -&gt; <span class="library" title="binding of C int type">int</span> = <span class="fstring">"recv($1,$2,$3,$4)"</span>;
<span class="lineno" id=line1188></span>  
<span class="lineno" id=line1189></span>    <span class="big_keyword" title="Define a mutable variable">var</span> buf:<span class="library" title="binding of C char type">char</span> ^1025;
<span class="lineno" id=line1190></span>    <span class="big_keyword" title="Define a mutable variable">var</span> counter = 0;
<span class="lineno" id=line1191></span>    <span class="big_keyword" title="Define a mutable variable">var</span> extra = 0;
<span class="lineno" id=line1192></span>    shutdown(k,1); <span class="comment">// shutdown read</span>
<span class="lineno" id=line1193></span>  retry:&gt;
<span class="lineno" id=line1194></span>    <span class="big_keyword" title="Define a mutable variable">var</span> b = hack_recv(k,<span class="hack">C_hack</span>::cast[&amp;<span class="library" title="binding of C char type">char</span>] (&amp;buf),1024,0);
<span class="lineno" id=line1195></span>    <span class="comment">//println$ "Error code " + str b + " from read after shutdown";</span>
<span class="lineno" id=line1196></span>    <span class="small_keyword" title="conditional">if</span> b &gt; 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1197></span>      extra += b;
<span class="lineno" id=line1198></span>      <span class="small_keyword" title="conditional">if</span> extra &gt; 2000 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1199></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Read too many extraneous bytes from OS buffer"</span>;
<span class="lineno" id=line1200></span>        <span class="small_keyword" title="jump to label">goto</span> force_close;
<span class="lineno" id=line1201></span>       <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line1202></span>     <span class="small_keyword" title="jump to label">goto</span> retry;
<span class="lineno" id=line1203></span>    <span class="small_keyword" title="conditional">elif</span> b == -1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1204></span>      ++counter;
<span class="lineno" id=line1205></span>      <span class="small_keyword" title="conditional">if</span> counter &gt; 200 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1206></span>        <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"Timeout waiting for write buffers to be flushed"</span>;
<span class="lineno" id=line1207></span>        <span class="small_keyword" title="jump to label">goto</span> force_close;
<span class="lineno" id=line1208></span>      <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line1209></span>      Faio::sleep(clock,0.1); <span class="comment">// 100 ms</span>
<span class="lineno" id=line1210></span>      <span class="small_keyword" title="jump to label">goto</span> retry;
<span class="lineno" id=line1211></span>    <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line1212></span>    <span class="big_keyword" title="Run time assertion">assert</span> b==0;
<span class="lineno" id=line1213></span>  
<span class="lineno" id=line1214></span>  force_close:&gt; 
<span class="lineno" id=line1215></span>    Socket::shutdown(k,2);
<span class="lineno" id=line1216></span>    ioclose(k);
<span class="lineno" id=line1217></span>    <span class="comment">//fprint$ stderr,"fthread "+str k+" terminating!\n";</span>
<span class="lineno" id=line1218></span>  };
<span class="lineno" id=line1219></span>  
<span class="lineno" id=line1220></span>  <span class="big_keyword" title="Spawn a cooperative fibre">spawn_fthread</span> { <span class="small_keyword" title="while loop">while</span> run <span class="small_keyword" title="imperative code begins">do</span> Faio::sleep(clock, 60.0); collect(); <span class="small_keyword" title="end of body">done</span> };
<span class="lineno" id=line1221></span>  <span class="small_keyword" title="while loop">while</span> run <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line1222></span>    <span class="big_keyword" title="Define a mutable variable">var</span> s: socket_t;
<span class="lineno" id=line1223></span>    <span class="comment">//dbg$ "Waiting for connection\n";</span>
<span class="lineno" id=line1224></span>    accept(listener, &amp;s);  <span class="comment">// blocking</span>
<span class="lineno" id=line1225></span>    <span class="comment">//dbg$ "got connection "+str s + "\n";  // error check here</span>
<span class="lineno" id=line1226></span>  
<span class="lineno" id=line1227></span>    <span class="comment">// hmm - spawning an fthread is blocking the web server. don't know why</span>
<span class="lineno" id=line1228></span>    <span class="comment">//dbg$ "spawning fthread to handle connection "+str s+"\n";</span>
<span class="lineno" id=line1229></span>    <span class="big_keyword" title="Define a mutable variable">var</span> h = handler s;
<span class="lineno" id=line1230></span>    <span class="big_keyword" title="Spawn a cooperative fibre">spawn_fthread</span>  h;
<span class="lineno" id=line1231></span>   <span class="comment">//collect(); // this hangs everything, no idea why!</span>
<span class="lineno" id=line1232></span>  <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line1233></span>  
<span class="lineno" id=line1234></span>  <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"WEB SERVER FINNISHED?"</span>;
<span class="lineno" id=line1235></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Closing listener socket "</span> + <span class="library" title="Convert a value to a string">str</span> listener;
<span class="lineno" id=line1236></span>  iclose (listener);
</pre></p></div><h2 id='Mainline_with_preloaded_plugins._h'><img src='/share/src/web/images/minus.gif' id='Mainline with preloaded plugins.' onclick='toggle(this,"Mainline_with_preloaded_plugins._d")' alt='+'/> 1.2 Mainline with preloaded plugins.</h2><div id='Mainline_with_preloaded_plugins._d' style='display:block'>
<pre class='inclusion'>
$PWD/src/tools/flx_web.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// webserver plugin linker</span>
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> WebserverPluginSymbols 
<span class="lineno" id=line4></span>  {
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>    <span class="comment">// We have to do this dummy requirements because static</span>
<span class="lineno" id=line7></span>    <span class="comment">// linking removes</span>
<span class="lineno" id=line8></span>    <span class="big_keyword" title="specify requirements">requires</span> <span class="small_keyword" title="specifies an abstract package name">package</span> <span class="fstring">"re2"</span>;
<span class="lineno" id=line9></span>    <span class="big_keyword" title="specify requirements">requires</span> <span class="small_keyword" title="specifies an abstract package name">package</span> <span class="fstring">"faio"</span>;
<span class="lineno" id=line10></span>    <span class="big_keyword" title="specify requirements">requires</span> <span class="small_keyword" title="specifies an abstract package name">package</span> <span class="fstring">"flx_arun"</span>;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Open a module or class">open</span> Dynlink;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>    <span class="comment">// Now add all the symbols.</span>
<span class="lineno" id=line15></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> addsymbols ()
<span class="lineno" id=line16></span>    {
<span class="lineno" id=line17></span>      static-link-plugin 
<span class="lineno" id=line18></span>        html2html,
<span class="lineno" id=line19></span>        flx2html,
<span class="lineno" id=line20></span>        fpc2html,
<span class="lineno" id=line21></span>        py2html,
<span class="lineno" id=line22></span>        ocaml2html,
<span class="lineno" id=line23></span>        cpp2html,
<span class="lineno" id=line24></span>        html_scanner,
<span class="lineno" id=line25></span>        html_slideshow,
<span class="lineno" id=line26></span>        html_heading,
<span class="lineno" id=line27></span>        html_fileseq,
<span class="lineno" id=line28></span>        html_paragraph,
<span class="lineno" id=line29></span>        html_button,
<span class="lineno" id=line30></span>        html_frame,
<span class="lineno" id=line31></span>        html_edit,
<span class="lineno" id=line32></span>        toc_menu
<span class="lineno" id=line33></span>      ;
<span class="lineno" id=line34></span>      <span class="comment">// webserver</span>
<span class="lineno" id=line35></span>      static-link-symbol dflx_web_create_thread_frame <span class="small_keyword" title="membership operator, function mem">in</span> plugin dflx_web;
<span class="lineno" id=line36></span>      static-link-symbol dflx_web_flx_start <span class="small_keyword" title="membership operator, function mem">in</span> plugin dflx_web;
<span class="lineno" id=line37></span>      
<span class="lineno" id=line38></span>    }
<span class="lineno" id=line39></span>  }
<span class="lineno" id=line40></span>  
<span class="lineno" id=line41></span>  <span class="comment">// Add the symbols</span>
<span class="lineno" id=line42></span>  WebserverPluginSymbols::addsymbols;
<span class="lineno" id=line43></span>  
<span class="lineno" id=line44></span>  <span class="comment">// Now invoke the webserver!</span>
<span class="lineno" id=line45></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Running webserver"</span>;
<span class="lineno" id=line46></span>  <span class="big_keyword" title="Define an immutable value">val</span> linstance =  Dynlink::prepare_lib(<span class="fstring">"dflx_web"</span>);
<span class="lineno" id=line47></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Webserver prepared"</span>;
<span class="lineno" id=line48></span>  <span class="big_keyword" title="Define a mutable variable">var</span> init: cont = Dynlink::get_init linstance;
<span class="lineno" id=line49></span>  
<span class="lineno" id=line50></span>  Fibres::chain init;
<span class="lineno" id=line51></span>  
</pre></p></div></div><h1 id='Language_Translators._h'><img src='/share/src/web/images/minus.gif' id='Language Translators.' onclick='toggle(this,"Language_Translators._d")' alt='+'/> 2 Language Translators.</h1><div id='Language_Translators._d' style='display:block'>
<h2 id='Felix_Package_Config_<code>fpc</code>_format._h'><img src='/share/src/web/images/minus.gif' id='Felix Package Config <code>fpc</code> format.' onclick='toggle(this,"Felix_Package_Config_<code>fpc</code>_format._d")' alt='+'/> 2.1 Felix Package Config <code>fpc</code> format.</h2><div id='Felix_Package_Config_<code>fpc</code>_format._d' style='display:block'>
<pre class='inclusion'>
share/lib/plugins/fpc2html.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PKGCONFIG_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a mutable variable">var</span> INSTALL_ROOT = <span class="fstring">""</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Define a mutable variable">var</span> C_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_file (<span class="big_keyword" title="Define a mutable variable">var</span> fname:<span class="library" title="binding of C++ string type">string</span>, path:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) = {
<span class="lineno" id=line8></span>    <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"$"</span> <span class="small_keyword" title="imperative code begins">do</span> fname = fname.[1 <span class="small_keyword" title="substring range separator">to</span>]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line9></span>    <span class="small_keyword" title="conditional">if</span> FileStat::fileexists fname <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> Some fname;
<span class="lineno" id=line10></span>    <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line11></span>      <span class="big_keyword" title="Define a mutable variable">var</span> f = Filename::join(INSTALL_ROOT,fname);
<span class="lineno" id=line12></span>      <span class="small_keyword" title="conditional">if</span> FileStat::fileexists f <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> Some f;
<span class="lineno" id=line13></span>      <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="return">return</span> FileSystem::find_in_path (fname, path);
<span class="lineno" id=line14></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line15></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line16></span>  }
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>  <span class="big_keyword" title="Define a module namespace">module</span> Fpc2Html 
<span class="lineno" id=line21></span>  {
<span class="lineno" id=line22></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> xlat_fpc(t:<span class="library" title="binding of C++ string type">string</span>, dir:<span class="library" title="binding of C++ string type">string</span>) : bool * <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line23></span>  {
<span class="lineno" id=line24></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"formatting fpc data"</span>;
<span class="lineno" id=line25></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line26></span>    <span class="big_keyword" title="Define an immutable value">val</span> lines = split(t,<span class="fstring">"\n"</span>);
<span class="lineno" id=line27></span>    <span class="library" title="call procedure on each element of data structure">iter</span> handle_line lines;
<span class="lineno" id=line28></span>    <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>, out;
<span class="lineno" id=line29></span>  
<span class="lineno" id=line30></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handle_line(s:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line31></span>      <span class="small_keyword" title="match statement or expression">match</span> split(s,<span class="fstring">":"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line32></span>      | Cons(fn,Cons(fv,Empty))  =&gt;
<span class="lineno" id=line33></span>        { 
<span class="lineno" id=line34></span>          out+= <span class="fstring">"&lt;span class=fpc_fieldname&gt;"</span>+fn+<span class="fstring">": &lt;/span&gt;"</span>;
<span class="lineno" id=line35></span>          <span class="small_keyword" title="conditional">if</span> fn <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">"Requires"</span>,<span class="fstring">"flx_requires_driver"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line36></span>            <span class="big_keyword" title="Define a mutable variable">var</span> pkgs=split$ fv.strip, <span class="fstring">" "</span>;
<span class="lineno" id=line37></span>            <span class="library" title="call procedure on each element of data structure">iter</span> handle_pkg pkgs;
<span class="lineno" id=line38></span>            out+=<span class="fstring">"\n"</span>;
<span class="lineno" id=line39></span>          <span class="small_keyword" title="conditional">elif</span> fn == <span class="fstring">"includes"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line40></span>            <span class="big_keyword" title="Define a mutable variable">var</span> includes=split$ fv.strip, <span class="fstring">" "</span>;
<span class="lineno" id=line41></span>            <span class="library" title="call procedure on each element of data structure">iter</span> handle_include includes;
<span class="lineno" id=line42></span>            out+=<span class="fstring">"\n"</span>;
<span class="lineno" id=line43></span>          <span class="small_keyword" title="conditional">else</span> out+= fv+<span class="fstring">"\n"</span>; 
<span class="lineno" id=line44></span>          <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line45></span>        }
<span class="lineno" id=line46></span>      | x =&gt; { out+=s + <span class="fstring">"\n"</span>; }
<span class="lineno" id=line47></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line48></span>    }
<span class="lineno" id=line49></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handle_pkg(s:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line50></span>      <span class="small_keyword" title="match statement or expression">match</span> get_file(s+<span class="fstring">".fpc"</span>,FLX_PKGCONFIG_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line51></span>      | Some path =&gt; { out += <span class="fstring">'&lt;a href="/$'</span> + path + <span class="fstring">'"&gt;'</span> + s + <span class="fstring">'&lt;/a&gt; '</span>; }
<span class="lineno" id=line52></span>      | #None =&gt; { out += s + <span class="fstring">" "</span>; }
<span class="lineno" id=line53></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line54></span>    }
<span class="lineno" id=line55></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handle_include(s:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line56></span>      <span class="big_keyword" title="Define a mutable variable">var</span> n = s;
<span class="lineno" id=line57></span>      <span class="small_keyword" title="while loop">while</span> n.[0] <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span>, <span class="library" title="binding of C char type">char</span> <span class="fstring">'&lt;'</span>, <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span>) <span class="small_keyword" title="imperative code begins">do</span> n=n.[1 <span class="small_keyword" title="substring range separator">to</span>]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line58></span>      <span class="small_keyword" title="while loop">while</span> n.[-1] <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span>,<span class="library" title="binding of C char type">char</span> <span class="fstring">'&gt;'</span>,<span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span>) <span class="small_keyword" title="imperative code begins">do</span> n=n.[<span class="small_keyword" title="substring range separator">to</span> -1]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line59></span>      <span class="small_keyword" title="match statement or expression">match</span> get_file(n,C_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line60></span>      | Some path =&gt; { out += <span class="fstring">'&lt;a href="/$'</span> + path + <span class="fstring">'"&gt;'</span> + s + <span class="fstring">'&lt;/a&gt; '</span>; }
<span class="lineno" id=line61></span>      | #None =&gt; { out += s + <span class="fstring">" "</span>; }
<span class="lineno" id=line62></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line63></span>    }
<span class="lineno" id=line64></span>  }
<span class="lineno" id=line65></span>  }
<span class="lineno" id=line66></span>  
<span class="lineno" id=line67></span>  <span class="comment">//eprintln$ Version::felix_version+"Fpc2html initialisation";</span>
<span class="lineno" id=line68></span>  
<span class="lineno" id=line69></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line70></span>    <span class="big_keyword" title="Define a mutable variable">var</span> config_lines = split(config_data, <span class="fstring">"\n"</span>);
<span class="lineno" id=line71></span>    config_lines = <span class="library" title="return data structure with function applied to each value">map</span> (strip of (<span class="library" title="binding of C++ string type">string</span>)) config_lines; 
<span class="lineno" id=line72></span>    <span class="big_keyword" title="Define a mutable variable">var</span> pathext = RE2(<span class="fstring">"(.*)\\+=(.*)"</span>);
<span class="lineno" id=line73></span>    <span class="big_keyword" title="Define a mutable variable">var</span> varset = RE2(<span class="fstring">"(.*)=(.*)"</span>);
<span class="lineno" id=line74></span>    <span class="big_keyword" title="Define a mutable variable">var</span> plugin_spec = RE2 <span class="fstring">" *extension (.*)-&gt;(.*)::(.*)"</span>;
<span class="lineno" id=line75></span>  
<span class="lineno" id=line76></span>    <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (4.<span class="library" title="binding of C size_t type">size</span>,StringPiece(<span class="fstring">""</span>));
<span class="lineno" id=line77></span>    <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> config_lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line78></span>      <span class="big_keyword" title="Define a mutable variable">var</span> match_result = Match(pathext, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line79></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line80></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line81></span>        <span class="big_keyword" title="Define a mutable variable">var</span> rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line82></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line83></span>        | <span class="fstring">"FLX_PATH"</span> =&gt; FLX_PATH += rhs; 
<span class="lineno" id=line84></span>        | <span class="fstring">"C_PATH"</span> =&gt; C_PATH += rhs; 
<span class="lineno" id=line85></span>        | <span class="fstring">"FLX_PKGCONFIG_PATH"</span> =&gt; FLX_PKGCONFIG_PATH += rhs;
<span class="lineno" id=line86></span>        | _ =&gt; ;
<span class="lineno" id=line87></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line88></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line89></span>      match_result = Match(varset, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line90></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line91></span>        lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line92></span>        rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line93></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line94></span>        | <span class="fstring">"INSTALL_ROOT"</span> =&gt; INSTALL_ROOT = rhs;
<span class="lineno" id=line95></span>        | _ =&gt; ;
<span class="lineno" id=line96></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line97></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line98></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line99></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line100></span>  }
<span class="lineno" id=line101></span>  
<span class="lineno" id=line102></span>  
<span class="lineno" id=line103></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"fpc2html_setup"</span>;
<span class="lineno" id=line104></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> Fpc2Html::xlat_fpc of (<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"fpc2html"</span>;
<span class="lineno" id=line105></span>  
</pre></p></div><h2 id='Ocaml_h'><img src='/share/src/web/images/minus.gif' id='Ocaml' onclick='toggle(this,"Ocaml_d")' alt='+'/> 2.2 Ocaml</h2><div id='Ocaml_d' style='display:block'>
<pre class='inclusion'>
share/lib/plugins/ocaml2html.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// Ocaml</span>
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Define a module namespace">module</span> Ocaml2Html {
<span class="lineno" id=line3></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> big_keywords = 
<span class="lineno" id=line4></span>    <span class="fstring">"module"</span>,
<span class="lineno" id=line5></span>    <span class="fstring">"functor"</span>,
<span class="lineno" id=line6></span>    <span class="fstring">"open"</span>,
<span class="lineno" id=line7></span>    <span class="fstring">"type"</span>,
<span class="lineno" id=line8></span>    <span class="fstring">"class"</span>,
<span class="lineno" id=line9></span>    <span class="fstring">"struct"</span>,
<span class="lineno" id=line10></span>    <span class="fstring">"end"</span>,
<span class="lineno" id=line11></span>    <span class="fstring">"val"</span>,
<span class="lineno" id=line12></span>    <span class="fstring">"inherit"</span>,
<span class="lineno" id=line13></span>    <span class="fstring">"exception"</span>
<span class="lineno" id=line14></span>  ;
<span class="lineno" id=line15></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> small_keywords =
<span class="lineno" id=line16></span>    <span class="fstring">"if"</span>, <span class="fstring">"then"</span>, <span class="fstring">"else"</span>, <span class="fstring">"elif"</span>, <span class="fstring">"endif"</span>, <span class="fstring">"do"</span>, <span class="fstring">"done"</span>,
<span class="lineno" id=line17></span>    <span class="fstring">"let"</span>, <span class="fstring">"in"</span>, <span class="fstring">"for"</span>, <span class="fstring">"while"</span>, <span class="fstring">"to"</span>, <span class="fstring">"upto"</span>,<span class="fstring">"downto"</span>,
<span class="lineno" id=line18></span>    <span class="fstring">"try"</span>,<span class="fstring">"match"</span>,<span class="fstring">"with"</span>,<span class="fstring">"fun"</span>,<span class="fstring">"function"</span>,
<span class="lineno" id=line19></span>    <span class="fstring">"begin"</span>,<span class="fstring">"end"</span>
<span class="lineno" id=line20></span>  ;
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> qualifiers = 
<span class="lineno" id=line23></span>    <span class="fstring">"virtual"</span>, <span class="fstring">"private"</span>
<span class="lineno" id=line24></span>  ;
<span class="lineno" id=line25></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> hack = <span class="fstring">"C_hack"</span>,<span class="fstring">"C_hack"</span>; <span class="comment">// to make it an array we need 2 components</span>
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> xlat_ocaml(t:<span class="library" title="binding of C++ string type">string</span>, dir:<span class="library" title="binding of C++ string type">string</span>) : bool * <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line29></span>  {
<span class="lineno" id=line30></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line31></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> write_string(t:<span class="library" title="binding of C++ string type">string</span>) 
<span class="lineno" id=line32></span>    { 
<span class="lineno" id=line33></span>     out += t;
<span class="lineno" id=line34></span>    }
<span class="lineno" id=line35></span>  
<span class="lineno" id=line36></span>    variant state_t = 
<span class="lineno" id=line37></span>      | sot <span class="comment">// start of token</span>
<span class="lineno" id=line38></span>      | id <span class="comment">// processing identifier</span>
<span class="lineno" id=line39></span>      | num <span class="comment">// in a number</span>
<span class="lineno" id=line40></span>      | dq <span class="comment">// processing double quote string</span>
<span class="lineno" id=line41></span>      | ccomment <span class="comment">// a C style comment</span>
<span class="lineno" id=line42></span>    ;
<span class="lineno" id=line43></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span>(s:state_t) =&gt; <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line44></span>    | #sot =&gt; <span class="fstring">"sot"</span>
<span class="lineno" id=line45></span>    | #id =&gt; <span class="fstring">"id"</span>
<span class="lineno" id=line46></span>    | #num =&gt; <span class="fstring">"num"</span>
<span class="lineno" id=line47></span>    | #dq =&gt; <span class="fstring">"dq"</span>
<span class="lineno" id=line48></span>    | #ccomment =&gt; <span class="fstring">"ccomment"</span>
<span class="lineno" id=line49></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line50></span>    
<span class="lineno" id=line51></span>    <span class="big_keyword" title="Define a mutable variable">var</span> i = 0; <span class="big_keyword" title="Define a mutable variable">var</span> s:state_t;
<span class="lineno" id=line52></span>    <span class="big_keyword" title="Define a mutable variable">var</span> ch = t.[i];
<span class="lineno" id=line53></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> next() { ch = t.[i]; ++i; }
<span class="lineno" id=line54></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> ahead (j:<span class="library" title="binding of C int type">int</span>)=&gt; t.[i + j - 1]; 
<span class="lineno" id=line55></span>  
<span class="lineno" id=line56></span>    <span class="big_keyword" title="Define a mutable variable">var</span> b = <span class="fstring">""</span>;
<span class="lineno" id=line57></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_id = <span class="fstring">""</span>;
<span class="lineno" id=line58></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_op = <span class="fstring">""</span>;
<span class="lineno" id=line59></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cp() { b += ch; }
<span class="lineno" id=line60></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ws() {
<span class="lineno" id=line61></span>       write_string(<span class="fstring">'&lt;span class=fstring&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line62></span>    }
<span class="lineno" id=line63></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> w() { 
<span class="lineno" id=line64></span>      <span class="comment">//println$ "Token["+str s+"]="+b; </span>
<span class="lineno" id=line65></span>      <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line66></span>      | #dq =&gt; ws; 
<span class="lineno" id=line67></span>      | #ccomment =&gt; write_string(<span class="fstring">'&lt;span class=comment&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>);
<span class="lineno" id=line68></span>      | #id =&gt; 
<span class="lineno" id=line69></span>          last_id = b;
<span class="lineno" id=line70></span>          <span class="small_keyword" title="conditional">if</span> b <span class="small_keyword" title="membership operator, function mem">in</span> big_keywords <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class=big_keyword&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line71></span>          <span class="small_keyword" title="conditional">elif</span> b <span class="small_keyword" title="membership operator, function mem">in</span> small_keywords <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class=small_keyword&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line72></span>          <span class="small_keyword" title="conditional">elif</span> b <span class="small_keyword" title="membership operator, function mem">in</span> qualifiers <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class=qualifier&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line73></span>          <span class="small_keyword" title="conditional">elif</span> isupper b.[0] <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class=ctor&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line74></span>          <span class="small_keyword" title="conditional">else</span> write_string(b); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line75></span>      | _ =&gt;
<span class="lineno" id=line76></span>          last_op=b; 
<span class="lineno" id=line77></span>          <span class="small_keyword" title="conditional">if</span> b == <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line78></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line79></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line80></span>          <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line81></span>          write_string(b);  
<span class="lineno" id=line82></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line83></span>      b = <span class="fstring">""</span>;  
<span class="lineno" id=line84></span>    }
<span class="lineno" id=line85></span>  
<span class="lineno" id=line86></span>  
<span class="lineno" id=line87></span>    <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line88></span>  
<span class="lineno" id=line89></span>  contin:&gt; <span class="comment">// copy char and continue</span>
<span class="lineno" id=line90></span>    cp();
<span class="lineno" id=line91></span>    <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line92></span>     
<span class="lineno" id=line93></span>  overrun:&gt; <span class="comment">// one past last char of token</span>
<span class="lineno" id=line94></span>    w();
<span class="lineno" id=line95></span>    s = sot;
<span class="lineno" id=line96></span>    <span class="small_keyword" title="jump to label">goto</span> thisch;
<span class="lineno" id=line97></span>  
<span class="lineno" id=line98></span>  lastch:&gt; <span class="comment">// last char of token</span>
<span class="lineno" id=line99></span>    cp();
<span class="lineno" id=line100></span>    w();
<span class="lineno" id=line101></span>  
<span class="lineno" id=line102></span>  nextt:&gt;  <span class="comment">// new token on next char</span>
<span class="lineno" id=line103></span>    s = sot;
<span class="lineno" id=line104></span>  
<span class="lineno" id=line105></span>  nextch:&gt; <span class="comment">// next char</span>
<span class="lineno" id=line106></span>    next();
<span class="lineno" id=line107></span>  
<span class="lineno" id=line108></span>  thisch:&gt; <span class="comment">// same char, reconsider it</span>
<span class="lineno" id=line109></span>    <span class="comment">//println$ "Considering char " + str(ord(ch));</span>
<span class="lineno" id=line110></span>    <span class="small_keyword" title="conditional">if</span> isnull ch <span class="small_keyword" title="jump to label">goto</span> fin; <span class="comment">// out of data</span>
<span class="lineno" id=line111></span>    <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line112></span>    | #sot =&gt;
<span class="lineno" id=line113></span>        <span class="small_keyword" title="conditional">if</span> isidstart ch <span class="small_keyword" title="imperative code begins">do</span> s = id; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line114></span>        <span class="small_keyword" title="conditional">elif</span> isdigit ch <span class="small_keyword" title="imperative code begins">do</span> s = num; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line115></span>        <span class="small_keyword" title="conditional">elif</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> s = dq; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line116></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"("</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line117></span>          <span class="small_keyword" title="conditional">if</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"*"</span> <span class="small_keyword" title="imperative code begins">do</span> cp; next; s = ccomment; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line118></span>          <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line119></span>          <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line120></span>        <span class="small_keyword" title="conditional">else</span> cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line121></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line122></span>  
<span class="lineno" id=line123></span>    | #id =&gt; 
<span class="lineno" id=line124></span>        <span class="small_keyword" title="conditional">if</span> iscamlidcont ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line125></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun;
<span class="lineno" id=line126></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line127></span>    | #num =&gt; 
<span class="lineno" id=line128></span>        <span class="small_keyword" title="conditional">if</span> isnumeric ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line129></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun; 
<span class="lineno" id=line130></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line131></span>    | #dq =&gt;
<span class="lineno" id=line132></span>        <span class="small_keyword" title="conditional">if</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line133></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;lt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line134></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line135></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;amp;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line136></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line137></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line138></span>     <span class="comment">// comments</span>
<span class="lineno" id=line139></span>    | #ccomment =&gt; <span class="comment">// doesn't handle nested comments yet</span>
<span class="lineno" id=line140></span>        <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"*"</span> <span class="small_keyword" title="logical conjunction">and</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">")"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line141></span>          cp; 
<span class="lineno" id=line142></span>          <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line143></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line144></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line145></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line146></span>    ; 
<span class="lineno" id=line147></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unexpected drop thru"</span>;
<span class="lineno" id=line148></span>  
<span class="lineno" id=line149></span>  fin:&gt;
<span class="lineno" id=line150></span>     <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"outof data"</span>;
<span class="lineno" id=line151></span>     w(); <span class="comment">// whatever is left over gets written</span>
<span class="lineno" id=line152></span>     <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>, out;
<span class="lineno" id=line153></span>  }
<span class="lineno" id=line154></span>  }
<span class="lineno" id=line155></span>  
<span class="lineno" id=line156></span>  
<span class="lineno" id=line157></span>  <span class="comment">//eprintln$ Version::felix_version+"ocaml2html initialisation";</span>
<span class="lineno" id=line158></span>  
<span class="lineno" id=line159></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(x:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line160></span>    <span class="hack">C_hack</span>::ignore(x); <span class="comment">// which means, don't ignore it!</span>
<span class="lineno" id=line161></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line162></span>  }
<span class="lineno" id=line163></span>  
<span class="lineno" id=line164></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"ocaml2html_setup"</span>;
<span class="lineno" id=line165></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> Ocaml2Html::xlat_ocaml of (<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"ocaml2html"</span>;
<span class="lineno" id=line166></span>  
</pre></p></div><h2 id='Python_h'><img src='/share/src/web/images/minus.gif' id='Python' onclick='toggle(this,"Python_d")' alt='+'/> 2.3 Python</h2><div id='Python_d' style='display:block'>
<pre class='inclusion'>
share/lib/plugins/py2html.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  
<span class="lineno" id=line2></span>  <span class="comment">// Python </span>
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a module namespace">module</span> Py2Html {
<span class="lineno" id=line4></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> big_keywords = 
<span class="lineno" id=line5></span>    <span class="fstring">"def"</span>,
<span class="lineno" id=line6></span>    <span class="fstring">"class"</span>,
<span class="lineno" id=line7></span>    <span class="fstring">"import"</span>
<span class="lineno" id=line8></span>  ;
<span class="lineno" id=line9></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> small_keywords =
<span class="lineno" id=line10></span>    <span class="fstring">"if"</span>, <span class="fstring">"while"</span>, <span class="fstring">"for"</span>, <span class="fstring">"return"</span>, <span class="fstring">"in"</span>, <span class="fstring">"from"</span>,<span class="fstring">"else"</span>,<span class="fstring">"elsif"</span>,<span class="fstring">"except"</span>,<span class="fstring">"try"</span>,
<span class="lineno" id=line11></span>    <span class="fstring">"not"</span>,<span class="fstring">"with"</span>,<span class="fstring">"raise"</span>
<span class="lineno" id=line12></span>  ;
<span class="lineno" id=line13></span>  
<span class="lineno" id=line14></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> qualifiers = 
<span class="lineno" id=line15></span>    <span class="fstring">"None"</span>, <span class="fstring">"True"</span>, <span class="fstring">"False"</span>, <span class="fstring">"pass"</span>,<span class="fstring">"self"</span>
<span class="lineno" id=line16></span>  ;
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> xlat_py(t:<span class="library" title="binding of C++ string type">string</span>, dir:<span class="library" title="binding of C++ string type">string</span>) : bool * <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line20></span>  {
<span class="lineno" id=line21></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line22></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> write_string(t:<span class="library" title="binding of C++ string type">string</span>) 
<span class="lineno" id=line23></span>    { 
<span class="lineno" id=line24></span>     out += t;
<span class="lineno" id=line25></span>    }
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>    variant state_t = 
<span class="lineno" id=line28></span>      | sot <span class="comment">// start of token</span>
<span class="lineno" id=line29></span>      | id <span class="comment">// processing identifier</span>
<span class="lineno" id=line30></span>      | num <span class="comment">// in a number</span>
<span class="lineno" id=line31></span>      | sq <span class="comment">// processing single quote string</span>
<span class="lineno" id=line32></span>      | dq <span class="comment">// processing double quote string</span>
<span class="lineno" id=line33></span>      | sq3 <span class="comment">// processing single quote string</span>
<span class="lineno" id=line34></span>      | dq3 <span class="comment">// processing double quote string</span>
<span class="lineno" id=line35></span>      | cppcomment <span class="comment">// a C++ style comment</span>
<span class="lineno" id=line36></span>    ;
<span class="lineno" id=line37></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span>(s:state_t) =&gt; <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line38></span>    | #sot =&gt; <span class="fstring">"sot"</span>
<span class="lineno" id=line39></span>    | #id =&gt; <span class="fstring">"id"</span>
<span class="lineno" id=line40></span>    | #num =&gt; <span class="fstring">"num"</span>
<span class="lineno" id=line41></span>    | #sq =&gt; <span class="fstring">"sq"</span>
<span class="lineno" id=line42></span>    | #dq =&gt; <span class="fstring">"dq"</span>
<span class="lineno" id=line43></span>    | #sq3 =&gt; <span class="fstring">"sq3"</span>
<span class="lineno" id=line44></span>    | #dq3 =&gt; <span class="fstring">"dq3"</span>
<span class="lineno" id=line45></span>    | #cppcomment =&gt; <span class="fstring">"cppcomment"</span>
<span class="lineno" id=line46></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line47></span>    
<span class="lineno" id=line48></span>    <span class="big_keyword" title="Define a mutable variable">var</span> i = 0; <span class="big_keyword" title="Define a mutable variable">var</span> s:state_t;
<span class="lineno" id=line49></span>    <span class="big_keyword" title="Define a mutable variable">var</span> ch = t.[i];
<span class="lineno" id=line50></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> next() { ch = t.[i]; ++i; }
<span class="lineno" id=line51></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> ahead (j:<span class="library" title="binding of C int type">int</span>)=&gt; t.[i + j - 1]; 
<span class="lineno" id=line52></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> issq3() =&gt; 
<span class="lineno" id=line53></span>      ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical conjunction">and</span> 
<span class="lineno" id=line54></span>      ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical conjunction">and</span>
<span class="lineno" id=line55></span>      ahead(2) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> 
<span class="lineno" id=line56></span>    ;
<span class="lineno" id=line57></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> isdq3() =&gt; 
<span class="lineno" id=line58></span>      ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span>  <span class="small_keyword" title="logical conjunction">and</span>
<span class="lineno" id=line59></span>      ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="logical conjunction">and</span>
<span class="lineno" id=line60></span>      ahead(2) == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> 
<span class="lineno" id=line61></span>    ;
<span class="lineno" id=line62></span>  
<span class="lineno" id=line63></span>    <span class="big_keyword" title="Define a mutable variable">var</span> b = <span class="fstring">""</span>;
<span class="lineno" id=line64></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_id = <span class="fstring">""</span>;
<span class="lineno" id=line65></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_op = <span class="fstring">""</span>;
<span class="lineno" id=line66></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cp() { b += ch; }
<span class="lineno" id=line67></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ws() {
<span class="lineno" id=line68></span>       write_string(<span class="fstring">'&lt;span class=fstring&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line69></span>    }
<span class="lineno" id=line70></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> w() { 
<span class="lineno" id=line71></span>      <span class="comment">//println$ "Token["+str s+"]="+b; </span>
<span class="lineno" id=line72></span>      <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line73></span>      | #dq =&gt;  ws; 
<span class="lineno" id=line74></span>      | #sq =&gt;  ws; 
<span class="lineno" id=line75></span>      | #sq3 =&gt;  ws; 
<span class="lineno" id=line76></span>      | #dq3 =&gt;  ws; 
<span class="lineno" id=line77></span>      | #cppcomment =&gt; write_string(<span class="fstring">'&lt;span class=comment&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line78></span>      | #id =&gt; 
<span class="lineno" id=line79></span>          last_id = b;
<span class="lineno" id=line80></span>          <span class="small_keyword" title="conditional">if</span> b <span class="small_keyword" title="membership operator, function mem">in</span> big_keywords <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class=big_keyword&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line81></span>          <span class="small_keyword" title="conditional">elif</span> b <span class="small_keyword" title="membership operator, function mem">in</span> small_keywords <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class=small_keyword&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line82></span>          <span class="small_keyword" title="conditional">elif</span> b <span class="small_keyword" title="membership operator, function mem">in</span> qualifiers <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class=qualifier&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line83></span>          <span class="small_keyword" title="conditional">else</span> write_string(b); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line84></span>      | _ =&gt;
<span class="lineno" id=line85></span>          last_op=b; 
<span class="lineno" id=line86></span>          <span class="small_keyword" title="conditional">if</span> b == <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line87></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line88></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line89></span>          <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line90></span>          write_string(b);  
<span class="lineno" id=line91></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line92></span>      b = <span class="fstring">""</span>;  
<span class="lineno" id=line93></span>    }
<span class="lineno" id=line94></span>  
<span class="lineno" id=line95></span>  
<span class="lineno" id=line96></span>    <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line97></span>  
<span class="lineno" id=line98></span>  contin:&gt; <span class="comment">// copy char and continue</span>
<span class="lineno" id=line99></span>    cp();
<span class="lineno" id=line100></span>    <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line101></span>     
<span class="lineno" id=line102></span>  overrun:&gt; <span class="comment">// one past last char of token</span>
<span class="lineno" id=line103></span>    w();
<span class="lineno" id=line104></span>    s = sot;
<span class="lineno" id=line105></span>    <span class="small_keyword" title="jump to label">goto</span> thisch;
<span class="lineno" id=line106></span>  
<span class="lineno" id=line107></span>  lastch:&gt; <span class="comment">// last char of token</span>
<span class="lineno" id=line108></span>    cp();
<span class="lineno" id=line109></span>    w();
<span class="lineno" id=line110></span>  
<span class="lineno" id=line111></span>  nextt:&gt;  <span class="comment">// new token on next char</span>
<span class="lineno" id=line112></span>    s = sot;
<span class="lineno" id=line113></span>  
<span class="lineno" id=line114></span>  nextch:&gt; <span class="comment">// next char</span>
<span class="lineno" id=line115></span>    next();
<span class="lineno" id=line116></span>  
<span class="lineno" id=line117></span>  thisch:&gt; <span class="comment">// same char, reconsider it</span>
<span class="lineno" id=line118></span>    <span class="comment">//println$ "Considering char " + str(ord(ch));</span>
<span class="lineno" id=line119></span>    <span class="small_keyword" title="conditional">if</span> isnull ch <span class="small_keyword" title="jump to label">goto</span> fin; <span class="comment">// out of data</span>
<span class="lineno" id=line120></span>    <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line121></span>    | #sot =&gt;
<span class="lineno" id=line122></span>        <span class="small_keyword" title="conditional">if</span> isidstart ch <span class="small_keyword" title="imperative code begins">do</span> s = id; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line123></span>        <span class="small_keyword" title="conditional">elif</span> isdigit ch <span class="small_keyword" title="imperative code begins">do</span> s = num; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line124></span>        <span class="small_keyword" title="conditional">elif</span> issq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; s = sq3; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line125></span>        <span class="small_keyword" title="conditional">elif</span> isdq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; s = dq3; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line126></span>        <span class="small_keyword" title="conditional">elif</span> issq ch <span class="small_keyword" title="imperative code begins">do</span> s = sq; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line127></span>        <span class="small_keyword" title="conditional">elif</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> s = dq; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line128></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"#"</span> <span class="small_keyword" title="imperative code begins">do</span> s = cppcomment; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line129></span>        <span class="small_keyword" title="conditional">else</span> cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line130></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line131></span>  
<span class="lineno" id=line132></span>    | #id =&gt; 
<span class="lineno" id=line133></span>        <span class="small_keyword" title="conditional">if</span> isalphanum ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line134></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun;
<span class="lineno" id=line135></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line136></span>    | #num =&gt; 
<span class="lineno" id=line137></span>        <span class="small_keyword" title="conditional">if</span> isnumeric ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line138></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun; 
<span class="lineno" id=line139></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line140></span>    <span class="comment">// single quoted strings</span>
<span class="lineno" id=line141></span>    | #sq =&gt;
<span class="lineno" id=line142></span>        <span class="small_keyword" title="conditional">if</span> issq ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch; 
<span class="lineno" id=line143></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;lt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line144></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line145></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;amp;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line146></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line147></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line148></span>    | #dq =&gt;
<span class="lineno" id=line149></span>        <span class="small_keyword" title="conditional">if</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line150></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;lt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line151></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line152></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;amp;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line153></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line154></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line155></span>     <span class="comment">// triple quoted strings</span>
<span class="lineno" id=line156></span>    | #sq3 =&gt;
<span class="lineno" id=line157></span>        <span class="small_keyword" title="conditional">if</span> issq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt; 
<span class="lineno" id=line158></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;lt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line159></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line160></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;amp;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line161></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line162></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line163></span>    | #dq3 =&gt;
<span class="lineno" id=line164></span>        <span class="small_keyword" title="conditional">if</span> isdq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line165></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;lt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line166></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line167></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;amp;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line168></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line169></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line170></span>     <span class="comment">// comments</span>
<span class="lineno" id=line171></span>    | #cppcomment =&gt;
<span class="lineno" id=line172></span>        <span class="small_keyword" title="conditional">if</span> iseol ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line173></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line174></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line175></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line176></span>    ; 
<span class="lineno" id=line177></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unexpected drop thru"</span>;
<span class="lineno" id=line178></span>  
<span class="lineno" id=line179></span>  fin:&gt;
<span class="lineno" id=line180></span>     <span class="library" title="Print a string to standard output with newline appended">println</span> <span class="fstring">"outof data"</span>;
<span class="lineno" id=line181></span>     w(); <span class="comment">// whatever is left over gets written</span>
<span class="lineno" id=line182></span>     <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>, out;
<span class="lineno" id=line183></span>  }
<span class="lineno" id=line184></span>  }
<span class="lineno" id=line185></span>  
<span class="lineno" id=line186></span>  <span class="comment">//eprintln$ Version::felix_version+"Py2html initialisation";</span>
<span class="lineno" id=line187></span>  
<span class="lineno" id=line188></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(x:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line189></span>    <span class="hack">C_hack</span>::ignore(x); <span class="comment">// which means, don't ignore it .. :)</span>
<span class="lineno" id=line190></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line191></span>  }
<span class="lineno" id=line192></span>  
<span class="lineno" id=line193></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"py2html_setup"</span>;
<span class="lineno" id=line194></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> Py2Html::xlat_py of (<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"py2html"</span>;
<span class="lineno" id=line195></span>  
<span class="lineno" id=line196></span>  
</pre></p></div><h2 id='Felix_<code>flx</code>_format._h'><img src='/share/src/web/images/minus.gif' id='Felix <code>flx</code> format.' onclick='toggle(this,"Felix_<code>flx</code>_format._d")' alt='+'/> 2.4 Felix <code>flx</code> format.</h2><div id='Felix_<code>flx</code>_format._d' style='display:block'>
<pre class='inclusion'>
share/lib/plugins/flx2html.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./plugin_common"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="comment">// fixup text by replacing &lt; &gt; and &amp; characters</span>
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> txt2html (x:<span class="library" title="binding of C++ string type">string</span>) =
<span class="lineno" id=line5></span>  {
<span class="lineno" id=line6></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out2 = <span class="fstring">""</span>;
<span class="lineno" id=line7></span>    <span class="small_keyword" title="for loop">for</span> <span class="big_keyword" title="Define a mutable variable">var</span> i <span class="small_keyword" title="membership operator, function mem">in</span> 0 <span class="small_keyword" title="upwards counting for loop">upto</span> x.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> - 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line8></span>      <span class="big_keyword" title="Define a mutable variable">var</span> ch = x.[i];
<span class="lineno" id=line9></span>      <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line10></span>      <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line11></span>      <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line12></span>      <span class="small_keyword" title="conditional">else</span> out2+=ch;
<span class="lineno" id=line13></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line14></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line15></span>  
<span class="lineno" id=line16></span>    <span class="small_keyword" title="return">return</span> out2;
<span class="lineno" id=line17></span>  }
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>  <span class="big_keyword" title="Define a mutable variable">var</span> INSTALL_ROOT = <span class="fstring">""</span>;
<span class="lineno" id=line20></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PKGCONFIG_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line21></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line22></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_WEBSERVER_PLUGIN_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>  <span class="big_keyword" title="Define a mutable variable">var</span> xlat_cpp: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; bool * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line25></span>  
<span class="lineno" id=line26></span>  <span class="comment">// stick line numbers in front of each line (for hyperlinking source refs)</span>
<span class="lineno" id=line27></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> lc (x:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line28></span>    <span class="big_keyword" title="Define a mutable variable">var</span> lines = unbox (<span class="library" title="return data structure with elements reversed">rev</span>
<span class="lineno" id=line29></span>      <span class="small_keyword" title="match statement or expression">match</span> unbox (rev_split (x,<span class="fstring">"\n"</span>)) <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line30></span>      | Cons (<span class="fstring">""</span>,t) =&gt; t
<span class="lineno" id=line31></span>      | x =&gt; x
<span class="lineno" id=line32></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>)
<span class="lineno" id=line33></span>    ;
<span class="lineno" id=line34></span>    
<span class="lineno" id=line35></span>    <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="fstring">""</span>;
<span class="lineno" id=line36></span>    reserve (&amp;<span class="small_keyword" title="value of function return used in post condition">result</span>, <span class="library" title="number of elements in data structure">len</span> x + 50.<span class="library" title="binding of C size_t type">size</span> * <span class="library" title="number of elements in data structure">len</span> lines);
<span class="lineno" id=line37></span>    <span class="big_keyword" title="Define a mutable variable">var</span> count = 0;
<span class="lineno" id=line38></span>    <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line39></span>      ++count;
<span class="lineno" id=line40></span>      <span class="small_keyword" title="value of function return used in post condition">result</span> += <span class="fstring">'&lt;span class="lineno" id=line'</span>+count.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'&gt;&lt;/span&gt;'</span>;
<span class="lineno" id=line41></span>      <span class="small_keyword" title="value of function return used in post condition">result</span> += <span class="fstring">'  '</span> +line+<span class="fstring">'\n'</span>;
<span class="lineno" id=line42></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line43></span>    <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line44></span>  }
<span class="lineno" id=line45></span>  
<span class="lineno" id=line46></span>  <span class="comment">// Felix</span>
<span class="lineno" id=line47></span>  <span class="big_keyword" title="Define a module namespace">module</span> Flx2Html {
<span class="lineno" id=line48></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> big_keywords = 
<span class="lineno" id=line49></span>    (<span class="fstring">"chip"</span>,<span class="fstring">'defines a coroutine using chip idiom'</span>),
<span class="lineno" id=line50></span>    (<span class="fstring">"export"</span>,<span class="fstring">'generate extern "C" wrapper'</span>),
<span class="lineno" id=line51></span>    (<span class="fstring">"macro"</span>,<span class="fstring">"prefix for macro definitions"</span>),
<span class="lineno" id=line52></span>    (<span class="fstring">"module"</span>,<span class="fstring">"Define a module namespace"</span>),
<span class="lineno" id=line53></span>    (<span class="fstring">"cfun"</span>,<span class="fstring">"Define a C function"</span>),
<span class="lineno" id=line54></span>    (<span class="fstring">"cproc"</span>,<span class="fstring">"Define a C procedure"</span>),
<span class="lineno" id=line55></span>    (<span class="fstring">"fun"</span>,<span class="fstring">"Define a function with no side-effects"</span>),
<span class="lineno" id=line56></span>    (<span class="fstring">"enum"</span>,<span class="fstring">"Elaborate an enumeration, a simple sum type"</span>),
<span class="lineno" id=line57></span>    (<span class="fstring">"cenum"</span>,<span class="fstring">"Lift an enumeration of integers from C"</span>),
<span class="lineno" id=line58></span>    (<span class="fstring">"cflags"</span>,<span class="fstring">"Lift an enumeration of flags from C"</span>),
<span class="lineno" id=line59></span>    (<span class="fstring">"gen"</span>,<span class="fstring">"Define a generator, a function with side-effects returning a value"</span>),
<span class="lineno" id=line60></span>    (<span class="fstring">"proc"</span>,<span class="fstring">"Define a procedure, a function with side-effects not returning a value"</span>),
<span class="lineno" id=line61></span>    (<span class="fstring">"ctor"</span>,<span class="fstring">"Define a value constructor or conversion operator for a type"</span>),
<span class="lineno" id=line62></span>    (<span class="fstring">"type"</span>,<span class="fstring">"Define a primitive type by binding to a C type"</span>),
<span class="lineno" id=line63></span>    (<span class="fstring">"ctypes"</span>,<span class="fstring">"Define a set of primitive type by binding to C types with the same name"</span>),
<span class="lineno" id=line64></span>    (<span class="fstring">"union"</span>,<span class="fstring">"Define a union of variants (alternatives)"</span>),
<span class="lineno" id=line65></span>    (<span class="fstring">"struct"</span>,<span class="fstring">"Define a structure"</span>),
<span class="lineno" id=line66></span>    (<span class="fstring">"cstruct"</span>,<span class="fstring">"Provide a model for an existing C struct"</span>),
<span class="lineno" id=line67></span>    (<span class="fstring">"typedef"</span>,<span class="fstring">"Define an alias for a type expression"</span>),
<span class="lineno" id=line68></span>    (<span class="fstring">"var"</span>,<span class="fstring">"Define a mutable variable"</span>),
<span class="lineno" id=line69></span>    (<span class="fstring">"val"</span>,<span class="fstring">"Define an immutable value"</span>),
<span class="lineno" id=line70></span>    (<span class="fstring">"class"</span>,<span class="fstring">"Define a type class"</span>),
<span class="lineno" id=line71></span>    (<span class="fstring">"const"</span>,<span class="fstring">"Bind a Felix symbol to a C expression"</span>),
<span class="lineno" id=line72></span>    (<span class="fstring">"instance"</span>,<span class="fstring">"Provide an instance of a typeclass"</span>),
<span class="lineno" id=line73></span>    (<span class="fstring">"header"</span>,<span class="fstring">"Specify C code to be inserted into header file"</span>),
<span class="lineno" id=line74></span>    (<span class="fstring">"body"</span>,<span class="fstring">"Specify C code to be inserted into implementation file"</span>),
<span class="lineno" id=line75></span>    (<span class="fstring">"include"</span>,<span class="fstring">"Include a Felix file"</span>),
<span class="lineno" id=line76></span>    (<span class="fstring">"spawn_fthread"</span>,<span class="fstring">"Spawn a cooperative fibre"</span>),
<span class="lineno" id=line77></span>    (<span class="fstring">"spawn_pthread"</span>,<span class="fstring">"Spawn a pre-emptive thread"</span>),
<span class="lineno" id=line78></span>    (<span class="fstring">"reduce"</span>, <span class="fstring">"Specify a reduction"</span>),
<span class="lineno" id=line79></span>    (<span class="fstring">"axiom"</span>, <span class="fstring">"Specify core semantics"</span>),
<span class="lineno" id=line80></span>    (<span class="fstring">"assert"</span>, <span class="fstring">"Run time assertion"</span>),
<span class="lineno" id=line81></span>    (<span class="fstring">"open"</span>, <span class="fstring">"Open a module or class"</span>),
<span class="lineno" id=line82></span>    (<span class="fstring">"inherit"</span>,<span class="fstring">"Inherit symbols into a module or typeclass"</span>),
<span class="lineno" id=line83></span>    (<span class="fstring">"rename"</span>,<span class="fstring">"create a new name for a symbol"</span>),
<span class="lineno" id=line84></span>    (<span class="fstring">"use"</span>,<span class="fstring">"put the basename of a qualified name in the current scope"</span>),
<span class="lineno" id=line85></span>    (<span class="fstring">"SCHEME"</span>,<span class="fstring">"Define Scheme symbols"</span>),
<span class="lineno" id=line86></span>    (<span class="fstring">"syntax"</span>,<span class="fstring">"define domain specific sublanguage module"</span>),
<span class="lineno" id=line87></span>    (<span class="fstring">"regdef"</span>,<span class="fstring">"define named regular expression"</span>),
<span class="lineno" id=line88></span>    (<span class="fstring">"literal"</span>,<span class="fstring">"define literal"</span>),
<span class="lineno" id=line89></span>    (<span class="fstring">"priority"</span>,<span class="fstring">"Define order of syntactic priority symbols"</span>),
<span class="lineno" id=line90></span>    (<span class="fstring">"requires"</span>,<span class="fstring">"specify requirements"</span>),
<span class="lineno" id=line91></span>    (<span class="fstring">"object"</span>,<span class="fstring">"define an object factory"</span>),
<span class="lineno" id=line92></span>    (<span class="fstring">"interface"</span>,<span class="fstring">"define an object interface"</span>),
<span class="lineno" id=line93></span>    (<span class="fstring">"try"</span>,<span class="fstring">"try block"</span>),
<span class="lineno" id=line94></span>    (<span class="fstring">"catch"</span>,<span class="fstring">"catch handler"</span>),
<span class="lineno" id=line95></span>    (<span class="fstring">"endtry"</span>,<span class="fstring">"end of try block"</span>),
<span class="lineno" id=line96></span>    (<span class="fstring">"halt"</span>, <span class="fstring">"terminate program with message"</span>)
<span class="lineno" id=line97></span>  ;
<span class="lineno" id=line98></span>  
<span class="lineno" id=line99></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> small_keywords =
<span class="lineno" id=line100></span>    (<span class="fstring">"circuit"</span>,<span class="fstring">'defines the topology of chip connections'</span>),
<span class="lineno" id=line101></span>    (<span class="fstring">"endcircuit"</span>,<span class="fstring">'defines the topology of chip connections'</span>),
<span class="lineno" id=line102></span>    (<span class="fstring">"connect"</span>,<span class="fstring">'connects two pins with a channel'</span>),
<span class="lineno" id=line103></span>    (<span class="fstring">"connector"</span>,<span class="fstring">"the parameter of a chip"</span>), 
<span class="lineno" id=line104></span>    (<span class="fstring">"pin"</span>,<span class="fstring">"a field of the chip parameter"</span>), 
<span class="lineno" id=line105></span>    (<span class="fstring">"device"</span>,<span class="fstring">"a synonym for var to suit the chip idiom"</span>), 
<span class="lineno" id=line106></span>    (<span class="fstring">"if"</span>,<span class="fstring">"conditional"</span>), 
<span class="lineno" id=line107></span>    (<span class="fstring">"then"</span>,<span class="fstring">"conditional"</span>), 
<span class="lineno" id=line108></span>    (<span class="fstring">"else"</span>,<span class="fstring">"conditional"</span>), 
<span class="lineno" id=line109></span>    (<span class="fstring">"elif"</span>,<span class="fstring">"conditional"</span>), 
<span class="lineno" id=line110></span>    (<span class="fstring">"endif"</span>,<span class="fstring">"conditional"</span>), 
<span class="lineno" id=line111></span>    (<span class="fstring">"do"</span>,<span class="fstring">"imperative code begins"</span>), 
<span class="lineno" id=line112></span>    (<span class="fstring">"done"</span>,<span class="fstring">"end of body"</span>),
<span class="lineno" id=line113></span>    (<span class="fstring">"extend"</span>,<span class="fstring">"define an object interface"</span>),
<span class="lineno" id=line114></span>    (<span class="fstring">"begin"</span>,<span class="fstring">"end of extension"</span>),
<span class="lineno" id=line115></span>    (<span class="fstring">"end"</span>,<span class="fstring">"end of extension"</span>),
<span class="lineno" id=line116></span>    (<span class="fstring">"in"</span>, <span class="fstring">"membership operator, function mem"</span>),
<span class="lineno" id=line117></span>    (<span class="fstring">"for"</span>, <span class="fstring">"for loop"</span>),
<span class="lineno" id=line118></span>    (<span class="fstring">"while"</span>,<span class="fstring">"while loop"</span>),
<span class="lineno" id=line119></span>    (<span class="fstring">"to"</span>, <span class="fstring">"substring range separator"</span>),
<span class="lineno" id=line120></span>    (<span class="fstring">"upto"</span>,<span class="fstring">"upwards counting for loop"</span>),
<span class="lineno" id=line121></span>    (<span class="fstring">"downto"</span>,<span class="fstring">"downwards counting for loop"</span>),
<span class="lineno" id=line122></span>    (<span class="fstring">"typematch"</span>,<span class="fstring">"type match expression"</span>),
<span class="lineno" id=line123></span>    (<span class="fstring">"match"</span>,<span class="fstring">"match statement or expression"</span>),
<span class="lineno" id=line124></span>    (<span class="fstring">"endmatch"</span>,<span class="fstring">"end a match statement or expression"</span>),
<span class="lineno" id=line125></span>    (<span class="fstring">"with"</span>, <span class="fstring">"type-class constraint"</span>),
<span class="lineno" id=line126></span>    (<span class="fstring">"return"</span>,<span class="fstring">"return"</span>),
<span class="lineno" id=line127></span>    (<span class="fstring">"yield"</span>,<span class="fstring">"return a value saving the current location for future resumption"</span>),
<span class="lineno" id=line128></span>    (<span class="fstring">"goto"</span>,<span class="fstring">"jump to label"</span>),
<span class="lineno" id=line129></span>    (<span class="fstring">"goto-indirect"</span>,<span class="fstring">"jump to code address"</span>),
<span class="lineno" id=line130></span>    (<span class="fstring">"branch-and-link"</span>,<span class="fstring">"low level exchange of control"</span>),
<span class="lineno" id=line131></span>    (<span class="fstring">"call"</span>,<span class="fstring">"call a procedure"</span>),
<span class="lineno" id=line132></span>    (<span class="fstring">"jump"</span>,<span class="fstring">"tail call of function"</span>),
<span class="lineno" id=line133></span>    (<span class="fstring">"loop"</span>,<span class="fstring">"self-tail call"</span>),
<span class="lineno" id=line134></span>    (<span class="fstring">"package"</span>,<span class="fstring">"specifies an abstract package name"</span>),
<span class="lineno" id=line135></span>    (<span class="fstring">"when"</span>, <span class="fstring">"predicative type constraint or precondition"</span>),
<span class="lineno" id=line136></span>    (<span class="fstring">"result"</span>,<span class="fstring">"value of function return used in post condition"</span>),
<span class="lineno" id=line137></span>    (<span class="fstring">"expect"</span>,<span class="fstring">"post condition"</span>),
<span class="lineno" id=line138></span>    (<span class="fstring">"for"</span>,<span class="fstring">"for loop"</span>),
<span class="lineno" id=line139></span>    (<span class="fstring">"ident"</span>,<span class="fstring">"identifier macro"</span>),
<span class="lineno" id=line140></span>    (<span class="fstring">"noexpand"</span>,<span class="fstring">"inhibit macro expansion"</span>),
<span class="lineno" id=line141></span>    (<span class="fstring">"typesetof"</span>,<span class="fstring">"a set of types"</span>),
<span class="lineno" id=line142></span>    (<span class="fstring">"code"</span>,<span class="fstring">"literal C code insertion"</span>),
<span class="lineno" id=line143></span>    (<span class="fstring">"extends"</span>,<span class="fstring">"extend an object or interface with extra methods"</span>),
<span class="lineno" id=line144></span>    (<span class="fstring">"implements"</span>,<span class="fstring">"specify what interfaces an object implements"</span>), 
<span class="lineno" id=line145></span>    (<span class="fstring">"encoder"</span>,<span class="fstring">"serialisation encoder"</span>),
<span class="lineno" id=line146></span>    (<span class="fstring">"decoder"</span>,<span class="fstring">"serialisation decoder"</span>),
<span class="lineno" id=line147></span>    (<span class="fstring">"caseno"</span>,<span class="fstring">"Integer index of value of a sum type"</span>),
<span class="lineno" id=line148></span>    (<span class="fstring">"case"</span>,<span class="fstring">"Sum type selector"</span>),
<span class="lineno" id=line149></span>    (<span class="fstring">"proj"</span>,<span class="fstring">"Product projection"</span>),
<span class="lineno" id=line150></span>    (<span class="fstring">"let"</span>,<span class="fstring">"let binder"</span>),
<span class="lineno" id=line151></span>    (<span class="fstring">"label_address"</span>,<span class="fstring">"code address at a label"</span>),
<span class="lineno" id=line152></span>    (<span class="fstring">"and"</span>,<span class="fstring">"logical conjunction"</span>),
<span class="lineno" id=line153></span>    (<span class="fstring">"or"</span>,<span class="fstring">"logical disjunction"</span>),
<span class="lineno" id=line154></span>    (<span class="fstring">"not"</span>,<span class="fstring">"logical negation"</span>),
<span class="lineno" id=line155></span>    (<span class="fstring">"implies"</span>,<span class="fstring">"logical implication"</span>),
<span class="lineno" id=line156></span>    (<span class="fstring">"until"</span>,<span class="fstring">"loop until condition is met"</span>),
<span class="lineno" id=line157></span>    (<span class="fstring">"invariant"</span>,<span class="fstring">"establish invariant for object methods"</span>)
<span class="lineno" id=line158></span>  ;
<span class="lineno" id=line159></span>  
<span class="lineno" id=line160></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> qualifiers = 
<span class="lineno" id=line161></span>    (<span class="fstring">"method"</span>, <span class="fstring">"A function depending only on its parameters"</span>),
<span class="lineno" id=line162></span>    (<span class="fstring">"pure"</span>, <span class="fstring">"A function depending only on its parameters"</span>),
<span class="lineno" id=line163></span>    (<span class="fstring">"virtual"</span>, <span class="fstring">"Type of a function to be provided in type class instances"</span>),
<span class="lineno" id=line164></span>    (<span class="fstring">"inline"</span>, <span class="fstring">"Function or procedure which should be inlined if possible"</span>),
<span class="lineno" id=line165></span>    (<span class="fstring">"noinline"</span>, <span class="fstring">"Function or procedure which must not be inlined"</span>),
<span class="lineno" id=line166></span>    (<span class="fstring">"private"</span>, <span class="fstring">"Symbol visible only in enclosing module or typeclass namespace"</span>),
<span class="lineno" id=line167></span>    (<span class="fstring">"incomplete"</span>,<span class="fstring">"A type which must not be instantiated"</span>),
<span class="lineno" id=line168></span>    (<span class="fstring">"callback"</span>,<span class="fstring">"A C wrapper for a Felix callback"</span>),
<span class="lineno" id=line169></span>    (<span class="fstring">"pod"</span>,<span class="fstring">"A Plain Old Data type, which needs no finalisation"</span>),
<span class="lineno" id=line170></span>    (<span class="fstring">"_gc_pointer"</span>,<span class="fstring">"A Felix heap allocated pointer"</span>),
<span class="lineno" id=line171></span>    (<span class="fstring">"_gc_type"</span>,<span class="fstring">"Type of object pointed to"</span>),
<span class="lineno" id=line172></span>    (<span class="fstring">"scanner"</span>,<span class="fstring">"names C routine which scans a data structure for pointers"</span>),
<span class="lineno" id=line173></span>    (<span class="fstring">"finaliser"</span>,<span class="fstring">"names C routine which finalises an object"</span>),
<span class="lineno" id=line174></span>    (<span class="fstring">"_repr_"</span>,<span class="fstring">"Refer to the representation of a Felix abstract type"</span>),
<span class="lineno" id=line175></span>    (<span class="fstring">"noreturn"</span>,<span class="fstring">"specify C code doesn't return"</span>)
<span class="lineno" id=line176></span>  ;
<span class="lineno" id=line177></span>  
<span class="lineno" id=line178></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> dlibrary = 
<span class="lineno" id=line179></span>    (<span class="fstring">"any"</span>, <span class="fstring">"Type a non-returning function returns"</span>),
<span class="lineno" id=line180></span>    (<span class="fstring">"void"</span>, <span class="fstring">"Type with no values, returning void indicates a procedure"</span>),
<span class="lineno" id=line181></span>    (<span class="fstring">"unit"</span>, <span class="fstring">"Type with one values (), the empty tuple"</span>),
<span class="lineno" id=line182></span>    (<span class="fstring">"tiny"</span>, <span class="fstring">"binding of C signed char type"</span>),
<span class="lineno" id=line183></span>    (<span class="fstring">"utiny"</span>, <span class="fstring">"binding of C unsigned char type"</span>),
<span class="lineno" id=line184></span>    (<span class="fstring">"short"</span>, <span class="fstring">"binding of C short type"</span>),
<span class="lineno" id=line185></span>    (<span class="fstring">"ushort"</span>, <span class="fstring">"binding of C unsigned short type"</span>),
<span class="lineno" id=line186></span>    (<span class="fstring">"int"</span>, <span class="fstring">"binding of C int type"</span>),
<span class="lineno" id=line187></span>    (<span class="fstring">"uint"</span>, <span class="fstring">"binding of C unsigned int type"</span>),
<span class="lineno" id=line188></span>    (<span class="fstring">"long"</span>, <span class="fstring">"binding of C long type"</span>),
<span class="lineno" id=line189></span>    (<span class="fstring">"ulong"</span>, <span class="fstring">"binding of C unsigned long type"</span>),
<span class="lineno" id=line190></span>    (<span class="fstring">"vlong"</span>, <span class="fstring">"binding of C long long type"</span>),
<span class="lineno" id=line191></span>    (<span class="fstring">"uvlong"</span>, <span class="fstring">"binding of C unsigned long long type"</span>),
<span class="lineno" id=line192></span>    (<span class="fstring">"int8"</span>, <span class="fstring">"binding of C int8_t type"</span>),
<span class="lineno" id=line193></span>    (<span class="fstring">"int16"</span>, <span class="fstring">"binding of C int16_t type"</span>),
<span class="lineno" id=line194></span>    (<span class="fstring">"int32"</span>, <span class="fstring">"binding of C int32_t type"</span>),
<span class="lineno" id=line195></span>    (<span class="fstring">"int64"</span>, <span class="fstring">"binding of C int64 type"</span>),
<span class="lineno" id=line196></span>    (<span class="fstring">"uint8"</span>, <span class="fstring">"binding of C uint8_t type"</span>),
<span class="lineno" id=line197></span>    (<span class="fstring">"uint16"</span>, <span class="fstring">"binding of C uint16_t type"</span>),
<span class="lineno" id=line198></span>    (<span class="fstring">"uint32"</span>, <span class="fstring">"binding of C uint32_t type"</span>),
<span class="lineno" id=line199></span>    (<span class="fstring">"uint64"</span>, <span class="fstring">"binding of C uint64 type"</span>),
<span class="lineno" id=line200></span>    (<span class="fstring">"char"</span>, <span class="fstring">"binding of C char type"</span>),
<span class="lineno" id=line201></span>    (<span class="fstring">"uchar"</span>, <span class="fstring">"binding of C int32_t type used for Unicode character set"</span>),
<span class="lineno" id=line202></span>    (<span class="fstring">"intptr"</span>, <span class="fstring">"binding of C intptr_t type"</span>),
<span class="lineno" id=line203></span>    (<span class="fstring">"uintptr"</span>, <span class="fstring">"binding of C unsigned type corresponding to intptr_t type"</span>),
<span class="lineno" id=line204></span>    (<span class="fstring">"maxint"</span>, <span class="fstring">"binding of C maxint_t type"</span>),
<span class="lineno" id=line205></span>    (<span class="fstring">"umaxint"</span>, <span class="fstring">"binding of C unsigned type corresponding to maxint_t type"</span>),
<span class="lineno" id=line206></span>    (<span class="fstring">"size"</span>, <span class="fstring">"binding of C size_t type"</span>),
<span class="lineno" id=line207></span>    (<span class="fstring">"ssize"</span>, <span class="fstring">"binding of C signed type corresponding to size_t type"</span>),
<span class="lineno" id=line208></span>    (<span class="fstring">"float"</span>, <span class="fstring">"binding of C float type"</span>),
<span class="lineno" id=line209></span>    (<span class="fstring">"double"</span>, <span class="fstring">"binding of C double float type"</span>),
<span class="lineno" id=line210></span>    (<span class="fstring">"ldouble"</span>, <span class="fstring">"binding of C long double type"</span>),
<span class="lineno" id=line211></span>    (<span class="fstring">"string"</span>, <span class="fstring">"binding of C++ string type"</span>),
<span class="lineno" id=line212></span>    (<span class="fstring">"ptrdiff"</span>, <span class="fstring">"binding of C ptrdiff_t type"</span>),
<span class="lineno" id=line213></span>    (<span class="fstring">"intmax"</span>, <span class="fstring">"binding of C intmax_t type"</span>),
<span class="lineno" id=line214></span>    (<span class="fstring">"uintmax"</span>, <span class="fstring">"binding of C uintmax_t type"</span>),
<span class="lineno" id=line215></span>    (<span class="fstring">"wchar"</span>, <span class="fstring">"binding of C uintmax_t type"</span>),
<span class="lineno" id=line216></span>    (<span class="fstring">"fcomplex"</span>, <span class="fstring">"binding of C++ complex&amp;lt;float&amp;gt; type"</span>),
<span class="lineno" id=line217></span>    (<span class="fstring">"dcomplex"</span>, <span class="fstring">"binding of C++ complex&amp;lt;double&amp;gt; type"</span>),
<span class="lineno" id=line218></span>    (<span class="fstring">"lcomplex"</span>, <span class="fstring">"binding of C++ complex&amp;lt;long double&amp;gt; type"</span>),
<span class="lineno" id=line219></span>    (<span class="fstring">"byte"</span>, <span class="fstring">"special binding of C unsigned char type"</span>),
<span class="lineno" id=line220></span>    (<span class="fstring">"address"</span>, <span class="fstring">"special binding of C void* type"</span>),
<span class="lineno" id=line221></span>  
<span class="lineno" id=line222></span>    (<span class="fstring">"opt"</span>, <span class="fstring">"option type: Some x or None"</span>),
<span class="lineno" id=line223></span>    (<span class="fstring">"list"</span>, <span class="fstring">"functional, singly linked list"</span>),
<span class="lineno" id=line224></span>    (<span class="fstring">"array"</span>, <span class="fstring">"array type, a tuple of all components the same type"</span>),
<span class="lineno" id=line225></span>    (<span class="fstring">"varray"</span>, <span class="fstring">"array with dynamically variable limit up to a fixed bound"</span>),
<span class="lineno" id=line226></span>    (<span class="fstring">"darray"</span>, <span class="fstring">"array with unbounded dynamically variable limit"</span>),
<span class="lineno" id=line227></span>    (<span class="fstring">"sarray"</span>, <span class="fstring">"unbounded sparse array"</span>),
<span class="lineno" id=line228></span>    (<span class="fstring">"bsarray"</span>, <span class="fstring">"bounded sparse array"</span>),
<span class="lineno" id=line229></span>  
<span class="lineno" id=line230></span>    (<span class="fstring">"str"</span>, <span class="fstring">"Convert a value to a string"</span>),
<span class="lineno" id=line231></span>    (<span class="fstring">"print"</span>, <span class="fstring">"Print a string to standard output"</span>),
<span class="lineno" id=line232></span>    (<span class="fstring">"println"</span>, <span class="fstring">"Print a string to standard output with newline appended"</span>),
<span class="lineno" id=line233></span>    (<span class="fstring">"write"</span>, <span class="fstring">"Print a string to a stream"</span>),
<span class="lineno" id=line234></span>    (<span class="fstring">"write"</span>, <span class="fstring">"Print a string to a stream with newline appended"</span>),
<span class="lineno" id=line235></span>    (<span class="fstring">"readln"</span>, <span class="fstring">"Read a string from a stream including trailing newline"</span>),
<span class="lineno" id=line236></span>  
<span class="lineno" id=line237></span>    (<span class="fstring">"iter"</span>, <span class="fstring">"call procedure on each element of data structure"</span>),
<span class="lineno" id=line238></span>    (<span class="fstring">"map"</span>, <span class="fstring">"return data structure with function applied to each value"</span>),
<span class="lineno" id=line239></span>    (<span class="fstring">"fold_left"</span>, <span class="fstring">"accumulated values of data structure from left into initial value using function"</span>),
<span class="lineno" id=line240></span>    (<span class="fstring">"fold_right"</span>, <span class="fstring">"accumulated values of data structure from right into initial value using function"</span>),
<span class="lineno" id=line241></span>    (<span class="fstring">"rev"</span>, <span class="fstring">"return data structure with elements reversed"</span>),
<span class="lineno" id=line242></span>    (<span class="fstring">"len"</span>, <span class="fstring">"number of elements in data structure"</span>),
<span class="lineno" id=line243></span>    (<span class="fstring">"true"</span>, <span class="fstring">"truth value"</span>),
<span class="lineno" id=line244></span>    (<span class="fstring">"false"</span>, <span class="fstring">"false value"</span>)
<span class="lineno" id=line245></span>  ;
<span class="lineno" id=line246></span>  
<span class="lineno" id=line247></span>  <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define an immutable value">val</span> hack = <span class="fstring">"C_hack"</span>,<span class="fstring">"C_hack"</span>; <span class="comment">// to make it an array we need 2 components</span>
<span class="lineno" id=line248></span>  
<span class="lineno" id=line249></span>  
<span class="lineno" id=line250></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> valof[N:UNITSUM](x:<span class="library" title="array type, a tuple of all components the same type">array</span>[<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>,N],key:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line251></span>    <span class="small_keyword" title="match statement or expression">match</span> find (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (kv:<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>)=&gt; kv.(0) == key) x <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line252></span>    | Some (k,v) =&gt; v
<span class="lineno" id=line253></span>    | #None =&gt; <span class="fstring">""</span>
<span class="lineno" id=line254></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line255></span>  ;
<span class="lineno" id=line256></span>  
<span class="lineno" id=line257></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> xlat_felix(t:<span class="library" title="binding of C++ string type">string</span>, dir:<span class="library" title="binding of C++ string type">string</span>): bool * <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line258></span>  {
<span class="lineno" id=line259></span>    <span class="big_keyword" title="Define a mutable variable">var</span> needs_mathjax = <span class="library" title="false value">false</span>;
<span class="lineno" id=line260></span>    <span class="big_keyword" title="Define a mutable variable">var</span> mathcount = 0;
<span class="lineno" id=line261></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line262></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> write_string(t:<span class="library" title="binding of C++ string type">string</span>) 
<span class="lineno" id=line263></span>    { 
<span class="lineno" id=line264></span>     out += t;
<span class="lineno" id=line265></span>    }
<span class="lineno" id=line266></span>  
<span class="lineno" id=line267></span>    variant state_t = 
<span class="lineno" id=line268></span>      | sot <span class="comment">// start of token</span>
<span class="lineno" id=line269></span>      | id <span class="comment">// processing identifier</span>
<span class="lineno" id=line270></span>      | texid <span class="comment">// processing identifier</span>
<span class="lineno" id=line271></span>      | num <span class="comment">// in a number</span>
<span class="lineno" id=line272></span>      | sq <span class="comment">// processing single quote string</span>
<span class="lineno" id=line273></span>      | dq <span class="comment">// processing double quote string</span>
<span class="lineno" id=line274></span>      | sq3 <span class="comment">// processing single quote string</span>
<span class="lineno" id=line275></span>      | dq3 <span class="comment">// processing double quote string</span>
<span class="lineno" id=line276></span>      | ccomment of <span class="library" title="binding of C int type">int</span> <span class="comment">// a C style comment</span>
<span class="lineno" id=line277></span>      | cppcomment <span class="comment">// a C++ style comment</span>
<span class="lineno" id=line278></span>      | cpphtml <span class="comment">// a documentation comment  //$</span>
<span class="lineno" id=line279></span>      | mathmode <span class="comment">// TeX math mode</span>
<span class="lineno" id=line280></span>      | mathid <span class="comment">// TeX math mode, Felix id</span>
<span class="lineno" id=line281></span>      | mathtexid <span class="comment">// TeX math mode, TeX id</span>
<span class="lineno" id=line282></span>    ;
<span class="lineno" id=line283></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span>(s:state_t) =&gt; <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line284></span>    | #sot =&gt; <span class="fstring">"sot"</span>
<span class="lineno" id=line285></span>    | #id =&gt; <span class="fstring">"id"</span>
<span class="lineno" id=line286></span>    | #texid =&gt; <span class="fstring">"texid"</span>
<span class="lineno" id=line287></span>    | #num =&gt; <span class="fstring">"num"</span>
<span class="lineno" id=line288></span>    | #sq =&gt; <span class="fstring">"sq"</span>
<span class="lineno" id=line289></span>    | #dq =&gt; <span class="fstring">"dq"</span>
<span class="lineno" id=line290></span>    | #sq3 =&gt; <span class="fstring">"sq3"</span>
<span class="lineno" id=line291></span>    | #dq3 =&gt; <span class="fstring">"dq3"</span>
<span class="lineno" id=line292></span>    | ccomment n =&gt; <span class="fstring">"ccomment_"</span>+ <span class="library" title="Convert a value to a string">str</span> n
<span class="lineno" id=line293></span>    | #cppcomment =&gt; <span class="fstring">"cppcomment"</span>
<span class="lineno" id=line294></span>    | #cpphtml =&gt; <span class="fstring">"doccomment"</span>
<span class="lineno" id=line295></span>    | #mathmode =&gt; <span class="fstring">"mathmode"</span>
<span class="lineno" id=line296></span>    | #mathid =&gt; <span class="fstring">"mathid"</span>
<span class="lineno" id=line297></span>    | #mathtexid =&gt; <span class="fstring">"mathid"</span>
<span class="lineno" id=line298></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line299></span>    
<span class="lineno" id=line300></span>    <span class="big_keyword" title="Define a mutable variable">var</span> i = 0; <span class="big_keyword" title="Define a mutable variable">var</span> s:state_t;
<span class="lineno" id=line301></span>    <span class="big_keyword" title="Define a mutable variable">var</span> ch = t.[i];
<span class="lineno" id=line302></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> next() { ch = t.[i]; ++i; }
<span class="lineno" id=line303></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> ahead (j:<span class="library" title="binding of C int type">int</span>)=&gt; t.[i + j - 1]; 
<span class="lineno" id=line304></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> issq3() =&gt; 
<span class="lineno" id=line305></span>      ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical conjunction">and</span> 
<span class="lineno" id=line306></span>      ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical conjunction">and</span>
<span class="lineno" id=line307></span>      ahead(2) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> 
<span class="lineno" id=line308></span>    ;
<span class="lineno" id=line309></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> isdq3() =&gt; 
<span class="lineno" id=line310></span>      ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span>  <span class="small_keyword" title="logical conjunction">and</span>
<span class="lineno" id=line311></span>      ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="logical conjunction">and</span>
<span class="lineno" id=line312></span>      ahead(2) == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> 
<span class="lineno" id=line313></span>    ;
<span class="lineno" id=line314></span>  
<span class="lineno" id=line315></span>    <span class="big_keyword" title="Define a mutable variable">var</span> b = <span class="fstring">""</span>;
<span class="lineno" id=line316></span>    <span class="big_keyword" title="Define a mutable variable">var</span> htmlb = <span class="fstring">""</span>;
<span class="lineno" id=line317></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_id = <span class="fstring">""</span>;
<span class="lineno" id=line318></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_texop = <span class="fstring">""</span>;
<span class="lineno" id=line319></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_op = <span class="fstring">""</span>;
<span class="lineno" id=line320></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_key = <span class="fstring">""</span>;
<span class="lineno" id=line321></span>  
<span class="lineno" id=line322></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cp() { b += ch; }
<span class="lineno" id=line323></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cphtml() { htmlb += ch; }
<span class="lineno" id=line324></span>  
<span class="lineno" id=line325></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ws() {
<span class="lineno" id=line326></span>      <span class="small_keyword" title="conditional">if</span> last_id == <span class="fstring">"include"</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// hackery</span>
<span class="lineno" id=line327></span>        <span class="big_keyword" title="Define a mutable variable">var</span> n = b; 
<span class="lineno" id=line328></span>        <span class="small_keyword" title="while loop">while</span> n.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical disjunction">or</span> n.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="imperative code begins">do</span> n = n.[1 <span class="small_keyword" title="substring range separator">to</span>]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line329></span>        <span class="small_keyword" title="while loop">while</span> n.[-1] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical disjunction">or</span> n.[-1] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="imperative code begins">do</span> n = n.[<span class="small_keyword" title="substring range separator">to</span> -1]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line330></span>        <span class="small_keyword" title="conditional">if</span> n.[0] == <span class="fstring">'.'</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line331></span>          <span class="big_keyword" title="Define a mutable variable">var</span> rel_flx = Filename::join (dir, n.[1 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line332></span>          <span class="small_keyword" title="conditional">if</span> FileStat::fileexists rel_flx <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line333></span>            write_string(<span class="fstring">'&lt;a href="/$'</span>+rel_flx+<span class="fstring">'" &gt;'</span> + b + <span class="fstring">'&lt;/a&gt;'</span>) ;
<span class="lineno" id=line334></span>          <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line335></span>            write_string(<span class="fstring">'&lt;span class="fstring"&gt;'</span>+txt2html b+<span class="fstring">"&lt;/span&gt;"</span>);
<span class="lineno" id=line336></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line337></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line338></span>          <span class="big_keyword" title="Define a mutable variable">var</span> try_flx = n+ <span class="fstring">".flx"</span>; 
<span class="lineno" id=line339></span>          <span class="big_keyword" title="Define a mutable variable">var</span> resolve_flx = get_file (try_flx, INSTALL_ROOT,FLX_PATH);
<span class="lineno" id=line340></span>          <span class="big_keyword" title="Define a mutable variable">var</span> try_html = n+ <span class="fstring">".html"</span>; 
<span class="lineno" id=line341></span>          <span class="big_keyword" title="Define a mutable variable">var</span> resolve_html= get_file (try_html, INSTALL_ROOT,FLX_PATH);
<span class="lineno" id=line342></span>          <span class="big_keyword" title="Define a mutable variable">var</span> flx_time,flx_file = <span class="small_keyword" title="match statement or expression">match</span> resolve_flx <span class="small_keyword" title="type-class constraint">with</span> | Some f =&gt; FileStat::filetime f,f | #None =&gt; 0.0,<span class="fstring">""</span>;
<span class="lineno" id=line343></span>          <span class="big_keyword" title="Define a mutable variable">var</span> html_time,html_file = <span class="small_keyword" title="match statement or expression">match</span> resolve_html <span class="small_keyword" title="type-class constraint">with</span> | Some f =&gt; FileStat::filetime f,f | #None =&gt; 0.0,<span class="fstring">""</span>;
<span class="lineno" id=line344></span>          <span class="small_keyword" title="conditional">if</span> flx_time &gt; html_time <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line345></span>            write_string(<span class="fstring">'&lt;a href="/$'</span>+flx_file+<span class="fstring">'" &gt;'</span> + b + <span class="fstring">'&lt;/a&gt;'</span>) ;
<span class="lineno" id=line346></span>          <span class="small_keyword" title="conditional">elif</span> html_time &gt; flx_time <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line347></span>            write_string(<span class="fstring">'&lt;a href="/$'</span>+html_file+<span class="fstring">'" &gt;'</span> + b + <span class="fstring">'&lt;/a&gt;'</span>) ;
<span class="lineno" id=line348></span>          <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line349></span>            write_string(<span class="fstring">'&lt;span class="fstring"&gt;'</span>+txt2html b+<span class="fstring">"&lt;/span&gt;"</span>);
<span class="lineno" id=line350></span>          <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line351></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line352></span>      <span class="small_keyword" title="conditional">elif</span> last_key <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">"header"</span>,<span class="fstring">"body"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line353></span>        n = b; 
<span class="lineno" id=line354></span>        <span class="big_keyword" title="Define a mutable variable">var</span> quote = <span class="fstring">'"""'</span>;
<span class="lineno" id=line355></span>        <span class="small_keyword" title="conditional">if</span> prefix(b,quote) <span class="small_keyword" title="imperative code begins">do</span> n = b.[3 <span class="small_keyword" title="substring range separator">to</span> -3]; <span class="small_keyword" title="jump to label">goto</span> unstring; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line356></span>        quote = <span class="fstring">"'''"</span>; 
<span class="lineno" id=line357></span>        <span class="small_keyword" title="conditional">if</span> prefix(b,quote) <span class="small_keyword" title="imperative code begins">do</span> n = b.[3 <span class="small_keyword" title="substring range separator">to</span> -3]; <span class="small_keyword" title="jump to label">goto</span> unstring; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line358></span>        quote = <span class="fstring">"'"</span>; 
<span class="lineno" id=line359></span>        <span class="small_keyword" title="conditional">if</span> prefix(b,quote) <span class="small_keyword" title="imperative code begins">do</span> n = b.[1 <span class="small_keyword" title="substring range separator">to</span> -1]; <span class="small_keyword" title="jump to label">goto</span> unstring; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line360></span>        quote = <span class="fstring">'"'</span>; 
<span class="lineno" id=line361></span>        <span class="small_keyword" title="conditional">if</span> prefix(b,quote) <span class="small_keyword" title="imperative code begins">do</span> n = b.[1 <span class="small_keyword" title="substring range separator">to</span> -1]; <span class="small_keyword" title="jump to label">goto</span> unstring; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line362></span>        <span class="comment">// shouldn't happen ..</span>
<span class="lineno" id=line363></span>  unstring:&gt;
<span class="lineno" id=line364></span>        <span class="big_keyword" title="Define an immutable value">val</span> c = (xlat_cpp (n,dir)).1;
<span class="lineno" id=line365></span>        write_string(quote+<span class="fstring">'&lt;span class="embedded_c"&gt;'</span> + c + <span class="fstring">'&lt;/span&gt;'</span>+quote); 
<span class="lineno" id=line366></span>      <span class="small_keyword" title="conditional">elif</span> last_key == <span class="fstring">"package"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line367></span>         <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Package: "</span> + b;
<span class="lineno" id=line368></span>         n = b;
<span class="lineno" id=line369></span>        <span class="small_keyword" title="while loop">while</span> n.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical disjunction">or</span> n.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="imperative code begins">do</span> n = n.[1 <span class="small_keyword" title="substring range separator">to</span>]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line370></span>        <span class="small_keyword" title="while loop">while</span> n.[-1] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"'"</span> <span class="small_keyword" title="logical disjunction">or</span> n.[-1] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="imperative code begins">do</span> n = n.[<span class="small_keyword" title="substring range separator">to</span> -1]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line371></span>        n+=<span class="fstring">".fpc"</span>;
<span class="lineno" id=line372></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Package file basename is "</span> + n;
<span class="lineno" id=line373></span>        <span class="small_keyword" title="match statement or expression">match</span> get_file(n,INSTALL_ROOT,FLX_PKGCONFIG_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line374></span>        | Some f =&gt; { write_string(<span class="fstring">'&lt;a href="/$'</span>+f+<span class="fstring">'" &gt;'</span> + txt2html b + <span class="fstring">'&lt;/a&gt;'</span>) ; }
<span class="lineno" id=line375></span>        | #None =&gt; { 
<span class="lineno" id=line376></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Can't find "</span>+n+<span class="fstring">" in path "</span> + <span class="library" title="Convert a value to a string">str</span> FLX_PKGCONFIG_PATH;   
<span class="lineno" id=line377></span>            write_string(<span class="fstring">'&lt;span class="fstring"&gt;'</span>+txt2html b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line378></span>          }
<span class="lineno" id=line379></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line380></span>      <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line381></span>       write_string(<span class="fstring">'&lt;span class="fstring"&gt;'</span>+txt2html b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line382></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line383></span>    }
<span class="lineno" id=line384></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> whtml() {
<span class="lineno" id=line385></span>      write_string (<span class="fstring">'&lt;span class="doccomment"&gt;'</span> + txt2html htmlb + <span class="fstring">"&lt;/span&gt;\n"</span>);
<span class="lineno" id=line386></span>      htmlb = <span class="fstring">""</span>; b=<span class="fstring">""</span>;
<span class="lineno" id=line387></span>    }
<span class="lineno" id=line388></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> w() { 
<span class="lineno" id=line389></span>      last_texop = <span class="fstring">""</span>; 
<span class="lineno" id=line390></span>      <span class="comment">//println$ "Token["+str s+"]="+b; </span>
<span class="lineno" id=line391></span>      <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line392></span>      | #dq =&gt; { ws; }
<span class="lineno" id=line393></span>      | #sq =&gt; { ws; }
<span class="lineno" id=line394></span>      | #sq3 =&gt; { ws; }
<span class="lineno" id=line395></span>      | #dq3 =&gt; { ws; }
<span class="lineno" id=line396></span>      | ccomment _ =&gt; { write_string(<span class="fstring">'&lt;span class="comment"&gt;'</span>+txt2html b+<span class="fstring">"&lt;/span&gt;"</span>); }
<span class="lineno" id=line397></span>      | #cppcomment =&gt; { write_string(<span class="fstring">'&lt;span class="comment"&gt;'</span>+txt2html b.[<span class="small_keyword" title="substring range separator">to</span> -1]+<span class="fstring">"&lt;/span&gt;\n"</span>); }
<span class="lineno" id=line398></span>      | #texid =&gt; { write_string (
<span class="lineno" id=line399></span>          <span class="fstring">'&lt;span class="tex_symbol" title="'</span>+b+<span class="fstring">'"&gt;\\('</span> + txt2html b + <span class="fstring">'\\)&lt;/span&gt;'</span>
<span class="lineno" id=line400></span>          ); 
<span class="lineno" id=line401></span>          needs_mathjax = <span class="library" title="truth value">true</span>; 
<span class="lineno" id=line402></span>        }  <span class="comment">// format with MathJax</span>
<span class="lineno" id=line403></span>      | #mathmode =&gt; { needs_mathjax = <span class="library" title="truth value">true</span>; write_string b; }
<span class="lineno" id=line404></span>      | #mathid =&gt; { needs_mathjax = <span class="library" title="truth value">true</span>; write_string b; }
<span class="lineno" id=line405></span>      | #mathtexid =&gt; { needs_mathjax = <span class="library" title="truth value">true</span>; last_texop = b; write_string b; }
<span class="lineno" id=line406></span>      | #id =&gt; 
<span class="lineno" id=line407></span>        { 
<span class="lineno" id=line408></span>          last_id = b;
<span class="lineno" id=line409></span>          <span class="comment">// this is a bit hacky but I can't see another way!</span>
<span class="lineno" id=line410></span>          <span class="big_keyword" title="Define a mutable variable">var</span> bv=valof(big_keywords,b);
<span class="lineno" id=line411></span>          <span class="big_keyword" title="Define a mutable variable">var</span> sv=valof(small_keywords,b);
<span class="lineno" id=line412></span>          <span class="big_keyword" title="Define a mutable variable">var</span> qv=valof(qualifiers,b);
<span class="lineno" id=line413></span>          <span class="big_keyword" title="Define a mutable variable">var</span> lv=valof(dlibrary,b);
<span class="lineno" id=line414></span>          <span class="small_keyword" title="conditional">if</span>   bv != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> last_key=b; write_string(<span class="fstring">'&lt;span class="big_keyword" title="'</span>+bv+<span class="fstring">'"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line415></span>          <span class="small_keyword" title="conditional">elif</span> sv != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> last_key=b; write_string(<span class="fstring">'&lt;span class="small_keyword" title="'</span>+sv+<span class="fstring">'"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>);
<span class="lineno" id=line416></span>          <span class="small_keyword" title="conditional">elif</span> qv != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class="qualifier" title="'</span>+qv+<span class="fstring">'"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line417></span>          <span class="small_keyword" title="conditional">elif</span> lv != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class="library" title="'</span>+lv+<span class="fstring">'"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line418></span>          <span class="small_keyword" title="conditional">elif</span> b <span class="small_keyword" title="membership operator, function mem">in</span> hack <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class="hack"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line419></span>          <span class="small_keyword" title="conditional">else</span> write_string(b); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line420></span>        }
<span class="lineno" id=line421></span>      | _ =&gt;
<span class="lineno" id=line422></span>        { 
<span class="lineno" id=line423></span>          last_op=b; 
<span class="lineno" id=line424></span>          <span class="small_keyword" title="conditional">if</span> b == <span class="fstring">";"</span> <span class="small_keyword" title="imperative code begins">do</span> last_key = <span class="fstring">""</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line425></span>          <span class="small_keyword" title="conditional">if</span> b == <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line426></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line427></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line428></span>          <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line429></span>          write_string(b);  
<span class="lineno" id=line430></span>        }
<span class="lineno" id=line431></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line432></span>      b = <span class="fstring">""</span>;  
<span class="lineno" id=line433></span>    }
<span class="lineno" id=line434></span>  
<span class="lineno" id=line435></span>  
<span class="lineno" id=line436></span>    <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line437></span>  
<span class="lineno" id=line438></span>  continhtml:&gt;
<span class="lineno" id=line439></span>    cphtml;
<span class="lineno" id=line440></span>    <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line441></span>  
<span class="lineno" id=line442></span>  contin:&gt; <span class="comment">// copy char and continue</span>
<span class="lineno" id=line443></span>    cp;
<span class="lineno" id=line444></span>    <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line445></span>     
<span class="lineno" id=line446></span>  overrun:&gt; <span class="comment">// one past last char of token</span>
<span class="lineno" id=line447></span>    w;
<span class="lineno" id=line448></span>    s = sot;
<span class="lineno" id=line449></span>    <span class="small_keyword" title="jump to label">goto</span> thisch;
<span class="lineno" id=line450></span>  
<span class="lineno" id=line451></span>  lasthtml:&gt;
<span class="lineno" id=line452></span>    whtml;
<span class="lineno" id=line453></span>    <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line454></span>  
<span class="lineno" id=line455></span>  lastch:&gt; <span class="comment">// last char of token</span>
<span class="lineno" id=line456></span>    cp;
<span class="lineno" id=line457></span>    w;
<span class="lineno" id=line458></span>  
<span class="lineno" id=line459></span>  nextt:&gt;  <span class="comment">// new token on next char</span>
<span class="lineno" id=line460></span>    s = sot;
<span class="lineno" id=line461></span>  
<span class="lineno" id=line462></span>  nextch:&gt; <span class="comment">// next char</span>
<span class="lineno" id=line463></span>    next;
<span class="lineno" id=line464></span>  
<span class="lineno" id=line465></span>  thisch:&gt; <span class="comment">// same char, reconsider it</span>
<span class="lineno" id=line466></span>    <span class="comment">//println$ "Considering char " + str(ord(ch));</span>
<span class="lineno" id=line467></span>    <span class="small_keyword" title="conditional">if</span> isnull ch <span class="small_keyword" title="jump to label">goto</span> fin; <span class="comment">// out of data</span>
<span class="lineno" id=line468></span>    <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line469></span>    | #sot =&gt;
<span class="lineno" id=line470></span>        <span class="small_keyword" title="conditional">if</span> isidstart ch <span class="small_keyword" title="imperative code begins">do</span> s = id; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line471></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"\\"</span> <span class="small_keyword" title="logical conjunction">and</span> isletter (ahead(1)) <span class="small_keyword" title="imperative code begins">do</span> cp; next; s = texid; <span class="small_keyword" title="jump to label">goto</span> contin; 
<span class="lineno" id=line472></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"\\"</span> <span class="small_keyword" title="logical conjunction">and</span> ahead(1) <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="library" title="binding of C char type">char</span> <span class="fstring">"("</span>, <span class="library" title="binding of C char type">char</span> <span class="fstring">"["</span>)  <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line473></span>          cp; next; s=mathmode; ++mathcount; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line474></span>        <span class="small_keyword" title="conditional">elif</span> isdigit ch <span class="small_keyword" title="imperative code begins">do</span> s = num; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line475></span>        <span class="small_keyword" title="conditional">elif</span> issq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; s = sq3; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line476></span>        <span class="small_keyword" title="conditional">elif</span> isdq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; s = dq3; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line477></span>        <span class="small_keyword" title="conditional">elif</span> issq ch <span class="small_keyword" title="imperative code begins">do</span> s = sq; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line478></span>        <span class="small_keyword" title="conditional">elif</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> s = dq; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line479></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line480></span>          <span class="small_keyword" title="conditional">if</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line481></span>            <span class="small_keyword" title="conditional">if</span> ahead(2) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"$"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line482></span>              next; next; next;
<span class="lineno" id=line483></span>              s = cpphtml; 
<span class="lineno" id=line484></span>            <span class="small_keyword" title="conditional">else</span> cp; next; s = cppcomment;
<span class="lineno" id=line485></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line486></span>            <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line487></span>          <span class="small_keyword" title="conditional">elif</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"*"</span> <span class="small_keyword" title="imperative code begins">do</span> cp; next; s = ccomment 1; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line488></span>          <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line489></span>          <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line490></span>        <span class="small_keyword" title="conditional">else</span> cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line491></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line492></span>  
<span class="lineno" id=line493></span>    | #mathmode =&gt;
<span class="lineno" id=line494></span>       <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"\\"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line495></span>         <span class="small_keyword" title="conditional">if</span> ahead (1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">")"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line496></span>           --mathcount;
<span class="lineno" id=line497></span>           <span class="small_keyword" title="conditional">if</span> mathcount == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line498></span>             <span class="comment">// EXIT MATH MODE</span>
<span class="lineno" id=line499></span>             cp; next; cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line500></span>           <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line501></span>            next; b+=<span class="fstring">"}"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line502></span>           <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line503></span>         <span class="small_keyword" title="conditional">elif</span> ahead (1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"("</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line504></span>            ++mathcount;
<span class="lineno" id=line505></span>            b+=<span class="fstring">"{"</span>;
<span class="lineno" id=line506></span>            next; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line507></span>         <span class="small_keyword" title="conditional">elif</span> ahead (1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"]"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line508></span>           --mathcount;
<span class="lineno" id=line509></span>           <span class="small_keyword" title="conditional">if</span> mathcount == 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line510></span>             <span class="comment">// EXIT MATH MODE</span>
<span class="lineno" id=line511></span>             cp; next; cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line512></span>           <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line513></span>            cp; next; cp; b+=<span class="fstring">"}"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line514></span>           <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line515></span>         <span class="small_keyword" title="conditional">elif</span> ahead (1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"["</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line516></span>            ++mathcount;
<span class="lineno" id=line517></span>            b+=<span class="fstring">"{"</span>;
<span class="lineno" id=line518></span>            cp; next; cp; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line519></span>         <span class="small_keyword" title="conditional">elif</span> ahead (1) == (<span class="library" title="binding of C char type">char</span> <span class="fstring">"{"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line520></span>           b+=<span class="fstring">"{"</span>; cp; next; cp; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line521></span>         <span class="small_keyword" title="conditional">elif</span> ahead (1)  == (<span class="library" title="binding of C char type">char</span> <span class="fstring">"}"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line522></span>           cp; next; cp; b+=<span class="fstring">"}"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line523></span>         <span class="small_keyword" title="conditional">elif</span> isletter (ahead(1)) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line524></span>           cp; s = mathtexid; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line525></span>         <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line526></span>           <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line527></span>         <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line528></span>       <span class="comment">// add {} around () and [] so TeX sees a group</span>
<span class="lineno" id=line529></span>       <span class="small_keyword" title="conditional">elif</span> ch <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="library" title="binding of C char type">char</span> <span class="fstring">"("</span>, <span class="library" title="binding of C char type">char</span> <span class="fstring">"["</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line530></span>         b+=<span class="fstring">"{"</span>; cp; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line531></span>       <span class="small_keyword" title="conditional">elif</span> ch <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="library" title="binding of C char type">char</span> <span class="fstring">")"</span>, <span class="library" title="binding of C char type">char</span> <span class="fstring">"]"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line532></span>         cp; b+=<span class="fstring">"}"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line533></span>   
<span class="lineno" id=line534></span>       <span class="small_keyword" title="conditional">elif</span> isidstart ch <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line535></span>         w; 
<span class="lineno" id=line536></span>         <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> (isflxidcont (ahead 1)) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line537></span>           <span class="small_keyword" title="jump to label">goto</span> contin; <span class="comment">// leave one character identifiers "as is"</span>
<span class="lineno" id=line538></span>                        <span class="comment">// so default typeface is mathit</span>
<span class="lineno" id=line539></span>         <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line540></span>           s = mathid; 
<span class="lineno" id=line541></span>           <span class="big_keyword" title="Define a mutable variable">var</span> mathfont = 
<span class="lineno" id=line542></span>             <span class="small_keyword" title="conditional">if</span> last_texop <span class="small_keyword" title="membership operator, function mem">in</span> (
<span class="lineno" id=line543></span>               <span class="fstring">"\\mathit"</span>,   <span class="comment">// math italic</span>
<span class="lineno" id=line544></span>               <span class="fstring">"\\mathfrak"</span>, <span class="comment">// fraktur</span>
<span class="lineno" id=line545></span>               <span class="fstring">"\\mathcal"</span>,  <span class="comment">// caligraphic</span>
<span class="lineno" id=line546></span>               <span class="fstring">"\\mathrm"</span>,   <span class="comment">// roman</span>
<span class="lineno" id=line547></span>               <span class="fstring">"\\mathbf"</span>,   <span class="comment">// bold</span>
<span class="lineno" id=line548></span>               <span class="fstring">"\\mathscr"</span>,  <span class="comment">// script</span>
<span class="lineno" id=line549></span>               <span class="fstring">"\mathbb"</span>,    <span class="comment">// blackboard bold</span>
<span class="lineno" id=line550></span>               <span class="fstring">"\mathsf"</span>,    <span class="comment">// sans-serif</span>
<span class="lineno" id=line551></span>               <span class="fstring">"\\pmb"</span>       <span class="comment">// poor mans bold</span>
<span class="lineno" id=line552></span>             )
<span class="lineno" id=line553></span>             <span class="small_keyword" title="conditional">then</span> last_texop <span class="small_keyword" title="conditional">else</span> <span class="fstring">"\\mathtt"</span>
<span class="lineno" id=line554></span>           ;
<span class="lineno" id=line555></span>           b=<span class="fstring">"{"</span>+mathfont+<span class="fstring">"{\\text{"</span>; 
<span class="lineno" id=line556></span>           <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line557></span>         <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line558></span>       <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line559></span>         <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line560></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line561></span>    | #mathtexid =&gt;
<span class="lineno" id=line562></span>        <span class="small_keyword" title="conditional">if</span> isletter ch <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line563></span>        w;
<span class="lineno" id=line564></span>        s = mathmode;
<span class="lineno" id=line565></span>        <span class="small_keyword" title="jump to label">goto</span> thisch;
<span class="lineno" id=line566></span>  
<span class="lineno" id=line567></span>    | #mathid =&gt;
<span class="lineno" id=line568></span>        <span class="small_keyword" title="conditional">if</span> isflxidcont ch <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line569></span>        b+=<span class="fstring">"}}}"</span>;
<span class="lineno" id=line570></span>        w; s = mathmode;
<span class="lineno" id=line571></span>        <span class="small_keyword" title="jump to label">goto</span> thisch;
<span class="lineno" id=line572></span>  
<span class="lineno" id=line573></span>    | #texid =&gt; 
<span class="lineno" id=line574></span>        <span class="small_keyword" title="conditional">if</span> isletter ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line575></span>        <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line576></span>          <span class="small_keyword" title="jump to label">goto</span> overrun;
<span class="lineno" id=line577></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line578></span>    | #id =&gt; 
<span class="lineno" id=line579></span>        <span class="small_keyword" title="conditional">if</span> isflxidcont ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line580></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun;
<span class="lineno" id=line581></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line582></span>    | #num =&gt; 
<span class="lineno" id=line583></span>        <span class="small_keyword" title="conditional">if</span> isnumeric ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line584></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun; 
<span class="lineno" id=line585></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line586></span>    <span class="comment">// single quoted strings</span>
<span class="lineno" id=line587></span>    | #sq =&gt;
<span class="lineno" id=line588></span>        <span class="small_keyword" title="conditional">if</span> issq ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line589></span>        <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line590></span>    | #dq =&gt;
<span class="lineno" id=line591></span>        <span class="small_keyword" title="conditional">if</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line592></span>        <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line593></span>     <span class="comment">// triple quoted strings</span>
<span class="lineno" id=line594></span>    | #sq3 =&gt;
<span class="lineno" id=line595></span>        <span class="small_keyword" title="conditional">if</span> issq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line596></span>        <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line597></span>    | #dq3 =&gt;
<span class="lineno" id=line598></span>        <span class="small_keyword" title="conditional">if</span> isdq3() <span class="small_keyword" title="imperative code begins">do</span> cp; next; cp; next; cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line599></span>        <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line600></span>     <span class="comment">// comments</span>
<span class="lineno" id=line601></span>    | #cpphtml =&gt;
<span class="lineno" id=line602></span>       <span class="small_keyword" title="conditional">if</span> iseol ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lasthtml;
<span class="lineno" id=line603></span>       <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> continhtml;
<span class="lineno" id=line604></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line605></span>  
<span class="lineno" id=line606></span>    | #cppcomment =&gt;
<span class="lineno" id=line607></span>        <span class="small_keyword" title="conditional">if</span> iseol ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line608></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line609></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line610></span>    | ccomment n =&gt; 
<span class="lineno" id=line611></span>        <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"*"</span> <span class="small_keyword" title="logical conjunction">and</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line612></span>          <span class="small_keyword" title="conditional">if</span> n == 1 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line613></span>            cp; next;
<span class="lineno" id=line614></span>            <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line615></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line616></span>            s = ccomment (n - 1);
<span class="lineno" id=line617></span>            <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line618></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line619></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="logical conjunction">and</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"*"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line620></span>          s = ccomment (n + 1);
<span class="lineno" id=line621></span>          <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line622></span>        <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line623></span>          <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line624></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line625></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line626></span>  
<span class="lineno" id=line627></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unexpected drop thru"</span>;
<span class="lineno" id=line628></span>  
<span class="lineno" id=line629></span>  fin:&gt;
<span class="lineno" id=line630></span>     <span class="comment">//println "outof data, final write ..";</span>
<span class="lineno" id=line631></span>     w(); <span class="comment">// whatever is left over gets written</span>
<span class="lineno" id=line632></span>     <span class="small_keyword" title="return">return</span> needs_mathjax, lc out;
<span class="lineno" id=line633></span>  }
<span class="lineno" id=line634></span>  }
<span class="lineno" id=line635></span>  
<span class="lineno" id=line636></span>  
<span class="lineno" id=line637></span>  <span class="comment">//eprintln$ Version::felix_version+" flx2html initialisation";</span>
<span class="lineno" id=line638></span>  
<span class="lineno" id=line639></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line640></span>    <span class="big_keyword" title="Define a mutable variable">var</span> config_lines = split(config_data, <span class="fstring">"\n"</span>);
<span class="lineno" id=line641></span>    config_lines = <span class="library" title="return data structure with function applied to each value">map</span> (strip of (<span class="library" title="binding of C++ string type">string</span>)) config_lines; 
<span class="lineno" id=line642></span>    <span class="big_keyword" title="Define a mutable variable">var</span> pathext = RE2(<span class="fstring">"(.*)\\+=(.*)"</span>);
<span class="lineno" id=line643></span>    <span class="big_keyword" title="Define a mutable variable">var</span> varset = RE2(<span class="fstring">"(.*)=(.*)"</span>);
<span class="lineno" id=line644></span>    <span class="big_keyword" title="Define a mutable variable">var</span> plugin_spec = RE2 <span class="fstring">" *extension (.*)-&gt;(.*)::(.*)"</span>;
<span class="lineno" id=line645></span>  
<span class="lineno" id=line646></span>    <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (4.<span class="library" title="binding of C size_t type">size</span>,StringPiece(<span class="fstring">""</span>));
<span class="lineno" id=line647></span>    <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> config_lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line648></span>      <span class="big_keyword" title="Define a mutable variable">var</span> match_result = Match(pathext, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line649></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line650></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line651></span>        <span class="big_keyword" title="Define a mutable variable">var</span> rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line652></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line653></span>        | <span class="fstring">"FLX_PATH"</span> =&gt; FLX_PATH += rhs; 
<span class="lineno" id=line654></span>        | <span class="fstring">"FLX_PKGCONFIG_PATH"</span> =&gt; FLX_PKGCONFIG_PATH += rhs;
<span class="lineno" id=line655></span>        | <span class="fstring">"FLX_WEBSERVER_PLUGIN_PATH"</span> =&gt; FLX_WEBSERVER_PLUGIN_PATH += rhs;
<span class="lineno" id=line656></span>        | _ =&gt; ;
<span class="lineno" id=line657></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line658></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line659></span>      match_result = Match(varset, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line660></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line661></span>        lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line662></span>        rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line663></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line664></span>        | <span class="fstring">"INSTALL_ROOT"</span> =&gt; INSTALL_ROOT = rhs;
<span class="lineno" id=line665></span>        | _ =&gt; ;
<span class="lineno" id=line666></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line667></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line668></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line669></span>  
<span class="lineno" id=line670></span>    xlat_cpp = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line671></span>      dll-name=<span class="fstring">"cpp2html"</span>, setup-str=config_data, entry-point=<span class="fstring">"cpp2html"</span>
<span class="lineno" id=line672></span>    );
<span class="lineno" id=line673></span>    
<span class="lineno" id=line674></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line675></span>  }
<span class="lineno" id=line676></span>  
<span class="lineno" id=line677></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"flx2html_setup"</span>;
<span class="lineno" id=line678></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> Flx2Html::xlat_felix of (<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"flx2html"</span>;
<span class="lineno" id=line679></span>  
</pre></p></div><h2 id='C_and_C++_code._h'><img src='/share/src/web/images/minus.gif' id='C and C++ code.' onclick='toggle(this,"C_and_C++_code._d")' alt='+'/> 2.5 C and C++ code.</h2><div id='C_and_C++_code._d' style='display:block'>
<pre class='inclusion'>
share/lib/plugins/cpp2html.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./plugin_common"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a mutable variable">var</span> C_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Define a mutable variable">var</span> INSTALL_ROOT = <span class="fstring">""</span>;
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Define a module namespace">module</span> Cpp2Html { 
<span class="lineno" id=line8></span>  <span class="comment">// C++ and C</span>
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Define an immutable value">val</span> cpp_big_keywords = 
<span class="lineno" id=line10></span>    <span class="fstring">"class"</span>,
<span class="lineno" id=line11></span>    <span class="fstring">"struct"</span>,
<span class="lineno" id=line12></span>    <span class="fstring">"union"</span>,
<span class="lineno" id=line13></span>    <span class="fstring">"namespace"</span>,
<span class="lineno" id=line14></span>    <span class="fstring">"typedef"</span>,
<span class="lineno" id=line15></span>    <span class="fstring">"enum"</span>,
<span class="lineno" id=line16></span>    <span class="fstring">"template"</span>
<span class="lineno" id=line17></span>  ;
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>  <span class="big_keyword" title="Define an immutable value">val</span> cpp_small_keywords =
<span class="lineno" id=line20></span>    <span class="fstring">"if"</span>, <span class="fstring">"while"</span>, <span class="fstring">"until"</span>,<span class="fstring">"do"</span>,<span class="fstring">"for"</span>,<span class="fstring">"return"</span>,<span class="fstring">"goto"</span>,<span class="fstring">"std"</span>
<span class="lineno" id=line21></span>  ;
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>  <span class="big_keyword" title="Define an immutable value">val</span> cpp_qualifiers = 
<span class="lineno" id=line24></span>    <span class="fstring">"virtual"</span>, <span class="fstring">"inline"</span>, <span class="fstring">"static"</span>, <span class="fstring">"extern"</span>, <span class="fstring">"public"</span>,<span class="fstring">"private"</span>,<span class="fstring">"protected"</span>,
<span class="lineno" id=line25></span>    <span class="fstring">"int"</span>,<span class="fstring">"long"</span>,<span class="fstring">"unsigned"</span>,<span class="fstring">"float"</span>,<span class="fstring">"double"</span>,<span class="fstring">"char"</span>,<span class="fstring">"short"</span>,<span class="fstring">"signed"</span>,<span class="fstring">"void"</span>,<span class="fstring">"size_t"</span>,
<span class="lineno" id=line26></span>    <span class="fstring">"const"</span>,<span class="fstring">"volatile"</span>,<span class="fstring">"typename"</span>
<span class="lineno" id=line27></span>  ;
<span class="lineno" id=line28></span>  
<span class="lineno" id=line29></span>  <span class="big_keyword" title="Define an immutable value">val</span> cpp_preproc = 
<span class="lineno" id=line30></span>    <span class="fstring">"define"</span>,<span class="fstring">"if"</span>,<span class="fstring">"endif"</span>,<span class="fstring">"else"</span>,<span class="fstring">"include"</span>,<span class="fstring">"ifdef"</span>,<span class="fstring">"ifndef"</span>
<span class="lineno" id=line31></span>  ;
<span class="lineno" id=line32></span>  
<span class="lineno" id=line33></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> xlat_cpp(t:<span class="library" title="binding of C++ string type">string</span>, dir:<span class="library" title="binding of C++ string type">string</span>) : bool * <span class="library" title="binding of C++ string type">string</span>=
<span class="lineno" id=line34></span>  {
<span class="lineno" id=line35></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line36></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> write_string(t:<span class="library" title="binding of C++ string type">string</span>) 
<span class="lineno" id=line37></span>    { 
<span class="lineno" id=line38></span>      out += t;
<span class="lineno" id=line39></span>    }
<span class="lineno" id=line40></span>  
<span class="lineno" id=line41></span>    variant state_t = 
<span class="lineno" id=line42></span>      | sot <span class="comment">// start of token</span>
<span class="lineno" id=line43></span>      | id <span class="comment">// processing identifier</span>
<span class="lineno" id=line44></span>      | num <span class="comment">// in a number</span>
<span class="lineno" id=line45></span>      | sq <span class="comment">// processing single quote string</span>
<span class="lineno" id=line46></span>      | dq <span class="comment">// processing double quote string</span>
<span class="lineno" id=line47></span>      | angle <span class="comment">// processing &lt;filename&gt; string</span>
<span class="lineno" id=line48></span>      | ccomment <span class="comment">// a C style comment</span>
<span class="lineno" id=line49></span>      | cppcomment <span class="comment">// a C++ style comment</span>
<span class="lineno" id=line50></span>    ;
<span class="lineno" id=line51></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> <span class="library" title="Convert a value to a string">str</span>(s:state_t) =&gt; <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line52></span>    | #sot =&gt; <span class="fstring">"sot"</span>
<span class="lineno" id=line53></span>    | #id =&gt; <span class="fstring">"id"</span>
<span class="lineno" id=line54></span>    | #num =&gt; <span class="fstring">"num"</span>
<span class="lineno" id=line55></span>    | #sq =&gt; <span class="fstring">"sq"</span>
<span class="lineno" id=line56></span>    | #dq =&gt; <span class="fstring">"dq"</span>
<span class="lineno" id=line57></span>    | #angle =&gt; <span class="fstring">"angle"</span>
<span class="lineno" id=line58></span>    | #ccomment=&gt; <span class="fstring">"ccomment"</span>
<span class="lineno" id=line59></span>    | #cppcomment =&gt; <span class="fstring">"cppcomment"</span>
<span class="lineno" id=line60></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line61></span>    
<span class="lineno" id=line62></span>    <span class="big_keyword" title="Define a mutable variable">var</span> i = 0; <span class="big_keyword" title="Define a mutable variable">var</span> s:state_t;
<span class="lineno" id=line63></span>    <span class="big_keyword" title="Define a mutable variable">var</span> ch = t.[i];
<span class="lineno" id=line64></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> next() { ch = t.[i]; ++i; }
<span class="lineno" id=line65></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> ahead (j:<span class="library" title="binding of C int type">int</span>)=&gt; t.[i + j - 1]; 
<span class="lineno" id=line66></span>  
<span class="lineno" id=line67></span>    <span class="big_keyword" title="Define a mutable variable">var</span> b = <span class="fstring">""</span>;
<span class="lineno" id=line68></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_id = <span class="fstring">""</span>;
<span class="lineno" id=line69></span>    <span class="big_keyword" title="Define a mutable variable">var</span> last_op = <span class="fstring">""</span>;
<span class="lineno" id=line70></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cp() { b += ch; }
<span class="lineno" id=line71></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ws() {
<span class="lineno" id=line72></span>      <span class="small_keyword" title="conditional">if</span> last_id == <span class="fstring">"include"</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// hackery</span>
<span class="lineno" id=line73></span>        <span class="big_keyword" title="Define a mutable variable">var</span> n = b; 
<span class="lineno" id=line74></span>        <span class="small_keyword" title="while loop">while</span> n.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'&lt;'</span> <span class="small_keyword" title="logical disjunction">or</span> n.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="imperative code begins">do</span> n = n.[1 <span class="small_keyword" title="substring range separator">to</span>]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line75></span>        <span class="small_keyword" title="while loop">while</span> n.[-1] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'&gt;'</span> <span class="small_keyword" title="logical disjunction">or</span> n.[-1] == <span class="library" title="binding of C char type">char</span> <span class="fstring">'"'</span> <span class="small_keyword" title="imperative code begins">do</span> n = n.[<span class="small_keyword" title="substring range separator">to</span> -1]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line76></span>        <span class="big_keyword" title="Define a mutable variable">var</span> x = b;
<span class="lineno" id=line77></span>        <span class="small_keyword" title="conditional">if</span> x.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> x = <span class="fstring">"&amp;lt;"</span> + x.[1 <span class="small_keyword" title="substring range separator">to</span>]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line78></span>        <span class="small_keyword" title="conditional">if</span> x.[-1] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> x = x.[<span class="small_keyword" title="substring range separator">to</span> -1] + <span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line79></span>        <span class="small_keyword" title="match statement or expression">match</span> get_file(n,INSTALL_ROOT,Cons(dir,C_PATH)) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line80></span>        | Some f =&gt; 
<span class="lineno" id=line81></span>            <span class="comment">// the $ is so we know we have resolved the filename</span>
<span class="lineno" id=line82></span>            <span class="comment">// we can't use just / because it means the server root</span>
<span class="lineno" id=line83></span>            <span class="comment">// and we can't use // because firefox thinks it means</span>
<span class="lineno" id=line84></span>            <span class="comment">// the website name is empty</span>
<span class="lineno" id=line85></span>            <span class="comment">// the trailing cpp tells us the filetype is C/C++</span>
<span class="lineno" id=line86></span>            write_string(<span class="fstring">'&lt;a href="/$'</span>+f+<span class="fstring">'" &gt;'</span> + x + <span class="fstring">'&lt;/a&gt;'</span>); 
<span class="lineno" id=line87></span>        | #None =&gt; write_string(<span class="fstring">'&lt;span class="fstring"&gt;'</span>+x+<span class="fstring">"&lt;/span&gt;"</span>);
<span class="lineno" id=line88></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line89></span>      <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line90></span>       write_string(<span class="fstring">'&lt;span class="fstring"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line91></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line92></span>    }
<span class="lineno" id=line93></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> w() { 
<span class="lineno" id=line94></span>      <span class="comment">//println$ "Token["+str s+"]="+b; </span>
<span class="lineno" id=line95></span>      <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line96></span>      | #dq =&gt; ws; 
<span class="lineno" id=line97></span>      | #sq =&gt; ws; 
<span class="lineno" id=line98></span>      | #ccomment=&gt; write_string(<span class="fstring">'&lt;span class="comment"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>);
<span class="lineno" id=line99></span>      | #cppcomment=&gt; write_string(<span class="fstring">'&lt;span class="comment"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>);
<span class="lineno" id=line100></span>      | #id =&gt; 
<span class="lineno" id=line101></span>          last_id = b;
<span class="lineno" id=line102></span>          <span class="small_keyword" title="conditional">if</span> b <span class="small_keyword" title="membership operator, function mem">in</span> cpp_big_keywords <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class="big_keyword"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line103></span>          <span class="small_keyword" title="conditional">elif</span> b <span class="small_keyword" title="membership operator, function mem">in</span> cpp_small_keywords <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class="small_keyword"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line104></span>          <span class="small_keyword" title="conditional">elif</span> b <span class="small_keyword" title="membership operator, function mem">in</span> cpp_qualifiers <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class="qualifier"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); 
<span class="lineno" id=line105></span>          <span class="small_keyword" title="conditional">elif</span> last_op == <span class="fstring">"#"</span> <span class="small_keyword" title="logical conjunction">and</span> b <span class="small_keyword" title="membership operator, function mem">in</span> cpp_preproc <span class="small_keyword" title="imperative code begins">do</span> write_string(<span class="fstring">'&lt;span class="preproc"&gt;'</span>+b+<span class="fstring">"&lt;/span&gt;"</span>); last_op=<span class="fstring">""</span>;
<span class="lineno" id=line106></span>          <span class="small_keyword" title="conditional">else</span> write_string(b); <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line107></span>      | #angle =&gt; ws; 
<span class="lineno" id=line108></span>      | _ =&gt; 
<span class="lineno" id=line109></span>          last_op=b; 
<span class="lineno" id=line110></span>          <span class="small_keyword" title="conditional">if</span> b == <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line111></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line112></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b = <span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line113></span>          <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line114></span>          write_string(b);  
<span class="lineno" id=line115></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line116></span>      b = <span class="fstring">""</span>;  
<span class="lineno" id=line117></span>    }
<span class="lineno" id=line118></span>  
<span class="lineno" id=line119></span>  
<span class="lineno" id=line120></span>    <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line121></span>  
<span class="lineno" id=line122></span>  contin:&gt; <span class="comment">// copy char and continue</span>
<span class="lineno" id=line123></span>    cp();
<span class="lineno" id=line124></span>    <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line125></span>     
<span class="lineno" id=line126></span>  overrun:&gt; <span class="comment">// one past last char of token</span>
<span class="lineno" id=line127></span>    w();
<span class="lineno" id=line128></span>    s = sot;
<span class="lineno" id=line129></span>    <span class="small_keyword" title="jump to label">goto</span> thisch;
<span class="lineno" id=line130></span>  
<span class="lineno" id=line131></span>  lastch:&gt; <span class="comment">// last char of token</span>
<span class="lineno" id=line132></span>    cp();
<span class="lineno" id=line133></span>    w();
<span class="lineno" id=line134></span>  
<span class="lineno" id=line135></span>  nextt:&gt;  <span class="comment">// new token on next char</span>
<span class="lineno" id=line136></span>    s = sot;
<span class="lineno" id=line137></span>  
<span class="lineno" id=line138></span>  nextch:&gt; <span class="comment">// next char</span>
<span class="lineno" id=line139></span>    next();
<span class="lineno" id=line140></span>  
<span class="lineno" id=line141></span>  thisch:&gt; <span class="comment">// same char, reconsider it</span>
<span class="lineno" id=line142></span>    <span class="comment">//println$ "Considering char " + str(ord(ch));</span>
<span class="lineno" id=line143></span>    <span class="small_keyword" title="conditional">if</span> isnull ch <span class="small_keyword" title="jump to label">goto</span> fin; <span class="comment">// out of data</span>
<span class="lineno" id=line144></span>    <span class="small_keyword" title="match statement or expression">match</span> s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line145></span>    | #sot =&gt;
<span class="lineno" id=line146></span>        <span class="small_keyword" title="conditional">if</span> isidstart ch <span class="small_keyword" title="imperative code begins">do</span> s = id; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line147></span>        <span class="small_keyword" title="conditional">elif</span> isdigit ch <span class="small_keyword" title="imperative code begins">do</span> s = num; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line148></span>        <span class="small_keyword" title="conditional">elif</span> issq ch <span class="small_keyword" title="imperative code begins">do</span> s = sq; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line149></span>        <span class="small_keyword" title="conditional">elif</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> s = dq; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line150></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line151></span>          <span class="small_keyword" title="conditional">if</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="imperative code begins">do</span> cp; next; s = cppcomment; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line152></span>          <span class="small_keyword" title="conditional">elif</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"*"</span> <span class="small_keyword" title="imperative code begins">do</span> cp; next; s = ccomment; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line153></span>          <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line154></span>          <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line155></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="logical conjunction">and</span> last_id == <span class="fstring">"include"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line156></span>          s = angle; <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line157></span>        <span class="small_keyword" title="conditional">else</span> cp; w; <span class="small_keyword" title="jump to label">goto</span> nextt;
<span class="lineno" id=line158></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line159></span>  
<span class="lineno" id=line160></span>    | #id =&gt; 
<span class="lineno" id=line161></span>        <span class="small_keyword" title="conditional">if</span> isalphanum ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line162></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun;
<span class="lineno" id=line163></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line164></span>    | #num =&gt; 
<span class="lineno" id=line165></span>        <span class="small_keyword" title="conditional">if</span> isnumeric ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line166></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> overrun; 
<span class="lineno" id=line167></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line168></span>    <span class="comment">// single quoted strings</span>
<span class="lineno" id=line169></span>    | #sq =&gt;
<span class="lineno" id=line170></span>        <span class="small_keyword" title="conditional">if</span> issq ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch; 
<span class="lineno" id=line171></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;lt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line172></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line173></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;amp;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line174></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line175></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line176></span>    | #dq =&gt;
<span class="lineno" id=line177></span>        <span class="small_keyword" title="conditional">if</span> isdq ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line178></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;lt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line179></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;gt;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line180></span>        <span class="small_keyword" title="conditional">elif</span> ch== <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> b+=<span class="fstring">"&amp;amp;"</span>; <span class="small_keyword" title="jump to label">goto</span> nextch;
<span class="lineno" id=line181></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line182></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line183></span>  
<span class="lineno" id=line184></span>    <span class="comment">// &lt;bracket&gt; form</span>
<span class="lineno" id=line185></span>    | #angle =&gt;
<span class="lineno" id=line186></span>        <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line187></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line188></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line189></span>  
<span class="lineno" id=line190></span>    <span class="comment">// comments</span>
<span class="lineno" id=line191></span>    | #cppcomment =&gt;
<span class="lineno" id=line192></span>        <span class="small_keyword" title="conditional">if</span> iseol ch <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line193></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line194></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line195></span>    | #ccomment =&gt; <span class="comment">// doesn't handle nested comments yet</span>
<span class="lineno" id=line196></span>        <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"*"</span> <span class="small_keyword" title="logical conjunction">and</span> ahead(1) == <span class="library" title="binding of C char type">char</span> <span class="fstring">"/"</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line197></span>          cp; 
<span class="lineno" id=line198></span>          <span class="small_keyword" title="jump to label">goto</span> lastch;
<span class="lineno" id=line199></span>        <span class="small_keyword" title="conditional">else</span> <span class="small_keyword" title="jump to label">goto</span> contin;
<span class="lineno" id=line200></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line201></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line202></span>    ; 
<span class="lineno" id=line203></span>    <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unexpected drop thru"</span>;
<span class="lineno" id=line204></span>  
<span class="lineno" id=line205></span>  fin:&gt;
<span class="lineno" id=line206></span>     w(); <span class="comment">// whatever is left over gets written</span>
<span class="lineno" id=line207></span>     <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>, out;
<span class="lineno" id=line208></span>  }
<span class="lineno" id=line209></span>  }
<span class="lineno" id=line210></span>  <span class="comment">//eprintln$ Version::felix_version+ " cpp2html initialisation";</span>
<span class="lineno" id=line211></span>  
<span class="lineno" id=line212></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line213></span>    <span class="big_keyword" title="Define a mutable variable">var</span> config_lines = split(config_data, <span class="fstring">"\n"</span>);
<span class="lineno" id=line214></span>    config_lines = <span class="library" title="return data structure with function applied to each value">map</span> (strip of (<span class="library" title="binding of C++ string type">string</span>)) config_lines; 
<span class="lineno" id=line215></span>    <span class="big_keyword" title="Define a mutable variable">var</span> pathext = RE2(<span class="fstring">"(.*)\\+=(.*)"</span>);
<span class="lineno" id=line216></span>    <span class="big_keyword" title="Define a mutable variable">var</span> varset = RE2(<span class="fstring">"(.*)=(.*)"</span>);
<span class="lineno" id=line217></span>    <span class="big_keyword" title="Define a mutable variable">var</span> plugin_spec = RE2 <span class="fstring">" *extension (.*)-&gt;(.*)::(.*)"</span>;
<span class="lineno" id=line218></span>  
<span class="lineno" id=line219></span>    <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (4.<span class="library" title="binding of C size_t type">size</span>,StringPiece(<span class="fstring">""</span>));
<span class="lineno" id=line220></span>    <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> config_lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line221></span>      <span class="big_keyword" title="Define a mutable variable">var</span> match_result = Match(pathext, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line222></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line223></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line224></span>        <span class="big_keyword" title="Define a mutable variable">var</span> rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line225></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line226></span>        | <span class="fstring">"C_PATH"</span> =&gt; C_PATH += rhs;
<span class="lineno" id=line227></span>        | _ =&gt; ;
<span class="lineno" id=line228></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line229></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line230></span>      match_result = Match(varset, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line231></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line232></span>        lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line233></span>        rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line234></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line235></span>        | <span class="fstring">"INSTALL_ROOT"</span> =&gt; INSTALL_ROOT = rhs;
<span class="lineno" id=line236></span>        | _ =&gt; ;
<span class="lineno" id=line237></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line238></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line239></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line240></span>  
<span class="lineno" id=line241></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line242></span>  }
<span class="lineno" id=line243></span>  
<span class="lineno" id=line244></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"cpp2html_setup"</span>;
<span class="lineno" id=line245></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> Cpp2Html::xlat_cpp of (<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"cpp2html"</span>;
<span class="lineno" id=line246></span>  
<span class="lineno" id=line247></span>  
</pre></p></div><h2 id='Top_level_Felix_<code>html</code>_format._h'><img src='/share/src/web/images/minus.gif' id='Top level Felix <code>html</code> format.' onclick='toggle(this,"Top_level_Felix_<code>html</code>_format._d")' alt='+'/> 2.6 Top level Felix <code>html</code> format.</h2><div id='Top_level_Felix_<code>html</code>_format._d' style='display:block'>
<p>Handles both original <code>html</code> format Felix programs
and also <code>html</code> format <code>flx_iscr.py</code> package format.
Note the former are real Felix programs.
</p><pre class='inclusion'>
share/lib/plugins/html2html.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Open a module or class">open</span> Regdef; <span class="comment">// required</span>
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./plugin_common"</span>;
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./slideshow-interface"</span>;
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Define a mutable variable">var</span> slideshow-maker  : (string-&gt;0) -&gt; slideshow_t;
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./paragraph-interface"</span>;
<span class="lineno" id=line10></span>  <span class="big_keyword" title="Define a mutable variable">var</span> paragraph-maker : (string-&gt;0) -&gt; paragraph-control_t;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./heading-interface"</span>;
<span class="lineno" id=line13></span>  <span class="big_keyword" title="Define a mutable variable">var</span> heading-maker : paragraph-control_t * (string-&gt;0) -&gt; heading-control_t;
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./fileseq-interface"</span>;
<span class="lineno" id=line16></span>  <span class="big_keyword" title="Define a mutable variable">var</span> fileseq-maker : <span class="library" title="binding of C++ string type">string</span> -&gt; fileseq-control_t;
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./scanner-interface"</span>;
<span class="lineno" id=line19></span>  <span class="big_keyword" title="Define a mutable variable">var</span> htmlscanner-maker : <span class="library" title="Type with one values (), the empty tuple">unit</span> -&gt; htmlscanner-control_t;
<span class="lineno" id=line20></span>  
<span class="lineno" id=line21></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./button-interface"</span>;
<span class="lineno" id=line22></span>  <span class="big_keyword" title="Define a mutable variable">var</span> button-factory-maker : <span class="library" title="Type with one values (), the empty tuple">unit</span> -&gt; button-factory_t;
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./html-frame-interface"</span>;
<span class="lineno" id=line25></span>  <span class="big_keyword" title="Define a mutable variable">var</span> html_frame_maker : html_frame_data_t -&gt; html_frame_t;
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./html-interface"</span>;
<span class="lineno" id=line28></span>  
<span class="lineno" id=line29></span>  <span class="big_keyword" title="Define a mutable variable">var</span> xlat_cpp: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; bool * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line30></span>  <span class="big_keyword" title="Define a mutable variable">var</span> xlat_felix: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; bool * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line31></span>  <span class="big_keyword" title="Define a mutable variable">var</span> xlat_ocaml: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; bool * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line32></span>  <span class="big_keyword" title="Define a mutable variable">var</span> xlat_python: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; bool * <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>  <span class="comment">// felix document</span>
<span class="lineno" id=line35></span>  <span class="big_keyword" title="Define a mutable variable">var</span> INSTALL_ROOT=<span class="fstring">""</span>;
<span class="lineno" id=line36></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line37></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FDOC_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line38></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_PKGCONFIG_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line39></span>  <span class="big_keyword" title="Define a mutable variable">var</span> FLX_WEBSERVER_PLUGIN_PATH = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line40></span>  <span class="big_keyword" title="Define a mutable variable">var</span> PLUGIN_MAP = Empty[<span class="library" title="binding of C++ string type">string</span>^3];
<span class="lineno" id=line41></span>  
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_flx (fname:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line44></span>    <span class="big_keyword" title="Define a mutable variable">var</span> flx =
<span class="lineno" id=line45></span>      <span class="small_keyword" title="match statement or expression">match</span> get_file(fname,INSTALL_ROOT,FLX_PATH) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line46></span>      | Some name =&gt; load(name)
<span class="lineno" id=line47></span>      | #None =&gt; f<span class="fstring">"NO FILE %S FOUND IN %S"</span> (fname, <span class="library" title="Convert a value to a string">str</span> FLX_PATH)
<span class="lineno" id=line48></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line49></span>    ;
<span class="lineno" id=line50></span>    <span class="comment">//println$ "Loaded felix file " + fname+", len="+str (flx.len.int);</span>
<span class="lineno" id=line51></span>    <span class="small_keyword" title="return">return</span> flx;
<span class="lineno" id=line52></span>  }
<span class="lineno" id=line53></span>  
<span class="lineno" id=line54></span>  <span class="comment">// fixup text by replacing &lt; &gt; and &amp; characters</span>
<span class="lineno" id=line55></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> txt2html (x:<span class="library" title="binding of C++ string type">string</span>) =
<span class="lineno" id=line56></span>  {
<span class="lineno" id=line57></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out2 = <span class="fstring">""</span>;
<span class="lineno" id=line58></span>    <span class="small_keyword" title="for loop">for</span> <span class="big_keyword" title="Define a mutable variable">var</span> i <span class="small_keyword" title="membership operator, function mem">in</span> 0 <span class="small_keyword" title="upwards counting for loop">upto</span> x.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> - 1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line59></span>      <span class="big_keyword" title="Define a mutable variable">var</span> ch = x.[i];
<span class="lineno" id=line60></span>      <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&lt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;lt;"</span>;
<span class="lineno" id=line61></span>      <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&gt;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;gt;"</span>;
<span class="lineno" id=line62></span>      <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"&amp;"</span> <span class="small_keyword" title="imperative code begins">do</span> out2+=<span class="fstring">"&amp;amp;"</span>;
<span class="lineno" id=line63></span>      <span class="small_keyword" title="conditional">else</span> out2+=ch;
<span class="lineno" id=line64></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line65></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line66></span>  
<span class="lineno" id=line67></span>    <span class="small_keyword" title="return">return</span> out2;
<span class="lineno" id=line68></span>  }
<span class="lineno" id=line69></span>  
<span class="lineno" id=line70></span>  
<span class="lineno" id=line71></span>  <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> boreq(l:&amp;bool, r:bool) { l &lt;- *l <span class="small_keyword" title="logical disjunction">or</span> r; } 
<span class="lineno" id=line72></span>  
<span class="lineno" id=line73></span>  <span class="big_keyword" title="Define an immutable value">val</span> markdown_code1 = RE2 (<span class="fstring">"(@{([^}]*)})"</span>);
<span class="lineno" id=line74></span>  <span class="big_keyword" title="Define an immutable value">val</span> markdown_code2 = RE2 (r<span class="fstring">"(@glossary\(([^)]*)\))"</span>);
<span class="lineno" id=line75></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> markdown (s:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span>= {
<span class="lineno" id=line76></span>    <span class="big_keyword" title="Define a mutable variable">var</span> x = s;
<span class="lineno" id=line77></span>    <span class="hack">C_hack</span>::ignore(GlobalReplace(&amp;x, markdown_code1, StringPiece (<span class="fstring">"&lt;code&gt;\\2&lt;/code&gt;"</span>)));
<span class="lineno" id=line78></span>    <span class="hack">C_hack</span>::ignore(GlobalReplace(&amp;x, markdown_code2, StringPiece (<span class="fstring">"&lt;a href='/share/src/web/ref/glossary.html#\\2'&gt;\\2&lt;/a&gt;"</span>)));
<span class="lineno" id=line79></span>    <span class="small_keyword" title="return">return</span> x;
<span class="lineno" id=line80></span>  }
<span class="lineno" id=line81></span>  
<span class="lineno" id=line82></span>  <span class="big_keyword" title="Define an immutable value">val</span> timeout = Filename::join (#Config::std_config.FLX_TARGET_DIR, <span class="fstring">"bin"</span>, <span class="fstring">"flx_timeout"</span>+#(Filename::executable_extension));
<span class="lineno" id=line83></span>  
<span class="lineno" id=line84></span>  <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> safer_popen(cmd:<span class="library" title="binding of C++ string type">string</span>)=&gt;
<span class="lineno" id=line85></span>    Process::popen_in(timeout+<span class="fstring">" -t 15 "</span> + cmd + <span class="fstring">" 2&gt;&amp;1"</span>)
<span class="lineno" id=line86></span>  ;
<span class="lineno" id=line87></span>  
<span class="lineno" id=line88></span>  <span class="comment">// helper definitions</span>
<span class="lineno" id=line89></span>  <span class="big_keyword" title="define named regular expression">regdef</span> optwhite = <span class="fstring">' '</span>*;
<span class="lineno" id=line90></span>  <span class="big_keyword" title="define named regular expression">regdef</span> white = <span class="fstring">' '</span>+;
<span class="lineno" id=line91></span>  <span class="big_keyword" title="define named regular expression">regdef</span> felt= perl (<span class="fstring">"\\$?[A-Za-z._][-A-Za-z0-9_.]*"</span>);
<span class="lineno" id=line92></span>  <span class="big_keyword" title="define named regular expression">regdef</span> fname = (felt <span class="fstring">"/"</span>)* felt;
<span class="lineno" id=line93></span>  
<span class="lineno" id=line94></span>  <span class="comment">// A tangler definition looks like:</span>
<span class="lineno" id=line95></span>  <span class="comment">// @tangler name = filename</span>
<span class="lineno" id=line96></span>  <span class="big_keyword" title="define named regular expression">regdef</span> tangler_def_regdef = 
<span class="lineno" id=line97></span>    <span class="fstring">"tangler"</span> white group (felt) optwhite <span class="fstring">"="</span> 
<span class="lineno" id=line98></span>    optwhite group (fname) optwhite 
<span class="lineno" id=line99></span>  ; 
<span class="lineno" id=line100></span>  
<span class="lineno" id=line101></span>  <span class="comment">// To set the output we just use</span>
<span class="lineno" id=line102></span>  <span class="comment">// @tangle name</span>
<span class="lineno" id=line103></span>  <span class="big_keyword" title="define named regular expression">regdef</span> tangler_use_regdef = 
<span class="lineno" id=line104></span>    <span class="fstring">"tangle"</span> white group (felt) optwhite 
<span class="lineno" id=line105></span>  ; 
<span class="lineno" id=line106></span>  <span class="big_keyword" title="Define a mutable variable">var</span> tangler_def_re2 = RE2 (Regdef::render tangler_def_regdef);
<span class="lineno" id=line107></span>  <span class="big_keyword" title="Define a mutable variable">var</span> tangler_use_re2 = RE2 (Regdef::render tangler_use_regdef);
<span class="lineno" id=line108></span>  
<span class="lineno" id=line109></span>  <span class="big_keyword" title="define an object factory">object</span> xlat_html (t:<span class="library" title="binding of C++ string type">string</span>, filename:<span class="library" title="binding of C++ string type">string</span>) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> html_t = {
<span class="lineno" id=line110></span>  
<span class="lineno" id=line111></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"Translator for "</span> + filename;
<span class="lineno" id=line112></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> mathjax_required () =&gt; needs_mathjax;
<span class="lineno" id=line113></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_raw () =&gt; out;
<span class="lineno" id=line114></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_page () =&gt; page;
<span class="lineno" id=line115></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_title () =&gt; title;
<span class="lineno" id=line116></span>    <span class="big_keyword" title="Define a mutable variable">var</span> title = filename;
<span class="lineno" id=line117></span>    <span class="big_keyword" title="Define a mutable variable">var</span> slideshow = slideshow-maker write_string of (<span class="library" title="binding of C++ string type">string</span>);
<span class="lineno" id=line118></span>    <span class="comment">//eprintln$ "FDOC make slidehow .. " + #(slideshow.whatami);</span>
<span class="lineno" id=line119></span>  
<span class="lineno" id=line120></span>    <span class="big_keyword" title="Define a mutable variable">var</span> paragraph = paragraph-maker write_string of (<span class="library" title="binding of C++ string type">string</span>);
<span class="lineno" id=line121></span>    <span class="comment">//eprintln$ "FDOC make paragraph .. " + #(paragraph.whatami);</span>
<span class="lineno" id=line122></span>  
<span class="lineno" id=line123></span>    <span class="big_keyword" title="Define a mutable variable">var</span> heading = heading-maker (paragraph, write_string of (<span class="library" title="binding of C++ string type">string</span>));
<span class="lineno" id=line124></span>    <span class="comment">//eprintln$ "FDOC make heading .. " + #(heading.whatami);</span>
<span class="lineno" id=line125></span>  
<span class="lineno" id=line126></span>    <span class="big_keyword" title="Define a mutable variable">var</span> fileseq = fileseq-maker (filename);
<span class="lineno" id=line127></span>    <span class="comment">//eprintln$ "FDOC make fileseq .. " + #(fileseq.whatami);</span>
<span class="lineno" id=line128></span>  
<span class="lineno" id=line129></span>    <span class="big_keyword" title="Define a mutable variable">var</span> htmlscanner = htmlscanner-maker ();
<span class="lineno" id=line130></span>    <span class="comment">//eprintln$ "FDOC make scanner .. " + #(htmlscanner.whatami);</span>
<span class="lineno" id=line131></span>  
<span class="lineno" id=line132></span>    <span class="big_keyword" title="Define a mutable variable">var</span> html_frame_data :html_frame_data_t = (heading=heading, button-factory=#button-factory-maker,fileseq=fileseq);
<span class="lineno" id=line133></span>    <span class="big_keyword" title="Define a mutable variable">var</span> html_frame = html_frame_maker html_frame_data;
<span class="lineno" id=line134></span>  
<span class="lineno" id=line135></span>  
<span class="lineno" id=line136></span>    <span class="big_keyword" title="Define a mutable variable">var</span> needs_mathjax = <span class="library" title="false value">false</span>;
<span class="lineno" id=line137></span>    <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line138></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> write_string(t:<span class="library" title="binding of C++ string type">string</span>) 
<span class="lineno" id=line139></span>    { 
<span class="lineno" id=line140></span>      out += t;
<span class="lineno" id=line141></span>    }
<span class="lineno" id=line142></span>  
<span class="lineno" id=line143></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> split_first (x:<span class="library" title="binding of C++ string type">string</span>, c:<span class="library" title="binding of C++ string type">string</span>):<span class="library" title="binding of C++ string type">string</span>*<span class="library" title="binding of C++ string type">string</span> =&gt;
<span class="lineno" id=line144></span>      <span class="small_keyword" title="match statement or expression">match</span> find_first_of (x, c) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line145></span>        | Some n =&gt; (strip(x.[<span class="small_keyword" title="substring range separator">to</span> n]),strip(x.[n+1 <span class="small_keyword" title="substring range separator">to</span>]))
<span class="lineno" id=line146></span>        | _ =&gt; (x,<span class="fstring">""</span>)
<span class="lineno" id=line147></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line148></span>    ;
<span class="lineno" id=line149></span>  
<span class="lineno" id=line150></span>    <span class="big_keyword" title="Define a mutable variable">var</span> tanglers = strdict[<span class="library" title="binding of C++ string type">string</span>] ();
<span class="lineno" id=line151></span>  
<span class="lineno" id=line152></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> def_tangler (id:<span class="library" title="binding of C++ string type">string</span>, filename:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line153></span>    {
<span class="lineno" id=line154></span>      <span class="small_keyword" title="match statement or expression">match</span> get tanglers id <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line155></span>      | Some _ =&gt;
<span class="lineno" id=line156></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Duplicate definition of tangler "</span> + id;
<span class="lineno" id=line157></span>      | #None =&gt;
<span class="lineno" id=line158></span>        <span class="comment">//println$ "Add tangler id=" + id + " filename=" + filename;</span>
<span class="lineno" id=line159></span>        add tanglers id filename;
<span class="lineno" id=line160></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line161></span>    }
<span class="lineno" id=line162></span>     
<span class="lineno" id=line163></span>    <span class="comment">// paragraphs</span>
<span class="lineno" id=line164></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> sp () { paragraph.sp (); }
<span class="lineno" id=line165></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> sp (cls:<span class="library" title="binding of C++ string type">string</span>) { paragraph.sp-clas cls; }
<span class="lineno" id=line166></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ep () { paragraph.ep (); }
<span class="lineno" id=line167></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> bp () { paragraph.bp (); }
<span class="lineno" id=line168></span>  
<span class="lineno" id=line169></span>    <span class="comment">// headings</span>
<span class="lineno" id=line170></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> h(n:<span class="library" title="binding of C int type">int</span>, txt:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line171></span>      heading.head (#(fileseq.docnum), n, markdown txt);
<span class="lineno" id=line172></span>    }
<span class="lineno" id=line173></span>  
<span class="lineno" id=line174></span>  <span class="comment">//---------------------------------------------------</span>
<span class="lineno" id=line175></span>    <span class="comment">// main loop</span>
<span class="lineno" id=line176></span>    <span class="big_keyword" title="Define a mutable variable">var</span> inp = htmlscanner.html_scan t;
<span class="lineno" id=line177></span>    <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> get_text () =&gt;
<span class="lineno" id=line178></span>      <span class="small_keyword" title="match statement or expression">match</span> #inp <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line179></span>      | Some (Text x) =&gt; x
<span class="lineno" id=line180></span>      | _ =&gt; <span class="fstring">""</span>
<span class="lineno" id=line181></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line182></span>    ;
<span class="lineno" id=line183></span>  next:&gt;
<span class="lineno" id=line184></span>    <span class="big_keyword" title="Define a mutable variable">var</span> entry = #inp;
<span class="lineno" id=line185></span>    <span class="small_keyword" title="match statement or expression">match</span> entry <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line186></span>    | Some (Cmd cmdline) =&gt; handle_cmd cmdline; <span class="small_keyword" title="jump to label">goto</span> next;
<span class="lineno" id=line187></span>    | Some (Text x) =&gt;
<span class="lineno" id=line188></span>      <span class="small_keyword" title="for loop">for</span> para <span class="small_keyword" title="membership operator, function mem">in</span> htmlscanner.psplit x <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line189></span>        bp; 
<span class="lineno" id=line190></span>        write_string(markdown para); 
<span class="lineno" id=line191></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line192></span>      ep;
<span class="lineno" id=line193></span>      <span class="small_keyword" title="jump to label">goto</span> next;
<span class="lineno" id=line194></span>  
<span class="lineno" id=line195></span>    | #None =&gt; 
<span class="lineno" id=line196></span>      ep;
<span class="lineno" id=line197></span>      heading.finalise();
<span class="lineno" id=line198></span>  
<span class="lineno" id=line199></span>      slideshow.finalise();
<span class="lineno" id=line200></span>      <span class="small_keyword" title="conditional">if</span> #(slideshow.active) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line201></span>        eprintln$ <span class="fstring">"Slideshow Active"</span>;
<span class="lineno" id=line202></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line203></span>        <span class="comment">//eprintln$ "Slideshow NOT active";</span>
<span class="lineno" id=line204></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line205></span>    <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line206></span>  
<span class="lineno" id=line207></span>    <span class="big_keyword" title="Define a mutable variable">var</span> page = 
<span class="lineno" id=line208></span>     <span class="small_keyword" title="conditional">if</span> #(slideshow.active)  <span class="small_keyword" title="conditional">then</span> out 
<span class="lineno" id=line209></span>     <span class="small_keyword" title="conditional">else</span> html_frame.make_frame out
<span class="lineno" id=line210></span>     <span class="small_keyword" title="conditional">endif</span>
<span class="lineno" id=line211></span>    ;
<span class="lineno" id=line212></span>  
<span class="lineno" id=line213></span>  <span class="comment">//---------------------------------------------------</span>
<span class="lineno" id=line214></span>  
<span class="lineno" id=line215></span>    <span class="comment">// preformat</span>
<span class="lineno" id=line216></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_pre(b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line217></span>    {
<span class="lineno" id=line218></span>      sp; 
<span class="lineno" id=line219></span>      write_string(<span class="fstring">'&lt;pre class="prefmtbg"&gt;'</span>); 
<span class="lineno" id=line220></span>      write_string(txt2html b); 
<span class="lineno" id=line221></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line222></span>      ep;
<span class="lineno" id=line223></span>    }
<span class="lineno" id=line224></span>  
<span class="lineno" id=line225></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_expect(b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line226></span>    {
<span class="lineno" id=line227></span>      sp; 
<span class="lineno" id=line228></span>      write_string(<span class="fstring">'&lt;pre class="expected"&gt;'</span>); 
<span class="lineno" id=line229></span>      write_string(txt2html b); 
<span class="lineno" id=line230></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line231></span>      ep;
<span class="lineno" id=line232></span>    }
<span class="lineno" id=line233></span>  
<span class="lineno" id=line234></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_input(b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line235></span>    {
<span class="lineno" id=line236></span>      sp; 
<span class="lineno" id=line237></span>      write_string(<span class="fstring">'&lt;pre class="input"&gt;'</span>); 
<span class="lineno" id=line238></span>      write_string(txt2html b); 
<span class="lineno" id=line239></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line240></span>      ep;
<span class="lineno" id=line241></span>    }
<span class="lineno" id=line242></span>  
<span class="lineno" id=line243></span>  
<span class="lineno" id=line244></span>  
<span class="lineno" id=line245></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_cpp (b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line246></span>    {
<span class="lineno" id=line247></span>      sp;
<span class="lineno" id=line248></span>      write_string(<span class="fstring">"&lt;pre class='cppbg'&gt;"</span>); 
<span class="lineno" id=line249></span>      write_string((xlat_cpp(b,<span class="fstring">""</span>)).1); <span class="comment">// no parent!</span>
<span class="lineno" id=line250></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>);
<span class="lineno" id=line251></span>      ep; 
<span class="lineno" id=line252></span>    }
<span class="lineno" id=line253></span>  
<span class="lineno" id=line254></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_felix (b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line255></span>    {
<span class="lineno" id=line256></span>      sp;
<span class="lineno" id=line257></span>      write_string(<span class="fstring">"&lt;pre class='flxbg'&gt;"</span>); 
<span class="lineno" id=line258></span>      needs_mathjax', txt := xlat_felix (b,<span class="fstring">""</span>);
<span class="lineno" id=line259></span>      needs_mathjax |= needs_mathjax';
<span class="lineno" id=line260></span>      write_string(txt); <span class="comment">// no parent!</span>
<span class="lineno" id=line261></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>);
<span class="lineno" id=line262></span>      ep; 
<span class="lineno" id=line263></span>    }
<span class="lineno" id=line264></span>  
<span class="lineno" id=line265></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_felix_unchecked (b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line266></span>    {
<span class="lineno" id=line267></span>      sp;
<span class="lineno" id=line268></span>      write_string(<span class="fstring">"&lt;pre class='uncheckedflxbg'&gt;"</span>); 
<span class="lineno" id=line269></span>      needs_mathjax', txt := xlat_felix (b,<span class="fstring">""</span>);
<span class="lineno" id=line270></span>      needs_mathjax |= needs_mathjax';
<span class="lineno" id=line271></span>      write_string(txt); <span class="comment">// no parent!</span>
<span class="lineno" id=line272></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>);
<span class="lineno" id=line273></span>      ep; 
<span class="lineno" id=line274></span>    }
<span class="lineno" id=line275></span>  
<span class="lineno" id=line276></span>  
<span class="lineno" id=line277></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_ocaml(b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line278></span>    {
<span class="lineno" id=line279></span>      sp;
<span class="lineno" id=line280></span>      write_string(<span class="fstring">"&lt;pre class='flxbg'&gt;"</span>); 
<span class="lineno" id=line281></span>      needs_mathjax', txt := xlat_ocaml(b,<span class="fstring">""</span>);
<span class="lineno" id=line282></span>      needs_mathjax |= needs_mathjax';
<span class="lineno" id=line283></span>      write_string(txt); <span class="comment">// no parent!</span>
<span class="lineno" id=line284></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>);
<span class="lineno" id=line285></span>      ep; 
<span class="lineno" id=line286></span>    }
<span class="lineno" id=line287></span>  
<span class="lineno" id=line288></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> inline_python(b:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line289></span>    {
<span class="lineno" id=line290></span>      sp;
<span class="lineno" id=line291></span>      write_string(<span class="fstring">"&lt;pre class='flxbg'&gt;"</span>); 
<span class="lineno" id=line292></span>      needs_mathjax', txt := xlat_python(b,<span class="fstring">""</span>);
<span class="lineno" id=line293></span>      needs_mathjax |= needs_mathjax';
<span class="lineno" id=line294></span>      write_string(txt); <span class="comment">// no parent!</span>
<span class="lineno" id=line295></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>);
<span class="lineno" id=line296></span>      ep; 
<span class="lineno" id=line297></span>    }
<span class="lineno" id=line298></span>  
<span class="lineno" id=line299></span>  
<span class="lineno" id=line300></span>  
<span class="lineno" id=line301></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> felix_file (rest:<span class="library" title="binding of C++ string type">string</span>) 
<span class="lineno" id=line302></span>    {
<span class="lineno" id=line303></span>        <span class="big_keyword" title="Define a mutable variable">var</span> re1 = RE2(<span class="fstring">'(.*) "(.*)" "(.*)"'</span>);
<span class="lineno" id=line304></span>        <span class="big_keyword" title="Define a mutable variable">var</span> re2 = RE2(<span class="fstring">'(.*) "(.*)"'</span>);
<span class="lineno" id=line305></span>        <span class="big_keyword" title="Define a mutable variable">var</span> v1 = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>(4uz, StringPiece <span class="fstring">""</span>);
<span class="lineno" id=line306></span>        <span class="big_keyword" title="Define a mutable variable">var</span> v2 = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>(4uz, StringPiece <span class="fstring">""</span>);
<span class="lineno" id=line307></span>        <span class="big_keyword" title="Define a mutable variable">var</span> v3 = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>(4uz, StringPiece <span class="fstring">""</span>);
<span class="lineno" id=line308></span>        <span class="big_keyword" title="Define a mutable variable">var</span> matched1 = Match(re1, StringPiece(rest),0,ANCHOR_BOTH,v1.stl_begin, v1.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line309></span>        <span class="big_keyword" title="Define a mutable variable">var</span> matched2 = Match(re2, StringPiece(rest),0,ANCHOR_BOTH,v2.stl_begin, v2.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line310></span>        <span class="small_keyword" title="conditional">if</span> matched1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line311></span>          <span class="big_keyword" title="Define a mutable variable">var</span> fname = v1.1.<span class="library" title="binding of C++ string type">string</span>.strip;
<span class="lineno" id=line312></span>        <span class="small_keyword" title="conditional">elif</span> matched2 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line313></span>          fname = v2.1.<span class="library" title="binding of C++ string type">string</span>.strip;
<span class="lineno" id=line314></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line315></span>          fname = rest;
<span class="lineno" id=line316></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line317></span>        <span class="big_keyword" title="Define a mutable variable">var</span> flx = get_flx(fname);
<span class="lineno" id=line318></span>        <span class="small_keyword" title="conditional">if</span> matched1 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line319></span>          <span class="big_keyword" title="Define a mutable variable">var</span> p1 = <span class="small_keyword" title="match statement or expression">match</span> find(flx,v1.2.<span class="library" title="binding of C++ string type">string</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line320></span>          | Some i =&gt; i.<span class="library" title="binding of C int type">int</span>
<span class="lineno" id=line321></span>          | #None =&gt; 0
<span class="lineno" id=line322></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line323></span>          flx = flx.[p1 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line324></span>          <span class="big_keyword" title="Define a mutable variable">var</span> p2 = <span class="small_keyword" title="match statement or expression">match</span> find(flx,v1.3.<span class="library" title="binding of C++ string type">string</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line325></span>          | Some i =&gt; i.<span class="library" title="binding of C int type">int</span>
<span class="lineno" id=line326></span>          | #None =&gt; flx.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> - 1
<span class="lineno" id=line327></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line328></span>          flx = flx.[<span class="small_keyword" title="substring range separator">to</span> p2];
<span class="lineno" id=line329></span>        <span class="small_keyword" title="conditional">elif</span> matched2 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line330></span>          <span class="big_keyword" title="Define a mutable variable">var</span> re3 = RE2(v2.2.<span class="library" title="binding of C++ string type">string</span>);
<span class="lineno" id=line331></span>          <span class="big_keyword" title="Define a mutable variable">var</span> matched3 = Match(re3,StringPiece(flx),0,UNANCHORED,v3.stl_begin, v3.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line332></span>          <span class="small_keyword" title="conditional">if</span> matched3 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line333></span>            flx = v3.1.<span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line334></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line335></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line336></span>        needs_mathjax', html := xlat_felix (flx,<span class="fstring">""</span>);
<span class="lineno" id=line337></span>        needs_mathjax |= needs_mathjax';
<span class="lineno" id=line338></span>        write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;\n"</span>+fname+<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line339></span>        write_string(<span class="fstring">"&lt;pre class='flxbg'&gt;"</span>); 
<span class="lineno" id=line340></span>        write_string(html);
<span class="lineno" id=line341></span>        write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line342></span>    }
<span class="lineno" id=line343></span>  
<span class="lineno" id=line344></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> flx_and_expect (fname:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line345></span>    {
<span class="lineno" id=line346></span>      <span class="big_keyword" title="Define a mutable variable">var</span> flx = get_flx(fname+<span class="fstring">".flx"</span>);
<span class="lineno" id=line347></span>      needs_mathjax', html := xlat_felix (flx,<span class="fstring">""</span>);
<span class="lineno" id=line348></span>      needs_mathjax |= needs_mathjax';
<span class="lineno" id=line349></span>      write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;"</span>+fname+<span class="fstring">".flx&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line350></span>      write_string(<span class="fstring">"&lt;pre class='flxbg'&gt;"</span>); 
<span class="lineno" id=line351></span>      write_string(html);
<span class="lineno" id=line352></span>      write_string(<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line353></span>      heading.add_button fname;
<span class="lineno" id=line354></span>      write_string(heading.tree_button(fname,fname+<span class="fstring">"_d"</span>));
<span class="lineno" id=line355></span>      write_string(<span class="fstring">"&lt;code class='inclusion'&gt;  "</span>+fname+<span class="fstring">".expect&lt;/code&gt;\n"</span>);
<span class="lineno" id=line356></span>      <span class="big_keyword" title="Define a mutable variable">var</span> xpected = get_flx(fname+<span class="fstring">".expect"</span>);
<span class="lineno" id=line357></span>      write_string(<span class="fstring">"&lt;pre id='"</span>+fname+<span class="fstring">"_d' class='expected' style='display:none'&gt;"</span>); 
<span class="lineno" id=line358></span>      write_string(xpected);
<span class="lineno" id=line359></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line360></span>    }
<span class="lineno" id=line361></span>  
<span class="lineno" id=line362></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> extern_cpp (fname:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line363></span>    {
<span class="lineno" id=line364></span>      <span class="big_keyword" title="Define a mutable variable">var</span> flx = get_flx(fname);
<span class="lineno" id=line365></span>      write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;\n"</span>+fname+<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line366></span>      write_string(<span class="fstring">"&lt;pre class='cppbg'&gt;"</span>); 
<span class="lineno" id=line367></span>      write_string((xlat_cpp (flx,<span class="fstring">""</span>)).1);
<span class="lineno" id=line368></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line369></span>    }
<span class="lineno" id=line370></span>  
<span class="lineno" id=line371></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> extern_ocaml (fname:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line372></span>    {
<span class="lineno" id=line373></span>      <span class="big_keyword" title="Define a mutable variable">var</span> flx = get_flx(fname);
<span class="lineno" id=line374></span>      write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;\n"</span>+fname+<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line375></span>      write_string(<span class="fstring">"&lt;pre class='cppbg'&gt;"</span>); 
<span class="lineno" id=line376></span>      write_string((xlat_ocaml(flx,<span class="fstring">""</span>)).1);
<span class="lineno" id=line377></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line378></span>    }
<span class="lineno" id=line379></span>  
<span class="lineno" id=line380></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> extern_python(fname:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line381></span>    {
<span class="lineno" id=line382></span>      <span class="big_keyword" title="Define a mutable variable">var</span> flx = get_flx(fname);
<span class="lineno" id=line383></span>      write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;\n"</span>+fname+<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line384></span>      write_string(<span class="fstring">"&lt;pre class='cppbg'&gt;"</span>); 
<span class="lineno" id=line385></span>      write_string((xlat_python(flx,<span class="fstring">""</span>)).1);
<span class="lineno" id=line386></span>      write_string(<span class="fstring">"&lt;/pre&gt;"</span>); 
<span class="lineno" id=line387></span>    }
<span class="lineno" id=line388></span>    
<span class="lineno" id=line389></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> handle_cmd (b:<span class="library" title="binding of C++ string type">string</span>) 
<span class="lineno" id=line390></span>    {
<span class="lineno" id=line391></span>  <span class="comment">//println$ "CMD=@"+b;</span>
<span class="lineno" id=line392></span>      <span class="small_keyword" title="match statement or expression">match</span> Match (tangler_def_re2, b) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line393></span>      | Some v =&gt; def_tangler (v.1, v.2);
<span class="lineno" id=line394></span>      | #None =&gt; 
<span class="lineno" id=line395></span>        <span class="small_keyword" title="match statement or expression">match</span> Match (tangler_use_re2, b) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line396></span>        | Some s =&gt; 
<span class="lineno" id=line397></span>          <span class="comment">//println$ "Tangle id=" + s.1;</span>
<span class="lineno" id=line398></span>          <span class="small_keyword" title="match statement or expression">match</span> get tanglers s.1 <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line399></span>          | Some x =&gt; 
<span class="lineno" id=line400></span>            <span class="comment">//println$ "Tangler filename=" + x;</span>
<span class="lineno" id=line401></span>            <span class="big_keyword" title="Define a mutable variable">var</span> xtn = Filename::get_extension x;
<span class="lineno" id=line402></span>            <span class="comment">//println$ "Extension=" + xtn;</span>
<span class="lineno" id=line403></span>            <span class="small_keyword" title="conditional">if</span> xtn <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">".flx"</span>,<span class="fstring">".flxh"</span>,<span class="fstring">".fsyn"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line404></span>              write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;\n"</span>+x+<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line405></span>              <span class="comment">//println$ "flx ....";</span>
<span class="lineno" id=line406></span>              inline_felix (#get_text);
<span class="lineno" id=line407></span>            <span class="small_keyword" title="conditional">elif</span> xtn <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">".cxx"</span>,<span class="fstring">".cpp"</span>,<span class="fstring">".hpp"</span>,<span class="fstring">".c"</span>,<span class="fstring">".cc"</span>,<span class="fstring">".h"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line408></span>              write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;\n"</span>+x+<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line409></span>              <span class="comment">//println$ "cpp ....";</span>
<span class="lineno" id=line410></span>              inline_cpp (#get_text);
<span class="lineno" id=line411></span>            <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line412></span>              write_string(<span class="fstring">"&lt;pre class='inclusion'&gt;\n"</span>+x+<span class="fstring">"&lt;/pre&gt;\n"</span>);
<span class="lineno" id=line413></span>              <span class="comment">//println$ "pre ....";</span>
<span class="lineno" id=line414></span>              inline_pre (#get_text);
<span class="lineno" id=line415></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line416></span>          | #None =&gt; 
<span class="lineno" id=line417></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Can't find tangler '"</span> + s.1+<span class="fstring">"'"</span>;
<span class="lineno" id=line418></span>            inline_pre (#get_text);
<span class="lineno" id=line419></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line420></span>        | #None =&gt; 
<span class="lineno" id=line421></span>          <span class="small_keyword" title="conditional">if</span> b == <span class="fstring">"felix"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_felix (#get_text);
<span class="lineno" id=line422></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"felix-unchecked"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_felix_unchecked (#get_text);
<span class="lineno" id=line423></span>          <span class="small_keyword" title="conditional">elif</span> prefix (b,<span class="fstring">"felix "</span>) <span class="small_keyword" title="imperative code begins">do</span> felix_file (strip (b.[6 <span class="small_keyword" title="substring range separator">to</span>]));
<span class="lineno" id=line424></span>          <span class="small_keyword" title="conditional">elif</span> prefix (b,<span class="fstring">"flx-and-expect "</span>) <span class="small_keyword" title="imperative code begins">do</span> flx_and_expect (strip(b.[15 <span class="small_keyword" title="substring range separator">to</span>]));
<span class="lineno" id=line425></span>  
<span class="lineno" id=line426></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"c++"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_cpp (#get_text);
<span class="lineno" id=line427></span>          <span class="small_keyword" title="conditional">elif</span> prefix (b,<span class="fstring">"c++"</span>) <span class="small_keyword" title="imperative code begins">do</span> extern_cpp ( strip(b.[4 <span class="small_keyword" title="substring range separator">to</span>]));
<span class="lineno" id=line428></span>  
<span class="lineno" id=line429></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"ocaml"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_ocaml (#get_text);
<span class="lineno" id=line430></span>          <span class="small_keyword" title="conditional">elif</span> prefix (b,<span class="fstring">"ocaml"</span>) <span class="small_keyword" title="imperative code begins">do</span> extern_ocaml( strip(b.[6 <span class="small_keyword" title="substring range separator">to</span>]));
<span class="lineno" id=line431></span>  
<span class="lineno" id=line432></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"python"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_python(#get_text);
<span class="lineno" id=line433></span>          <span class="small_keyword" title="conditional">elif</span> prefix (b,<span class="fstring">"python"</span>) <span class="small_keyword" title="imperative code begins">do</span> extern_python( strip(b.[7 <span class="small_keyword" title="substring range separator">to</span>]));
<span class="lineno" id=line434></span>  
<span class="lineno" id=line435></span>  
<span class="lineno" id=line436></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"p"</span> <span class="small_keyword" title="imperative code begins">do</span> bp; 
<span class="lineno" id=line437></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"pre"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_pre (#get_text);
<span class="lineno" id=line438></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"expect"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_expect (#get_text);
<span class="lineno" id=line439></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"input"</span> <span class="small_keyword" title="imperative code begins">do</span> inline_input(#get_text);
<span class="lineno" id=line440></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"obsolete"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'obsolete'</span>; write_string(<span class="fstring">"&lt;em&gt;Obsolete&lt;/em&gt; "</span>);
<span class="lineno" id=line441></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"caveat"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'caveat'</span>; write_string(<span class="fstring">"&lt;em&gt;Caveat: &lt;/em&gt; "</span>);
<span class="lineno" id=line442></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"impl"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'implementation_detail'</span>; write_string(<span class="fstring">"&lt;em&gt;Implementation Detail: &lt;/em&gt;"</span>);
<span class="lineno" id=line443></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"future"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'future'</span>; write_string(<span class="fstring">"&lt;em&gt;In future: &lt;/em&gt;"</span>);
<span class="lineno" id=line444></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"note"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'bug'</span>; write_string(<span class="fstring">"&lt;em&gt;Note: &lt;/em&gt;"</span>);
<span class="lineno" id=line445></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"bug"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'bug'</span>; write_string(<span class="fstring">"&lt;em&gt;Bug: &lt;/em&gt;"</span>);
<span class="lineno" id=line446></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"fixed"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'fixed'</span>; write_string(<span class="fstring">"&lt;em&gt;Fixed: &lt;/em&gt;"</span>);
<span class="lineno" id=line447></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"done"</span> <span class="small_keyword" title="imperative code begins">do</span> ep; sp <span class="fstring">'done'</span>; write_string(<span class="fstring">"&lt;em&gt;Done: &lt;/em&gt;"</span>);
<span class="lineno" id=line448></span>          <span class="small_keyword" title="conditional">elif</span> b==<span class="fstring">"mathjax"</span> <span class="small_keyword" title="imperative code begins">do</span> needs_mathjax = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line449></span>  
<span class="lineno" id=line450></span>          <span class="small_keyword" title="conditional">elif</span> prefix (b,<span class="fstring">"title"</span>) <span class="small_keyword" title="imperative code begins">do</span> title = strip(b.[5 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line451></span>  
<span class="lineno" id=line452></span>          <span class="small_keyword" title="conditional">elif</span> prefix(b,<span class="fstring">"h1"</span>) <span class="small_keyword" title="imperative code begins">do</span> h(1,b.[3 <span class="small_keyword" title="substring range separator">to</span>]); 
<span class="lineno" id=line453></span>          <span class="small_keyword" title="conditional">elif</span> prefix(b,<span class="fstring">"h2"</span>) <span class="small_keyword" title="imperative code begins">do</span> h(2,b.[3 <span class="small_keyword" title="substring range separator">to</span>]); 
<span class="lineno" id=line454></span>          <span class="small_keyword" title="conditional">elif</span> prefix(b,<span class="fstring">"h3"</span>) <span class="small_keyword" title="imperative code begins">do</span> h(3,b.[3 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line455></span>          <span class="small_keyword" title="conditional">elif</span> prefix(b,<span class="fstring">"h4"</span>) <span class="small_keyword" title="imperative code begins">do</span> h(4,b.[3 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line456></span>          <span class="small_keyword" title="conditional">elif</span> prefix(b,<span class="fstring">"h5"</span>) <span class="small_keyword" title="imperative code begins">do</span> h(5,b.[3 <span class="small_keyword" title="substring range separator">to</span>]);
<span class="lineno" id=line457></span>  
<span class="lineno" id=line458></span>          <span class="comment">// external image</span>
<span class="lineno" id=line459></span>          <span class="small_keyword" title="conditional">elif</span> prefix(b,<span class="fstring">"image"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line460></span>            <span class="big_keyword" title="Define a mutable variable">var</span> img = split_first(b.[6 <span class="small_keyword" title="substring range separator">to</span>],<span class="fstring">"|"</span>);
<span class="lineno" id=line461></span>            write_string(<span class="fstring">"&lt;img src='"</span>+img.(0)+<span class="fstring">"' style='"</span>+img.(1)+<span class="fstring">"'&gt;&lt;/img&gt;"</span>);
<span class="lineno" id=line462></span>  
<span class="lineno" id=line463></span>          <span class="comment">// arbitrary shell command</span>
<span class="lineno" id=line464></span>          <span class="small_keyword" title="conditional">elif</span> prefix(b,<span class="fstring">"sh"</span>) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line465></span>            <span class="big_keyword" title="Define a mutable variable">var</span> cmd = b.[3 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line466></span>            <span class="big_keyword" title="Define a mutable variable">var</span> fout = safer_popen(cmd);
<span class="lineno" id=line467></span>            <span class="small_keyword" title="conditional">if</span> valid fout <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line468></span>              <span class="big_keyword" title="Define a mutable variable">var</span> output = load fout;
<span class="lineno" id=line469></span>              <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Process::pclose fout; 
<span class="lineno" id=line470></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ran cmd="</span> + cmd;
<span class="lineno" id=line471></span>              <span class="comment">//println$ "Output = " + output;</span>
<span class="lineno" id=line472></span>              write_string(<span class="fstring">"&lt;pre&gt;"</span>);
<span class="lineno" id=line473></span>              write_string output;
<span class="lineno" id=line474></span>              write_string(<span class="fstring">"&lt;/pre&gt;"</span>);
<span class="lineno" id=line475></span>            <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line476></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unable to run shell command '"</span> + cmd <span class="fstring">"'"</span>;
<span class="lineno" id=line477></span>              write_string(<span class="fstring">"Failed cmd: "</span> + b);
<span class="lineno" id=line478></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line479></span>  
<span class="lineno" id=line480></span>          <span class="comment">// slideshow</span>
<span class="lineno" id=line481></span>          <span class="small_keyword" title="conditional">elif</span> slideshow.check-slide-commands b <span class="small_keyword" title="imperative code begins">do</span> ;
<span class="lineno" id=line482></span>          <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> ;
<span class="lineno" id=line483></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line484></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unable to understand @command '"</span>+b+<span class="fstring">"'"</span>;
<span class="lineno" id=line485></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line486></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line487></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line488></span>    }
<span class="lineno" id=line489></span>  }
<span class="lineno" id=line490></span>  
<span class="lineno" id=line491></span>  <span class="comment">//eprintln$ Version::felix_version +  " html2html initialisation";</span>
<span class="lineno" id=line492></span>  
<span class="lineno" id=line493></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line494></span>    <span class="big_keyword" title="Define a mutable variable">var</span> config_lines = split(config_data, <span class="fstring">"\n"</span>);
<span class="lineno" id=line495></span>    config_lines = <span class="library" title="return data structure with function applied to each value">map</span> (strip of (<span class="library" title="binding of C++ string type">string</span>)) config_lines; 
<span class="lineno" id=line496></span>    <span class="big_keyword" title="Define a mutable variable">var</span> pathext = RE2(<span class="fstring">"(.*)\\+=(.*)"</span>);
<span class="lineno" id=line497></span>    <span class="big_keyword" title="Define a mutable variable">var</span> varset = RE2(<span class="fstring">"(.*)=(.*)"</span>);
<span class="lineno" id=line498></span>    <span class="big_keyword" title="Define a mutable variable">var</span> plugin_spec = RE2 <span class="fstring">" *extension (.*)-&gt;(.*)::(.*)"</span>;
<span class="lineno" id=line499></span>  
<span class="lineno" id=line500></span>    <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[StringPiece] (4.<span class="library" title="binding of C size_t type">size</span>,StringPiece(<span class="fstring">""</span>));
<span class="lineno" id=line501></span>    <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> config_lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line502></span>      <span class="big_keyword" title="Define a mutable variable">var</span> match_result = Match(pathext, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line503></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line504></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line505></span>        <span class="big_keyword" title="Define a mutable variable">var</span> rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line506></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line507></span>        | <span class="fstring">"FLX_PATH"</span> =&gt; FLX_PATH += rhs; 
<span class="lineno" id=line508></span>        | <span class="fstring">"FDOC_PATH"</span> =&gt; FDOC_PATH += rhs; 
<span class="lineno" id=line509></span>        | <span class="fstring">"FLX_PKGCONFIG_PATH"</span> =&gt; FLX_PKGCONFIG_PATH += rhs;
<span class="lineno" id=line510></span>        | <span class="fstring">"FLX_WEBSERVER_PLUGIN_PATH"</span> =&gt; FLX_WEBSERVER_PLUGIN_PATH += rhs;
<span class="lineno" id=line511></span>        | _ =&gt; ;
<span class="lineno" id=line512></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line513></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line514></span>      match_result = Match(varset, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,3);
<span class="lineno" id=line515></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line516></span>        lhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line517></span>        rhs = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line518></span>        <span class="small_keyword" title="match statement or expression">match</span> lhs <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line519></span>        | <span class="fstring">"INSTALL_ROOT"</span> =&gt; INSTALL_ROOT = rhs;
<span class="lineno" id=line520></span>        | _ =&gt; ;
<span class="lineno" id=line521></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line522></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line523></span>      match_result = Match(plugin_spec, StringPiece(line),0,ANCHOR_BOTH, <span class="small_keyword" title="value of function return used in post condition">result</span>.stl_begin,4);
<span class="lineno" id=line524></span>      <span class="small_keyword" title="conditional">if</span> match_result <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line525></span>        <span class="big_keyword" title="Define a mutable variable">var</span> extn = <span class="small_keyword" title="value of function return used in post condition">result</span>.1.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line526></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lib = <span class="small_keyword" title="value of function return used in post condition">result</span>.2.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line527></span>        <span class="big_keyword" title="Define a mutable variable">var</span> entry = <span class="small_keyword" title="value of function return used in post condition">result</span>.3.<span class="library" title="Convert a value to a string">str</span>.strip;
<span class="lineno" id=line528></span>        PLUGIN_MAP = Cons ((extn, lib, entry), PLUGIN_MAP);
<span class="lineno" id=line529></span>      <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of body">done</span> <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line530></span>    <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line531></span>  
<span class="lineno" id=line532></span>    xlat_felix = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line533></span>      dll-name=<span class="fstring">"flx2html"</span>, setup-str=config_data, entry-point=<span class="fstring">"flx2html"</span>
<span class="lineno" id=line534></span>    );
<span class="lineno" id=line535></span>  
<span class="lineno" id=line536></span>    xlat_cpp = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line537></span>      dll-name=<span class="fstring">"cpp2html"</span>, setup-str=config_data, entry-point=<span class="fstring">"cpp2html"</span>
<span class="lineno" id=line538></span>    );
<span class="lineno" id=line539></span>  
<span class="lineno" id=line540></span>    xlat_ocaml = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line541></span>      dll-name=<span class="fstring">"ocaml2html"</span>, setup-str=config_data, entry-point=<span class="fstring">"ocaml2html"</span>
<span class="lineno" id=line542></span>    );
<span class="lineno" id=line543></span>  
<span class="lineno" id=line544></span>    xlat_python = Dynlink::load-plugin-func2 [bool * <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>, <span class="library" title="binding of C++ string type">string</span>] (
<span class="lineno" id=line545></span>      dll-name=<span class="fstring">"py2html"</span>, setup-str=config_data, entry-point=<span class="fstring">"py2html"</span>
<span class="lineno" id=line546></span>    );
<span class="lineno" id=line547></span>  
<span class="lineno" id=line548></span>  
<span class="lineno" id=line549></span>    slideshow-maker  = Dynlink::load-plugin-func1 [slideshow_t, (string-&gt;0)] (dll-name=<span class="fstring">"html_slideshow"</span>);
<span class="lineno" id=line550></span>  
<span class="lineno" id=line551></span>    paragraph-maker = Dynlink::load-plugin-func1 [paragraph-control_t, (string-&gt;0)] (dll-name=<span class="fstring">"html_paragraph"</span>);
<span class="lineno" id=line552></span>  
<span class="lineno" id=line553></span>    heading-maker = Dynlink::load-plugin-func2 [heading-control_t, paragraph-control_t , (string-&gt;0)] (dll-name=<span class="fstring">"html_heading"</span>);
<span class="lineno" id=line554></span>  
<span class="lineno" id=line555></span>    fileseq-maker = Dynlink::load-plugin-func1 [fileseq-control_t,<span class="library" title="binding of C++ string type">string</span>] (dll-name=<span class="fstring">"html_fileseq"</span>);
<span class="lineno" id=line556></span>  
<span class="lineno" id=line557></span>    htmlscanner-maker = Dynlink::load-plugin-func0 [htmlscanner-control_t] (dll-name=<span class="fstring">"html_scanner"</span>);
<span class="lineno" id=line558></span>  
<span class="lineno" id=line559></span>    button-factory-maker = Dynlink::load-plugin-func0 [button-factory_t] (dll-name=<span class="fstring">"html_button"</span>);
<span class="lineno" id=line560></span>  
<span class="lineno" id=line561></span>    html_frame_maker = Dynlink::load-plugin-func1 [html_frame_t,html_frame_data_t] (dll-name=<span class="fstring">"html_frame"</span>);
<span class="lineno" id=line562></span>  
<span class="lineno" id=line563></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line564></span>  }
<span class="lineno" id=line565></span>  
<span class="lineno" id=line566></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html2html_setup"</span>;
<span class="lineno" id=line567></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> xlat_html of (<span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html2html"</span>;
</pre></p></div></div><h1 id='Decorator_Interfaces._h'><img src='/share/src/web/images/minus.gif' id='Decorator Interfaces.' onclick='toggle(this,"Decorator_Interfaces._d")' alt='+'/> 3 Decorator Interfaces.</h1><div id='Decorator_Interfaces._d' style='display:block'>
<p>Web page architecture layout and decorators.
</p><pre class='inclusion'>
share/lib/plugins/button-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="define an object interface">interface</span> button-spec_t {
<span class="lineno" id=line2></span>    id: <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line3></span>    text: <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line4></span>    onclick: <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line5></span>  }
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="big_keyword" title="define an object interface">interface</span> button-factory_t {
<span class="lineno" id=line8></span>    whatami: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line9></span>    get-jscript: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line10></span>    make-button: button-spec_t -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line11></span>  }
</pre></p><pre class='inclusion'>
share/lib/plugins/toc_menu-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  
<span class="lineno" id=line2></span>  <span class="big_keyword" title="define an object interface">interface</span> toc_menu_interface {
<span class="lineno" id=line3></span>    whatami: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line4></span>    get_style: 1-&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line5></span>    get_js: 1-&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line6></span>    make_menu: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line7></span>  }
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/edit-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  
<span class="lineno" id=line2></span>  <span class="big_keyword" title="define an object interface">interface</span> edit-interface_t {
<span class="lineno" id=line3></span>    whatami: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line4></span>    get_header: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line5></span>    get_body : <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line6></span>  }
</pre></p><pre class='inclusion'>
share/lib/plugins/html-frame-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./heading-interface"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./button-interface"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./fileseq-interface"</span>;
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Define an alias for a type expression">typedef</span> html_frame_data_t = (
<span class="lineno" id=line6></span>    heading: heading-control_t,
<span class="lineno" id=line7></span>    button-factory: button-factory_t,
<span class="lineno" id=line8></span>    fileseq: fileseq-control_t
<span class="lineno" id=line9></span>  );
<span class="lineno" id=line10></span>  
<span class="lineno" id=line11></span>  <span class="big_keyword" title="define an object interface">interface</span> html_frame_t {
<span class="lineno" id=line12></span>    whatami : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line13></span>    make_frame: <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line14></span>  }
<span class="lineno" id=line15></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="define an object interface">interface</span> html_t {
<span class="lineno" id=line2></span>    whatami : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line3></span>    html_raw : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line4></span>    html_page : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line5></span>    html_title: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line6></span>    mathjax_required: 1 -&gt; bool;
<span class="lineno" id=line7></span>  }
<span class="lineno" id=line8></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/fileseq-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="define an object interface">interface</span> fileseq-control_t {
<span class="lineno" id=line2></span>    whatami: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line3></span>    shownav: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line4></span>    docnum: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line5></span>    get-jscript: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line6></span>  }
</pre></p><pre class='inclusion'>
share/lib/plugins/heading-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="define an object interface">interface</span> heading-control_t {
<span class="lineno" id=line2></span>    whatami: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line3></span>    get_headings: 1 -&gt; <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line4></span>    head : <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; 0;
<span class="lineno" id=line5></span>    tree_button : <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span> -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line6></span>    add_button: <span class="library" title="binding of C++ string type">string</span> -&gt; 0;
<span class="lineno" id=line7></span>    emit-buttons: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line8></span>    emit-js: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line9></span>    finalise: 1 -&gt; 0;
<span class="lineno" id=line10></span>  }
</pre></p><pre class='inclusion'>
share/lib/plugins/paragraph-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="define an object interface">interface</span> paragraph-control_t {
<span class="lineno" id=line2></span>    whatami: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line3></span>    sp : 1 -&gt; 0;
<span class="lineno" id=line4></span>    sp-clas : <span class="library" title="binding of C++ string type">string</span> -&gt; 0;
<span class="lineno" id=line5></span>    ep : 1 -&gt; 0;
<span class="lineno" id=line6></span>    bp : 1 -&gt; 0;
<span class="lineno" id=line7></span>  }
</pre></p><pre class='inclusion'>
share/lib/plugins/scanner-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="comment">// split up an html into a stream of commands and text </span>
<span class="lineno" id=line2></span>  variant html-data_t = 
<span class="lineno" id=line3></span>    | Cmd of <span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line4></span>    | Text of <span class="library" title="binding of C++ string type">string</span>
<span class="lineno" id=line5></span>  ;
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  <span class="big_keyword" title="define an object interface">interface</span> htmlscanner-control_t {
<span class="lineno" id=line8></span>    whatami: 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line9></span>    html_scan : <span class="library" title="binding of C++ string type">string</span> -&gt; 1 -&gt;  <span class="library" title="option type: Some x or None">opt</span>[html-data_t];
<span class="lineno" id=line10></span>    psplit : <span class="library" title="binding of C++ string type">string</span> -&gt; 1 -&gt; <span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line11></span>  }
<span class="lineno" id=line12></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/slideshow-interface.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="define an object interface">interface</span> slideshow_t {
<span class="lineno" id=line2></span>    whatami : 1 -&gt; <span class="library" title="binding of C++ string type">string</span>;
<span class="lineno" id=line3></span>    check-slide-commands : <span class="library" title="binding of C++ string type">string</span> -&gt; bool;
<span class="lineno" id=line4></span>    finalise: 1 -&gt; 0;
<span class="lineno" id=line5></span>    active : 1 -&gt; bool;
<span class="lineno" id=line6></span>  }
<span class="lineno" id=line7></span>  
</pre></p></div><h1 id='Decorator_Implementations._h'><img src='/share/src/web/images/minus.gif' id='Decorator Implementations.' onclick='toggle(this,"Decorator_Implementations._d")' alt='+'/> 4 Decorator Implementations.</h1><div id='Decorator_Implementations._d' style='display:block'>
<pre class='inclusion'>
share/lib/plugins/html_button.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="doccomment">Make buttons in a consistent style</span>
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./button-interface"</span>;
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line5></span>    <span class="comment">//eprintln$ "Setup html_button " + config_data;</span>
<span class="lineno" id=line6></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line7></span>  }
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Define an immutable value">val</span> jscript = <span class="fstring">"""
<span class="lineno" id=line10></span>  &lt;script&gt;
<span class="lineno" id=line11></span>  function mouseover(id)
<span class="lineno" id=line12></span>  {
<span class="lineno" id=line13></span>    var elt = document.getElementById(id);
<span class="lineno" id=line14></span>    elt.style.display="none";
<span class="lineno" id=line15></span>    var elt2 = document.getElementById(id+"_mo");
<span class="lineno" id=line16></span>    elt2.style.display="inline";
<span class="lineno" id=line17></span>  }
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>  function mouseout(id)
<span class="lineno" id=line20></span>  {
<span class="lineno" id=line21></span>    var elt = document.getElementById(id+"_mo");
<span class="lineno" id=line22></span>    elt.style.display="none";
<span class="lineno" id=line23></span>    var elt2 = document.getElementById(id);
<span class="lineno" id=line24></span>    elt2.style.display="inline";
<span class="lineno" id=line25></span>  }
<span class="lineno" id=line26></span>  
<span class="lineno" id=line27></span>  &lt;/script&gt;
<span class="lineno" id=line28></span>  """</span>;
<span class="lineno" id=line29></span>  
<span class="lineno" id=line30></span>  <span class="big_keyword" title="define an object factory">object</span> html_button () <span class="small_keyword" title="specify what interfaces an object implements">implements</span> button-factory_t = {
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"button factory"</span>;
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get-jscript () =&gt; jscript;
<span class="lineno" id=line35></span>  
<span class="lineno" id=line36></span>    <span class="big_keyword" title="Define an immutable value">val</span> sz = 65,30; <span class="comment">// frame size</span>
<span class="lineno" id=line37></span>    <span class="big_keyword" title="Define an immutable value">val</span> bz = 60,20; <span class="comment">// button size</span>
<span class="lineno" id=line38></span>    <span class="big_keyword" title="Define an immutable value">val</span> bp = 4,6; <span class="comment">// button pos in frame</span>
<span class="lineno" id=line39></span>    <span class="big_keyword" title="Define an immutable value">val</span> cr = 4,40; <span class="comment">// corner radii</span>
<span class="lineno" id=line40></span>    <span class="big_keyword" title="Define an immutable value">val</span> st = 2,<span class="fstring">"black"</span>; <span class="comment">// border stroke thickness and colour</span>
<span class="lineno" id=line41></span>    <span class="big_keyword" title="Define an immutable value">val</span> fc = <span class="fstring">"blue"</span>,0.2; <span class="comment">// fill colour and opacity</span>
<span class="lineno" id=line42></span>    <span class="big_keyword" title="Define an immutable value">val</span> hfc = <span class="fstring">"red"</span>,0.2; <span class="comment">// hilight colour and opacity</span>
<span class="lineno" id=line43></span>    <span class="big_keyword" title="Define an immutable value">val</span> tp = 13,21; <span class="comment">// text position in frame</span>
<span class="lineno" id=line44></span>    <span class="big_keyword" title="Define an immutable value">val</span> tc = <span class="fstring">"black"</span>; <span class="comment">// text colour</span>
<span class="lineno" id=line45></span>    <span class="big_keyword" title="Define an immutable value">val</span> fz = <span class="fstring">"12px"</span>; <span class="comment">// font size</span>
<span class="lineno" id=line46></span>  
<span class="lineno" id=line47></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> rect (bz: <span class="library" title="binding of C int type">int</span>^2, cr:<span class="library" title="binding of C int type">int</span>^2, st: <span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span>, fc: <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C double float type">double</span>) (bp:<span class="library" title="binding of C int type">int</span>^2) =&gt;
<span class="lineno" id=line48></span>      <span class="fstring">'&lt;rect '</span>+
<span class="lineno" id=line49></span>        <span class="fstring">'x="'</span>+bp.0.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" y="'</span>+bp.1.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" '</span>+
<span class="lineno" id=line50></span>        <span class="fstring">'rx="'</span>+cr.0.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" ry="'</span>+cr.1.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" '</span>+
<span class="lineno" id=line51></span>        <span class="fstring">'width="'</span>+bz.0.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" height="'</span>+bz.1.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" '</span>+
<span class="lineno" id=line52></span>        <span class="fstring">'style='</span>+
<span class="lineno" id=line53></span>          <span class="fstring">'"'</span>+
<span class="lineno" id=line54></span>            <span class="fstring">'fill:'</span>+fc.0+<span class="fstring">';opacity:'</span>+fc.1.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">';'</span>+
<span class="lineno" id=line55></span>            <span class="fstring">'stroke:'</span>+st.1+<span class="fstring">';stroke-width:'</span>+st.0.<span class="library" title="Convert a value to a string">str</span>+
<span class="lineno" id=line56></span>         <span class="fstring">'"'</span>+
<span class="lineno" id=line57></span>       <span class="fstring">'/&gt;'</span>
<span class="lineno" id=line58></span>    ;
<span class="lineno" id=line59></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> text (tc:<span class="library" title="binding of C++ string type">string</span>, txt:<span class="library" title="binding of C++ string type">string</span>) (tp:<span class="library" title="binding of C int type">int</span>^2) =&gt;
<span class="lineno" id=line60></span>      <span class="fstring">'&lt;text x="'</span>+tp.0.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" y="'</span>+tp.1+<span class="fstring">'px" fill="'</span>+tc+
<span class="lineno" id=line61></span>      <span class="fstring">'" style="font-size:'</span>+fz+<span class="fstring">';"&gt;'</span>+txt+<span class="fstring">'&lt;/text&gt;'</span>
<span class="lineno" id=line62></span>    ;
<span class="lineno" id=line63></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> span (id:<span class="library" title="binding of C++ string type">string</span>) (txt:<span class="library" title="binding of C++ string type">string</span>) =&gt; 
<span class="lineno" id=line64></span>      <span class="fstring">'&lt;span id="'</span>+id+<span class="fstring">'"&gt;'</span> + txt + <span class="fstring">'&lt;/span&gt;'</span>
<span class="lineno" id=line65></span>    ;
<span class="lineno" id=line66></span>  
<span class="lineno" id=line67></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> span_hide (id:<span class="library" title="binding of C++ string type">string</span>) (txt:<span class="library" title="binding of C++ string type">string</span>) =&gt; 
<span class="lineno" id=line68></span>      <span class="fstring">'&lt;span id="'</span>+id+<span class="fstring">'" style="display:none"&gt;'</span> + txt + <span class="fstring">'&lt;/span&gt;'</span>
<span class="lineno" id=line69></span>    ;
<span class="lineno" id=line70></span>  
<span class="lineno" id=line71></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> svg (sz:<span class="library" title="binding of C int type">int</span>^2) (txt:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line72></span>      <span class="fstring">'&lt;svg height="'</span>+sz.1.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">'px" width="'</span> + sz.0.<span class="library" title="Convert a value to a string">str</span> + <span class="fstring">'px"&gt;'</span> + txt + <span class="fstring">'&lt;/svg&gt;'</span>
<span class="lineno" id=line73></span>    ;
<span class="lineno" id=line74></span>  
<span class="lineno" id=line75></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> make-button (b:button-spec_t) =&gt;
<span class="lineno" id=line76></span>    <span class="fstring">"""&lt;span style="position:relative; bottom:6px"
<span class="lineno" id=line77></span>    onmouseover="mouseover('"""</span>+b.id+<span class="fstring">"""')" 
<span class="lineno" id=line78></span>    onmouseout="mouseout('"""</span>+b.id+<span class="fstring">"""')"
<span class="lineno" id=line79></span>    onclick=\"""</span><span class="fstring">"+b.onclick+"</span><span class="fstring">""</span>(<span class="fstring">'"""+b.id+"""'</span>)<span class="fstring">"  
<span class="lineno" id=line80></span>    &gt;"</span><span class="fstring">""</span> +
<span class="lineno" id=line81></span>  
<span class="lineno" id=line82></span>     span b.id (
<span class="lineno" id=line83></span>      svg sz ( rect (bz,cr,st,fc) bp + text (tc,b.text) tp )
<span class="lineno" id=line84></span>     ) +
<span class="lineno" id=line85></span>     span_hide (b.id+<span class="fstring">"_mo"</span>) (
<span class="lineno" id=line86></span>      svg sz ( rect (bz,cr,st,hfc) bp + text (tc,b.text) tp ) 
<span class="lineno" id=line87></span>     )
<span class="lineno" id=line88></span>     +
<span class="lineno" id=line89></span>    <span class="fstring">'&lt;/span&gt;'</span>
<span class="lineno" id=line90></span>    ;
<span class="lineno" id=line91></span>  }
<span class="lineno" id=line92></span>  
<span class="lineno" id=line93></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_button_setup"</span>;
<span class="lineno" id=line94></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_button of (<span class="library" title="Type with one values (), the empty tuple">unit</span>) as <span class="fstring">"html_button"</span>;
<span class="lineno" id=line95></span>  
<span class="lineno" id=line96></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html_edit.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./edit-interface"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line4></span>    <span class="comment">//eprintln$ "Setup html_edit " + config_data;</span>
<span class="lineno" id=line5></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line6></span>  }
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Define a mutable variable">var</span> mime-to-file = 
<span class="lineno" id=line9></span>    <span class="library" title="functional, singly linked list">list</span> (
<span class="lineno" id=line10></span>      (<span class="fstring">"text/x-felix"</span>, <span class="fstring">"flx_codemirror/mode/felix/felix.js"</span>),
<span class="lineno" id=line11></span>      (<span class="fstring">"text/x-ocaml"</span>, <span class="fstring">"codemirror/mode/mllike/mllike.js"</span>),
<span class="lineno" id=line12></span>      (<span class="fstring">"text/x-csrc"</span>, <span class="fstring">"codemirror/mode/clike/clike.js"</span>),
<span class="lineno" id=line13></span>      (<span class="fstring">"text/x-c++src"</span>, <span class="fstring">"codemirror/mode/clike/clike.js"</span>),
<span class="lineno" id=line14></span>      (<span class="fstring">"text/x-python"</span>, <span class="fstring">"codemirror/mode/python/python.js"</span>),
<span class="lineno" id=line15></span>      (<span class="fstring">"text/html"</span>, <span class="fstring">"codemirror/mode/htmlmixed/htmlmixed.js"</span>),
<span class="lineno" id=line16></span>      (<span class="fstring">"application/xml"</span>, <span class="fstring">"codemirror/mode/xml/xml.js"</span>),
<span class="lineno" id=line17></span>      (<span class="fstring">"text/s-tex"</span>, <span class="fstring">"codemirror/mode/stex/stex.js"</span>),
<span class="lineno" id=line18></span>      (<span class="fstring">"text/css"</span>, <span class="fstring">"codemirror/mode/css/css.js"</span>)
<span class="lineno" id=line19></span>    )
<span class="lineno" id=line20></span>  ;
<span class="lineno" id=line21></span>  
<span class="lineno" id=line22></span>  <span class="big_keyword" title="define an object factory">object</span> html_edit () <span class="small_keyword" title="specify what interfaces an object implements">implements</span> edit-interface_t = {
<span class="lineno" id=line23></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"html edit"</span>;
<span class="lineno" id=line24></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_header (filename:<span class="library" title="binding of C++ string type">string</span>, mimetype:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line25></span>      <span class="small_keyword" title="let binder">let</span> modefile = 
<span class="lineno" id=line26></span>         <span class="small_keyword" title="match statement or expression">match</span> Assoc_list::find mime-to-file mimetype <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line27></span>         | Some f =&gt; f
<span class="lineno" id=line28></span>         | #None =&gt; <span class="fstring">"flx_codemirror/felix/felix.js"</span>
<span class="lineno" id=line29></span>         <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line30></span>      <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>      <span class="fstring">"&lt;title&gt;"</span>+filename+<span class="fstring">"&lt;/title&gt;"</span> +
<span class="lineno" id=line33></span>      <span class="fstring">''' 
<span class="lineno" id=line34></span>      &lt;link rel="stylesheet" href="/share/src/codemirror/lib/codemirror.css"&gt;
<span class="lineno" id=line35></span>      &lt;link rel="stylesheet" href="/share/src/codemirror/addon/fold/foldgutter.css"&gt;
<span class="lineno" id=line36></span>      &lt;script src="/share/src/codemirror/lib/codemirror.js"&gt;&lt;/script&gt;
<span class="lineno" id=line37></span>      &lt;script src="/share/src/'''</span>+modefile+<span class="fstring">'''"&gt;&lt;/script&gt;
<span class="lineno" id=line38></span>      &lt;script src="/share/src/codemirror/addon/edit/matchbrackets.js"&gt;&lt;/script&gt;
<span class="lineno" id=line39></span>      &lt;script src="/share/src/codemirror/addon/fold/foldcode.js"&gt;&lt;/script&gt;
<span class="lineno" id=line40></span>      &lt;script src="/share/src/codemirror/addon/fold/foldgutter.js"&gt;&lt;/script&gt;
<span class="lineno" id=line41></span>      &lt;script src="/share/src/codemirror/addon/fold/brace-fold.js"&gt;&lt;/script&gt;
<span class="lineno" id=line42></span>      &lt;script src="/share/src/codemirror/addon/fold/comment-fold.js"&gt;&lt;/script&gt;
<span class="lineno" id=line43></span>      &lt;style&gt;.CodeMirror {border: 2px inset #dee; height:auto; }&lt;/style&gt;
<span class="lineno" id=line44></span>      &lt;style&gt;.CodeMirror-scroll {overflow-x: hidden; overflow-y:auto; }&lt;/style&gt;
<span class="lineno" id=line45></span>      '''</span>
<span class="lineno" id=line46></span>    ;
<span class="lineno" id=line47></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_body (id:<span class="library" title="binding of C++ string type">string</span>, mime:<span class="library" title="binding of C++ string type">string</span>, text:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line48></span>     <span class="fstring">'&lt;form action="doedit" method="post" enctype="text/plain"&gt;'</span>+
<span class="lineno" id=line49></span>     <span class="fstring">'&lt;input type="submit" value="Save"&gt;&lt;br&gt;'</span>+
<span class="lineno" id=line50></span>     <span class="fstring">'&lt;textarea id="'</span>+id+<span class="fstring">'" name="code"&gt;'</span>+
<span class="lineno" id=line51></span>     text +
<span class="lineno" id=line52></span>     <span class="fstring">'&lt;/textarea&gt;&lt;/form&gt;'</span> +
<span class="lineno" id=line53></span>      <span class="fstring">'''
<span class="lineno" id=line54></span>      &lt;script&gt;
<span class="lineno" id=line55></span>        var editor = CodeMirror.fromTextArea(document.getElementById("'''</span>+id+<span class="fstring">'''"), {
<span class="lineno" id=line56></span>          lineNumbers: true,
<span class="lineno" id=line57></span>          lineWrapping: true,
<span class="lineno" id=line58></span>          matchBrackets: true,
<span class="lineno" id=line59></span>          smartIndent: false,
<span class="lineno" id=line60></span>          viewportMargin: Infinity,
<span class="lineno" id=line61></span>          extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
<span class="lineno" id=line62></span>          foldGutter:true,
<span class="lineno" id=line63></span>          gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
<span class="lineno" id=line64></span>          mode: "'''</span>+mime+<span class="fstring">'''"
<span class="lineno" id=line65></span>        });
<span class="lineno" id=line66></span>      &lt;/script&gt;
<span class="lineno" id=line67></span>      '''</span>
<span class="lineno" id=line68></span>    ;
<span class="lineno" id=line69></span>  
<span class="lineno" id=line70></span>  }
<span class="lineno" id=line71></span>  
<span class="lineno" id=line72></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_edit_setup"</span>;
<span class="lineno" id=line73></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_edit of (<span class="library" title="Type with one values (), the empty tuple">unit</span>) as <span class="fstring">"html_edit"</span>;
<span class="lineno" id=line74></span>  
<span class="lineno" id=line75></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html_fileseq.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./fileseq-interface"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./button-interface"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Define a mutable variable">var</span> button-factory : <span class="library" title="Type with one values (), the empty tuple">unit</span> -&gt; button-factory_t;
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line7></span>    <span class="comment">//eprintln$ "Setup html_fileseq " + config_data;</span>
<span class="lineno" id=line8></span>    button-factory = Dynlink::load-plugin-func0 [button-factory_t] (dll-name=<span class="fstring">"html_button"</span>);
<span class="lineno" id=line9></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line10></span>  }
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>  <span class="big_keyword" title="define an object factory">object</span> html_fileseq (filename: <span class="library" title="binding of C++ string type">string</span>) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> fileseq-control_t = 
<span class="lineno" id=line13></span>  {
<span class="lineno" id=line14></span>    <span class="big_keyword" title="Define a mutable variable">var</span> button = #button-factory;
<span class="lineno" id=line15></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami()=&gt; <span class="fstring">"Filename sequence navigation object"</span>;
<span class="lineno" id=line16></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get-jscript() =&gt; <span class="fstring">"&lt;script&gt; function nop(dummy) {} &lt;/script&gt;"</span>;
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> calnav() = 
<span class="lineno" id=line19></span>    {
<span class="lineno" id=line20></span>      <span class="big_keyword" title="Define an immutable value">val</span> relfile = <span class="small_keyword" title="match statement or expression">match</span> (filename,<span class="fstring">'/'</span>).split.<span class="library" title="return data structure with elements reversed">rev</span>.unbox <span class="small_keyword" title="type-class constraint">with</span> | Cons(h,_) =&gt; h | #Empty =&gt; <span class="fstring">""</span>;
<span class="lineno" id=line21></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lpos = relfile.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line22></span>      <span class="small_keyword" title="while loop">while</span> lpos &gt; 0 <span class="small_keyword" title="logical conjunction">and</span> <span class="small_keyword" title="logical negation">not</span> isdigit(relfile.[lpos - 1]) <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line23></span>         --lpos; 
<span class="lineno" id=line24></span>      <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line25></span>      <span class="big_keyword" title="Run time assertion">assert</span> lpos == 0 <span class="small_keyword" title="logical disjunction">or</span> relfile.[lpos - 1].isdigit;
<span class="lineno" id=line26></span>      <span class="big_keyword" title="Define a mutable variable">var</span> fpos = lpos;
<span class="lineno" id=line27></span>      <span class="small_keyword" title="while loop">while</span> fpos &gt; 0 <span class="small_keyword" title="logical conjunction">and</span> isdigit(relfile.[fpos - 1]) <span class="small_keyword" title="imperative code begins">do</span> --fpos; <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line28></span>      <span class="big_keyword" title="Run time assertion">assert</span> fpos == 0 <span class="small_keyword" title="logical disjunction">or</span> relfile.[fpos].isdigit;
<span class="lineno" id=line29></span>      <span class="big_keyword" title="Define an immutable value">val</span> digits = 
<span class="lineno" id=line30></span>        <span class="small_keyword" title="conditional">if</span> fpos &gt;=0 <span class="small_keyword" title="logical conjunction">and</span> lpos &gt; fpos <span class="small_keyword" title="conditional">then</span>
<span class="lineno" id=line31></span>          relfile.[fpos <span class="small_keyword" title="substring range separator">to</span> lpos]
<span class="lineno" id=line32></span>        <span class="small_keyword" title="conditional">else</span> <span class="fstring">""</span>
<span class="lineno" id=line33></span>      ;
<span class="lineno" id=line34></span>  
<span class="lineno" id=line35></span>      <span class="big_keyword" title="Define an immutable value">val</span> n = digits.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line36></span>      <span class="big_keyword" title="Define an immutable value">val</span> v = digits.<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line37></span>      <span class="big_keyword" title="Define an immutable value">val</span> vnext = v + 1;
<span class="lineno" id=line38></span>      <span class="big_keyword" title="Define an immutable value">val</span> vprev = v - 1;
<span class="lineno" id=line39></span>      <span class="big_keyword" title="Define a mutable variable">var</span> snext = (f<span class="fstring">"%010d"</span> vnext).[10-n <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line40></span>      <span class="big_keyword" title="Define a mutable variable">var</span> sprev= (f<span class="fstring">"%010d"</span> vprev).[10-n <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line41></span>  
<span class="lineno" id=line42></span>      snext = relfile.[<span class="small_keyword" title="substring range separator">to</span> fpos] + snext + relfile.[lpos <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line43></span>      sprev = relfile.[<span class="small_keyword" title="substring range separator">to</span> fpos] + sprev + relfile.[lpos <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line44></span>      docindex := relfile.[<span class="small_keyword" title="substring range separator">to</span> fpos] + <span class="fstring">"index"</span> + relfile.[lpos <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line45></span>  
<span class="lineno" id=line46></span>      <span class="small_keyword" title="return">return</span>
<span class="lineno" id=line47></span>        <span class="small_keyword" title="conditional">if</span> digits == <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> 
<span class="lineno" id=line48></span>          None[<span class="library" title="binding of C int type">int</span>],None[<span class="library" title="binding of C++ string type">string</span>],None[<span class="library" title="binding of C++ string type">string</span>],docindex
<span class="lineno" id=line49></span>        <span class="small_keyword" title="conditional">elif</span> vprev &gt; 0 <span class="small_keyword" title="conditional">then</span> 
<span class="lineno" id=line50></span>          Some v,Some sprev, Some snext,docindex
<span class="lineno" id=line51></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line52></span>          Some v,None[<span class="library" title="binding of C++ string type">string</span>], Some snext,docindex
<span class="lineno" id=line53></span>      ;
<span class="lineno" id=line54></span>    }
<span class="lineno" id=line55></span>  
<span class="lineno" id=line56></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> shownav() =&gt; 
<span class="lineno" id=line57></span>      <span class="small_keyword" title="match statement or expression">match</span> calnav() <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line58></span>      | _,Some sprev, Some snext, docindex =&gt; 
<span class="lineno" id=line59></span>          <span class="fstring">"&lt;a href='"</span>+sprev+<span class="fstring">"'&gt;"</span>+button.make-button(id=<span class="fstring">"prev"</span>, text=<span class="fstring">"Prev"</span>, onclick=<span class="fstring">"nop"</span>)+<span class="fstring">"&lt;/a&gt; "</span> + 
<span class="lineno" id=line60></span>          <span class="fstring">"&lt;a href='"</span>+snext+<span class="fstring">"'&gt;"</span>+button.make-button(id=<span class="fstring">"next"</span>, text=<span class="fstring">"Next"</span>, onclick=<span class="fstring">"nop"</span>)+<span class="fstring">"&lt;/a&gt; "</span> + 
<span class="lineno" id=line61></span>          <span class="fstring">"&lt;a href='"</span>+docindex+<span class="fstring">"'&gt;"</span>+button.make-button(id=<span class="fstring">"index"</span>, text=<span class="fstring">"Index"</span>, onclick=<span class="fstring">"nop"</span>)+<span class="fstring">"&lt;/a&gt; "</span>
<span class="lineno" id=line62></span>      | _,#None, Some snext, docindex =&gt; 
<span class="lineno" id=line63></span>         <span class="fstring">"&lt;a href='"</span>+snext+<span class="fstring">"'&gt;"</span>+button.make-button(id=<span class="fstring">"next"</span>, text=<span class="fstring">"Next"</span>, onclick=<span class="fstring">"nop"</span>)+<span class="fstring">"&lt;/a&gt; "</span>+
<span class="lineno" id=line64></span>         <span class="fstring">"&lt;a href='"</span>+docindex+<span class="fstring">"'&gt;"</span>+button.make-button(id=<span class="fstring">"index"</span>, text=<span class="fstring">"Index"</span>, onclick=<span class="fstring">"nop"</span>)+<span class="fstring">"&lt;/a&gt;"</span> 
<span class="lineno" id=line65></span>      | _,#None, #None,_ =&gt; <span class="fstring">""</span>
<span class="lineno" id=line66></span>      <span class="small_keyword" title="end a match statement or expression">endmatch</span>
<span class="lineno" id=line67></span>    ;
<span class="lineno" id=line68></span>  
<span class="lineno" id=line69></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> docnum()=&gt;
<span class="lineno" id=line70></span>      <span class="small_keyword" title="match statement or expression">match</span> calnav() <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line71></span>      | #None,_,_,_ =&gt; <span class="fstring">""</span>
<span class="lineno" id=line72></span>      | Some v,_,_,_ =&gt; <span class="library" title="Convert a value to a string">str</span> v + <span class="fstring">"."</span>
<span class="lineno" id=line73></span>    ; 
<span class="lineno" id=line74></span>  
<span class="lineno" id=line75></span>  }
<span class="lineno" id=line76></span>  
<span class="lineno" id=line77></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_fileseq_setup"</span>;
<span class="lineno" id=line78></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_fileseq of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_fileseq"</span>;
<span class="lineno" id=line79></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html_frame.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./html-frame-interface"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./toc_menu-interface"</span>;
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup (config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line5></span>    <span class="comment">//eprintln$ "Setup html_frame v1.4 " + config_data;</span>
<span class="lineno" id=line6></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line7></span>  }
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  <span class="big_keyword" title="Define a mutable variable">var</span> frame_style= <span class="fstring">""" 
<span class="lineno" id=line10></span>  &lt;style&gt;
<span class="lineno" id=line11></span>  body {margin:3%; font-family: sans-serif; }
<span class="lineno" id=line12></span>  h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
<span class="lineno" id=line13></span>  h2 {color:#202020; font-size:105%;}
<span class="lineno" id=line14></span>  h3 {font-size:100%;}
<span class="lineno" id=line15></span>  h4 {font-size:95%;}
<span class="lineno" id=line16></span>  h5 {font-size:95%;}
<span class="lineno" id=line17></span>  span.fstring {color:darkblue; font-style:italic; }
<span class="lineno" id=line18></span>  span.comment {font-family:arial; color:blue; font-style:italic; }
<span class="lineno" id=line19></span>  span.doccomment {font-family:arial; color:green; font-style:italic; }
<span class="lineno" id=line20></span>  span.big_keyword {color:#FF1010; }
<span class="lineno" id=line21></span>  span.small_keyword {color:#802040; }
<span class="lineno" id=line22></span>  span.qualifier {color:#A02020; }
<span class="lineno" id=line23></span>  span.library {color:#A02000; }
<span class="lineno" id=line24></span>  span.ctor {color:#406020; }
<span class="lineno" id=line25></span>  span.hack {color:#66DD00; }
<span class="lineno" id=line26></span>  span.preproc {color:#005500; }
<span class="lineno" id=line27></span>  span.embedded_c{background-color:#DDDDDD; }
<span class="lineno" id=line28></span>  span.fpc_fieldname {color:#DD0000; }
<span class="lineno" id=line29></span>  span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
<span class="lineno" id=line30></span>  pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
<span class="lineno" id=line31></span>  pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
<span class="lineno" id=line32></span>  pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
<span class="lineno" id=line33></span>  pre.cppbg {background-color:#C2FDC2; }
<span class="lineno" id=line34></span>  pre.prefmtbg {background-color:#F1F1F1; }
<span class="lineno" id=line35></span>  pre.expected {background-color:hsla(74,94%,88%,1); }
<span class="lineno" id=line36></span>  pre.input {background-color:hsla(20,94%,88%,1); }
<span class="lineno" id=line37></span>  pre.inclusion {
<span class="lineno" id=line38></span>      font-family: Arial;
<span class="lineno" id=line39></span>      font-weight: normal;
<span class="lineno" id=line40></span>      font-size: 0.9em;
<span class="lineno" id=line41></span>      color: #555;
<span class="lineno" id=line42></span>      border: none;
<span class="lineno" id=line43></span>      box-shadow: none;
<span class="lineno" id=line44></span>      text-align: right;
<span class="lineno" id=line45></span>      margin: -7px 11px -12px 0;
<span class="lineno" id=line46></span>      padding: 0;
<span class="lineno" id=line47></span>      background-color:#fafafa;
<span class="lineno" id=line48></span>  }
<span class="lineno" id=line49></span>  code.inclusion {background-color:#D070D0; color:black; }
<span class="lineno" id=line50></span>  .obsolete { background-color:#FFEFEF; font-size: small; color:black; }
<span class="lineno" id=line51></span>  .future { background-color:#FF8080; font-size: small; color:black; }
<span class="lineno" id=line52></span>  .implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
<span class="lineno" id=line53></span>  .bug { background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line54></span>  .fixed{ background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line55></span>  .done { background-color:#FFE0E0; font-size: small; color:black; }
<span class="lineno" id=line56></span>  .caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
<span class="lineno" id=line57></span>  .container {
<span class="lineno" id=line58></span>    position: fixed;
<span class="lineno" id=line59></span>    top:0px;
<span class="lineno" id=line60></span>    left:0px;
<span class="lineno" id=line61></span>    height : 100%;
<span class="lineno" id=line62></span>    width: 100%;
<span class="lineno" id=line63></span>    background-color: grey;
<span class="lineno" id=line64></span>    margin: 0px;
<span class="lineno" id=line65></span>    padding: 0px;
<span class="lineno" id=line66></span>    border-width: 0px;
<span class="lineno" id=line67></span>    color: #404040;
<span class="lineno" id=line68></span>  }
<span class="lineno" id=line69></span>  .maincontent {
<span class="lineno" id=line70></span>    padding:4px;
<span class="lineno" id=line71></span>    padding-left:8px;
<span class="lineno" id=line72></span>    line-height:1.3em;
<span class="lineno" id=line73></span>    color:#404040; background-color:#fafafa;
<span class="lineno" id=line74></span>  }
<span class="lineno" id=line75></span>  .maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
<span class="lineno" id=line76></span>  .maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
<span class="lineno" id=line77></span>  .maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
<span class="lineno" id=line78></span>  .maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
<span class="lineno" id=line79></span>  .maincontent code { color:#902030; }
<span class="lineno" id=line80></span>  .toppanel {
<span class="lineno" id=line81></span>    position:absolute; left:0px; top:0px; height:20px; right:0px; 
<span class="lineno" id=line82></span>    background-color: #e0e0e0;
<span class="lineno" id=line83></span>  }
<span class="lineno" id=line84></span>  .bottompanel {
<span class="lineno" id=line85></span>    position:absolute; left:0px; top:22px; bottom:0px; right:0px; 
<span class="lineno" id=line86></span>    background-color: #fafafa;
<span class="lineno" id=line87></span>    font-size:14px;
<span class="lineno" id=line88></span>  }
<span class="lineno" id=line89></span>  .leftpanel {
<span class="lineno" id=line90></span>    position:absolute; left:0px; top:0px; bottom:0px; width: 150px; 
<span class="lineno" id=line91></span>    background-color: #eaeaea; overflow: auto;
<span class="lineno" id=line92></span>  }
<span class="lineno" id=line93></span>  .rightpanel {
<span class="lineno" id=line94></span>    position:absolute; right: 0px; left:160px; top:0px; bottom: 0px; 
<span class="lineno" id=line95></span>    background-color: #fafafa; overflow: auto;
<span class="lineno" id=line96></span>  }
<span class="lineno" id=line97></span>  .divider {
<span class="lineno" id=line98></span>    position:absolute; left: 150px; top:0px; bottom:0px; 
<span class="lineno" id=line99></span>    background-color: black; width:2px;
<span class="lineno" id=line100></span>    box-shadow: 0 0 8px #000;
<span class="lineno" id=line101></span>  }
<span class="lineno" id=line102></span>  
<span class="lineno" id=line103></span>  #panemover {
<span class="lineno" id=line104></span>      position:absolute;
<span class="lineno" id=line105></span>      left: 150px;
<span class="lineno" id=line106></span>      width : 10px;
<span class="lineno" id=line107></span>      top: 0px;
<span class="lineno" id=line108></span>      bottom: 0px;
<span class="lineno" id=line109></span>      opacity: 0.3;
<span class="lineno" id=line110></span>      cursor:col-resize;
<span class="lineno" id=line111></span>  }
<span class="lineno" id=line112></span>  
<span class="lineno" id=line113></span>  div.m {
<span class="lineno" id=line114></span>      margin: 0px;
<span class="lineno" id=line115></span>      padding:0px;
<span class="lineno" id=line116></span>      border-width:2px;
<span class="lineno" id=line117></span>      border-color: green;
<span class="lineno" id=line118></span>  }
<span class="lineno" id=line119></span>  
<span class="lineno" id=line120></span>  div.m1 {
<span class="lineno" id=line121></span>      background-color: #86E870;
<span class="lineno" id=line122></span>      border-style:outset;
<span class="lineno" id=line123></span>      border-color:#ccc;
<span class="lineno" id=line124></span>      border-width:2px 0;
<span class="lineno" id=line125></span>      font-size:90%;
<span class="lineno" id=line126></span>      padding: 1px 0 2px 10px;
<span class="lineno" id=line127></span>  }
<span class="lineno" id=line128></span>  
<span class="lineno" id=line129></span>  div.m2 {
<span class="lineno" id=line130></span>      background-color: #70C070;
<span class="lineno" id=line131></span>      padding-left:15px;
<span class="lineno" id=line132></span>      padding-top:2px;
<span class="lineno" id=line133></span>      border-style:outset;
<span class="lineno" id=line134></span>      border-color:green;
<span class="lineno" id=line135></span>      border-width:0 0 1px 0;
<span class="lineno" id=line136></span>      font-size:80%;
<span class="lineno" id=line137></span>  }
<span class="lineno" id=line138></span>  
<span class="lineno" id=line139></span>  div.m1:hover, div.m2:hover {
<span class="lineno" id=line140></span>      background-color: white;
<span class="lineno" id=line141></span>  }
<span class="lineno" id=line142></span>  
<span class="lineno" id=line143></span>  #leftmargintoc a {
<span class="lineno" id=line144></span>      text-decoration: none;
<span class="lineno" id=line145></span>      color: #404040;
<span class="lineno" id=line146></span>  }
<span class="lineno" id=line147></span>  &lt;/style&gt;
<span class="lineno" id=line148></span>  """</span>;
<span class="lineno" id=line149></span>  
<span class="lineno" id=line150></span>  <span class="big_keyword" title="Define a mutable variable">var</span> frame_js = <span class="fstring">"""
<span class="lineno" id=line151></span>      &lt;script async="true"&gt;
<span class="lineno" id=line152></span>        function dragStart(e, left, right){
<span class="lineno" id=line153></span>          document.getElementById("panemover").style.width="70%";
<span class="lineno" id=line154></span>          document.getElementById("panemover").style.left="50px";
<span class="lineno" id=line155></span>          mousedown = true;
<span class="lineno" id=line156></span>          x = e.clientX
<span class="lineno" id=line157></span>          dragOffsetLeft =  
<span class="lineno" id=line158></span>            document.getElementById(left).getBoundingClientRect().right - 
<span class="lineno" id=line159></span>            document.getElementById(left).getBoundingClientRect().left - 
<span class="lineno" id=line160></span>            x 
<span class="lineno" id=line161></span>          ; 
<span class="lineno" id=line162></span>          dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x; 
<span class="lineno" id=line163></span>          dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
<span class="lineno" id=line164></span>        }
<span class="lineno" id=line165></span>        function dragRelease(){
<span class="lineno" id=line166></span>          document.getElementById('panemover').style.width = '10px';
<span class="lineno" id=line167></span>          document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
<span class="lineno" id=line168></span>          mousedown = false;
<span class="lineno" id=line169></span>        }
<span class="lineno" id=line170></span>        function drag(e, left, right){
<span class="lineno" id=line171></span>          if(!mousedown){return}
<span class="lineno" id=line172></span>          x = e.clientX
<span class="lineno" id=line173></span>          tmpLeft = dragOffsetLeft + x
<span class="lineno" id=line174></span>          tmpDivider= dragOffsetDivider + x
<span class="lineno" id=line175></span>          tmpRight = dragOffsetRight + x
<span class="lineno" id=line176></span>          document.getElementById(left).style.width= tmpLeft + 'px';
<span class="lineno" id=line177></span>          document.getElementById("divider").style.left= tmpDivider + 'px';
<span class="lineno" id=line178></span>          document.getElementById(right).style.left = tmpRight + 'px';
<span class="lineno" id=line179></span>        };
<span class="lineno" id=line180></span>      &lt;/script&gt;
<span class="lineno" id=line181></span>  """</span>;
<span class="lineno" id=line182></span>  
<span class="lineno" id=line183></span>  <span class="big_keyword" title="Define a mutable variable">var</span>  toc_menu = Dynlink::load-plugin-func1 [toc_menu_interface, <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>]] (
<span class="lineno" id=line184></span>      dll-name=<span class="fstring">"toc_menu"</span>, setup-str=<span class="fstring">"loaded-from-html_frame"</span>, entry-point=<span class="fstring">"toc_menu"</span>
<span class="lineno" id=line185></span>    );
<span class="lineno" id=line186></span>  
<span class="lineno" id=line187></span>  
<span class="lineno" id=line188></span>  <span class="big_keyword" title="define an object factory">object</span> html_frame (d:html_frame_data_t) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> html_frame_t = 
<span class="lineno" id=line189></span>  {
<span class="lineno" id=line190></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"html_frame maker"</span>;
<span class="lineno" id=line191></span>  
<span class="lineno" id=line192></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_frame (out:<span class="library" title="binding of C++ string type">string</span>) :<span class="library" title="binding of C++ string type">string</span> = {
<span class="lineno" id=line193></span>      <span class="big_keyword" title="Define a mutable variable">var</span> o = <span class="fstring">""</span>;
<span class="lineno" id=line194></span>      reserve(&amp;o,10000+out.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span>);
<span class="lineno" id=line195></span>      <span class="big_keyword" title="Define a mutable variable">var</span> h2 = #(d.heading.get_headings);
<span class="lineno" id=line196></span>      <span class="big_keyword" title="Define a mutable variable">var</span> h3 = unbox (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (level:<span class="library" title="binding of C int type">int</span>, heading:<span class="library" title="binding of C++ string type">string</span>) =&gt; level, heading, <span class="fstring">'#'</span>+heading+<span class="fstring">'_h'</span>) h2);
<span class="lineno" id=line197></span>      <span class="big_keyword" title="Define a mutable variable">var</span> menu = toc_menu (h3);
<span class="lineno" id=line198></span>  
<span class="lineno" id=line199></span>      o+=frame_style;
<span class="lineno" id=line200></span>      o+=#(menu.get_style);
<span class="lineno" id=line201></span>      o+=frame_js;
<span class="lineno" id=line202></span>      o+=#(menu.get_js);
<span class="lineno" id=line203></span>  
<span class="lineno" id=line204></span>      o+=#(d.heading.emit-js);
<span class="lineno" id=line205></span>      o+=#(d.button-factory.get-jscript);
<span class="lineno" id=line206></span>      o+=#(d.fileseq.get-jscript);
<span class="lineno" id=line207></span>  
<span class="lineno" id=line208></span>      <span class="comment">// MAIN CONTENT</span>
<span class="lineno" id=line209></span>      <span class="big_keyword" title="Define a mutable variable">var</span> topcontent =
<span class="lineno" id=line210></span>        <span class="fstring">'    &lt;!--Main Content top navbar--&gt;\n'</span>  +
<span class="lineno" id=line211></span>        #(d.heading.emit-buttons) + 
<span class="lineno" id=line212></span>        #(d.fileseq.shownav) +
<span class="lineno" id=line213></span>        <span class="fstring">'    &lt;!--Main Content top navbar End--&gt;\n'</span>
<span class="lineno" id=line214></span>      ;
<span class="lineno" id=line215></span>  
<span class="lineno" id=line216></span>      <span class="big_keyword" title="Define a mutable variable">var</span> leftcontent = #(menu.make_menu);
<span class="lineno" id=line217></span>  
<span class="lineno" id=line218></span>      <span class="big_keyword" title="Define a mutable variable">var</span> rightcontent =
<span class="lineno" id=line219></span>        <span class="fstring">'&lt;!--Main Content Body--&gt;\n'</span> + 
<span class="lineno" id=line220></span>        out +
<span class="lineno" id=line221></span>        <span class="fstring">'&lt;!--Main Content Body End--&gt;\n'</span>
<span class="lineno" id=line222></span>      ;
<span class="lineno" id=line223></span>   
<span class="lineno" id=line224></span>      <span class="big_keyword" title="Define a mutable variable">var</span> html = <span class="fstring">"""
<span class="lineno" id=line225></span>      &lt;div class="container"&gt;
<span class="lineno" id=line226></span>        &lt;div class="toppanel"&gt;
<span class="lineno" id=line227></span>  """</span> + topcontent + <span class="fstring">"""
<span class="lineno" id=line228></span>        &lt;/div&gt; &lt;!-- toppanel end --&gt;
<span class="lineno" id=line229></span>        &lt;div class="bottompanel"&gt;
<span class="lineno" id=line230></span>          &lt;span id="divider" class="divider"&gt;&lt;/span&gt;
<span class="lineno" id=line231></span>  
<span class="lineno" id=line232></span>          &lt;span id="left" class="leftpanel" &gt;
<span class="lineno" id=line233></span>            &lt;div class="menucontent"&gt;
<span class="lineno" id=line234></span>  """</span> + leftcontent + <span class="fstring">"""
<span class="lineno" id=line235></span>            &lt;/div&gt; &lt;!-- leftpanel contents end --&gt;
<span class="lineno" id=line236></span>          &lt;/span&gt; &lt;!-- leftpanel end --&gt;
<span class="lineno" id=line237></span>  
<span class="lineno" id=line238></span>          &lt;span id="right" class="rightpanel"&gt;
<span class="lineno" id=line239></span>            &lt;div class="maincontent"&gt;
<span class="lineno" id=line240></span>  """</span> + rightcontent + <span class="fstring">"""
<span class="lineno" id=line241></span>            &lt;/div&gt; &lt;!-- rightpanel contents end --&gt;
<span class="lineno" id=line242></span>            &lt;hr&gt;
<span class="lineno" id=line243></span>          &lt;/span&gt; &lt;!-- rightpanel end --&gt;
<span class="lineno" id=line244></span>  
<span class="lineno" id=line245></span>          &lt;span id="panemover" style="cursor:col-resize;" 
<span class="lineno" id=line246></span>           onmousedown="dragStart(event, 'left', 'right'); return false;" 
<span class="lineno" id=line247></span>           onmousemove="drag(event, 'left', 'right');" 
<span class="lineno" id=line248></span>           onmouseout="dragRelease();" 
<span class="lineno" id=line249></span>           onmouseup="dragRelease();"
<span class="lineno" id=line250></span>          &gt;
<span class="lineno" id=line251></span>          &lt;/span&gt; &lt;!-- panemover end --&gt;
<span class="lineno" id=line252></span>        &lt;/div&gt; &lt;!-- bottom panel end --&gt;
<span class="lineno" id=line253></span>      &lt;/div&gt; &lt;!-- container end --&gt;
<span class="lineno" id=line254></span>  """</span>;
<span class="lineno" id=line255></span>      o+= html;
<span class="lineno" id=line256></span>      <span class="small_keyword" title="return">return</span> o;
<span class="lineno" id=line257></span>    }
<span class="lineno" id=line258></span>  
<span class="lineno" id=line259></span>  }
<span class="lineno" id=line260></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_frame_setup"</span>;
<span class="lineno" id=line261></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_frame of (html_frame_data_t) as <span class="fstring">"html_frame"</span>;
<span class="lineno" id=line262></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html_heading.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./paragraph-interface"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./heading-interface"</span>;
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./button-interface"</span>;
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Define a mutable variable">var</span> button-factory : <span class="library" title="Type with one values (), the empty tuple">unit</span> -&gt; button-factory_t;
<span class="lineno" id=line6></span>  
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Define an immutable value">val</span> js1 =
<span class="lineno" id=line9></span>  <span class="fstring">"""
<span class="lineno" id=line10></span>  &lt;script type="text/javascript"&gt;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>  function expand(but,id)
<span class="lineno" id=line13></span>  {
<span class="lineno" id=line14></span>    var n = document.getElementById(id).style;
<span class="lineno" id=line15></span>    var button = document.getElementById(but);
<span class="lineno" id=line16></span>    button.src = "/share/src/web/images/minus.gif";
<span class="lineno" id=line17></span>    button.alt = "-";
<span class="lineno" id=line18></span>    n.display = "block";
<span class="lineno" id=line19></span>  }
<span class="lineno" id=line20></span>  function collapse(but,id)
<span class="lineno" id=line21></span>  {
<span class="lineno" id=line22></span>    var n = document.getElementById(id).style;
<span class="lineno" id=line23></span>    var button = document.getElementById(but);
<span class="lineno" id=line24></span>    button.src = "/share/src/web/images/plus.gif";
<span class="lineno" id=line25></span>    button.alt = "+";
<span class="lineno" id=line26></span>    n.display = "none";
<span class="lineno" id=line27></span>  }
<span class="lineno" id=line28></span>  function toggle(button,id)
<span class="lineno" id=line29></span>  {
<span class="lineno" id=line30></span>    var n = document.getElementById(id).style;
<span class="lineno" id=line31></span>    if (n.display == "none")
<span class="lineno" id=line32></span>    {
<span class="lineno" id=line33></span>      button.src = "/share/src/web/images/minus.gif";
<span class="lineno" id=line34></span>      button.alt = "-";
<span class="lineno" id=line35></span>      n.display = "block";
<span class="lineno" id=line36></span>    }
<span class="lineno" id=line37></span>    else
<span class="lineno" id=line38></span>    {
<span class="lineno" id=line39></span>      button.src = "/share/src/web/images/plus.gif";
<span class="lineno" id=line40></span>      button.alt = "+";
<span class="lineno" id=line41></span>      n.display = "none";
<span class="lineno" id=line42></span>    }
<span class="lineno" id=line43></span>  }
<span class="lineno" id=line44></span>  var allbuttons = [
<span class="lineno" id=line45></span>  """</span>;
<span class="lineno" id=line46></span>  <span class="big_keyword" title="Define an immutable value">val</span> js2 =
<span class="lineno" id=line47></span>  <span class="fstring">"""
<span class="lineno" id=line48></span>  ];
<span class="lineno" id=line49></span>  function expand_all(dummy)
<span class="lineno" id=line50></span>  {
<span class="lineno" id=line51></span>    for (i in allbuttons)
<span class="lineno" id=line52></span>    {
<span class="lineno" id=line53></span>      expand(allbuttons[i], allbuttons[i]+"_d");
<span class="lineno" id=line54></span>    }
<span class="lineno" id=line55></span>  }
<span class="lineno" id=line56></span>  function collapse_all(dummy)
<span class="lineno" id=line57></span>  {
<span class="lineno" id=line58></span>    for (i in allbuttons)
<span class="lineno" id=line59></span>    {
<span class="lineno" id=line60></span>      collapse(allbuttons[i], allbuttons[i]+"_d");
<span class="lineno" id=line61></span>    }
<span class="lineno" id=line62></span>  }
<span class="lineno" id=line63></span>  &lt;/script&gt;
<span class="lineno" id=line64></span>  """</span>;
<span class="lineno" id=line65></span>  
<span class="lineno" id=line66></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> escape_sp(h: <span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (c: <span class="library" title="binding of C char type">char</span>) =&gt; <span class="small_keyword" title="conditional">if</span> c == <span class="fstring">' '</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">'_'</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="conditional">else</span> c) h;
<span class="lineno" id=line67></span>  
<span class="lineno" id=line68></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line69></span>    button-factory = Dynlink::load-plugin-func0 [button-factory_t] (dll-name=<span class="fstring">"html_button"</span>);
<span class="lineno" id=line70></span>    <span class="comment">//eprintln$ "Setup html_heading " + config_data;</span>
<span class="lineno" id=line71></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line72></span>  }
<span class="lineno" id=line73></span>  
<span class="lineno" id=line74></span>  
<span class="lineno" id=line75></span>  <span class="big_keyword" title="define an object factory">object</span> html_heading (paragraph: paragraph-control_t, write_string: <span class="library" title="binding of C++ string type">string</span> -&gt; 0) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> heading-control_t =
<span class="lineno" id=line76></span>  {
<span class="lineno" id=line77></span>    <span class="big_keyword" title="Define a mutable variable">var</span> button = #button-factory;
<span class="lineno" id=line78></span>  
<span class="lineno" id=line79></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"Heading object"</span>;
<span class="lineno" id=line80></span>    <span class="big_keyword" title="Define a mutable variable">var</span> hstack = 0; <span class="comment">// number of open &lt;div&gt;s</span>
<span class="lineno" id=line81></span>    <span class="big_keyword" title="Define a mutable variable">var</span> hnums = <span class="library" title="array with dynamically variable limit up to a fixed bound">varray</span>[<span class="library" title="binding of C int type">int</span>] (<span class="library" title="binding of C size_t type">size</span> 5,1);
<span class="lineno" id=line82></span>    <span class="big_keyword" title="Define a mutable variable">var</span> all_buttons = <span class="fstring">""</span>;
<span class="lineno" id=line83></span>    <span class="big_keyword" title="Define a mutable variable">var</span> htree = Empty[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line84></span>  
<span class="lineno" id=line85></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_headings () =&gt; unbox (<span class="library" title="return data structure with elements reversed">rev</span> htree);
<span class="lineno" id=line86></span>  
<span class="lineno" id=line87></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> emit-buttons() =&gt;
<span class="lineno" id=line88></span>     button.make-button(id=<span class="fstring">"expand"</span>, text=<span class="fstring">"Expand"</span>, onclick=<span class="fstring">"expand_all"</span>) +
<span class="lineno" id=line89></span>     button.make-button(id=<span class="fstring">"collapse"</span>, text=<span class="fstring">"Collapse"</span>, onclick=<span class="fstring">"collapse_all"</span>)
<span class="lineno" id=line90></span>    ;
<span class="lineno" id=line91></span>  
<span class="lineno" id=line92></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> emit-js() =&gt; js1 + all_buttons + js2;
<span class="lineno" id=line93></span>  
<span class="lineno" id=line94></span>    <span class="comment">// bid is the button id, cid is the stuff which is controlled by it</span>
<span class="lineno" id=line95></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> tree_button(bid:<span class="library" title="binding of C++ string type">string</span>, cid:<span class="library" title="binding of C++ string type">string</span>)=&gt;
<span class="lineno" id=line96></span>      <span class="fstring">"&lt;img src='/share/src/web/images/minus.gif' id='"</span>+bid+<span class="fstring">"' onclick='toggle(this,\"</span><span class="fstring">"+cid+"</span>\<span class="fstring">")' alt='+'/&gt;"</span>
<span class="lineno" id=line97></span>    ;
<span class="lineno" id=line98></span>  
<span class="lineno" id=line99></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> add_button (fname: <span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line100></span>      all_buttons = <span class="small_keyword" title="conditional">if</span> all_buttons != <span class="fstring">""</span> <span class="small_keyword" title="conditional">then</span> all_buttons + <span class="fstring">',\n'</span> <span class="small_keyword" title="conditional">else</span> <span class="fstring">''</span> <span class="small_keyword" title="conditional">endif</span> + <span class="fstring">'"'</span> + fname + <span class="fstring">'"'</span>;
<span class="lineno" id=line101></span>    }
<span class="lineno" id=line102></span>  
<span class="lineno" id=line103></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> edivs(n:<span class="library" title="binding of C int type">int</span>) {
<span class="lineno" id=line104></span>      <span class="small_keyword" title="while loop">while</span> hstack &gt; n <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line105></span>        write_string(<span class="fstring">"&lt;/div&gt;"</span>);
<span class="lineno" id=line106></span>        --hstack;
<span class="lineno" id=line107></span>        set (hnums,hstack,1);
<span class="lineno" id=line108></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line109></span>       <span class="small_keyword" title="conditional">if</span> hstack == n <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line110></span>         --hstack;
<span class="lineno" id=line111></span>         write_string(<span class="fstring">"&lt;/div&gt;"</span>);
<span class="lineno" id=line112></span>         set(hnums,hstack,hnums.hstack+1);
<span class="lineno" id=line113></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line114></span>    }
<span class="lineno" id=line115></span>  
<span class="lineno" id=line116></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> hnum() = {
<span class="lineno" id=line117></span>      <span class="big_keyword" title="Define a mutable variable">var</span> s = <span class="fstring">""</span>; <span class="big_keyword" title="Define a mutable variable">var</span> i:<span class="library" title="binding of C int type">int</span>;
<span class="lineno" id=line118></span>      <span class="small_keyword" title="for loop">for</span> i <span class="small_keyword" title="membership operator, function mem">in</span> 0 <span class="small_keyword" title="upwards counting for loop">upto</span> hstack - 2 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line119></span>        s+=<span class="library" title="Convert a value to a string">str</span>(hnums.i) + <span class="fstring">"."</span>;
<span class="lineno" id=line120></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line121></span>      <span class="small_keyword" title="return">return</span> s + <span class="library" title="Convert a value to a string">str</span>(hnums.(hstack - 1));
<span class="lineno" id=line122></span>    }
<span class="lineno" id=line123></span>  
<span class="lineno" id=line124></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> head(docnum: <span class="library" title="binding of C++ string type">string</span>, n:<span class="library" title="binding of C int type">int</span>, txt:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line125></span>      #(paragraph.ep);
<span class="lineno" id=line126></span>      edivs(n);
<span class="lineno" id=line127></span>      add_button txt;
<span class="lineno" id=line128></span>      tb:=tree_button(txt,escape_sp(txt)+<span class="fstring">"_d"</span>);
<span class="lineno" id=line129></span>      ++hstack;
<span class="lineno" id=line130></span>      htree = Cons ( (n,txt), htree);
<span class="lineno" id=line131></span>      write_string(<span class="fstring">"&lt;h"</span>+<span class="library" title="Convert a value to a string">str</span> n+<span class="fstring">" id='"</span>+escape_sp(txt)+<span class="fstring">"_h'&gt;"</span>+tb+<span class="fstring">" "</span>+docnum+hnum()+<span class="fstring">" "</span>+ txt+<span class="fstring">"&lt;/h"</span>+<span class="library" title="Convert a value to a string">str</span> n+<span class="fstring">"&gt;"</span> +
<span class="lineno" id=line132></span>       <span class="fstring">"&lt;div id='"</span>+escape_sp(txt)+<span class="fstring">"_d' style='display:block'&gt;\n"</span>);
<span class="lineno" id=line133></span>    }
<span class="lineno" id=line134></span>  
<span class="lineno" id=line135></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> finalise () {
<span class="lineno" id=line136></span>     edivs(1);
<span class="lineno" id=line137></span>    }
<span class="lineno" id=line138></span>  }
<span class="lineno" id=line139></span>  
<span class="lineno" id=line140></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_heading_setup"</span>;
<span class="lineno" id=line141></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_heading of (paragraph-control_t * (string-&gt;0)) as <span class="fstring">"html_heading"</span>;
<span class="lineno" id=line142></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html_paragraph.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./paragraph-interface"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line4></span>    <span class="comment">//eprintln$ "Setup html_paragraph" + config_data;</span>
<span class="lineno" id=line5></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line6></span>  }
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  <span class="big_keyword" title="define an object factory">object</span> html_paragraph (write_string: <span class="library" title="binding of C++ string type">string</span> -&gt; 0) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> paragraph-control_t = 
<span class="lineno" id=line10></span>  {
<span class="lineno" id=line11></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"Paragraph object"</span>;
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a mutable variable">var</span> pstate = <span class="library" title="false value">false</span>;
<span class="lineno" id=line13></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> start_p () { write_string(<span class="fstring">"&lt;p&gt;"</span>); pstate=<span class="library" title="truth value">true</span>; }
<span class="lineno" id=line14></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> start_p (cls:<span class="library" title="binding of C++ string type">string</span>) { write_string(<span class="fstring">"&lt;p class='"</span>+cls+<span class="fstring">"'&gt;"</span>); pstate=<span class="library" title="truth value">true</span>; }
<span class="lineno" id=line15></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> end_p () { write_string(<span class="fstring">"&lt;/p&gt;"</span>); pstate=<span class="library" title="false value">false</span>; }
<span class="lineno" id=line16></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> break_p () { write_string(<span class="fstring">"&lt;/p&gt;&lt;p&gt;"</span>); }
<span class="lineno" id=line17></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> sp-clas (cls: <span class="library" title="binding of C++ string type">string</span>) { <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> pstate <span class="small_keyword" title="imperative code begins">do</span> start_p cls; <span class="small_keyword" title="end of body">done</span> }
<span class="lineno" id=line18></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> sp() { <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> pstate <span class="small_keyword" title="imperative code begins">do</span> start_p; <span class="small_keyword" title="end of body">done</span> }
<span class="lineno" id=line19></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ep() { <span class="small_keyword" title="conditional">if</span> pstate <span class="small_keyword" title="imperative code begins">do</span> end_p; <span class="small_keyword" title="end of body">done</span> }
<span class="lineno" id=line20></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> bp() { <span class="small_keyword" title="conditional">if</span> pstate <span class="small_keyword" title="imperative code begins">do</span> end_p; <span class="small_keyword" title="end of body">done</span> start_p; }
<span class="lineno" id=line21></span>  }
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_paragraph_setup"</span>;
<span class="lineno" id=line24></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_paragraph of (string-&gt;0) as <span class="fstring">"html_paragraph"</span>;
<span class="lineno" id=line25></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html_scanner.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./scanner-interface"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line4></span>    <span class="comment">//eprintln$ "Setup html_scanner " + config_data;</span>
<span class="lineno" id=line5></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line6></span>  }
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  
<span class="lineno" id=line9></span>  <span class="big_keyword" title="define an object factory">object</span> html_scanner () <span class="small_keyword" title="specify what interfaces an object implements">implements</span> htmlscanner-control_t = {
<span class="lineno" id=line10></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"Scanner object"</span>;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> html_scan (<span class="big_keyword" title="Define a mutable variable">var</span> inp:<span class="library" title="binding of C++ string type">string</span>) () : <span class="library" title="option type: Some x or None">opt</span>[html-data_t] = {
<span class="lineno" id=line13></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lines = split (inp,<span class="fstring">"\n"</span>);
<span class="lineno" id=line14></span>      <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line15></span>      String::reserve (&amp;out,inp.<span class="library" title="number of elements in data structure">len</span>);
<span class="lineno" id=line16></span>      <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line17></span>        <span class="small_keyword" title="conditional">if</span> line.[0]==<span class="fstring">'@'</span> <span class="small_keyword" title="logical conjunction">and</span> line.[1] != <span class="fstring">"{"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line18></span>          <span class="small_keyword" title="conditional">if</span> out !=<span class="fstring">""</span>  <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line19></span>             <span class="small_keyword" title="return a value saving the current location for future resumption">yield</span> Some (Text out);
<span class="lineno" id=line20></span>             out = <span class="fstring">""</span>;
<span class="lineno" id=line21></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line22></span>          <span class="small_keyword" title="return a value saving the current location for future resumption">yield</span> Some (Cmd$ strip(line.[1 <span class="small_keyword" title="substring range separator">to</span>]));
<span class="lineno" id=line23></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line24></span>          out+=line;
<span class="lineno" id=line25></span>          out+=<span class="fstring">"\n"</span>;
<span class="lineno" id=line26></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line27></span>      <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line28></span>      <span class="small_keyword" title="conditional">if</span> out != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line29></span>        <span class="small_keyword" title="return a value saving the current location for future resumption">yield</span> Some (Text out);
<span class="lineno" id=line30></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line31></span>      <span class="small_keyword" title="return">return</span> None[html-data_t];
<span class="lineno" id=line32></span>    }
<span class="lineno" id=line33></span>  
<span class="lineno" id=line34></span>    <span class="comment">// split up doc text into a stream of paragraphs</span>
<span class="lineno" id=line35></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> psplit (<span class="big_keyword" title="Define a mutable variable">var</span> inp:<span class="library" title="binding of C++ string type">string</span>) () : <span class="library" title="option type: Some x or None">opt</span>[<span class="library" title="binding of C++ string type">string</span>] = {
<span class="lineno" id=line36></span>      <span class="big_keyword" title="Define a mutable variable">var</span> lines = split(inp,<span class="fstring">"\n"</span>);
<span class="lineno" id=line37></span>      <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line38></span>      String::reserve (&amp;out,inp.<span class="library" title="number of elements in data structure">len</span>);
<span class="lineno" id=line39></span>      <span class="small_keyword" title="for loop">for</span> line <span class="small_keyword" title="membership operator, function mem">in</span> lines <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line40></span>        <span class="comment">// accumulate non-blank lines</span>
<span class="lineno" id=line41></span>        <span class="small_keyword" title="conditional">if</span> line != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line42></span>          out += line;
<span class="lineno" id=line43></span>          out += <span class="fstring">"\n"</span>;
<span class="lineno" id=line44></span>  
<span class="lineno" id=line45></span>        <span class="small_keyword" title="conditional">else</span> <span class="comment">// emit accumulated lines</span>
<span class="lineno" id=line46></span>          <span class="small_keyword" title="conditional">if</span> out != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line47></span>            <span class="small_keyword" title="return a value saving the current location for future resumption">yield</span> Some out;
<span class="lineno" id=line48></span>            out = <span class="fstring">""</span>;
<span class="lineno" id=line49></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line50></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line51></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line52></span>      <span class="small_keyword" title="conditional">if</span> out != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line53></span>        <span class="small_keyword" title="return a value saving the current location for future resumption">yield</span> Some out;
<span class="lineno" id=line54></span>        out = <span class="fstring">""</span>; <span class="comment">// no semantics but release memory</span>
<span class="lineno" id=line55></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line56></span>      <span class="small_keyword" title="return">return</span> None[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line57></span>    }
<span class="lineno" id=line58></span>  }
<span class="lineno" id=line59></span>  
<span class="lineno" id=line60></span>   
<span class="lineno" id=line61></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_scanner_setup"</span>;
<span class="lineno" id=line62></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_scanner of (<span class="library" title="Type with one values (), the empty tuple">unit</span>) as <span class="fstring">"html_scanner"</span>;
<span class="lineno" id=line63></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/html_slideshow.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define an immutable value">val</span> slideshow_js = <span class="fstring">"""
<span class="lineno" id=line4></span>  &lt;button id="start" onclick="start_slides()"&gt;Start&lt;/button&gt;
<span class="lineno" id=line5></span>  &lt;button id="stop" onclick="stop_slides()" disabled="true"&gt;Stop&lt;/button&gt;
<span class="lineno" id=line6></span>  &lt;button id="reset" onclick="reset_slides()"&gt;Reset&lt;/button&gt;
<span class="lineno" id=line7></span>  &lt;button id="next" onclick="skip_to_next()"&gt;Next&lt;/button&gt;
<span class="lineno" id=line8></span>  &lt;span id="goose" style="position:absolute; right:50px;"&gt;Slideshow Ready&lt;/span&gt;
<span class="lineno" id=line9></span>  &lt;script&gt;
<span class="lineno" id=line10></span>  var slides = new Array();
<span class="lineno" id=line11></span>  var slideno = 0;
<span class="lineno" id=line12></span>  var lineno = 0;
<span class="lineno" id=line13></span>  var nslides = 0;
<span class="lineno" id=line14></span>  slides[0]=0;
<span class="lineno" id=line15></span>  
<span class="lineno" id=line16></span>  var interval_handle;
<span class="lineno" id=line17></span>  function enable (slide, line) {
<span class="lineno" id=line18></span>    var elt = document.getElementById("slide-section-"+slide+","+line)
<span class="lineno" id=line19></span>    elt.style.display="";
<span class="lineno" id=line20></span>    var n = elt.innerHTML.length;
<span class="lineno" id=line21></span>    interval_handle = setTimeout(showframe, 7000+25 * n); 
<span class="lineno" id=line22></span>  }
<span class="lineno" id=line23></span>  
<span class="lineno" id=line24></span>  function disable (slide, line) {
<span class="lineno" id=line25></span>    document.getElementById("slide-section-"+slide+","+line).style.display="none";
<span class="lineno" id=line26></span>  }
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>  function disable_slide (slide) {
<span class="lineno" id=line29></span>    for (i = 1; i &lt;= slides[slide]; i = i + 1) disable(slide,i);
<span class="lineno" id=line30></span>  }
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>  function nextslide() {
<span class="lineno" id=line33></span>    slideno = slideno + 1;
<span class="lineno" id=line34></span>    if (slideno &gt; nslides ) { reset_slides();}
<span class="lineno" id=line35></span>    lineno = 1;
<span class="lineno" id=line36></span>  }
<span class="lineno" id=line37></span>  
<span class="lineno" id=line38></span>  function nextline() {
<span class="lineno" id=line39></span>    lineno = lineno + 1;
<span class="lineno" id=line40></span>    if (lineno &gt; slides[slideno]) { nextslide(); }
<span class="lineno" id=line41></span>  }
<span class="lineno" id=line42></span>  
<span class="lineno" id=line43></span>  function showline() { 
<span class="lineno" id=line44></span>    if (slideno == 0) {
<span class="lineno" id=line45></span>      document.getElementById("goose").innerHTML="READY";
<span class="lineno" id=line46></span>    }
<span class="lineno" id=line47></span>    else {
<span class="lineno" id=line48></span>      document.getElementById("goose").innerHTML="SLIDE " + (slideno) + ", LINE " + (lineno) +"";
<span class="lineno" id=line49></span>      enable (slideno, lineno); 
<span class="lineno" id=line50></span>    }
<span class="lineno" id=line51></span>  }
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>  function showframe(){
<span class="lineno" id=line54></span>    oldslide = slideno;
<span class="lineno" id=line55></span>    oldline = lineno;
<span class="lineno" id=line56></span>    nextline();
<span class="lineno" id=line57></span>    if (oldslide != slideno) { 
<span class="lineno" id=line58></span>      disable_slide(oldslide);
<span class="lineno" id=line59></span>      setTimeout(showline,2000);
<span class="lineno" id=line60></span>    }
<span class="lineno" id=line61></span>    else showline();
<span class="lineno" id=line62></span>  }
<span class="lineno" id=line63></span>  
<span class="lineno" id=line64></span>  function skip_to_next() {
<span class="lineno" id=line65></span>    clearTimeout(interval_handle);
<span class="lineno" id=line66></span>    disable_slide (slideno);
<span class="lineno" id=line67></span>    nextslide();
<span class="lineno" id=line68></span>    showline();
<span class="lineno" id=line69></span>  }
<span class="lineno" id=line70></span>  
<span class="lineno" id=line71></span>  function start_slides() { 
<span class="lineno" id=line72></span>    document.body.style.background="black";
<span class="lineno" id=line73></span>    document.body.style.color="white";
<span class="lineno" id=line74></span>    document.getElementById("start").disabled=true; 
<span class="lineno" id=line75></span>    document.getElementById("stop").disabled=false; 
<span class="lineno" id=line76></span>    document.getElementById("reset").disabled=false; 
<span class="lineno" id=line77></span>    showframe();
<span class="lineno" id=line78></span>  }
<span class="lineno" id=line79></span>  
<span class="lineno" id=line80></span>  function stop_slides() { 
<span class="lineno" id=line81></span>    document.body.style.background="white";
<span class="lineno" id=line82></span>    document.body.style.color="black";
<span class="lineno" id=line83></span>    document.getElementById("start").disabled=false; 
<span class="lineno" id=line84></span>    document.getElementById("stop").disabled=true; 
<span class="lineno" id=line85></span>    document.getElementById("reset").disabled=false; 
<span class="lineno" id=line86></span>    clearTimeout(interval_handle); 
<span class="lineno" id=line87></span>  }
<span class="lineno" id=line88></span>  
<span class="lineno" id=line89></span>  function reset_slides() {
<span class="lineno" id=line90></span>    document.getElementById("reset").disabled=true; 
<span class="lineno" id=line91></span>    disable_slide(slideno);
<span class="lineno" id=line92></span>    stop_slides();
<span class="lineno" id=line93></span>    slideno = 0;
<span class="lineno" id=line94></span>    lineno = 0;
<span class="lineno" id=line95></span>    showline();
<span class="lineno" id=line96></span>  }
<span class="lineno" id=line97></span>  
<span class="lineno" id=line98></span>  &lt;/script&gt;
<span class="lineno" id=line99></span>  """</span>;
<span class="lineno" id=line100></span>  
<span class="lineno" id=line101></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./slideshow-interface"</span>;
<span class="lineno" id=line102></span>  
<span class="lineno" id=line103></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup(config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line104></span>    <span class="comment">//eprintln$ "Setup html_slideshow " + config_data;</span>
<span class="lineno" id=line105></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line106></span>  }
<span class="lineno" id=line107></span>  
<span class="lineno" id=line108></span>  
<span class="lineno" id=line109></span>  <span class="big_keyword" title="define an object factory">object</span> html_slideshow (<span class="big_keyword" title="Define a mutable variable">var</span> write_string: <span class="library" title="binding of C++ string type">string</span> -&gt; 0) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> slideshow_t = 
<span class="lineno" id=line110></span>  {
<span class="lineno" id=line111></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"Slideshow object"</span>;
<span class="lineno" id=line112></span>    <span class="big_keyword" title="Define a mutable variable">var</span> slideshow-used = <span class="library" title="false value">false</span>;
<span class="lineno" id=line113></span>    <span class="big_keyword" title="Define a mutable variable">var</span> slide_count = 0;
<span class="lineno" id=line114></span>    <span class="big_keyword" title="Define a mutable variable">var</span> slide_section_count = 0;
<span class="lineno" id=line115></span>  
<span class="lineno" id=line116></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> end_slide_section() { write_string(<span class="fstring">"\n&lt;/div&gt;"</span>); }
<span class="lineno" id=line117></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> end_slide() {
<span class="lineno" id=line118></span>      write_string(<span class="fstring">"&lt;/div&gt;\n&lt;script&gt;\nslides["</span>+<span class="library" title="Convert a value to a string">str</span> slide_count+<span class="fstring">"]="</span> + <span class="library" title="Convert a value to a string">str</span> slide_section_count + <span class="fstring">";\n&lt;/script&gt;\n"</span>);
<span class="lineno" id=line119></span>    }
<span class="lineno" id=line120></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> start_slide() {
<span class="lineno" id=line121></span>      write_string(<span class="fstring">'\n&lt;div class="slide" id="slide-'</span>+<span class="library" title="Convert a value to a string">str</span> slide_count+<span class="fstring">'"&gt;\n'</span>);
<span class="lineno" id=line122></span>    }
<span class="lineno" id=line123></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> start_slide_section() {
<span class="lineno" id=line124></span>      write_string(<span class="fstring">'\n&lt;div class="slide-section" id="slide-section-'</span>+
<span class="lineno" id=line125></span>        <span class="library" title="Convert a value to a string">str</span> slide_count+<span class="fstring">","</span>+<span class="library" title="Convert a value to a string">str</span> slide_section_count+<span class="fstring">'" style="display:none"&gt;\n'</span>);
<span class="lineno" id=line126></span>    }
<span class="lineno" id=line127></span>  
<span class="lineno" id=line128></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> check-slide-commands (b:<span class="library" title="binding of C++ string type">string</span>) : bool =
<span class="lineno" id=line129></span>    {
<span class="lineno" id=line130></span>      <span class="small_keyword" title="conditional">if</span> b == <span class="fstring">"slideshow"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line131></span>        slideshow-used = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line132></span>        write_string (slideshow_js);
<span class="lineno" id=line133></span>        slide_count = 0;
<span class="lineno" id=line134></span>        slide_section_count = 0;
<span class="lineno" id=line135></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="truth value">true</span>;
<span class="lineno" id=line136></span>      <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"slide"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line137></span>        <span class="small_keyword" title="conditional">if</span> slide_count != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line138></span>          end_slide_section(); 
<span class="lineno" id=line139></span>          end_slide(); 
<span class="lineno" id=line140></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line141></span>        slide_count = slide_count + 1;
<span class="lineno" id=line142></span>        slide_section_count = 1;
<span class="lineno" id=line143></span>        start_slide();
<span class="lineno" id=line144></span>        start_slide_section();
<span class="lineno" id=line145></span>        <span class="comment">//s = doc;</span>
<span class="lineno" id=line146></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="truth value">true</span>;
<span class="lineno" id=line147></span>      <span class="small_keyword" title="conditional">elif</span> b == <span class="fstring">"section"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line148></span>        <span class="small_keyword" title="conditional">if</span> slide_section_count != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line149></span>          end_slide_section(); 
<span class="lineno" id=line150></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line151></span>        slide_section_count = slide_section_count + 1; 
<span class="lineno" id=line152></span>        start_slide_section();
<span class="lineno" id=line153></span>        <span class="comment">//s = doc;</span>
<span class="lineno" id=line154></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="truth value">true</span>;
<span class="lineno" id=line155></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line156></span>        <span class="small_keyword" title="return">return</span> <span class="library" title="false value">false</span>;
<span class="lineno" id=line157></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line158></span>    }
<span class="lineno" id=line159></span>  
<span class="lineno" id=line160></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> finalise() =
<span class="lineno" id=line161></span>    {
<span class="lineno" id=line162></span>      <span class="small_keyword" title="conditional">if</span> slide_count &gt; 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line163></span>        end_slide_section();
<span class="lineno" id=line164></span>        end_slide();
<span class="lineno" id=line165></span>        write_string(<span class="fstring">"\n&lt;script&gt;nslides = "</span> + <span class="library" title="Convert a value to a string">str</span> slide_count + <span class="fstring">";&lt;/script&gt;\n"</span>);
<span class="lineno" id=line166></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line167></span>    }
<span class="lineno" id=line168></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> active () =&gt; slideshow-used;
<span class="lineno" id=line169></span>  };
<span class="lineno" id=line170></span>  
<span class="lineno" id=line171></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"html_slideshow_setup"</span>;
<span class="lineno" id=line172></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> html_slideshow of (string-&gt;0) as <span class="fstring">"html_slideshow"</span>;
<span class="lineno" id=line173></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/plugin_common.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Open a module or class">open</span> <span class="big_keyword" title="Define a type class">class</span> WebserverPluginCommon
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_file (<span class="big_keyword" title="Define a mutable variable">var</span> fname:<span class="library" title="binding of C++ string type">string</span>, INSTALL_ROOT:<span class="library" title="binding of C++ string type">string</span>, path:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) = {
<span class="lineno" id=line4></span>  <span class="comment">//println$ "Search for file " + fname;</span>
<span class="lineno" id=line5></span>      <span class="small_keyword" title="conditional">if</span> fname.[0] == <span class="library" title="binding of C char type">char</span> <span class="fstring">"$"</span> <span class="small_keyword" title="imperative code begins">do</span> fname = fname.[1 <span class="small_keyword" title="substring range separator">to</span>]; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line6></span>      <span class="small_keyword" title="conditional">if</span> FileStat::fileexists fname <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line7></span>        <span class="comment">//println$ "Found as " + fname; </span>
<span class="lineno" id=line8></span>        <span class="small_keyword" title="return">return</span> Some fname;
<span class="lineno" id=line9></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line10></span>        <span class="big_keyword" title="Define a mutable variable">var</span> f = Filename::join(INSTALL_ROOT,fname);
<span class="lineno" id=line11></span>        <span class="small_keyword" title="conditional">if</span> FileStat::fileexists f <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line12></span>          <span class="comment">// println$ "Found in root as " + f; </span>
<span class="lineno" id=line13></span>          <span class="small_keyword" title="return">return</span> Some f;
<span class="lineno" id=line14></span>        <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line15></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = FileSystem::find_in_path (fname, path);
<span class="lineno" id=line16></span>          <span class="comment">//match result with</span>
<span class="lineno" id=line17></span>          <span class="comment">//| Some f =&gt; println$ "Found in path as " + f;</span>
<span class="lineno" id=line18></span>          <span class="comment">//| #None =&gt; println$ "Not found in path " + str path;</span>
<span class="lineno" id=line19></span>          <span class="comment">//endmatch;</span>
<span class="lineno" id=line20></span>          <span class="small_keyword" title="return">return</span> <span class="small_keyword" title="value of function return used in post condition">result</span>;
<span class="lineno" id=line21></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line22></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line23></span>    }
<span class="lineno" id=line24></span>  }
<span class="lineno" id=line25></span>  
</pre></p><pre class='inclusion'>
share/lib/plugins/toc_menu.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"./toc_menu-interface"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup (config_data:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line4></span>    <span class="comment">//eprintln$ "Setup toc_menu v1.1 " + config_data;</span>
<span class="lineno" id=line5></span>    <span class="small_keyword" title="return">return</span> 0;
<span class="lineno" id=line6></span>  }
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Define a mutable variable">var</span> menu_js = <span class="fstring">"""
<span class="lineno" id=line9></span>  &lt;script type="text/javascript"&gt;
<span class="lineno" id=line10></span>  
<span class="lineno" id=line11></span>    function mexpand(id)
<span class="lineno" id=line12></span>    {
<span class="lineno" id=line13></span>      var n = document.getElementById(id).style;
<span class="lineno" id=line14></span>      n.display = "block";
<span class="lineno" id=line15></span>    }
<span class="lineno" id=line16></span>  
<span class="lineno" id=line17></span>    function mcollapse(id)
<span class="lineno" id=line18></span>    {
<span class="lineno" id=line19></span>      var n = document.getElementById(id).style;
<span class="lineno" id=line20></span>      n.display = "none";
<span class="lineno" id=line21></span>    }
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>    var counter_max = 0;
<span class="lineno" id=line24></span>    function mshow(id,loc)
<span class="lineno" id=line25></span>    {
<span class="lineno" id=line26></span>      var i;
<span class="lineno" id=line27></span>      for(i=1; i&lt;=counter_max; ++i)
<span class="lineno" id=line28></span>        mcollapse("menu"+String(i));
<span class="lineno" id=line29></span>      mexpand(id);
<span class="lineno" id=line30></span>      window.location.replace(loc);
<span class="lineno" id=line31></span>    }
<span class="lineno" id=line32></span>  &lt;/script&gt;
<span class="lineno" id=line33></span>  """</span>;
<span class="lineno" id=line34></span>  
<span class="lineno" id=line35></span>  <span class="big_keyword" title="Define a mutable variable">var</span> menu_style = <span class="fstring">"""
<span class="lineno" id=line36></span>  &lt;style&gt;
<span class="lineno" id=line37></span>  div.m {
<span class="lineno" id=line38></span>      margin: 0px;
<span class="lineno" id=line39></span>      padding:0px;
<span class="lineno" id=line40></span>      border-width:2px;
<span class="lineno" id=line41></span>      border-color: green;
<span class="lineno" id=line42></span>  }
<span class="lineno" id=line43></span>  
<span class="lineno" id=line44></span>  div.m1 {
<span class="lineno" id=line45></span>      background-color: #86E870;
<span class="lineno" id=line46></span>      border-style:outset;
<span class="lineno" id=line47></span>      border-color:#ccc;
<span class="lineno" id=line48></span>      border-width:2px 0;
<span class="lineno" id=line49></span>      font-size:90%;
<span class="lineno" id=line50></span>      padding: 1px 0 2px 10px;
<span class="lineno" id=line51></span>  }
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>  div.m2 {
<span class="lineno" id=line54></span>      background-color: #70C070;
<span class="lineno" id=line55></span>      padding-left:15px;
<span class="lineno" id=line56></span>      padding-top:2px;
<span class="lineno" id=line57></span>      border-style:outset;
<span class="lineno" id=line58></span>      border-color:green;
<span class="lineno" id=line59></span>      border-width:0 0 1px 0;
<span class="lineno" id=line60></span>      font-size:80%;
<span class="lineno" id=line61></span>  }
<span class="lineno" id=line62></span>  
<span class="lineno" id=line63></span>  div.m1:hover, div.m2:hover {
<span class="lineno" id=line64></span>      background-color: white;
<span class="lineno" id=line65></span>  }
<span class="lineno" id=line66></span>  
<span class="lineno" id=line67></span>  #leftmargintoc a {
<span class="lineno" id=line68></span>      text-decoration: none;
<span class="lineno" id=line69></span>      color: #404040;
<span class="lineno" id=line70></span>  }
<span class="lineno" id=line71></span>  
<span class="lineno" id=line72></span>  
<span class="lineno" id=line73></span>  &lt;/style&gt;
<span class="lineno" id=line74></span>  """</span>;
<span class="lineno" id=line75></span>  
<span class="lineno" id=line76></span>  <span class="big_keyword" title="Define a function with no side-effects">fun</span> escape_sp(h: <span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (c: <span class="library" title="binding of C char type">char</span>) =&gt; <span class="small_keyword" title="conditional">if</span> c == <span class="fstring">' '</span> <span class="small_keyword" title="conditional">then</span> <span class="fstring">'_'</span>.<span class="library" title="binding of C char type">char</span> <span class="small_keyword" title="conditional">else</span> c) h;
<span class="lineno" id=line77></span>  
<span class="lineno" id=line78></span>  
<span class="lineno" id=line79></span>  <span class="big_keyword" title="define an object factory">object</span> toc_menu (h:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>]) <span class="small_keyword" title="specify what interfaces an object implements">implements</span> toc_menu_interface =
<span class="lineno" id=line80></span>  {
<span class="lineno" id=line81></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> whatami () =&gt; <span class="fstring">"toc_menu maker"</span>;
<span class="lineno" id=line82></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_style () =&gt; menu_style;
<span class="lineno" id=line83></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> get_js() =&gt; menu_js;
<span class="lineno" id=line84></span>    <span class="qualifier" title="A function depending only on its parameters">method</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> make_menu() =
<span class="lineno" id=line85></span>    {
<span class="lineno" id=line86></span>      <span class="comment">// LEFT MARGIN</span>
<span class="lineno" id=line87></span>      <span class="big_keyword" title="Define a mutable variable">var</span> leftcontent =<span class="fstring">'  &lt;!--Left Margin Toc--&gt;\n'</span>;
<span class="lineno" id=line88></span>        leftcontent +=<span class="fstring">'  &lt;div id="leftmargintoc"&gt;\n'</span>;
<span class="lineno" id=line89></span>  
<span class="lineno" id=line90></span>        <span class="comment">// Contents body</span>
<span class="lineno" id=line91></span>          leftcontent+=<span class="fstring">'    &lt;!--Left Margin Toc Main Contents--&gt;\n'</span>;
<span class="lineno" id=line92></span>  
<span class="lineno" id=line93></span>          <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> head1(level:<span class="library" title="binding of C int type">int</span>, text:<span class="library" title="binding of C++ string type">string</span>, link:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line94></span>            leftcontent+= <span class="fstring">"""      &lt;div class=m1 onclick="mshow('menu"""</span>+ counter.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">"""','"""</span>+link+<span class="fstring">"""')"&gt; """</span>;
<span class="lineno" id=line95></span>            leftcontent+= <span class="fstring">'''&lt;a href="'''</span>+escape_sp(link)+<span class="fstring">'''"&gt;'''</span>;
<span class="lineno" id=line96></span>            leftcontent+= text + <span class="fstring">"&lt;/a&gt;&lt;/div&gt;\n"</span>;
<span class="lineno" id=line97></span>            leftcontent+= <span class="fstring">"""      &lt;div class=sm id=menu"""</span>+counter.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">"""&gt;\n"""</span>;
<span class="lineno" id=line98></span>          }
<span class="lineno" id=line99></span>          <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> foot1() { leftcontent+=<span class="fstring">"      &lt;/div&gt;\n"</span>; }
<span class="lineno" id=line100></span>          <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> break1(level:<span class="library" title="binding of C int type">int</span>, text:<span class="library" title="binding of C++ string type">string</span>,link:<span class="library" title="binding of C++ string type">string</span>) {foot1(); ++counter; head1(level,text,link); }
<span class="lineno" id=line101></span>  
<span class="lineno" id=line102></span>          <span class="big_keyword" title="Define a mutable variable">var</span> counter = 0;
<span class="lineno" id=line103></span>          <span class="library" title="call procedure on each element of data structure">iter</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> (level:<span class="library" title="binding of C int type">int</span>,text:<span class="library" title="binding of C++ string type">string</span>, link:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line104></span>            {
<span class="lineno" id=line105></span>              <span class="comment">//println$ i,s;</span>
<span class="lineno" id=line106></span>              <span class="small_keyword" title="conditional">if</span> level == 1 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// first level meny entry</span>
<span class="lineno" id=line107></span>                <span class="small_keyword" title="conditional">if</span> counter == 0 <span class="small_keyword" title="imperative code begins">do</span> ++counter; head1 (level, text, link);
<span class="lineno" id=line108></span>                <span class="small_keyword" title="conditional">else</span> break1 (level,text,link);
<span class="lineno" id=line109></span>                <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line110></span>              <span class="small_keyword" title="conditional">elif</span> level == 2 <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// second level menu entry</span>
<span class="lineno" id=line111></span>                leftcontent+=<span class="fstring">"      &lt;div class=m2&gt;"</span>;
<span class="lineno" id=line112></span>                leftcontent+=<span class="fstring">'''&lt;a href="'''</span>+escape_sp(link)+<span class="fstring">'''"&gt;'''</span>+text+<span class="fstring">'''&lt;/a&gt;&lt;/div&gt;\n'''</span>;
<span class="lineno" id=line113></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line114></span>            }
<span class="lineno" id=line115></span>            h
<span class="lineno" id=line116></span>          ;
<span class="lineno" id=line117></span>          <span class="small_keyword" title="conditional">if</span> counter &gt;= 1 <span class="small_keyword" title="imperative code begins">do</span>  foot1; <span class="small_keyword" title="end of body">done</span>;
<span class="lineno" id=line118></span>          leftcontent+=<span class="fstring">"    &lt;script&gt;counter_max="</span>+counter.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">";&lt;/script&gt;\n"</span>;
<span class="lineno" id=line119></span>  
<span class="lineno" id=line120></span>        leftcontent+=<span class="fstring">'  &lt;/div&gt;\n'</span>; <span class="comment">// leftmargintoc end</span>
<span class="lineno" id=line121></span>        leftcontent+=<span class="fstring">'  &lt;!--End Left Margin Toc--&gt;\n'</span>;
<span class="lineno" id=line122></span>      <span class="small_keyword" title="return">return</span> leftcontent;
<span class="lineno" id=line123></span>    }
<span class="lineno" id=line124></span>  
<span class="lineno" id=line125></span>  }
<span class="lineno" id=line126></span>  
<span class="lineno" id=line127></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> setup of (<span class="library" title="binding of C++ string type">string</span>) as <span class="fstring">"toc_menu_setup"</span>;
<span class="lineno" id=line128></span>  <span class="big_keyword" title="generate extern "C" wrapper">export</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> toc_menu of (<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C int type">int</span> * <span class="library" title="binding of C++ string type">string</span> * <span class="library" title="binding of C++ string type">string</span>]) as <span class="fstring">"toc_menu"</span>;
<span class="lineno" id=line129></span>  
</pre></p></div><!--Main Content Body End-->

          </div> <!-- rightpanel contents end -->
          <hr>
        </span> <!-- rightpanel end -->

        <span id="panemover" style="cursor:col-resize;"
         onmousedown="dragStart(event, 'left', 'right'); return false;"
         onmousemove="drag(event, 'left', 'right');"
         onmouseout="dragRelease();"
         onmouseup="dragRelease();"
        >
        </span> <!-- panemover end -->
      </div> <!-- bottom panel end -->
    </div> <!-- container end -->
</body></html>

