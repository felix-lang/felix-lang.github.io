<html><head>
<style type="text/css">
body {margin:3%; }
h1 {color:gray; font-size:120%;}
h2 {color:gray; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre.flxbg {background-color:#A0FFA0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.uncheckedflxbg {background-color:#D0D0D0; color:black; padding:2px; box-shadow:5px 5px 2px #807080; }
pre.cppbg {background-color:#80FF80; color:black; }
pre.prefmtbg {background-color:#D0D0D0; color:black; }
pre.expected {background-color:#E0FF80; color:black; }
pre.input {background-color:#E08080; color:black; }
pre.inclusion {background-color:#D070D0; color:black; }
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:#FF8080; color:black; }
</style>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
        skipTags: ["script","noscript","style","textarea"]
    }
  });
</script>
<title>Tools For building Felix</title></head><body>
<style>
body {margin:3%; font-family: sans-serif; }
h1 {color:black; font-size:120%; border-bottom: 2px solid #ddd; padding: 0 0 3px 0;}
h2 {color:#202020; font-size:105%;}
h3 {font-size:100%;}
h4 {font-size:95%;}
h5 {font-size:95%;}
span.fstring {color:darkblue; font-style:italic; }
span.comment {font-family:arial; color:blue; font-style:italic; }
span.doccomment {font-family:arial; color:green; font-style:italic; }
span.big_keyword {color:#FF1010; }
span.small_keyword {color:#802040; }
span.qualifier {color:#A02020; }
span.library {color:#A02000; }
span.ctor {color:#406020; }
span.hack {color:#66DD00; }
span.preproc {color:#005500; }
span.embedded_c{background-color:#DDDDDD; }
span.fpc_fieldname {color:#DD0000; }
span.lineno {color:#101010; background-color:#E0E0E0; font-size:80%; font-family:"courier",monospace; font-style:normal; }
pre { border: 1px solid #ccc; color: black; box-shadow:3px 3px 2px rgba(0,0,0,0.1); padding:2px; }
pre.flxbg {background-color:#C2FDC2; box-shadow:3px 3px 2px rgba(0,0,0,0.1) }
pre.uncheckedflxbg {background-color:#eee; box-shadow:3px 3px 2px rgba(0,0,0,0.1); }
pre.cppbg {background-color:#C2FDC2; }
pre.prefmtbg {background-color:#F1F1F1; }
pre.expected {background-color:hsla(74,94%,88%,1); }
pre.input {background-color:hsla(20,94%,88%,1); }
pre.inclusion {
    font-family: Arial;
    font-weight: normal;
    font-size: 0.9em;
    color: #555;
    border: none;
    box-shadow: none;
    text-align: right;
    margin: -7px 11px -12px 0;
    padding: 0;
    background-color:#fafafa;
}
code.inclusion {background-color:#D070D0; color:black; }
.obsolete { background-color:#FFEFEF; font-size: small; color:black; }
.future { background-color:#FF8080; font-size: small; color:black; }
.implementation_detail { background-color:#E0E0E0; font-size: small; color:black;  }
.bug { background-color:#FFE0E0; font-size: small; color:black; }
.fixed{ background-color:#FFE0E0; font-size: small; color:black; }
.done { background-color:#FFE0E0; font-size: small; color:black; }
.caveat { background-color:hsla(0,100%,91%,1); color:black; padding: 0.6em; }
.container {
  position: fixed;
  top:0px;
  left:0px;
  height : 100%;
  width: 100%;
  background-color: grey;
  margin: 0px;
  padding: 0px;
  border-width: 0px;
  color: #404040;
}
.maincontent {
  padding:4px;
  padding-left:8px;
  line-height:1.3em;
  color:#404040; background-color:#fafafa;
}
.maincontent h1 { margin-left:-8px; position: relative; font-family: georgia, serif; font-size: 1.8em; font-weight: normal; }
.maincontent h2 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h3 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent h4 { margin-left:-8px; position: relative; margin-bottom:-5px; }
.maincontent code { color:#902030; }
.toppanel {
  position:absolute; left:0px; top:0px; height:20px; right:0px;
  background-color: #e0e0e0;
}
.bottompanel {
  position:absolute; left:0px; top:22px; bottom:0px; right:0px;
  background-color: #fafafa;
  font-size:14px;
}
.leftpanel {
  position:absolute; left:0px; top:0px; bottom:0px; width: 150px;
  background-color: #eaeaea; overflow: auto;
}
.rightpanel {
  position:absolute; right: 0px; left:160px; top:0px; bottom: 0px;
  background-color: #fafafa; overflow: auto;
}
.divider {
  position:absolute; left: 150px; top:0px; bottom:0px;
  background-color: black; width:2px;
  box-shadow: 0 0 8px #000;
}

#panemover {
    position:absolute;
    left: 150px;
    width : 10px;
    top: 0px;
    bottom: 0px;
    opacity: 0.3;
    cursor:col-resize;
}

div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}
</style>

<style>
div.m {
    margin: 0px;
    padding:0px;
    border-width:2px;
    border-color: green;
}

div.m1 {
    background-color: #86E870;
    border-style:outset;
    border-color:#ccc;
    border-width:2px 0;
    font-size:90%;
    padding: 1px 0 2px 10px;
}

div.m2 {
    background-color: #70C070;
    padding-left:15px;
    padding-top:2px;
    border-style:outset;
    border-color:green;
    border-width:0 0 1px 0;
    font-size:80%;
}

div.m1:hover, div.m2:hover {
    background-color: white;
}

#leftmargintoc a {
    text-decoration: none;
    color: #404040;
}


</style>

    <script async="true">
      function dragStart(e, left, right){
        document.getElementById("panemover").style.width="70%";
        document.getElementById("panemover").style.left="50px";
        mousedown = true;
        x = e.clientX
        dragOffsetLeft =
          document.getElementById(left).getBoundingClientRect().right -
          document.getElementById(left).getBoundingClientRect().left -
          x
        ;
        dragOffsetDivider= document.getElementById("divider").getBoundingClientRect().left - x;
        dragOffsetRight = document.getElementById(right).getBoundingClientRect().left - x;
      }
      function dragRelease(){
        document.getElementById('panemover').style.width = '10px';
        document.getElementById('panemover').style.left = document.getElementById('divider').offsetLeft + 'px';
        mousedown = false;
      }
      function drag(e, left, right){
        if(!mousedown){return}
        x = e.clientX
        tmpLeft = dragOffsetLeft + x
        tmpDivider= dragOffsetDivider + x
        tmpRight = dragOffsetRight + x
        document.getElementById(left).style.width= tmpLeft + 'px';
        document.getElementById("divider").style.left= tmpDivider + 'px';
        document.getElementById(right).style.left = tmpRight + 'px';
      };
    </script>

<script type="text/javascript">

  function mexpand(id)
  {
    var n = document.getElementById(id).style;
    n.display = "block";
  }

  function mcollapse(id)
  {
    var n = document.getElementById(id).style;
    n.display = "none";
  }

  var counter_max = 0;
  function mshow(id,loc)
  {
    var i;
    for(i=1; i<=counter_max; ++i)
      mcollapse("menu"+String(i));
    mexpand(id);
    window.location.replace(loc);
  }
</script>

<script type="text/javascript">

function expand(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/minus.gif";
  button.alt = "-";
  n.display = "block";
}
function collapse(but,id)
{
  var n = document.getElementById(id).style;
  var button = document.getElementById(but);
  button.src = "/share/src/web/images/plus.gif";
  button.alt = "+";
  n.display = "none";
}
function toggle(button,id)
{
  var n = document.getElementById(id).style;
  if (n.display == "none")
  {
    button.src = "/share/src/web/images/minus.gif";
    button.alt = "-";
    n.display = "block";
  }
  else
  {
    button.src = "/share/src/web/images/plus.gif";
    button.alt = "+";
    n.display = "none";
  }
}
var allbuttons = [
"Tools to build the core Felix system.",
"Building the compiler <code>flxg</code>",
"Preparation for building.",
"Build the Run Time Library (RTL)",
"Build everything else."
];
function expand_all(dummy)
{
  for (i in allbuttons)
  {
    expand(allbuttons[i], allbuttons[i]+"_d");
  }
}
function collapse_all(dummy)
{
  for (i in allbuttons)
  {
    collapse(allbuttons[i], allbuttons[i]+"_d");
  }
}
</script>

<script>
function mouseover(id)
{
  var elt = document.getElementById(id);
  elt.style.display="none";
  var elt2 = document.getElementById(id+"_mo");
  elt2.style.display="inline";
}

function mouseout(id)
{
  var elt = document.getElementById(id+"_mo");
  elt.style.display="none";
  var elt2 = document.getElementById(id);
  elt2.style.display="inline";
}

</script>
<script> function nop(dummy) {} </script>
    <div class="container">
      <div class="toppanel">
    <!--Main Content top navbar-->
<span style="position:relative; bottom:6px"
  onmouseover="mouseover('expand')"
  onmouseout="mouseout('expand')"
  onclick="expand_all('expand')"
  ><span id="expand"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span><span id="expand_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Expand</text></svg></span></span><span style="position:relative; bottom:6px"
  onmouseover="mouseover('collapse')"
  onmouseout="mouseout('collapse')"
  onclick="collapse_all('collapse')"
  ><span id="collapse"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:blue;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span><span id="collapse_mo" style="display:none"><svg height="30px" width="65px"><rect x="4px" y="6px" rx="4px" ry="40px" width="60px" height="20px" style="fill:red;opacity:0.2;stroke:black;stroke-width:2"/><text x="13px" y="21px" fill="black" style="font-size:12px;">Collapse</text></svg></span></span>    <!--Main Content top navbar End-->

      </div> <!-- toppanel end -->
      <div class="bottompanel">
        <span id="divider" class="divider"></span>

        <span id="left" class="leftpanel" >
          <div class="menucontent">
  <!--Left Margin Toc-->
  <div id="leftmargintoc">
    <!--Left Margin Toc Main Contents-->
      <div class=m1 onclick="mshow('menu1','#Tools to build the core Felix system._h')"> <a href="#Tools_to_build_the_core_Felix_system._h">Tools to build the core Felix system.</a></div>
      <div class=sm id=menu1>
      <div class=m2><a href="#Building_the_compiler_<code>flxg</code>_h">Building the compiler <code>flxg</code></a></div>
      <div class=m2><a href="#Preparation_for_building._h">Preparation for building.</a></div>
      <div class=m2><a href="#Build_the_Run_Time_Library_(RTL)_h">Build the Run Time Library (RTL)</a></div>
      <div class=m2><a href="#Build_everything_else._h">Build everything else.</a></div>
      </div>
    <script>counter_max=1;</script>
  </div>
  <!--End Left Margin Toc-->

          </div> <!-- leftpanel contents end -->
        </span> <!-- leftpanel end -->

        <span id="right" class="rightpanel">
          <div class="maincontent">
<!--Main Content Body-->
<h1 id='Tools_to_build_the_core_Felix_system._h'><img src='/share/src/web/images/minus.gif' id='Tools to build the core Felix system.' onclick='toggle(this,"Tools_to_build_the_core_Felix_system._d")' alt='+'/> 1 Tools to build the core Felix system.</h1><div id='Tools_to_build_the_core_Felix_system._d' style='display:block'>
<p>These tools are written in Felix and can be
used to build a Felix installation. However of course
you must first have a working installation to do this.
</p><h2 id='Building_the_compiler_<code>flxg</code>_h'><img src='/share/src/web/images/minus.gif' id='Building the compiler <code>flxg</code>' onclick='toggle(this,"Building_the_compiler_<code>flxg</code>_d")' alt='+'/> 1.1 Building the compiler <code>flxg</code></h2><div id='Building_the_compiler_<code>flxg</code>_d' style='display:block'>
<p>Run this one first to build the compiler.
It is built directly from the repository.
</p><pre class='inclusion'>
$PWD/src/tools/flx_build_flxg.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Define a type class">class</span> BuildFlxg
<span class="lineno" id=line2></span>  {
<span class="lineno" id=line3></span>  
<span class="lineno" id=line4></span>  
<span class="lineno" id=line5></span>    <span class="comment">// remove slosh-newline</span>
<span class="lineno" id=line6></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> pack(s:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line7></span>      <span class="big_keyword" title="Define a mutable variable">var</span> slosh = <span class="library" title="false value">false</span>;
<span class="lineno" id=line8></span>      <span class="big_keyword" title="Define a mutable variable">var</span> space = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line9></span>      <span class="big_keyword" title="Define a mutable variable">var</span> out = <span class="fstring">""</span>;
<span class="lineno" id=line10></span>      <span class="small_keyword" title="for loop">for</span> ch <span class="small_keyword" title="membership operator, function mem">in</span> s <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line11></span>        <span class="small_keyword" title="conditional">if</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"\n"</span> <span class="small_keyword" title="logical conjunction">and</span> slosh <span class="small_keyword" title="imperative code begins">do</span> slosh = <span class="library" title="false value">false</span>;
<span class="lineno" id=line12></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="library" title="binding of C char type">char</span> <span class="fstring">"\\"</span> <span class="small_keyword" title="imperative code begins">do</span> slosh=<span class="library" title="truth value">true</span>; 
<span class="lineno" id=line13></span>        <span class="small_keyword" title="conditional">elif</span> slosh <span class="small_keyword" title="imperative code begins">do</span> slosh=<span class="library" title="false value">false</span>; out+=<span class="fstring">"\\"</span>; out+=ch;
<span class="lineno" id=line14></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="fstring">"\t"</span> <span class="small_keyword" title="imperative code begins">do</span> out+=<span class="library" title="binding of C char type">char</span> <span class="fstring">' '</span>; space=<span class="library" title="truth value">true</span>;
<span class="lineno" id=line15></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="fstring">' '</span> <span class="small_keyword" title="logical conjunction">and</span> space <span class="small_keyword" title="imperative code begins">do</span> ;
<span class="lineno" id=line16></span>        <span class="small_keyword" title="conditional">elif</span> ch == <span class="fstring">' '</span> <span class="small_keyword" title="imperative code begins">do</span> out+=ch; space=<span class="library" title="truth value">true</span>;
<span class="lineno" id=line17></span>        <span class="small_keyword" title="conditional">else</span> out+=ch; space=<span class="library" title="false value">false</span>;
<span class="lineno" id=line18></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line19></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line20></span>      <span class="small_keyword" title="return">return</span> out;
<span class="lineno" id=line21></span>    }
<span class="lineno" id=line22></span>  
<span class="lineno" id=line23></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> version_hook () = {
<span class="lineno" id=line24></span>      <span class="big_keyword" title="Define a mutable variable">var</span> time = #Time::time;
<span class="lineno" id=line25></span>      <span class="comment">//var fmttime = fmt_time (time, "%a %d %b %Y");</span>
<span class="lineno" id=line26></span>      <span class="big_keyword" title="Define a mutable variable">var</span> fmttime = time.<span class="library" title="Convert a value to a string">str</span>; <span class="comment">// Its just arbitrary text</span>
<span class="lineno" id=line27></span>      <span class="small_keyword" title="return">return</span>
<span class="lineno" id=line28></span>        <span class="fstring">"open Flx_version\n"</span> +
<span class="lineno" id=line29></span>        <span class="fstring">"let version_data: version_data_t = \n"</span> +
<span class="lineno" id=line30></span>        <span class="fstring">"{\n"</span> +
<span class="lineno" id=line31></span>        <span class="fstring">'  version_string = "'</span> + Version::felix_version + <span class="fstring">'";\n'</span> +
<span class="lineno" id=line32></span>        <span class="fstring">'  build_time_float = '</span>+ <span class="library" title="Convert a value to a string">str</span> time + <span class="fstring">';\n'</span>+ 
<span class="lineno" id=line33></span>        <span class="fstring">'  build_time = "'</span> + fmttime + <span class="fstring">'";\n'</span>+
<span class="lineno" id=line34></span>        <span class="fstring">"}\n"</span> +
<span class="lineno" id=line35></span>        <span class="fstring">";;\n"</span> +
<span class="lineno" id=line36></span>        <span class="fstring">"let set_version () = \n"</span> +
<span class="lineno" id=line37></span>        <span class="fstring">"  Flx_version.version_data := version_data\n"</span> +
<span class="lineno" id=line38></span>        <span class="fstring">";;\n"</span>
<span class="lineno" id=line39></span>      ;
<span class="lineno" id=line40></span>    }
<span class="lineno" id=line41></span>  
<span class="lineno" id=line42></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> first (a:<span class="library" title="binding of C++ string type">string</span>, b:<span class="library" title="binding of C++ string type">string</span>) =&gt; a;
<span class="lineno" id=line43></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> second (a:<span class="library" title="binding of C++ string type">string</span>, b:<span class="library" title="binding of C++ string type">string</span>) =&gt; b;
<span class="lineno" id=line44></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_flx_drivers() 
<span class="lineno" id=line45></span>    {
<span class="lineno" id=line46></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tmpdir = <span class="fstring">'build/flxg-tmp'</span>;
<span class="lineno" id=line47></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> entmp (a:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="small_keyword" title="conditional">if</span> prefix (a,tmpdir) <span class="small_keyword" title="conditional">then</span> a <span class="small_keyword" title="conditional">else</span> tmpdir/a;
<span class="lineno" id=line48></span>  
<span class="lineno" id=line49></span>      <span class="hack">C_hack</span>::ignore$ Directory::mkdir tmpdir;
<span class="lineno" id=line50></span>     
<span class="lineno" id=line51></span>      <span class="comment">// make the version hook file</span>
<span class="lineno" id=line52></span>      <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line53></span>        <span class="big_keyword" title="Define a mutable variable">var</span> path = tmpdir/<span class="fstring">"flx_version_hook"</span>;
<span class="lineno" id=line54></span>        Directory::mkdirs path;
<span class="lineno" id=line55></span>        <span class="big_keyword" title="Define a mutable variable">var</span> f = fopen_output (path/<span class="fstring">"flx_version_hook.ml"</span>);
<span class="lineno" id=line56></span>        <span class="library" title="Print a string to a stream">write</span> (f, #version_hook);
<span class="lineno" id=line57></span>        fclose f;
<span class="lineno" id=line58></span>      <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line59></span>  
<span class="lineno" id=line60></span>      <span class="big_keyword" title="Define a mutable variable">var</span> db = strdict[bool]();
<span class="lineno" id=line61></span>      <span class="big_keyword" title="Define an alias for a type expression">typedef</span> db_t = strdict[bool];
<span class="lineno" id=line62></span>  
<span class="lineno" id=line63></span>      <span class="big_keyword" title="Define a mutable variable">var</span> sorted_libs = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line64></span>  
<span class="lineno" id=line65></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> libdflt () =&gt; (
<span class="lineno" id=line66></span>        srcs=Empty[<span class="library" title="binding of C++ string type">string</span>], 
<span class="lineno" id=line67></span>        libs=Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line68></span>        includes=Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line69></span>        external_libs=Empty[<span class="library" title="binding of C++ string type">string</span>]
<span class="lineno" id=line70></span>      );
<span class="lineno" id=line71></span>  
<span class="lineno" id=line72></span>      <span class="big_keyword" title="Define an alias for a type expression">typedef</span> libspec_t = typeof (#libdflt);
<span class="lineno" id=line73></span>  
<span class="lineno" id=line74></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> exedflt () =&gt; libdflt();
<span class="lineno" id=line75></span>      <span class="big_keyword" title="Define an alias for a type expression">typedef</span> exespec_t = typeof (#exedflt);
<span class="lineno" id=line76></span>  
<span class="lineno" id=line77></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> lexdflt () =&gt; (flags=Empty[<span class="library" title="binding of C++ string type">string</span>]);
<span class="lineno" id=line78></span>      <span class="big_keyword" title="Define an alias for a type expression">typedef</span> lexspec_t = typeof (#lexdflt);
<span class="lineno" id=line79></span>  
<span class="lineno" id=line80></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> yaccflt () =&gt; (flags=Empty[<span class="library" title="binding of C++ string type">string</span>]);
<span class="lineno" id=line81></span>      <span class="big_keyword" title="Define an alias for a type expression">typedef</span> yaccspec_t = typeof (#lexdflt);
<span class="lineno" id=line82></span>  
<span class="lineno" id=line83></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> dypgendflt () =&gt; (flags=Empty[<span class="library" title="binding of C++ string type">string</span>]);
<span class="lineno" id=line84></span>      <span class="big_keyword" title="Define an alias for a type expression">typedef</span> dypgenspec_t = typeof (#dypgendflt);
<span class="lineno" id=line85></span>  
<span class="lineno" id=line86></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocamldep (dir:<span class="library" title="binding of C++ string type">string</span>, src:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line87></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span>, dep = Shell::get_stdout$ <span class="library" title="functional, singly linked list">list</span>$ <span class="fstring">"ocamldep.opt"</span>, <span class="fstring">"-native"</span>,<span class="fstring">"-I"</span>, Filename::dirname src, <span class="fstring">"-I"</span>, dir, <span class="fstring">"-I"</span>, tmpdir, src;
<span class="lineno" id=line88></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line89></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ocamldep failed to process "</span> + src;
<span class="lineno" id=line90></span>          System::exit (1);
<span class="lineno" id=line91></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line92></span>        <span class="comment">//println$ "Ocamldep raw return = " + dep;</span>
<span class="lineno" id=line93></span>        <span class="big_keyword" title="Define a mutable variable">var</span> out = dep.pack.strip;
<span class="lineno" id=line94></span>        <span class="comment">//println$ "Ocamldep packed return = " + out;</span>
<span class="lineno" id=line95></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lines = filter (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; stl_find (s,<span class="fstring">".cmo"</span>) == stl_npos) (split(out,<span class="fstring">"\n"</span>));
<span class="lineno" id=line96></span>        <span class="comment">//println$ "Ocamldep lines = " + str lines;</span>
<span class="lineno" id=line97></span>        <span class="big_keyword" title="Define a mutable variable">var</span> res = head lines;
<span class="lineno" id=line98></span>        <span class="comment">//println$ "ocamldep result=" + res;</span>
<span class="lineno" id=line99></span>        <span class="big_keyword" title="Define a mutable variable">var</span> pos = stl_find (res, <span class="fstring">":"</span>);
<span class="lineno" id=line100></span>        <span class="small_keyword" title="conditional">if</span> pos == stl_npos <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line101></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Cannot find ':' in string "</span> + res;
<span class="lineno" id=line102></span>          System::exit 1;
<span class="lineno" id=line103></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line104></span>        res = res.[pos+2 <span class="small_keyword" title="substring range separator">to</span>].strip;
<span class="lineno" id=line105></span>        <span class="comment">//println$ "ocamldep result 2 =" + res;</span>
<span class="lineno" id=line106></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dfiles = split(res,<span class="fstring">' '</span>);
<span class="lineno" id=line107></span>        <span class="comment">//println$ "ocamldep result 3 =" + str dfiles;</span>
<span class="lineno" id=line108></span>        dfiles = unbox (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) = { <span class="comment">//println$ "Extension swap case '" + s+"'";</span>
<span class="lineno" id=line109></span>          <span class="small_keyword" title="match statement or expression">match</span> Filename::get_extension s <span class="small_keyword" title="type-class constraint">with</span> 
<span class="lineno" id=line110></span>          | <span class="fstring">".cmi"</span> =&gt; <span class="small_keyword" title="return">return</span> Filename::strip_extension s + <span class="fstring">".mli"</span>;
<span class="lineno" id=line111></span>          | <span class="fstring">".cmx"</span> =&gt; <span class="small_keyword" title="return">return</span> Filename::strip_extension s + <span class="fstring">".ml"</span>;
<span class="lineno" id=line112></span>          | <span class="fstring">""</span> =&gt; <span class="small_keyword" title="return">return</span> <span class="fstring">""</span>;
<span class="lineno" id=line113></span>          | x =&gt; <span class="small_keyword" title="return">return</span>  <span class="fstring">"ERROR"</span> ;
<span class="lineno" id=line114></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line115></span>          }) 
<span class="lineno" id=line116></span>          dfiles)
<span class="lineno" id=line117></span>        ;
<span class="lineno" id=line118></span>        <span class="comment">//println$ "ocamldep result 4 =" + str dfiles;</span>
<span class="lineno" id=line119></span>        dfiles = filter (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; s != <span class="fstring">""</span>) dfiles;
<span class="lineno" id=line120></span>        <span class="small_keyword" title="return">return</span> dfiles;
<span class="lineno" id=line121></span>      }
<span class="lineno" id=line122></span>  
<span class="lineno" id=line123></span>      variant build_kind = Library | Executable;
<span class="lineno" id=line124></span>  
<span class="lineno" id=line125></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocaml_build(kind:build_kind, dir:<span class="library" title="binding of C++ string type">string</span>, lib:<span class="library" title="binding of C++ string type">string</span>, spec:libspec_t) =
<span class="lineno" id=line126></span>      {
<span class="lineno" id=line127></span>  <span class="comment">/*
<span class="lineno" id=line128></span>        var safe_string_flag = 
<span class="lineno" id=line129></span>          if lib == "dypgen.exe" 
<span class="lineno" id=line130></span>          then "-unsafe-string"
<span class="lineno" id=line131></span>          else "-safe-string"
<span class="lineno" id=line132></span>        ;
<span class="lineno" id=line133></span>  */</span>
<span class="lineno" id=line134></span>  <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"-"</span> * 20;
<span class="lineno" id=line135></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Lib="</span> + lib + <span class="fstring">" in "</span> + dir;
<span class="lineno" id=line136></span>  <span class="comment">//      println$ "Safe-string-flag=" + safe_string_flag;</span>
<span class="lineno" id=line137></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"-"</span> * 20;
<span class="lineno" id=line138></span>        <span class="comment">//println$ "srcs = \n    " +strcat "\n    " spec.srcs;</span>
<span class="lineno" id=line139></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"libs= \n    "</span> + strcat <span class="fstring">"\n    "</span> spec.libs;
<span class="lineno" id=line140></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"includes= \n"</span> + strcat <span class="fstring">"\n    "</span> spec.includes;
<span class="lineno" id=line141></span>        <span class="comment">/*
<span class="lineno" id=line142></span>        println$ "external libs = \n    " + strcat "\n    " spec.external_libs;
<span class="lineno" id=line143></span>        println$ "-" * 20;
<span class="lineno" id=line144></span>        println$ "";
<span class="lineno" id=line145></span>        */</span>
<span class="lineno" id=line146></span>  
<span class="lineno" id=line147></span>        <span class="comment">// copy the list of files, processing dyp, mll, and mly files we encounter.</span>
<span class="lineno" id=line148></span>        <span class="big_keyword" title="Define a mutable variable">var</span> infiles = spec.srcs;
<span class="lineno" id=line149></span>        <span class="big_keyword" title="Define a mutable variable">var</span> files = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line150></span>        <span class="small_keyword" title="for loop">for</span> file <span class="small_keyword" title="membership operator, function mem">in</span> infiles <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line151></span>          <span class="small_keyword" title="match statement or expression">match</span> Filename::get_extension file <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line152></span>          | <span class="fstring">".mli"</span> =&gt; files += file;
<span class="lineno" id=line153></span>          | <span class="fstring">".ml"</span> =&gt; files += file;
<span class="lineno" id=line154></span>          | <span class="fstring">".dyp"</span> =&gt; files += dypgen file;
<span class="lineno" id=line155></span>          | <span class="fstring">".mll"</span> =&gt; files += ocamllex file;
<span class="lineno" id=line156></span>          | <span class="fstring">".mly"</span> =&gt; <span class="big_keyword" title="Define a mutable variable">var</span> out = ocamlyacc file; files += out+<span class="fstring">".ml"</span>; files += out+<span class="fstring">".mli"</span>;
<span class="lineno" id=line157></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line158></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line159></span>  
<span class="lineno" id=line160></span>        <span class="big_keyword" title="Define a mutable variable">var</span> sorted_files = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line161></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line162></span>          <span class="comment">// calculate dependencies</span>
<span class="lineno" id=line163></span>          <span class="big_keyword" title="Define a mutable variable">var</span> db = strdict[<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]]();
<span class="lineno" id=line164></span>          <span class="small_keyword" title="for loop">for</span> file <span class="small_keyword" title="membership operator, function mem">in</span> files <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line165></span>            <span class="big_keyword" title="Define a mutable variable">var</span> deps = ocamldep (dir,file);
<span class="lineno" id=line166></span>            deps = filter (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) =&gt; f <span class="small_keyword" title="membership operator, function mem">in</span> files) deps;
<span class="lineno" id=line167></span>            db.add file deps;
<span class="lineno" id=line168></span>            <span class="comment">//println$ "Ocamldep : " + src + " : " + str deps;</span>
<span class="lineno" id=line169></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line170></span>  
<span class="lineno" id=line171></span>          <span class="comment">// topological sort</span>
<span class="lineno" id=line172></span>          <span class="big_keyword" title="Define a mutable variable">var</span> count = 0;
<span class="lineno" id=line173></span>          <span class="small_keyword" title="while loop">while</span> <span class="small_keyword" title="logical negation">not</span> files.is_empty <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line174></span>            ++count;
<span class="lineno" id=line175></span>            <span class="small_keyword" title="conditional">if</span> count &gt; 40 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line176></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Invalid file or circular reference"</span>;
<span class="lineno" id=line177></span>              System::exit 1;
<span class="lineno" id=line178></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line179></span>            <span class="big_keyword" title="Define a mutable variable">var</span> unsorted = Empty[<span class="library" title="binding of C++ string type">string</span>];
<span class="lineno" id=line180></span>            <span class="small_keyword" title="for loop">for</span> file <span class="small_keyword" title="membership operator, function mem">in</span> files <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line181></span>              <span class="small_keyword" title="match statement or expression">match</span> db.get file <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line182></span>              | Some dps =&gt;
<span class="lineno" id=line183></span>                <span class="small_keyword" title="conditional">if</span> dps <span class="tex_symbol" title="\subseteq">\(\subseteq\)</span> sorted_files <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line184></span>                  sorted_files = file + sorted_files;
<span class="lineno" id=line185></span>                <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line186></span>                  unsorted = file + unsorted;
<span class="lineno" id=line187></span>                <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line188></span>              | #None =&gt; <span class="big_keyword" title="Run time assertion">assert</span> <span class="library" title="false value">false</span>;
<span class="lineno" id=line189></span>              <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line190></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line191></span>            files = unsorted;
<span class="lineno" id=line192></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line193></span>          sorted_files = unbox (<span class="library" title="return data structure with elements reversed">rev</span> sorted_files);
<span class="lineno" id=line194></span>          <span class="comment">//println$ "Library build order: " + str sorted_files;</span>
<span class="lineno" id=line195></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line196></span>  
<span class="lineno" id=line197></span>        <span class="comment">// compile the files</span>
<span class="lineno" id=line198></span>        <span class="big_keyword" title="Define a mutable variable">var</span> include_flags = <span class="library" title="accumulated values of data structure from left into initial value using function">fold_left</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (acc:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) (a:<span class="library" title="binding of C++ string type">string</span>) =&gt; acc+<span class="fstring">"-I"</span>+entmp a) Empty[<span class="library" title="binding of C++ string type">string</span>] spec.libs;
<span class="lineno" id=line199></span>        <span class="small_keyword" title="for loop">for</span> file <span class="small_keyword" title="membership operator, function mem">in</span> sorted_files <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line200></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = tmpdir/(Filename::dirname file);
<span class="lineno" id=line201></span>          Directory::mkdirs path;
<span class="lineno" id=line202></span>          <span class="small_keyword" title="match statement or expression">match</span> Filename::get_extension file <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line203></span>          | <span class="fstring">".mli"</span> =&gt; 
<span class="lineno" id=line204></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Compiling MLI "</span> + file;
<span class="lineno" id=line205></span>            <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line206></span>              <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Shell::system$ <span class="library" title="functional, singly linked list">list</span>(
<span class="lineno" id=line207></span>                 <span class="fstring">"ocamlc.opt"</span>,
<span class="lineno" id=line208></span>                 <span class="fstring">"-I"</span>,tmpdir, 
<span class="lineno" id=line209></span>                 <span class="fstring">"-I"</span>,tmpdir/dir, 
<span class="lineno" id=line210></span>                 <span class="fstring">"-I"</span>, entmp (Filename::dirname file)) + 
<span class="lineno" id=line211></span>                 include_flags + <span class="comment">/* safe_string_flag + */</span>
<span class="lineno" id=line212></span>                 <span class="library" title="functional, singly linked list">list</span>(<span class="fstring">"-c"</span>, 
<span class="lineno" id=line213></span>                 <span class="fstring">'-o'</span>,entmp (Filename::strip_extension file) + <span class="fstring">".cmi"</span>,
<span class="lineno" id=line214></span>                 file)
<span class="lineno" id=line215></span>              ;
<span class="lineno" id=line216></span>              <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line217></span>                <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"MLI Compile Failed : "</span> + file;
<span class="lineno" id=line218></span>                System::exit 1;
<span class="lineno" id=line219></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line220></span>            <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line221></span>          | <span class="fstring">".ml"</span> =&gt; 
<span class="lineno" id=line222></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Compiling ML  "</span> + file;
<span class="lineno" id=line223></span>            <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line224></span>              <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Shell::system$ <span class="library" title="functional, singly linked list">list</span>(
<span class="lineno" id=line225></span>                 <span class="fstring">"ocamlopt.opt"</span>, <span class="fstring">"-g"</span>, <span class="comment">/* with exception tracing enabled */</span>
<span class="lineno" id=line226></span>                 <span class="fstring">"-w"</span>, <span class="fstring">"-26"</span>, <span class="comment">/* suppress unused variable warning */</span>
<span class="lineno" id=line227></span>                 <span class="fstring">"-w"</span>, <span class="fstring">"@8"</span>, <span class="comment">/* bug out partial matches */</span>
<span class="lineno" id=line228></span>                 <span class="fstring">"-w"</span>, <span class="fstring">"@11"</span>, <span class="comment">/* bug out unused cases */</span>
<span class="lineno" id=line229></span>                 <span class="fstring">"-w"</span>, <span class="fstring">"-21"</span>, <span class="comment">/* shut up about non-returning statments like assert false */</span>
<span class="lineno" id=line230></span>                 <span class="fstring">"-I"</span>, <span class="fstring">"+unix"</span>,
<span class="lineno" id=line231></span>                 <span class="fstring">"-I"</span>, <span class="fstring">"+str"</span>,
<span class="lineno" id=line232></span>                 <span class="fstring">"-I"</span>,tmpdir, 
<span class="lineno" id=line233></span>                 <span class="fstring">"-I"</span>,tmpdir/dir, 
<span class="lineno" id=line234></span>                 <span class="fstring">"-I"</span>, entmp (Filename::dirname file)) +
<span class="lineno" id=line235></span>                 include_flags + <span class="comment">/* safe_string_flag + */</span>
<span class="lineno" id=line236></span>                 <span class="library" title="functional, singly linked list">list</span>(<span class="fstring">"-c"</span>, 
<span class="lineno" id=line237></span>                 <span class="fstring">'-o'</span>,entmp (Filename::strip_extension file) + <span class="fstring">".cmx"</span>,
<span class="lineno" id=line238></span>                 file)
<span class="lineno" id=line239></span>              ;
<span class="lineno" id=line240></span>              <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line241></span>                <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"ML Compile Failed : "</span> + file;
<span class="lineno" id=line242></span>                System::exit 1;
<span class="lineno" id=line243></span>              <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line244></span>            <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line245></span>          | x =&gt; <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ignoring "</span> + file;
<span class="lineno" id=line246></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line247></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line248></span>  
<span class="lineno" id=line249></span>        <span class="small_keyword" title="match statement or expression">match</span> kind <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line250></span>        | #Library =&gt;
<span class="lineno" id=line251></span>          <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line252></span>            <span class="comment">// link files into library</span>
<span class="lineno" id=line253></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Linking library "</span> + tmpdir/lib + <span class="fstring">".cmxa"</span>;
<span class="lineno" id=line254></span>            sorted_libs = sorted_libs + (tmpdir/lib+ <span class="fstring">".cmxa"</span>);
<span class="lineno" id=line255></span>            <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Shell::system$ <span class="fstring">"ocamlopt.opt"</span> + <span class="library" title="functional, singly linked list">list</span>(
<span class="lineno" id=line256></span>              <span class="fstring">"-I"</span>,<span class="fstring">"+unix"</span>,<span class="fstring">"-I"</span>,<span class="fstring">"+str"</span>,
<span class="lineno" id=line257></span>              <span class="fstring">"-a"</span>, 
<span class="lineno" id=line258></span>              <span class="fstring">'-o'</span>,tmpdir/lib + <span class="fstring">".cmxa"</span>) +
<span class="lineno" id=line259></span>              unbox (<span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line260></span>                (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; entmp (Filename::strip_extension s) + <span class="fstring">".cmx"</span>) 
<span class="lineno" id=line261></span>                (filter (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>)=&gt; Filename::get_extension s == <span class="fstring">".ml"</span>) sorted_files)
<span class="lineno" id=line262></span>            );
<span class="lineno" id=line263></span>            <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> !=0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line264></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Linking cmxa library "</span> + tmpdir/lib+<span class="fstring">'.cmxa'</span> + <span class="fstring">" failed"</span>;
<span class="lineno" id=line265></span>              System::exit 1;
<span class="lineno" id=line266></span>            <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line267></span>          <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line268></span>        | #Executable =&gt;
<span class="lineno" id=line269></span>          <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line270></span>            <span class="comment">// link files into executable</span>
<span class="lineno" id=line271></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Linking executable "</span> + tmpdir/lib;
<span class="lineno" id=line272></span>            <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Shell::system$ <span class="fstring">"ocamlopt.opt"</span> + <span class="library" title="functional, singly linked list">list</span>(
<span class="lineno" id=line273></span>              <span class="fstring">'-I'</span>, <span class="fstring">'+unix'</span>, <span class="fstring">'-I'</span>, <span class="fstring">'+str'</span>,
<span class="lineno" id=line274></span>              <span class="fstring">'-o'</span>,tmpdir/lib ) + spec.external_libs + sorted_libs +
<span class="lineno" id=line275></span>              unbox (<span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line276></span>                (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; entmp (Filename::strip_extension s) + <span class="fstring">".cmx"</span>) 
<span class="lineno" id=line277></span>                (filter (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>)=&gt; Filename::get_extension s == <span class="fstring">".ml"</span>) sorted_files)
<span class="lineno" id=line278></span>              )
<span class="lineno" id=line279></span>            ;
<span class="lineno" id=line280></span>            <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> !=0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line281></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Linking executable "</span> + tmpdir/lib+ <span class="fstring">" failed"</span>;
<span class="lineno" id=line282></span>              System::exit 1;
<span class="lineno" id=line283></span>            <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line284></span>          <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line285></span>        <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line286></span>  
<span class="lineno" id=line287></span>        <span class="comment">// return the directory containing the library source.</span>
<span class="lineno" id=line288></span>        <span class="small_keyword" title="return">return</span> dir;
<span class="lineno" id=line289></span>      }
<span class="lineno" id=line290></span>  
<span class="lineno" id=line291></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocaml_build_lib (dir:<span class="library" title="binding of C++ string type">string</span>, lib:<span class="library" title="binding of C++ string type">string</span>, spec:libspec_t) =&gt;
<span class="lineno" id=line292></span>        ocaml_build(Library,dir,lib,spec)
<span class="lineno" id=line293></span>      ;
<span class="lineno" id=line294></span>  
<span class="lineno" id=line295></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocaml_build_exe (dir:<span class="library" title="binding of C++ string type">string</span>, lib:<span class="library" title="binding of C++ string type">string</span>, spec:libspec_t) =&gt;
<span class="lineno" id=line296></span>        ocaml_build(Executable,dir,lib,spec)
<span class="lineno" id=line297></span>      ;
<span class="lineno" id=line298></span>  
<span class="lineno" id=line299></span>  
<span class="lineno" id=line300></span>      <span class="comment">// src, including .mll suffix, dst: including .ml suffix</span>
<span class="lineno" id=line301></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocamllex (file:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line302></span>      {
<span class="lineno" id=line303></span>        <span class="big_keyword" title="Define a mutable variable">var</span> out = entmp (file.Filename::basename.Filename::strip_extension + <span class="fstring">".ml"</span>);
<span class="lineno" id=line304></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Shell::system$ <span class="library" title="functional, singly linked list">list</span>$ <span class="fstring">'ocamllex.opt'</span>,<span class="fstring">'-o'</span>,out,file;
<span class="lineno" id=line305></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line306></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ocamllex failed to process "</span> + file;
<span class="lineno" id=line307></span>          System::exit (1);
<span class="lineno" id=line308></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line309></span>        <span class="small_keyword" title="return">return</span> out;
<span class="lineno" id=line310></span>      }
<span class="lineno" id=line311></span>  
<span class="lineno" id=line312></span>      <span class="comment">// src, including .mly suffix, dst: excluding suffices</span>
<span class="lineno" id=line313></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> ocamlyacc(file:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line314></span>      {
<span class="lineno" id=line315></span>        <span class="big_keyword" title="Define a mutable variable">var</span> out = entmp (file.Filename::basename.Filename::strip_extension);
<span class="lineno" id=line316></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Shell::system(<span class="fstring">'ocamlyacc.opt'</span>,<span class="fstring">'-b'</span>+out,file);
<span class="lineno" id=line317></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line318></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ocamlyacc failed to process "</span> + file;
<span class="lineno" id=line319></span>          System::exit (1);
<span class="lineno" id=line320></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line321></span>        <span class="small_keyword" title="return">return</span> out;
<span class="lineno" id=line322></span>      }
<span class="lineno" id=line323></span>  
<span class="lineno" id=line324></span>      <span class="comment">// executable: the dypgen executable name</span>
<span class="lineno" id=line325></span>      <span class="comment">// src: including .dyp suffix</span>
<span class="lineno" id=line326></span>      <span class="comment">// tmpdir: directory for target .ml, .mli files</span>
<span class="lineno" id=line327></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> dypgen(file:<span class="library" title="binding of C++ string type">string</span>) : <span class="library" title="binding of C++ string type">string</span> =
<span class="lineno" id=line328></span>      {
<span class="lineno" id=line329></span>        <span class="big_keyword" title="Define a mutable variable">var</span> flags = <span class="library" title="functional, singly linked list">list</span>$ <span class="fstring">"--no-mli"</span>, <span class="fstring">"--no-undef-nt"</span>, <span class="fstring">"--pv-obj"</span>, <span class="fstring">"--noemit-token-type"</span>;
<span class="lineno" id=line330></span>        <span class="big_keyword" title="Define a mutable variable">var</span> executable = tmpdir / <span class="fstring">'dypgen.exe'</span>;
<span class="lineno" id=line331></span>  
<span class="lineno" id=line332></span>        <span class="comment">// Dypgen doesn't allow an output spec</span>
<span class="lineno" id=line333></span>        <span class="comment">// so we process a copy of the file.</span>
<span class="lineno" id=line334></span>        <span class="big_keyword" title="Define a mutable variable">var</span> dyp = entmp (file.Filename::basename);
<span class="lineno" id=line335></span>        <span class="hack">C_hack</span>::ignore$ FileSystem::filecopy (file, dyp);
<span class="lineno" id=line336></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Shell::system(executable + flags +  dyp);
<span class="lineno" id=line337></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line338></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"dypgen failed to process "</span> +file;
<span class="lineno" id=line339></span>          System::exit (1);
<span class="lineno" id=line340></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line341></span>        <span class="small_keyword" title="return">return</span> dyp.Filename::strip_extension+<span class="fstring">".ml"</span>;
<span class="lineno" id=line342></span>      }
<span class="lineno" id=line343></span>  
<span class="lineno" id=line344></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_dypgen() = 
<span class="lineno" id=line345></span>      {
<span class="lineno" id=line346></span>        <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'dypgen'</span>/<span class="fstring">'dypgen'</span>;
<span class="lineno" id=line347></span>        <span class="big_keyword" title="Define a mutable variable">var</span> exe = ocaml_build_exe (path,<span class="fstring">'dypgen.exe'</span>,
<span class="lineno" id=line348></span>           <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls_nodyp path,
<span class="lineno" id=line349></span>              libs = <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] (build_dyplib())
<span class="lineno" id=line350></span>              ) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line351></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Done, exe = "</span> + exe;
<span class="lineno" id=line352></span>        <span class="small_keyword" title="return">return</span> exe;
<span class="lineno" id=line353></span>      }
<span class="lineno" id=line354></span>      <span class="comment">//----------------------------------------------------------------------------------</span>
<span class="lineno" id=line355></span>  
<span class="lineno" id=line356></span>      <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (a:<span class="library" title="binding of C++ string type">string</span>, b:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join (a,b);
<span class="lineno" id=line357></span>  
<span class="lineno" id=line358></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> mls (d:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line359></span>        <span class="big_keyword" title="Define a mutable variable">var</span> files = FileSystem::regfilesin (d, RE2 <span class="fstring">'.*\\.(mli?|dyp|mll|mly)'</span>);
<span class="lineno" id=line360></span>        <span class="small_keyword" title="return">return</span> unbox (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) = { <span class="small_keyword" title="return">return</span> d/f;}) files);
<span class="lineno" id=line361></span>      }
<span class="lineno" id=line362></span>  
<span class="lineno" id=line363></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> mls_nodyp (d:<span class="library" title="binding of C++ string type">string</span>) = {
<span class="lineno" id=line364></span>        <span class="big_keyword" title="Define a mutable variable">var</span> files = FileSystem::regfilesin (d, RE2 <span class="fstring">'.*\\.(mli?|mll|mly)'</span>);
<span class="lineno" id=line365></span>        <span class="small_keyword" title="return">return</span> unbox (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (f:<span class="library" title="binding of C++ string type">string</span>) = { <span class="small_keyword" title="return">return</span> d/f;}) files);
<span class="lineno" id=line366></span>      }
<span class="lineno" id=line367></span>  
<span class="lineno" id=line368></span>  
<span class="lineno" id=line369></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_ocs() =
<span class="lineno" id=line370></span>      {
<span class="lineno" id=line371></span>        <span class="big_keyword" title="Define a mutable variable">var</span> path = (<span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'ocs'</span>/<span class="fstring">'src'</span>);
<span class="lineno" id=line372></span>        <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line373></span>        db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line374></span>        <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'ocs'</span>,
<span class="lineno" id=line375></span>            <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line376></span>      }
<span class="lineno" id=line377></span>  
<span class="lineno" id=line378></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_sex() =
<span class="lineno" id=line379></span>      {
<span class="lineno" id=line380></span>        <span class="big_keyword" title="Define a mutable variable">var</span> path = (<span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'sex'</span>);
<span class="lineno" id=line381></span>        <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line382></span>        db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line383></span>        <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'sex'</span>,
<span class="lineno" id=line384></span>            <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line385></span>            libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] (build_dyplib(), build_ocs())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line386></span>      }
<span class="lineno" id=line387></span>  
<span class="lineno" id=line388></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_dyplib() =
<span class="lineno" id=line389></span>      {
<span class="lineno" id=line390></span>        <span class="big_keyword" title="Define a mutable variable">var</span> path = (<span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'dypgen'</span>/<span class="fstring">'dyplib'</span>);
<span class="lineno" id=line391></span>        <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line392></span>        db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line393></span>  
<span class="lineno" id=line394></span>        <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'dyp'</span>,
<span class="lineno" id=line395></span>            <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line396></span>      }
<span class="lineno" id=line397></span>  
<span class="lineno" id=line398></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_version() = {
<span class="lineno" id=line399></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = (<span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_version'</span>);
<span class="lineno" id=line400></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line401></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line402></span>  
<span class="lineno" id=line403></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_version'</span>,
<span class="lineno" id=line404></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line405></span>      }
<span class="lineno" id=line406></span>  
<span class="lineno" id=line407></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_misc() = {
<span class="lineno" id=line408></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_misc'</span>;
<span class="lineno" id=line409></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line410></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line411></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_misc'</span>,
<span class="lineno" id=line412></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line413></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] (build_flx_version()),
<span class="lineno" id=line414></span>              external_libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](<span class="fstring">'str'</span>, <span class="fstring">'unix'</span>)) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line415></span>      }
<span class="lineno" id=line416></span>  
<span class="lineno" id=line417></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_version_hook() = {
<span class="lineno" id=line418></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = tmpdir/<span class="fstring">'flx_version_hook'</span>;
<span class="lineno" id=line419></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line420></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line421></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_version_hook'</span>,
<span class="lineno" id=line422></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line423></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](build_flx_version())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line424></span>      }
<span class="lineno" id=line425></span>  
<span class="lineno" id=line426></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_lex() = {
<span class="lineno" id=line427></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_lex'</span>;
<span class="lineno" id=line428></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line429></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line430></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path,<span class="fstring">'flx_lex'</span>,
<span class="lineno" id=line431></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line432></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line433></span>                  build_dyplib(),
<span class="lineno" id=line434></span>                  build_ocs(),
<span class="lineno" id=line435></span>                  build_sex(),
<span class="lineno" id=line436></span>                  build_flx_version())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line437></span>      }
<span class="lineno" id=line438></span>  
<span class="lineno" id=line439></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_parse() = {
<span class="lineno" id=line440></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_parse'</span>;
<span class="lineno" id=line441></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line442></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line443></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path,<span class="fstring">'flx_parse'</span>,
<span class="lineno" id=line444></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line445></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line446></span>                  build_dyplib(),
<span class="lineno" id=line447></span>                  build_ocs(),
<span class="lineno" id=line448></span>                  build_sex(),
<span class="lineno" id=line449></span>                  build_flx_version(),
<span class="lineno" id=line450></span>                  build_flx_lex())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line451></span>      }
<span class="lineno" id=line452></span>  
<span class="lineno" id=line453></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_file() = {
<span class="lineno" id=line454></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_file'</span>;
<span class="lineno" id=line455></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line456></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line457></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path,<span class="fstring">'flx_file'</span>,
<span class="lineno" id=line458></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line459></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line460></span>                  build_dyplib(),
<span class="lineno" id=line461></span>                  build_ocs(),
<span class="lineno" id=line462></span>                  build_sex(),
<span class="lineno" id=line463></span>                  build_flx_version(),
<span class="lineno" id=line464></span>                  build_flx_misc(),
<span class="lineno" id=line465></span>                  build_flx_lex(),
<span class="lineno" id=line466></span>                  build_flx_parse()
<span class="lineno" id=line467></span>                  )) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line468></span>      }
<span class="lineno" id=line469></span>  
<span class="lineno" id=line470></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_core() = {
<span class="lineno" id=line471></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_core'</span>;
<span class="lineno" id=line472></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line473></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line474></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_core'</span>,
<span class="lineno" id=line475></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line476></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line477></span>                  build_dyplib(),
<span class="lineno" id=line478></span>                  build_ocs(),
<span class="lineno" id=line479></span>                  build_flx_lex(),
<span class="lineno" id=line480></span>                  build_flx_parse(),
<span class="lineno" id=line481></span>                  build_flx_misc()
<span class="lineno" id=line482></span>                  ),
<span class="lineno" id=line483></span>              external_libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]()) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line484></span>      }
<span class="lineno" id=line485></span>  
<span class="lineno" id=line486></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_desugar() = {
<span class="lineno" id=line487></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_desugar'</span>;
<span class="lineno" id=line488></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line489></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line490></span>  
<span class="lineno" id=line491></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_desugar'</span>,
<span class="lineno" id=line492></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line493></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line494></span>                  build_dyplib(),
<span class="lineno" id=line495></span>                  build_ocs(),
<span class="lineno" id=line496></span>                  build_sex(),
<span class="lineno" id=line497></span>                  build_flx_lex(),
<span class="lineno" id=line498></span>                  build_flx_parse(),
<span class="lineno" id=line499></span>                  build_flx_file(),
<span class="lineno" id=line500></span>                  build_flx_misc(),
<span class="lineno" id=line501></span>                  build_flx_core(),
<span class="lineno" id=line502></span>                  build_flx_version()
<span class="lineno" id=line503></span>                  ),
<span class="lineno" id=line504></span>              external_libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](<span class="fstring">'unix'</span>)) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line505></span>      }
<span class="lineno" id=line506></span>  
<span class="lineno" id=line507></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_bind() = {
<span class="lineno" id=line508></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_bind'</span>;
<span class="lineno" id=line509></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line510></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line511></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_bind'</span>,
<span class="lineno" id=line512></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line513></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line514></span>                  build_flx_lex(),
<span class="lineno" id=line515></span>                  build_flx_misc(),
<span class="lineno" id=line516></span>                  build_flx_core(),
<span class="lineno" id=line517></span>                  build_flx_desugar()),
<span class="lineno" id=line518></span>              external_libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]()) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line519></span>      }
<span class="lineno" id=line520></span>  
<span class="lineno" id=line521></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_frontend() = {
<span class="lineno" id=line522></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_frontend'</span>;
<span class="lineno" id=line523></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line524></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line525></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_frontend'</span>,
<span class="lineno" id=line526></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line527></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line528></span>                  build_flx_lex(),
<span class="lineno" id=line529></span>                  build_flx_misc(),
<span class="lineno" id=line530></span>                  build_flx_core())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line531></span>      }
<span class="lineno" id=line532></span>  
<span class="lineno" id=line533></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_opt() = {
<span class="lineno" id=line534></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_opt'</span>;
<span class="lineno" id=line535></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line536></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line537></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_opt'</span>,
<span class="lineno" id=line538></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line539></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line540></span>                  build_flx_lex(),
<span class="lineno" id=line541></span>                  build_flx_misc(),
<span class="lineno" id=line542></span>                  build_flx_core(),
<span class="lineno" id=line543></span>                  build_flx_frontend())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line544></span>      }
<span class="lineno" id=line545></span>  
<span class="lineno" id=line546></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_lower() = {
<span class="lineno" id=line547></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_lower'</span>;
<span class="lineno" id=line548></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line549></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line550></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_lower'</span>,
<span class="lineno" id=line551></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line552></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line553></span>                  build_flx_lex(),
<span class="lineno" id=line554></span>                  build_flx_misc(),
<span class="lineno" id=line555></span>                  build_flx_core(),
<span class="lineno" id=line556></span>                  build_flx_frontend())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line557></span>      }
<span class="lineno" id=line558></span>  
<span class="lineno" id=line559></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_backend() = {
<span class="lineno" id=line560></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_backend'</span>;
<span class="lineno" id=line561></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line562></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line563></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_backend'</span>,
<span class="lineno" id=line564></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line565></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line566></span>                  build_flx_lex(),
<span class="lineno" id=line567></span>                  build_flx_misc(),
<span class="lineno" id=line568></span>                  build_flx_core())) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line569></span>      }
<span class="lineno" id=line570></span>  
<span class="lineno" id=line571></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> build_flx_cpp_backend() = {
<span class="lineno" id=line572></span>          <span class="big_keyword" title="Define a mutable variable">var</span> path = <span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flx_cpp_backend'</span>;
<span class="lineno" id=line573></span>          <span class="small_keyword" title="conditional">if</span> db.haskey path <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="return">return</span> path; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line574></span>          db.add path <span class="library" title="truth value">true</span>;
<span class="lineno" id=line575></span>          <span class="small_keyword" title="return">return</span> ocaml_build_lib(path, <span class="fstring">'flx_cpp_backend'</span>,
<span class="lineno" id=line576></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line577></span>              libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>](
<span class="lineno" id=line578></span>                  build_flx_lex(),
<span class="lineno" id=line579></span>                  build_flx_misc(),
<span class="lineno" id=line580></span>                  build_flx_core(),
<span class="lineno" id=line581></span>                  build_flx_frontend(),
<span class="lineno" id=line582></span>                  build_flx_backend()),
<span class="lineno" id=line583></span>              external_libs=<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]()) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line584></span>      }
<span class="lineno" id=line585></span>  
<span class="lineno" id=line586></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Build dypgen"</span>;
<span class="lineno" id=line587></span>      <span class="hack">C_hack</span>::ignore$ build_dypgen();
<span class="lineno" id=line588></span>      <span class="big_keyword" title="Define a mutable variable">var</span> libs = <span class="library" title="functional, singly linked list">list</span> ( 
<span class="lineno" id=line589></span>            build_ocs(),
<span class="lineno" id=line590></span>            build_sex(),
<span class="lineno" id=line591></span>            build_dyplib(),
<span class="lineno" id=line592></span>            build_flx_version(),
<span class="lineno" id=line593></span>            build_flx_lex(),
<span class="lineno" id=line594></span>            build_flx_parse(),
<span class="lineno" id=line595></span>            build_flx_misc(),
<span class="lineno" id=line596></span>            build_flx_file(),
<span class="lineno" id=line597></span>            build_flx_core(),
<span class="lineno" id=line598></span>            build_flx_desugar(),
<span class="lineno" id=line599></span>            build_flx_bind(),
<span class="lineno" id=line600></span>            build_flx_frontend(),
<span class="lineno" id=line601></span>            build_flx_opt(),
<span class="lineno" id=line602></span>            build_flx_lower(),
<span class="lineno" id=line603></span>            build_flx_backend(),
<span class="lineno" id=line604></span>            build_flx_cpp_backend(),
<span class="lineno" id=line605></span>            build_flx_version_hook()
<span class="lineno" id=line606></span>      );
<span class="lineno" id=line607></span>  
<span class="lineno" id=line608></span>      <span class="big_keyword" title="Define a mutable variable">var</span> external_libs = <span class="library" title="functional, singly linked list">list</span>(<span class="fstring">'unix.cmxa'</span>, <span class="fstring">'str.cmxa'</span>);
<span class="lineno" id=line609></span>  
<span class="lineno" id=line610></span>      <span class="hack">C_hack</span>::ignore$ libs;
<span class="lineno" id=line611></span>      <span class="big_keyword" title="Define a mutable variable">var</span> path =<span class="fstring">'src'</span>/<span class="fstring">'compiler'</span>/<span class="fstring">'flxg'</span>;
<span class="lineno" id=line612></span>      <span class="big_keyword" title="Define a mutable variable">var</span> exe = ocaml_build_exe (path,<span class="fstring">'flxg'</span>,
<span class="lineno" id=line613></span>              <span class="small_keyword" title="define an object interface">extend</span> #libdflt <span class="small_keyword" title="type-class constraint">with</span> (srcs=mls path,
<span class="lineno" id=line614></span>              libs = libs,
<span class="lineno" id=line615></span>              external_libs=external_libs) <span class="small_keyword" title="end of extension">end</span>);
<span class="lineno" id=line616></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Done, exe = "</span> + exe;
<span class="lineno" id=line617></span>    } <span class="comment">// end build_drivers</span>
<span class="lineno" id=line618></span>  } <span class="comment">// end class</span>
<span class="lineno" id=line619></span>  
<span class="lineno" id=line620></span>  
<span class="lineno" id=line621></span>  BuildFlxg::build_flx_drivers();
<span class="lineno" id=line622></span>  
</pre></p></div><h2 id='Preparation_for_building._h'><img src='/share/src/web/images/minus.gif' id='Preparation for building.' onclick='toggle(this,"Preparation_for_building._d")' alt='+'/> 1.2 Preparation for building.</h2><div id='Preparation_for_building._d' style='display:block'>
<p>This tools copies things out of the repository and sets up
the build target directory.
</p><pre class='inclusion'>
$PWD/src/tools/flx_build_prep.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_cp"</span>;
<span class="lineno" id=line2></span>  
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Define a type class">class</span> FlxPrepBuild
<span class="lineno" id=line4></span>  {
<span class="lineno" id=line5></span>  
<span class="lineno" id=line6></span>    <span class="big_keyword" title="Define an immutable value">val</span> VERSION =  <span class="fstring">"2020.09.10A"</span>;
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (x:<span class="library" title="binding of C++ string type">string</span>,y:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join(x,y);
<span class="lineno" id=line9></span>  
<span class="lineno" id=line10></span>    <span class="big_keyword" title="Define a mutable variable">var</span> dirsetup_done = <span class="library" title="false value">false</span>;
<span class="lineno" id=line11></span>  
<span class="lineno" id=line12></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> dirsetup(cmd:cmd_type)
<span class="lineno" id=line13></span>    {
<span class="lineno" id=line14></span>      <span class="comment">// NOTE: unlink doesn't work on directories anyhow ...</span>
<span class="lineno" id=line15></span>      <span class="comment">// We need rmdir(), but that doesn't work unless dir is empty!</span>
<span class="lineno" id=line16></span>      <span class="comment">//FileSystem::unlink("trial-tmp");</span>
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>      <span class="small_keyword" title="conditional">if</span> cmd.clean_target_dir <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line19></span>         <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Deleting target-dir="</span> + cmd.target_dir;
<span class="lineno" id=line20></span>         FileSystem::unlink(cmd.target_dir);
<span class="lineno" id=line21></span>      <span class="small_keyword" title="conditional">elif</span> cmd.clean_target_bin_dir <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line22></span>         <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Deleting target-bin="</span> + cmd.target_dir/cmd.target_bin;
<span class="lineno" id=line23></span>         FileSystem::unlink(cmd.target_dir/cmd.target_bin);
<span class="lineno" id=line24></span>      <span class="small_keyword" title="conditional">elif</span> cmd.clean_target_bin_binaries <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line25></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Cleaning binaries out of target not implemented"</span>;
<span class="lineno" id=line26></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line27></span>  
<span class="lineno" id=line28></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> dirsetup_done <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line29></span>        <span class="hack">C_hack</span>::ignore$ Directory::mkdir(cmd.target_dir);
<span class="lineno" id=line30></span>        <span class="hack">C_hack</span>::ignore$ Directory::mkdir(cmd.target_dir/cmd.target_bin);
<span class="lineno" id=line31></span>        <span class="hack">C_hack</span>::ignore$ Directory::mkdir(cmd.target_dir/cmd.target_bin/<span class="fstring">'bin'</span>);
<span class="lineno" id=line32></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line33></span>      dirsetup_done = <span class="library" title="truth value">true</span>;
<span class="lineno" id=line34></span>  
<span class="lineno" id=line35></span>      <span class="comment">// Set up the share subdirectory.</span>
<span class="lineno" id=line36></span>      <span class="small_keyword" title="conditional">if</span> cmd.copy_repo <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line37></span>        <span class="small_keyword" title="conditional">if</span> cmd.repo != cmd.target_dir/<span class="fstring">'share'</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line38></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Copy repository "</span>+cmd.repo/<span class="fstring">'src -&gt; '</span> + cmd.target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>;
<span class="lineno" id=line39></span>          CopyFiles::copyfiles(cmd.repo/<span class="fstring">'src'</span>, 
<span class="lineno" id=line40></span>           <span class="fstring">'(.*\.(h|hpp|ml|mli|c|cpp|cxx|cc|flx|flxh|html|fsyn|js|html|css|svg|png|gif|jpg|files|include|ttf))'</span>, 
<span class="lineno" id=line41></span>           cmd.target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/<span class="fstring">'${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line42></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line43></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Cannot copy repo because source = target"</span>;
<span class="lineno" id=line44></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line45></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line46></span>  
<span class="lineno" id=line47></span>      <span class="small_keyword" title="conditional">if</span> cmd.copy_library <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line48></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Copy Felix library"</span>;
<span class="lineno" id=line49></span>        CopyFiles::copyfiles (cmd.target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/<span class="fstring">'lib'</span>, r<span class="fstring">"(.*\.(flx|flxh|fsyn|html|files))"</span>, 
<span class="lineno" id=line50></span>          cmd.target_dir/<span class="fstring">'share'</span>/<span class="fstring">'lib/${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line51></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>      <span class="comment">// This is SPECIAL because "version.flx" is the only file which is both</span>
<span class="lineno" id=line54></span>      <span class="comment">// shared-readonly and generated. So it has to be copied out of an</span>
<span class="lineno" id=line55></span>      <span class="comment">// existing built library not the repository dir.</span>
<span class="lineno" id=line56></span>      <span class="comment">// TODO: generate it using, say, flx or flxg.</span>
<span class="lineno" id=line57></span>      <span class="small_keyword" title="conditional">if</span> cmd.copy_version <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line58></span>        <span class="small_keyword" title="conditional">if</span> cmd.source_dir != cmd.target_dir <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line59></span>          CopyFiles::copyfiles (cmd.source_dir/<span class="fstring">'share'</span>/<span class="fstring">'lib'</span>/<span class="fstring">'std'</span>, <span class="fstring">'(version.flx)'</span>, 
<span class="lineno" id=line60></span>            cmd.target_dir/<span class="fstring">'share'</span>/<span class="fstring">'lib'</span>/<span class="fstring">'std/${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line61></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line62></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Cannot copy version because source = target"</span>;
<span class="lineno" id=line63></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line64></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line65></span>  
<span class="lineno" id=line66></span>      <span class="small_keyword" title="conditional">if</span> cmd.copy_pkg_db <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line67></span>        <span class="small_keyword" title="conditional">if</span> cmd.source_dir/cmd.source_bin != cmd.target_dir/cmd.target_bin <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line68></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Copy config db"</span>;
<span class="lineno" id=line69></span>          CopyFiles::copyfiles(cmd.source_dir/cmd.source_bin/<span class="fstring">'config'</span>, <span class="fstring">'(.*)'</span>,
<span class="lineno" id=line70></span>            cmd.target_dir/cmd.target_bin/<span class="fstring">'config'</span>/<span class="fstring">'${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line71></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line72></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Cannot copy config db because source = target"</span>;
<span class="lineno" id=line73></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line74></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line75></span>  
<span class="lineno" id=line76></span>      <span class="small_keyword" title="conditional">if</span> cmd.copy_config_headers <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line77></span>        <span class="small_keyword" title="conditional">if</span> cmd.source_dir/cmd.source_bin != cmd.target_dir/cmd.target_bin <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line78></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Copy rtl config headers"</span>;
<span class="lineno" id=line79></span>          CopyFiles::copyfiles(cmd.source_dir/cmd.source_bin/<span class="fstring">'lib'</span>, r<span class="fstring">"(.*\.(h|hpp|flx|flxh))"</span>, 
<span class="lineno" id=line80></span>            cmd.target_dir/cmd.target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line81></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line82></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Cannot copy rtl config headers because source = target"</span>;
<span class="lineno" id=line83></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line84></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line85></span>  
<span class="lineno" id=line86></span>      <span class="comment">// configure and db copy are exclusive</span>
<span class="lineno" id=line87></span>      <span class="small_keyword" title="conditional">if</span> cmd.configure <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line88></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'Generating Configuration'</span>;
<span class="lineno" id=line89></span>        <span class="small_keyword" title="conditional">if</span> cmd.compiler <span class="small_keyword" title="logical negation">not</span> <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">'gcc'</span>, <span class="fstring">'clang'</span>, <span class="fstring">'msvc'</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line90></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'ERROR: Configuration compiler must be gcc,clang or msvc'</span>;
<span class="lineno" id=line91></span>          System::exit 1;
<span class="lineno" id=line92></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line93></span>        <span class="small_keyword" title="conditional">if</span> cmd.os <span class="small_keyword" title="logical negation">not</span> <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">'linux'</span>, <span class="fstring">'macosx'</span>, <span class="fstring">'win'</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line94></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'ERROR: Configuration os must be linux,macosx or win'</span>;
<span class="lineno" id=line95></span>          System::exit 1;
<span class="lineno" id=line96></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line97></span>        <span class="small_keyword" title="conditional">if</span> cmd.bits <span class="small_keyword" title="logical negation">not</span> <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">'32'</span>, <span class="fstring">'64'</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line98></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'ERROR: Configuration bits musty be 32 or 64'</span>;
<span class="lineno" id=line99></span>          System::exit 1;
<span class="lineno" id=line100></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line101></span>        <span class="small_keyword" title="conditional">if</span> cmd.os == <span class="fstring">'win'</span> <span class="small_keyword" title="logical conjunction">and</span> cmd.bits == <span class="fstring">'32'</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line102></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'ERROR: Only 64 bit windows is supported'</span>;
<span class="lineno" id=line103></span>          System::exit 1;
<span class="lineno" id=line104></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line105></span>  
<span class="lineno" id=line106></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'Copying platform macro ..'</span>;
<span class="lineno" id=line107></span>        <span class="comment">// Felix platform macro</span>
<span class="lineno" id=line108></span>        <span class="big_keyword" title="Define a mutable variable">var</span> fmacs = ([cmd.os+<span class="fstring">'/([^/]*\\.flxh)'</span>]);
<span class="lineno" id=line109></span>        <span class="small_keyword" title="for loop">for</span> pattern <span class="small_keyword" title="membership operator, function mem">in</span> fmacs perform
<span class="lineno" id=line110></span>          CopyFiles::copyfiles(cmd.repo/<span class="fstring">'src'</span>/<span class="fstring">'config'</span>, pattern,
<span class="lineno" id=line111></span>            cmd.target_dir/cmd.target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'plat'</span>/<span class="fstring">'${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line112></span>  
<span class="lineno" id=line113></span>        <span class="comment">// setup header files to copy</span>
<span class="lineno" id=line114></span>        <span class="comment">// os/bits/compiler config</span>
<span class="lineno" id=line115></span>        <span class="big_keyword" title="Define a mutable variable">var</span> headers = ([(cmd.os+cmd.bits)/cmd.compiler/<span class="fstring">'rtl'</span>/<span class="fstring">'([^/]*\\.hpp)'</span>]);
<span class="lineno" id=line116></span>        <span class="comment">// socket config </span>
<span class="lineno" id=line117></span>        headers += (cmd.os+cmd.bits)/<span class="fstring">'rtl'</span>/<span class="fstring">'([^/]*\\.hpp)'</span>;
<span class="lineno" id=line118></span>  
<span class="lineno" id=line119></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'Copying C++ headers ..'</span>;
<span class="lineno" id=line120></span>        <span class="small_keyword" title="for loop">for</span> pattern <span class="small_keyword" title="membership operator, function mem">in</span> headers perform
<span class="lineno" id=line121></span>          CopyFiles::copyfiles(cmd.repo/<span class="fstring">'src'</span>/<span class="fstring">'config'</span>, pattern,
<span class="lineno" id=line122></span>            cmd.target_dir/cmd.target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/<span class="fstring">'${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line123></span>  
<span class="lineno" id=line124></span>        <span class="small_keyword" title="conditional">if</span> cmd.c_compiler != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line125></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'Specifying C compiler executable '</span> + cmd.c_compiler;
<span class="lineno" id=line126></span>          <span class="big_keyword" title="Define a mutable variable">var</span> fn = cmd.target_dir/cmd.target_bin/<span class="fstring">'config'</span>/<span class="fstring">"toolchain_"</span>+cmd.compiler+<span class="fstring">"_"</span>+cmd.os+<span class="fstring">"_c_compiler_executable.fpc"</span>;
<span class="lineno" id=line127></span>          <span class="big_keyword" title="Define a mutable variable">var</span> txt = ([<span class="fstring">"compiler: "</span> + cmd.c_compiler]);
<span class="lineno" id=line128></span>          save (fn,txt);
<span class="lineno" id=line129></span>        <span class="small_keyword" title="end of extension">end</span> <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line130></span>  
<span class="lineno" id=line131></span>        <span class="small_keyword" title="conditional">if</span> cmd.cxx_compiler != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line132></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'Specifying C++ compiler executable '</span> + cmd.cxx_compiler;
<span class="lineno" id=line133></span>          <span class="big_keyword" title="Define a mutable variable">var</span> fnam = cmd.target_dir/cmd.target_bin/<span class="fstring">'config'</span>/<span class="fstring">"toolchain_"</span>+cmd.compiler+<span class="fstring">"_"</span>+cmd.os+<span class="fstring">"_cxx_compiler_executable.fpc"</span>;
<span class="lineno" id=line134></span>          <span class="big_keyword" title="Define a mutable variable">var</span> txt = ([<span class="fstring">"compiler: "</span> + cmd.cxx_compiler]);
<span class="lineno" id=line135></span>          save (fnam,txt);
<span class="lineno" id=line136></span>        <span class="small_keyword" title="end of extension">end</span> <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line137></span>  
<span class="lineno" id=line138></span>        <span class="comment">// setup fpc's to copy: ORDER MATTERS!</span>
<span class="lineno" id=line139></span>        <span class="big_keyword" title="Define a mutable variable">var</span> fpcs = ([ <span class="fstring">'([^/]*\\.fpc)'</span>]);
<span class="lineno" id=line140></span>        <span class="small_keyword" title="conditional">if</span> cmd.os <span class="small_keyword" title="membership operator, function mem">in</span> (<span class="fstring">'linux'</span>,<span class="fstring">'macosx'</span>) <span class="small_keyword" title="imperative code begins">do</span>  
<span class="lineno" id=line141></span>          fpcs +=  <span class="fstring">'unix'</span>/<span class="fstring">'([^/]*\\.fpc)'</span>;
<span class="lineno" id=line142></span>          fpcs +=  (<span class="fstring">'unix'</span>+cmd.bits)/<span class="fstring">'([^/]*\\.fpc)'</span>;
<span class="lineno" id=line143></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line144></span>        fpcs += cmd.os/<span class="fstring">'([^/]*\\.fpc)'</span>;
<span class="lineno" id=line145></span>        fpcs += (cmd.os+cmd.bits)/<span class="fstring">'([^/]*\\.fpc)'</span>;
<span class="lineno" id=line146></span>        fpcs += cmd.os/<span class="fstring">'([^/]*\\.fpc)'</span>;
<span class="lineno" id=line147></span>  
<span class="lineno" id=line148></span>        <span class="comment">// do the copying</span>
<span class="lineno" id=line149></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'Copying STANDARD fpcs ..'</span>;
<span class="lineno" id=line150></span>        <span class="small_keyword" title="for loop">for</span> pattern <span class="small_keyword" title="membership operator, function mem">in</span> fpcs perform
<span class="lineno" id=line151></span>          CopyFiles::copyfiles(cmd.repo/<span class="fstring">'src'</span>/<span class="fstring">'config'</span>, pattern,
<span class="lineno" id=line152></span>            cmd.target_dir/cmd.target_bin/<span class="fstring">'config'</span>/<span class="fstring">'${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line153></span>  
<span class="lineno" id=line154></span>        <span class="big_keyword" title="Define a mutable variable">var</span> HOME = Env::getenv <span class="fstring">"HOME"</span>;
<span class="lineno" id=line155></span>        <span class="small_keyword" title="conditional">if</span> HOME == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line156></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Skipping CUSTOM fpcs, no HOME environment variable set"</span>;
<span class="lineno" id=line157></span>        <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line158></span>          <span class="big_keyword" title="Define a mutable variable">var</span> dirspec = HOME/<span class="fstring">".felix"</span>/<span class="fstring">'config'</span>/cmd.target_bin/<span class="fstring">'config'</span>;
<span class="lineno" id=line159></span>          Directory::mkdirs$ dirspec;
<span class="lineno" id=line160></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'Copying CUSTOM fpcs ..'</span>;
<span class="lineno" id=line161></span>          <span class="big_keyword" title="Define a mutable variable">var</span> pattern = <span class="fstring">'([^/]*\\.fpc)'</span>;
<span class="lineno" id=line162></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  Checking "</span> + dirspec;
<span class="lineno" id=line163></span>          CopyFiles::copyfiles(dirspec, pattern,
<span class="lineno" id=line164></span>           cmd.target_dir/cmd.target_bin/<span class="fstring">'config'</span>/<span class="fstring">'${1}'</span>,<span class="library" title="truth value">true</span>,cmd.debug);
<span class="lineno" id=line165></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line166></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line167></span>  
<span class="lineno" id=line168></span>      <span class="small_keyword" title="conditional">if</span> cmd.setup_pkg != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line169></span>        <span class="big_keyword" title="Define a mutable variable">var</span> setupdata = load cmd.setup_pkg;
<span class="lineno" id=line170></span>        <span class="big_keyword" title="Define a mutable variable">var</span> commands = split(setupdata,<span class="fstring">"\n"</span>);
<span class="lineno" id=line171></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lineno = 0;
<span class="lineno" id=line172></span>        <span class="small_keyword" title="for loop">for</span> command <span class="small_keyword" title="membership operator, function mem">in</span> commands <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line173></span>          <span class="comment">//println$ "Command=" + command;</span>
<span class="lineno" id=line174></span>          ++lineno;
<span class="lineno" id=line175></span>          <span class="big_keyword" title="Define a mutable variable">var</span> hsrc, hdst = <span class="fstring">""</span>,<span class="fstring">""</span>;
<span class="lineno" id=line176></span>          <span class="small_keyword" title="match statement or expression">match</span> split (command, <span class="fstring">"&gt;"</span>) <span class="small_keyword" title="type-class constraint">with</span>
<span class="lineno" id=line177></span>          | #Empty =&gt; ;
<span class="lineno" id=line178></span>          | Cons (h,#Empty) =&gt; hsrc = strip h;
<span class="lineno" id=line179></span>          | Cons (h,Cons (d,#Empty)) =&gt; hsrc = strip h; hdst = strip d;
<span class="lineno" id=line180></span>          | _ =&gt; 
<span class="lineno" id=line181></span>             <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"[flx_build_prep:setup-pkg] file too many &gt; characters file: "</span>+
<span class="lineno" id=line182></span>             cmd.setup_pkg +<span class="fstring">"["</span>+lineno.<span class="library" title="Convert a value to a string">str</span>+<span class="fstring">"] "</span> + command;
<span class="lineno" id=line183></span>          <span class="small_keyword" title="end a match statement or expression">endmatch</span>;
<span class="lineno" id=line184></span>  
<span class="lineno" id=line185></span>          <span class="small_keyword" title="conditional">if</span> hsrc != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line186></span>            <span class="small_keyword" title="conditional">if</span> hdst == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> hdst = <span class="fstring">"${0}"</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line187></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Copying files "</span> + hsrc + <span class="fstring">" &gt; "</span> + hdst;
<span class="lineno" id=line188></span>            <span class="comment">//println$ "From source directory " + cmd.source_dir;</span>
<span class="lineno" id=line189></span>            <span class="comment">//println$ "To target directory " + cmd.target_dir/cmd.target_bin;</span>
<span class="lineno" id=line190></span>            CopyFiles::copyfiles (cmd.source_dir, hsrc,cmd.target_dir/cmd.target_bin/hdst,<span class="library" title="truth value">true</span>, <span class="library" title="truth value">true</span>);
<span class="lineno" id=line191></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line192></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line193></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line194></span>    }
<span class="lineno" id=line195></span>  
<span class="lineno" id=line196></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> flx_build(cmd: cmd_type)
<span class="lineno" id=line197></span>    {
<span class="lineno" id=line198></span>      dirsetup(cmd);
<span class="lineno" id=line199></span>      <span class="comment">// copy the compiler </span>
<span class="lineno" id=line200></span>      <span class="big_keyword" title="Define a mutable variable">var</span> compiler_name = <span class="fstring">"flxg"</span>;
<span class="lineno" id=line201></span>      <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line202></span>         compiler_name += <span class="fstring">".exe"</span>;
<span class="lineno" id=line203></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line204></span>      <span class="small_keyword" title="conditional">if</span> cmd.copy_compiler <span class="small_keyword" title="call a procedure">call</span> CopyFiles::copyfiles(cmd.source_dir/cmd.source_bin/<span class="fstring">'bin'</span>, compiler_name, 
<span class="lineno" id=line205></span>        cmd.target_dir/cmd.target_bin/<span class="fstring">'bin'</span>/<span class="fstring">'flxg'</span>, <span class="library" title="truth value">true</span>, cmd.debug);
<span class="lineno" id=line206></span>  
<span class="lineno" id=line207></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Build Complete"</span>;
<span class="lineno" id=line208></span>    }
<span class="lineno" id=line209></span>  
<span class="lineno" id=line210></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> print_help()
<span class="lineno" id=line211></span>    {
<span class="lineno" id=line212></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"flx_build_prep v2020.09.10"</span>;
<span class="lineno" id=line213></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Usage: flx_build_prep "</span>;
<span class="lineno" id=line214></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line215></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"--version                     show version and exit"</span>;
<span class="lineno" id=line216></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# locations"</span>;
<span class="lineno" id=line217></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line218></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --repo=repo                 default: src"</span>;
<span class="lineno" id=line219></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --target-dir=target_dir     default: build/trial"</span>;
<span class="lineno" id=line220></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --target-bin=target_bin     default: host"</span>;
<span class="lineno" id=line221></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --source-dir=source_dir     default: build/release"</span>;
<span class="lineno" id=line222></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --source-bin=source_bin     default: host"</span>;
<span class="lineno" id=line223></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line224></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# configuration"</span>;
<span class="lineno" id=line225></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line226></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --configure                 generate configuration"</span>;
<span class="lineno" id=line227></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --compiler=(gcc/clang/msvc) no default!"</span>;
<span class="lineno" id=line228></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --os=(linux/macosx/win)     no default!"</span>;
<span class="lineno" id=line229></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --bits=(32/64)              defaut 64"</span>;
<span class="lineno" id=line230></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --c-compiler=               default std compiler name"</span>;
<span class="lineno" id=line231></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --cxx-compiler=             default std compiler name"</span>;
<span class="lineno" id=line232></span>  
<span class="lineno" id=line233></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line234></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# cleaning options"</span>;
<span class="lineno" id=line235></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line236></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --clean-target-dir          delete entire target directory"</span>;
<span class="lineno" id=line237></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --clean-target-bin-dir      delete target sub-directory"</span>;
<span class="lineno" id=line238></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --clean-target-bin-binaries delete binaries from target sub-directory (not implemented yet)"</span>;
<span class="lineno" id=line239></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line240></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# copy options"</span>;
<span class="lineno" id=line241></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line242></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --copy-repo                 copy src dir of repository"</span>;
<span class="lineno" id=line243></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --copy-compiler             copy compiler flxg"</span>;
<span class="lineno" id=line244></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --copy-pkg-db               copy package database"</span>;
<span class="lineno" id=line245></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --copy-config-headers       copy C++ config headers (NO LONGER OF ANY USE!)"</span>;
<span class="lineno" id=line246></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --copy-version              copy Felix version file"</span>;
<span class="lineno" id=line247></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --copy-library              copy Felix library"</span>;
<span class="lineno" id=line248></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line249></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# selective setup of pkg-db"</span>;
<span class="lineno" id=line250></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --setup=pkg                 setup using file"</span>;
<span class="lineno" id=line251></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --toolchain=toolchain       specify toolchain to use"</span>;
<span class="lineno" id=line252></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --debug                     do stuff verbosely"</span>;
<span class="lineno" id=line253></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line254></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# Environment variables"</span>;
<span class="lineno" id=line255></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line256></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_SHELL_ECHO=1              echo all shell callouts (system, popen)"</span>;
<span class="lineno" id=line257></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_DEBUG_FLX=1               make 'flx' explain its processing decisions"</span>;
<span class="lineno" id=line258></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"BUILD_FLX_TOOLCHAIN_FAMILY=family   family=gcc or family=clang"</span>;
<span class="lineno" id=line259></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line260></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Purpose: setup new Felix target"</span>;
<span class="lineno" id=line261></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line262></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Requires repository directory $repo contain subdirectory 'src'"</span>;
<span class="lineno" id=line263></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Requires directory $source_dir contain subdirectory $source_bin which contains program 'flxg'"</span>;
<span class="lineno" id=line264></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ensures target_dir contains:"</span>;
<span class="lineno" id=line265></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line266></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (a) Repository source in $target_dir/share/src"</span>;
<span class="lineno" id=line267></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (b) config db, C++ headers, libraries in $target_dir/$target_bin/*"</span>;
<span class="lineno" id=line268></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line269></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Copies version, flxg, config db, and C++ headers from $source_dir if required"</span>;
<span class="lineno" id=line270></span>    }
<span class="lineno" id=line271></span>  
<span class="lineno" id=line272></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> setup_toolchain(<span class="big_keyword" title="Define a mutable variable">var</span> toolchain:<span class="library" title="binding of C++ string type">string</span>, pkgdir:<span class="library" title="binding of C++ string type">string</span>)
<span class="lineno" id=line273></span>    {
<span class="lineno" id=line274></span>      <span class="comment">// if the toolchain is specified, fix it</span>
<span class="lineno" id=line275></span>      <span class="small_keyword" title="conditional">if</span> toolchain != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line276></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line277></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Write toolchain "</span> + toolchain + <span class="fstring">" into package "</span> + pkgdir/<span class="fstring">'toolchain.fpc'</span>;
<span class="lineno" id=line278></span>          Directory::mkdirs pkgdir;
<span class="lineno" id=line279></span>          <span class="big_keyword" title="Define a mutable variable">var</span> f = fopen_output (pkgdir/<span class="fstring">'toolchain.fpc'</span>);
<span class="lineno" id=line280></span>          <span class="library" title="Print a string to a stream">write</span> (f,<span class="fstring">"toolchain: "</span> + toolchain +<span class="fstring">"\n"</span>);
<span class="lineno" id=line281></span>          fclose f;
<span class="lineno" id=line282></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line283></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"WRITING SPECIFIED TOOLCHAIN PACKAGE: ****************************"</span>;
<span class="lineno" id=line284></span>      <span class="small_keyword" title="conditional">elif</span> FileStat::fileexists (pkgdir/<span class="fstring">'toolchain.fpc'</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line285></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"USING EXISTING TOOLCHAIN PACKAGE: ****************************"</span>;
<span class="lineno" id=line286></span>      <span class="small_keyword" title="conditional">else</span> <span class="comment">// guess toolchain and write it</span>
<span class="lineno" id=line287></span>        <span class="big_keyword" title="Define a mutable variable">var</span> res, os = Shell::get_stdout(<span class="fstring">"uname"</span>);
<span class="lineno" id=line288></span>        &amp;os &lt;- os.strip;
<span class="lineno" id=line289></span>        <span class="big_keyword" title="Define a mutable variable">var</span> compiler_family = Env::getenv <span class="fstring">"BUILD_FLX_TOOLCHAIN_FAMILY"</span>;
<span class="lineno" id=line290></span>        <span class="small_keyword" title="match statement or expression">match</span> os,compiler_family <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line291></span>        | <span class="fstring">""</span>,<span class="fstring">""</span> =&gt; &amp;toolchain &lt;- <span class="fstring">"toolchain_mscv_win"</span>;
<span class="lineno" id=line292></span>        | <span class="fstring">"Linux"</span>,<span class="fstring">""</span> =&gt; &amp;toolchain &lt;- <span class="fstring">"toolchain_gcc_linux"</span>;
<span class="lineno" id=line293></span>        | <span class="fstring">"Darwin"</span>,<span class="fstring">""</span> =&gt; &amp;toolchain &lt;- <span class="fstring">"toolchain_clang_macosx"</span>;
<span class="lineno" id=line294></span>  
<span class="lineno" id=line295></span>        | <span class="fstring">"Linux"</span>,<span class="fstring">"gcc"</span> =&gt; &amp;toolchain &lt;- <span class="fstring">"toolchain_gcc_linux"</span>;
<span class="lineno" id=line296></span>        | <span class="fstring">"Linux"</span>,<span class="fstring">"clang"</span> =&gt; &amp;toolchain &lt;- <span class="fstring">"toolchain_clang_linux"</span>;
<span class="lineno" id=line297></span>        | <span class="fstring">"Darwin"</span>,<span class="fstring">"gcc"</span> =&gt; &amp;toolchain &lt;- <span class="fstring">"toolchain_gcc_macosx"</span>;
<span class="lineno" id=line298></span>        | <span class="fstring">"Darwin"</span>,<span class="fstring">"clang"</span> =&gt; &amp;toolchain &lt;- <span class="fstring">"toolchain_clang_macosx"</span>;
<span class="lineno" id=line299></span>  
<span class="lineno" id=line300></span>        | _,_ =&gt; 
<span class="lineno" id=line301></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"No toolchain specified in toolchain.fpc or with --toolchain switch"</span>;
<span class="lineno" id=line302></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  uname returns unknown OS: '"</span> +os+<span class="fstring">'"'</span>;
<span class="lineno" id=line303></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Either:"</span>;
<span class="lineno" id=line304></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (1) Set environment variable BUID_FLX_TOOLCHAIN_FAMILY=family where family=gcc or family=clang"</span>;
<span class="lineno" id=line305></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (2) Set the toolchain.fpc file to read 'toolchain:toolchain_name"</span>;
<span class="lineno" id=line306></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (3) use --toolchain=toolchain_name command line option"</span>;
<span class="lineno" id=line307></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  Note:toolchain name is form 'toolchain_&lt;family&gt;_&lt;os&gt;'"</span>;
<span class="lineno" id=line308></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"    where os=Darwin or os=Linux or os=Win32"</span>;
<span class="lineno" id=line309></span>          System::exit(1);
<span class="lineno" id=line310></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line311></span>        <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line312></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Write toolchain "</span> + toolchain + <span class="fstring">" into package "</span> + pkgdir/<span class="fstring">'toolchain.fpc'</span>;
<span class="lineno" id=line313></span>          <span class="big_keyword" title="Define a mutable variable">var</span> f = fopen_output (pkgdir/<span class="fstring">'toolchain.fpc'</span>);
<span class="lineno" id=line314></span>          <span class="library" title="Print a string to a stream">write</span> (f,<span class="fstring">"toolchain: "</span> + toolchain +<span class="fstring">"\n"</span>);
<span class="lineno" id=line315></span>          fclose f;
<span class="lineno" id=line316></span>        <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line317></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"USING GUESSED TOOLCHAIN PACKAGE: ****************************"</span>;
<span class="lineno" id=line318></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line319></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ load (pkgdir/<span class="fstring">'toolchain.fpc'</span>);
<span class="lineno" id=line320></span>    }
<span class="lineno" id=line321></span>  
<span class="lineno" id=line322></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> cmd_type = typeof (parse_args Empty[<span class="library" title="binding of C++ string type">string</span>]);
<span class="lineno" id=line323></span>  
<span class="lineno" id=line324></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_args (args: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) = 
<span class="lineno" id=line325></span>    {
<span class="lineno" id=line326></span>       <span class="big_keyword" title="Define a mutable variable">var</span> cmd = (
<span class="lineno" id=line327></span>         repo = <span class="fstring">'.'</span>,
<span class="lineno" id=line328></span>         target_dir=<span class="fstring">"build"</span>/<span class="fstring">"trial"</span>,
<span class="lineno" id=line329></span>         target_bin=<span class="fstring">"host"</span>,
<span class="lineno" id=line330></span>         source_dir=<span class="fstring">"build"</span>/<span class="fstring">"release"</span>,
<span class="lineno" id=line331></span>         source_bin=<span class="fstring">"host"</span>,
<span class="lineno" id=line332></span>         toolchain=<span class="fstring">""</span>,
<span class="lineno" id=line333></span>  
<span class="lineno" id=line334></span>         clean_target_dir=<span class="library" title="false value">false</span>,
<span class="lineno" id=line335></span>         clean_target_bin_dir=<span class="library" title="false value">false</span>,
<span class="lineno" id=line336></span>         clean_target_bin_binaries=<span class="library" title="false value">false</span>,
<span class="lineno" id=line337></span>  
<span class="lineno" id=line338></span>         copy_repo=<span class="library" title="false value">false</span>,
<span class="lineno" id=line339></span>         copy_compiler=<span class="library" title="false value">false</span>,
<span class="lineno" id=line340></span>         copy_pkg_db=<span class="library" title="false value">false</span>,
<span class="lineno" id=line341></span>         copy_config_headers=<span class="library" title="false value">false</span>,
<span class="lineno" id=line342></span>         copy_version=<span class="library" title="false value">false</span>,
<span class="lineno" id=line343></span>         copy_library=<span class="library" title="false value">false</span>,
<span class="lineno" id=line344></span>         setup_pkg=<span class="fstring">""</span>,
<span class="lineno" id=line345></span>         configure=<span class="library" title="false value">false</span>,
<span class="lineno" id=line346></span>         compiler=<span class="fstring">"notspecified"</span>,
<span class="lineno" id=line347></span>         os=<span class="fstring">"notspecified"</span>,
<span class="lineno" id=line348></span>         bits=<span class="fstring">"notspecified"</span>,
<span class="lineno" id=line349></span>         c_compiler=<span class="fstring">""</span>,
<span class="lineno" id=line350></span>         cxx_compiler=<span class="fstring">""</span>,
<span class="lineno" id=line351></span>         debug = <span class="library" title="false value">false</span>
<span class="lineno" id=line352></span>       );
<span class="lineno" id=line353></span>  
<span class="lineno" id=line354></span>       <span class="small_keyword" title="for loop">for</span> arg <span class="small_keyword" title="membership operator, function mem">in</span> args <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line355></span>         <span class="small_keyword" title="conditional">if</span> prefix(arg, <span class="fstring">"--version"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line356></span>           <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"flx_build_prep version "</span> + VERSION;
<span class="lineno" id=line357></span>           System::exit 0;
<span class="lineno" id=line358></span>         <span class="comment">// location options</span>
<span class="lineno" id=line359></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--repo="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line360></span>           &amp;cmd.repo &lt;- arg.[7 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line361></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line362></span>           &amp;cmd.target_dir &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line363></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target-bin="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line364></span>           &amp;cmd.target_bin &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line365></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--source-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line366></span>           &amp;cmd.source_dir &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line367></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--source-bin="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line368></span>           &amp;cmd.source_bin &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line369></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--toolchain="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line370></span>           &amp;cmd.toolchain &lt;- arg.[12 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line371></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--debug"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line372></span>           &amp;cmd.debug &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line373></span>  
<span class="lineno" id=line374></span>         <span class="comment">// operation options: cleaning</span>
<span class="lineno" id=line375></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--clean-target-dir"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line376></span>           &amp;cmd.clean_target_dir &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line377></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--clean-target-bin-dir"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line378></span>           &amp;cmd.clean_target_bin_dir &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line379></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--clean-target-bin-binaries"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line380></span>           &amp;cmd.clean_target_bin_binaries &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line381></span>  
<span class="lineno" id=line382></span>         <span class="comment">// operation options: copying</span>
<span class="lineno" id=line383></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--copy-repo"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line384></span>           &amp;cmd.copy_repo&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line385></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--copy-compiler"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line386></span>           &amp;cmd.copy_compiler&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line387></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--copy-pkg-db"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line388></span>           &amp;cmd.copy_pkg_db &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line389></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--copy-config-headers"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line390></span>           &amp;cmd.copy_config_headers &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line391></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--copy-version"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line392></span>           &amp;cmd.copy_version &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line393></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--copy-library"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line394></span>           &amp;cmd.copy_library &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line395></span>  
<span class="lineno" id=line396></span>         <span class="comment">// configuration</span>
<span class="lineno" id=line397></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--configure"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line398></span>           &amp;cmd.configure &lt;-<span class="library" title="truth value">true</span>;
<span class="lineno" id=line399></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--compiler"</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line400></span>           &amp;cmd.compiler&lt;- arg.[11 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line401></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--os="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line402></span>           &amp;cmd.os&lt;- arg.[5 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line403></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--bits="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line404></span>           &amp;cmd.bits&lt;- arg.[7 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line405></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--c-compiler="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line406></span>           &amp;cmd.c_compiler&lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line407></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--cxx-compiler="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line408></span>           &amp;cmd.cxx_compiler&lt;- arg.[15 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line409></span>    
<span class="lineno" id=line410></span>         <span class="comment">// special configuration package</span>
<span class="lineno" id=line411></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--setup="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line412></span>           &amp;cmd.setup_pkg &lt;- arg.[8 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line413></span>  
<span class="lineno" id=line414></span>         <span class="comment">// help</span>
<span class="lineno" id=line415></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--help"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line416></span>           print_help();
<span class="lineno" id=line417></span>           System::exit(0);
<span class="lineno" id=line418></span>         <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line419></span>           <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unknown switch "</span> + arg;
<span class="lineno" id=line420></span>           print_help();
<span class="lineno" id=line421></span>           System::exit(1);
<span class="lineno" id=line422></span>         <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line423></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line424></span>  
<span class="lineno" id=line425></span>   
<span class="lineno" id=line426></span>       <span class="small_keyword" title="return">return</span> cmd;
<span class="lineno" id=line427></span>    }
<span class="lineno" id=line428></span>  
<span class="lineno" id=line429></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_felix (xargs:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line430></span>    {
<span class="lineno" id=line431></span>      <span class="small_keyword" title="conditional">if</span> xargs.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> &lt; 2 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line432></span>        print_help();
<span class="lineno" id=line433></span>        System::exit(1);
<span class="lineno" id=line434></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line435></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cmd = parse_args (tail xargs);
<span class="lineno" id=line436></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"flx_build_prep "</span> + VERSION; 
<span class="lineno" id=line437></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  repository       = "</span> + cmd.repo;
<span class="lineno" id=line438></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  target-dir       = "</span> + cmd.target_dir;
<span class="lineno" id=line439></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  target-bin       = "</span> + cmd.target_bin;
<span class="lineno" id=line440></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  source-dir       = "</span> + cmd.source_dir;
<span class="lineno" id=line441></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  source-bin       = "</span> + cmd.source_bin;
<span class="lineno" id=line442></span>      <span class="small_keyword" title="conditional">if</span> cmd.configure <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line443></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"CONFIGURE compiler="</span> + cmd.compiler+<span class="fstring">", os="</span> + cmd.os + <span class="fstring">", bits="</span> + cmd.bits;
<span class="lineno" id=line444></span>        cmd&amp;.toolchain &lt;- <span class="fstring">"toolchain_"</span> + cmd.compiler + <span class="fstring">"_"</span> + cmd.os;
<span class="lineno" id=line445></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line446></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  setup-pkg        = "</span> + cmd.setup_pkg;
<span class="lineno" id=line447></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  toolchain (spec) = "</span> + cmd.toolchain;
<span class="lineno" id=line448></span>      flx_build (cmd);
<span class="lineno" id=line449></span>      <span class="big_keyword" title="Define a mutable variable">var</span> target_config_dir = cmd.target_dir/cmd.target_bin/<span class="fstring">"config"</span> ;
<span class="lineno" id=line450></span>      setup_toolchain(cmd.toolchain,target_config_dir );
<span class="lineno" id=line451></span>    }
<span class="lineno" id=line452></span>  
<span class="lineno" id=line453></span>  }
<span class="lineno" id=line454></span>  
<span class="lineno" id=line455></span>  FlxPrepBuild::build_felix (#System::args);
<span class="lineno" id=line456></span>  
<span class="lineno" id=line457></span>  System::exit (0);
</pre></p></div><h2 id='Build_the_Run_Time_Library_(RTL)_h'><img src='/share/src/web/images/minus.gif' id='Build the Run Time Library (RTL)' onclick='toggle(this,"Build_the_Run_Time_Library_(RTL)_d")' alt='+'/> 1.3 Build the Run Time Library (RTL)</h2><div id='Build_the_Run_Time_Library_(RTL)_d' style='display:block'>
<p>Builds the run time library from the build target
share directory. Does not look in the repository.
</p><pre class='inclusion'>
$PWD/src/tools/flx_build_rtl.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_config"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_interface"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_pkgconfig"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_pkg"</span>; <span class="comment">// only for "fix2word_flags"</span>
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_cp"</span>;
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_depchk"</span>;
<span class="lineno" id=line7></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/pthread/threadpool"</span>;
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_mklib"</span>;
<span class="lineno" id=line9></span>  
<span class="lineno" id=line10></span>  <span class="big_keyword" title="Define a type class">class</span> FlxRtlBuild
<span class="lineno" id=line11></span>  {
<span class="lineno" id=line12></span>  
<span class="lineno" id=line13></span>    <span class="qualifier" title="Symbol visible only in enclosing module or typeclass namespace">private</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (x:<span class="library" title="binding of C++ string type">string</span>,y:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join(x,y);
<span class="lineno" id=line14></span>  
<span class="lineno" id=line15></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ehandler () {
<span class="lineno" id=line16></span>      eprintln$ <span class="fstring">"Flx_buildtools:FlxRtlBuild flx_pkgconfig temporary ehandler invoked"</span>;
<span class="lineno" id=line17></span>      System::exit 1;
<span class="lineno" id=line18></span>    }
<span class="lineno" id=line19></span>  
<span class="lineno" id=line20></span>  
<span class="lineno" id=line21></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> make_rtl (
<span class="lineno" id=line22></span>      build:<span class="library" title="binding of C++ string type">string</span>, target:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line23></span>      boot_package:<span class="library" title="binding of C++ string type">string</span>, 
<span class="lineno" id=line24></span>      tmpdir:<span class="library" title="binding of C++ string type">string</span>,
<span class="lineno" id=line25></span>      static_only:bool,
<span class="lineno" id=line26></span>      noexes:bool,
<span class="lineno" id=line27></span>      debug: bool
<span class="lineno" id=line28></span>    )
<span class="lineno" id=line29></span>    {
<span class="lineno" id=line30></span>      <span class="big_keyword" title="Define an immutable value">val</span> pkgdir = build / target / <span class="fstring">'config'</span>;
<span class="lineno" id=line31></span>      <span class="big_keyword" title="Define an immutable value">val</span> srtl = build / <span class="fstring">'share'</span> / <span class="fstring">'lib'</span> / <span class="fstring">'rtl'</span>;
<span class="lineno" id=line32></span>      <span class="big_keyword" title="Define an immutable value">val</span> hrtl = build / target / <span class="fstring">'lib'</span> / <span class="fstring">'rtl'</span>;
<span class="lineno" id=line33></span>      <span class="big_keyword" title="Define an immutable value">val</span> bin = build / target / <span class="fstring">'bin'</span>;
<span class="lineno" id=line34></span>      <span class="big_keyword" title="Define an immutable value">val</span> repo = build / <span class="fstring">'share'</span>; <span class="comment">// excludes "src" cause that's in the packages</span>
<span class="lineno" id=line35></span>      
<span class="lineno" id=line36></span>      <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> dbug (x:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="small_keyword" title="conditional">if</span> debug <span class="small_keyword" title="call a procedure">call</span> <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">'[make_rtl] '</span> + x;
<span class="lineno" id=line37></span>      Directory::mkdirs tmpdir;
<span class="lineno" id=line38></span>      Directory::mkdirs hrtl;
<span class="lineno" id=line39></span>      Directory::mkdirs srtl;
<span class="lineno" id=line40></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"bootpkg="</span> + boot_package + <span class="fstring">" build image="</span> + build;
<span class="lineno" id=line41></span>  
<span class="lineno" id=line42></span>      <span class="big_keyword" title="Define a mutable variable">var</span> db = FlxPkgConfig::FlxPkgConfigQuery (<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] pkgdir);
<span class="lineno" id=line43></span>  
<span class="lineno" id=line44></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> getbootfield (field:<span class="library" title="binding of C++ string type">string</span>) =&gt; db.getpkgfield1 ehandler (boot_package, field);
<span class="lineno" id=line45></span>      <span class="comment">// toolchain pkg 1</span>
<span class="lineno" id=line46></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_name = db.getpkgfield1 ehandler (<span class="fstring">"toolchain"</span>,<span class="fstring">"toolchain"</span>);
<span class="lineno" id=line47></span>  
<span class="lineno" id=line48></span>      <span class="big_keyword" title="Define a mutable variable">var</span> c_compiler_executable = 
<span class="lineno" id=line49></span>        db.getpkgfielddflt ehandler (toolchain_name+<span class="fstring">"_c_compiler_executable"</span>, <span class="fstring">"compiler"</span>)
<span class="lineno" id=line50></span>      ;
<span class="lineno" id=line51></span>  
<span class="lineno" id=line52></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cxx_compiler_executable =
<span class="lineno" id=line53></span>        db.getpkgfielddflt ehandler (toolchain_name+<span class="fstring">"_cxx_compiler_executable"</span>, <span class="fstring">"compiler"</span>)
<span class="lineno" id=line54></span>      ;
<span class="lineno" id=line55></span>  
<span class="lineno" id=line56></span>  
<span class="lineno" id=line57></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"toolchain    : "</span> + <span class="library" title="Convert a value to a string">str</span> toolchain_name + <span class="fstring">", c: "</span>+ c_compiler_executable + <span class="fstring">", c++: "</span> + cxx_compiler_executable;
<span class="lineno" id=line58></span>  
<span class="lineno" id=line59></span>      <span class="big_keyword" title="Define a mutable variable">var</span> allpkgs = db.getclosure ehandler boot_package;
<span class="lineno" id=line60></span>      <span class="comment">//println$ "Closure      : " + str allpkgs;</span>
<span class="lineno" id=line61></span>  
<span class="lineno" id=line62></span>      <span class="small_keyword" title="for loop">for</span> pkg <span class="small_keyword" title="membership operator, function mem">in</span> allpkgs <span class="small_keyword" title="end of extension">begin</span> 
<span class="lineno" id=line63></span>        <span class="big_keyword" title="Define a mutable variable">var</span> lib = db.getpkgfielddflt ehandler (pkg,<span class="fstring">"library"</span>);
<span class="lineno" id=line64></span>        <span class="big_keyword" title="Define a mutable variable">var</span> srcdir = db.getpkgfielddflt ehandler (pkg,<span class="fstring">"srcdir"</span>);
<span class="lineno" id=line65></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ f<span class="fstring">"%15S %20S %20S"</span> (pkg,lib,srcdir);
<span class="lineno" id=line66></span>      <span class="small_keyword" title="end of extension">end</span> 
<span class="lineno" id=line67></span>  
<span class="lineno" id=line68></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain-maker = 
<span class="lineno" id=line69></span>        Dynlink::load-plugin-func1 [toolchain_t,toolchain_config_t] 
<span class="lineno" id=line70></span>        (
<span class="lineno" id=line71></span>          dll-name=toolchain_name, 
<span class="lineno" id=line72></span>          setup-str=<span class="fstring">""</span>,
<span class="lineno" id=line73></span>          entry-point=toolchain_name
<span class="lineno" id=line74></span>        )
<span class="lineno" id=line75></span>      ;
<span class="lineno" id=line76></span>      <span class="small_keyword" title="for loop">for</span> pkg <span class="small_keyword" title="membership operator, function mem">in</span> allpkgs <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line77></span>        <span class="big_keyword" title="Define a mutable variable">var</span> library = db.getpkgfielddflt ehandler (pkg,<span class="fstring">"library"</span>);
<span class="lineno" id=line78></span>        <span class="big_keyword" title="Define a mutable variable">var</span> srcdir = db.getpkgfielddflt ehandler (pkg,<span class="fstring">"srcdir"</span>);
<span class="lineno" id=line79></span>        <span class="big_keyword" title="Define a mutable variable">var</span> src = db.getpkgfield ehandler (pkg,<span class="fstring">"src"</span>);
<span class="lineno" id=line80></span>        <span class="small_keyword" title="conditional">if</span> library != <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line81></span>          <span class="small_keyword" title="conditional">if</span> srcdir == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line82></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Package error, package "</span> + pkg + <span class="fstring">" library "</span> + library + <span class="fstring">" No srcdir specified"</span>;
<span class="lineno" id=line83></span>            System::exit(1);
<span class="lineno" id=line84></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line85></span>          <span class="small_keyword" title="conditional">if</span> src.is_empty <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line86></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Package error, package "</span> + pkg + <span class="fstring">" library "</span> + library + <span class="fstring">" No src files specified"</span>;
<span class="lineno" id=line87></span>            System::exit(1);
<span class="lineno" id=line88></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line89></span>          <span class="big_keyword" title="Define a mutable variable">var</span> src_dir =  build / <span class="fstring">'share'</span>;
<span class="lineno" id=line90></span>          <span class="big_keyword" title="Define a mutable variable">var</span> share_rtl = src_dir / <span class="fstring">'lib'</span> / <span class="fstring">'rtl'</span>;
<span class="lineno" id=line91></span>          <span class="big_keyword" title="Define a mutable variable">var</span> target_dir =  build / target / <span class="fstring">'lib'</span> / <span class="fstring">'rtl'</span>;
<span class="lineno" id=line92></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = FlxLibBuild::make_lib (db,toolchain-maker, c_compiler_executable, cxx_compiler_executable,src_dir, target_dir, share_rtl, pkg,tmpdir, static_only, debug) ();
<span class="lineno" id=line93></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="logical negation">not</span> <span class="small_keyword" title="value of function return used in post condition">result</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line94></span>            eprintln$ <span class="fstring">"Library build "</span> + pkg + <span class="fstring">" failed"</span>;
<span class="lineno" id=line95></span>            System::exit 1;
<span class="lineno" id=line96></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line97></span>        <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line98></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"------------"</span>;
<span class="lineno" id=line99></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"External package "</span> + pkg;
<span class="lineno" id=line100></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"------------"</span>;
<span class="lineno" id=line101></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line102></span>      <span class="small_keyword" title="end of extension">end</span> 
<span class="lineno" id=line103></span>  
<span class="lineno" id=line104></span>      <span class="comment">// make drivers</span>
<span class="lineno" id=line105></span>      <span class="small_keyword" title="end of extension">begin</span>
<span class="lineno" id=line106></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"------------"</span>;
<span class="lineno" id=line107></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Make drivers"</span>;
<span class="lineno" id=line108></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"------------"</span>;
<span class="lineno" id=line109></span>        <span class="big_keyword" title="Define a mutable variable">var</span> srcdir = repo/<span class="fstring">"src"</span>/<span class="fstring">"flx_drivers"</span>;
<span class="lineno" id=line110></span>        <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_config = 
<span class="lineno" id=line111></span>          (
<span class="lineno" id=line112></span>            c_compiler_executable = c_compiler_executable,
<span class="lineno" id=line113></span>            cxx_compiler_executable = cxx_compiler_executable,
<span class="lineno" id=line114></span>            header_search_dirs= <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] (hrtl, srcdir, srtl),
<span class="lineno" id=line115></span>            macros= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line116></span>            ccflags = Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line117></span>            library_search_dirs= <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] (<span class="fstring">"-L"</span>+hrtl),
<span class="lineno" id=line118></span>            dynamic_libraries= Empty[<span class="library" title="binding of C++ string type">string</span>],
<span class="lineno" id=line119></span>            static_libraries= Empty[<span class="library" title="binding of C++ string type">string</span>], <span class="comment">//############ FIXME or the link won't work!</span>
<span class="lineno" id=line120></span>            debugln = dbug
<span class="lineno" id=line121></span>          )
<span class="lineno" id=line122></span>        ;
<span class="lineno" id=line123></span>        <span class="big_keyword" title="Define a function with no side-effects">fun</span> prgname (file:<span class="library" title="binding of C++ string type">string</span>) =&gt; <span class="small_keyword" title="let binder">let</span> 
<span class="lineno" id=line124></span>            dstprg = file.Filename::strip_extension + #(toolchain.executable_extension) <span class="small_keyword" title="membership operator, function mem">in</span>
<span class="lineno" id=line125></span>            bin / dstprg
<span class="lineno" id=line126></span>        ;
<span class="lineno" id=line127></span>  
<span class="lineno" id=line128></span>        <span class="big_keyword" title="Define a mutable variable">var</span> toolchain = toolchain-maker toolchain_config;
<span class="lineno" id=line129></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ #(toolchain.whatami);
<span class="lineno" id=line130></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cobj_static (s:<span class="library" title="binding of C++ string type">string</span>,dst:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line131></span>          <span class="big_keyword" title="Define a mutable variable">var</span> src = srcdir/s;
<span class="lineno" id=line132></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Compiling [static] "</span> + src + <span class="fstring">" -&gt; "</span> + dst;
<span class="lineno" id=line133></span>          <span class="big_keyword" title="Define a mutable variable">var</span> fresh = cxx_depcheck (toolchain, src, dst);
<span class="lineno" id=line134></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="small_keyword" title="conditional">if</span> fresh <span class="small_keyword" title="conditional">then</span> 0 <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line135></span>            toolchain.cxx_static_object_compiler(src=src, dst=dst)
<span class="lineno" id=line136></span>          ;
<span class="lineno" id=line137></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line138></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Driver compile "</span>+ s + <span class="fstring">" -&gt; "</span> + dst +<span class="fstring">" FAILED"</span>;
<span class="lineno" id=line139></span>            System::exit 1;
<span class="lineno" id=line140></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line141></span>        }
<span class="lineno" id=line142></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> cobj_dynamic (s:<span class="library" title="binding of C++ string type">string</span>,dst:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line143></span>          <span class="big_keyword" title="Define a mutable variable">var</span> src = srcdir/s;
<span class="lineno" id=line144></span>          <span class="small_keyword" title="conditional">if</span> static_only <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line145></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Skipping [dynamic] "</span> + src + <span class="fstring">" -&gt; "</span> + dst + <span class="fstring">" due to flag"</span>;
<span class="lineno" id=line146></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line147></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Compiling [dynamic] "</span> + src + <span class="fstring">" -&gt; "</span> + dst;
<span class="lineno" id=line148></span>            <span class="big_keyword" title="Define a mutable variable">var</span> fresh = cxx_depcheck (toolchain, src, dst);
<span class="lineno" id=line149></span>            <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = <span class="small_keyword" title="conditional">if</span> fresh <span class="small_keyword" title="conditional">then</span> 0 <span class="small_keyword" title="conditional">else</span> 
<span class="lineno" id=line150></span>              toolchain.cxx_dynamic_object_compiler(src=src, dst=dst)
<span class="lineno" id=line151></span>            ;
<span class="lineno" id=line152></span>            <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line153></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Driver compile "</span>+ s + <span class="fstring">" -&gt; "</span> + dst +<span class="fstring">" FAILED"</span>;
<span class="lineno" id=line154></span>              System::exit 1;
<span class="lineno" id=line155></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line156></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line157></span>        }
<span class="lineno" id=line158></span>  
<span class="lineno" id=line159></span>        <span class="comment">// VERY CONFUSING!</span>
<span class="lineno" id=line160></span>        <span class="comment">// This one is for full static linkage, RTL static linked</span>
<span class="lineno" id=line161></span>        cobj_static(<span class="fstring">"flx_run_lib_static.cpp"</span>,hrtl/<span class="fstring">"flx_run_lib_static"</span>+#(toolchain.static_object_extension));
<span class="lineno" id=line162></span>  
<span class="lineno" id=line163></span>        <span class="comment">// This run is for linking an executable which uses the RTL dynamic linked</span>
<span class="lineno" id=line164></span>        cobj_dynamic(<span class="fstring">"flx_run_lib_static.cpp"</span>,hrtl/<span class="fstring">"flx_run_lib_static"</span>+#(toolchain.dynamic_object_extension));
<span class="lineno" id=line165></span>  
<span class="lineno" id=line166></span>        <span class="comment">// This one is for loading a program as a DLL, i.e. for use in flx_run.exe</span>
<span class="lineno" id=line167></span>        cobj_dynamic(<span class="fstring">"flx_run_lib_dynamic.cpp"</span>,hrtl/<span class="fstring">"flx_run_lib_dynamic"</span>+#(toolchain.dynamic_object_extension));
<span class="lineno" id=line168></span>  
<span class="lineno" id=line169></span>        cobj_static(<span class="fstring">"flx_arun_lib_static.cpp"</span>,hrtl/<span class="fstring">"flx_arun_lib_static"</span>+#(toolchain.static_object_extension));
<span class="lineno" id=line170></span>        cobj_dynamic(<span class="fstring">"flx_arun_lib_static.cpp"</span>,hrtl/<span class="fstring">"flx_arun_lib_static"</span>+#(toolchain.dynamic_object_extension));
<span class="lineno" id=line171></span>        cobj_dynamic(<span class="fstring">"flx_arun_lib_dynamic.cpp"</span>,hrtl/<span class="fstring">"flx_arun_lib_dynamic"</span>+#(toolchain.dynamic_object_extension));
<span class="lineno" id=line172></span>  
<span class="lineno" id=line173></span>        cobj_static(<span class="fstring">"flx_run_main.cxx"</span>,hrtl/<span class="fstring">"flx_run_main"</span>+#(toolchain.static_object_extension));
<span class="lineno" id=line174></span>        cobj_dynamic(<span class="fstring">"flx_run_main.cxx"</span>,hrtl/<span class="fstring">"flx_run_main"</span>+#(toolchain.dynamic_object_extension));
<span class="lineno" id=line175></span>  
<span class="lineno" id=line176></span>        cobj_static(<span class="fstring">"flx_arun_main.cxx"</span>,hrtl/<span class="fstring">"flx_arun_main"</span>+#(toolchain.static_object_extension));
<span class="lineno" id=line177></span>        cobj_dynamic(<span class="fstring">"flx_arun_main.cxx"</span>,hrtl/<span class="fstring">"flx_arun_main"</span>+#(toolchain.dynamic_object_extension));
<span class="lineno" id=line178></span>  
<span class="lineno" id=line179></span>        <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> prg(file:<span class="library" title="binding of C++ string type">string</span>) {
<span class="lineno" id=line180></span>          <span class="big_keyword" title="Define a mutable variable">var</span> exe = prgname file;
<span class="lineno" id=line181></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Linking [executable] "</span> + exe;
<span class="lineno" id=line182></span>          <span class="big_keyword" title="Define a mutable variable">var</span> objs = <span class="library" title="functional, singly linked list">list</span> (
<span class="lineno" id=line183></span>            hrtl/file+<span class="fstring">"_lib_dynamic"</span>+#(toolchain.dynamic_object_extension),
<span class="lineno" id=line184></span>            hrtl/file+<span class="fstring">"_main"</span>+#(toolchain.dynamic_object_extension)
<span class="lineno" id=line185></span>          );
<span class="lineno" id=line186></span>          <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span>,libs = db.query$ <span class="library" title="functional, singly linked list">list</span>(<span class="fstring">"--rec"</span>,<span class="fstring">"--keeprightmost"</span>,
<span class="lineno" id=line187></span>            <span class="fstring">"--field=provides_dlib"</span>,<span class="fstring">"--field=requires_dlibs"</span>,file);
<span class="lineno" id=line188></span>          libs = FlxPkg::fix2word_flags libs;
<span class="lineno" id=line189></span>          <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line190></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Driver pkgconfig query for "</span>+ file+<span class="fstring">" FAILED"</span>;
<span class="lineno" id=line191></span>            System::exit 1;
<span class="lineno" id=line192></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line193></span>          <span class="small_keyword" title="conditional">if</span> noexes <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line194></span>            <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Skipping executable link due to flag"</span>;
<span class="lineno" id=line195></span>          <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line196></span>            <span class="small_keyword" title="value of function return used in post condition">result</span> = toolchain.dynamic_executable_linker(srcs=objs+libs, dst=exe);
<span class="lineno" id=line197></span>            <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line198></span>              <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Driver link  "</span>+ file+<span class="fstring">" FAILED"</span>;
<span class="lineno" id=line199></span>              System::exit 1;
<span class="lineno" id=line200></span>            <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line201></span>          <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line202></span>        }
<span class="lineno" id=line203></span>        prg(<span class="fstring">"flx_run"</span>);
<span class="lineno" id=line204></span>        prg(<span class="fstring">"flx_arun"</span>);
<span class="lineno" id=line205></span>      <span class="small_keyword" title="end of extension">end</span>
<span class="lineno" id=line206></span>    }
<span class="lineno" id=line207></span>  
<span class="lineno" id=line208></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> flx_build(cmd: cmd_type)
<span class="lineno" id=line209></span>    {
<span class="lineno" id=line210></span>      make_rtl ( cmd.target_dir, cmd.target_bin, cmd.boot_package, cmd.tmp_dir, cmd.static_only, cmd.noexes, cmd.debug);
<span class="lineno" id=line211></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Build Complete"</span>;
<span class="lineno" id=line212></span>    }
<span class="lineno" id=line213></span>  
<span class="lineno" id=line214></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> print_help()
<span class="lineno" id=line215></span>    {
<span class="lineno" id=line216></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Usage: flx_build_rtl "</span>;
<span class="lineno" id=line217></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line218></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# locations"</span>;
<span class="lineno" id=line219></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line220></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --pkg=bootpkg (default: flx_rtl_core)"</span>;
<span class="lineno" id=line221></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --target-dir=target_dir     default: build/trial"</span>;
<span class="lineno" id=line222></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --target-bin=target_bin     default: host"</span>;
<span class="lineno" id=line223></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --tmp-dir=tmp               default: build/rtl-tmp"</span>;
<span class="lineno" id=line224></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --static                    static link libraries only"</span>;
<span class="lineno" id=line225></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --noexes                    libraries only"</span>;
<span class="lineno" id=line226></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line227></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --debug                     do stuff verbosely"</span>;
<span class="lineno" id=line228></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line229></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# Environment variables"</span>;
<span class="lineno" id=line230></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line231></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_SHELL_ECHO=1              echo all shell callouts (system, popen)"</span>;
<span class="lineno" id=line232></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_DEBUG_FLX=1               make 'flx' explain its processing decisions"</span>;
<span class="lineno" id=line233></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line234></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Purpose: Build new Felix target"</span>;
<span class="lineno" id=line235></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line236></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ensures target_dir contains:"</span>;
<span class="lineno" id=line237></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line238></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (a) Repository source in $target_dir/share/src"</span>;
<span class="lineno" id=line239></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (b) Share library in $target_dir/share/lib"</span>;
<span class="lineno" id=line240></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (c) config db, C++ headers, libraries and executables in $target_dir/$target_bin/*"</span>;
<span class="lineno" id=line241></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line242></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Compiles all C++ sources to libraries and executables"</span>;
<span class="lineno" id=line243></span>    }
<span class="lineno" id=line244></span>  
<span class="lineno" id=line245></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> cmd_type = typeof (parse_args Empty[<span class="library" title="binding of C++ string type">string</span>]);
<span class="lineno" id=line246></span>  
<span class="lineno" id=line247></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_args (args: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) = 
<span class="lineno" id=line248></span>    {
<span class="lineno" id=line249></span>       <span class="big_keyword" title="Define a mutable variable">var</span> cmd = (
<span class="lineno" id=line250></span>         boot_package=<span class="fstring">""</span>,
<span class="lineno" id=line251></span>         target_dir=<span class="fstring">"build"</span>/<span class="fstring">"trial"</span>,
<span class="lineno" id=line252></span>         target_bin=<span class="fstring">"host"</span>,
<span class="lineno" id=line253></span>         tmp_dir=<span class="fstring">"build"</span>/<span class="fstring">"rtl-tmp"</span>,
<span class="lineno" id=line254></span>         static_only=<span class="library" title="false value">false</span>,
<span class="lineno" id=line255></span>         noexes=<span class="library" title="false value">false</span>,
<span class="lineno" id=line256></span>         debug = <span class="library" title="false value">false</span>
<span class="lineno" id=line257></span>       );
<span class="lineno" id=line258></span>  
<span class="lineno" id=line259></span>       <span class="small_keyword" title="for loop">for</span> arg <span class="small_keyword" title="membership operator, function mem">in</span> args <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line260></span>         <span class="comment">// location options</span>
<span class="lineno" id=line261></span>         <span class="small_keyword" title="conditional">if</span> prefix(arg,<span class="fstring">"--pkg="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line262></span>           &amp;cmd.boot_package &lt;- arg.[6 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line263></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line264></span>           &amp;cmd.target_dir &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line265></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target-bin="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line266></span>           &amp;cmd.target_bin &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line267></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--tmp-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line268></span>           &amp;cmd.tmp_dir &lt;- arg.[10 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line269></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--static"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line270></span>           &amp;cmd.static_only &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line271></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--noexes"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line272></span>           &amp;cmd.noexes&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line273></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--debug"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line274></span>           &amp;cmd.debug &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line275></span>  
<span class="lineno" id=line276></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--help"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line277></span>           print_help();
<span class="lineno" id=line278></span>           System::exit(0);
<span class="lineno" id=line279></span>         <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line280></span>           <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unknown switch "</span> + arg;
<span class="lineno" id=line281></span>           print_help();
<span class="lineno" id=line282></span>           System::exit(1);
<span class="lineno" id=line283></span>         <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line284></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line285></span>       <span class="small_keyword" title="conditional">if</span> cmd.boot_package== <span class="fstring">""</span> perform &amp;cmd.boot_package &lt;- <span class="fstring">"flx_rtl_core"</span>;
<span class="lineno" id=line286></span>       <span class="small_keyword" title="return">return</span> cmd;
<span class="lineno" id=line287></span>    }
<span class="lineno" id=line288></span>  
<span class="lineno" id=line289></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_felix_rtl (xargs:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line290></span>    {
<span class="lineno" id=line291></span>      <span class="small_keyword" title="conditional">if</span> xargs.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> &lt; 2 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line292></span>        print_help();
<span class="lineno" id=line293></span>        System::exit(1);
<span class="lineno" id=line294></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line295></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cmd = parse_args (tail xargs);
<span class="lineno" id=line296></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"flx_build_rtl v1.9"</span>;
<span class="lineno" id=line297></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  build-package = "</span> + cmd.boot_package;
<span class="lineno" id=line298></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  target-dir    = "</span> + cmd.target_dir;
<span class="lineno" id=line299></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  target-bin    = "</span> + cmd.target_bin;
<span class="lineno" id=line300></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  tmp-dir       = "</span> + cmd.tmp_dir;
<span class="lineno" id=line301></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  static only   = "</span> + cmd.static_only.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line302></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  no executables= "</span> + cmd.noexes.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line303></span>      flx_build (cmd);
<span class="lineno" id=line304></span>    }
<span class="lineno" id=line305></span>  
<span class="lineno" id=line306></span>  }
<span class="lineno" id=line307></span>  
<span class="lineno" id=line308></span>  FlxRtlBuild::build_felix_rtl (#System::args);
<span class="lineno" id=line309></span>  
<span class="lineno" id=line310></span>  System::exit (0);
</pre></p></div><h2 id='Build_everything_else._h'><img src='/share/src/web/images/minus.gif' id='Build everything else.' onclick='toggle(this,"Build_everything_else._d")' alt='+'/> 1.4 Build everything else.</h2><div id='Build_everything_else._d' style='display:block'>
<p>Builds the plugins and essential build tools including <code>flx</code> and <code>flx_pkgconfig</code>
and all the build tools in this package.
</p><p>It uses a specified build configuration file to determine what
to build. The standard file is <code>build_boot.fpc</code> in the configuration
directory.
</p><pre class='inclusion'>
$PWD/src/config/build_boot.fpc</pre>
<p><pre class="prefmtbg">web_plugin:      cpp2html
web_plugin:      html2html
web_plugin:      html_edit
web_plugin:      html_button
web_plugin:      html_fileseq
web_plugin:      html_heading
web_plugin:      html_paragraph
web_plugin:      html_scanner
web_plugin:      html_slideshow
web_plugin:      toc_menu
web_plugin:      html_frame
web_plugin:      flx2html
web_plugin:      fpc2html
web_plugin:      ocaml2html
web_plugin:      py2html
toolchain_plugin:      toolchain_clang_linux
toolchain_plugin:      toolchain_clang_macosx
toolchain_plugin:      toolchain_iphoneos
toolchain_plugin:      toolchain_iphonesimulator
toolchain_plugin:      toolchain_gcc_linux
toolchain_plugin:      toolchain_gcc_macosx
toolchain_plugin:      toolchain_msvc_win
tool:      flx_cp
tool:      flx_ls
tool:      flx_grep
tool:      flx_replace
tool:      flx_batch_replace
tool:      flx_tangle
tool:      flx_perror
tool:      flx_gramdoc
tool:      flx_libindex
tool:      flx_libcontents
tool:      flx_mktutindex
tool:      flx_renumber
tool:      flx_find_grammar_files
tool:      flx_iscr
tool:      flx_pretty
flx_tool: flx_find_cxx_packages
flx_tool: flx_gen_cxx_includes
flx_tool: flx_pkgconfig
flx_tool: flx_build_prep
flx_tool: flx_build_rtl
flx_tool: flx_build_boot
flx_tool: flx_build_flxg
</pre></p><pre class='inclusion'>
$PWD/src/tools/flx_build_boot.flx</pre>
<p><pre class='flxbg'><span class="lineno" id=line1></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_config"</span>;
<span class="lineno" id=line2></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/toolchain_interface"</span>;
<span class="lineno" id=line3></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_cp"</span>;
<span class="lineno" id=line4></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_pkgconfig"</span>;
<span class="lineno" id=line5></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx_pkg"</span>; <span class="comment">// only for "fix2word_flags"</span>
<span class="lineno" id=line6></span>  <span class="big_keyword" title="Include a Felix file">include</span> <span class="fstring">"std/felix/flx/flx_plugin_client"</span>;
<span class="lineno" id=line7></span>  
<span class="lineno" id=line8></span>  <span class="big_keyword" title="Define a type class">class</span> FlxCoreBuild
<span class="lineno" id=line9></span>  {
<span class="lineno" id=line10></span>  
<span class="lineno" id=line11></span>    <span class="big_keyword" title="Define a function with no side-effects">fun</span> / (x:<span class="library" title="binding of C++ string type">string</span>,y:<span class="library" title="binding of C++ string type">string</span>) =&gt; Filename::join(x,y);
<span class="lineno" id=line12></span>  
<span class="lineno" id=line13></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> ehandler () {
<span class="lineno" id=line14></span>      eprintln$ <span class="fstring">"Flx_buildtools:FlxCoreBuild flx_pkgconfig temporary ehandler invoked"</span>;
<span class="lineno" id=line15></span>      System::exit 1;
<span class="lineno" id=line16></span>    }
<span class="lineno" id=line17></span>  
<span class="lineno" id=line18></span>  
<span class="lineno" id=line19></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_plugins(target_dir:<span class="library" title="binding of C++ string type">string</span>, target_bin:<span class="library" title="binding of C++ string type">string</span>, plugins:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line20></span>    {
<span class="lineno" id=line21></span>      <span class="small_keyword" title="for loop">for</span> plugin <span class="small_keyword" title="membership operator, function mem">in</span> plugins <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line22></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Building plugin "</span> + plugin;
<span class="lineno" id=line23></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line24></span>          <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line25></span>          <span class="fstring">'-c'</span>, <span class="fstring">'-ox'</span>,target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/plugin, 
<span class="lineno" id=line26></span>          target_dir/<span class="fstring">'share'</span>/<span class="fstring">'lib'</span>/<span class="fstring">'plugins'</span>/plugin);
<span class="lineno" id=line27></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line28></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"plugin (dynamic) build failed"</span>;
<span class="lineno" id=line29></span>          System::exit 1; 
<span class="lineno" id=line30></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line31></span>  
<span class="lineno" id=line32></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line33></span>          <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line34></span>          <span class="fstring">'-c'</span>, <span class="fstring">'--nolink'</span>,<span class="fstring">'-ox'</span>, target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/plugin, 
<span class="lineno" id=line35></span>          target_dir/<span class="fstring">'share'</span>/<span class="fstring">'lib'</span>/<span class="fstring">'plugins'</span>/plugin);
<span class="lineno" id=line36></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line37></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"plugin (dynamic obj) build failed"</span>;
<span class="lineno" id=line38></span>          System::exit 1; 
<span class="lineno" id=line39></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line40></span>  
<span class="lineno" id=line41></span>        <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line42></span>          <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line43></span>          <span class="fstring">'--static'</span>,<span class="fstring">'-c'</span>, <span class="fstring">'--nolink'</span>,<span class="fstring">'-ox'</span>, target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/plugin, 
<span class="lineno" id=line44></span>          target_dir/<span class="fstring">'share'</span>/<span class="fstring">'lib'</span>/<span class="fstring">'plugins'</span>/plugin);
<span class="lineno" id=line45></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line46></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"plugin (static obj) build failed"</span>;
<span class="lineno" id=line47></span>          System::exit 1; 
<span class="lineno" id=line48></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line49></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line50></span>     
<span class="lineno" id=line51></span>    }
<span class="lineno" id=line52></span>  
<span class="lineno" id=line53></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_exes(target_dir:<span class="library" title="binding of C++ string type">string</span>, target_bin:<span class="library" title="binding of C++ string type">string</span>, tools:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line54></span>    {
<span class="lineno" id=line55></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"build exes"</span>;
<span class="lineno" id=line56></span>      <span class="small_keyword" title="for loop">for</span> exe <span class="small_keyword" title="membership operator, function mem">in</span> tools <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line57></span>        <span class="big_keyword" title="Define a mutable variable">var</span> src = Filename::join (<span class="fstring">"tools"</span>,exe);
<span class="lineno" id=line58></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ src + <span class="fstring">" -&gt; "</span> + exe;
<span class="lineno" id=line59></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line60></span>          <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line61></span>          <span class="fstring">'--static'</span>,<span class="fstring">'-c'</span>,
<span class="lineno" id=line62></span>          <span class="fstring">'-ox'</span>, target_dir/target_bin/<span class="fstring">'bin'</span>/exe, target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/src);
<span class="lineno" id=line63></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line64></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"exe build failed"</span>;
<span class="lineno" id=line65></span>          System::exit 1; 
<span class="lineno" id=line66></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line67></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line68></span>    }
<span class="lineno" id=line69></span>  
<span class="lineno" id=line70></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_flx_tools (target_dir:<span class="library" title="binding of C++ string type">string</span>, target_bin:<span class="library" title="binding of C++ string type">string</span>, tools:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line71></span>    {
<span class="lineno" id=line72></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"build flx build tools"</span>;
<span class="lineno" id=line73></span>      <span class="small_keyword" title="for loop">for</span> exe <span class="small_keyword" title="membership operator, function mem">in</span> tools <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line74></span>        <span class="big_keyword" title="Define a mutable variable">var</span> src = Filename::join (<span class="fstring">"tools"</span>,exe);
<span class="lineno" id=line75></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ src + <span class="fstring">" -&gt; "</span> + exe;
<span class="lineno" id=line76></span>        <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line77></span>          <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line78></span>          <span class="fstring">'--static'</span>,<span class="fstring">'-c'</span>,
<span class="lineno" id=line79></span>          <span class="fstring">'-ox'</span>, target_dir/target_bin/<span class="fstring">'bin'</span>/exe, target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/src);
<span class="lineno" id=line80></span>        <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line81></span>          <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"exe build failed"</span>;
<span class="lineno" id=line82></span>          System::exit 1; 
<span class="lineno" id=line83></span>        <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line84></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line85></span>    }
<span class="lineno" id=line86></span>  
<span class="lineno" id=line87></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_flx_web (target_dir:<span class="library" title="binding of C++ string type">string</span>, target_bin:<span class="library" title="binding of C++ string type">string</span>, web_plugins:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line88></span>    {
<span class="lineno" id=line89></span>      <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line90></span>        <span class="big_keyword" title="Define a mutable variable">var</span> obj_extn = <span class="fstring">"_static.obj"</span>; <span class="comment">// HACK!!!!!!!! </span>
<span class="lineno" id=line91></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line92></span>        <span class="big_keyword" title="Define a mutable variable">var</span> obj_extn = <span class="fstring">"_static.o"</span>; <span class="comment">// HACK!!!!!!!! </span>
<span class="lineno" id=line93></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line94></span>  
<span class="lineno" id=line95></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"dflx_web  -&gt; dflx_web object file"</span>;
<span class="lineno" id=line96></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line97></span>        <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line98></span>        <span class="fstring">'--static'</span>,<span class="fstring">'-c'</span>,<span class="fstring">'--nolink'</span>,
<span class="lineno" id=line99></span>        <span class="fstring">'-o'</span>, target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/<span class="fstring">'dflx_web'</span>+obj_extn, target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/<span class="fstring">'tools'</span>/<span class="fstring">'dflx_web'</span>);
<span class="lineno" id=line100></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line101></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"dflx_web build failed"</span>;
<span class="lineno" id=line102></span>        System::exit 1; 
<span class="lineno" id=line103></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line104></span>      <span class="big_keyword" title="Define a mutable variable">var</span> web_plugin_objs = 
<span class="lineno" id=line105></span>        unbox (<span class="library" title="return data structure with function applied to each value">map</span> 
<span class="lineno" id=line106></span>          (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (s:<span class="library" title="binding of C++ string type">string</span>) =&gt; target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/s+obj_extn) 
<span class="lineno" id=line107></span>          web_plugins
<span class="lineno" id=line108></span>        )
<span class="lineno" id=line109></span>      ;
<span class="lineno" id=line110></span>  
<span class="lineno" id=line111></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Build flx_web. Note: requires --build-web-plugins"</span>;
<span class="lineno" id=line112></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"flx_web  -&gt; flx_web executable"</span>;
<span class="lineno" id=line113></span>      <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ 
<span class="lineno" id=line114></span>        <span class="library" title="functional, singly linked list">list</span> (
<span class="lineno" id=line115></span>          <span class="fstring">'[flx]'</span>,
<span class="lineno" id=line116></span>          <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line117></span>          <span class="fstring">'--static'</span>,<span class="fstring">'-c'</span>,
<span class="lineno" id=line118></span>          <span class="fstring">'-ox'</span>, target_dir/target_bin/<span class="fstring">'bin'</span>/<span class="fstring">'flx_web'</span>) + 
<span class="lineno" id=line119></span>        web_plugin_objs +
<span class="lineno" id=line120></span>        <span class="library" title="functional, singly linked list">list</span> (
<span class="lineno" id=line121></span>          target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/<span class="fstring">'dflx_web'</span> + obj_extn, 
<span class="lineno" id=line122></span>          target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/<span class="fstring">'tools'</span>/<span class="fstring">'flx_web.flx'</span>)
<span class="lineno" id=line123></span>      ;
<span class="lineno" id=line124></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line125></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"exe build failed"</span>;
<span class="lineno" id=line126></span>        System::exit 1; 
<span class="lineno" id=line127></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line128></span>    }
<span class="lineno" id=line129></span>  
<span class="lineno" id=line130></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_flx (target_dir:<span class="library" title="binding of C++ string type">string</span>, target_bin:<span class="library" title="binding of C++ string type">string</span>, toolchain_plugins:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line131></span>    {
<span class="lineno" id=line132></span>      <span class="small_keyword" title="conditional">if</span> PLAT_WIN32 <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line133></span>        <span class="big_keyword" title="Define a mutable variable">var</span> obj_extn = <span class="fstring">".obj"</span>; <span class="comment">// HACK!!!!!!!! </span>
<span class="lineno" id=line134></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line135></span>        <span class="big_keyword" title="Define a mutable variable">var</span> obj_extn = <span class="fstring">".o"</span>; <span class="comment">// HACK!!!!!!!! </span>
<span class="lineno" id=line136></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line137></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"dflx  -&gt; dflx object file"</span>;
<span class="lineno" id=line138></span>      <span class="big_keyword" title="Define a mutable variable">var</span> <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line139></span>        <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line140></span>        <span class="fstring">'-c'</span>,<span class="fstring">'--nolink'</span>, <span class="fstring">'--static'</span>,
<span class="lineno" id=line141></span>        <span class="fstring">'-o'</span>, target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/<span class="fstring">'dflx'</span>+obj_extn, target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/<span class="fstring">'tools'</span>/<span class="fstring">'dflx'</span>);
<span class="lineno" id=line142></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line143></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"dflx build failed"</span>;
<span class="lineno" id=line144></span>        System::exit 1; 
<span class="lineno" id=line145></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line146></span>  
<span class="lineno" id=line147></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Compile of dflx"</span>+obj_extn+<span class="fstring">" SUCCEEDED"</span>;
<span class="lineno" id=line148></span>  
<span class="lineno" id=line149></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_objects : <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] = unbox (<span class="library" title="return data structure with function applied to each value">map</span> (<span class="big_keyword" title="Define a function with no side-effects">fun</span> (p:<span class="library" title="binding of C++ string type">string</span>) =&gt;
<span class="lineno" id=line150></span>        target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/p + <span class="fstring">"_static"</span>+obj_extn) 
<span class="lineno" id=line151></span>        toolchain_plugins)
<span class="lineno" id=line152></span>      ; 
<span class="lineno" id=line153></span>  
<span class="lineno" id=line154></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Linking dflx"</span>+obj_extn+<span class="fstring">" with toolchains "</span>+toolchain_objects.<span class="library" title="Convert a value to a string">str</span>;
<span class="lineno" id=line155></span>   
<span class="lineno" id=line156></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Build flx. Note: requires --build-toolchain-plugins"</span>;
<span class="lineno" id=line157></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"flx  -&gt; flx"</span>;
<span class="lineno" id=line158></span>      <span class="small_keyword" title="value of function return used in post condition">result</span> = Flx_client::runflx$ <span class="library" title="functional, singly linked list">list</span> (<span class="fstring">'[flx]'</span>,
<span class="lineno" id=line159></span>        <span class="fstring">'--test='</span>+target_dir, <span class="fstring">'--target='</span>+target_bin, 
<span class="lineno" id=line160></span>        <span class="fstring">'--static'</span>,<span class="fstring">'-c'</span>,
<span class="lineno" id=line161></span>        <span class="fstring">'-ox'</span>, target_dir/target_bin/<span class="fstring">'bin'</span>/<span class="fstring">'flx'</span>) + toolchain_objects +
<span class="lineno" id=line162></span>        (target_dir/target_bin/<span class="fstring">'lib'</span>/<span class="fstring">'rtl'</span>/<span class="fstring">'dflx'</span> + obj_extn) +
<span class="lineno" id=line163></span>        (target_dir/<span class="fstring">'share'</span>/<span class="fstring">'src'</span>/<span class="fstring">'tools'</span>/<span class="fstring">'flx.flx'</span>)
<span class="lineno" id=line164></span>      ;
<span class="lineno" id=line165></span>      <span class="small_keyword" title="conditional">if</span> <span class="small_keyword" title="value of function return used in post condition">result</span> != 0 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line166></span>        <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"exe build failed"</span>;
<span class="lineno" id=line167></span>        System::exit 1; 
<span class="lineno" id=line168></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line169></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Build flx: SUCCEEDED"</span>;
<span class="lineno" id=line170></span>    }
<span class="lineno" id=line171></span>  
<span class="lineno" id=line172></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> flx_build(cmd: cmd_type)
<span class="lineno" id=line173></span>    {
<span class="lineno" id=line174></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"bootpkg="</span> + cmd.boot_package;
<span class="lineno" id=line175></span>      <span class="big_keyword" title="Define a mutable variable">var</span> pkgdir = Filename::join (cmd.target_dir, cmd.target_bin, <span class="fstring">"config"</span>);
<span class="lineno" id=line176></span>      <span class="big_keyword" title="Define a mutable variable">var</span> db = FlxPkgConfig::FlxPkgConfigQuery (<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>] pkgdir);
<span class="lineno" id=line177></span>      <span class="big_keyword" title="Define a generator, a function with side-effects returning a value">gen</span> getbootfields (field:<span class="library" title="binding of C++ string type">string</span>) =&gt; db.getpkgfield  ehandler (cmd.boot_package, field);
<span class="lineno" id=line178></span>      <span class="big_keyword" title="Define a mutable variable">var</span> toolchain_plugins = getbootfields (<span class="fstring">"toolchain_plugin"</span>);
<span class="lineno" id=line179></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cygwin_toolchain_plugins = getbootfields (<span class="fstring">"cygwin_toolchain_plugin"</span>);
<span class="lineno" id=line180></span>      <span class="big_keyword" title="Define a mutable variable">var</span> web_plugins = getbootfields (<span class="fstring">"web_plugin"</span>);
<span class="lineno" id=line181></span>      <span class="big_keyword" title="Define a mutable variable">var</span> flx_tools = getbootfields (<span class="fstring">"flx_tool"</span>);
<span class="lineno" id=line182></span>      <span class="big_keyword" title="Define a mutable variable">var</span> tools = getbootfields (<span class="fstring">"tool"</span>);
<span class="lineno" id=line183></span>  
<span class="lineno" id=line184></span>      <span class="comment">// at this point, the build proceeds using host tools, but only target sources.</span>
<span class="lineno" id=line185></span>      <span class="small_keyword" title="conditional">if</span> PLAT_CYGWIN <span class="small_keyword" title="imperative code begins">do</span> <span class="comment">// requires cygwin dll and headers so only on Cygwin!</span>
<span class="lineno" id=line186></span>        <span class="small_keyword" title="conditional">if</span> cmd.build_toolchain_plugins <span class="small_keyword" title="call a procedure">call</span> 
<span class="lineno" id=line187></span>          build_plugins(cmd.target_dir, cmd.target_bin, 
<span class="lineno" id=line188></span>          toolchain_plugins+cygwin_toolchain_plugins+<span class="fstring">"flx_plugin"</span>)
<span class="lineno" id=line189></span>        ;
<span class="lineno" id=line190></span>        <span class="small_keyword" title="conditional">if</span> cmd.build_flx <span class="small_keyword" title="call a procedure">call</span> 
<span class="lineno" id=line191></span>          build_flx(cmd.target_dir, cmd.target_bin, toolchain_plugins+cygwin_toolchain_plugins)
<span class="lineno" id=line192></span>        ;
<span class="lineno" id=line193></span>      <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line194></span>        <span class="small_keyword" title="conditional">if</span> cmd.build_toolchain_plugins <span class="small_keyword" title="call a procedure">call</span> 
<span class="lineno" id=line195></span>          build_plugins(cmd.target_dir, cmd.target_bin, toolchain_plugins+<span class="fstring">"flx_plugin"</span>)
<span class="lineno" id=line196></span>        ;
<span class="lineno" id=line197></span>        <span class="small_keyword" title="conditional">if</span> cmd.build_flx <span class="small_keyword" title="call a procedure">call</span> 
<span class="lineno" id=line198></span>          build_flx(cmd.target_dir, cmd.target_bin, toolchain_plugins)
<span class="lineno" id=line199></span>        ;
<span class="lineno" id=line200></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line201></span>  
<span class="lineno" id=line202></span>      <span class="small_keyword" title="conditional">if</span> cmd.build_flx_tools <span class="small_keyword" title="call a procedure">call</span> build_flx_tools(cmd.target_dir, cmd.target_bin, flx_tools);
<span class="lineno" id=line203></span>      <span class="small_keyword" title="conditional">if</span> cmd.build_web_plugins <span class="small_keyword" title="call a procedure">call</span> build_plugins(cmd.target_dir, cmd.target_bin, web_plugins);
<span class="lineno" id=line204></span>      <span class="small_keyword" title="conditional">if</span> cmd.build_tools <span class="small_keyword" title="call a procedure">call</span> build_exes(cmd.target_dir, cmd.target_bin, tools);
<span class="lineno" id=line205></span>      <span class="small_keyword" title="conditional">if</span> cmd.build_flx_web <span class="small_keyword" title="call a procedure">call</span> build_flx_web (cmd.target_dir, cmd.target_bin, web_plugins);
<span class="lineno" id=line206></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Build Complete"</span>;
<span class="lineno" id=line207></span>    }
<span class="lineno" id=line208></span>  
<span class="lineno" id=line209></span>    <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> print_help()
<span class="lineno" id=line210></span>    {
<span class="lineno" id=line211></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Usage: flx_build_boot "</span>;
<span class="lineno" id=line212></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line213></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# locations"</span>;
<span class="lineno" id=line214></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line215></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --pkg=bootpkg               default: build_boot"</span>;
<span class="lineno" id=line216></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --target-dir=target_dir     default: build/release"</span>;
<span class="lineno" id=line217></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --target-bin=target_bin     default: host"</span>;
<span class="lineno" id=line218></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line219></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line220></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# compilation options"</span>;
<span class="lineno" id=line221></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line222></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --build-toolchain-plugins   Felix compile the toolchain plugins"</span>;
<span class="lineno" id=line223></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --build-flx                 Felix compile flx"</span>;
<span class="lineno" id=line224></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --build-flx-tools           Felix compile flx build tools"</span>;
<span class="lineno" id=line225></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --build-web-plugins         Felix compile the webserver plugins"</span>;
<span class="lineno" id=line226></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --build-tools               Felix compile standard tools"</span>;
<span class="lineno" id=line227></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --build-flx-web             Felix compile web server executable"</span>;
<span class="lineno" id=line228></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line229></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  --debug                     do stuff verbosely"</span>;
<span class="lineno" id=line230></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line231></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"# Environment variables"</span>;
<span class="lineno" id=line232></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line233></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_SHELL_ECHO=1              echo all shell callouts (system, popen)"</span>;
<span class="lineno" id=line234></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"FLX_DEBUG_FLX=1               make 'flx' explain its processing decisions"</span>;
<span class="lineno" id=line235></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line236></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Purpose: Build new Felix target: stuff written in Felix"</span>;
<span class="lineno" id=line237></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line238></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Ensures target_dir contains:"</span>;
<span class="lineno" id=line239></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line240></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (a) Repository source in $target_dir/share/src"</span>;
<span class="lineno" id=line241></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (b) Share library in $target_dir/share/lib"</span>;
<span class="lineno" id=line242></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  (c) config db, C++ headers, libraries and executables in $target_dir/$target_bin/*"</span>;
<span class="lineno" id=line243></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">""</span>;
<span class="lineno" id=line244></span>    }
<span class="lineno" id=line245></span>  
<span class="lineno" id=line246></span>    <span class="big_keyword" title="Define an alias for a type expression">typedef</span> cmd_type = typeof (parse_args Empty[<span class="library" title="binding of C++ string type">string</span>]);
<span class="lineno" id=line247></span>  
<span class="lineno" id=line248></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a function with no side-effects">fun</span> parse_args (args: <span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>]) = 
<span class="lineno" id=line249></span>    {
<span class="lineno" id=line250></span>       <span class="big_keyword" title="Define a mutable variable">var</span> cmd = (
<span class="lineno" id=line251></span>         boot_package=<span class="fstring">""</span>,
<span class="lineno" id=line252></span>         target_dir=<span class="fstring">"build"</span>/<span class="fstring">"release"</span>,
<span class="lineno" id=line253></span>         target_bin=<span class="fstring">"host"</span>,
<span class="lineno" id=line254></span>  
<span class="lineno" id=line255></span>         build_web_plugins=<span class="library" title="false value">false</span>,
<span class="lineno" id=line256></span>         build_toolchain_plugins=<span class="library" title="false value">false</span>,
<span class="lineno" id=line257></span>         build_flx=<span class="library" title="false value">false</span>,
<span class="lineno" id=line258></span>         build_flx_tools=<span class="library" title="false value">false</span>,
<span class="lineno" id=line259></span>         build_tools=<span class="library" title="false value">false</span>,
<span class="lineno" id=line260></span>         build_flx_web=<span class="library" title="false value">false</span>,
<span class="lineno" id=line261></span>         debug = <span class="library" title="false value">false</span>
<span class="lineno" id=line262></span>       );
<span class="lineno" id=line263></span>  
<span class="lineno" id=line264></span>       <span class="small_keyword" title="for loop">for</span> arg <span class="small_keyword" title="membership operator, function mem">in</span> args <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line265></span>         <span class="comment">// location options</span>
<span class="lineno" id=line266></span>         <span class="small_keyword" title="conditional">if</span> prefix(arg,<span class="fstring">"--pkg="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line267></span>           &amp;cmd.boot_package &lt;- arg.[6 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line268></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target-dir="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line269></span>           &amp;cmd.target_dir &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line270></span>         <span class="small_keyword" title="conditional">elif</span> prefix(arg,<span class="fstring">"--target-bin="</span>) <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line271></span>           &amp;cmd.target_bin &lt;- arg.[13 <span class="small_keyword" title="substring range separator">to</span>];
<span class="lineno" id=line272></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--debug"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line273></span>           &amp;cmd.debug &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line274></span>  
<span class="lineno" id=line275></span>         <span class="comment">// operation options: compilation</span>
<span class="lineno" id=line276></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--build-web-plugins"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line277></span>           &amp;cmd.build_web_plugins&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line278></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--build-toolchain-plugins"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line279></span>           &amp;cmd.build_toolchain_plugins&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line280></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--build-flx"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line281></span>           &amp;cmd.build_flx &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line282></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--build-flx-tools"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line283></span>           &amp;cmd.build_flx_tools &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line284></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--build-tools"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line285></span>           &amp;cmd.build_tools&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line286></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--build-flx-web"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line287></span>           &amp;cmd.build_flx_web &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line288></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--build-all"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line289></span>           &amp;cmd.build_web_plugins&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line290></span>           &amp;cmd.build_toolchain_plugins&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line291></span>           &amp;cmd.build_flx &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line292></span>           &amp;cmd.build_flx_web &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line293></span>           &amp;cmd.build_flx_tools &lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line294></span>           &amp;cmd.build_tools&lt;- <span class="library" title="truth value">true</span>;
<span class="lineno" id=line295></span>         <span class="small_keyword" title="conditional">elif</span> arg == <span class="fstring">"--help"</span> <span class="small_keyword" title="imperative code begins">do</span>
<span class="lineno" id=line296></span>           print_help();
<span class="lineno" id=line297></span>           System::exit(0);
<span class="lineno" id=line298></span>         <span class="small_keyword" title="conditional">else</span>
<span class="lineno" id=line299></span>           <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"Unknown switch "</span> + arg;
<span class="lineno" id=line300></span>           print_help();
<span class="lineno" id=line301></span>           System::exit(1);
<span class="lineno" id=line302></span>         <span class="small_keyword" title="end of body">done</span> 
<span class="lineno" id=line303></span>       <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line304></span>  
<span class="lineno" id=line305></span>       <span class="comment">// Note: unrelated to boot package used by flx_build_rtl</span>
<span class="lineno" id=line306></span>       <span class="small_keyword" title="conditional">if</span> cmd.boot_package == <span class="fstring">""</span> <span class="small_keyword" title="imperative code begins">do</span> &amp;cmd.boot_package &lt;- <span class="fstring">"build_boot"</span>; <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line307></span>       <span class="small_keyword" title="return">return</span> cmd;
<span class="lineno" id=line308></span>    }
<span class="lineno" id=line309></span>  
<span class="lineno" id=line310></span>    <span class="qualifier" title="Function or procedure which must not be inlined">noinline</span> <span class="big_keyword" title="Define a procedure, a function with side-effects not returning a value">proc</span> build_felix (xargs:<span class="library" title="functional, singly linked list">list</span>[<span class="library" title="binding of C++ string type">string</span>])
<span class="lineno" id=line311></span>    {
<span class="lineno" id=line312></span>      <span class="small_keyword" title="conditional">if</span> xargs.<span class="library" title="number of elements in data structure">len</span>.<span class="library" title="binding of C int type">int</span> &lt; 2 <span class="small_keyword" title="imperative code begins">do</span> 
<span class="lineno" id=line313></span>        print_help();
<span class="lineno" id=line314></span>        System::exit(1);
<span class="lineno" id=line315></span>      <span class="small_keyword" title="end of body">done</span>
<span class="lineno" id=line316></span>      <span class="big_keyword" title="Define a mutable variable">var</span> cmd = parse_args (tail xargs);
<span class="lineno" id=line317></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"flx_build_boot v1.3"</span>;
<span class="lineno" id=line318></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  build_package = "</span> + cmd.boot_package;
<span class="lineno" id=line319></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  target_dir    = "</span> + cmd.target_dir;
<span class="lineno" id=line320></span>      <span class="library" title="Print a string to standard output with newline appended">println</span>$ <span class="fstring">"  target_bin    = "</span> + cmd.target_bin;
<span class="lineno" id=line321></span>  
<span class="lineno" id=line322></span>      flx_build (cmd);
<span class="lineno" id=line323></span>    }
<span class="lineno" id=line324></span>  
<span class="lineno" id=line325></span>  }
<span class="lineno" id=line326></span>  
<span class="lineno" id=line327></span>  Flx_client::setup;
<span class="lineno" id=line328></span>  FlxCoreBuild::build_felix (#System::args);
<span class="lineno" id=line329></span>  
<span class="lineno" id=line330></span>  System::exit (0);
<span class="lineno" id=line331></span>  
<span class="lineno" id=line332></span>  
</pre></p></div></div><!--Main Content Body End-->

          </div> <!-- rightpanel contents end -->
          <hr>
        </span> <!-- rightpanel end -->

        <span id="panemover" style="cursor:col-resize;"
         onmousedown="dragStart(event, 'left', 'right'); return false;"
         onmousemove="drag(event, 'left', 'right');"
         onmouseout="dragRelease();"
         onmouseup="dragRelease();"
        >
        </span> <!-- panemover end -->
      </div> <!-- bottom panel end -->
    </div> <!-- container end -->
</body></html>

